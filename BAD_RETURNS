# BAD_RETURNS - Success Returns That Mask Failures

## Overview
This document catalogs all instances where service code returns success (StatusCodes.OK/Created, Success=true)
when the operation has actually failed, partially failed, or lost data silently.

---

## CRITICAL: Error Event Publishing Safety

**`TryPublishErrorAsync` is ALWAYS safe to call.** Both implementations have internal try/catch:

- **RabbitMQMessageBus** (lines 220-260): Wraps publishing in try/catch, logs warning on failure, returns `false`
- **InMemoryMessageBus** (lines 72-90): Logs only (no I/O to fail), returns `true`

This means:
1. You can call `TryPublishErrorAsync` in catch blocks without risk of cascading failures
2. If publishing fails, it logs a warning and returns `false` - no exception propagates
3. The operation should still fail for its original reason, regardless of error event success/failure

**Pattern for catch blocks:**
```csharp
catch (Exception ex)
{
    _logger.LogError(ex, "Operation {Op} failed", opName);
    await _messageBus.TryPublishErrorAsync(_serviceId, opName, ex.GetType().Name, ex.Message);
    return (StatusCodes.InternalServerError, null);  // Always fails - error event is best-effort
}
```

---

## FIXES APPLIED

### P0-1: Auth Service Null Roles/Authorizations (FIXED)
**File**: `lib-auth/AuthService.cs:998-1022`
**Problem**: Returned `Valid=true` with empty lists when `sessionData.Roles` or `sessionData.Authorizations` were null
**Fix**: Added explicit null check before returning success. If either is null, logs error, publishes error event, returns Unauthorized
**Why**: Null roles/authorizations in an existing session indicates data corruption - this must never silently succeed

### P0-2: Orchestrator Topology Changes (FIXED)
**File**: `lib-orchestrator/OrchestratorService.cs:1636-1792`
**Problem**: `AddNode`, `RemoveNode`, `MoveService`, `Scale` all set `Success=true` unconditionally
**Fix**: Added success/failure counters. `Success=true` only when ALL operations succeed. Partial failures set `Success=true` with error message. Complete failures set `Success=false`
**Why**: Deployment operations must accurately report their outcome so orchestration decisions can be made correctly

### P0-3: Game Session PerformGameAction (FIXED)
**File**: `lib-game-session/GameSessionService.cs:587-648`
**Problem**: Set `Success=true` without any validation or persistence
**Fix**: Added action validation (non-empty type, valid action data), event publishing, and `TryPublishErrorAsync` in catch block
**Why**: Game actions must be validated and the event must be published before returning success

### P0-4: Accounts Index Removal Failure (FIXED)
**File**: `lib-accounts/AccountsService.cs:1263-1274`
**Problem**: Index removal failures were swallowed - exception caught, error event published, but then returned normally allowing delete to succeed
**Fix**: Changed to throw after publishing error event, so caller's outer catch handles it and returns InternalServerError
**Why**: Orphaned index entries are a data integrity issue - delete should fail if index can't be cleaned up

---

## CATEGORY 1: Null-Coalescing on Required Fields with OK Return

These return success with fabricated default values when actual data is null (data corruption indicator).

### CRITICAL - Authentication/Authorization Data

| File | Line | Field | Problem |
|------|------|-------|---------|
| lib-auth/AuthService.cs | 1009 | Roles | Returns Valid=true with empty list when session roles are null |
| lib-auth/AuthService.cs | 1010 | Authorizations | Returns Valid=true with empty list when session authorizations are null |
| lib-auth/AuthService.cs | 1148 | DisplayName | Session created with empty display name |
| lib-auth/AuthService.cs | 1149 | Roles | Session created with potentially empty roles |
| lib-accounts/AccountsService.cs | 652 | ExternalId | OAuth linking with potentially empty ExternalId |
| lib-accounts/AccountsService.cs | 676 | ExternalId | OAuth response with potentially empty ExternalId |
| lib-accounts/AccountsService.cs | 1086 | DisplayName | Account event with empty display name |
| lib-accounts/AccountsService.cs | 1088 | Roles | Account event with empty roles |
| lib-accounts/AccountsService.cs | 1117-1119 | DisplayName/Roles | Account updated event with empty values |
| lib-accounts/AccountsService.cs | 1150-1152 | DisplayName/Roles | Account deleted event with empty values |

### CRITICAL - Game/Session Data

| File | Line | Field | Problem |
|------|------|-------|---------|
| lib-game-session/GameSessionService.cs | 272 | SessionName | Empty session name in created event |
| lib-game-session/GameSessionService.cs | 498-499 | SdpOffer/IceCandidates | Empty WebRTC data in response |
| lib-game-session/GameSessionService.cs | 1430 | SessionName | Empty session name in response |
| lib-game-session/GameSessionService.cs | 1438 | GameSettings | Empty object instead of actual settings |
| lib-mesh/MeshService.cs | 184 | Services | Endpoint registered with no services |

### HIGH - Entity Metadata

| File | Line | Field | Problem |
|------|------|-------|---------|
| lib-realm/RealmService.cs | 743, 770-771, 775 | Category/Description/DeprecationReason | Empty strings mask missing data |
| lib-location/LocationService.cs | 1368, 1374-1375, 1393, 1399-1400, 1419, 1425-1426 | Description/DeprecationReason/Metadata | Empty values |
| lib-species/SpeciesService.cs | 1185-1194 | Multiple fields including BaseLifespan=0, MaturityAge=0 | Zeros mask missing gameplay values |
| lib-relationship/RelationshipService.cs | 761, 797 | Metadata | Empty dict masks missing relationship metadata |
| lib-relationship-type/RelationshipTypeService.cs | 1144, 1172-1173, 1180 | Category/Description/DeprecationReason | Empty strings |
| lib-behavior/BehaviorService.cs | 246-247, 266-267, 757-758 | Category/BundleId | Empty strings mask missing behavior metadata |
| lib-asset/AssetService.cs | 346 | Tags | Empty tags list loses asset metadata |

### MEDIUM - Permissions/State Data

| File | Line | Field | Problem |
|------|------|-------|---------|
| lib-permissions/PermissionsService.cs | 758-759 | states/permissionsData | Empty dicts mask state store failures |
| lib-permissions/PermissionsService.cs | 1234-1235 | sessionStates | Empty dict masks session state lookup failure |

---

## CATEGORY 2: Silent Null Skips in Loops

These loops silently skip null items without counting or logging how many were lost.

### CRITICAL - Index/Data Mismatch Hidden

| File | Line | Context | Problem |
|------|------|---------|---------|
| lib-accounts/AccountsService.cs | 138 | LoadAccountResponseAsync loop | Skips null accounts, no count of how many IDs failed to load |
| lib-game-session/GameSessionService.cs | 156 | LoadSessionAsync loop | Skips null sessions, TotalCount mismatches list size |
| lib-relationship/RelationshipService.cs | 224 | Bulk relationship load | Skips null relationships from index lookup |

### LOWER - Expected Behavior

| File | Line | Context | Status |
|------|------|---------|--------|
| lib-permissions/PermissionsService.cs | 904 | Permission matrix lookup | ACCEPTABLE - empty permission sets are expected |

---

## CATEGORY 3: Success=true Without Validation

These set Success=true unconditionally before or without validating the operation succeeded.

### CRITICAL - Topology/Deployment Operations

| File | Line | Method | Problem |
|------|------|--------|---------|
| lib-orchestrator/OrchestratorService.cs | 1655 | AddNode | Success=true after loop even if ALL deployments failed (only warnings logged) |
| lib-orchestrator/OrchestratorService.cs | 1685 | RemoveNode | Success=true after loop even if ALL teardowns failed |
| lib-orchestrator/OrchestratorService.cs | 1704 | MoveService | Success=true without checking SetServiceRoutingAsync result |
| lib-orchestrator/OrchestratorService.cs | 1732 | Scale | Success=true even if ALL scale operations failed |

### CRITICAL - Game Session Operations

| File | Line | Method | Problem |
|------|------|--------|---------|
| lib-game-session/GameSessionService.cs | 464 | JoinGameSession | Success=true BEFORE voice room join and session save |
| lib-game-session/GameSessionService.cs | 601 | PerformGameAction | Success=true without any action validation or persistence |

### HIGH - Session/Permission Operations

| File | Line | Method | Problem |
|------|------|--------|---------|
| lib-permissions/PermissionsService.cs | 579 | UpdateSessionStateAsync | Success=true after SaveAsync without verification |
| lib-permissions/PermissionsService.cs | 1292 | HandleSessionConnectedAsync | Success=true without RecompileSessionPermissionsAsync return check |
| lib-permissions/PermissionsService.cs | 1360 | HandleSessionDisconnectedAsync | Success=true without state clear verification |

### HIGH - Voice Operations

| File | Line | Method | Problem |
|------|------|--------|---------|
| lib-voice/VoiceService.cs | 302 | JoinVoiceRoom (Scaled) | Success=true before permission updates |
| lib-voice/VoiceService.cs | 366 | JoinVoiceRoom (P2P) | Success=true after NotifyPeerJoinedAsync which is fire-and-forget |

---

## CATEGORY 4: Exception Swallowing That Allows Success Return

These catch blocks log errors but don't prevent the calling method from returning success.

### CRITICAL - Event Publishing Failures Swallowed

| File | Lines | Method | Problem |
|------|-------|--------|---------|
| lib-accounts/AccountsService.cs | 1095-1101 | PublishAccountCreatedEventAsync | Exception caught, CreateAccountAsync still returns Created |
| lib-accounts/AccountsService.cs | 1128-1134 | PublishAccountUpdatedEventAsync | Exception caught, UpdateAccountAsync still returns OK |
| lib-accounts/AccountsService.cs | 1164-1170 | PublishAccountDeletedEventAsync | Exception caught, DeleteAccountAsync still returns NoContent |
| lib-character/CharacterService.cs | 722-726 | PublishCharacterCreatedEventAsync | Exception caught, no error event published |
| lib-character/CharacterService.cs | 745-749 | PublishCharacterUpdatedEventAsync | Exception caught |
| lib-character/CharacterService.cs | 767-771 | PublishCharacterDeletedEventAsync | Exception caught |
| lib-character/CharacterService.cs | 789-793 | PublishCharacterRealmJoinedEventAsync | Exception caught |
| lib-character/CharacterService.cs | 811-815 | PublishCharacterRealmLeftEventAsync | Exception caught |
| lib-relationship/RelationshipService.cs | 768-771 | PublishRelationshipCreatedEventAsync | Exception caught |
| lib-relationship/RelationshipService.cs | 806-809 | PublishRelationshipUpdatedEventAsync | Exception caught |
| lib-relationship/RelationshipService.cs | 841-844 | PublishRelationshipDeletedEventAsync | Exception caught |

### CRITICAL - Index Management Failures

| File | Lines | Method | Problem |
|------|-------|--------|---------|
| lib-accounts/AccountsService.cs | 1263-1269 | RemoveAccountFromIndexAsync | Index removal fails but account deletion returns success |

### MEDIUM - Metadata Caching

| File | Lines | Method | Problem |
|------|-------|--------|---------|
| lib-behavior/BehaviorService.cs | 372-379 | ExtractAndCacheGoapMetadataAsync | GOAP extraction fails but compilation returns success |

---

## CATEGORY 5: Partial Success Returned as Full Success

These operations process multiple items but return OK even when some/all items failed.

### CRITICAL - Silent Delivery Failures

| File | Lines | Method | Problem |
|------|-------|--------|---------|
| lib-game-session/GameSessionService.cs | 975-977 | SendChatMessageAsync | Returns OK even if 0 messages delivered |
| lib-voice/VoiceService.cs | 680-681 | NotifyPeerJoinedAsync | Logs publishedCount but is void - caller can't know |
| lib-voice/VoiceService.cs | 720-721 | NotifyPeerLeftAsync | Same pattern |
| lib-voice/VoiceService.cs | 765-766 | NotifyPeerUpdatedAsync | Same pattern |
| lib-voice/VoiceService.cs | 808-809 | NotifyRoomClosedAsync | Same pattern |

### MEDIUM - Bulk Operations (caller CAN detect via response if they check)

| File | Lines | Method | Problem |
|------|-------|--------|---------|
| lib-documentation/DocumentationService.cs | 1046-1112 | BulkUpdateDocumentsAsync | Returns OK with Failed list - caller must inspect |
| lib-documentation/DocumentationService.cs | 1148-1196 | BulkDeleteDocumentsAsync | Returns OK with Failed list - caller must inspect |
| lib-documentation/DocumentationService.cs | 1239-1319 | ImportDocumentationAsync | Returns OK with counters - caller must inspect |

---

## FIX PRIORITY

### P0 - Fix Immediately (Security/Data Integrity) - ALL FIXED
1. ~~lib-auth/AuthService.cs:1009-1010 - Null roles/authorizations should return Unauthorized~~ **FIXED**
2. ~~lib-accounts/AccountsService.cs:1263-1269 - Index removal failure should fail delete~~ **FIXED**
3. ~~lib-game-session/GameSessionService.cs:601 - Game action Success=true without validation~~ **FIXED**
4. ~~lib-orchestrator/OrchestratorService.cs:1655,1685,1704,1732 - Topology changes reporting false success~~ **FIXED**

### P1 - Fix Soon (User Experience/Consistency)
5. All event publishing failures - Operation must BOTH fail AND publish error event (see Category 4)
6. lib-game-session/GameSessionService.cs:464 - Join session Success=true before voice/save
7. Silent null skips in loops - Add logging of skipped count, consider failing if too many

### P2 - Fix Eventually (Data Quality)
8. All null-coalescing patterns on metadata fields - Should use nullable types or explicit validation
9. Partial success patterns - Consider returning partial success status code (207 Multi-Status)

---

## CRITICAL ANALYSIS OF REMAINING VIOLATIONS

### Category 1: Null-Coalescing Analysis

**VALID - Must Fix:**
- `lib-auth/AuthService.cs:1148-1149` - DisplayName/Roles in session creation: If account data is corrupt, session shouldn't be created with fabricated values
- `lib-accounts/AccountsService.cs:652,676` - ExternalId in OAuth: Empty ExternalId breaks OAuth flow integrity

**VALID BUT LOWER PRIORITY:**
- Entity metadata fields (Category, Description, DeprecationReason) - These are truly optional metadata. Empty string is semantically correct for "no description". Not a violation.
- `lib-game-session/GameSessionService.cs:1438` GameSettings - Empty object for null settings may be acceptable if settings are optional

**REQUIRES INVESTIGATION:**
- `lib-game-session/GameSessionService.cs:498-499` SdpOffer/IceCandidates - Need to verify if these are truly required for WebRTC or can be empty in valid flows

### Category 2: Silent Null Skips Analysis

**VALID - Must Fix:**
- `lib-accounts/AccountsService.cs:138` - If 10 accounts requested and 3 are null, TotalCount=10 but list has 7. Response is misleading.
- `lib-game-session/GameSessionService.cs:156` - Same pattern, TotalCount mismatches actual returned sessions

**ACCEPTABLE:**
- `lib-relationship/RelationshipService.cs:224` - Bulk load where some IDs don't exist is expected (deletions between index query and data fetch)

### Category 3: Unconditional Success Analysis

**VALID - Must Fix:**
- `lib-game-session/GameSessionService.cs:464` JoinGameSession - Sets Success=true then does voice join and save. Should only succeed AFTER those complete
- `lib-permissions/PermissionsService.cs:579` UpdateSessionStateAsync - Should verify SaveAsync succeeded

**QUESTIONABLE:**
- `lib-voice/VoiceService.cs:302,366` - Voice operations are inherently "fire and forget" for notifications. Core join logic succeeds before notifications.
- `lib-permissions/PermissionsService.cs:1292,1360` - Event handlers that return void. Success flag in handler context may be irrelevant.

### Category 4: Exception Swallowing Analysis

**VALID - Must Fix (All of these):**
All event publishing try/catch blocks in Category 4 follow this pattern:
1. Main operation succeeds (account created, character updated, etc.)
2. Event publishing attempted in try block
3. Exception caught, logged, but caller never knows
4. Operation returns success despite event not being published

**The fix for all Category 4 violations is the same pattern:**
```csharp
catch (Exception ex)
{
    _logger.LogError(ex, "Failed to publish {Event} for {Id}", eventName, entityId);
    await _messageBus.TryPublishErrorAsync(_serviceId, operationName, ex.GetType().Name, ex.Message);
    // The original operation should STILL return failure if event publishing is critical
    // OR if the event is non-critical, the operation can still succeed but the error is logged
}
```

**Decision required:** Are these events CRITICAL (operation should fail if event fails) or INFORMATIONAL (operation succeeds, event is best-effort)?
- Account/Character lifecycle events → Likely CRITICAL (other services depend on them)
- Relationship events → May be INFORMATIONAL (local change succeeded)

### Category 5: Partial Success Analysis

**VALID - Must Fix:**
- `lib-game-session/GameSessionService.cs:975-977` SendChatMessageAsync - Returns OK even if 0 messages delivered. Should return partial failure or at least include delivery count.

**ACCEPTABLE:**
- `lib-documentation/DocumentationService.cs` bulk operations - Already return Failed lists, caller CAN detect partial failure

**NOT A VIOLATION:**
- `lib-voice/VoiceService.cs` notify methods - These are void notification helpers, not API endpoints. The caller (JoinVoiceRoom) should track success.

---

## TOTAL VIOLATIONS FOUND
- Category 1 (Null-Coalescing): 35+ instances → ~10 valid after analysis
- Category 2 (Silent Skips): 4 instances → 2 valid
- Category 3 (Unconditional Success): 11 instances → 3-5 valid after analysis
- Category 4 (Exception Swallowing): 14 instances → All 14 need review, ~10 need fix
- Category 5 (Partial Success): 9 instances → 1 needs fix, rest acceptable

REMAINING AFTER ANALYSIS: ~25-30 violations requiring fixes
