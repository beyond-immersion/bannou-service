# Potential TENET Violations Report

> **Generated**: 2026-01-09
> **Scope**: Comprehensive audit of all 24 TENET rules across the Bannou codebase

This document catalogs all potential TENET violations discovered during a comprehensive codebase audit. Violations are organized by tenet number, with file paths, line numbers, and remediation guidance.

---

## Executive Summary

| Tenet | Status | Violation Count | Severity |
|-------|--------|-----------------|----------|
| T0 (Tenet Number References) | VIOLATIONS | 11+ | Medium |
| T1 (Schema-First Development) | COMPLIANT | 0 | - |
| T2 (Code Generation System) | COMPLIANT | 0 | - |
| T3 (Event Consumer Fan-Out) | INCONSISTENCY | 1 | Low |
| T4 (Infrastructure Libs Pattern) | VIOLATIONS | 2 | Medium |
| T5 (Event-Driven Architecture) | COMPLIANT | 0 | - |
| T6 (Service Implementation Pattern) | VIOLATIONS | 5 | Medium |
| T7 (Error Handling) | VIOLATIONS | 150+ | Critical |
| T8 (Return Pattern) | VIOLATIONS | 42 | High |
| T9 (Multi-Instance Safety) | VIOLATIONS | 32+ | Critical |
| T10 (Logging Standards) | VIOLATIONS | 5 | Medium |
| T11 (Testing Requirements) | VIOLATIONS | 2 | High |
| T12 (Test Integrity) | VIOLATIONS | 6 | Medium |
| T13 (X-Permissions Usage) | VIOLATIONS | 24 | Critical |
| T14 (Polymorphic Associations) | VIOLATIONS | 4 | Medium |
| T15 (Browser-Facing Endpoints) | VIOLATIONS | 4 | Medium |
| T16 (Naming Conventions) | VIOLATIONS | 20 | Medium |
| T17 (Client Event Schema Pattern) | VIOLATIONS | 3 | High |
| T18 (Licensing Requirements) | COMPLIANT | 0 | - |
| T19 (XML Documentation Standards) | COMPLIANT | 0 | - |
| T20 (JSON Serialization) | COMPLIANT | 0 | - |
| T21 (Configuration-First) | COMPLIANT | 0 | - |
| T22 (Warning Suppression) | COMPLIANT | 0 | - |
| T23 (Async Method Pattern) | VIOLATIONS | 170+ | Critical |

---

## TENET 0: Never Reference Tenet Numbers in Source Code

**Status**: 11+ VIOLATIONS FOUND

### Violations

| File | Line | Content | Fix |
|------|------|---------|-----|
| `plugins/lib-character-history/CharacterHistoryService.cs` | 145, 332, 450, 521, 583, 634 | `// Publish typed event (T5 compliant)` | Use "IMPLEMENTATION TENETS compliant" |
| `plugins/lib-realm-history/RealmHistoryService.cs` | 129, 372, 531, 638, 711, 801 | `// Publish typed event (T5 compliant)` | Use "IMPLEMENTATION TENETS compliant" |
| `plugins/lib-actor/Caching/BehaviorDocumentCache.cs` | 17 | `Thread-safe via ConcurrentDictionary (T9 compliant)` | Use "IMPLEMENTATION TENETS compliant" |
| `plugins/lib-actor/Runtime/ActorRegistry.cs` | 7 | `Uses ConcurrentDictionary internally per T9` | Use "per IMPLEMENTATION TENETS" |
| `plugins/lib-actor/Runtime/IActorRegistry.cs` | 5 | `Uses ConcurrentDictionary internally per T9` | Use "per IMPLEMENTATION TENETS" |
| `bannou-service/Enums.cs` | 70, 74 | `See TENETS.md T8:` and `TENET T8` | Use category names |
| `bannou-service/Services/IMessageBus.cs` | 23 | `See TENETS.md T5:` | Use category name |
| `http-tester/Tests/MessagingTestHandler.cs` | 13 | `Required by T5` | Use "per FOUNDATION TENETS" |
| `scripts/generate-config.sh` | 139 | `WARNING: DO NOT EDIT THIS FILE (TENETS T1/T2)` | Use category name |
| `scripts/generate-interface.sh` | 46 | `WARNING: DO NOT EDIT THIS FILE (TENETS T1/T2)` | Use category name |
| `scripts/generate-permissions.sh` | 142 | `WARNING: DO NOT EDIT THIS FILE (TENETS T1/T2)` | Use category name |

---

## TENET 1: Schema-First Development

**Status**: COMPLIANT - No violations found

---

## TENET 2: Code Generation System

**Status**: COMPLIANT - No violations found

---

## TENET 3: Event Consumer Fan-Out

**Status**: 1 PATTERN INCONSISTENCY

### Inconsistency

| File | Line | Issue |
|------|------|-------|
| `plugins/lib-game-session/GameSessionService.cs` | 151 | Uses `RegisterEventConsumers(eventConsumer)` directly instead of `((IBannouService)this).RegisterEventConsumers(eventConsumer)` like other 29 services |

---

## TENET 4: Infrastructure Libs Pattern

**Status**: 2 VIOLATIONS FOUND

### Violations

| File | Line | Pattern | Severity |
|------|------|---------|----------|
| `plugins/lib-actor/Caching/BehaviorDocumentCache.cs` | 38 | `_httpClient = new HttpClient();` - Direct instantiation without IHttpClientFactory | HIGH |
| `bannou-service/Program.cs` | 640 | `using var httpClient = new HttpClient();` - Direct HttpClient in startup (may have DI constraints) | MEDIUM |

### Cleared After Investigation

| File | Line | Status | Reason |
|------|------|--------|--------|
| `plugins/lib-voice/Clients/KamailioClient.cs` | 15 | NOT A VIOLATION | HttpClient is properly injected via constructor parameter (line 37-44) |

---

## TENET 5: Event-Driven Architecture

**Status**: COMPLIANT - No violations found

---

## TENET 6: Service Implementation Pattern

**Status**: 5 VIOLATIONS FOUND (Helper services missing partial keyword and [BannouService] attribute)

### Violations

| File | Line | Issue |
|------|------|-------|
| `plugins/lib-documentation/Services/GitSyncService.cs` | 13 | `public class GitSyncService` - Missing `partial` and `[BannouService]` |
| `plugins/lib-documentation/Services/RedisSearchIndexService.cs` | 11 | `public class RedisSearchIndexService` - Missing `partial` and `[BannouService]` |
| `plugins/lib-auth/Services/TokenService.cs` | 20 | `public class TokenService` - Missing `partial` and `[BannouService]` |
| `plugins/lib-auth/Services/OAuthProviderService.cs` | 19 | `public class OAuthProviderService` - Missing `partial` and `[BannouService]` |
| `plugins/lib-auth/Services/SessionService.cs` | 14 | `public class SessionService` - Missing `partial` and `[BannouService]` |

---

## TENET 7: Error Handling

**Status**: 150+ VIOLATIONS FOUND

### Pattern: Missing ApiException handling before generic Exception

Services systematically catch generic `Exception` without first catching `ApiException` specifically.

| File | Violation Count | Lines (Sample) |
|------|-----------------|----------------|
| `plugins/lib-account/AccountService.cs` | 19 | 190, 320, 419, 517, 588, 629... |
| `plugins/lib-realm/RealmService.cs` | 14 | 78, 120, 199, 241, 319... |
| `plugins/lib-location/LocationService.cs` | 17 | 81, 118, 176, 245, 323... |
| `plugins/lib-mapping/MappingService.cs` | 21 | 370, 432, 507, 576, 618... |
| `plugins/lib-asset/AssetService.cs` | 11 | 247, 412, 480, 573, 639... |
| `plugins/lib-species/SpeciesService.cs` | 23 | 83, 140, 179, 253, 324... |
| `plugins/lib-game-session/GameSessionService.cs` | 22 | 201, 266, 309, 346, 482... |
| `plugins/lib-achievement/AchievementService.cs` | 15 | 148, 186, 270, 344, 391... |
| `plugins/lib-leaderboard/LeaderboardService.cs` | 12 | 166, 209, 292, 351, 423... |
| `plugins/lib-character/CharacterService.cs` | 13 | 163, 199, 286, 342, 381... |

### Issue: Error events emitted for user errors
All above services also emit `TryPublishErrorAsync` for ALL exceptions including expected user errors (400, 401, 403, 404, 409).

---

## TENET 8: Return Pattern

**Status**: 42 VIOLATIONS FOUND

### Pattern: Returning non-null response body with error status codes

| File | Violation Count | Lines (Sample) |
|------|-----------------|----------------|
| `plugins/lib-mapping/MappingService.cs` | 18 | 392, 402, 453, 467, 478, 535, 554, 606... |
| `plugins/lib-actor/ActorService.cs` | 5 | 1304, 1340, 1403, 1471, 1548 |
| `plugins/lib-behavior/BehaviorService.cs` | 4 | 108, 138, 502, 821 |
| `plugins/lib-testing/TestingService.cs` | 1 | 253 |
| `plugins/lib-messaging/MessagingService.cs` | 1 | 340 |
| `plugins/lib-connect/ConnectService.cs` | 1 | 174 |
| `plugins/lib-scene/SceneService.cs` | 1 | 477 |
| `plugins/lib-orchestrator/OrchestratorService.cs` | 7 | 505, 630, 663, 1759, 2151, 2167, 2750 |
| `plugins/lib-game-session/GameSessionService.cs` | 4 | 387, 416, 428, 440 |
| `plugins/lib-state/StateService.cs` | 1 | 109 |
| `plugins/lib-achievement/AchievementService.cs` | 1 | 851 |

---

## TENET 9: Multi-Instance Safety

**Status**: REDUCED - Most flagged items cleared after investigation

### Cleared After Investigation (NOT VIOLATIONS)

| File | Line | Status | Reason |
|------|------|--------|--------|
| `plugins/lib-behavior/Runtime/BehaviorModelInterpreter.cs` | 84 | NOT A VIOLATION | SDK Behavior Runtime exception (T4) - client-side code, has `SetRandomSeed()` for deterministic replay |
| `Bannou.SDK/Generated/Behavior/Runtime/BehaviorModelInterpreter.cs` | 84 | NOT A VIOLATION | Same - copied to SDK for game client execution |
| `Bannou.Client.SDK/Generated/Behavior/Runtime/BehaviorModelInterpreter.cs` | 84 | NOT A VIOLATION | Same - SDK client code |
| `plugins/lib-game-session/GameSessionService.cs` | 68 | NOT A VIOLATION | Explicitly documented as acceptable "Event-Backed Local Cache" pattern in T9 (lines 213-232) |

### Remaining Potential Issues (Questionable)

| File | Line | Issue | Notes |
|------|------|-------|-------|
| `bannou-service/Plugins/PluginLoader.cs` | 53-56 | Plain Dictionary fields | Used during single-threaded startup only - may be acceptable |
| `plugins/lib-documentation/Services/RedisSearchIndexService.cs` | 22 | `HashSet<string> _initializedNamespaces` | Uses lock(), could use ConcurrentDictionary instead |

### Category 4: Additional Plain Dictionary Fields (Lower Priority)
- ABML Parser Dictionaries (mostly single-threaded compilation)
- Messaging HashSets (typically protected by locks)

---

## TENET 10: Logging Standards

**Status**: 5 VIOLATIONS FOUND

### Violations

| File | Line | Issue | Type |
|------|------|-------|------|
| `plugins/lib-permission/PermissionServiceEvents.cs` | 215 | `[{Roles}]` and `[{Authorizations}]` in log template | Bracket formatting |
| `plugins/lib-state/Services/RedisSearchStateStore.cs` | 482 | `[{Fields}]` in log template | Bracket formatting |
| `plugins/lib-auth/AuthService.cs` | 89-90 | Logs JWT secret length | Sensitive metadata |
| `plugins/lib-auth/AuthService.cs` | 1148-1149 | Logs JWT secret length | Sensitive metadata |
| `plugins/lib-auth/AuthService.cs` | 843-844 | Logs first 10 chars of reset token | Partial token exposure |

---

## TENET 11: Testing Requirements

**Status**: 2 CRITICAL VIOLATIONS

### Violations

| File | Issue | Severity |
|------|-------|----------|
| `plugins/lib-connect/Protocol/BinaryProtocolTests.cs` | Test file in production directory instead of lib-connect.tests/ | CRITICAL |
| Missing `lib-testing.tests/` | No test project for lib-testing service | CRITICAL |

---

## TENET 12: Test Integrity

**Status**: 6 VIOLATIONS FOUND

### Pattern: Times.AtLeastOnce instead of Times.Once

| File | Line | Test Method |
|------|------|-------------|
| `plugins/lib-permission.tests/PermissionServiceTests.cs` | 272 | `RegisterServicePermissionsAsync_StoresPermissionMatrix` |
| `plugins/lib-permission.tests/PermissionServiceTests.cs` | 327 | `UpdateSessionRoleAsync_AddsSessionToActiveList` |
| `plugins/lib-permission.tests/PermissionServiceTests.cs` | 1280 | `HandleSessionConnectedAsync_PublishesSessionCapabilitiesEvent` |
| `plugins/lib-permission.tests/PermissionServiceTests.cs` | 1891 | `RegisterServicePermissionsAsync_PublishesOnlyToActiveConnections` |
| `plugins/lib-mapping.tests/MappingServiceTests.cs` | 873 | `HandleIngestEventAsync_WithValidToken_ShouldProcessPayloads` |
| `plugins/lib-orchestrator.tests/SmartRestartManagerTests.cs` | 184 | `RestartServiceAsync_WithEnvironmentVariables_ShouldStillAttemptRestart` |

---

## TENET 13: X-Permissions Usage

**Status**: 24 VIOLATIONS FOUND

### Missing x-permissions Declarations

| Schema File | Endpoints Missing x-permissions | Count |
|-------------|--------------------------------|-------|
| `schemas/connect-api.yaml` | `/internal/proxy`, `/connect` (GET), `/connect` (POST) | 3 |
| `schemas/state-api.yaml` | All 6 endpoints (`/state/get`, `/state/save`, etc.) | 6 |
| `schemas/messaging-api.yaml` | All 4 endpoints | 4 |
| `schemas/voice-api.yaml` | All 6 endpoints | 6 |
| `schemas/game-session-api.yaml` | 3 endpoints | 3 |
| `schemas/documentation-api.yaml` | 2 GET endpoints | 2 |

---

## TENET 14: Polymorphic Associations

**Status**: 4 VIOLATIONS FOUND

### Missing targetType discriminator

| File | Line | Field | Issue |
|------|------|-------|-------|
| `schemas/game-session-events.yaml` | 169-173 | `targetId` | Missing `targetType` discriminator |
| `schemas/game-session-client-events.yaml` | 388-392 | `targetId` (VisibleEffect) | Missing `targetType` |
| `schemas/game-session-api.yaml` | 945-950 | `targetId` (GameActionRequest) | Missing `targetType` |
| `schemas/actor-api.yaml` | 2003-2008 | `targetId` (ChoreographyAction) | Missing `targetType` |

---

## TENET 15: Browser-Facing Endpoints

**Status**: 4 VIOLATIONS

### Violations

| File | Endpoint | Issue |
|------|----------|-------|
| `schemas/documentation-api.yaml` | `GET /documentation/view/{slug}` | Missing x-permissions (undocumented browser-facing) |
| `schemas/documentation-api.yaml` | `GET /documentation/raw/{slug}` | Missing x-permissions (undocumented browser-facing) |
| `schemas/website-api.yaml` | `GET /website/content/{slug}` | Path parameter in GET violates POST-only |
| `schemas/website-api.yaml` | `GET /website/news`, `GET /website/downloads` | Query parameters in GET |

---

## TENET 16: Naming Conventions

**Status**: 20 VIOLATIONS FOUND

### Underscore in Event Topics

| File | Topic | Should Be |
|------|-------|-----------|
| `schemas/behavior-events.yaml` | `character.cinematic_extension` | `character.cinematic-extension` |
| `schemas/scene-events.yaml` | `scene.checked_out` | `scene.checked-out` |
| `schemas/scene-events.yaml` | `scene.validation_rules.updated` | `scene.validation-rules-updated` |
| `schemas/mapping-events.yaml` | `map.warnings.unauthorized_publish` | `map.warnings.unauthorized-publish` |

### Hyphen in Entity Names

| File | Topic | Should Be |
|------|-------|-----------|
| `schemas/orchestrator-events.yaml` | `bannou-service-heartbeats` | `bannou.service.heartbeats` |
| `schemas/orchestrator-events.yaml` | `bannou-full-service-mappings` | `bannou.full-service-mappings` |
| `schemas/mesh-events.yaml` | `bannou-service-heartbeats` | `bannou.service.heartbeats` |
| `schemas/mesh-events.yaml` | `bannou-full-service-mappings` | `bannou.full-service-mappings` |
| `schemas/character-history-events.yaml` | `character-history.*` (6 topics) | `character.history.*` |
| `schemas/realm-history-events.yaml` | `realm-history.*` (6 topics) | `realm.history.*` |
| `schemas/relationship-type-events.yaml` | `relationship-type.*` (3 topics) | `relationship.type.*` |

---

## TENET 17: Client Event Schema Pattern

**Status**: 3 VIOLATIONS FOUND

### Events in common-client-events.yaml that should be service-specific

| Event | Current Location | Should Be In | Used By |
|-------|------------------|--------------|---------|
| `SessionCapabilitiesEvent` | `common-client-events.yaml` | `permission-client-events.yaml` | Permission service |
| `SystemNotificationEvent` | `common-client-events.yaml` | `testing-client-events.yaml` | Testing service |
| `ShortcutPublishedEvent`, `ShortcutRevokedEvent` | `common-client-events.yaml` | `game-session-client-events.yaml` | GameSession service |

---

## TENET 18: Licensing Requirements

**Status**: COMPLIANT - No violations found

**Note**: MinIO, SIPSorcery, and similar packages were initially flagged but are NOT violations:
- **MinIO**: The `Minio` NuGet package is the Apache 2.0 licensed *client SDK*. The MinIO *server* (AGPL) runs as a separate infrastructure container we communicate with via network - this is explicitly allowed per the Infrastructure Container Exception.
- **SIPSorcery**: BSD-3-Clause licensed library. Any GPL-derived components (DTLS/SRTP) are in optional subsystems.

---

## TENET 19: XML Documentation Standards

**Status**: COMPLIANT - No violations found

---

## TENET 20: JSON Serialization

**Status**: COMPLIANT - No violations found (all uses in allowed exception categories)

---

## TENET 21: Configuration-First Development

**Status**: COMPLIANT - No violations found (all Environment access in allowed exceptions)

---

## TENET 22: Warning Suppression

**Status**: COMPLIANT - No violations found (all suppressions in allowed exceptions)

---

## TENET 23: Async Method Pattern

**Status**: 170+ VIOLATIONS FOUND

### Category 1: Non-Async Task Methods (14 violations)

| File | Methods |
|------|---------|
| `plugins/lib-achievement/Sync/SteamAchievementSync.cs` | `IsLinkedAsync`, `GetExternalIdAsync` |
| `plugins/lib-achievement/Sync/PlayStationAchievementSync.cs` | `IsLinkedAsync`, `GetExternalIdAsync`, `UnlockAsync`, `SetProgressAsync` |
| `plugins/lib-achievement/Sync/InternalAchievementSync.cs` | `IsLinkedAsync`, `GetExternalIdAsync`, `UnlockAsync`, `SetProgressAsync` |
| `plugins/lib-achievement/Sync/XboxAchievementSync.cs` | `IsLinkedAsync`, `GetExternalIdAsync`, `UnlockAsync`, `SetProgressAsync` |

### Category 2: Blocking .Result Calls (126 violations)

| File | Count | Lines (Sample) |
|------|-------|----------------|
| `plugins/lib-permission/PermissionService.cs` | 2 | 793-794 |
| `plugins/lib-state/Services/StateStoreFactory.cs` | 1 | 256 (GetAwaiter().GetResult()) |
| `plugins/lib-behavior/Runtime/CinematicController.cs` | 1 | - |
| `plugins/lib-voice/Clients/RtpEngineClient.cs` | 2 | - |
| `plugins/lib-messaging/Services/RabbitMQConnectionManager.cs` | 1 | - |
| `plugins/lib-documentation/Services/GitSyncService.cs` | 3 | - |
| `edge-tester/Tests/*.cs` | 69 | Multiple test handlers |

### Category 3: Return Task.CompletedTask (30+ violations)

| File | Count |
|------|-------|
| `GameTransport/LiteNetLibClientTransport.cs` | 1 |
| `GameTransport/LiteNetLibServerTransport.cs` | 1 |
| `Bannou.Client.Voice.SDK/*.cs` | 4 |
| `plugins/lib-messaging.tests/*.cs` | 18 |

---

## Priority Remediation Roadmap

### Critical (Block Release)
1. **TENET 13**: Add x-permissions to all 24 missing endpoints
2. **TENET 7**: Implement proper ApiException handling pattern across all services
3. **TENET 9**: Replace per-instance Random with seeded/shared values

### High Priority
1. **TENET 8**: Change all 42 error returns to use null second element
2. **TENET 23**: Convert all non-async Task methods to proper async/await
3. **TENET 4**: Replace direct HttpClient with IHttpClientFactory

### Medium Priority
1. **TENET 0**: Replace all tenet number references with category names
2. **TENET 6**: Add partial keyword and [BannouService] to helper services
3. **TENET 16**: Fix event topic naming to use proper kebab-case
4. **TENET 17**: Create service-specific client-events.yaml files

### Low Priority
1. **TENET 10**: Fix bracket formatting and sensitive data logging
2. **TENET 11**: Move BinaryProtocolTests.cs, create lib-testing.tests
3. **TENET 12**: Replace Times.AtLeastOnce with Times.Once
4. **TENET 14/15**: Add missing type discriminators and fix browser-facing endpoints

---

*Report generated by comprehensive codebase audit on 2026-01-09*
