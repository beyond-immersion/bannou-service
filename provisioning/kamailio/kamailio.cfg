# Kamailio SIP Proxy Configuration for Bannou Voice Service
# Designed for scaled tier voice conferencing via RTPEngine
# Part of Phase 2: Scaled Tier Implementation

#!KAMAILIO

####### Global Parameters #########

# Debug level (1=errors, 2=warnings, 3=info, 4+=debug)
debug=2
log_stderror=no
log_facility=LOG_LOCAL0

fork=yes
children=4

# SIP listeners
listen=udp:0.0.0.0:5060
listen=tcp:0.0.0.0:5060
listen=tcp:0.0.0.0:5080  # HTTP for JSONRPC

auto_aliases=no

####### Modules Section ########

# Core modules
loadmodule "tm.so"
loadmodule "sl.so"
loadmodule "rr.so"
loadmodule "pv.so"
loadmodule "maxfwd.so"
loadmodule "textops.so"
loadmodule "siputils.so"

# User location (memory-only for game sessions)
loadmodule "usrloc.so"
loadmodule "registrar.so"

# NAT traversal
loadmodule "nathelper.so"

# RTPEngine integration for media handling
loadmodule "rtpengine.so"

# Load balancing and dispatching
loadmodule "dispatcher.so"

# Dialog tracking for active calls
loadmodule "dialog.so"

# HTTP and JSONRPC for Bannou control
loadmodule "xhttp.so"
loadmodule "jsonrpcs.so"

####### Module Parameters ########

# User location - memory-only (game sessions are temporary)
modparam("usrloc", "db_mode", 0)
modparam("usrloc", "hash_size", 14)           # 16384 slots for thousands of users

# Registration expiry
modparam("registrar", "default_expires", 300) # 5 minute registration
modparam("registrar", "min_expires", 60)
modparam("registrar", "max_expires", 600)

# RTPEngine socket - connect to local RTPEngine container
modparam("rtpengine", "rtpengine_sock", "udp:127.0.0.1:22222")
modparam("rtpengine", "rtpengine_timeout", "3000")
modparam("rtpengine", "rtpengine_retr", 1)

# Dispatcher for load balancing multiple RTPEngine instances
modparam("dispatcher", "list_file", "/etc/kamailio/dispatcher.list")
modparam("dispatcher", "ds_ping_interval", 10)
modparam("dispatcher", "ds_probing_mode", 1)

# Dialog tracking for call statistics
modparam("dialog", "enable_stats", 1)
modparam("dialog", "db_mode", 0)              # Memory-only
modparam("dialog", "hash_size", 4096)

# JSONRPC - HTTP transport on port 5080
modparam("jsonrpcs", "transport", 1)          # HTTP transport
modparam("jsonrpcs", "pretty_format", 1)

# Transaction module timeouts
modparam("tm", "fr_timer", 5000)
modparam("tm", "fr_inv_timer", 30000)

####### Main Request Routing Logic ########

request_route {
    # Sanity checks - drop too many hops
    if (!mf_process_maxfwd_header("10")) {
        sl_send_reply("483", "Too Many Hops");
        exit;
    }

    # NAT detection and handling
    force_rport();
    if (nat_uac_test("19")) {
        setflag(1);  # NAT flag
        if (is_method("REGISTER")) {
            fix_nated_register();
        } else {
            fix_nated_contact();
        }
    }

    # Handle CANCEL requests
    if (is_method("CANCEL")) {
        if (t_check_trans()) {
            route(RELAY);
        }
        exit;
    }

    # Handle ACK
    if (is_method("ACK")) {
        if (t_check_trans()) {
            t_relay();
        }
        exit;
    }

    # Handle registrations
    if (is_method("REGISTER")) {
        route(REGISTRAR);
        exit;
    }

    # Record-route for INVITE and SUBSCRIBE
    if (is_method("INVITE|SUBSCRIBE")) {
        record_route();
    }

    # Handle INVITE for conference
    if (is_method("INVITE")) {
        route(INVITE);
        exit;
    }

    # Handle BYE for leaving conference
    if (is_method("BYE")) {
        route(BYE);
        exit;
    }

    # Relay all other requests
    route(RELAY);
}

####### Registration Route ########

route[REGISTRAR] {
    if (!save("location")) {
        sl_reply_error();
    }
    xlog("L_INFO", "Registration: $fU from $si:$sp\n");
    exit;
}

####### INVITE Route ########

route[INVITE] {
    # Start dialog tracking
    if (!dlg_manage()) {
        xlog("L_WARN", "Failed to start dialog tracking\n");
    }

    xlog("L_INFO", "INVITE: $fU -> $rU ($ru)\n");

    # Relay with RTPEngine
    route(RELAY);
}

####### BYE Route ########

route[BYE] {
    xlog("L_INFO", "BYE: $fU from dialog $dlg_id\n");

    # Delete RTPEngine session
    if (has_body("application/sdp")) {
        rtpengine_delete();
    }

    # Relay the BYE
    if (!t_relay()) {
        sl_reply_error();
    }
    exit;
}

####### Relay Route with RTPEngine ########

route[RELAY] {
    # RTPEngine for media handling
    if (has_body("application/sdp")) {
        if (isflagset(1)) {
            # NAT traversal - force ICE candidates
            rtpengine_manage("replace-origin replace-session-connection ICE=force");
        } else {
            rtpengine_manage("replace-origin replace-session-connection");
        }
    }

    if (!t_relay()) {
        sl_reply_error();
    }
    exit;
}

####### Reply Route ########

onreply_route {
    # NAT handling for replies
    if (nat_uac_test("1")) {
        fix_nated_contact();
    }

    # RTPEngine for SDP in replies
    if (has_body("application/sdp")) {
        if (isflagset(1)) {
            rtpengine_manage("replace-origin replace-session-connection ICE=force");
        } else {
            rtpengine_manage("replace-origin replace-session-connection");
        }
    }
}

####### Failure Route ########

failure_route[RTF] {
    if (t_is_canceled()) {
        exit;
    }

    xlog("L_WARN", "Call failed: $rU reason=$rs\n");

    # Clean up RTPEngine session on failure
    rtpengine_delete();
}

####### HTTP/JSONRPC Event Route ########

event_route[xhttp:request] {
    # JSONRPC endpoint for Bannou VoiceService control
    if ($hu =~ "^/RPC") {
        # Note: Add authentication in production via X-API-Key header
        xlog("L_DEBUG", "JSONRPC request from $si\n");
        jsonrpc_dispatch();
        return;
    }

    # Health check endpoint
    if ($hu == "/health") {
        xhttp_reply("200", "OK", "text/plain", "healthy");
        return;
    }

    # 404 for everything else
    xhttp_reply("404", "Not Found", "text/html", "<html><body>Not Found</body></html>");
}
