# Kamailio SIP Proxy Configuration for Bannou Voice Service
# Simplified config for testing scaled tier voice conferencing
# Part of Phase 2: Scaled Tier Implementation

#!KAMAILIO

####### Global Parameters #########

debug=3
log_stderror=yes
log_facility=LOG_LOCAL0

fork=yes
children=2

# SIP listeners
listen=udp:0.0.0.0:5060
listen=tcp:0.0.0.0:5060
listen=tcp:0.0.0.0:5080  # HTTP for JSONRPC

auto_aliases=no

# Required for HTTP requests without Content-Length
tcp_accept_no_cl=yes

####### Modules Section ########

# Core modules
loadmodule "tm.so"
loadmodule "sl.so"
loadmodule "rr.so"
loadmodule "pv.so"
loadmodule "maxfwd.so"
loadmodule "textops.so"
loadmodule "siputils.so"
loadmodule "xlog.so"

# User location (memory-only for game sessions)
loadmodule "usrloc.so"
loadmodule "registrar.so"

# RTPEngine integration for media handling
loadmodule "rtpengine.so"

# Dialog tracking for active calls
loadmodule "dialog.so"

# HTTP and JSONRPC for Bannou control
loadmodule "xhttp.so"
loadmodule "jsonrpcs.so"

####### Module Parameters ########

# User location - memory-only (game sessions are temporary)
modparam("usrloc", "db_mode", 0)
modparam("usrloc", "hash_size", 10)

# Registration expiry
modparam("registrar", "default_expires", 300)
modparam("registrar", "min_expires", 60)
modparam("registrar", "max_expires", 600)

# RTPEngine socket - connect to RTPEngine container
# In bridge networking, use container name
modparam("rtpengine", "rtpengine_sock", "udp:rtpengine:22222")
modparam("rtpengine", "rtpengine_tout_ms", 3000)
modparam("rtpengine", "rtpengine_retr", 2)

# Dialog tracking for call statistics
modparam("dialog", "enable_stats", 1)
modparam("dialog", "db_mode", 0)
modparam("dialog", "hash_size", 2048)

# JSONRPC - HTTP transport on port 5080
modparam("jsonrpcs", "transport", 1)
modparam("jsonrpcs", "pretty_format", 1)

# Transaction module timeouts
modparam("tm", "fr_timer", 5000)
modparam("tm", "fr_inv_timer", 30000)

####### Main Request Routing Logic ########

request_route {
    # Sanity checks - drop too many hops
    if (!mf_process_maxfwd_header("10")) {
        sl_send_reply("483", "Too Many Hops");
        exit;
    }

    # Handle CANCEL requests
    if (is_method("CANCEL")) {
        if (t_check_trans()) {
            t_relay();
        }
        exit;
    }

    # Handle ACK
    if (is_method("ACK")) {
        if (t_check_trans()) {
            t_relay();
        }
        exit;
    }

    # Handle registrations
    if (is_method("REGISTER")) {
        if (!save("location")) {
            sl_reply_error();
        }
        xlog("L_INFO", "Registration: $fU from $si:$sp\n");
        exit;
    }

    # Record-route for INVITE and SUBSCRIBE
    if (is_method("INVITE|SUBSCRIBE")) {
        record_route();
    }

    # Handle INVITE for conference
    if (is_method("INVITE")) {
        if (!dlg_manage()) {
            xlog("L_WARN", "Failed to start dialog tracking\n");
        }
        xlog("L_INFO", "INVITE: $fU -> $rU ($ru)\n");
    }

    # Handle BYE
    if (is_method("BYE")) {
        xlog("L_INFO", "BYE: $fU\n");
        if (has_body("application/sdp")) {
            rtpengine_delete();
        }
    }

    # RTPEngine for media handling on all requests with SDP
    if (has_body("application/sdp")) {
        rtpengine_manage("replace-origin replace-session-connection");
    }

    # Relay the request
    if (!t_relay()) {
        sl_reply_error();
    }
    exit;
}

####### Reply Route ########

onreply_route {
    # RTPEngine for SDP in replies
    if (has_body("application/sdp")) {
        rtpengine_manage("replace-origin replace-session-connection");
    }
}

####### HTTP/JSONRPC Event Route ########

event_route[xhttp:request] {
    # JSONRPC endpoint for Bannou VoiceService control
    if ($hu =~ "^/RPC") {
        xlog("L_DEBUG", "JSONRPC request from $si\n");
        jsonrpc_dispatch();
        return;
    }

    # Health check endpoint
    if ($hu == "/health") {
        xhttp_reply("200", "OK", "text/plain", "healthy");
        return;
    }

    # 404 for everything else
    xhttp_reply("404", "Not Found", "text/html", "<html><body>Not Found</body></html>");
}
