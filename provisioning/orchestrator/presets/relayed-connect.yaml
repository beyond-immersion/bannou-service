# Relayed Connect Preset
# Deploys a Connect service in Relayed mode for peer-to-peer routing tests.
#
# Topology:
# - Main node (already running): all services in External mode (default)
# - bannou-relayed (deployed by this preset): Full L1 stack with Connect in Relayed mode
#
# All L1 (AppFoundation) services are included per SERVICE-HIERARCHY.md:
# L1 is "Required for ANY deployment" â€” DI listeners, shared state, and
# co-location assumptions between L1 services (e.g., Permission's
# ISessionActivityListener for Connect) require the full L1 layer.
#
# When deployed, new WebSocket connections can be routed to this node,
# enabling peer-to-peer message routing between connected clients.
#
# Use Case:
# - Edge tests deploy this preset to test peer-to-peer routing
# - Validates Connect service responsibility handoff to new node
# - Tests that Relayed mode correctly includes peerGuid in capability manifest

name: relayed-connect
description: Relayed Connect node for peer-to-peer routing tests
category: testing

topology:
  nodes:
    # Relayed Connect node - full L1 stack with peer-to-peer WebSocket routing
    - name: bannou-relayed
      layers:
        # All L1 (AppFoundation) services - required for any deployment
        - AppFoundation
      replicas: 1
      environment:
        # Enable Relayed mode for peer-to-peer routing
        CONNECT_CONNECTION_MODE: "relayed"
        # Node-specific marker
        BANNOU_IS_RELAYED_NODE: "true"

  infrastructure:
    mysql:
      enabled: true
      version: "8.0"
    redis:
      enabled: true
      version: "7"
    rabbitmq:
      enabled: true
      version: "4.0-management"

environment:
  # Debug logging for test visibility
  BANNOU_APP_LOGGING_LEVEL: Debug

requiredBackends:
  - docker-compose
