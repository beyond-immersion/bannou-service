# Split Service Routing Test Preset
# Tests dynamic service-to-app-id routing with auth/account on separate node
# This validates the core multi-node routing architecture
#
# Topology:
# - Main node (already running): all services (connect in External mode, game-session generic, etc.)
# - bannou-auth (deployed by this preset): full L1 stack + game-session (test-game only)
#
# All L1 (AppFoundation) services are included per SERVICE-HIERARCHY.md:
# L1 is "Required for ANY deployment" â€” DI listeners, shared state, and
# co-location assumptions between L1 services require the full L1 layer.
#
# NOTE: The main node is NOT included here - orchestrator never deploys itself.
# Presets only define ADDITIONAL nodes to deploy alongside the main orchestrator node.
#
# Environment Inheritance:
# Deployed containers inherit ALL environment variables from the orchestrator,
# so there's no need to duplicate AUTH_*, STATE_*, etc. configuration here.
# Only specify overrides or node-specific configuration.
#
# When deployed, ServiceMappingEvents are published:
# - account -> bannou-auth
# - auth -> bannou-auth
# - game-session -> bannou-auth (for test-game only; main node handles "generic")
#
# The ServiceAppMappingResolver receives these events and routes accordingly.
# Other L1 services (connect, permission, chat, contract, resource) run on both
# nodes but the main node handles all routing for them.
#
# Game Session Partitioning:
# The bannou-auth node runs game-session with GAME_SESSION_SUPPORTED_GAME_SERVICES=test-game,
# meaning it only processes subscription.updated events for the "test-game" stub.
# The main node's game-session (default "generic") ignores "test-game" events.
# This tests the per-game horizontal scaling pattern where different nodes
# handle different games' lobbies. Since all game-session endpoints are accessed
# via prebound shortcuts, this partitioning is transparent to clients.

name: split-auth-routing-test
description: Split service deployment for routing validation - auth/account on separate node
category: testing

topology:
  nodes:
    # Auth node - full L1 stack plus test-game lobbies
    # Deployed as a SEPARATE container from the main orchestrator node
    - name: bannou-auth
      layers:
        # All L1 (AppFoundation) services - required for any deployment
        - AppFoundation
      services:
        # L2 service override for game session partitioning test
        - game-session
      replicas: 1
      environment:
        # Node-specific marker
        BANNOU_IS_AUTH_NODE: "true"
        # Only handle "test-game" subscriptions - main node handles "generic" catch-all
        GAME_SESSION_SUPPORTED_GAME_SERVICES: "test-game"

  infrastructure:
    mysql:
      enabled: true
      version: "8.0"
    redis:
      enabled: true
      version: "7"
    rabbitmq:
      enabled: true
      version: "3.12-management"

environment:
  # Only override logging if different from main node
  # All other configuration (AUTH_*, STATE_*, ACCOUNT_*, etc.) is
  # inherited from orchestrator's environment automatically
  BANNOU_APP_LOGGING_LEVEL: Debug

requiredBackends:
  - docker-compose
