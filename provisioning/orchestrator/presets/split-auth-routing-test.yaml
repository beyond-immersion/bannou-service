# Split Service Routing Test Preset
# Tests dynamic service-to-app-id routing with auth/account on separate node
# This validates the core multi-node routing architecture
#
# Topology:
# - Main node (already running): connect, permission, game-session (generic), behavior, orchestrator, etc.
# - bannou-auth (deployed by this preset): account, auth, game-session (test-game only)
#
# NOTE: The main node is NOT included here - orchestrator never deploys itself.
# Presets only define ADDITIONAL nodes to deploy alongside the main orchestrator node.
#
# Environment Inheritance:
# Deployed containers inherit ALL environment variables from the orchestrator,
# so there's no need to duplicate AUTH_*, STATE_*, etc. configuration here.
# Only specify overrides or node-specific configuration.
#
# When deployed, ServiceMappingEvents are published:
# - account -> bannou-auth
# - auth -> bannou-auth
# - game-session -> bannou-auth (for test-game only; main node handles "generic")
#
# The ServiceAppMappingResolver receives these events and routes accordingly.
#
# Game Session Partitioning:
# The bannou-auth node runs game-session with GAME_SESSION_SUPPORTED_GAME_SERVICES=test-game,
# meaning it only processes subscription.updated events for the "test-game" stub.
# The main node's game-session (default "generic") ignores "test-game" events.
# This tests the per-game horizontal scaling pattern where different nodes
# handle different games' lobbies. Since all game-session endpoints are accessed
# via prebound shortcuts, this partitioning is transparent to clients.

name: split-auth-routing-test
description: Split service deployment for routing validation - auth/account on separate node
category: testing

topology:
  nodes:
    # Auth node - handles authentication services and test-game lobbies
    # Deployed as a SEPARATE container from the main orchestrator node
    - name: bannou-auth
      services:
        - account
        - auth
        - game-session
      replicas: 1
      environment:
        # Node-specific marker
        BANNOU_IS_AUTH_NODE: "true"
        # Only handle "test-game" subscriptions - main node handles "generic" catch-all
        GAME_SESSION_SUPPORTED_GAME_SERVICES: "test-game"

  infrastructure:
    mysql:
      enabled: true
      version: "8.0"
    redis:
      enabled: true
      version: "7"
    rabbitmq:
      enabled: true
      version: "3.12-management"

environment:
  # Only override logging if different from main node
  # All other configuration (AUTH_*, STATE_*, ACCOUNT_*, etc.) is
  # inherited from orchestrator's environment automatically
  BANNOU_APP_LOGGING_LEVEL: Debug

requiredBackends:
  - docker-compose
