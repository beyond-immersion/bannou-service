# Orchestrator Service
# The orchestrator connects directly to Redis and RabbitMQ for infrastructure
# monitoring, and uses lib-mesh for service-to-service communication.
#
# Usage with Makefile:
#   make up-orchestrator    - Start orchestrator with infrastructure
#   make down-orchestrator  - Stop orchestrator stack
#   make test-orchestrator  - Test orchestrator APIs via http-tester
#
# Architecture:
#   - Direct Redis/RabbitMQ for orchestrator's infrastructure monitoring
#   - lib-mesh for service-to-service communication
#   - Docker socket access for container management operations

services:

  # Orchestrator instance - uses lib-mesh for service invocation
  bannou-orchestrator:
    image: bannou:latest
    build:
      context: ../
      dockerfile: provisioning/Dockerfile
    environment:
      # Orchestrator service only
      - BANNOU_APP_ID=orchestrator
      - ORCHESTRATOR_SERVICE_ENABLED=true
      - TESTING_SERVICE_ENABLED=false
      - ACCOUNTS_SERVICE_ENABLED=false
      - AUTH_SERVICE_ENABLED=false
      - BEHAVIOR_SERVICE_ENABLED=false
      - CONNECT_SERVICE_ENABLED=false
      - GAME_SESSION_SERVICE_ENABLED=false
      - PERMISSION_SERVICE_ENABLED=false
      - WEBSITE_SERVICE_ENABLED=false
      # Direct infrastructure connections for orchestrator's own monitoring
      - ORCHESTRATOR_REDIS_CONNECTION_STRING=bannou-redis:6379
      - ORCHESTRATOR_RABBITMQ_CONNECTION_STRING=amqp://guest:guest@rabbitmq:5672
      - ORCHESTRATOR_DOCKER_HOST=unix:///var/run/docker.sock
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"  # Docker socket access
      - "./certificates:/certificates"
      - "orchestrator-logs:/app/logs/"
    ports:
      - "8090:80"   # Orchestrator HTTP API (direct access for debugging)
      - "8493:443"  # Orchestrator HTTPS API
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://127.0.0.1:80/health"]
      interval: 15s
      timeout: 3s
      retries: 5
      start_period: 30s
    depends_on:
      bannou-redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy

volumes:
  orchestrator-logs:
