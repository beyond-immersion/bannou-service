# Base Bannou Services - Infrastructure libs pattern (no sidecars)
# Uses lib-mesh for service routing, lib-messaging for RabbitMQ, lib-state for Redis/MySQL

services:

  # Bannou monoservice - binds to 0.0.0.0 for WSL2 compatibility
  bannou:
    image: bannou:latest
    build:
      context: ../
      dockerfile: provisioning/Dockerfile
    environment:
      - BANNOU_APP_ID=bannou
    volumes:
      - "./certificates:/certificates"
      - "logs-data:/app/logs/"
      - "./orchestrator/presets:/app/provisioning/orchestrator/presets:ro"
    ports:
      - "8080:80"
      - "8443:443"
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://127.0.0.1:80/health"]
      interval: 30s
      timeout: 3s
      retries: 5
      start_period: 60s
    depends_on:
      rabbitmq:
        condition: service_healthy

  # RabbitMQ message broker - uses default bridge network
  rabbitmq:
    image: rabbitmq:4.0-management
    ports:
      - "5672:5672"   # AMQP port
      - "15672:15672" # Management UI
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "check_port_connectivity"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 30s

volumes:
  logs-data:
  rabbitmq-data:
