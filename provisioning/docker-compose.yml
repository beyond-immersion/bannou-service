# Base Bannou Services - WSL2 Compatible Networking
# Uses Docker's default bridge network for all internal communication
# No custom networks = no mDNS issues on WSL2/Windows

services:

  # Bannou monoservice - binds to 0.0.0.0 for WSL2 compatibility
  bannou:
    image: bannou:latest
    build:
      context: ../
      dockerfile: provisioning/Dockerfile
    environment:
      # Dapr endpoints - use 127.0.0.1 since sidecar shares network stack
      - DAPR_HTTP_ENDPOINT=http://127.0.0.1:3500
      - DAPR_GRPC_ENDPOINT=http://127.0.0.1:50001
    volumes:
      - "./certificates:/certificates"
      - "logs-data:/app/logs/"
    ports:
      - "8080:80"
      - "8443:443"
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://127.0.0.1:80/health"]
      interval: 30s
      timeout: 3s
      retries: 5
      start_period: 60s

  # Dapr sidecar - shares network stack with bannou container
  bannou-dapr:
    image: "daprio/daprd:edge"
    command: [
      "./daprd",
      "--app-id", "bannou",
      "--app-port", "80",
      "--app-protocol", "http",
      "--dapr-http-port", "3500",
      "--dapr-grpc-port", "50001",
      "--placement-host-address", "placement:50006",
      "--resources-path", "./components",
      "--log-level", "debug",
      "--enable-api-logging"
    ]
    volumes:
      - "./dapr/components/:/components"
      - "./certificates:/certificates"
    environment:
      - "SSL_CERT_DIR=/certificates"
    network_mode: "service:bannou"  # Share network stack with bannou
    restart: on-failure

  # Dapr placement service - uses default bridge network
  placement:
    image: "daprio/placement"
    command: [
      "./placement", "--port", "50006"
    ]
    ports:
      - "50006:50006"

  # RabbitMQ message broker - uses default bridge network
  rabbitmq:
    image: rabbitmq:3.12-management
    ports:
      - "5672:5672"   # AMQP port
      - "15672:15672" # Management UI
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "check_port_connectivity"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 30s

volumes:
  logs-data:
  rabbitmq-data:
