# OpenResty + Lua + Redis Configuration for Bannou
# Implements complex queue system with dynamic routing and service heartbeats
# Based on API-DESIGN.md requirements

worker_processes auto;
error_log logs/error.log warn;
pid logs/nginx.pid;

events {
    worker_connections 1024;
    use epoll;
    multi_accept on;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    # Logging format for debugging
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" '
                    'rt=$request_time uct="$upstream_connect_time" '
                    'uht="$upstream_header_time" urt="$upstream_response_time"';

    access_log logs/access.log main;

    # Performance optimizations
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;

    # Lua package path for our modules
    lua_package_path "/usr/local/openresty/lua/?.lua;;";

    # Redis connection pool
    lua_shared_dict redis_cluster_slot_locks 100k;

    # Service heartbeat cache
    lua_shared_dict service_heartbeat 10m;

    # Queue status cache
    lua_shared_dict queue_status 5m;

    # Service routing cache
    lua_shared_dict service_routes 5m;

    # Initialize Redis connections on worker start
    init_worker_by_lua_block {
        local redis = require "resty.redis"
        local redis_host = os.getenv("REDIS_HOST") or "routing-redis"
        local redis_port = os.getenv("REDIS_PORT") or 6379

        -- Store Redis connection info in shared memory
        ngx.shared.service_routes:set("redis_host", redis_host)
        ngx.shared.service_routes:set("redis_port", redis_port)

        ngx.log(ngx.INFO, "OpenResty worker initialized with Redis: ", redis_host, ":", redis_port)
    }

    # Upstream definitions for Bannou services
    upstream bannou_backend {
        server bannou:80 max_fails=3 fail_timeout=30s;
        keepalive 32;
    }

    # Queue Service Virtual Host (External Access)
    server {
        listen 80;
        server_name queue.localhost;

        # Queue status endpoint (external HTTP access)
        location /queue/status {
            access_by_lua_file /usr/local/openresty/lua/queue_auth.lua;
            content_by_lua_file /usr/local/openresty/lua/queue_status.lua;
        }

        # Queue join endpoint (external HTTP access)
        location /queue/join {
            access_by_lua_file /usr/local/openresty/lua/queue_auth.lua;
            content_by_lua_file /usr/local/openresty/lua/queue_join.lua;
        }

        # Queue grant endpoint (external HTTP access)
        location /queue/grant {
            access_by_lua_file /usr/local/openresty/lua/queue_auth.lua;
            content_by_lua_file /usr/local/openresty/lua/queue_grant.lua;
        }
    }

    # Auth Service Virtual Host
    server {
        listen 80;
        server_name auth.localhost;

        location / {
            # Add /authorization prefix for internal routing
            rewrite ^/(.*) /authorization/$1 break;

            # Service heartbeat checking and routing
            access_by_lua_file /usr/local/openresty/lua/service_route.lua;

            proxy_pass http://bannou_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Queue system headers
            proxy_set_header X-Queue-Token $http_x_queue_token;
            proxy_set_header X-User-Id $http_x_user_id;
        }

        # Internal Dapr endpoint for service-to-service communication
        location /internal/auth/ {
            internal;
            rewrite ^/internal/auth/(.*) /authorization/$1 break;
            proxy_pass http://bannou_backend;
        }
    }

    # Connect Service Virtual Host
    server {
        listen 80;
        server_name connect.localhost;

        location / {
            # Add /connect prefix for internal routing
            rewrite ^/(.*) /connect/$1 break;

            # WebSocket upgrade support
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            # Service routing for Connect service
            access_by_lua_file /usr/local/openresty/lua/service_route.lua;

            proxy_pass http://bannou_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # Default server (for testing and health checks)
    server {
        listen 80 default_server;
        listen 8080;  # Admin interface
        server_name _;

        # DNS resolver for container hostname resolution
        resolver 127.0.0.11 valid=30s;

        # Health check endpoint
        location /health {
            access_log off;
            content_by_lua_block {
                ngx.status = 200
                ngx.say("OpenResty OK")
            }
        }

        # Redis health check
        location /health/redis {
            content_by_lua_file /usr/local/openresty/lua/redis_health.lua;
        }

        # Service heartbeat status (admin interface)
        location /admin/heartbeats {
            content_by_lua_file /usr/local/openresty/lua/admin_heartbeats.lua;
        }

        # Queue status (admin interface)
        location /admin/queues {
            content_by_lua_file /usr/local/openresty/lua/admin_queues.lua;
        }

        # Default route to Bannou
        location / {
            proxy_pass http://bannou_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}