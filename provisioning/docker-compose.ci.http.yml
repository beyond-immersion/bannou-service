services:

  # build the monoservice with all libs
  bannou:
    env_file: ../.env.ci.http

  # HTTP testing configuration for bannou-dapr
  bannou-dapr:
    volumes:
      - "./dapr/components/ci/:/components"

  # HTTP integration testing container - mirrors infrastructure testing pattern
  # This container runs ON THE INTERNAL NETWORK and can access Dapr services directly
  bannou-http-tester:
    build:
      context: ..
      dockerfile: http-tester/Dockerfile
    env_file: ../.env.ci.http
    environment:
      - PLUGIN=${PLUGIN}
      - DAPR_HTTP_ENDPOINT=http://127.0.0.1:3500
      - DAPR_GRPC_ENDPOINT=http://127.0.0.1:50001
    ports:
      - "9000:80"
      - "9001:443"
    depends_on:
      bannou:
        condition: service_healthy
      placement:
        condition: service_started
    networks:
      - celestial_network
    command: ["dotnet", "run", "--project", "http-tester", "--configuration", "Release", "--no-build"]

  # Dapr sidecar for the http-tester
  bannou-http-tester-dapr:
    image: "daprio/daprd:edge"
    command: [
      "./daprd",
      "--app-id", "bannou-http-tester",
      "--app-port", "80",
      "--app-protocol", "http",
      "--dapr-http-port", "3500",
      "--placement-host-address", "placement:50006",
      "--resources-path", "./components",
      "--log-level", "debug",
      "--enable-api-logging"
    ]
    volumes:
      - "./dapr/components/ci/:/components"
      - "./certificates:/certificates"
    environment:
      - "SSL_CERT_DIR=/certificates"
    depends_on:
      rabbitmq:
        condition: service_healthy
    network_mode: "service:bannou-http-tester"

networks:
  celestial_network:
