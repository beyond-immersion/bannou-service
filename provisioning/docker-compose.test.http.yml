# HTTP Integration Test Configuration
# Service-to-service testing using Dapr service invocation
# Standalone Dapr containers with mDNS (default) for service discovery

services:

  bannou:
    env_file: ../.env.test.http
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"  # Docker socket for orchestrator

  # HTTP integration tester - simulates another service in datacenter
  bannou-http-tester:
    build:
      context: ..
      dockerfile: http-tester/Dockerfile
    env_file: ../.env.test.http
    environment:
      - PLUGIN=${PLUGIN}
      # Dapr is a standalone container, use Docker DNS to reach it
      - DAPR_HTTP_ENDPOINT=http://bannou-http-tester-dapr:3500
      - DAPR_GRPC_ENDPOINT=http://bannou-http-tester-dapr:50001
    ports:
      - "9000:80"
      - "9001:443"

  # Override Dapr sidecar for bannou - uses custom image that waits for RabbitMQ
  bannou-dapr:
    image: bannou-dapr-wait:latest
    build:
      context: ./dapr
      dockerfile: Dockerfile.dapr-wait
    command: [
      "--app-id", "bannou",
      "--app-port", "80",
      "--app-protocol", "http",
      "--app-channel-address", "bannou",
      "--dapr-http-port", "3500",
      "--dapr-grpc-port", "50001",
      "--placement-host-address", "placement:50006",
      "--resources-path", "/components",
      "--log-level", "debug",
      "--enable-api-logging"
    ]
    volumes:
      - "./dapr/components-http-test/:/components"
      - "./certificates:/certificates"
    environment:
      - "SSL_CERT_DIR=/certificates"
      - "RABBITMQ_HOST=rabbitmq"
      - "RABBITMQ_PORT=5672"
      - "RABBITMQ_MAX_RETRIES=30"
      - "RABBITMQ_RETRY_INTERVAL=2"
    # NO network_mode - standalone container with own IP

  # Dapr sidecar for HTTP tester - standalone container
  # Uses custom image that waits for RabbitMQ before starting Dapr
  bannou-http-tester-dapr:
    image: bannou-dapr-wait:latest
    build:
      context: ./dapr
      dockerfile: Dockerfile.dapr-wait
    command: [
      "--app-id", "bannou-http-tester",
      "--app-port", "80",
      "--app-protocol", "http",
      "--app-channel-address", "bannou-http-tester",
      "--dapr-http-port", "3500",
      "--dapr-grpc-port", "50001",
      "--placement-host-address", "placement:50006",
      "--resources-path", "/components",
      "--log-level", "debug",
      "--enable-api-logging"
    ]
    volumes:
      - "./dapr/components-http-test/:/components"
      - "./certificates:/certificates"
    environment:
      - "SSL_CERT_DIR=/certificates"
      - "RABBITMQ_HOST=rabbitmq"
      - "RABBITMQ_PORT=5672"
      - "RABBITMQ_MAX_RETRIES=30"
      - "RABBITMQ_RETRY_INTERVAL=2"
    # NO network_mode - standalone container with own IP
    restart: always
