services:

  # modifies the monoservice startup to include a bunch of ENVs for testing
  # and telling it wait for backing datastores, etc to start first
  bannou:
    environment:
      - APP_LOGGING_LEVEL=Information
      - ASPNETCORE_ENVIRONMENT=Development

  # Add healthcheck to MySQL service for better startup coordination
  account-db:
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "Franklin", "-pDevPassword"]
      timeout: 20s
      retries: 10
      interval: 10s

  # add the CI components to the dapr sidecar attached to the monoservice
  # Temporarily disable components to allow integration testing of HTTP endpoints
  bannou-dapr:
    volumes:
      - "./dapr/components/ci-disabled/:/components"
    restart: "no"

  # adds a new sidecar to the monoservice, just to run the shell script
  # which CURLs an API to trigger all of the integration tests to run
  bannou-tester:
    image: curlimages/curl:latest
    networks:
      - celestial_network
    volumes:
      - "../wait-for-health.sh:/wait-for-health.sh"
      - "../service-tests.sh:/service-tests.sh"
    stdin_open: false
    depends_on:
      - bannou
    command: sh -c "/wait-for-health.sh && /service-tests.sh"

  # silence filebeat during CI testing
  filebeat:
    logging:
      driver: none

networks:
  celestial_network:
