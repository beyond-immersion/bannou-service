# Voice Infrastructure - Kamailio + RTPEngine for Scaled Tier
# Part of Phase 2: Scaled Tier Implementation
#
# IMPORTANT: Both services use network_mode: host because:
# - SIP (5060) requires proper NAT handling and direct host access
# - RTP (10000-20000) requires kernel forwarding and direct UDP access
#
# Usage:
#   docker compose -f provisioning/docker-compose.voice.yml up -d

services:

  # Kamailio SIP Proxy
  # Handles SIP registration, routing, and RTPEngine integration
  # Official CI image from GitHub Container Registry: https://github.com/kamailio/kamailio-ci
  # kamailio-ci is the ready-to-use image (kamailio-docker is just a base/template)
  kamailio:
    image: ghcr.io/kamailio/kamailio-ci:master-alpine
    container_name: bannou-kamailio
    network_mode: host
    volumes:
      - ./kamailio/kamailio.cfg:/etc/kamailio/kamailio.cfg:ro
      - ./kamailio/dispatcher.list:/etc/kamailio/dispatcher.list:ro
    environment:
      - KAMAILIO_DEBUG_LEVEL=2
    restart: unless-stopped
    healthcheck:
      # Alpine doesn't have curl, use wget instead
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://127.0.0.1:5080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    depends_on:
      rtpengine:
        condition: service_healthy

  # RTPEngine Media Relay (SFU)
  # Handles RTP media forwarding, NAT traversal, and kernel-mode performance
  # Docker wrapper: MIT license (https://github.com/drachtio/docker-rtpengine)
  # RTPEngine software: GPL v3 (https://github.com/sipwise/rtpengine)
  rtpengine:
    image: drachtio/rtpengine:latest
    container_name: bannou-rtpengine
    network_mode: host
    privileged: true  # Required for kernel forwarding table access
    volumes:
      - ./rtpengine/rtpengine.conf:/etc/rtpengine/rtpengine.conf:ro
    environment:
      # Kernel forwarding table (0 = enabled, -1 = disabled)
      - TABLE=0
    restart: unless-stopped
    healthcheck:
      # Check if rtpengine is listening on ng protocol UDP port
      # (nc not available in this image, use ss instead)
      test: ["CMD", "bash", "-c", "ss -uln | grep -q ':22222'"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
