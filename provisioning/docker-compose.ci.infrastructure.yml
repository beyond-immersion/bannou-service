services:

  # build the monoservice with only the TESTING lib
  bannou:
    image: bannou:latest
    build:
      context: ../
      dockerfile: provisioning/Dockerfile
      args:
        BANNOU_SERVICES: "testing"
    env_file: ../.env.ci.infrastructure

  # Infrastructure testing configuration for bannou-dapr
  bannou-dapr:
    # Use minimal restart policy for infrastructure testing
    restart: "no"

  # adds a new sidecar to the monoservice, just to run the shell script
  # which CURLs an API to trigger all of the integration tests to run
  bannou-infra-tester:
    image: curlimages/curl:latest
    network_mode: service:bannou
    volumes:
      - "../scripts/wait-for-health.sh:/wait-for-health.sh"
      - "../scripts/infrastructure-tests.sh:/infrastructure-tests.sh"
    stdin_open: false
    depends_on:
      bannou:
        condition: service_healthy
      openresty:
        condition: service_healthy
    command: sh -c "/wait-for-health.sh && /infrastructure-tests.sh"

networks:
  celestial_network:
