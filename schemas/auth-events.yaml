openapi: 3.0.3
info:
  title: Auth Service Events
  description: |
    Event models for Auth service RabbitMQ pub/sub via MassTransit.
    Contains auth-specific events and subscription/publication declarations.

    **NRT Compliance**: AI agents MUST review docs/NRT-SCHEMA-RULES.md before
    modifying this schema. Optional reference types require `nullable: true`.
  version: 1.0.0
  x-event-subscriptions:
    # Account lifecycle events from Account service
    - topic: account.deleted
      event: AccountDeletedEvent
      handler: HandleAccountDeleted
    - topic: account.updated
      event: AccountUpdatedEvent
      handler: HandleAccountUpdated
    # Subscription changes from Subscriptions service
    - topic: subscription.updated
      event: SubscriptionUpdatedEvent
      handler: HandleSubscriptionUpdated
  x-event-publications:
    # Session lifecycle events published by Auth service
    - topic: session.invalidated
      event: SessionInvalidatedEvent
      description: Published when sessions are invalidated (logout, deletion, security)
    - topic: session.updated
      event: SessionUpdatedEvent
      description: Published when session roles/authorizations change

paths: {}  # Events don't have HTTP paths

components:
  schemas:
    # Base event schema - inherited by all service events
    # Duplicated here for $ref resolution; actual implementation in common-events.yaml
    BaseServiceEvent:
      type: object
      additionalProperties: false
      required:
        - eventId
        - timestamp
      properties:
        eventId:
          type: string
          description: Unique identifier for this event instance
        timestamp:
          type: string
          format: date-time
          description: When the event was created (UTC)

    # Auth-specific events (published by Auth service)
    # NOTE: Events Auth subscribes to (AccountDeletedEvent, etc.) are defined in their
    # canonical locations and accessed via BeyondImmersion.BannouService.Events namespace
    SessionInvalidatedEvent:
      allOf:
        - $ref: '#/components/schemas/BaseServiceEvent'
      type: object
      additionalProperties: false
      description: Event published when sessions are invalidated (logout, account deletion, etc.)
      required:
        - sessionIds
        - reason
      properties:
        accountId:
          type: string
          format: uuid
          nullable: true
          description: ID of the account whose sessions were invalidated
        sessionIds:
          type: array
          items:
            type: string
          description: List of session IDs that were invalidated
        reason:
          $ref: '#/components/schemas/SessionInvalidatedEventReason'
          description: The reason why the session(s) were invalidated
        disconnectClients:
          type: boolean
          default: true
          description: Whether Connect service should disconnect WebSocket clients

    SessionInvalidatedEventReason:
      type: string
      enum: [logout, account_deleted, security_revocation, admin_action, session_expired]
      description: Reason for session invalidation

    SessionUpdatedEvent:
      allOf:
        - $ref: '#/components/schemas/BaseServiceEvent'
      type: object
      additionalProperties: false
      description: |
        Published when a session's roles or authorizations change.
        Permission service subscribes to update capability compilation.
      required:
        - accountId
        - sessionId
        - roles
        - authorizations
        - reason
      properties:
        accountId:
          type: string
          format: uuid
          description: ID of the account whose session changed
        sessionId:
          type: string
          format: uuid
          description: ID of the session that changed
        roles:
          type: array
          items:
            type: string
          description: Current roles for the session
        authorizations:
          type: array
          items:
            type: string
          description: Current authorization strings (e.g., ["arcadia:authorized"])
        reason:
          $ref: '#/components/schemas/SessionUpdatedEventReason'
          description: The reason why the session was updated

    SessionUpdatedEventReason:
      type: string
      enum: [role_changed, authorization_changed, subscription_changed]
      description: Reason for session update
