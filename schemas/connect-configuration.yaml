openapi: 3.0.3
info:
  title: Connect Service Configuration
  description: |
    Configuration schema for Connect service.
    Properties are bound to environment variables with BANNOU_ prefix.

    **SCHEMA MODIFICATION GATE**: STOP. Before modifying this schema, you MUST:
    1. Read docs/reference/SCHEMA-RULES.md
    2. State which section applies to your change
    3. Only then proceed with edits
    Edits without stating the applicable rule are FORBIDDEN.
  version: 1.0.0
paths: {}
x-service-configuration:
  properties:
    MaxConcurrentConnections:
      type: integer
      description: Maximum number of concurrent WebSocket connections
      default: 10000
      env: CONNECT_MAX_CONCURRENT_CONNECTIONS
    HeartbeatIntervalSeconds:
      type: integer
      description: Interval between heartbeat messages
      default: 30
      env: CONNECT_HEARTBEAT_INTERVAL_SECONDS
    BufferSize:
      type: integer
      description: Size of message buffers in bytes
      default: 65536
      env: CONNECT_BUFFER_SIZE
    EnableClientToClientRouting:
      type: boolean
      description: Enable routing messages between WebSocket clients
      default: true
      env: CONNECT_ENABLE_CLIENT_TO_CLIENT_ROUTING
    MaxMessagesPerMinute:
      type: integer
      description: Rate limit for messages per minute per client
      default: 1000
      env: CONNECT_MAX_MESSAGES_PER_MINUTE
    RateLimitWindowMinutes:
      type: integer
      description: Rate limit window in minutes
      default: 1
      env: CONNECT_RATE_LIMIT_WINDOW_MINUTES
    # NOTE: JWT validation is delegated to Auth service via HTTP, no local secret needed
    ServerSalt:
      type: string
      description: Server salt for client GUID generation. Must be shared across all Connect instances for session shortcuts to work correctly. Change in production.
      env: CONNECT_SERVER_SALT
      default: "bannou-dev-connect-salt-change-in-production"

    ConnectionMode:
      type: string
      enum: ["external", "relayed", "internal"]
      description: "Connection mode: external (default, no broadcast), relayed (broadcast allowed), internal (minimal response, broadcast allowed)"
      default: "external"
      env: CONNECT_CONNECTION_MODE
    InternalAuthMode:
      type: string
      enum: ["service-token", "network-trust"]
      description: "Auth mode for internal connections: service-token (validate X-Service-Token) or network-trust (no auth)"
      default: "service-token"
      env: CONNECT_INTERNAL_AUTH_MODE
    InternalServiceToken:
      type: string
      nullable: true
      description: "Secret for X-Service-Token validation when InternalAuthMode is service-token"
      env: CONNECT_INTERNAL_SERVICE_TOKEN
      example: "your-internal-service-token-secret"

    # === Session/Connection TTLs (Tier 1) ===
    SessionTtlSeconds:
      type: integer
      env: CONNECT_SESSION_TTL_SECONDS
      default: 86400
      description: Session time-to-live in seconds (default 24 hours)

    HeartbeatTtlSeconds:
      type: integer
      env: CONNECT_HEARTBEAT_TTL_SECONDS
      default: 300
      description: Heartbeat data TTL in Redis in seconds (default 5 minutes)

    ReconnectionWindowSeconds:
      type: integer
      env: CONNECT_RECONNECTION_WINDOW_SECONDS
      default: 300
      description: Window for client reconnection after disconnect in seconds (default 5 minutes)

    # === WebSocket Connection Management (Tier 2) ===
    RpcCleanupIntervalSeconds:
      type: integer
      env: CONNECT_RPC_CLEANUP_INTERVAL_SECONDS
      default: 30
      description: Interval in seconds between pending RPC cleanup runs

    DefaultRpcTimeoutSeconds:
      type: integer
      env: CONNECT_DEFAULT_RPC_TIMEOUT_SECONDS
      default: 30
      description: Default timeout in seconds for RPC calls when not specified

    ConnectionCleanupIntervalSeconds:
      type: integer
      env: CONNECT_CONNECTION_CLEANUP_INTERVAL_SECONDS
      default: 30
      description: Interval in seconds between connection cleanup runs

    InactiveConnectionTimeoutMinutes:
      type: integer
      env: CONNECT_INACTIVE_CONNECTION_TIMEOUT_MINUTES
      default: 30
      description: Timeout in minutes after which inactive connections are cleaned up

    PendingMessageTimeoutSeconds:
      type: integer
      env: CONNECT_PENDING_MESSAGE_TIMEOUT_SECONDS
      default: 30
      description: Timeout in seconds for pending messages awaiting acknowledgment

    ConnectionShutdownTimeoutSeconds:
      type: integer
      env: CONNECT_CONNECTION_SHUTDOWN_TIMEOUT_SECONDS
      default: 5
      description: Timeout in seconds when waiting for connection closure during shutdown
    ReconnectionWindowExtensionMinutes:
      type: integer
      env: CONNECT_RECONNECTION_WINDOW_EXTENSION_MINUTES
      default: 1
      description: Additional minutes added to reconnection window on each extension

    CompanionRoomMode:
      $ref: 'connect-api.yaml#/components/schemas/CompanionRoomMode'
      env: CONNECT_COMPANION_ROOM_MODE
      default: Disabled
      description: How Connect manages companion chat rooms (Disabled, AutoJoinLazy, AutoJoin, Manual)

    # === Outbound Payload Compression ===
    CompressionEnabled:
      type: boolean
      env: CONNECT_COMPRESSION_ENABLED
      default: false
      description: Enable Brotli compression for outbound WebSocket payloads above the size threshold

    CompressionThresholdBytes:
      type: integer
      env: CONNECT_COMPRESSION_THRESHOLD_BYTES
      default: 1024
      minimum: 64
      maximum: 1048576
      description: Minimum payload size in bytes before compression is applied (payloads below this are sent uncompressed)

    CompressionQuality:
      type: integer
      env: CONNECT_COMPRESSION_QUALITY
      default: 1
      minimum: 0
      maximum: 11
      description: Brotli compression quality level (0=no compression, 1=fastest, 11=best ratio). Quality 1 recommended for real-time traffic.

    # === Multi-Node Broadcast ===
    MultiNodeBroadcastMode:
      $ref: 'connect-api.yaml#/components/schemas/BroadcastMode'
      env: CONNECT_MULTINODE_BROADCAST_MODE
      default: None
      description: Multi-node broadcast directionality (None disables broadcast relay entirely, requires BroadcastInternalUrl to be set)

    BroadcastInternalUrl:
      type: string
      nullable: true
      env: CONNECT_BROADCAST_INTERNAL_URL
      description: WebSocket URL where this instance accepts inter-node broadcast connections (null disables broadcast regardless of mode)

    BroadcastHeartbeatIntervalSeconds:
      type: integer
      env: CONNECT_BROADCAST_HEARTBEAT_INTERVAL_SECONDS
      default: 30
      minimum: 5
      maximum: 300
      description: Interval in seconds between broadcast registry heartbeat refreshes

    BroadcastStaleThresholdSeconds:
      type: integer
      env: CONNECT_BROADCAST_STALE_THRESHOLD_SECONDS
      default: 90
      minimum: 15
      maximum: 600
      description: Threshold in seconds after which a broadcast registry entry is considered stale and removed

# Note: Event subscriptions are handled via MassTransit consumers in ConnectEventsController.cs
# Topics subscribed: session.invalidated, permission.capabilities-updated
