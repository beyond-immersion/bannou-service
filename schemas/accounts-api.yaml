openapi: 3.0.0
info:
  title: Bannou Accounts Service API
  description: |
    Internal account management service (CRUD operations only, never exposed to internet).

    **POST-Only API Pattern**: This API uses POST for all operations to support zero-copy
    WebSocket routing. Path parameters are passed in request bodies instead of URLs.
    See API-DESIGN.md for architectural rationale.
  version: 2.0.0
servers:
- url: http://localhost:3500/v1.0/invoke/bannou/method
  description: Dapr sidecar endpoint (internal only)

# NOTE: x-lifecycle moved to accounts-events.yaml

paths:
  /accounts/list:
    post:
      summary: List accounts with filtering
      operationId: listAccounts
      tags:
      - Account Management
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ListAccountsRequest'
      responses:
        '200':
          description: Accounts retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AccountListResponse'

  /accounts/create:
    post:
      summary: Create new account
      operationId: createAccount
      tags:
      - Account Management
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateAccountRequest'
      responses:
        '201':
          description: Account created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AccountResponse'
        '400':
          description: Invalid account data
        '409':
          description: Account already exists

  /accounts/get:
    post:
      summary: Get account by ID
      operationId: getAccount
      tags:
      - Account Management
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetAccountRequest'
      responses:
        '200':
          description: Account retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AccountResponse'
        '404':
          description: Account not found

  /accounts/update:
    post:
      summary: Update account
      operationId: updateAccount
      tags:
      - Account Management
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateAccountRequest'
      responses:
        '200':
          description: Account updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AccountResponse'
        '404':
          description: Account not found
        '400':
          description: Invalid update data

  /accounts/delete:
    post:
      summary: Delete account
      operationId: deleteAccount
      tags:
      - Account Management
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeleteAccountRequest'
      responses:
        '204':
          description: Account deleted successfully
        '404':
          description: Account not found
        '409':
          description: Account cannot be deleted (active sessions exist)

  /accounts/by-email:
    post:
      summary: Get account by email
      operationId: getAccountByEmail
      tags:
      - Account Lookup
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetAccountByEmailRequest'
      responses:
        '200':
          description: Account retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AccountResponse'
        '404':
          description: Account not found

  /accounts/auth-methods/list:
    post:
      summary: Get authentication methods for account
      operationId: getAuthMethods
      tags:
      - Authentication Methods
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetAuthMethodsRequest'
      responses:
        '200':
          description: Authentication methods retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthMethodsResponse'
        '404':
          description: Account not found

  /accounts/auth-methods/add:
    post:
      summary: Add authentication method to account
      operationId: addAuthMethod
      tags:
      - Authentication Methods
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddAuthMethodRequest'
      responses:
        '201':
          description: Authentication method added successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthMethodResponse'
        '404':
          description: Account not found
        '409':
          description: Authentication method already exists

  /accounts/auth-methods/remove:
    post:
      summary: Remove authentication method from account
      operationId: removeAuthMethod
      tags:
      - Authentication Methods
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RemoveAuthMethodRequest'
      responses:
        '204':
          description: Authentication method removed successfully
        '404':
          description: Account or method not found
        '400':
          description: Cannot remove last authentication method

  /accounts/by-provider:
    post:
      summary: Get account by external provider ID
      operationId: getAccountByProvider
      tags:
      - Account Lookup
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetAccountByProviderRequest'
      responses:
        '200':
          description: Account retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AccountResponse'
        '404':
          description: Account not found

  /accounts/profile/update:
    post:
      summary: Update account profile
      operationId: updateProfile
      tags:
      - Profile Management
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateProfileRequest'
      responses:
        '200':
          description: Profile updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AccountResponse'
        '404':
          description: Account not found

  /accounts/password/update:
    post:
      summary: Update account password hash
      operationId: updatePasswordHash
      tags:
      - Account Management
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdatePasswordRequest'
      responses:
        '200':
          description: Password hash updated successfully
        '404':
          description: Account not found

  /accounts/verification/update:
    post:
      summary: Update email verification status
      operationId: updateVerificationStatus
      tags:
      - Account Management
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateVerificationRequest'
      responses:
        '200':
          description: Verification status updated successfully
        '404':
          description: Account not found

components:
  schemas:
    # Shared Enum Definitions (consolidated to avoid duplication)
    AuthProvider:
      type: string
      description: All authentication provider types including email
      enum: [email, google, discord, twitch, steam]

    OAuthProvider:
      type: string
      description: OAuth provider types (excludes email)
      enum: [google, discord, twitch, steam]

    # Request Models for POST-only pattern
    ListAccountsRequest:
      type: object
      description: Request to list accounts with optional filtering
      properties:
        email:
          type: string
          format: email
          nullable: true
        displayName:
          type: string
          nullable: true
        provider:
          allOf:
          - $ref: '#/components/schemas/AuthProvider'
          nullable: true
        verified:
          type: boolean
          nullable: true
        page:
          type: integer
          minimum: 1
          default: 1
        pageSize:
          type: integer
          minimum: 1
          maximum: 100
          default: 20

    GetAccountRequest:
      type: object
      description: Request to get a specific account by ID
      required:
      - accountId
      properties:
        accountId:
          type: string
          format: uuid
          description: ID of the account to retrieve

    DeleteAccountRequest:
      type: object
      description: Request to delete a specific account
      required:
      - accountId
      properties:
        accountId:
          type: string
          format: uuid
          description: ID of the account to delete

    GetAccountByEmailRequest:
      type: object
      description: Request to get account by email address
      required:
      - email
      properties:
        email:
          type: string
          format: email
          description: Email address to look up

    GetAuthMethodsRequest:
      type: object
      description: Request to get authentication methods for an account
      required:
      - accountId
      properties:
        accountId:
          type: string
          format: uuid
          description: ID of the account

    RemoveAuthMethodRequest:
      type: object
      description: Request to remove an authentication method from an account
      required:
      - accountId
      - methodId
      properties:
        accountId:
          type: string
          format: uuid
          description: ID of the account
        methodId:
          type: string
          format: uuid
          description: ID of the authentication method to remove

    GetAccountByProviderRequest:
      type: object
      description: Request to get account by external provider ID
      required:
      - provider
      - externalId
      properties:
        provider:
          $ref: '#/components/schemas/OAuthProvider'
          description: OAuth provider type
        externalId:
          type: string
          description: External ID from the provider

    CreateAccountRequest:
      type: object
      required:
      - email
      properties:
        email:
          type: string
          format: email
        passwordHash:
          type: string
          nullable: true
          description: Pre-hashed password from Auth service
        displayName:
          type: string
          nullable: true
          maxLength: 100
        emailVerified:
          type: boolean
          default: false
        roles:
          type: array
          items:
            type: string
          default: []
        metadata:
          type: object
          additionalProperties: true
          nullable: true

    UpdateAccountRequest:
      type: object
      required:
      - accountId
      properties:
        accountId:
          type: string
          format: uuid
          description: ID of the account to update
        displayName:
          type: string
          nullable: true
          maxLength: 100
        roles:
          type: array
          items:
            type: string
        metadata:
          type: object
          additionalProperties: true
          nullable: true

    UpdateProfileRequest:
      type: object
      required:
      - accountId
      properties:
        accountId:
          type: string
          format: uuid
          description: ID of the account to update
        displayName:
          type: string
          nullable: true
          maxLength: 100
        metadata:
          type: object
          additionalProperties: true
          nullable: true

    UpdatePasswordRequest:
      type: object
      required:
      - accountId
      - passwordHash
      properties:
        accountId:
          type: string
          format: uuid
          description: ID of the account to update
        passwordHash:
          type: string
          description: New pre-hashed password from Auth service

    UpdateVerificationRequest:
      type: object
      required:
      - accountId
      - emailVerified
      properties:
        accountId:
          type: string
          format: uuid
          description: ID of the account to update
        emailVerified:
          type: boolean

    AddAuthMethodRequest:
      type: object
      required:
      - accountId
      - provider
      properties:
        accountId:
          type: string
          format: uuid
          description: ID of the account to add auth method to
        provider:
          $ref: '#/components/schemas/OAuthProvider'
        externalId:
          type: string
        displayName:
          type: string
          nullable: true

    # Response Models
    AccountResponse:
      type: object
      required:
      - accountId
      - email
      - createdAt
      - emailVerified
      - roles
      properties:
        accountId:
          type: string
          format: uuid
        email:
          type: string
          format: email
        displayName:
          type: string
          nullable: true
        passwordHash:
          type: string
          nullable: true
          description: BCrypt hashed password for authentication
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
          nullable: true
        emailVerified:
          type: boolean
        roles:
          type: array
          items:
            type: string
        authMethods:
          type: array
          items:
            $ref: '#/components/schemas/AuthMethodInfo'
        metadata:
          type: object
          additionalProperties: true
          nullable: true

    AuthMethodInfo:
      type: object
      required:
      - provider
      - linkedAt
      properties:
        methodId:
          type: string
          format: uuid
        provider:
          $ref: '#/components/schemas/AuthProvider'
        externalId:
          type: string
          nullable: true
        displayName:
          type: string
          nullable: true
        linkedAt:
          type: string
          format: date-time

    AuthMethodResponse:
      type: object
      required:
      - methodId
      - provider
      - linkedAt
      properties:
        methodId:
          type: string
          format: uuid
        provider:
          $ref: '#/components/schemas/OAuthProvider'
        externalId:
          type: string
        displayName:
          type: string
          nullable: true
        linkedAt:
          type: string
          format: date-time

    AuthMethodsResponse:
      type: object
      required:
      - authMethods
      properties:
        authMethods:
          type: array
          items:
            $ref: '#/components/schemas/AuthMethodInfo'

    AccountListResponse:
      type: object
      required:
      - accounts
      - totalCount
      - page
      - pageSize
      properties:
        accounts:
          type: array
          items:
            $ref: '#/components/schemas/AccountResponse'
        totalCount:
          type: integer
        page:
          type: integer
        pageSize:
          type: integer
        hasNextPage:
          type: boolean
        hasPreviousPage:
          type: boolean

