openapi: 3.0.0
info:
  title: Bannou Accounts API
  version: 1.0.0
  description: |
    User account management for Bannou services.
    
    This API handles:
    - Account creation with multiple authentication methods (username/password, Steam OAuth, Google OAuth)
    - Account retrieval and management
    - Complex claims system for roles, apps, scopes, identity, and profile data
    - Integration with Dapr service mesh

servers:
  - url: http://localhost/api/accounts
    description: Development server

paths:
  /create:
    post:
      summary: Create new user account
      description: |
        Creates a new user account with support for multiple authentication methods.
        At least one identity method must be provided (username, email, or OAuth).
      operationId: CreateAccount
      tags:
        - Accounts
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateAccountRequest'
            examples:
              username-password:
                summary: Username and password registration
                value:
                  username: "gameuser123"
                  password: "SecurePassword123!"
                  email: "user@example.com"
                  email_verified: false
                  two_factor_enabled: false
                  region: "us-east"
              steam-oauth:
                summary: Steam OAuth registration
                value:
                  steam_id: "76561198012345678"
                  steam_token: "steam_auth_token_here"
                  username: "SteamUser"
                  email: "steamuser@example.com"
                  email_verified: true
              google-oauth:
                summary: Google OAuth registration
                value:
                  google_id: "google_user_id_12345"
                  google_token: "google_auth_token_here"
                  email: "googleuser@gmail.com"
                  email_verified: true
      responses:
        '200':
          description: Account created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateAccountResponse'
        '400':
          description: Invalid request data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Account already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /get:
    post:
      summary: Retrieve user account
      description: |
        Retrieves user account information by various identifiers.
        At least one identifier must be provided.
      operationId: GetAccount
      tags:
        - Accounts
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetAccountRequest'
            examples:
              by-id:
                summary: Get account by ID
                value:
                  id: 12345
                  include_claims: true
              by-username:
                summary: Get account by username
                value:
                  username: "gameuser123"
                  include_claims: false
      responses:
        '200':
          description: Account retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetAccountResponse'
        '400':
          description: Invalid request data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Account not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    CreateAccountRequest:
      type: object
      description: Request to create a new user account
      properties:
        username:
          type: string
          description: Username - optional if using OAuth
          minLength: 3
          maxLength: 32
          pattern: '^[a-zA-Z0-9_]+$'
          example: "gameuser123"
        password:
          type: string
          description: Password - optional if using OAuth
          minLength: 8
          maxLength: 128
          format: password
          example: "SecurePassword123!"
        steam_id:
          type: string
          description: Steam user ID, if using Steam OAuth
          pattern: '^[0-9]+$'
          example: "76561198012345678"
        steam_token:
          type: string
          description: Steam user token, if using Steam OAuth
          example: "steam_auth_token_here"
        google_id:
          type: string
          description: Google user ID, if using Google OAuth
          example: "google_user_id_12345"
        google_token:
          type: string
          description: Google user token, if using Google OAuth
          example: "google_auth_token_here"
        email:
          type: string
          description: Email address - optional
          format: email
          maxLength: 255
          example: "user@example.com"
        region:
          type: string
          description: Account creation region - used for routing and metrics
          maxLength: 32
          example: "us-east"
        email_verified:
          type: boolean
          description: Whether the email should be considered verified
          default: false
        two_factor_enabled:
          type: boolean
          description: Whether 2-factor authentication has been enabled
          default: false
        role_claims:
          type: array
          description: System-wide role claims (Administrator, User, etc.)
          items:
            type: string
          example: ["User"]
        app_claims:
          type: array
          description: Application access claims, may include licenses
          items:
            type: string
          example: ["ArcadiaGame", "ArcadiaGame:LICENSE_abc123"]
        scope_claims:
          type: array
          description: Specific permissions within applications
          items:
            type: string
          example: ["ArcadiaGame:CREATE_CHARACTER", "ArcadiaGame:TRADE_ITEMS"]
        identity_claims:
          type: array
          description: Identity-related claims (OAuth tokens, hashed passwords)
          items:
            type: string
          example: ["STEAM_OAUTH_ENABLED"]
        profile_claims:
          type: array
          description: Generic profile information
          items:
            type: string
          example: ["Age:25", "Region:US", "Timezone:EST"]

    CreateAccountResponse:
      type: object
      description: Response from account creation
      required:
        - id
        - created_at
      properties:
        id:
          type: integer
          description: Unique account identifier
          format: int32
          example: 12345
        username:
          type: string
          description: Account username
          example: "gameuser123"
        email:
          type: string
          description: Account email address
          format: email
          example: "user@example.com"
        email_verified:
          type: boolean
          description: Email verification status
          example: false
        region:
          type: string
          description: Account region
          example: "us-east"
        security_token:
          type: string
          description: Security token for account operations
          example: "secure_token_abc123"
        two_factor_enabled:
          type: boolean
          description: 2FA status
          example: false
        lockout_end:
          type: string
          description: Account lockout end time (if locked)
          format: date-time
          nullable: true
        last_login_at:
          type: string
          description: Last login timestamp
          format: date-time
          nullable: true
        created_at:
          type: string
          description: Account creation timestamp
          format: date-time
          example: "2024-01-01T12:00:00Z"
        updated_at:
          type: string
          description: Last account update timestamp
          format: date-time
          nullable: true
        deleted_at:
          type: string
          description: Account deletion timestamp (soft delete)
          format: date-time
          nullable: true
        app_claims:
          type: array
          description: Application claims assigned to account
          items:
            type: string
        identity_claims:
          type: array
          description: Identity claims assigned to account
          items:
            type: string

    GetAccountRequest:
      type: object
      description: Request to retrieve account information
      properties:
        id:
          type: integer
          description: Account ID
          format: int32
          example: 12345
        username:
          type: string
          description: Account username
          example: "gameuser123"
        email:
          type: string
          description: Account email
          format: email
          example: "user@example.com"
        steam_id:
          type: string
          description: Steam user ID
          example: "76561198012345678"
        google_id:
          type: string
          description: Google user ID
          example: "google_user_id_12345"
        identity_claim:
          type: string
          description: Specific identity claim to search by
          example: "SteamIDToken:abc123"
        include_claims:
          type: boolean
          description: Whether to include all claims in response
          default: false

    GetAccountResponse:
      type: object
      description: Account information response
      allOf:
        - $ref: '#/components/schemas/CreateAccountResponse'
        - type: object
          properties:
            role_claims:
              type: array
              description: Role claims (only if include_claims=true)
              items:
                type: string
            scope_claims:
              type: array
              description: Scope claims (only if include_claims=true)
              items:
                type: string
            profile_claims:
              type: array
              description: Profile claims (only if include_claims=true)
              items:
                type: string

    ErrorResponse:
      type: object
      description: Error response
      required:
        - error
        - message
      properties:
        error:
          type: string
          description: Error type
          example: "INVALID_REQUEST"
        message:
          type: string
          description: Human-readable error message
          example: "Username is required when not using OAuth"
        details:
          type: object
          description: Additional error details
          additionalProperties: true

tags:
  - name: Accounts
    description: User account management operations