openapi: 3.0.0
info:
  title: Bannou Achievement Service API
  description: |
    Achievement and trophy system with progress tracking and platform synchronization.

    **POST-Only API Pattern**: This API uses POST for all operations to support zero-copy
    WebSocket routing. Path parameters are passed in request bodies instead of URLs.
    See docs/BANNOU_DESIGN.md for architectural rationale.

    **Polymorphic Entity Model**: Achievements can be earned by accounts, characters,
    guilds, or actors using `entityId + entityType`.

    **Platform Sync**: Supports synchronization with Steam, Xbox, and PlayStation
    achievement systems. Platform-specific achievement IDs are mapped via association tables.

    **NRT Compliance**: AI agents MUST review docs/NRT-SCHEMA-RULES.md before modifying
    this schema. Optional reference types require `nullable: true`.
  version: 1.0.0
servers:
- url: http://localhost:5012
  description: Bannou service endpoint (internal only)

paths:
  /achievement/definition/create:
    post:
      summary: Create a new achievement definition
      description: |
        Create a new achievement with specified criteria and platform mappings.
        Developer-only endpoint.
      operationId: createAchievementDefinition
      tags:
      - Definitions
      x-permissions:
      - role: developer
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateAchievementDefinitionRequest'
      responses:
        '200':
          description: Achievement created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AchievementDefinitionResponse'
        '409':
          description: Achievement with this ID already exists

  /achievement/definition/get:
    post:
      summary: Get achievement definition
      description: Retrieve details about a specific achievement.
      operationId: getAchievementDefinition
      tags:
      - Definitions
      x-permissions:
      - role: service
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetAchievementDefinitionRequest'
      responses:
        '200':
          description: Achievement definition retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AchievementDefinitionResponse'
        '404':
          description: Achievement not found

  /achievement/definition/list:
    post:
      summary: List achievement definitions
      description: List achievements for a game service with optional platform filtering.
      operationId: listAchievementDefinitions
      tags:
      - Definitions
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ListAchievementDefinitionsRequest'
      responses:
        '200':
          description: Achievement definitions retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListAchievementDefinitionsResponse'

  /achievement/definition/update:
    post:
      summary: Update achievement definition
      description: |
        Update properties of an existing achievement.
        Developer-only endpoint.
      operationId: updateAchievementDefinition
      tags:
      - Definitions
      x-permissions:
      - role: developer
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateAchievementDefinitionRequest'
      responses:
        '200':
          description: Achievement updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AchievementDefinitionResponse'
        '404':
          description: Achievement not found

  /achievement/definition/delete:
    post:
      summary: Delete achievement definition
      description: |
        Delete an achievement. Earned instances are preserved in history.
        Developer-only endpoint.
      operationId: deleteAchievementDefinition
      tags:
      - Definitions
      x-permissions:
      - role: developer
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeleteAchievementDefinitionRequest'
      responses:
        '200':
          description: Achievement deleted successfully
        '404':
          description: Achievement not found

  /achievement/progress/get:
    post:
      summary: Get entity's achievement progress
      description: Get progress for an entity across all achievements or a specific one.
      operationId: getAchievementProgress
      tags:
      - Progress
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetAchievementProgressRequest'
      responses:
        '200':
          description: Progress retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AchievementProgressResponse'

  /achievement/progress/update:
    post:
      summary: Update achievement progress
      description: |
        Increment progress toward an achievement. If target is reached, auto-unlocks.
        Service-only endpoint - called by game logic.
      operationId: updateAchievementProgress
      tags:
      - Progress
      x-permissions: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateAchievementProgressRequest'
      responses:
        '200':
          description: Progress updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UpdateAchievementProgressResponse'
        '404':
          description: Achievement not found

  /achievement/unlock:
    post:
      summary: Directly unlock an achievement
      description: |
        Immediately unlock an achievement without progress tracking.
        Service-only endpoint - used for non-progressive achievements.
      operationId: unlockAchievement
      tags:
      - Progress
      x-permissions: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UnlockAchievementRequest'
      responses:
        '200':
          description: Achievement unlocked successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UnlockAchievementResponse'
        '404':
          description: Achievement not found
        '409':
          description: Achievement already unlocked

  /achievement/list-unlocked:
    post:
      summary: List unlocked achievements
      description: Get all achievements unlocked by an entity.
      operationId: listUnlockedAchievements
      tags:
      - Progress
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ListUnlockedAchievementsRequest'
      responses:
        '200':
          description: Unlocked achievements retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListUnlockedAchievementsResponse'

  /achievement/platform/sync:
    post:
      summary: Manually trigger platform sync
      description: |
        Force synchronization of achievements with external platforms.
        Admin-only endpoint.
      operationId: syncPlatformAchievements
      tags:
      - Platform Sync
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SyncPlatformAchievementsRequest'
      responses:
        '200':
          description: Sync completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SyncPlatformAchievementsResponse'

  /achievement/platform/status:
    post:
      summary: Get platform sync status
      description: Get the sync status for an entity on a specific platform.
      operationId: getPlatformSyncStatus
      tags:
      - Platform Sync
      x-permissions:
      - role: service
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetPlatformSyncStatusRequest'
      responses:
        '200':
          description: Sync status retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlatformSyncStatusResponse'

components:
  schemas:
    # ============================================
    # Shared Enums
    # ============================================
    EntityType:
      type: string
      description: Type of entity that can earn achievements
      enum:
        - account
        - character
        - guild
        - actor
        - custom

    AchievementType:
      type: string
      description: Type of achievement
      enum:
        - standard
        - progressive
        - hidden
        - secret

    Platform:
      type: string
      description: External platform for achievement sync
      enum:
        - steam
        - xbox
        - playstation
        - internal

    SyncStatus:
      type: string
      description: Status of platform synchronization
      enum:
        - pending
        - synced
        - failed
        - not_linked

    # ============================================
    # Achievement Definitions
    # ============================================
    CreateAchievementDefinitionRequest:
      type: object
      description: Request to create a new achievement
      additionalProperties: false
      required:
        - gameServiceId
        - achievementId
        - displayName
        - description
      properties:
        gameServiceId:
          type: string
          format: uuid
          description: ID of the game service owning this achievement
        achievementId:
          type: string
          maxLength: 64
          pattern: "^[a-z0-9_-]+$"
          description: Unique identifier for this achievement (lowercase, no spaces)
        displayName:
          type: string
          maxLength: 100
          description: Human-readable name
        description:
          type: string
          maxLength: 500
          description: Description of how to earn this achievement
        hiddenDescription:
          type: string
          maxLength: 500
          nullable: true
          description: Description shown before achievement is earned (for hidden types)
        achievementType:
          $ref: '#/components/schemas/AchievementType'
          default: standard
          description: Type of achievement
        entityTypes:
          type: array
          items:
            $ref: '#/components/schemas/EntityType'
          description: Which entity types can earn this achievement
        progressTarget:
          type: integer
          nullable: true
          description: Target value for progressive achievements
        points:
          type: integer
          default: 10
          description: Point value of this achievement
        iconUrl:
          type: string
          format: uri
          nullable: true
          description: URL to achievement icon
        platforms:
          type: array
          items:
            $ref: '#/components/schemas/Platform'
          description: Platforms where this achievement exists
        platformIds:
          type: object
          additionalProperties:
            type: string
          nullable: true
          description: Platform-specific achievement IDs (e.g., {"steam": "ACH_001"})
        prerequisites:
          type: array
          items:
            type: string
          nullable: true
          description: Achievement IDs that must be unlocked first
        isActive:
          type: boolean
          default: true
          description: Whether this achievement can be earned
        metadata:
          type: object
          additionalProperties: true
          nullable: true
          description: Additional achievement-specific metadata

    GetAchievementDefinitionRequest:
      type: object
      description: Request to get an achievement definition
      additionalProperties: false
      required:
        - gameServiceId
        - achievementId
      properties:
        gameServiceId:
          type: string
          format: uuid
          description: ID of the game service
        achievementId:
          type: string
          description: ID of the achievement

    ListAchievementDefinitionsRequest:
      type: object
      description: Request to list achievement definitions
      additionalProperties: false
      required:
        - gameServiceId
      properties:
        gameServiceId:
          type: string
          format: uuid
          description: ID of the game service
        platform:
          $ref: '#/components/schemas/Platform'
          nullable: true
          description: Filter by platform
        achievementType:
          $ref: '#/components/schemas/AchievementType'
          nullable: true
          description: Filter by achievement type
        isActive:
          type: boolean
          nullable: true
          description: Filter by active status
        includeHidden:
          type: boolean
          default: false
          description: Include hidden achievements in response

    ListAchievementDefinitionsResponse:
      type: object
      description: Response containing achievement definitions
      additionalProperties: false
      required:
        - achievements
      properties:
        achievements:
          type: array
          items:
            $ref: '#/components/schemas/AchievementDefinitionResponse'
          description: List of achievement definitions

    UpdateAchievementDefinitionRequest:
      type: object
      description: Request to update an achievement definition
      additionalProperties: false
      required:
        - gameServiceId
        - achievementId
      properties:
        gameServiceId:
          type: string
          format: uuid
          description: ID of the game service
        achievementId:
          type: string
          description: ID of the achievement to update
        displayName:
          type: string
          maxLength: 100
          nullable: true
          description: New display name
        description:
          type: string
          maxLength: 500
          nullable: true
          description: New description
        isActive:
          type: boolean
          nullable: true
          description: New active status
        platformIds:
          type: object
          additionalProperties:
            type: string
          nullable: true
          description: Updated platform ID mappings

    DeleteAchievementDefinitionRequest:
      type: object
      description: Request to delete an achievement
      additionalProperties: false
      required:
        - gameServiceId
        - achievementId
      properties:
        gameServiceId:
          type: string
          format: uuid
          description: ID of the game service
        achievementId:
          type: string
          description: ID of the achievement to delete

    AchievementDefinitionResponse:
      type: object
      description: Achievement definition details
      additionalProperties: false
      required:
        - gameServiceId
        - achievementId
        - displayName
        - description
        - achievementType
        - points
        - isActive
        - createdAt
      properties:
        gameServiceId:
          type: string
          format: uuid
          description: ID of the owning game service
        achievementId:
          type: string
          description: Unique identifier
        displayName:
          type: string
          description: Human-readable name
        description:
          type: string
          description: How to earn this achievement
        hiddenDescription:
          type: string
          nullable: true
          description: Description for hidden achievements
        achievementType:
          $ref: '#/components/schemas/AchievementType'
        entityTypes:
          type: array
          items:
            $ref: '#/components/schemas/EntityType'
          description: Allowed entity types
        progressTarget:
          type: integer
          nullable: true
          description: Target for progressive achievements
        points:
          type: integer
          description: Point value
        iconUrl:
          type: string
          format: uri
          nullable: true
          description: Achievement icon URL
        platforms:
          type: array
          items:
            $ref: '#/components/schemas/Platform'
          description: Available platforms
        platformIds:
          type: object
          additionalProperties:
            type: string
          nullable: true
          description: Platform-specific IDs
        prerequisites:
          type: array
          items:
            type: string
          nullable: true
          description: Required achievements
        isActive:
          type: boolean
          description: Whether achievement is earnable
        earnedCount:
          type: integer
          format: int64
          description: How many entities have earned this
        createdAt:
          type: string
          format: date-time
          description: When the achievement was created
        metadata:
          type: object
          additionalProperties: true
          nullable: true
          description: Additional metadata

    # ============================================
    # Achievement Progress
    # ============================================
    GetAchievementProgressRequest:
      type: object
      description: Request to get achievement progress
      additionalProperties: false
      required:
        - gameServiceId
        - entityId
        - entityType
      properties:
        gameServiceId:
          type: string
          format: uuid
          description: ID of the game service
        entityId:
          type: string
          format: uuid
          description: ID of the entity
        entityType:
          $ref: '#/components/schemas/EntityType'
        achievementId:
          type: string
          nullable: true
          description: Specific achievement ID (null for all)

    AchievementProgressResponse:
      type: object
      description: Achievement progress for an entity
      additionalProperties: false
      required:
        - entityId
        - entityType
        - progress
      properties:
        entityId:
          type: string
          format: uuid
          description: ID of the entity
        entityType:
          $ref: '#/components/schemas/EntityType'
        progress:
          type: array
          items:
            $ref: '#/components/schemas/AchievementProgress'
          description: Progress for each achievement
        totalPoints:
          type: integer
          description: Total points from unlocked achievements
        unlockedCount:
          type: integer
          description: Number of unlocked achievements

    AchievementProgress:
      type: object
      description: Progress toward a single achievement
      additionalProperties: false
      required:
        - achievementId
        - isUnlocked
      properties:
        achievementId:
          type: string
          description: Achievement identifier
        displayName:
          type: string
          description: Achievement display name
        currentProgress:
          type: integer
          nullable: true
          description: Current progress (for progressive)
        targetProgress:
          type: integer
          nullable: true
          description: Target progress (for progressive)
        percentComplete:
          type: number
          format: double
          nullable: true
          description: Completion percentage (0-100)
        isUnlocked:
          type: boolean
          description: Whether achievement is unlocked
        unlockedAt:
          type: string
          format: date-time
          nullable: true
          description: When achievement was unlocked

    UpdateAchievementProgressRequest:
      type: object
      description: Request to update achievement progress
      additionalProperties: false
      required:
        - gameServiceId
        - achievementId
        - entityId
        - entityType
        - increment
      properties:
        gameServiceId:
          type: string
          format: uuid
          description: ID of the game service
        achievementId:
          type: string
          description: ID of the achievement
        entityId:
          type: string
          format: uuid
          description: ID of the entity
        entityType:
          $ref: '#/components/schemas/EntityType'
        increment:
          type: integer
          minimum: 1
          description: Amount to increment progress

    UpdateAchievementProgressResponse:
      type: object
      description: Response after updating progress
      additionalProperties: false
      required:
        - achievementId
        - previousProgress
        - newProgress
        - targetProgress
        - unlocked
      properties:
        achievementId:
          type: string
          description: Achievement identifier
        previousProgress:
          type: integer
          description: Progress before update
        newProgress:
          type: integer
          description: Progress after update
        targetProgress:
          type: integer
          description: Target to unlock
        unlocked:
          type: boolean
          description: Whether this update unlocked the achievement
        unlockedAt:
          type: string
          format: date-time
          nullable: true
          description: Unlock timestamp (if unlocked)

    UnlockAchievementRequest:
      type: object
      description: Request to directly unlock an achievement
      additionalProperties: false
      required:
        - gameServiceId
        - achievementId
        - entityId
        - entityType
      properties:
        gameServiceId:
          type: string
          format: uuid
          description: ID of the game service
        achievementId:
          type: string
          description: ID of the achievement to unlock
        entityId:
          type: string
          format: uuid
          description: ID of the entity
        entityType:
          $ref: '#/components/schemas/EntityType'
        skipPlatformSync:
          type: boolean
          default: false
          description: Skip syncing to external platforms

    UnlockAchievementResponse:
      type: object
      description: Response after unlocking an achievement
      additionalProperties: false
      required:
        - achievementId
        - unlocked
        - unlockedAt
      properties:
        achievementId:
          type: string
          description: Achievement identifier
        unlocked:
          type: boolean
          description: Whether unlock was successful
        unlockedAt:
          type: string
          format: date-time
          description: Unlock timestamp
        platformSyncStatus:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/SyncStatus'
          nullable: true
          description: Sync status by platform

    ListUnlockedAchievementsRequest:
      type: object
      description: Request to list unlocked achievements
      additionalProperties: false
      required:
        - gameServiceId
        - entityId
        - entityType
      properties:
        gameServiceId:
          type: string
          format: uuid
          description: ID of the game service
        entityId:
          type: string
          format: uuid
          description: ID of the entity
        entityType:
          $ref: '#/components/schemas/EntityType'
        platform:
          $ref: '#/components/schemas/Platform'
          nullable: true
          description: Filter by platform

    ListUnlockedAchievementsResponse:
      type: object
      description: Response containing unlocked achievements
      additionalProperties: false
      required:
        - entityId
        - entityType
        - achievements
        - totalPoints
      properties:
        entityId:
          type: string
          format: uuid
          description: ID of the entity
        entityType:
          $ref: '#/components/schemas/EntityType'
        achievements:
          type: array
          items:
            $ref: '#/components/schemas/UnlockedAchievement'
          description: List of unlocked achievements
        totalPoints:
          type: integer
          description: Total points earned

    UnlockedAchievement:
      type: object
      description: An unlocked achievement instance
      additionalProperties: false
      required:
        - achievementId
        - displayName
        - points
        - unlockedAt
      properties:
        achievementId:
          type: string
          description: Achievement identifier
        displayName:
          type: string
          description: Achievement name
        description:
          type: string
          description: Achievement description
        points:
          type: integer
          description: Point value
        iconUrl:
          type: string
          format: uri
          nullable: true
          description: Achievement icon
        unlockedAt:
          type: string
          format: date-time
          description: When it was unlocked

    # ============================================
    # Platform Sync
    # ============================================
    SyncPlatformAchievementsRequest:
      type: object
      description: Request to sync achievements with external platform
      additionalProperties: false
      required:
        - gameServiceId
        - entityId
        - entityType
        - platform
      properties:
        gameServiceId:
          type: string
          format: uuid
          description: ID of the game service
        entityId:
          type: string
          format: uuid
          description: ID of the entity (must be account for platform sync)
        entityType:
          $ref: '#/components/schemas/EntityType'
        platform:
          $ref: '#/components/schemas/Platform'
        forceResync:
          type: boolean
          default: false
          description: Force resync even if already synced

    SyncPlatformAchievementsResponse:
      type: object
      description: Response after platform sync attempt
      additionalProperties: false
      required:
        - platform
        - synced
        - failed
      properties:
        platform:
          $ref: '#/components/schemas/Platform'
        synced:
          type: integer
          description: Number of achievements successfully synced
        failed:
          type: integer
          description: Number of sync failures
        notLinked:
          type: boolean
          description: Whether account is not linked to platform
        errors:
          type: array
          items:
            type: string
          nullable: true
          description: Error messages for failed syncs

    GetPlatformSyncStatusRequest:
      type: object
      description: Request to get platform sync status
      additionalProperties: false
      required:
        - gameServiceId
        - entityId
        - entityType
      properties:
        gameServiceId:
          type: string
          format: uuid
          description: ID of the game service
        entityId:
          type: string
          format: uuid
          description: ID of the entity
        entityType:
          $ref: '#/components/schemas/EntityType'
        platform:
          $ref: '#/components/schemas/Platform'
          nullable: true
          description: Specific platform (null for all)

    PlatformSyncStatusResponse:
      type: object
      description: Platform sync status for an entity
      additionalProperties: false
      required:
        - entityId
        - entityType
        - platforms
      properties:
        entityId:
          type: string
          format: uuid
          description: ID of the entity
        entityType:
          $ref: '#/components/schemas/EntityType'
        platforms:
          type: array
          items:
            $ref: '#/components/schemas/PlatformStatus'
          description: Sync status per platform

    PlatformStatus:
      type: object
      description: Sync status for a single platform
      additionalProperties: false
      required:
        - platform
        - isLinked
        - syncedCount
        - pendingCount
      properties:
        platform:
          $ref: '#/components/schemas/Platform'
        isLinked:
          type: boolean
          description: Whether entity is linked to this platform
        externalId:
          type: string
          nullable: true
          description: External platform user ID
        syncedCount:
          type: integer
          description: Achievements successfully synced
        pendingCount:
          type: integer
          description: Achievements pending sync
        failedCount:
          type: integer
          description: Achievements that failed to sync
        lastSyncAt:
          type: string
          format: date-time
          nullable: true
          description: Last successful sync timestamp
        lastError:
          type: string
          nullable: true
          description: Most recent sync error

# Service Registration Information
x-service-registration:
  serviceId: "achievement"
  serviceName: "Achievement Service"
  version: "1.0.0"
  categories:
  - gaming
  - progression
