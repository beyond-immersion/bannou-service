openapi: 3.0.3
info:
  title: Asset Client Events API
  description: |
    Server-to-client push events for the Asset service.
    These events notify clients of upload completions, processing results,
    bundle validations, and asset availability delivered via WebSocket.

    All events inherit from BaseClientEvent (common-client-events.yaml) and use
    the "asset.{event_type}" naming convention.

    Event delivery: Published to RabbitMQ channel `CONNECT_{sessionId}`, forwarded
    to client's WebSocket connection with Event flag (0x10).

    **SCHEMA MODIFICATION GATE**: STOP. Before modifying this schema, you MUST:
    1. Read docs/reference/SCHEMA-RULES.md
    2. State which section applies to your change
    3. Only then proceed with edits
    Edits without stating the applicable rule are FORBIDDEN.
  version: 1.0.0
  contact:
    name: Bannou Development Team

servers: []

paths: {}

components:
  schemas:
    # ============================================
    # Upload Events
    # ============================================

    AssetUploadCompleteEvent:
      allOf:
        - $ref: 'common-client-events.yaml#/components/schemas/BaseClientEvent'
      type: object
      additionalProperties: false
      x-client-event: true
      description: |
        Sent when an asset upload has completed (success or failure).
        Correlates with the upload_id from requestUpload response.
      required:
        - eventName
        - eventId
        - timestamp
        - uploadId
        - success
      properties:
        eventName:
          type: string
          default: "asset.upload.complete"
          description: Fixed event type identifier
        uploadId:
          type: string
          format: uuid
          description: Correlates with the upload request
        success:
          type: boolean
          description: Whether the upload completed successfully
        assetId:
          type: string
          nullable: true
          description: Asset ID assigned on success
        contentHash:
          type: string
          nullable: true
          description: SHA256 hash of uploaded content
        size:
          type: integer
          format: int64
          nullable: true
          description: File size in bytes
        errorCode:
          $ref: '#/components/schemas/UploadErrorCode'
          description: Error code indicating the type of upload failure
        errorMessage:
          type: string
          nullable: true
          description: Human-readable error description

    # ============================================
    # Processing Events
    # ============================================

    AssetProcessingCompleteEvent:
      allOf:
        - $ref: 'common-client-events.yaml#/components/schemas/BaseClientEvent'
      type: object
      additionalProperties: false
      x-client-event: true
      description: |
        Sent when asset processing (e.g., texture mipmaps, model LODs) completes.
        May include information about generated derivative assets.
      required:
        - eventName
        - eventId
        - timestamp
        - assetId
        - success
      properties:
        eventName:
          type: string
          default: "asset.processing.complete"
          description: Fixed event type identifier
        assetId:
          type: string
          description: ID of the asset that was processed
        success:
          type: boolean
          description: Whether processing completed successfully
        processingType:
          $ref: '#/components/schemas/ProcessingType'
          description: Type of processing that was performed on the asset
        outputs:
          type: array
          nullable: true
          description: Generated derivative assets (mipmaps, LODs, etc.)
          items:
            $ref: '#/components/schemas/ProcessingOutput'
        errorCode:
          $ref: '#/components/schemas/ProcessingErrorCode'
          description: Error code indicating the type of processing failure
        errorMessage:
          type: string
          nullable: true
          description: Human-readable error description

    AssetProcessingFailedEvent:
      allOf:
        - $ref: 'common-client-events.yaml#/components/schemas/BaseClientEvent'
      type: object
      additionalProperties: false
      x-client-event: true
      description: |
        Sent when asset processing fails. Includes retry information.
      required:
        - eventName
        - eventId
        - timestamp
        - assetId
        - errorCode
      properties:
        eventName:
          type: string
          default: "asset.processing.failed"
          description: Fixed event type identifier
        assetId:
          type: string
          description: ID of the asset that failed processing
        errorCode:
          $ref: '#/components/schemas/ProcessingErrorCode'
          description: Error code indicating the type of processing failure
        errorMessage:
          type: string
          nullable: true
          description: Human-readable error description
        retryAvailable:
          type: boolean
          default: true
          description: Whether the operation can be retried
        retryAfterMs:
          type: integer
          nullable: true
          description: Suggested retry delay in milliseconds

    # ============================================
    # Bundle Events
    # ============================================

    BundleValidationCompleteEvent:
      allOf:
        - $ref: 'common-client-events.yaml#/components/schemas/BaseClientEvent'
      type: object
      additionalProperties: false
      x-client-event: true
      description: |
        Sent when a bundle upload has been validated and processed.
        Includes information about registered assets and any skipped duplicates.
      required:
        - eventName
        - eventId
        - timestamp
        - uploadId
        - success
      properties:
        eventName:
          type: string
          default: "asset.bundle.validation.complete"
          description: Fixed event type identifier
        uploadId:
          type: string
          format: uuid
          description: Correlates with the bundle upload request
        success:
          type: boolean
          description: Whether validation passed
        bundleId:
          type: string
          nullable: true
          description: Assigned human-readable bundle ID on success
        assetsRegistered:
          type: integer
          nullable: true
          description: Number of assets extracted and registered
        duplicatesSkipped:
          type: integer
          nullable: true
          description: Assets with matching hash already in storage
        warnings:
          type: array
          nullable: true
          description: Non-fatal warnings encountered during validation
          items:
            $ref: '#/components/schemas/ValidationWarning'

    BundleValidationFailedEvent:
      allOf:
        - $ref: 'common-client-events.yaml#/components/schemas/BaseClientEvent'
      type: object
      additionalProperties: false
      x-client-event: true
      description: |
        Sent when bundle validation fails. Includes detailed error information.
      required:
        - eventName
        - eventId
        - timestamp
        - uploadId
        - errors
      properties:
        eventName:
          type: string
          default: "asset.bundle.validation.failed"
          description: Fixed event type identifier
        uploadId:
          type: string
          format: uuid
          description: Correlates with the bundle upload request
        errors:
          type: array
          description: List of validation errors that caused the failure
          items:
            $ref: '#/components/schemas/ValidationError'

    BundleCreationCompleteEvent:
      allOf:
        - $ref: 'common-client-events.yaml#/components/schemas/BaseClientEvent'
      type: object
      additionalProperties: false
      x-client-event: true
      description: |
        Sent when bundle creation from asset_ids completes.
      required:
        - eventName
        - eventId
        - timestamp
        - bundleId
        - success
      properties:
        eventName:
          type: string
          default: "asset.bundle.creation.complete"
          description: Fixed event type identifier
        bundleId:
          type: string
          description: Human-readable ID of the created bundle
        success:
          type: boolean
          description: Whether creation completed successfully
        downloadUrl:
          type: string
          format: uri
          nullable: true
          description: Pre-signed download URL (on success)
        size:
          type: integer
          format: int64
          nullable: true
          description: Bundle file size in bytes
        assetCount:
          type: integer
          nullable: true
          description: Number of assets in the bundle
        errorCode:
          type: string
          nullable: true
          description: Error code on failure
        errorMessage:
          type: string
          nullable: true
          description: Human-readable error description

    MetabundleCreationCompleteEvent:
      allOf:
        - $ref: 'common-client-events.yaml#/components/schemas/BaseClientEvent'
      type: object
      additionalProperties: false
      x-client-event: true
      description: |
        Sent when async metabundle creation job completes (success or failure).
        Clients that initiated metabundle creation with async processing receive
        this event when the job finishes, allowing them to retrieve the result.
      required:
        - eventName
        - eventId
        - timestamp
        - jobId
        - metabundleId
        - success
      properties:
        eventName:
          type: string
          default: "asset.metabundle.creation.complete"
          description: Fixed event type identifier
        jobId:
          type: string
          format: uuid
          description: Job ID from the original async creation request
        metabundleId:
          type: string
          description: Human-readable ID of the metabundle
        success:
          type: boolean
          description: Whether creation completed successfully
        status:
          $ref: '#/components/schemas/MetabundleJobStatus'
          description: Final job status
        downloadUrl:
          type: string
          format: uri
          nullable: true
          description: Pre-signed download URL (on success)
        sizeBytes:
          type: integer
          format: int64
          nullable: true
          description: Metabundle file size in bytes
        assetCount:
          type: integer
          nullable: true
          description: Total number of assets in the metabundle
        standaloneAssetCount:
          type: integer
          nullable: true
          description: Number of standalone assets included
        processingTimeMs:
          type: integer
          format: int64
          nullable: true
          description: Total processing time in milliseconds
        errorCode:
          $ref: '#/components/schemas/MetabundleErrorCode'
          description: Error code on failure
        errorMessage:
          type: string
          nullable: true
          description: Human-readable error description

    # ============================================
    # Asset Ready Event
    # ============================================

    AssetReadyEvent:
      allOf:
        - $ref: 'common-client-events.yaml#/components/schemas/BaseClientEvent'
      type: object
      additionalProperties: false
      x-client-event: true
      description: |
        Final notification that an asset is ready for use.
        Sent after upload and any required processing completes.
      required:
        - eventName
        - eventId
        - timestamp
        - assetId
      properties:
        eventName:
          type: string
          default: "asset.ready"
          description: Fixed event type identifier
        assetId:
          type: string
          description: ID of the asset that is now ready
        versionId:
          type: string
          nullable: true
          description: Version ID of this asset
        contentHash:
          type: string
          nullable: true
          description: SHA256 hash of the asset
        size:
          type: integer
          format: int64
          nullable: true
          description: File size in bytes
        contentType:
          type: string
          nullable: true
          description: MIME content type
        metadata:
          type: object
          additionalProperties: true
          nullable: true
          description: Asset metadata

    # ============================================
    # Supporting Types
    # ============================================

    UploadErrorCode:
      type: string
      nullable: true
      enum:
        - VALIDATION_FAILED
        - HASH_MISMATCH
        - SIZE_EXCEEDED
        - STORAGE_ERROR
        - TIMEOUT
      description: Error codes for upload failures

    ProcessingType:
      type: string
      nullable: true
      enum:
        - mipmaps
        - lod_generation
        - transcode
        - compression
        - validation
        - behavior_compile
      description: Type of processing performed

    ProcessingErrorCode:
      type: string
      nullable: true
      enum:
        - PROCESSING_FAILED
        - INVALID_FORMAT
        - RESOURCE_EXHAUSTED
        - TIMEOUT
        - PROCESSOR_UNAVAILABLE
      description: Error codes for processing failures

    ProcessingOutput:
      type: object
      additionalProperties: false
      description: Information about a generated derivative asset
      required:  # NRT: Required event properties
        - outputType
        - assetId
      properties:
        outputType:
          type: string
          description: Type of output (e.g., "mipmap_level_1", "lod_2")
        assetId:
          type: string
          description: ID of the generated asset
        size:
          type: integer
          format: int64
          nullable: true  # NRT: Optional property MUST be nullable
          description: Size of the generated asset

    ValidationWarning:
      type: object
      additionalProperties: false
      description: Non-fatal warning from bundle validation
      required:  # NRT: Required event properties
        - code
        - message
      properties:
        code:
          type: string
          description: Warning code
        message:
          type: string
          description: Warning message
        assetPath:
          type: string
          nullable: true
          description: Path within bundle where warning occurred

    ValidationError:
      type: object
      additionalProperties: false
      description: Fatal error from bundle validation
      required:
        - code
        - message
      properties:
        code:
          $ref: '#/components/schemas/ValidationErrorCode'
          description: Error code identifying the type of validation failure
        message:
          type: string
          description: Error message
        assetPath:
          type: string
          nullable: true
          description: Path within bundle where error occurred

    ValidationErrorCode:
      type: string
      enum:
        - INVALID_ARCHIVE
        - MISSING_MANIFEST
        - INVALID_MANIFEST
        - HASH_MISMATCH
        - PATH_TRAVERSAL
        - SIZE_EXCEEDED
        - DUPLICATE_ASSET_ID
        - MISSING_DEPENDENCY
      description: Error codes for bundle validation failures

    MetabundleJobStatus:
      type: string
      nullable: true
      enum:
        - queued
        - processing
        - ready
        - failed
        - cancelled
      description: |
        Status of an async metabundle creation job.
        - queued: Job accepted, waiting for processing resources
        - processing: Job is actively being processed
        - ready: Job completed successfully
        - failed: Job failed (see errorCode/errorMessage)
        - cancelled: Job was cancelled before completion

    MetabundleErrorCode:
      type: string
      nullable: true
      enum:
        - SOURCE_BUNDLE_NOT_FOUND
        - SOURCE_BUNDLE_NOT_READY
        - STANDALONE_ASSET_NOT_FOUND
        - STANDALONE_ASSET_NOT_READY
        - REALM_MISMATCH
        - ASSET_CONFLICT
        - STORAGE_ERROR
        - TIMEOUT
        - CANCELLED
        - INTERNAL_ERROR
      description: Error codes for metabundle creation failures
