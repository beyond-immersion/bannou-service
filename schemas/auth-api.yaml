openapi: 3.0.0
info:
  title: Bannou Auth Service API
  description: |
    Authentication and session management service (Internet-facing).

    **POST-Only API Pattern**: This API uses POST for all WebSocket-routable operations.
    Path parameters are passed in request bodies instead of URLs.

    **Exceptions**: OAuth endpoints (`/auth/oauth/*`) retain path parameters because they
    are browser-facing redirect flows, not WebSocket-routed. The browser navigates to
    these URLs directly for OAuth provider authentication.

    See API-DESIGN.md for architectural rationale.
  version: 4.0.0
servers:
  - url: http://localhost:3500/v1.0/invoke/bannou/method
    description: Dapr sidecar endpoint

paths:
  /auth/login:
    post:
      summary: Login with email/password
      operationId: login
      tags:
        - Authentication
      x-permissions:
        - role: anonymous
          states: {}  # Allow re-login when already authenticated
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: Invalid credentials
        '429':
          description: Too many login attempts

  /auth/register:
    post:
      summary: Register new user account
      operationId: register
      tags:
        - Authentication
      x-permissions:
        - role: anonymous
          states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '200':
          description: Registration successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RegisterResponse'
        '400':
          description: Invalid request data
        '409':
          description: Username already exists

  # OAuth endpoints use path parameters because they are browser-facing redirect flows.
  # These are NOT routed through WebSocket and are accessed directly via browser navigation.
  /auth/oauth/{provider}/init:
    get:
      summary: Initialize OAuth2 flow (browser redirect)
      description: |
        Browser-facing endpoint for initiating OAuth flows. The user's browser navigates
        to this URL directly, which then redirects to the OAuth provider.

        **Note**: This endpoint uses GET with path parameters because it's a browser
        redirect flow, not a WebSocket-routed API call.
      operationId: initOAuth
      tags:
        - OAuth
      x-browser-facing: true
      x-permissions:
        - role: anonymous
          states: {}
      parameters:
        - name: provider
          in: path
          required: true
          schema:
            $ref: '#/components/schemas/Provider'
        - name: redirectUri
          in: query
          required: true
          schema:
            type: string
            format: uri
        - name: state
          in: query
          schema:
            type: string
      responses:
        '302':
          description: Redirect to OAuth provider

  /auth/oauth/{provider}/callback:
    post:
      summary: Complete OAuth2 flow (browser redirect callback)
      description: |
        Browser-facing callback endpoint for OAuth providers. The OAuth provider redirects
        the user's browser back to this URL after authentication.

        **Note**: This endpoint uses path parameters because the callback URL is registered
        with OAuth providers and cannot be changed without updating provider configurations.
      operationId: completeOAuth
      tags:
        - OAuth
      x-browser-facing: true
      x-permissions:
        - role: anonymous
          states: {}
      parameters:
        - name: provider
          in: path
          required: true
          schema:
            $ref: '#/components/schemas/Provider'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OAuthCallbackRequest'
      responses:
        '200':
          description: OAuth authentication successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'

  /auth/steam/verify:
    post:
      summary: Verify Steam Session Ticket
      description: |
        Validates a Steam Session Ticket obtained from the game client via ISteamUser::GetAuthTicketForWebApi().
        The server validates the ticket with Steam's Web API and retrieves the SteamID from Steam's response.
        NEVER trust client-provided SteamID - it must come from Steam's authenticated response.
      operationId: verifySteamAuth
      tags:
        - Steam
      x-permissions:
        - role: anonymous
          states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SteamVerifyRequest'
      responses:
        '200':
          description: Steam authentication successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: Invalid or expired Steam ticket
        '503':
          description: Steam API unavailable

  /auth/refresh:
    post:
      summary: Refresh access token
      operationId: refreshToken
      tags:
        - Tokens
      x-permissions:
        - role: user
          states: {}
      parameters:
        - name: jwt
          in: header
          required: true
          schema:
            type: string
          description: Current JWT access token for refresh
          x-from-authorization: bearer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshRequest'
      responses:
        '200':
          description: Token refreshed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'

  /auth/validate:
    post:
      summary: Validate access token
      operationId: validateToken
      tags:
        - Tokens
      x-permissions:
        - role: user
          states: {}
      parameters:
        - name: jwt
          in: header
          required: true
          schema:
            type: string
          description: JWT access token for validation
          x-from-authorization: bearer
      responses:
        '200':
          description: Token is valid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidateTokenResponse'
        '401':
          description: Invalid or missing token
        '403':
          description: Token expired or malformed

  /auth/logout:
    post:
      summary: Logout and invalidate tokens
      operationId: logout
      tags:
        - Authentication
      x-permissions:
        - role: user
          states: {}
      parameters:
        - name: jwt
          in: header
          required: true
          schema:
            type: string
          description: JWT access token for session identification
          x-from-authorization: bearer
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LogoutRequest'
      responses:
        '200':
          description: Logged out successfully

  /auth/sessions/list:
    post:
      summary: Get active sessions for account
      operationId: getSessions
      tags:
        - Sessions
      x-permissions:
        - role: user
          states: {}
      parameters:
        - name: jwt
          in: header
          required: true
          schema:
            type: string
          description: JWT access token for session identification
          x-from-authorization: bearer
      responses:
        '200':
          description: Active sessions retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionsResponse'

  /auth/sessions/terminate:
    post:
      summary: Terminate specific session
      operationId: terminateSession
      tags:
        - Sessions
      x-permissions:
        - role: user
          states: {}
      parameters:
        - name: jwt
          in: header
          required: true
          schema:
            type: string
          description: JWT access token for session identification
          x-from-authorization: bearer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TerminateSessionRequest'
      responses:
        '204':
          description: Session terminated
        '404':
          description: Session not found

  /auth/password/reset:
    post:
      summary: Request password reset
      operationId: requestPasswordReset
      tags:
        - Password
      x-permissions:
        - role: anonymous
          states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PasswordResetRequest'
      responses:
        '200':
          description: Reset email sent if account exists

  /auth/password/confirm:
    post:
      summary: Confirm password reset with token
      operationId: confirmPasswordReset
      tags:
        - Password
      x-permissions:
        - role: anonymous
          states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PasswordResetConfirmRequest'
      responses:
        '200':
          description: Password reset successfully

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    Provider:
      type: string
      enum: [google, discord, twitch]
      description: OAuth provider type

    # Request Models for POST-only pattern
    TerminateSessionRequest:
      type: object
      description: Request to terminate a specific session
      required:
        - sessionId
      properties:
        sessionId:
          type: string
          format: uuid
          description: ID of the session to terminate

    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          format: password
        rememberMe:
          type: boolean
          default: false
        deviceInfo:
          $ref: '#/components/schemas/DeviceInfo'

    RegisterRequest:
      type: object
      description: Request to register a new user account
      required:
        - username
        - password
      properties:
        username:
          type: string
          description: Unique username for the account
          minLength: 3
          maxLength: 32
          pattern: '^[a-zA-Z0-9_]+$'
          example: "gameuser123"
        password:
          type: string
          description: Password for the account (will be hashed)
          minLength: 8
          format: password
          example: "SecurePassword123!"
        email:
          type: string
          format: email
          description: Optional email for account recovery
          example: "user@example.com"

    RegisterResponse:
      type: object
      description: Response from successful user registration
      required:
        - accessToken
        - connectUrl
      properties:
        accessToken:
          type: string
          description: JWT access token for immediate authentication
          example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJnYW1ldXNlcjEyMyIsImlhdCI6MTY0MDk5NTIwMCwiZXhwIjoxNjQwOTk4ODAwfQ.signature"
        refreshToken:
          type: string
          description: Refresh token for obtaining new access tokens
          nullable: true
          example: "refresh_token_abc123xyz789"
        connectUrl:
          type: string
          format: uri
          description: WebSocket endpoint for Connect service

    LoginResponse:
      type: object
      description: Response from successful user login
      required:
        - accessToken
      properties:
        accessToken:
          type: string
          description: JWT access token for authentication
          example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJnYW1ldXNlcjEyMyIsImlhdCI6MTY0MDk5NTIwMCwiZXhwIjoxNjQwOTk4ODAwfQ.signature"
        refreshToken:
          type: string
          description: Refresh token for obtaining new access tokens
          nullable: true
          example: "refresh_token_def456uvw012"

    AuthResponse:
      type: object
      required:
        - accountId
        - accessToken
        - refreshToken
        - expiresIn
        - connectUrl
      properties:
        accountId:
          type: string
          format: uuid
        accessToken:
          type: string
        refreshToken:
          type: string
        expiresIn:
          type: integer
          description: Seconds until access token expires
        connectUrl:
          type: string
          format: uri
          description: WebSocket endpoint for Connect service
        roles:
          type: array
          items:
            type: string
        requiresTwoFactor:
          type: boolean
          default: false

    OAuthCallbackRequest:
      type: object
      required:
        - code
      properties:
        code:
          type: string
        state:
          type: string
          nullable: true
        deviceInfo:
          $ref: '#/components/schemas/DeviceInfo'

    SteamVerifyRequest:
      type: object
      description: |
        Request to verify a Steam Session Ticket. The ticket is obtained client-side via
        ISteamUser::GetAuthTicketForWebApi("bannou"). SteamID is NOT included because
        it must be obtained from Steam's Web API response (never trust client-provided SteamID).
      required:
        - ticket
      properties:
        ticket:
          type: string
          description: |
            Hex-encoded Steam Session Ticket from ISteamUser::GetAuthTicketForWebApi().
            Client converts ticket bytes to hex string: BitConverter.ToString(ticketData).Replace("-", "")
          example: "140000006A7B3C8E..."
        deviceInfo:
          $ref: '#/components/schemas/DeviceInfo'

    RefreshRequest:
      type: object
      required:
        - refreshToken
      properties:
        refreshToken:
          type: string

    ValidateTokenResponse:
      type: object
      required:
        - valid
        - accountId
        - sessionId
      properties:
        valid:
          type: boolean
        accountId:
          type: string
          format: uuid
        sessionId:
          type: string
          description: Session identifier for WebSocket connections and service routing
        roles:
          type: array
          items:
            type: string
        authorizations:
          type: array
          items:
            type: string
          description: |
            Authorization strings from active subscriptions.
            Format: "{stubName}:{state}" (e.g., "arcadia:authorized")
        remainingTime:
          type: integer
          description: Seconds until expiration

    LogoutRequest:
      type: object
      properties:
        allSessions:
          type: boolean
          default: false
          description: Logout from all sessions/devices

    SessionsResponse:
      type: object
      required:
        - sessions
      properties:
        sessions:
          type: array
          items:
            $ref: '#/components/schemas/SessionInfo'

    SessionInfo:
      type: object
      required:
        - sessionId
        - createdAt
        - lastActive
      properties:
        sessionId:
          type: string
        deviceInfo:
          $ref: '#/components/schemas/DeviceInfo'
        createdAt:
          type: string
          format: date-time
        lastActive:
          type: string
          format: date-time
        ipAddress:
          type: string
        location:
          type: string
          nullable: true

    DeviceInfo:
      type: object
      properties:
        deviceType:
          type: string
          enum: [desktop, mobile, tablet, console]
        platform:
          type: string
        browser:
          type: string
          nullable: true
        appVersion:
          type: string
          nullable: true

    PasswordResetRequest:
      type: object
      required:
        - email
      properties:
        email:
          type: string
          format: email

    PasswordResetConfirmRequest:
      type: object
      required:
        - token
        - newPassword
      properties:
        token:
          type: string
        newPassword:
          type: string
          format: password
          minLength: 8

    OAuthProvidersResponse:
      type: object
      description: List of available OAuth providers
      required:
        - providers
      properties:
        providers:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
                example: "steam"
              displayName:
                type: string
                example: "Steam"
              authUrl:
                type: string
                format: uri
                example: "https://steamcommunity.com/openid/login"

    RoutingPreferenceResponse:
      type: object
      description: Response from routing preference update
      properties:
        success:
          type: boolean
          description: Whether the routing preference was updated successfully
          example: true
        preferredInstance:
          type: string
          description: The preferred Connect service instance ID
          example: "connect-omega-01"

    # Event Models for Auth Lifecycle
    SessionInvalidatedEvent:
      type: object
      description: Event published when sessions are invalidated (logout, account deletion, etc.)
      required:
        - eventId
        - timestamp
        - sessionIds
        - reason
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique identifier for this event
        timestamp:
          type: string
          format: date-time
          description: When the event occurred
        accountId:
          type: string
          format: uuid
          description: ID of the account whose sessions were invalidated
        sessionIds:
          type: array
          items:
            type: string
          description: List of session IDs that were invalidated
        reason:
          $ref: '#/components/schemas/SessionInvalidatedEventReason'
        disconnectClients:
          type: boolean
          default: true
          description: Whether Connect service should disconnect WebSocket clients

    SessionInvalidatedEventReason:
      type: string
      enum: [logout, account_deleted, security_revocation, admin_action, session_expired]
      description: Reason for session invalidation

    SessionUpdatedEvent:
      type: object
      description: |
        Published when a session's roles or authorizations change.
        Permissions service subscribes to update capability compilation.
      required:
        - eventId
        - timestamp
        - accountId
        - sessionId
        - roles
        - authorizations
        - reason
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique identifier for this event
        timestamp:
          type: string
          format: date-time
          description: When the event occurred
        accountId:
          type: string
          format: uuid
          description: ID of the account whose session changed
        sessionId:
          type: string
          description: ID of the session that changed
        roles:
          type: array
          items:
            type: string
          description: Current roles for the session
        authorizations:
          type: array
          items:
            type: string
          description: Current authorization strings (e.g., ["arcadia:authorized"])
        reason:
          $ref: '#/components/schemas/SessionUpdatedEventReason'

    SessionUpdatedEventReason:
      type: string
      enum: [role_changed, authorization_changed, subscription_changed]
      description: Reason for session update

x-service-configuration:
  properties:
    # JWT Configuration
    BcryptWorkFactor:
      type: integer
      description: Bcrypt work factor for password hashing (higher = more secure but slower)
      default: 12
    JwtSecret:
      type: string
      required: true
      description: JWT secret key for token signing
    JwtIssuer:
      type: string
      description: JWT issuer identifier
      default: "bannou-auth"
    JwtAudience:
      type: string
      description: JWT audience identifier
      default: "bannou-services"
    JwtExpirationMinutes:
      type: integer
      description: JWT expiration time in minutes
      default: 1440
    AccessTokenExpirationMinutes:
      type: integer
      description: Access token expiration time in minutes (alias for JwtExpirationMinutes)
      default: 1440

    # Connect Service Configuration
    ConnectUrl:
      type: string
      description: WebSocket URL for Connect service (returned in login responses for client connection)
      default: "ws://localhost:8080/connect"

    # Password Reset Configuration
    PasswordResetTokenTtlMinutes:
      type: integer
      description: Password reset token expiration time in minutes
      default: 60
    PasswordResetBaseUrl:
      type: string
      description: Base URL for password reset links (e.g., https://example.com/reset-password)
      default: "https://example.com/reset-password"

    # Mock Provider Configuration (for CI/staging testing)
    MockProviders:
      type: boolean
      description: When true, use mock providers instead of real OAuth/Steam APIs
      default: false
    MockSteamId:
      type: string
      description: Mock SteamID returned when MockProviders=true (64-bit Steam ID)
      default: "76561198000000001"
    MockDiscordId:
      type: string
      description: Mock Discord user ID returned when MockProviders=true
      default: "123456789012345678"
    MockGoogleId:
      type: string
      description: Mock Google user ID returned when MockProviders=true
      default: "mock-google-user-id-12345"

    # Steam Configuration (Session Tickets)
    SteamApiKey:
      type: string
      description: Steam Web API Publisher Key for ticket validation (from partner.steamgames.com)
    SteamAppId:
      type: string
      description: Steam Application ID for the game

    # Discord OAuth2 Configuration
    DiscordClientId:
      type: string
      description: Discord application client ID (from discord.com/developers)
    DiscordClientSecret:
      type: string
      description: Discord application client secret
    DiscordRedirectUri:
      type: string
      description: Discord OAuth2 redirect URI
      default: "http://localhost:5012/auth/oauth/discord/callback"

    # Google OAuth2 Configuration
    GoogleClientId:
      type: string
      description: Google OAuth2 client ID (from console.cloud.google.com)
    GoogleClientSecret:
      type: string
      description: Google OAuth2 client secret
    GoogleRedirectUri:
      type: string
      description: Google OAuth2 redirect URI
      default: "http://localhost:5012/auth/oauth/google/callback"

    # Twitch OAuth2 Configuration
    TwitchClientId:
      type: string
      description: Twitch application client ID (from dev.twitch.tv)
    TwitchClientSecret:
      type: string
      description: Twitch application client secret
    TwitchRedirectUri:
      type: string
      description: Twitch OAuth2 redirect URI
      default: "http://localhost:5012/auth/oauth/twitch/callback"

x-event-subscriptions:
  - topic: account.deleted
    pubsub: bannou-pubsub
    path: handle-account-deleted
    schema:
      $ref: 'accounts-events.yaml#/components/schemas/AccountDeletedEvent'
    description: Subscribe to account deletion events to invalidate sessions
  - topic: account.updated
    pubsub: bannou-pubsub
    path: handle-account-updated
    schema:
      $ref: 'accounts-events.yaml#/components/schemas/AccountUpdatedEvent'
    description: Subscribe to account update events to propagate role changes to sessions
  - topic: subscription.updated
    pubsub: bannou-pubsub
    path: handle-subscription-updated
    schema:
      $ref: 'subscriptions-events.yaml#/components/schemas/SubscriptionUpdatedEvent'
    description: Subscribe to subscription update events to propagate authorization changes to sessions

x-event-publications:
  - topic: session.updated
    pubsub: bannou-pubsub
    schema:
      $ref: '#/components/schemas/SessionUpdatedEvent'
    description: Published when a session's roles or authorizations change
