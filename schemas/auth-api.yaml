openapi: 3.0.0
info:
  title: Bannou Auth Service API
  description: Authentication and session management service (Internet-facing)
  version: 3.0.0
servers:
  - url: http://localhost:3500/v1.0/invoke/bannou/method
    description: Dapr sidecar endpoint

paths:
  /auth/login:
    post:
      summary: Login with email/password
      operationId: login
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: Invalid credentials
        '429':
          description: Too many login attempts

  /auth/register:
    post:
      summary: Register new user account
      operationId: register
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '200':
          description: Registration successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RegisterResponse'
        '400':
          description: Invalid request data
        '409':
          description: Username already exists

  /auth/oauth/{provider}/init:
    get:
      summary: Initialize OAuth2 flow
      operationId: initOAuth
      tags:
        - OAuth
      parameters:
        - name: provider
          in: path
          required: true
          schema:
            $ref: '#/components/schemas/Provider'
        - name: redirectUri
          in: query
          required: true
          schema:
            type: string
            format: uri
        - name: state
          in: query
          schema:
            type: string
      responses:
        '302':
          description: Redirect to OAuth provider

  /auth/oauth/{provider}/callback:
    post:
      summary: Complete OAuth2 flow
      operationId: completeOAuth
      tags:
        - OAuth
      parameters:
        - name: provider
          in: path
          required: true
          schema:
            $ref: '#/components/schemas/Provider'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OAuthCallbackRequest'
      responses:
        '200':
          description: OAuth authentication successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'

  /auth/steam/init:
    get:
      summary: Initialize Steam authentication
      operationId: initSteamAuth
      tags:
        - Steam
      parameters:
        - name: returnUrl
          in: query
          required: true
          schema:
            type: string
            format: uri
      responses:
        '302':
          description: Redirect to Steam login

  /auth/steam/verify:
    post:
      summary: Verify Steam authentication response
      operationId: verifySteamAuth
      tags:
        - Steam
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SteamVerifyRequest'
      responses:
        '200':
          description: Steam authentication successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'

  /auth/refresh:
    post:
      summary: Refresh access token
      operationId: refreshToken
      tags:
        - Tokens
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshRequest'
      responses:
        '200':
          description: Token refreshed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'

  /auth/validate:
    post:
      summary: Validate access token
      operationId: validateToken
      x-controller-only: true
      tags:
        - Tokens
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Token is valid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidateTokenResponse'

  /auth/logout:
    post:
      summary: Logout and invalidate tokens
      operationId: logout
      tags:
        - Authentication
      security:
        - BearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LogoutRequest'
      responses:
        '200':
          description: Logged out successfully

  /auth/sessions:
    get:
      summary: Get active sessions for account
      operationId: getSessions
      tags:
        - Sessions
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Active sessions retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionsResponse'

  /auth/sessions/{sessionId}:
    delete:
      summary: Terminate specific session
      operationId: terminateSession
      tags:
        - Sessions
      security:
        - BearerAuth: []
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Session terminated

  /auth/password/reset:
    post:
      summary: Request password reset
      operationId: requestPasswordReset
      tags:
        - Password
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PasswordResetRequest'
      responses:
        '200':
          description: Reset email sent if account exists

  /auth/password/confirm:
    post:
      summary: Confirm password reset with token
      operationId: confirmPasswordReset
      tags:
        - Password
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PasswordResetConfirmRequest'
      responses:
        '200':
          description: Password reset successfully

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    Provider:
      type: string
      enum: [google, discord, twitch]
      description: OAuth provider type

    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          format: password
        rememberMe:
          type: boolean
          default: false
        deviceInfo:
          $ref: '#/components/schemas/DeviceInfo'

    RegisterRequest:
      type: object
      description: Request to register a new user account
      required:
        - username
        - password
      properties:
        username:
          type: string
          description: Unique username for the account
          minLength: 3
          maxLength: 32
          pattern: '^[a-zA-Z0-9_]+$'
          example: "gameuser123"
        password:
          type: string
          description: Password for the account (will be hashed)
          minLength: 8
          format: password
          example: "SecurePassword123!"
        email:
          type: string
          format: email
          description: Optional email for account recovery
          example: "user@example.com"

    RegisterResponse:
      type: object
      description: Response from successful user registration
      required:
        - access_token
      properties:
        access_token:
          type: string
          description: JWT access token for immediate authentication
          example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJnYW1ldXNlcjEyMyIsImlhdCI6MTY0MDk5NTIwMCwiZXhwIjoxNjQwOTk4ODAwfQ.signature"
        refresh_token:
          type: string
          description: Refresh token for obtaining new access tokens
          nullable: true
          example: "refresh_token_abc123xyz789"

    LoginResponse:
      type: object
      description: Response from successful user login
      required:
        - access_token
      properties:
        access_token:
          type: string
          description: JWT access token for authentication
          example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJnYW1ldXNlcjEyMyIsImlhdCI6MTY0MDk5NTIwMCwiZXhwIjoxNjQwOTk4ODAwfQ.signature"
        refresh_token:
          type: string
          description: Refresh token for obtaining new access tokens
          nullable: true
          example: "refresh_token_def456uvw012"

    AuthResponse:
      type: object
      required:
        - accountId
        - accessToken
        - refreshToken
        - expiresIn
        - connectUrl
      properties:
        accountId:
          type: string
          format: uuid
        accessToken:
          type: string
        refreshToken:
          type: string
        expiresIn:
          type: integer
          description: Seconds until access token expires
        connectUrl:
          type: string
          format: uri
          description: WebSocket endpoint for Connect service
        roles:
          type: array
          items:
            type: string
        requiresTwoFactor:
          type: boolean
          default: false

    OAuthCallbackRequest:
      type: object
      required:
        - code
      properties:
        code:
          type: string
        state:
          type: string
          nullable: true
        deviceInfo:
          $ref: '#/components/schemas/DeviceInfo'

    SteamVerifyRequest:
      type: object
      required:
        - ticket
      properties:
        ticket:
          type: string
          description: Steam session ticket
        steamId:
          type: string
        deviceInfo:
          $ref: '#/components/schemas/DeviceInfo'

    RefreshRequest:
      type: object
      required:
        - refreshToken
      properties:
        refreshToken:
          type: string

    ValidateTokenResponse:
      type: object
      required:
        - valid
        - accountId
        - sessionId
      properties:
        valid:
          type: boolean
        accountId:
          type: string
          format: uuid
        sessionId:
          type: string
          description: Session identifier for WebSocket connections and service routing
        roles:
          type: array
          items:
            type: string
        remainingTime:
          type: integer
          description: Seconds until expiration

    LogoutRequest:
      type: object
      properties:
        allSessions:
          type: boolean
          default: false
          description: Logout from all sessions/devices

    SessionsResponse:
      type: object
      required:
        - sessions
      properties:
        sessions:
          type: array
          items:
            $ref: '#/components/schemas/SessionInfo'

    SessionInfo:
      type: object
      required:
        - sessionId
        - createdAt
        - lastActive
      properties:
        sessionId:
          type: string
        deviceInfo:
          $ref: '#/components/schemas/DeviceInfo'
        createdAt:
          type: string
          format: date-time
        lastActive:
          type: string
          format: date-time
        ipAddress:
          type: string
        location:
          type: string
          nullable: true

    DeviceInfo:
      type: object
      properties:
        deviceType:
          type: string
          enum: [desktop, mobile, tablet, console]
        platform:
          type: string
        browser:
          type: string
          nullable: true
        appVersion:
          type: string
          nullable: true

    PasswordResetRequest:
      type: object
      required:
        - email
      properties:
        email:
          type: string
          format: email

    PasswordResetConfirmRequest:
      type: object
      required:
        - token
        - newPassword
      properties:
        token:
          type: string
        newPassword:
          type: string
          format: password
          minLength: 8

    OAuthProvidersResponse:
      type: object
      description: List of available OAuth providers
      required:
        - providers
      properties:
        providers:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
                example: "steam"
              displayName:
                type: string
                example: "Steam"
              authUrl:
                type: string
                format: uri
                example: "https://steamcommunity.com/openid/login"

    RoutingPreferenceResponse:
      type: object
      description: Response from routing preference update
      properties:
        success:
          type: boolean
          description: Whether the routing preference was updated successfully
          example: true
        preferredInstance:
          type: string
          description: The preferred Connect service instance ID
          example: "connect-omega-01"

x-service-configuration:
  properties:
    BcryptWorkFactor:
      type: integer
      description: Bcrypt work factor for password hashing (higher = more secure but slower)
      default: 12
    JwtSecret:
      type: string
      required: true
      description: JWT secret key for token signing
    JwtIssuer:
      type: string
      description: JWT issuer identifier
      default: "bannou-auth"
    JwtAudience:
      type: string
      description: JWT audience identifier
      default: "bannou-services"
    JwtExpirationMinutes:
      type: integer
      description: JWT expiration time in minutes
      default: 1440
    AccessTokenExpirationMinutes:
      type: integer
      description: Access token expiration time in minutes (alias for JwtExpirationMinutes)
      default: 1440
