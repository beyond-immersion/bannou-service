openapi: 3.0.3
info:
  title: Common Client Events API
  description: |
    Base schemas for server-to-client push events delivered via WebSocket.
    All client events inherit from BaseClientEvent and are routed through
    session-specific RabbitMQ channels (CONNECT_SESSION_{sessionId}).

    These events are different from service-to-service events:
    - Service events: RabbitMQ pub/sub between services via MassTransit
    - Client events: Services → RabbitMQ → Connect service → WebSocket → Client

    **NRT Compliance**: AI agents MUST review docs/NRT-SCHEMA-RULES.md before
    modifying this schema. Optional reference types require `nullable: true`.
  version: 1.0.0
  contact:
    name: Bannou Development Team

servers: []

paths: {}

components:
  schemas:
    BaseClientEvent:
      type: object
      additionalProperties: false
      x-client-event: true
      description: |
        Base schema for all server-to-client push events.
        All client events MUST include these fields.
        The eventName field is used for whitelist validation in Connect service.
      required:
        - eventName
        - eventId
        - timestamp
      properties:
        eventName:
          type: string
          description: |
            Unique event type identifier (e.g., "connect.capability_manifest").
            Must be in the generated ClientEventWhitelist or will be rejected.
            Convention: {service}.{event_name}
        eventId:
          type: string
          format: uuid
          description: Unique identifier for this event instance
        timestamp:
          type: string
          format: date-time
          description: When the event was generated (ISO 8601 format)

    CapabilityManifestEvent:
      allOf:
        - $ref: '#/components/schemas/BaseClientEvent'
      type: object
      additionalProperties: false
      x-client-event: true
      description: |
        Sent to client when their available API capabilities change.
        Contains the complete list of service GUIDs the client can access.
        Delivered on initial connection and when permissions change.
      required:
        - sessionId
        - availableApis
        - version
      properties:
        eventName:
          type: string
          default: "connect.capability_manifest"
          description: Fixed event type identifier
        sessionId:
          type: string
          format: uuid
          description: Session ID this manifest applies to
        availableApis:
          type: array
          items:
            $ref: '#/components/schemas/ClientCapabilityEntry'
          description: List of available API endpoints with their GUIDs
        version:
          type: integer
          description: Manifest version number (incremented on each change)
        reason:
          type: string
          nullable: true
          description: Reason for manifest update (e.g., "initial_connection", "capabilities_updated", "role_changed")
        peerGuid:
          type: string
          format: uuid
          nullable: true
          description: |
            Unique GUID for peer-to-peer routing on this Connect node.
            Other connections on the same Connect node can route messages directly
            to this connection using this GUID with the Client flag (0x20).
            Enables zero-copy message forwarding between Game Servers, Actor Pool Nodes, and clients.
            Note: Only valid while connected to the same Connect instance.

    ClientCapabilityEntry:
      type: object
      additionalProperties: false
      description: Individual API capability entry with routing information
      required:
        - serviceId
        - serviceName
        - method
        - path
        - endpointKey
      properties:
        serviceId:
          type: string
          format: uuid
          description: Client-salted GUID for this endpoint (unique per client)
        serviceName:
          type: string
          description: Service name (e.g., "accounts", "game-session")
        method:
          type: string
          enum: [GET, POST]
          description: HTTP method for WebSocket routing
        path:
          type: string
          description: API endpoint path (e.g., "/accounts/get")
        endpointKey:
          type: string
          description: Full endpoint key for routing (e.g., "accounts:POST:/accounts/get")

    DisconnectNotificationEvent:
      allOf:
        - $ref: '#/components/schemas/BaseClientEvent'
      type: object
      additionalProperties: false
      x-client-event: true
      description: |
        Sent to client before WebSocket connection is closed.
        If reconnectable, includes a token for session restoration.
      required:
        - reconnectable
        - reason
      properties:
        eventName:
          type: string
          default: "connect.disconnect_notification"
          description: Fixed event type identifier
        reconnectionToken:
          type: string
          nullable: true
          description: Token for reconnecting to the same session (valid for 5 minutes)
        expiresAt:
          type: string
          format: date-time
          nullable: true
          description: When the reconnection token expires
        reconnectable:
          type: boolean
          description: Whether this session can be reconnected
        reason:
          type: string
          description: |
            Reason for disconnection:
            - graceful_disconnect: Client-initiated or idle timeout
            - session_invalidated: Session was revoked (e.g., logout, account deleted)
            - server_shutdown: Server is shutting down gracefully
            - forced_disconnect: Administrative disconnection

    SystemErrorEvent:
      allOf:
        - $ref: '#/components/schemas/BaseClientEvent'
      type: object
      additionalProperties: false
      x-client-event: true
      description: |
        Generic error notification sent to client.
        Used for recoverable errors that the client should be aware of.
      required:
        - errorCode
        - message
      properties:
        eventName:
          type: string
          default: "system.error"
          description: Fixed event type identifier
        errorCode:
          type: string
          description: Machine-readable error code (e.g., "SERVICE_UNAVAILABLE", "RATE_LIMITED")
        message:
          type: string
          description: Human-readable error message
        details:
          type: object
          additionalProperties: true
          nullable: true
          description: Additional error details (service-specific)
        recoverable:
          type: boolean
          default: true
          description: Whether the client can retry the operation

    SessionCapabilitiesEvent:
      allOf:
        - $ref: '#/components/schemas/BaseClientEvent'
      type: object
      additionalProperties: false
      x-client-event: true
      description: |
        Internal event carrying compiled capabilities from Permissions to Connect.
        NOT forwarded to clients - Connect intercepts, generates client-salted GUIDs,
        and sends CapabilityManifestEvent to the client.
      required:
        - sessionId
        - permissions
      properties:
        eventName:
          type: string
          default: "permission.session_capabilities"
          description: Fixed event type identifier (internal, not forwarded to client)
        sessionId:
          type: string
          format: uuid
          description: Session ID these capabilities apply to
        permissions:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          description: Map of ServiceID -> List of available methods (e.g., "accounts" -> ["POST:/get-account"])
        reason:
          type: string
          nullable: true
          description: Why capabilities were sent (e.g., "session_connected", "service_registered", "role_changed")

    SystemNotificationEvent:
      allOf:
        - $ref: '#/components/schemas/BaseClientEvent'
      type: object
      additionalProperties: false
      x-client-event: true
      description: |
        Generic notification event for system-level messages.
        Used for announcements, maintenance notices, etc.
      required:
        - notificationType
        - message
      properties:
        eventName:
          type: string
          default: "system.notification"
          description: Fixed event type identifier
        notificationType:
          type: string
          enum: [info, warning, maintenance, announcement]
          description: Type of notification
        message:
          type: string
          description: Human-readable notification message
        title:
          type: string
          nullable: true
          description: Optional notification title
        actionUrl:
          type: string
          nullable: true
          description: Optional URL for more information
        expiresAt:
          type: string
          format: date-time
          nullable: true
          description: When this notification expires/becomes irrelevant

    # ============================================================
    # SESSION SHORTCUT EVENTS
    # Internal events for services to publish/revoke session shortcuts.
    # Sent to CONNECT_SESSION_{sessionId} topics, handled by Connect.
    # NOT forwarded to clients - Connect updates internal state and
    # sends updated CapabilityManifestEvent with shortcut info.
    # ============================================================

    ShortcutPublishedEvent:
      allOf:
        - $ref: '#/components/schemas/BaseClientEvent'
      type: object
      additionalProperties: false
      x-client-event: true
      description: |
        Published by services to create or update a session shortcut.
        Sent to CONNECT_SESSION_{sessionId} topic for the specific session.
        Connect handles this event internally and does NOT forward to the client.
      required:
        - sessionId
        - shortcut
      properties:
        eventName:
          type: string
          default: "session.shortcut_published"
          description: Fixed event type identifier.
        sessionId:
          type: string
          format: uuid
          description: Target session for this shortcut.
        shortcut:
          $ref: '#/components/schemas/SessionShortcut'
          description: The session shortcut definition containing the pre-bound payload and routing information.
        replaceExisting:
          type: boolean
          default: true
          description: |
            If true and a shortcut with the same routeGuid exists, replace it.
            If false and shortcut exists, the event is ignored.

    ShortcutRevokedEvent:
      allOf:
        - $ref: '#/components/schemas/BaseClientEvent'
      type: object
      additionalProperties: false
      x-client-event: true
      description: |
        Published by services to remove shortcuts.
        Sent to CONNECT_SESSION_{sessionId} topic for the specific session.
        Supports both single-shortcut revocation (by routeGuid) and
        bulk revocation (all shortcuts from a sourceService).
      required:
        - sessionId
      properties:
        eventName:
          type: string
          default: "session.shortcut_revoked"
          description: Fixed event type identifier.
        sessionId:
          type: string
          format: uuid
          description: Target session for revocation.
        routeGuid:
          type: string
          format: uuid
          nullable: true
          description: |
            Specific shortcut to revoke.
            If provided, only this shortcut is removed.
            Mutually exclusive with revokeByService.
        revokeByService:
          type: string
          nullable: true
          description: |
            Revoke ALL shortcuts from this source service.
            Used when a service needs to clear all its shortcuts.
            Mutually exclusive with routeGuid.
        reason:
          type: string
          nullable: true
          description: Optional reason for revocation (for logging/debugging).

    SessionShortcut:
      type: object
      additionalProperties: false
      description: |
        A pre-bound API call that clients can invoke with a single GUID.
        The boundPayload is injected by Connect when the shortcut is invoked.
      required:
        - routeGuid
        - targetGuid
        - boundPayload
        - metadata
      properties:
        routeGuid:
          type: string
          format: uuid
          description: |
            Client-salted GUID for invoking this shortcut.
            Uses UUID version 7 bits to distinguish from service GUIDs (version 5).
        targetGuid:
          type: string
          format: uuid
          description: |
            The actual service capability GUID this shortcut invokes.
            Must be a valid capability in the client's current capability manifest.
        boundPayload:
          type: string
          description: |
            Pre-serialized JSON payload passed unchanged to the target service.
            Connect treats this as opaque bytes - no deserialization or modification.
        metadata:
          $ref: '#/components/schemas/SessionShortcutMetadata'
          description: Metadata about the shortcut including display name, source service, and lifecycle information.

    SessionShortcutMetadata:
      type: object
      additionalProperties: false
      description: |
        Metadata about a session shortcut for display, debugging, and lifecycle management.
      required:
        - name
        - sourceService
        - createdAt
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 128
          description: |
            Machine-readable identifier for this shortcut.
            Examples: "join_game_arcadia", "get_my_stats"
        description:
          type: string
          maxLength: 500
          nullable: true
          description: Human-readable description of what this shortcut does.
        sourceService:
          type: string
          description: The service that created this shortcut.
        targetService:
          type: string
          nullable: true  # NRT: Optional property MUST be nullable
          description: The target service for routing.
        targetMethod:
          type: string
          default: "POST"
          nullable: true  # NRT: Optional property MUST be nullable
          description: The target HTTP method for routing.
        targetEndpoint:
          type: string
          nullable: true  # NRT: Optional property MUST be nullable
          description: The target endpoint for routing.
        createdAt:
          type: string
          format: date-time
          description: When this shortcut was created.
        expiresAt:
          type: string
          format: date-time
          nullable: true
          description: |
            Optional TTL for this shortcut.
            If set, Connect automatically removes the shortcut after this time.
        tags:
          type: array
          items:
            type: string
          nullable: true
          description: Optional categorization tags for client-side organization.
        displayName:
          type: string
          maxLength: 64
          nullable: true
          description: Optional user-friendly name for display in client UIs.
