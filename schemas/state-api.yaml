openapi: 3.0.3
info:
  title: Bannou State Service API
  version: 1.0.0
  description: |
    Repository pattern state management with Redis and MySQL backends.

    NOTE: This is an INTERNAL service API. No x-permissions are defined because
    these endpoints are NOT exposed to WebSocket clients. Service-to-service
    calls within the cluster are always permitted (per TENETS Tenet 13).

    All endpoints use POST-only pattern per TENETS Tenet 1 to enable
    zero-copy WebSocket routing with static endpoint GUIDs.

servers:
- url: http://localhost:3500/v1.0/invoke/bannou/method

paths:
  /state/get:
    post:
      operationId: getState
      summary: Get state value by key
      tags:
      - State
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetStateRequest'
      responses:
        '200':
          description: State value retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetStateResponse'
        '404':
          description: Key not found

      x-request-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/GetStateRequest\"\
        ,\n  \"$defs\": {\n    \"GetStateRequest\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"storeName\"\
        ,\n        \"key\"\n      ],\n      \"properties\": {\n        \"storeName\": {\n          \"type\": \"string\",\n\
        \          \"description\": \"Name of the state store\"\n        },\n        \"key\": {\n          \"type\": \"string\"\
        ,\n          \"description\": \"Key to retrieve\"\n        }\n      }\n    }\n  }\n}"
      x-response-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/GetStateResponse\"\
        ,\n  \"$defs\": {\n    \"GetStateResponse\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"value\"\
        : {\n          \"type\": \"object\",\n          \"nullable\": true,\n          \"description\": \"The stored value
        (null if not found)\"\n        },\n        \"etag\": {\n          \"type\": \"string\",\n          \"nullable\": true,\n\
        \          \"description\": \"ETag for optimistic concurrency\"\n        },\n        \"metadata\": {\n          \"\
        $ref\": \"#/$defs/StateMetadata\"\n        }\n      }\n    },\n    \"StateMetadata\": {\n      \"type\": \"object\"\
        ,\n      \"properties\": {\n        \"createdAt\": {\n          \"type\": \"string\",\n          \"format\": \"date-time\"\
        ,\n          \"nullable\": true,\n          \"description\": \"When the state was created\"\n        },\n        \"\
        updatedAt\": {\n          \"type\": \"string\",\n          \"format\": \"date-time\",\n          \"nullable\": true,\n\
        \          \"description\": \"When the state was last updated\"\n        },\n        \"version\": {\n          \"\
        type\": \"integer\",\n          \"description\": \"Version number for optimistic concurrency\"\n        }\n      }\n\
        \    }\n  }\n}"
      x-endpoint-info-json: "{\n  \"summary\": \"Get state value by key\",\n  \"description\": \"\",\n  \"tags\": [\n    \"\
        State\"\n  ],\n  \"deprecated\": false,\n  \"operationId\": \"getState\"\n}"
  /state/save:
    post:
      operationId: saveState
      summary: Save state value
      tags:
      - State
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SaveStateRequest'
      responses:
        '200':
          description: State saved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SaveStateResponse'

      x-request-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/SaveStateRequest\"\
        ,\n  \"$defs\": {\n    \"SaveStateRequest\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"storeName\"\
        ,\n        \"key\",\n        \"value\"\n      ],\n      \"properties\": {\n        \"storeName\": {\n          \"\
        type\": \"string\",\n          \"description\": \"Name of the state store\"\n        },\n        \"key\": {\n    \
        \      \"type\": \"string\",\n          \"description\": \"Key to save\"\n        },\n        \"value\": {\n     \
        \     \"type\": \"object\",\n          \"description\": \"Value to store\"\n        },\n        \"options\": {\n \
        \         \"$ref\": \"#/$defs/StateOptions\"\n        }\n      }\n    },\n    \"StateOptions\": {\n      \"type\"\
        : \"object\",\n      \"properties\": {\n        \"ttl\": {\n          \"type\": \"integer\",\n          \"nullable\"\
        : true,\n          \"description\": \"TTL in seconds (Redis only)\"\n        },\n        \"consistency\": {\n    \
        \      \"type\": \"string\",\n          \"enum\": [\n            \"strong\",\n            \"eventual\"\n         \
        \ ],\n          \"default\": \"strong\",\n          \"description\": \"Consistency level\"\n        },\n        \"\
        etag\": {\n          \"type\": \"string\",\n          \"nullable\": true,\n          \"description\": \"Optimistic
        concurrency check - save fails if ETag mismatch\"\n        }\n      }\n    }\n  }\n}"
      x-response-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/SaveStateResponse\"\
        ,\n  \"$defs\": {\n    \"SaveStateResponse\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"\
        etag\": {\n          \"type\": \"string\",\n          \"description\": \"New ETag after save\"\n        },\n     \
        \   \"success\": {\n          \"type\": \"boolean\",\n          \"description\": \"Whether the save succeeded\"\n\
        \        }\n      }\n    }\n  }\n}"
      x-endpoint-info-json: "{\n  \"summary\": \"Save state value\",\n  \"description\": \"\",\n  \"tags\": [\n    \"State\"\
        \n  ],\n  \"deprecated\": false,\n  \"operationId\": \"saveState\"\n}"
  /state/delete:
    post:
      operationId: deleteState
      summary: Delete state value
      tags:
      - State
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeleteStateRequest'
      responses:
        '200':
          description: State deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeleteStateResponse'

      x-request-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/DeleteStateRequest\"\
        ,\n  \"$defs\": {\n    \"DeleteStateRequest\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"storeName\"\
        ,\n        \"key\"\n      ],\n      \"properties\": {\n        \"storeName\": {\n          \"type\": \"string\",\n\
        \          \"description\": \"Name of the state store\"\n        },\n        \"key\": {\n          \"type\": \"string\"\
        ,\n          \"description\": \"Key to delete\"\n        }\n      }\n    }\n  }\n}"
      x-response-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/DeleteStateResponse\"\
        ,\n  \"$defs\": {\n    \"DeleteStateResponse\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"\
        deleted\": {\n          \"type\": \"boolean\",\n          \"description\": \"Whether the key was deleted (false if
        not found)\"\n        }\n      }\n    }\n  }\n}"
      x-endpoint-info-json: "{\n  \"summary\": \"Delete state value\",\n  \"description\": \"\",\n  \"tags\": [\n    \"State\"\
        \n  ],\n  \"deprecated\": false,\n  \"operationId\": \"deleteState\"\n}"
  /state/query:
    post:
      operationId: queryState
      summary: Query state (MySQL stores only)
      tags:
      - State
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QueryStateRequest'
      responses:
        '200':
          description: Query results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueryStateResponse'

      x-request-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/QueryStateRequest\"\
        ,\n  \"$defs\": {\n    \"QueryStateRequest\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"storeName\"\
        ,\n        \"filter\"\n      ],\n      \"properties\": {\n        \"storeName\": {\n          \"type\": \"string\"\
        ,\n          \"description\": \"Name of the state store (must be MySQL backend)\"\n        },\n        \"filter\"\
        : {\n          \"type\": \"object\",\n          \"description\": \"JSON filter expression\"\n        },\n        \"\
        sort\": {\n          \"type\": \"array\",\n          \"items\": {\n            \"$ref\": \"#/$defs/SortField\"\n \
        \         },\n          \"description\": \"Sort order\"\n        },\n        \"page\": {\n          \"type\": \"integer\"\
        ,\n          \"default\": 0,\n          \"description\": \"Page number (0-indexed)\"\n        },\n        \"pageSize\"\
        : {\n          \"type\": \"integer\",\n          \"default\": 100,\n          \"description\": \"Items per page\"\n\
        \        }\n      }\n    },\n    \"SortField\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"\
        field\": {\n          \"type\": \"string\",\n          \"description\": \"Field name to sort by\"\n        },\n  \
        \      \"order\": {\n          \"type\": \"string\",\n          \"enum\": [\n            \"asc\",\n            \"\
        desc\"\n          ],\n          \"default\": \"asc\",\n          \"description\": \"Sort direction\"\n        }\n\
        \      }\n    }\n  }\n}"
      x-response-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/QueryStateResponse\"\
        ,\n  \"$defs\": {\n    \"QueryStateResponse\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"\
        results\": {\n          \"type\": \"array\",\n          \"items\": {\n            \"type\": \"object\"\n         \
        \ },\n          \"description\": \"Query results\"\n        },\n        \"totalCount\": {\n          \"type\": \"\
        integer\",\n          \"description\": \"Total matching items (for pagination)\"\n        },\n        \"page\": {\n\
        \          \"type\": \"integer\",\n          \"description\": \"Current page number\"\n        },\n        \"pageSize\"\
        : {\n          \"type\": \"integer\",\n          \"description\": \"Items per page\"\n        }\n      }\n    }\n\
        \  }\n}"
      x-endpoint-info-json: "{\n  \"summary\": \"Query state (MySQL stores only)\",\n  \"description\": \"\",\n  \"tags\"\
        : [\n    \"State\"\n  ],\n  \"deprecated\": false,\n  \"operationId\": \"queryState\"\n}"
  /state/bulk-get:
    post:
      operationId: bulkGetState
      summary: Bulk get multiple keys
      tags:
      - State
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BulkGetStateRequest'
      responses:
        '200':
          description: Bulk results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BulkGetStateResponse'

      x-request-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/BulkGetStateRequest\"\
        ,\n  \"$defs\": {\n    \"BulkGetStateRequest\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"\
        storeName\",\n        \"keys\"\n      ],\n      \"properties\": {\n        \"storeName\": {\n          \"type\": \"\
        string\",\n          \"description\": \"Name of the state store\"\n        },\n        \"keys\": {\n          \"type\"\
        : \"array\",\n          \"items\": {\n            \"type\": \"string\"\n          },\n          \"description\": \"\
        Keys to retrieve\"\n        }\n      }\n    }\n  }\n}"
      x-response-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/BulkGetStateResponse\"\
        ,\n  \"$defs\": {\n    \"BulkGetStateResponse\": {\n      \"type\": \"object\",\n      \"properties\": {\n       \
        \ \"items\": {\n          \"type\": \"array\",\n          \"items\": {\n            \"$ref\": \"#/$defs/BulkStateItem\"\
        \n          },\n          \"description\": \"Results for each key\"\n        }\n      }\n    },\n    \"BulkStateItem\"\
        : {\n      \"type\": \"object\",\n      \"properties\": {\n        \"key\": {\n          \"type\": \"string\",\n \
        \         \"description\": \"The key\"\n        },\n        \"value\": {\n          \"type\": \"object\",\n      \
        \    \"nullable\": true,\n          \"description\": \"The value (null if not found)\"\n        },\n        \"etag\"\
        : {\n          \"type\": \"string\",\n          \"nullable\": true,\n          \"description\": \"ETag for this item\"\
        \n        },\n        \"found\": {\n          \"type\": \"boolean\",\n          \"description\": \"Whether the key
        was found\"\n        }\n      }\n    }\n  }\n}"
      x-endpoint-info-json: "{\n  \"summary\": \"Bulk get multiple keys\",\n  \"description\": \"\",\n  \"tags\": [\n    \"\
        State\"\n  ],\n  \"deprecated\": false,\n  \"operationId\": \"bulkGetState\"\n}"
  /state/list-stores:
    post:
      operationId: listStores
      summary: List configured state stores
      tags:
      - State
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ListStoresRequest'
      responses:
        '200':
          description: List of stores
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListStoresResponse'

      x-request-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/ListStoresRequest\"\
        ,\n  \"$defs\": {\n    \"ListStoresRequest\": {\n      \"type\": \"object\",\n      \"description\": \"Optional filters
        for store listing (empty object returns all)\",\n      \"properties\": {\n        \"backendFilter\": {\n         \
        \ \"type\": \"string\",\n          \"enum\": [\n            \"redis\",\n            \"mysql\"\n          ],\n    \
        \      \"nullable\": true,\n          \"description\": \"Filter stores by backend type\"\n        },\n        \"includeStats\"\
        : {\n          \"type\": \"boolean\",\n          \"default\": false,\n          \"description\": \"Include key counts
        (may be slow for large stores)\"\n        }\n      }\n    }\n  }\n}"
      x-response-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/ListStoresResponse\"\
        ,\n  \"$defs\": {\n    \"ListStoresResponse\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"\
        stores\": {\n          \"type\": \"array\",\n          \"items\": {\n            \"$ref\": \"#/$defs/StoreInfo\"\n\
        \          },\n          \"description\": \"List of configured stores\"\n        }\n      }\n    },\n    \"StoreInfo\"\
        : {\n      \"type\": \"object\",\n      \"properties\": {\n        \"name\": {\n          \"type\": \"string\",\n\
        \          \"description\": \"Store name\"\n        },\n        \"backend\": {\n          \"type\": \"string\",\n\
        \          \"enum\": [\n            \"redis\",\n            \"mysql\"\n          ],\n          \"description\": \"\
        Backend type\"\n        },\n        \"keyCount\": {\n          \"type\": \"integer\",\n          \"nullable\": true,\n\
        \          \"description\": \"Number of keys (only if includeStats=true)\"\n        }\n      }\n    }\n  }\n}"
      x-endpoint-info-json: "{\n  \"summary\": \"List configured state stores\",\n  \"description\": \"\",\n  \"tags\": [\n\
        \    \"State\"\n  ],\n  \"deprecated\": false,\n  \"operationId\": \"listStores\"\n}"
components:
  schemas:
    GetStateRequest:
      type: object
      required:
      - storeName
      - key
      properties:
        storeName:
          type: string
          description: Name of the state store
        key:
          type: string
          description: Key to retrieve

    GetStateResponse:
      type: object
      properties:
        value:
          type: object
          nullable: true
          description: The stored value (null if not found)
        etag:
          type: string
          nullable: true
          description: ETag for optimistic concurrency
        metadata:
          $ref: '#/components/schemas/StateMetadata'

    SaveStateRequest:
      type: object
      required:
      - storeName
      - key
      - value
      properties:
        storeName:
          type: string
          description: Name of the state store
        key:
          type: string
          description: Key to save
        value:
          type: object
          description: Value to store
        options:
          $ref: '#/components/schemas/StateOptions'

    SaveStateResponse:
      type: object
      properties:
        etag:
          type: string
          description: New ETag after save
        success:
          type: boolean
          description: Whether the save succeeded

    DeleteStateRequest:
      type: object
      required:
      - storeName
      - key
      properties:
        storeName:
          type: string
          description: Name of the state store
        key:
          type: string
          description: Key to delete

    DeleteStateResponse:
      type: object
      properties:
        deleted:
          type: boolean
          description: Whether the key was deleted (false if not found)

    StateOptions:
      type: object
      properties:
        ttl:
          type: integer
          nullable: true
          description: TTL in seconds (Redis only)
        consistency:
          type: string
          enum:
          - strong
          - eventual
          default: strong
          description: Consistency level
        etag:
          type: string
          nullable: true
          description: Optimistic concurrency check - save fails if ETag mismatch

    StateMetadata:
      type: object
      properties:
        createdAt:
          type: string
          format: date-time
          nullable: true
          description: When the state was created
        updatedAt:
          type: string
          format: date-time
          nullable: true
          description: When the state was last updated
        version:
          type: integer
          description: Version number for optimistic concurrency

    QueryStateRequest:
      type: object
      required:
      - storeName
      - filter
      properties:
        storeName:
          type: string
          description: Name of the state store (must be MySQL backend)
        filter:
          type: object
          description: JSON filter expression
        sort:
          type: array
          items:
            $ref: '#/components/schemas/SortField'
          description: Sort order
        page:
          type: integer
          default: 0
          description: Page number (0-indexed)
        pageSize:
          type: integer
          default: 100
          description: Items per page

    SortField:
      type: object
      properties:
        field:
          type: string
          description: Field name to sort by
        order:
          type: string
          enum:
          - asc
          - desc
          default: asc
          description: Sort direction

    QueryStateResponse:
      type: object
      properties:
        results:
          type: array
          items:
            type: object
          description: Query results
        totalCount:
          type: integer
          description: Total matching items (for pagination)
        page:
          type: integer
          description: Current page number
        pageSize:
          type: integer
          description: Items per page

    BulkGetStateRequest:
      type: object
      required:
      - storeName
      - keys
      properties:
        storeName:
          type: string
          description: Name of the state store
        keys:
          type: array
          items:
            type: string
          description: Keys to retrieve

    BulkGetStateResponse:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/BulkStateItem'
          description: Results for each key

    BulkStateItem:
      type: object
      properties:
        key:
          type: string
          description: The key
        value:
          type: object
          nullable: true
          description: The value (null if not found)
        etag:
          type: string
          nullable: true
          description: ETag for this item
        found:
          type: boolean
          description: Whether the key was found

    ListStoresRequest:
      type: object
      description: Optional filters for store listing (empty object returns all)
      properties:
        backendFilter:
          type: string
          enum:
          - redis
          - mysql
          nullable: true
          description: Filter stores by backend type
        includeStats:
          type: boolean
          default: false
          description: Include key counts (may be slow for large stores)

    ListStoresResponse:
      type: object
      properties:
        stores:
          type: array
          items:
            $ref: '#/components/schemas/StoreInfo'
          description: List of configured stores

    StoreInfo:
      type: object
      properties:
        name:
          type: string
          description: Store name
        backend:
          type: string
          enum:
          - redis
          - mysql
          description: Backend type
        keyCount:
          type: integer
          nullable: true
          description: Number of keys (only if includeStats=true)
