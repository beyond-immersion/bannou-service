openapi: 3.0.3
info:
  title: Bannou State Service API
  version: 1.0.0
  description: |
    Repository pattern state management with Redis and MySQL backends.

    NOTE: This is an INTERNAL service API using empty x-permissions (internal-only).
    Service-to-service calls within the cluster are always permitted (per FOUNDATION TENETS).

    All endpoints use POST-only pattern per FOUNDATION TENETS to enable
    zero-copy WebSocket routing with static endpoint GUIDs.

    **SCHEMA MODIFICATION GATE**: STOP. Before modifying this schema, you MUST:
    1. Read docs/reference/SCHEMA-RULES.md
    2. State which section applies to your change
    3. Only then proceed with edits
    Edits without stating the applicable rule are FORBIDDEN.
servers:
- url: http://localhost:5012

paths:
  /state/get:
    post:
      operationId: getState
      summary: Get state value by key
      tags:
      - State
      x-permissions: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetStateRequest'
      responses:
        '200':
          description: State value retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetStateResponse'
        '404':
          description: Key not found

  /state/save:
    post:
      operationId: saveState
      summary: Save state value
      tags:
      - State
      x-permissions: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SaveStateRequest'
      responses:
        '200':
          description: State saved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SaveStateResponse'

  /state/delete:
    post:
      operationId: deleteState
      summary: Delete state value
      tags:
      - State
      x-permissions: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeleteStateRequest'
      responses:
        '200':
          description: State deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeleteStateResponse'

  /state/query:
    post:
      operationId: queryState
      summary: Query state (MySQL JSON queries or Redis with search enabled)
      tags:
      - State
      x-permissions: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QueryStateRequest'
      responses:
        '200':
          description: Query results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueryStateResponse'
        '400':
          description: Query not supported (Redis store without search enabled)
        '404':
          description: Store not found

  /state/bulk-get:
    post:
      operationId: bulkGetState
      summary: Bulk get multiple keys
      tags:
      - State
      x-permissions: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BulkGetStateRequest'
      responses:
        '200':
          description: Bulk results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BulkGetStateResponse'

  /state/list-stores:
    post:
      operationId: listStores
      summary: List configured state stores
      tags:
      - State
      x-permissions: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ListStoresRequest'
      responses:
        '200':
          description: List of stores
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListStoresResponse'

components:
  schemas:
    GetStateRequest:
      description: Request to retrieve a single state value by key from a state store
      type: object
      additionalProperties: false
      required:
      - storeName
      - key
      properties:
        storeName:
          type: string
          description: Name of the state store
        key:
          type: string
          description: Key to retrieve

    GetStateResponse:
      description: Response containing a retrieved state value with its metadata and ETag
      type: object
      additionalProperties: false
      properties:
        value:
          type: object
          additionalProperties: false
          nullable: true
          description: The stored value (null if not found)
        etag:
          type: string
          nullable: true
          description: ETag for optimistic concurrency
        metadata:
          $ref: '#/components/schemas/StateMetadata'
          description: Metadata about the state entry including timestamps and version

    SaveStateRequest:
      description: Request to save a state value to a state store with optional TTL and consistency settings
      type: object
      additionalProperties: false
      required:
      - storeName
      - key
      - value
      properties:
        storeName:
          type: string
          description: Name of the state store
        key:
          type: string
          description: Key to save
        value:
          type: object
          additionalProperties: false
          description: Value to store
        options:
          nullable: true
          $ref: '#/components/schemas/StateOptions'
          description: Optional settings for the save operation including TTL and consistency

    SaveStateResponse:
      description: Response from a save operation containing the new ETag
      type: object
      additionalProperties: false
      properties:
        etag:
          type: string
          description: New ETag after save

    DeleteStateRequest:
      description: Request to delete a state value by key from a state store
      type: object
      additionalProperties: false
      required:
      - storeName
      - key
      properties:
        storeName:
          type: string
          description: Name of the state store
        key:
          type: string
          description: Key to delete

    DeleteStateResponse:
      description: Response from a delete operation indicating whether the key was removed
      type: object
      additionalProperties: false
      properties:
        deleted:
          type: boolean
          description: Whether the key was deleted (false if not found)

    StateOptions:
      description: Configuration options for state save operations including TTL, consistency level, and optimistic 
        concurrency
      type: object
      additionalProperties: false
      properties:
        ttl:
          type: integer
          nullable: true
          description: TTL in seconds (Redis only)
        consistency:
          type: string
          enum:
          - strong
          - eventual
          default: strong
          description: Consistency level
        etag:
          type: string
          nullable: true
          description: Optimistic concurrency check - save fails if ETag mismatch

    StateMetadata:
      description: Metadata associated with a state entry including creation time, last update time, and version
      type: object
      additionalProperties: false
      properties:
        createdAt:
          type: string
          format: date-time
          nullable: true
          description: When the state was created
        updatedAt:
          type: string
          format: date-time
          nullable: true
          description: When the state was last updated
        version:
          type: integer
          description: Version number for optimistic concurrency

    QueryStateRequest:
      description: Request to query state entries with filtering, sorting, and pagination support for MySQL and Redis 
        backends
      type: object
      additionalProperties: false
      required:
      - storeName
      properties:
        storeName:
          type: string
          description: Name of the state store (MySQL or Redis with search enabled)
        conditions:
          type: array
          items:
            $ref: '#/components/schemas/QueryCondition'
          nullable: true
          description: |
            Query conditions for MySQL JSON queries. Multiple conditions are combined with AND.
            For Redis search, use indexName and query properties instead.
        indexName:
          type: string
          nullable: true
          description: |
            Redis search index name. Defaults to "{storeName}-idx".
            Only used for Redis stores with search enabled.
        query:
          type: string
          nullable: true
          description: |
            RedisSearch query string (e.g., "@name:John", "@age:[18 +inf]", "*").
            Defaults to "*" (match all). Only used for Redis stores with search enabled.
        sort:
          type: array
          items:
            $ref: '#/components/schemas/SortField'
          nullable: true
          description: Sort order (first field only is used) (null for default ordering)
        page:
          type: integer
          default: 0
          description: Page number (0-indexed)
        pageSize:
          type: integer
          default: 100
          description: Items per page (max 1000)

    SortField:
      description: Specifies a field and direction for sorting query results
      type: object
      additionalProperties: false
      properties:
        field:
          type: string
          description: Field name to sort by (JSON path for MySQL, field name for Redis)
        order:
          type: string
          enum:
          - asc
          - desc
          default: asc
          description: Sort direction

    QueryCondition:
      type: object
      additionalProperties: false
      description: A single query condition for MySQL JSON queries
      required:
      - path
      properties:
        path:
          type: string
          description: JSON path to query (e.g., "$.name", "$.address.city", "$.tags[0]")
        operator:
          $ref: '#/components/schemas/QueryOperator'
          description: Comparison operator to use for the condition
        value:
          description: Value to compare against. Not required for exists/notExists operators.

    QueryOperator:
      type: string
      description: Comparison operator for query conditions
      enum:
      - equals
      - notEquals
      - greaterThan
      - greaterThanOrEqual
      - lessThan
      - lessThanOrEqual
      - contains
      - startsWith
      - endsWith
      - in
      - exists
      - notExists
      - fullText
      default: equals

    QueryStateResponse:
      description: Response containing paginated query results with total count information
      type: object
      additionalProperties: false
      properties:
        results:
          type: array
          items:
            type: object
            additionalProperties: false
          description: Query results
        totalCount:
          type: integer
          description: Total matching items (for pagination)
        page:
          type: integer
          description: Current page number
        pageSize:
          type: integer
          description: Items per page

    BulkGetStateRequest:
      description: Request to retrieve multiple state values by key in a single operation
      type: object
      additionalProperties: false
      required:
      - storeName
      - keys
      properties:
        storeName:
          type: string
          description: Name of the state store
        keys:
          type: array
          items:
            type: string
          description: Keys to retrieve

    BulkGetStateResponse:
      description: Response containing the results of a bulk get operation for multiple keys
      type: object
      additionalProperties: false
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/BulkStateItem'
          description: Results for each key

    BulkStateItem:
      description: A single item result from a bulk get operation including the key, value, ETag, and found status
      type: object
      additionalProperties: false
      properties:
        key:
          type: string
          description: The key
        value:
          type: object
          additionalProperties: false
          nullable: true
          description: The value (null if not found)
        etag:
          type: string
          nullable: true
          description: ETag for this item
        found:
          type: boolean
          description: Whether the key was found

    ListStoresRequest:
      type: object
      additionalProperties: false
      description: Optional filters for store listing (empty object returns all)
      properties:
        backendFilter:
          type: string
          enum:
          - redis
          - mysql
          nullable: true
          description: Filter stores by backend type
        includeStats:
          type: boolean
          default: false
          description: Include key counts (may be slow for large stores)

    ListStoresResponse:
      description: Response containing the list of configured state stores
      type: object
      additionalProperties: false
      properties:
        stores:
          type: array
          items:
            $ref: '#/components/schemas/StoreInfo'
          description: List of configured stores

    StoreInfo:
      description: Information about a configured state store including its name, backend type, and optional key count
      type: object
      additionalProperties: false
      properties:
        name:
          type: string
          description: Store name
        backend:
          type: string
          enum:
          - redis
          - mysql
          description: Backend type
        keyCount:
          type: integer
          nullable: true
          description: Number of keys (only if includeStats=true)
