openapi: 3.0.0
info:
  title: Bannou Game Session Service API
  description: |
    Minimal game session management for Arcadia and other games.

    **POST-Only API Pattern**: This API uses POST for all operations to support zero-copy
    WebSocket routing. Path parameters are passed in request bodies instead of URLs.
    See docs/BANNOU_DESIGN.md for architectural rationale.

    **NRT Compliance**: AI agents MUST review docs/NRT-SCHEMA-RULES.md before modifying this schema. Optional reference types require `nullable: true`.
  version: 2.0.0
  # NOTE: Event subscriptions moved to game-session-events.yaml (x-event-subscriptions)
servers:
- url: http://localhost:5012
  description: Bannou service endpoint (internal only)

paths:
  /sessions/list:
    post:
      summary: List available game sessions
      description: |
        List available game sessions. This endpoint is not directly accessible via WebSocket API.
        Access is granted through session shortcuts or internal service calls.
      operationId: listGameSessions
      tags:
      - Game Sessions
      x-permissions:
      - role: admin
        states: {}
      x-rate-limit:
        requestsPerMinute: 30
        requestsPerHour: 500
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ListGameSessionsRequest'
      responses:
        '200':
          description: Game sessions retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GameSessionListResponse'

  /sessions/create:
    post:
      summary: Create new game session
      description: |
        Create a new game session. This endpoint is not directly accessible via WebSocket API.
        Access is granted through session shortcuts or internal service calls.
      operationId: createGameSession
      tags:
      - Game Sessions
      x-permissions: []
      x-rate-limit:
        requestsPerMinute: 5
        requestsPerHour: 20
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateGameSessionRequest'
      responses:
        '200':
          description: Game session created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GameSessionResponse'

  /sessions/get:
    post:
      summary: Get game session details
      description: Get details of the current game session the user has joined.
      operationId: getGameSession
      tags:
      - Game Sessions
      x-permissions:
      - role: user
        states:
          game-session: in_game
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetGameSessionRequest'
      responses:
        '200':
          description: Game session retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GameSessionResponse'
        '404':
          description: Game session not found

  /sessions/join:
    post:
      summary: Join a game session
      description: |
        Join an existing game session. This endpoint is not directly accessible via WebSocket API.
        Access is granted through session shortcuts published by the game-session service when
        a subscribed user connects. The shortcut contains a pre-bound JoinGameSessionRequest
        with the target session ID already filled in.
      operationId: joinGameSession
      tags:
      - Game Sessions
      x-permissions: []
      x-rate-limit:
        requestsPerMinute: 10
        requestsPerHour: 50
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JoinGameSessionRequest'
      responses:
        '200':
          description: Successfully joined game session
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JoinGameSessionResponse'
        '404':
          description: Game session not found
        '409':
          description: Session full or already joined

  /sessions/leave:
    post:
      summary: Leave a game session
      operationId: leaveGameSession
      tags:
      - Game Sessions
      x-permissions:
      - role: user
        states:
          game-session: in_game
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LeaveGameSessionRequest'
      responses:
        '200':
          description: Successfully left game session
        '404':
          description: Game session not found

  /sessions/kick:
    post:
      summary: Kick player from game session (admin only)
      operationId: kickPlayer
      tags:
      - Game Sessions
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/KickPlayerRequest'
      responses:
        '200':
          description: Player kicked successfully
        '404':
          description: Game session or player not found
        '403':
          description: Not authorized to kick players

  /sessions/chat:
    post:
      summary: Send chat message to game session
      operationId: sendChatMessage
      tags:
      - Game Chat
      x-permissions:
      - role: user
        states:
          game-session: in_game
      x-rate-limit:
        requestsPerMinute: 60
        burstLimit: 10
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatMessageRequest'
      responses:
        '200':
          description: Chat message sent successfully
        '404':
          description: Game session not found

  /sessions/actions:
    post:
      summary: Perform game action (enhanced permissions after joining)
      operationId: performGameAction
      tags:
      - Game Actions
      x-permissions:
      - role: user
        states:
          game-session: in_game
      x-rate-limit:
        requestsPerMinute: 120
        burstLimit: 20
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GameActionRequest'
      responses:
        '200':
          description: Game action performed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GameActionResponse'
        '404':
          description: Game session not found
        '400':
          description: Invalid game action

  /sessions/join-session:
    post:
      summary: Join a specific game session by ID
      description: |
        Join a game session by its session ID. Used for matchmade games where the session
        is pre-created by the matchmaking service and the player has a reservation.
        For matchmade sessions, a valid reservation token is required.
        For lobby sessions, this allows joining by ID without going through gameType lookup.
      operationId: joinGameSessionById
      tags:
      - Game Sessions
      x-permissions: []
      x-rate-limit:
        requestsPerMinute: 10
        requestsPerHour: 50
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JoinGameSessionByIdRequest'
      responses:
        '200':
          description: Successfully joined game session
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JoinGameSessionResponse'
        '404':
          description: Game session not found
        '403':
          description: Invalid or missing reservation token for matchmade session
        '409':
          description: Session full, reservation expired, or already joined
  /sessions/leave-session:
    post:
      summary: Leave a specific game session by ID
      description: |
        Leave a game session by its session ID. This is the session-specific alternative
        to /sessions/leave which uses gameType. Useful for matchmade sessions.
      operationId: leaveGameSessionById
      tags:
      - Game Sessions
      x-permissions:
      - role: user
        states:
          game-session: in_game
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LeaveGameSessionByIdRequest'
      responses:
        '200':
          description: Successfully left game session
        '404':
          description: Game session not found or player not in session
  /sessions/publish-join-shortcut:
    post:
      summary: Publish join shortcut for matchmade session
      description: |
        Internal endpoint for the matchmaking service to trigger shortcut publishing
        to a specific player for a matchmade session. The shortcut allows the player
        to join the session with their reservation token pre-bound.
      operationId: publishJoinShortcut
      tags:
      - Internal
      x-permissions: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PublishJoinShortcutRequest'
      responses:
        '200':
          description: Shortcut published successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PublishJoinShortcutResponse'
        '404':
          description: Game session or WebSocket session not found
        '400':
          description: Invalid reservation token
components:
  schemas:
    # Request Models for POST-only pattern
    ListGameSessionsRequest:
      type: object
      description: Request to list available game sessions
      additionalProperties: false
      properties:
        gameType:
          type: string
          enum: [arcadia, generic]
          description: Filter by game type
        status:
          type: string
          enum: [waiting, active, full]
          description: Filter by session status

    GetGameSessionRequest:
      type: object
      description: Request to get a specific game session
      additionalProperties: false
      required:
      - sessionId
      properties:
        sessionId:
          type: string
          format: uuid
          description: ID of the game session to retrieve

    LeaveGameSessionRequest:
      type: object
      description: Request to leave a game session
      additionalProperties: false
      required:
      - sessionId
      - accountId
      - gameType
      properties:
        sessionId:
          type: string
          format: uuid
          description: WebSocket session ID of the client leaving. Provided by shortcut system.
        accountId:
          type: string
          format: uuid
          description: Account ID of the player leaving. Provided by shortcut system.
        gameType:
          type: string
          description: Game type being left. Determines which lobby to leave. Provided by shortcut system.

    CreateGameSessionRequest:
      description: Request to create a new game session with specified settings
      type: object
      additionalProperties: false
      required:
      - gameType
      - maxPlayers
      properties:
        gameType:
          type: string
          enum: [arcadia, generic]
          description: Type of game for this session (arcadia or generic)
        maxPlayers:
          type: integer
          minimum: 1
          maximum: 100
          description: Maximum number of players allowed in the session
        sessionName:
          type: string
          nullable: true
          maxLength: 100
          description: Optional display name for the session
        isPrivate:
          type: boolean
          default: false
          description: Whether the session requires a password to join
        ownerId:
          type: string
          format: uuid
          description: Account ID of the session owner. If not provided, defaults to caller's account.
        gameSettings:
          type: object
          additionalProperties: true
          nullable: true
          description: Game-specific configuration settings (null to use defaults)
        sessionType:
          $ref: '#/components/schemas/SessionType'
          description: Type of session - lobby (persistent) or matchmade (time-limited with reservations). Defaults to 
            lobby.
        expectedPlayers:
          type: array
          items:
            type: string
            format: uuid
          nullable: true
          description: For matchmade sessions - list of account IDs expected to join. Reservations created for each.
        reservationTtlSeconds:
          type: integer
          minimum: 10
          maximum: 300
          default: 60
          description: For matchmade sessions - how long reservations last before expiring (seconds)

    GameSessionResponse:
      description: Complete details of a game session including players and settings
      type: object
      additionalProperties: false
      required:
      - sessionId
      - gameType
      - status
      - createdAt
      - sessionType
      properties:
        sessionId:
          type: string
          format: uuid
          description: Unique identifier for the game session
        gameType:
          type: string
          enum: [arcadia, generic]
          description: Type of game for this session
        sessionType:
          $ref: '#/components/schemas/SessionType'
          description: Type of session - lobby or matchmade
        sessionName:
          type: string
          nullable: true
          description: Display name for the session
        status:
          type: string
          enum: [waiting, active, full, finished]
          description: Current status of the game session
        maxPlayers:
          type: integer
          description: Maximum number of players allowed in the session
        currentPlayers:
          type: integer
          description: Current number of players in the session
        isPrivate:
          type: boolean
          description: Whether the session requires a password to join
        owner:
          type: string
          format: uuid
          description: Account ID of the session owner
        players:
          type: array
          items:
            $ref: '#/components/schemas/GamePlayer'
          description: List of players currently in the session
        createdAt:
          type: string
          format: date-time
          description: Timestamp when the session was created
        gameSettings:
          type: object
          additionalProperties: true
          # NRT: Optional object MUST be nullable (Rule 2)
          nullable: true
          description: Game-specific configuration settings
        reservations:
          type: array
          items:
            $ref: '#/components/schemas/ReservationInfo'
          nullable: true
          description: For matchmade sessions - reservation tokens for expected players
        reservationExpiresAt:
          type: string
          format: date-time
          nullable: true
          description: For matchmade sessions - when reservations expire

    GameSessionListResponse:
      description: Response containing a list of game sessions matching filter criteria
      type: object
      additionalProperties: false
      required:
      - sessions
      properties:
        sessions:
          type: array
          items:
            $ref: '#/components/schemas/GameSessionResponse'
          description: List of game sessions matching the filter criteria
        totalCount:
          type: integer
          description: Total number of sessions matching the filter (for pagination)

    JoinGameSessionRequest:
      description: Request to join an existing game session as a player
      type: object
      additionalProperties: false
      required:
      - sessionId
      - accountId
      - gameType
      properties:
        sessionId:
          type: string
          format: uuid
          description: WebSocket session ID of the client joining. Provided by shortcut system. Used for event delivery.
        accountId:
          type: string
          format: uuid
          description: Account ID of the player joining. Provided by shortcut system.
        gameType:
          type: string
          description: Game type to join (e.g., 'arcadia', 'generic'). Determines which lobby to join. Provided by 
            shortcut system.
        password:
          type: string
          nullable: true
          description: Password for private sessions (null for public sessions)
        characterData:
          type: object
          additionalProperties: true
          nullable: true
          description: Game-specific character data (null if no character data)
        voiceEndpoint:
          $ref: '#/components/schemas/VoiceSipEndpoint'
          nullable: true
          description: Client's SIP endpoint for voice communication (null if not using voice)

    JoinGameSessionResponse:
      description: Response after successfully joining a game session with role and permissions
      type: object
      additionalProperties: false
      required:
      - sessionId
      - playerRole
      properties:
        sessionId:
          type: string
          format: uuid
          description: ID of the joined game session
        playerRole:
          type: string
          enum: [player, spectator, moderator]
          description: Role assigned to the player in this session
        gameData:
          type: object
          additionalProperties: true
          description: Initial game state data
        newPermissions:
          type: array
          items:
            type: string
          description: Additional permissions granted by joining
        voice:
          $ref: '#/components/schemas/VoiceConnectionInfo'
          description: Voice connection info (if voice is enabled for this session)

    GamePlayer:
      description: Information about a player currently participating in a game session
      type: object
      additionalProperties: false
      required:
      - accountId
      - sessionId
      - joinedAt
      - role
      properties:
        accountId:
          type: string
          format: uuid
          description: Unique identifier for the player's account
        sessionId:
          type: string
          format: uuid
          description: WebSocket session ID that joined the game. Chat and events are delivered to this specific session
            only.
        displayName:
          type: string
          # NRT: Optional string MUST be nullable (Rule 2)
          nullable: true
          description: Display name shown to other players
        role:
          type: string
          enum: [player, spectator, moderator]
          description: Role of the player in the game session
        joinedAt:
          type: string
          format: date-time
          description: Timestamp when the player joined the session
        characterData:
          type: object
          additionalProperties: true
          nullable: true
          description: Game-specific character data for this player (null if none provided)
        voiceSessionId:
          type: string
          format: uuid
          nullable: true
          description: Voice participant session ID (if player has joined voice)

    KickPlayerRequest:
      description: Request to remove a player from a game session (admin only)
      type: object
      additionalProperties: false
      required:
      - sessionId
      - targetAccountId
      properties:
        sessionId:
          type: string
          format: uuid
          description: ID of the game session
        targetAccountId:
          type: string
          format: uuid
          description: Account ID of the player to kick
        reason:
          type: string
          maxLength: 200
          # NRT: Optional string MUST be nullable (Rule 2)
          nullable: true
          description: Reason for kicking the player

    ChatMessageRequest:
      description: Request to send a chat message to players in a game session
      type: object
      additionalProperties: false
      required:
      - sessionId
      - accountId
      - gameType
      - message
      properties:
        sessionId:
          type: string
          format: uuid
          description: WebSocket session ID of the sender. Provided by shortcut system.
        accountId:
          type: string
          format: uuid
          description: Account ID of the sender. Provided by shortcut system.
        gameType:
          type: string
          description: Game type for the chat. Determines which lobby's players receive the message. Provided by 
            shortcut system.
        message:
          type: string
          maxLength: 500
          description: Content of the chat message
        messageType:
          type: string
          enum: [public, whisper, system]
          default: public
          description: Type of message (public to all, whisper to one player, or system announcement)
        targetPlayerId:
          type: string
          format: uuid
          # NRT: Optional string MUST be nullable (Rule 2)
          nullable: true
          description: For whisper messages

    GameActionRequest:
      description: Request to perform a game action such as movement or combat
      type: object
      additionalProperties: false
      required:
      - sessionId
      - accountId
      - gameType
      - actionType
      properties:
        sessionId:
          type: string
          format: uuid
          description: WebSocket session ID of the client. Provided by shortcut system.
        accountId:
          type: string
          format: uuid
          description: Account ID of the player. Provided by shortcut system.
        gameType:
          type: string
          description: Game type for the action. Determines which lobby to apply the action. Provided by shortcut 
            system.
        actionType:
          type: string
          enum: [move, interact, attack, cast_spell, use_item]
          description: Type of game action to perform
        actionData:
          type: object
          additionalProperties: true
          # NRT: Optional object MUST be nullable (Rule 2)
          nullable: true
          description: Action-specific data
        targetId:
          type: string
          format: uuid
          # NRT: Optional string MUST be nullable (Rule 2)
          nullable: true
          description: Target of the action (if applicable)

    GameActionResponse:
      description: Response indicating the result of a game action with any state changes
      type: object
      additionalProperties: false
      required:
      - actionId
      properties:
        actionId:
          type: string
          format: uuid
          description: Unique identifier for this action instance
        result:
          type: object
          additionalProperties: true
          # NRT: Optional object MUST be nullable (Rule 2)
          nullable: true
          description: Action result data
        newGameState:
          type: object
          additionalProperties: true
          # NRT: Optional object MUST be nullable (Rule 2)
          nullable: true
          description: Updated game state (if applicable)

    # ============================================
    # Voice Integration Types
    # ============================================

    VoiceSipEndpoint:
      type: object
      description: Client's SIP/WebRTC endpoint for voice communication
      additionalProperties: false
      required:
      - sdpOffer
      properties:
        sdpOffer:
          type: string
          description: SDP offer for WebRTC negotiation
        iceCandidates:
          type: array
          items:
            type: string
          # NRT: Optional array MUST be nullable (Rule 2)
          nullable: true
          description: ICE candidates for NAT traversal

    VoiceConnectionInfo:
      type: object
      description: |
        Minimal voice metadata returned when joining a session.

        **Event-Only Pattern**: Peer connection details are NOT included here.
        Clients receive VoicePeerJoinedEvent when other peers join (with their SDP offers).
        This avoids race conditions between response processing and event handling.
      additionalProperties: false
      required:
      - voiceEnabled
      properties:
        voiceEnabled:
          type: boolean
          description: Whether voice is enabled for this game session
        roomId:
          type: string
          format: uuid
          nullable: true
          description: Voice room ID (null until room is created when 2+ participants join with voice)
        tier:
          type: string
          enum: [p2p, scaled]
          nullable: true
          description: Expected voice tier (may change based on participant count)
        codec:
          type: string
          enum: [opus, g711, g722]
          # NRT: Optional enum MUST be nullable (Rule 2)
          nullable: true
          description: Audio codec to use
        stunServers:
          type: array
          items:
            type: string
          # NRT: Optional array MUST be nullable (Rule 2)
          nullable: true
          description: STUN server URIs for NAT traversal (clients should configure these early)

    # ============================================
    # Session Type & Reservation Types (for matchmaking support)
    # ============================================

    SessionType:
      type: string
      description: Type of game session - determines join behavior
      enum: [lobby, matchmade]

    # NOTE: PlayerReservation removed - reservations use ReservationInfo for matchmaking integration

    ReservationInfo:
      type: object
      description: Reservation token returned when creating a matchmade session
      additionalProperties: false
      required:
      - accountId
      - token
      - expiresAt
      properties:
        accountId:
          type: string
          format: uuid
          description: Account ID this reservation is for
        token:
          type: string
          description: Token to claim this reservation
        expiresAt:
          type: string
          format: date-time
          description: When this reservation expires

    # ============================================
    # Session-Specific Join Types (for matchmaking)
    # ============================================

    JoinGameSessionByIdRequest:
      type: object
      description: Request to join a specific game session by ID (for matchmade sessions)
      additionalProperties: false
      required:
      - webSocketSessionId
      - accountId
      - gameSessionId
      properties:
        webSocketSessionId:
          type: string
          format: uuid
          description: WebSocket session ID of the client joining. Used for event delivery.
        accountId:
          type: string
          format: uuid
          description: Account ID of the player joining.
        gameSessionId:
          type: string
          format: uuid
          description: ID of the game session to join.
        reservationToken:
          type: string
          nullable: true
          description: Token proving reservation (required for matchmade sessions)
        characterData:
          type: object
          additionalProperties: true
          nullable: true
          description: Game-specific character data (null if no character data)
        voiceEndpoint:
          $ref: '#/components/schemas/VoiceSipEndpoint'
          nullable: true
          description: Client's SIP endpoint for voice communication (null if not using voice)

    # ============================================
    # Shortcut Publishing Types (for matchmaking integration)
    # ============================================

    PublishJoinShortcutRequest:
      type: object
      description: Request to publish a join shortcut for a matchmade session to a player
      additionalProperties: false
      required:
      - targetWebSocketSessionId
      - accountId
      - gameSessionId
      - reservationToken
      properties:
        targetWebSocketSessionId:
          type: string
          format: uuid
          description: WebSocket session ID to receive the shortcut
        accountId:
          type: string
          format: uuid
          description: Account ID of the player
        gameSessionId:
          type: string
          format: uuid
          description: ID of the game session to join
        reservationToken:
          type: string
          description: Token for this player's reservation

    PublishJoinShortcutResponse:
      type: object
      description: Response after publishing a join shortcut
      additionalProperties: false
      required:
      - success
      properties:
        success:
          type: boolean
          description: Whether the shortcut was published successfully
        shortcutRouteGuid:
          type: string
          format: uuid
          nullable: true
          description: The route GUID for the published shortcut (null if failed)

    # ============================================
    # Leave Session By ID Types
    # ============================================

    LeaveGameSessionByIdRequest:
      type: object
      description: Request to leave a specific game session by ID
      additionalProperties: false
      required:
      - webSocketSessionId
      - accountId
      - gameSessionId
      properties:
        webSocketSessionId:
          type: string
          format: uuid
          description: WebSocket session ID of the client leaving.
        accountId:
          type: string
          format: uuid
          description: Account ID of the player leaving.
        gameSessionId:
          type: string
          format: uuid
          description: ID of the game session to leave.

# Service Registration Information (used by permission system)
x-service-registration:
  serviceId: "game-session"
  serviceName: "Game Session Service"
  version: "3.0.0"
  categories:
  - gaming
  - social
  # Session states this service can set on clients:
  # - game-session: in_game (set when joining a session, cleared when leaving)
