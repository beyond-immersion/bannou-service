openapi: 3.0.0
info:
  title: Bannou Game Session Service API
  description: |
    Minimal game session management for Arcadia and other games.

    **POST-Only API Pattern**: This API uses POST for all operations to support zero-copy
    WebSocket routing. Path parameters are passed in request bodies instead of URLs.
    See API-DESIGN.md for architectural rationale.
  version: 2.0.0
servers:
  - url: http://localhost:3500/v1.0/invoke/bannou/method
    description: Dapr sidecar endpoint (internal only)

paths:
  /sessions/list:
    post:
      summary: List available game sessions
      operationId: listGameSessions
      tags:
        - Game Sessions
      x-permissions:
        - type: role
          value: user
      x-rate-limit:
        requestsPerMinute: 30
        requestsPerHour: 500
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ListGameSessionsRequest'
      responses:
        '200':
          description: Game sessions retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GameSessionListResponse'

  /sessions/create:
    post:
      summary: Create new game session
      operationId: createGameSession
      tags:
        - Game Sessions
      x-permissions:
        - type: role
          value: user
        - type: session_state
          value: authenticated
      x-rate-limit:
        requestsPerMinute: 5
        requestsPerHour: 20
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateGameSessionRequest'
      responses:
        '201':
          description: Game session created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GameSessionResponse'

  /sessions/get:
    post:
      summary: Get game session details
      operationId: getGameSession
      tags:
        - Game Sessions
      x-permissions:
        - type: role
          value: user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetGameSessionRequest'
      responses:
        '200':
          description: Game session retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GameSessionResponse'
        '404':
          description: Game session not found

  /sessions/join:
    post:
      summary: Join a game session
      operationId: joinGameSession
      tags:
        - Game Sessions
      x-permissions:
        - type: role
          value: user
        - type: session_state
          value: authenticated
      x-rate-limit:
        requestsPerMinute: 10
        requestsPerHour: 50
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JoinGameSessionRequest'
      responses:
        '200':
          description: Successfully joined game session
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JoinGameSessionResponse'
        '404':
          description: Game session not found
        '409':
          description: Session full or already joined

  /sessions/leave:
    post:
      summary: Leave a game session
      operationId: leaveGameSession
      tags:
        - Game Sessions
      x-permissions:
        - type: context
          contextKey: gameSessionId
          value: "{sessionId}"
          operator: equals
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LeaveGameSessionRequest'
      responses:
        '200':
          description: Successfully left game session
        '404':
          description: Game session not found

  /sessions/kick:
    post:
      summary: Kick player from game session (admin only)
      operationId: kickPlayer
      tags:
        - Game Sessions
      x-permissions:
        - type: role
          value: admin
        - type: context
          contextKey: gameSessionOwner
          value: "{accountId}"
          operator: equals
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/KickPlayerRequest'
      responses:
        '200':
          description: Player kicked successfully
        '404':
          description: Game session or player not found
        '403':
          description: Not authorized to kick players

  /sessions/chat:
    post:
      summary: Send chat message to game session
      operationId: sendChatMessage
      tags:
        - Game Chat
      x-permissions:
        - type: context
          contextKey: gameSessionId
          value: "{sessionId}"
          operator: equals
      x-rate-limit:
        requestsPerMinute: 60
        burstLimit: 10
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatMessageRequest'
      responses:
        '200':
          description: Chat message sent successfully
        '404':
          description: Game session not found

  /sessions/actions:
    post:
      summary: Perform game action (enhanced permissions after joining)
      operationId: performGameAction
      tags:
        - Game Actions
      x-permissions:
        - type: context
          contextKey: gameSessionId
          value: "{sessionId}"
          operator: equals
        - type: context
          contextKey: gameSessionRole
          value: player
          operator: equals
      x-rate-limit:
        requestsPerMinute: 120
        burstLimit: 20
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GameActionRequest'
      responses:
        '200':
          description: Game action performed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GameActionResponse'
        '404':
          description: Game session not found
        '400':
          description: Invalid game action

components:
  schemas:
    # Request Models for POST-only pattern
    ListGameSessionsRequest:
      type: object
      description: Request to list available game sessions
      properties:
        gameType:
          type: string
          enum: [arcadia, generic]
          description: Filter by game type
        status:
          type: string
          enum: [waiting, active, full]
          description: Filter by session status

    GetGameSessionRequest:
      type: object
      description: Request to get a specific game session
      required:
        - sessionId
      properties:
        sessionId:
          type: string
          format: uuid
          description: ID of the game session to retrieve

    LeaveGameSessionRequest:
      type: object
      description: Request to leave a game session
      required:
        - sessionId
      properties:
        sessionId:
          type: string
          format: uuid
          description: ID of the game session to leave

    CreateGameSessionRequest:
      type: object
      required:
        - gameType
        - maxPlayers
      properties:
        gameType:
          type: string
          enum: [arcadia, generic]
        maxPlayers:
          type: integer
          minimum: 1
          maximum: 100
        sessionName:
          type: string
          maxLength: 100
        isPrivate:
          type: boolean
          default: false
        gameSettings:
          type: object
          additionalProperties: true

    GameSessionResponse:
      type: object
      required:
        - sessionId
        - gameType
        - status
        - createdAt
      properties:
        sessionId:
          type: string
        gameType:
          type: string
          enum: [arcadia, generic]
        sessionName:
          type: string
        status:
          type: string
          enum: [waiting, active, full, finished]
        maxPlayers:
          type: integer
        currentPlayers:
          type: integer
        isPrivate:
          type: boolean
        owner:
          type: string
          format: uuid
        players:
          type: array
          items:
            $ref: '#/components/schemas/GamePlayer'
        createdAt:
          type: string
          format: date-time
        gameSettings:
          type: object
          additionalProperties: true

    GameSessionListResponse:
      type: object
      required:
        - sessions
      properties:
        sessions:
          type: array
          items:
            $ref: '#/components/schemas/GameSessionResponse'
        totalCount:
          type: integer

    JoinGameSessionRequest:
      type: object
      required:
        - sessionId
      properties:
        sessionId:
          type: string
          format: uuid
          description: ID of the game session to join
        password:
          type: string
          description: Password for private sessions
        characterData:
          type: object
          additionalProperties: true
          description: Game-specific character data
        voiceEndpoint:
          $ref: '#/components/schemas/VoiceSipEndpoint'
          description: Client's SIP endpoint for voice communication (optional)

    JoinGameSessionResponse:
      type: object
      required:
        - success
        - sessionId
        - playerRole
      properties:
        success:
          type: boolean
        sessionId:
          type: string
        playerRole:
          type: string
          enum: [player, spectator, moderator]
        gameData:
          type: object
          additionalProperties: true
          description: Initial game state data
        newPermissions:
          type: array
          items:
            type: string
          description: Additional permissions granted by joining
        voice:
          $ref: '#/components/schemas/VoiceConnectionInfo'
          description: Voice connection info (if voice is enabled for this session)

    GamePlayer:
      type: object
      required:
        - accountId
        - joinedAt
        - role
      properties:
        accountId:
          type: string
          format: uuid
        displayName:
          type: string
        role:
          type: string
          enum: [player, spectator, moderator]
        joinedAt:
          type: string
          format: date-time
        characterData:
          type: object
          additionalProperties: true

    KickPlayerRequest:
      type: object
      required:
        - sessionId
        - targetAccountId
      properties:
        sessionId:
          type: string
          format: uuid
          description: ID of the game session
        targetAccountId:
          type: string
          format: uuid
          description: Account ID of the player to kick
        reason:
          type: string
          maxLength: 200
          description: Reason for kicking the player

    ChatMessageRequest:
      type: object
      required:
        - sessionId
        - message
      properties:
        sessionId:
          type: string
          format: uuid
          description: ID of the game session
        message:
          type: string
          maxLength: 500
        messageType:
          type: string
          enum: [public, whisper, system]
          default: public
        targetPlayerId:
          type: string
          format: uuid
          description: For whisper messages

    GameActionRequest:
      type: object
      required:
        - sessionId
        - actionType
      properties:
        sessionId:
          type: string
          format: uuid
          description: ID of the game session
        actionType:
          type: string
          enum: [move, interact, attack, cast_spell, use_item]
        actionData:
          type: object
          additionalProperties: true
          description: Action-specific data
        targetId:
          type: string
          format: uuid
          description: Target of the action (if applicable)

    GameActionResponse:
      type: object
      required:
        - success
        - actionId
      properties:
        success:
          type: boolean
        actionId:
          type: string
          format: uuid
        result:
          type: object
          additionalProperties: true
          description: Action result data
        newGameState:
          type: object
          additionalProperties: true
          description: Updated game state (if applicable)

    # ============================================
    # Voice Integration Types
    # ============================================

    VoiceSipEndpoint:
      type: object
      description: Client's SIP/WebRTC endpoint for voice communication
      required:
        - sdpOffer
      properties:
        sdpOffer:
          type: string
          description: SDP offer for WebRTC negotiation
        iceCandidates:
          type: array
          items:
            type: string
          description: ICE candidates for NAT traversal

    VoiceConnectionInfo:
      type: object
      description: Voice connection information returned when joining a session
      required:
        - roomId
        - tier
      properties:
        roomId:
          type: string
          format: uuid
          description: Voice room ID
        tier:
          type: string
          enum: [p2p, scaled]
          description: Voice tier (p2p for direct connections, scaled for RTP server)
        codec:
          type: string
          enum: [opus, g711, g722]
          description: Audio codec to use
        peers:
          type: array
          items:
            $ref: '#/components/schemas/VoicePeerInfo'
          description: List of peers to connect to (P2P mode only)
        rtpServerUri:
          type: string
          nullable: true
          description: RTP server URI (scaled mode only)
        stunServers:
          type: array
          items:
            type: string
          description: STUN server URIs for NAT traversal

    VoicePeerInfo:
      type: object
      description: Peer connection info for P2P voice
      required:
        - accountId
        - sdpOffer
      properties:
        accountId:
          type: string
          format: uuid
          description: Peer's account ID
        displayName:
          type: string
          nullable: true
          description: Peer's display name
        sdpOffer:
          type: string
          description: SDP offer for WebRTC negotiation
        iceCandidates:
          type: array
          items:
            type: string
          nullable: true
          description: ICE candidates for NAT traversal

# Service Registration Information (used by permission system)
x-service-registration:
  serviceId: "game-session-service-guid"
  serviceName: "Game Session Service"
  version: "2.0.0"
  categories:
    - gaming
    - social
  basePermissions:
    - user  # All endpoints require at least 'user' role
  contextualPermissions:
    gameSessionId: "Current game session ID"
    gameSessionRole: "Role within the game session (player, spectator, moderator)"
    gameSessionOwner: "Account ID of session owner"
