openapi: 3.0.0
info:
  title: Bannou Permission System API
  description: |
    Redis-backed high-performance permission system for WebSocket services.

    **POST-Only API Pattern**: This API uses POST for all operations to support zero-copy
    WebSocket routing. Path parameters are passed in request bodies instead of URLs.
    See docs/BANNOU_DESIGN.md for architectural rationale.

    **NRT Compliance**: AI agents MUST review docs/NRT-SCHEMA-RULES.md before modifying this schema. Optional reference types require `nullable: true`.
  version: 3.0.0
  # NOTE: Event subscriptions moved to permission-events.yaml (x-event-subscriptions)
servers:
- url: http://localhost:5012
  description: Bannou service endpoint (internal only)

paths:
  /permission/capabilities:
    post:
      summary: Get available API methods for session
      description: Returns compiled list of methods available to this session
      operationId: getCapabilities
      tags:
      - Permission Lookup
      x-permissions: []  # Internal only - not exposed to WebSocket clients
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CapabilityRequest'
      responses:
        '200':
          description: Session capabilities retrieved from Redis
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CapabilityResponse'

  /permission/validate:
    post:
      summary: Validate specific API access for session
      description: Fast O(1) validation using Redis lookup
      operationId: validateApiAccess
      tags:
      - Permission Validation
      x-permissions: []  # Internal only - not exposed to WebSocket clients
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ValidationRequest'
      responses:
        '200':
          description: Permission validation result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationResponse'

  /permission/register-service:
    post:
      summary: Register or update service permission matrix
      description: Updates Redis with ServiceID -> State -> Role -> Methods structure
      operationId: registerServicePermissions
      tags:
      - Service Management
      x-permissions: []  # Internal only - not exposed to WebSocket clients
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ServicePermissionMatrix'
      responses:
        '200':
          description: Service permissions registered and sessions recompiled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RegistrationResponse'

  /permission/update-session-state:
    post:
      summary: Update session state for specific service
      description: Updates SessionID -> ServiceID -> State and recompiles permissions
      operationId: updateSessionState
      tags:
      - Session Management
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SessionStateUpdate'
      responses:
        '200':
          description: Session state updated and permissions recompiled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionUpdateResponse'

  /permission/update-session-role:
    post:
      summary: Update session role (affects all services)
      description: Updates SessionID -> Role and recompiles all service permissions
      operationId: updateSessionRole
      tags:
      - Session Management
      x-permissions: []  # Internal only - not exposed to WebSocket clients
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SessionRoleUpdate'
      responses:
        '200':
          description: Session role updated and all permissions recompiled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionUpdateResponse'

  /permission/clear-session-state:
    post:
      summary: Clear session state for specific service
      description: |
        Removes state for a specific service from the session and recompiles permissions.
        If states list is provided, only clears if current state matches one of the values.
        If states list is empty or not provided, clears the state unconditionally.
      operationId: clearSessionState
      tags:
      - Session Management
      x-permissions: []  # Internal only - not exposed to WebSocket clients
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ClearSessionStateRequest'
      responses:
        '200':
          description: Session state cleared and permissions recompiled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionUpdateResponse'

  /permission/get-session-info:
    post:
      summary: Get complete session information
      description: Returns current states, role, and compiled permissions
      operationId: getSessionInfo
      tags:
      - Session Management
      x-permissions: []  # Internal only - not exposed to WebSocket clients
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SessionInfoRequest'
      responses:
        '200':
          description: Complete session information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionInfo'

  /permission/services/list:
    post:
      summary: List all registered services
      description: |
        Returns list of all services that have registered their permissions.
        This endpoint is used by testers to wait for service readiness - a service
        appearing in this list means it has completed startup and registered its
        API permissions, indicating it's ready to handle requests.

        For service-to-service calls (via mesh), this endpoint is unrestricted.
        For client calls through WebSocket/Connect, only admin users can access it.
      operationId: getRegisteredServices
      tags:
      - Service Management
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ListServicesRequest'
      responses:
        '200':
          description: List of registered services
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RegisteredServicesResponse'

components:
  schemas:
    # Request Models for POST-only pattern
    ListServicesRequest:
      type: object
      additionalProperties: false
      description: Request to list registered services (empty body allowed for listing all)
      properties:
        serviceIdFilter:
          type: string
          description: Optional filter by service ID prefix
          nullable: true

    # Core API Request/Response Models
    CapabilityRequest:
      description: Request to retrieve available API methods for a session
      type: object
      additionalProperties: false
      required:
      - sessionId
      properties:
        sessionId:
          type: string
          format: uuid
          description: Session ID for lookup in Redis
        serviceIds:
          type: array
          items:
            type: string
          nullable: true
          description: Optional filter for specific services (null for all services)

    CapabilityResponse:
      description: Response containing the compiled permissions for a session
      type: object
      additionalProperties: false
      required:
      - sessionId
      - permissions
      properties:
        sessionId:
          type: string
          format: uuid
          description: Session ID that was queried
        permissions:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          description: Map of ServiceID -> List of available methods
        generatedAt:
          type: string
          format: date-time
          description: When these permissions were compiled

    ValidationRequest:
      description: Request to validate whether a session has access to a specific API method
      type: object
      additionalProperties: false
      required:
      - sessionId
      - serviceId
      - method
      properties:
        sessionId:
          type: string
          format: uuid
          description: Session ID to validate access for
        serviceId:
          type: string
          description: Target service ID
        method:
          type: string
          description: Method name being accessed

    ValidationResponse:
      description: Response indicating whether access to a specific API method is permitted
      type: object
      additionalProperties: false
      required:
      - allowed
      - sessionId
      properties:
        allowed:
          type: boolean
          description: Whether access is permitted
        sessionId:
          type: string
          format: uuid
          description: Session ID that was validated
        reason:
          type: string
          description: Reason for denial (if applicable)

    # Service Management Models
    ServicePermissionMatrix:
      description: Complete permission matrix for a service defining state-role-method access rules
      type: object
      additionalProperties: false
      required:
      - serviceId
      - permissions
      properties:
        serviceId:
          type: string
          description: Unique service identifier
        serviceName:
          type: string
          nullable: true
          description: Human-readable service name (null to use serviceId)
        permissions:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/StatePermissions'
          description: Map of State -> Role -> Methods structure
        version:
          type: string
          description: Service API version for change tracking

    StatePermissions:
      type: object
      additionalProperties:
        type: array
        items:
          type: string
      description: Map of Role -> List of Methods for this state
      example:
        user: ["ListGameSessions", "GetGameSession"]
        admin: ["ListGameSessions", "GetGameSession", "CreateGameSession"]

    RegistrationResponse:
      description: Response from registering or updating a service permission matrix
      type: object
      additionalProperties: false
      required:
      - serviceId
      - affectedSessions
      properties:
        serviceId:
          type: string
          description: Service ID that was registered
        message:
          type: string
          description: Success or error message
        registered:
          type: boolean
          description: Whether registration was successful
        affectedSessions:
          type: integer
          description: Number of sessions that had permissions recompiled
        recompiledAt:
          type: string
          format: date-time
          description: Timestamp when permissions were recompiled

    # Session Management Models
    SessionStateUpdate:
      description: Request to update a session's state for a specific service
      type: object
      additionalProperties: false
      required:
      - sessionId
      - serviceId
      - newState
      properties:
        sessionId:
          type: string
          format: uuid
          description: Session ID to update state for
        serviceId:
          type: string
          description: Service whose state is changing for this session
        newState:
          type: string
          description: New state value (lobby, in_game, etc.)
        previousState:
          type: string
          description: Previous state value (null for initial state)
          nullable: true
        metadata:
          type: object
          additionalProperties: true
          nullable: true
          description: Optional context data (null if none)

    SessionRoleUpdate:
      description: Request to update a session's role affecting permissions across all services
      type: object
      additionalProperties: false
      required:
      - sessionId
      - newRole
      properties:
        sessionId:
          type: string
          format: uuid
          description: Session ID to update role for
        newRole:
          type: string
          description: New role (user, admin, etc.)
        previousRole:
          type: string
          description: Previous role (null for initial role)
          nullable: true

    ClearSessionStateRequest:
      description: Request to clear a session's state for a specific service or all services
      type: object
      additionalProperties: false
      required:
      - sessionId
      properties:
        sessionId:
          type: string
          format: uuid
          description: Session ID to clear state from
        serviceId:
          type: string
          nullable: true
          description: Service whose state should be cleared (null to clear all services)
        states:
          type: array
          items:
            type: string
          description: |
            Optional list of state values to match. If provided, only clears if
            current state matches one of these values. If empty or not provided,
            clears the state unconditionally.
          nullable: true

    SessionUpdateResponse:
      description: Response from updating a session's state or role with recompiled permissions
      type: object
      additionalProperties: false
      required:
      - sessionId
      - permissionsChanged
      properties:
        sessionId:
          type: string
          format: uuid
          description: Session ID that was updated
        message:
          type: string
          description: Success or error message
        permissionsChanged:
          type: boolean
          description: Whether compiled permissions actually changed
        newPermissions:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          description: Updated ServiceID -> Methods if permissions changed
        updatedAt:
          type: string
          format: date-time
          description: Timestamp when the session was updated

    # Session Information Models
    SessionInfoRequest:
      description: Request to retrieve complete information about a session
      type: object
      additionalProperties: false
      required:
      - sessionId
      properties:
        sessionId:
          type: string
          format: uuid
          description: Session ID to retrieve information for

    SessionInfo:
      description: Complete session information including role, states, and compiled permissions
      type: object
      additionalProperties: false
      required:
      - sessionId
      - role
      - states
      - permissions
      properties:
        sessionId:
          type: string
          format: uuid
          description: Session ID being queried
        role:
          type: string
          description: Current session role
        states:
          type: object
          additionalProperties:
            type: string
          description: Map of ServiceID -> Current State
        permissions:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          description: Map of ServiceID -> List of available methods
        compiledPermissions:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          description: Map of ServiceID -> List of available methods
        version:
          type: integer
          description: Permission version number
        lastUpdated:
          type: string
          format: date-time
          description: When permissions were last recompiled

    # Service Readiness Models
    RegisteredServicesResponse:
      description: Response containing list of all services that have registered their permissions
      type: object
      additionalProperties: false
      required:
      - services
      - timestamp
      properties:
        services:
          type: array
          items:
            $ref: '#/components/schemas/RegisteredServiceInfo'
          description: List of all registered services
        timestamp:
          type: string
          format: date-time
          description: When this response was generated

    RegisteredServiceInfo:
      description: Information about a registered service including its ID, version, and endpoint count
      type: object
      additionalProperties: false
      required:
      - serviceId
      - registeredAt
      - endpointCount
      properties:
        serviceId:
          type: string
          description: Unique service identifier
        serviceName:
          type: string
          description: Human-readable service name
        version:
          type: string
          description: Service API version
        registeredAt:
          type: string
          format: date-time
          description: When the service registered its permissions
        endpointCount:
          type: integer
          description: Number of API endpoints registered by this service

# NOTE: Event subscriptions are defined in permission-events.yaml
# They are processed by generate-event-subscriptions.sh to generate PermissionsEventsController.cs
