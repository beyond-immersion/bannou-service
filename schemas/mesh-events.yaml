openapi: 3.0.3
info:
  title: Mesh Service Events
  description: |
    Event models for Mesh service RabbitMQ pub/sub.
    Mesh publishes endpoint lifecycle events and subscribes to heartbeats.

    **SCHEMA MODIFICATION GATE**: STOP. Before modifying this schema, you MUST:
    1. Read docs/reference/SCHEMA-RULES.md
    2. State which section applies to your change
    3. Only then proceed with edits
    Edits without stating the applicable rule are FORBIDDEN.
  version: 1.0.0
  x-event-subscriptions:
    - topic: bannou.service-heartbeats
      event: ServiceHeartbeatEvent
      handler: HandleServiceHeartbeat
    - topic: bannou.full-service-mappings
      event: FullServiceMappingsEvent
      handler: HandleServiceMappings
    - topic: mesh.circuit.changed
      event: MeshCircuitStateChangedEvent
      handler: HandleCircuitStateChanged
  x-event-publications:
    - topic: mesh.endpoint.registered
      event: MeshEndpointRegisteredEvent
      description: Published when a new endpoint is registered in the mesh
    - topic: mesh.endpoint.deregistered
      event: MeshEndpointDeregisteredEvent
      description: Published when an endpoint is removed from the mesh
    - topic: mesh.circuit.changed
      event: MeshCircuitStateChangedEvent
      description: Published when circuit breaker state changes for an app-id

paths: {}

components:
  schemas:
    # =========================================================================
    # Mesh-Published Events
    # =========================================================================
    MeshEndpointRegisteredEvent:
      allOf:
        - $ref: 'common-events.yaml#/components/schemas/BaseServiceEvent'
      type: object
      additionalProperties: false
      description: |
        Published when a new endpoint is registered in the service mesh.
        Consumers can use this to update local routing caches.
      required:
        - instanceId
        - appId
        - host
        - port
      properties:
        instanceId:
          type: string
          format: uuid
          description: Instance ID of the registered endpoint
        appId:
          type: string
          description: App-id of the registered endpoint
        host:
          type: string
          description: Host address of the endpoint
        port:
          type: integer
          description: Port of the endpoint
        services:
          type: array
          nullable: true  # NRT: Optional property MUST be nullable
          items:
            type: string
          description: Services available on this endpoint

    MeshEndpointDeregisteredEvent:
      allOf:
        - $ref: 'common-events.yaml#/components/schemas/BaseServiceEvent'
      type: object
      additionalProperties: false
      description: |
        Published when an endpoint is removed from the service mesh.
        Either via explicit deregistration or TTL expiration.
      required:
        - instanceId
        - appId
        - reason
      properties:
        instanceId:
          type: string
          format: uuid
          description: Instance ID that was deregistered
        appId:
          type: string
          description: App-id that was deregistered
        reason:
          type: string
          enum:
            - Graceful
            - TtlExpired
            - HealthCheckFailed
            - CircuitBreakerTripped
          description: Why the endpoint was removed

    # =========================================================================
    # Circuit Breaker Events
    # =========================================================================
    CircuitState:
      type: string
      enum:
        - Closed
        - Open
        - HalfOpen
      description: Circuit breaker state for mesh endpoints

    MeshCircuitStateChangedEvent:
      allOf:
        - $ref: 'common-events.yaml#/components/schemas/BaseServiceEvent'
      type: object
      additionalProperties: false
      description: |
        Published when circuit breaker state changes for an app-id.
        Consumed by all mesh instances to update local caches.
      required:
        - appId
        - newState
        - consecutiveFailures
        - changedAt
      properties:
        appId:
          type: string
          description: The app-id whose circuit state changed
        newState:
          $ref: '#/components/schemas/CircuitState'
          description: The new circuit breaker state
        previousState:
          $ref: '#/components/schemas/CircuitState'
          nullable: true
          description: Previous circuit state (null for first state change)
        consecutiveFailures:
          type: integer
          minimum: 0
          description: Current consecutive failure count
        changedAt:
          type: string
          format: date-time
          description: When the state change occurred
        openedAt:
          type: string
          format: date-time
          nullable: true
          description: When the circuit was opened (null if not Open state)
