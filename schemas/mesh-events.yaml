openapi: 3.0.3
info:
  title: Mesh Service Events
  description: |
    Event models for Mesh service RabbitMQ pub/sub.
    Mesh publishes endpoint lifecycle events and subscribes to heartbeats.

    **NRT Compliance**: AI agents MUST review docs/NRT-SCHEMA-RULES.md before
    modifying this schema. Optional reference types require `nullable: true`.
  version: 1.0.0
  x-event-subscriptions:
    - topic: bannou-service-heartbeats
      event: ServiceHeartbeatEvent
      handler: HandleServiceHeartbeat
    - topic: bannou-full-service-mappings
      event: FullServiceMappingsEvent
      handler: HandleServiceMappings
  x-event-publications:
    - topic: mesh.endpoint.registered
      event: MeshEndpointRegisteredEvent
      description: Published when a new endpoint is registered in the mesh
    - topic: mesh.endpoint.deregistered
      event: MeshEndpointDeregisteredEvent
      description: Published when an endpoint is removed from the mesh

paths: {}

components:
  schemas:
    # Base event schema for $ref resolution
    BaseServiceEvent:
      type: object
      additionalProperties: false
      required:
        - eventId
        - timestamp
      properties:
        eventId:
          type: string
          description: Unique identifier for this event instance
        timestamp:
          type: string
          format: date-time
          description: When the event was created (UTC)

    # =========================================================================
    # Mesh-Published Events
    # =========================================================================
    MeshEndpointRegisteredEvent:
      allOf:
        - $ref: '#/components/schemas/BaseServiceEvent'
      type: object
      additionalProperties: false
      description: |
        Published when a new endpoint is registered in the service mesh.
        Consumers can use this to update local routing caches.
      required:
        - instanceId
        - appId
        - host
        - port
      properties:
        instanceId:
          type: string
          format: uuid
          description: Instance ID of the registered endpoint
        appId:
          type: string
          description: App-id of the registered endpoint
        host:
          type: string
          description: Host address of the endpoint
        port:
          type: integer
          description: Port of the endpoint
        services:
          type: array
          nullable: true  # NRT: Optional property MUST be nullable
          items:
            type: string
          description: Services available on this endpoint

    MeshEndpointDeregisteredEvent:
      allOf:
        - $ref: '#/components/schemas/BaseServiceEvent'
      type: object
      additionalProperties: false
      description: |
        Published when an endpoint is removed from the service mesh.
        Either via explicit deregistration or TTL expiration.
      required:
        - instanceId
        - appId
        - reason
      properties:
        instanceId:
          type: string
          format: uuid
          description: Instance ID that was deregistered
        appId:
          type: string
          description: App-id that was deregistered
        reason:
          type: string
          enum:
            - Graceful
            - TtlExpired
            - HealthCheckFailed
            - CircuitBreakerTripped
          description: Why the endpoint was removed
