openapi: 3.0.0
info:
  title: Bannou Obligation Service API
  description: |
    Contract-aware obligation tracking for NPC cognition (L4 GameFeatures).

    Provides dynamically-updated action cost modifiers based on active contracts
    (guild charters, trade agreements, quest oaths). The obligation service is the
    bridge between the Contract service's behavioral clauses and the GOAP planner's
    action cost system, enabling NPCs to have "second thoughts" before violating
    their obligations.

    **Two-Layer Design**: Works standalone with raw contract penalties. When a
    personality-weighted moral reasoning provider is registered (soft L4 dependency
    via character-personality), obligation costs are enriched with trait-weighted,
    location/circumstance-dependent moral reasoning. Without personality enrichment,
    costs are the unweighted base penalties from contract behavioral clauses.

    **Personality Variables Consumed for Moral Weighting** (when personality provider available):
    - ${personality.honesty} — Scales theft/deception violation costs (higher honesty = higher cost)
    - ${personality.loyalty} — Scales betrayal/oath-breaking costs (higher loyalty = higher cost)
    - ${personality.agreeableness} — Scales social violation costs (higher agreeableness = higher cost)
    - ${personality.conscientiousness} — General obligation weight multiplier
    - ${combat.preferred_engagement} — Affects violence-related violation costs

    **Violation Types**: Types are opaque strings auto-recognized from contract behavioral
    clause definitions. No separate taxonomy is maintained — the vocabulary is defined by
    contract templates (e.g., "theft", "deception", "violence", "honor_combat"). Action tag
    mappings bridge GOAP action vocabulary to these contract-defined violation types.

    **Core Flow**:
    1. Contract activated → obligation service extracts behavioral clauses → caches per-party
    2. Actor cognition evaluates actions → reads ${obligations.*} variables from provider
    3. GOAP planner sees modified action costs → selects alternative if cost too high
    4. If actor proceeds despite cost → report-violation → breach + feedback events

    **Variable Provider**: Implements IVariableProviderFactory providing the
    ${obligations.*} namespace to Actor (L2) via the Variable Provider Factory pattern:
    - ${obligations.active_count} — Total active obligations
    - ${obligations.has_obligations} — Whether any obligations exist
    - ${obligations.contract_count} — Number of active contracts with behavioral clauses
    - ${obligations.violation_cost.<type>} — Total cost for a specific violation type
    - ${obligations.highest_penalty_type} — Violation type with highest total cost
    - ${obligations.highest_penalty_cost} — The highest single penalty cost
    - ${obligations.total_obligation_cost} — Sum of all max violation costs

    **POST-Only API Pattern**: This API uses POST for all operations to support zero-copy
    WebSocket routing. Path parameters are passed in request bodies instead of URLs.
    See docs/BANNOU_DESIGN.md for architectural rationale.

    **SCHEMA MODIFICATION GATE**: STOP. Before modifying this schema, you MUST:
    1. Read docs/reference/SCHEMA-RULES.md
    2. State which section applies to your change
    3. Only then proceed with edits
    Edits without stating the applicable rule are FORBIDDEN.
  version: 1.0.0
  # Resource reference tracking (see SCHEMA-RULES.md "x-references")
  # Obligation tracks data per character. When a character is deleted, all obligation
  # data (cached obligations and violation history) must be cleaned up.
  x-references:
    - target: character
      sourceType: obligation
      field: characterId
      onDelete: cascade
      cleanup:
        endpoint: /obligation/cleanup-by-character
        payloadTemplate: '{"characterId": "{{resourceId}}"}'
  # Compression callback for resource archival (see SCHEMA-RULES.md "x-compression-callback")
  x-compression-callback:
    resourceType: character
    sourceType: obligation
    compressEndpoint: /obligation/get-compress-data
    compressPayloadTemplate: '{"characterId": "{{resourceId}}"}'
    priority: 25
    templateNamespace: obligations
    description: Obligation violation history and behavioral constraint state
    decompressEndpoint: /obligation/restore-from-archive
    decompressPayloadTemplate: '{"characterId": "{{resourceId}}", "data": "{{data}}"}'
x-service-layer: GameFeatures
servers:
- url: http://localhost:5012
  description: Bannou service endpoint (internal only)

paths:
  # ===========================================================================
  # Action Tag Mapping Endpoints (Configuration)
  # ===========================================================================

  /obligation/action-mapping/set:
    post:
      summary: Create or update an action tag to violation type mapping
      operationId: setActionMapping
      tags:
      - Action Mapping
      description: |
        Registers or replaces a mapping from a GOAP action tag to one or more
        violation type codes. These mappings define how the obligation service
        connects GOAP planner actions (e.g., tag "steal_food") to contract
        behavioral clause violation types (e.g., "theft", "dishonesty").

        Mappings are idempotent by tag — setting a mapping for an existing tag
        replaces the previous mapping entirely.

        By default, action tags are matched 1:1 against violation type codes
        (tag "theft" matches violation type "theft"). Explicit mappings are only
        needed when the vocabularies differ or when one action triggers multiple
        violation types (e.g., "attack_surrendered_enemy" → ["honor_combat", "show_mercy"]).
      x-permissions:
      - role: developer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SetActionMappingRequest'
      responses:
        '200':
          description: Mapping saved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ActionMappingResponse'
        '400':
          description: Invalid mapping data

  /obligation/action-mapping/list:
    post:
      summary: List registered action tag mappings
      operationId: listActionMappings
      tags:
      - Action Mapping
      description: |
        Returns all registered action tag to violation type mappings.
        Supports cursor-based pagination and optional text search.
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ListActionMappingsRequest'
      responses:
        '200':
          description: Mappings retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListActionMappingsResponse'

  /obligation/action-mapping/delete:
    post:
      summary: Delete an action tag mapping
      operationId: deleteActionMapping
      tags:
      - Action Mapping
      description: |
        Removes a registered action tag mapping. After deletion, the tag will
        fall back to convention-based 1:1 matching (tag name == violation type code).
      x-permissions:
      - role: developer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeleteActionMappingRequest'
      responses:
        '200':
          description: Mapping deleted successfully
        '404':
          description: No mapping found for this tag

  # ===========================================================================
  # Obligation Query Endpoints (Runtime)
  # ===========================================================================

  /obligation/query:
    post:
      summary: Query active obligations for a character
      operationId: queryObligations
      tags:
      - Obligations
      description: |
        Returns all active obligations for a character, derived from their active
        contracts with behavioral clauses. The response includes a pre-computed
        violation cost map keyed by violation type code.

        Obligations are cached per character and refreshed when contract lifecycle
        events fire (contract.activated, contract.terminated, etc.). Use
        forceRefresh to bypass the cache and rebuild from current contract state.
      x-permissions: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QueryObligationsRequest'
      responses:
        '200':
          description: Obligations retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueryObligationsResponse'

  /obligation/evaluate-action:
    post:
      summary: Evaluate obligation violation costs for proposed actions
      operationId: evaluateAction
      tags:
      - Obligations
      description: |
        Non-mutating speculative query. Given a character and a set of GOAP action
        tags, returns the computed violation costs for each tag based on the
        character's active obligations.

        Each action tag is resolved to violation types via registered action mappings
        (or 1:1 convention if no explicit mapping exists), then matched against the
        character's active obligation clauses.

        When personality enrichment is available (via character-personality provider),
        costs are weighted by personality traits (honesty, loyalty, agreeableness,
        conscientiousness) and combat preferences. Without personality enrichment,
        base penalty costs from contract clauses are returned as-is.

        Faction context is resolved internally via the character's active contracts
        and locationId (if provided). Contracts encode party roles which implicitly
        represent faction obligations — no separate factionId is needed.

        This endpoint is primarily for external callers (game servers, debug tools).
        The actor cognition pipeline reads obligation costs from the Variable Provider
        cache (${obligations.*}) for performance.
      x-permissions: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EvaluateActionRequest'
      responses:
        '200':
          description: Evaluation completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EvaluateActionResponse'

  # ===========================================================================
  # Violation Management Endpoints
  # ===========================================================================

  /obligation/report-violation:
    post:
      summary: Report a knowing obligation violation
      operationId: reportViolation
      tags:
      - Violations
      description: |
        Records that a character knowingly violated an obligation. Called by the
        actor cognition pipeline when an action marked as "knowing_violation"
        completes execution.

        This endpoint:
        1. Saves a violation record to the violation history store
        2. Reports a breach to lib-contract via /contract/breach/report
        3. Publishes an obligation.violation.reported event for downstream consumers

        Downstream consumers (character-personality, character-encounter) can
        subscribe to the violation event to trigger personality drift (OATH_BROKEN
        experience), encounter memory recording, and other feedback effects.

        Idempotent: duplicate reports for the same violation are rejected (Conflict).
      x-permissions: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReportViolationRequest'
      responses:
        '200':
          description: Violation recorded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReportViolationResponse'
        '404':
          description: Contract or obligation not found
        '409':
          description: Duplicate violation report (idempotency)

  /obligation/query-violations:
    post:
      summary: Query violation history for a character
      operationId: queryViolations
      tags:
      - Violations
      description: |
        Returns the violation history for a character with cursor-based pagination.
        Supports filtering by contract, violation type, and time range.
        Ordered by timestamp descending (most recent first).
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QueryViolationsRequest'
      responses:
        '200':
          description: Violations retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueryViolationsResponse'

  # ===========================================================================
  # Cache Management Endpoints
  # ===========================================================================

  /obligation/invalidate-cache:
    post:
      summary: Force obligation cache refresh for a character
      operationId: invalidateCache
      tags:
      - Cache Management
      description: |
        Forces a full cache rebuild for a character's obligation manifest.
        Queries all active contracts for the character, extracts behavioral
        clauses, and rebuilds the cached obligation state.

        Normally, the cache is maintained automatically via contract lifecycle
        events. This endpoint is for administrative and debugging purposes.
      x-permissions:
      - role: developer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InvalidateCacheRequest'
      responses:
        '200':
          description: Cache refreshed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InvalidateCacheResponse'

  # ===========================================================================
  # Compression Endpoints
  # ===========================================================================

  /obligation/get-compress-data:
    post:
      summary: Get obligation data for character archival compression
      operationId: getCompressData
      tags:
      - Compression
      description: |
        Called by Resource service during character compression.
        Returns violation history and cached obligation state for archival.
      x-permissions:
      - role: developer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetCompressDataRequest'
      responses:
        '200':
          description: Compressed data returned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ObligationArchive'
        '404':
          description: No obligation data for character

  /obligation/restore-from-archive:
    post:
      summary: Restore obligation data from archive
      operationId: restoreFromArchive
      tags:
      - Compression
      description: |
        Called by Resource service during character decompression.
        Restores violation history from archive data. Obligation cache
        is rebuilt automatically from active contracts, not from archive.
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RestoreFromArchiveRequest'
      responses:
        '200':
          description: Restoration result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RestoreFromArchiveResponse'
        '400':
          description: Invalid archive data

  # ===========================================================================
  # Resource Cleanup Endpoint
  # ===========================================================================

  /obligation/cleanup-by-character:
    post:
      summary: Cleanup all obligation data for a deleted character
      operationId: cleanupByCharacter
      tags:
      - Resource Cleanup
      description: |
        Called by lib-resource cleanup coordination when a character is deleted.
        Removes cached obligation manifests and violation history for the
        specified character. This endpoint is designed for internal
        service-to-service calls during cascading resource cleanup.
      x-permissions:
      - role: developer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CleanupByCharacterRequest'
      responses:
        '200':
          description: Cleanup completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CleanupByCharacterResponse'

components:
  schemas:
    # =========================================================================
    # Action Mapping Models
    # =========================================================================

    ActionMappingResponse:
      type: object
      description: A registered mapping from a GOAP action tag to violation type codes
      additionalProperties: false
      required:
      - tag
      - violationTypes
      - createdAt
      properties:
        tag:
          type: string
          minLength: 1
          maxLength: 128
          description: The GOAP action tag (e.g., "steal_food", "deceive_merchant")
        violationTypes:
          type: array
          items:
            type: string
            minLength: 1
            maxLength: 128
          minItems: 1
          maxItems: 20
          description: Violation type codes this tag maps to (e.g., ["theft", "dishonesty"])
        description:
          type: string
          nullable: true
          maxLength: 512
          description: Human-readable description of what this mapping represents
        createdAt:
          type: string
          format: date-time
          description: When this mapping was first created
        updatedAt:
          type: string
          format: date-time
          nullable: true
          description: When this mapping was last modified

    SetActionMappingRequest:
      type: object
      description: Request to create or update an action tag mapping
      additionalProperties: false
      required:
      - tag
      - violationTypes
      properties:
        tag:
          type: string
          minLength: 1
          maxLength: 128
          description: The GOAP action tag to map (e.g., "steal_food")
        violationTypes:
          type: array
          items:
            type: string
            minLength: 1
            maxLength: 128
          minItems: 1
          maxItems: 20
          description: Violation type codes this tag should map to
        description:
          type: string
          nullable: true
          maxLength: 512
          description: Human-readable description of this mapping

    ListActionMappingsRequest:
      type: object
      description: Request to list action tag mappings with pagination
      additionalProperties: false
      properties:
        searchTerm:
          type: string
          nullable: true
          maxLength: 256
          description: Optional text search across tag names and descriptions
        cursor:
          type: string
          nullable: true
          maxLength: 512
          description: Pagination cursor from a previous response
        pageSize:
          type: integer
          default: 20
          minimum: 1
          maximum: 100
          description: Number of mappings to return per page

    ListActionMappingsResponse:
      type: object
      description: Paginated list of action tag mappings
      additionalProperties: false
      required:
      - mappings
      - hasMore
      properties:
        mappings:
          type: array
          items:
            $ref: '#/components/schemas/ActionMappingResponse'
          description: Action tag mappings for this page
        nextCursor:
          type: string
          nullable: true
          maxLength: 512
          description: Cursor for the next page (null if no more pages)
        hasMore:
          type: boolean
          description: Whether more pages are available

    DeleteActionMappingRequest:
      type: object
      description: Request to delete an action tag mapping
      additionalProperties: false
      required:
      - tag
      properties:
        tag:
          type: string
          minLength: 1
          maxLength: 128
          description: The GOAP action tag whose mapping should be deleted

    # =========================================================================
    # Obligation Query Models
    # =========================================================================

    ObligationEntry:
      type: object
      description: A single obligation derived from a behavioral clause in an active contract
      additionalProperties: false
      required:
      - contractId
      - templateCode
      - clauseCode
      - violationType
      - basePenalty
      - contractRole
      properties:
        contractId:
          type: string
          format: uuid
          description: ID of the contract this obligation comes from
        templateCode:
          type: string
          minLength: 1
          maxLength: 128
          description: Template code of the source contract
        clauseCode:
          type: string
          minLength: 1
          maxLength: 128
          description: Code of the behavioral clause defining this obligation
        violationType:
          type: string
          minLength: 1
          maxLength: 128
          description: Violation type code (e.g., "theft", "deception", "violence")
        basePenalty:
          type: number
          format: float
          minimum: 0.0
          description: Base GOAP cost penalty for violating this obligation
        description:
          type: string
          nullable: true
          maxLength: 1024
          description: Human-readable description of the obligation
        contractRole:
          type: string
          minLength: 1
          maxLength: 128
          description: The character's role in the contract (e.g., "member", "merchant")
        effectiveUntil:
          type: string
          format: date-time
          nullable: true
          description: When this obligation expires (null if indefinite)

    QueryObligationsRequest:
      type: object
      description: Request to query active obligations for a character
      additionalProperties: false
      required:
      - characterId
      properties:
        characterId:
          type: string
          format: uuid
          description: ID of the character to query obligations for
        forceRefresh:
          type: boolean
          default: false
          description: Force cache rebuild from current contract state

    QueryObligationsResponse:
      type: object
      description: Active obligations for a character with pre-computed violation cost map
      additionalProperties: false
      required:
      - characterId
      - obligations
      - violationCostMap
      - totalActiveContracts
      - totalObligations
      - lastRefreshedAt
      properties:
        characterId:
          type: string
          format: uuid
          description: Character these obligations belong to
        obligations:
          type: array
          items:
            $ref: '#/components/schemas/ObligationEntry'
          description: All active obligations for the character
        violationCostMap:
          type: object
          additionalProperties:
            type: number
            format: float
          description: Pre-computed map of violation type code to total cost across all obligations
        totalActiveContracts:
          type: integer
          minimum: 0
          maximum: 1000
          description: Number of active contracts with behavioral clauses
        totalObligations:
          type: integer
          minimum: 0
          maximum: 10000
          description: Total number of individual obligation entries
        lastRefreshedAt:
          type: string
          format: date-time
          description: When the obligation cache was last rebuilt

    # =========================================================================
    # Action Evaluation Models
    # =========================================================================

    ObligationCostDetail:
      type: object
      description: Per-obligation cost contribution for a specific action evaluation
      additionalProperties: false
      required:
      - contractId
      - templateCode
      - clauseCode
      - violationType
      - basePenalty
      - weightedPenalty
      - contractRole
      properties:
        contractId:
          type: string
          format: uuid
          description: ID of the contract producing this cost
        templateCode:
          type: string
          minLength: 1
          maxLength: 128
          description: Template code of the source contract
        clauseCode:
          type: string
          minLength: 1
          maxLength: 128
          description: Code of the violated behavioral clause
        violationType:
          type: string
          minLength: 1
          maxLength: 128
          description: Violation type code matched
        basePenalty:
          type: number
          format: float
          minimum: 0.0
          description: Base penalty from the contract clause
        weightedPenalty:
          type: number
          format: float
          minimum: 0.0
          description: Penalty after personality-weighted moral reasoning (equals basePenalty when personality enrichment unavailable)
        contractRole:
          type: string
          minLength: 1
          maxLength: 128
          description: The character's role in the contract

    ActionEvaluation:
      type: object
      description: Obligation violation cost evaluation for a single GOAP action tag
      additionalProperties: false
      required:
      - actionTag
      - isViolation
      - totalViolationCost
      - obligationDetails
      properties:
        actionTag:
          type: string
          minLength: 1
          maxLength: 128
          description: The GOAP action tag that was evaluated
        isViolation:
          type: boolean
          description: Whether this action would violate any active obligation
        totalViolationCost:
          type: number
          format: float
          minimum: 0.0
          description: Sum of all weighted violation costs for this action
        obligationDetails:
          type: array
          items:
            $ref: '#/components/schemas/ObligationCostDetail'
          description: Per-obligation breakdown of cost contributions

    EvaluateActionRequest:
      type: object
      description: Request to evaluate obligation violation costs for proposed GOAP actions
      additionalProperties: false
      required:
      - characterId
      - actionTags
      properties:
        characterId:
          type: string
          format: uuid
          description: ID of the character whose obligations to evaluate against
        actionTags:
          type: array
          items:
            type: string
            minLength: 1
            maxLength: 128
          minItems: 1
          maxItems: 50
          description: GOAP action tags to evaluate (e.g., ["steal_food", "buy_food", "beg_for_food"])
        realmId:
          type: string
          format: uuid
          nullable: true
          description: >-
            Realm the character operates in. When provided, passed directly to
            variable provider factories for realm-scoped data. When omitted, the
            service looks up the character's realm from the Character service.
        locationId:
          type: string
          format: uuid
          nullable: true
          description: Current location ID for context-dependent moral weighting (personality enrichment only)
        targetEntityId:
          type: string
          format: uuid
          nullable: true
          description: Target entity of the action for relationship-weighted costs (personality enrichment only)
        targetEntityType:
          $ref: 'common-api.yaml#/components/schemas/EntityType'
          nullable: true
          description: Entity type of the target

    EvaluateActionResponse:
      type: object
      description: Obligation cost evaluation results for proposed actions
      additionalProperties: false
      required:
      - characterId
      - evaluations
      - moralWeightingApplied
      properties:
        characterId:
          type: string
          format: uuid
          description: Character evaluated
        evaluations:
          type: array
          items:
            $ref: '#/components/schemas/ActionEvaluation'
          description: Per-action evaluation results (one per input tag)
        moralWeightingApplied:
          type: boolean
          description: Whether personality-weighted moral reasoning enriched the cost calculations

    # =========================================================================
    # Violation Models
    # =========================================================================

    ViolationRecord:
      type: object
      description: Record of a knowing obligation violation by a character
      additionalProperties: false
      required:
      - violationId
      - characterId
      - contractId
      - clauseCode
      - violationType
      - actionTag
      - motivationScore
      - violationCost
      - breachReported
      - timestamp
      properties:
        violationId:
          type: string
          format: uuid
          description: Unique identifier for this violation record
        characterId:
          type: string
          format: uuid
          description: Character who committed the violation
        contractId:
          type: string
          format: uuid
          description: Contract that was violated
        clauseCode:
          type: string
          minLength: 1
          maxLength: 128
          description: Code of the behavioral clause that was violated
        violationType:
          type: string
          minLength: 1
          maxLength: 128
          description: Violation type code
        actionTag:
          type: string
          minLength: 1
          maxLength: 128
          description: GOAP action tag that triggered the violation
        motivationScore:
          type: number
          format: float
          minimum: 0.0
          maximum: 1.0
          description: Goal urgency that overrode the obligation (0.0-1.0)
        violationCost:
          type: number
          format: float
          minimum: 0.0
          description: Total violation cost that was accepted
        breachReported:
          type: boolean
          description: Whether a breach was filed with the contract service
        breachId:
          type: string
          format: uuid
          nullable: true
          description: Breach record ID from contract service (null if breach not reported)
        targetEntityId:
          type: string
          format: uuid
          nullable: true
          description: Target entity of the violating action (null if no specific target)
        targetEntityType:
          $ref: 'common-api.yaml#/components/schemas/EntityType'
          nullable: true
          description: Entity type of the target
        timestamp:
          type: string
          format: date-time
          description: When the violation occurred

    ReportViolationRequest:
      type: object
      description: Request to report a knowing obligation violation
      additionalProperties: false
      required:
      - characterId
      - contractId
      - clauseCode
      - violationType
      - actionTag
      - motivationScore
      - violationCost
      properties:
        characterId:
          type: string
          format: uuid
          description: ID of the character who knowingly violated the obligation
        contractId:
          type: string
          format: uuid
          description: ID of the contract that was violated
        clauseCode:
          type: string
          minLength: 1
          maxLength: 128
          description: Code of the behavioral clause that was violated
        violationType:
          type: string
          minLength: 1
          maxLength: 128
          description: Violation type code (e.g., "theft", "deception")
        actionTag:
          type: string
          minLength: 1
          maxLength: 128
          description: GOAP action tag that triggered the violation (e.g., "steal_food")
        motivationScore:
          type: number
          format: float
          minimum: 0.0
          maximum: 1.0
          description: Goal urgency that overrode the obligation (0.0 = low, 1.0 = survival)
        violationCost:
          type: number
          format: float
          minimum: 0.0
          description: Total violation cost that was accepted by the actor
        targetEntityId:
          type: string
          format: uuid
          nullable: true
          description: Target entity of the violating action (e.g., the character stolen from)
        targetEntityType:
          $ref: 'common-api.yaml#/components/schemas/EntityType'
          nullable: true
          description: Entity type of the target
        idempotencyKey:
          type: string
          nullable: true
          maxLength: 128
          description: Idempotency key to prevent duplicate violation reports

    ReportViolationResponse:
      type: object
      description: Result of reporting an obligation violation
      additionalProperties: false
      required:
      - violationId
      - characterId
      - breachReported
      properties:
        violationId:
          type: string
          format: uuid
          description: ID of the created violation record
        characterId:
          type: string
          format: uuid
          description: Character who committed the violation
        breachReported:
          type: boolean
          description: Whether a breach was successfully filed with the contract service
        breachId:
          type: string
          format: uuid
          nullable: true
          description: Breach record ID from contract service (null if not reported or failed)

    QueryViolationsRequest:
      type: object
      description: Request to query violation history for a character
      additionalProperties: false
      required:
      - characterId
      properties:
        characterId:
          type: string
          format: uuid
          description: ID of the character to query violations for
        contractId:
          type: string
          format: uuid
          nullable: true
          description: Filter by specific contract
        violationType:
          type: string
          nullable: true
          maxLength: 128
          description: Filter by violation type code
        since:
          type: string
          format: date-time
          nullable: true
          description: Only return violations after this timestamp
        cursor:
          type: string
          nullable: true
          maxLength: 512
          description: Pagination cursor from a previous response
        pageSize:
          type: integer
          default: 20
          minimum: 1
          maximum: 100
          description: Number of violations to return per page

    QueryViolationsResponse:
      type: object
      description: Paginated violation history for a character
      additionalProperties: false
      required:
      - violations
      - hasMore
      properties:
        violations:
          type: array
          items:
            $ref: '#/components/schemas/ViolationRecord'
          description: Violation records for this page
        nextCursor:
          type: string
          nullable: true
          maxLength: 512
          description: Cursor for the next page (null if no more pages)
        hasMore:
          type: boolean
          description: Whether more pages are available

    # =========================================================================
    # Cache Management Models
    # =========================================================================

    InvalidateCacheRequest:
      type: object
      description: Request to force obligation cache refresh for a character
      additionalProperties: false
      required:
      - characterId
      properties:
        characterId:
          type: string
          format: uuid
          description: ID of the character whose cache to rebuild

    InvalidateCacheResponse:
      type: object
      description: Result of cache invalidation and rebuild
      additionalProperties: false
      required:
      - characterId
      - obligationsRefreshed
      - success
      properties:
        characterId:
          type: string
          format: uuid
          description: Character whose cache was rebuilt
        obligationsRefreshed:
          type: integer
          minimum: 0
          maximum: 10000
          description: Number of obligations found and cached
        success:
          type: boolean
          description: Whether the cache rebuild completed successfully

    # =========================================================================
    # Resource Cleanup Models
    # =========================================================================

    CleanupByCharacterRequest:
      type: object
      description: Request to cleanup all obligation data for a deleted character
      additionalProperties: false
      required:
      - characterId
      properties:
        characterId:
          type: string
          format: uuid
          description: ID of the character that was deleted

    CleanupByCharacterResponse:
      type: object
      description: Result of character obligation data cleanup
      additionalProperties: false
      required:
      - obligationsRemoved
      - violationsRemoved
      - success
      properties:
        obligationsRemoved:
          type: integer
          minimum: 0
          maximum: 10000
          description: Number of cached obligation entries removed
        violationsRemoved:
          type: integer
          minimum: 0
          maximum: 100000
          description: Number of violation history records removed
        success:
          type: boolean
          description: Whether cleanup completed successfully

    # =========================================================================
    # Compression Models
    # =========================================================================

    GetCompressDataRequest:
      type: object
      description: Request to get obligation data for compression
      additionalProperties: false
      required:
      - characterId
      properties:
        characterId:
          type: string
          format: uuid
          description: ID of the character to get compress data for

    ObligationArchive:
      type: object
      x-archive-type: true
      description: |
        Complete obligation data for archive storage and storyline SDK consumption.
        Inherits base archive properties from ResourceArchiveBase.
        The characterId field equals resourceId for convenience.
      allOf:
        - $ref: './common-api.yaml#/components/schemas/ResourceArchiveBase'
      additionalProperties: false
      required:
        - characterId
        - hasViolations
        - violationCount
      properties:
        characterId:
          type: string
          format: uuid
          description: Character this data belongs to (equals resourceId)
        hasViolations:
          type: boolean
          description: Whether any violation records exist
        violationCount:
          type: integer
          minimum: 0
          maximum: 100000
          description: Number of violation records in archive
        violations:
          type: array
          nullable: true
          items:
            $ref: '#/components/schemas/ViolationRecord'
          description: Violation history records (null if hasViolations=false)

    RestoreFromArchiveRequest:
      type: object
      description: Request to restore obligation data from archive
      additionalProperties: false
      required:
      - characterId
      - data
      properties:
        characterId:
          type: string
          format: uuid
          description: ID of the character to restore data for
        data:
          type: string
          description: Base64-encoded gzipped ObligationArchive JSON

    RestoreFromArchiveResponse:
      type: object
      description: Result of restoration from archive
      additionalProperties: false
      required:
      - characterId
      - violationsRestored
      - success
      properties:
        characterId:
          type: string
          format: uuid
          description: Character data was restored for
        violationsRestored:
          type: boolean
          description: Whether violation history was restored
        success:
          type: boolean
          description: Whether the restoration completed successfully
