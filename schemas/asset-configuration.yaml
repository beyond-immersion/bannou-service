openapi: 3.0.3
info:
  title: Asset Service Configuration
  description: |
    Configuration schema for Asset service.
    Properties are bound to environment variables with ASSET_ prefix.

    **NRT Compliance**: AI agents MUST review docs/NRT-SCHEMA-RULES.md before
    modifying this schema. Optional reference types require `nullable: true`.
  version: 1.0.0
paths: {}
x-service-configuration:
  properties:
    # Storage Provider Configuration
    StorageProvider:
      type: string
      description: Storage backend type (minio, s3, r2, azure, filesystem)
      env: ASSET_STORAGE_PROVIDER
      default: minio

    StorageBucket:
      type: string
      description: Primary bucket/container name for assets
      env: ASSET_STORAGE_BUCKET
      default: bannou-assets

    StorageEndpoint:
      type: string
      description: Storage endpoint host:port for internal service connections (MinIO/S3 compatible, no http prefix)
      env: ASSET_STORAGE_ENDPOINT
      default: "minio:9000"

    StoragePublicEndpoint:
      type: string
      nullable: true
      description: Public endpoint for pre-signed URLs accessible by clients. If not set, uses StorageEndpoint. Use for Docker/K8s where internal hostname differs from public access.
      env: ASSET_STORAGE_PUBLIC_ENDPOINT
      example: "localhost:9000"

    StorageAccessKey:
      type: string
      description: Storage access key/username
      env: ASSET_STORAGE_ACCESS_KEY
      default: "minioadmin"

    StorageSecretKey:
      type: string
      description: Storage secret key/password
      env: ASSET_STORAGE_SECRET_KEY
      default: "minioadmin"

    StorageRegion:
      type: string
      description: Storage region (for S3/R2)
      env: ASSET_STORAGE_REGION
      default: us-east-1

    StorageForcePathStyle:
      type: boolean
      description: Force path-style URLs (required for MinIO)
      env: ASSET_STORAGE_FORCE_PATH_STYLE
      default: true

    StorageUseSsl:
      type: boolean
      description: Use SSL/TLS for storage connections
      env: ASSET_STORAGE_USE_SSL
      default: false

    # Pre-signed URL Configuration
    TokenTtlSeconds:
      type: integer
      description: TTL for pre-signed upload/download URLs in seconds
      env: ASSET_TOKEN_TTL_SECONDS
      default: 3600

    DownloadTokenTtlSeconds:
      type: integer
      description: TTL for download URLs (can be shorter than upload)
      env: ASSET_DOWNLOAD_TOKEN_TTL_SECONDS
      default: 900

    # Upload Limits
    MaxUploadSizeMb:
      type: integer
      description: Maximum upload size in megabytes
      env: ASSET_MAX_UPLOAD_SIZE_MB
      default: 500

    MultipartThresholdMb:
      type: integer
      description: File size threshold for multipart uploads in megabytes
      env: ASSET_MULTIPART_THRESHOLD_MB
      default: 50

    MultipartPartSizeMb:
      type: integer
      description: Size of each part in multipart uploads in megabytes
      env: ASSET_MULTIPART_PART_SIZE_MB
      default: 16

    # API Limits
    MaxResolutionAssets:
      type: integer
      description: Maximum number of asset IDs allowed in a single bundle resolution request
      env: ASSET_MAX_RESOLUTION_ASSETS
      default: 500

    MaxBulkGetAssets:
      type: integer
      description: Maximum number of asset IDs allowed in a single bulk get request
      env: ASSET_MAX_BULK_GET_ASSETS
      default: 100

    # Processing Configuration
    LargeFileThresholdMb:
      type: integer
      description: File size threshold for delegating to processing pool
      env: ASSET_LARGE_FILE_THRESHOLD_MB
      default: 50

    ProcessingPoolType:
      type: string
      description: Processing pool identifier for orchestrator
      env: ASSET_PROCESSING_POOL_TYPE
      default: asset-processor

    ProcessingMode:
      type: string
      description: Service mode (api, worker, both)
      env: ASSET_PROCESSING_MODE
      default: both

    WorkerPool:
      type: string
      nullable: true  # NRT: Optional config MUST be nullable (only set in worker mode)
      description: Worker pool identifier when running in worker mode
      env: ASSET_WORKER_POOL
      example: "texture-processor-pool"

    # Processor Pool Configuration
    ProcessorNodeId:
      type: string
      nullable: true  # NRT: Optional config MUST be nullable (set by orchestrator when spawning worker)
      description: Unique processor node ID (set by orchestrator when spawning worker)
      env: ASSET_PROCESSOR_NODE_ID
      example: "processor-node-001"

    ProcessorIdleTimeoutSeconds:
      type: integer
      description: Seconds of zero-load before auto-termination (0 to disable)
      env: ASSET_PROCESSOR_IDLE_TIMEOUT_SECONDS
      default: 300

    ProcessorHeartbeatIntervalSeconds:
      type: integer
      description: Heartbeat emission interval in seconds
      env: ASSET_PROCESSOR_HEARTBEAT_INTERVAL_SECONDS
      default: 30

    ProcessorMaxConcurrentJobs:
      type: integer
      description: Maximum concurrent jobs per processor node
      env: ASSET_PROCESSOR_MAX_CONCURRENT_JOBS
      default: 10

    ProcessorHeartbeatTimeoutSeconds:
      type: integer
      description: Mark node unhealthy after this many seconds without heartbeat
      env: ASSET_PROCESSOR_HEARTBEAT_TIMEOUT_SECONDS
      default: 90

    # FFmpeg Configuration
    FfmpegPath:
      type: string
      nullable: true  # NRT: Optional config MUST be nullable (uses system PATH if not set)
      description: Path to FFmpeg binary (empty = use system PATH)
      env: ASSET_FFMPEG_PATH
      example: "/usr/bin/ffmpeg"

    FfmpegWorkingDirectory:
      type: string
      description: Working directory for FFmpeg temporary files
      env: ASSET_FFMPEG_WORKING_DIR
      default: /tmp/bannou-ffmpeg

    # Audio Processing Configuration
    AudioOutputFormat:
      type: string
      description: Default audio output format (mp3, opus, aac)
      env: ASSET_AUDIO_OUTPUT_FORMAT
      default: mp3

    AudioBitrateKbps:
      type: integer
      description: Default audio bitrate in kbps
      env: ASSET_AUDIO_BITRATE_KBPS
      default: 192

    AudioPreserveLossless:
      type: boolean
      description: Keep original lossless file alongside transcoded version
      env: ASSET_AUDIO_PRESERVE_LOSSLESS
      default: true

    # Bundle Configuration
    BundleCompressionDefault:
      type: string
      description: Default compression for bundles (lz4, lzma, none)
      env: ASSET_BUNDLE_COMPRESSION_DEFAULT
      default: lz4

    ZipCacheTtlHours:
      type: integer
      description: TTL for cached ZIP conversions in hours
      env: ASSET_ZIP_CACHE_TTL_HOURS
      default: 24

    DeletedBundleRetentionDays:
      type: integer
      nullable: true
      description: Number of days to retain soft-deleted bundles before permanent removal. Set to 0 for immediate deletion.
      env: ASSET_DELETED_BUNDLE_RETENTION_DAYS
      default: 30

    # Webhook Configuration
    MinioWebhookSecret:
      type: string
      nullable: true  # NRT: Optional config MUST be nullable (webhooks disabled if not set)
      description: Secret for validating MinIO webhook requests
      env: ASSET_MINIO_WEBHOOK_SECRET
      example: "your-minio-webhook-secret"

    # === Storage Path Prefixes (Tier 1) ===
    TempUploadPathPrefix:
      type: string
      description: Path prefix for temporary upload staging in storage bucket
      env: ASSET_TEMP_UPLOAD_PATH_PREFIX
      default: temp

    FinalAssetPathPrefix:
      type: string
      description: Path prefix for final asset storage in bucket
      env: ASSET_FINAL_ASSET_PATH_PREFIX
      default: assets

    BundleCurrentPathPrefix:
      type: string
      description: Path prefix for finalized bundles in storage bucket
      env: ASSET_BUNDLE_CURRENT_PATH_PREFIX
      default: bundles/current

    BundleZipCachePathPrefix:
      type: string
      description: Path prefix for ZIP conversion cache in storage bucket
      env: ASSET_BUNDLE_ZIP_CACHE_PATH_PREFIX
      default: bundles/zip-cache

    BundleUploadPathPrefix:
      type: string
      description: Path prefix for bundle upload staging in storage bucket
      env: ASSET_BUNDLE_UPLOAD_PATH_PREFIX
      default: bundles/uploads

    # === Processor Availability Parameters (Tier 1) ===
    ProcessorAvailabilityMaxWaitSeconds:
      type: integer
      description: Maximum seconds to wait for processor availability
      env: ASSET_PROCESSOR_AVAILABILITY_MAX_WAIT_SECONDS
      default: 60

    ProcessorAvailabilityPollIntervalSeconds:
      type: integer
      description: Polling interval in seconds when waiting for processor
      env: ASSET_PROCESSOR_AVAILABILITY_POLL_INTERVAL_SECONDS
      default: 2

    ProcessingMaxRetries:
      type: integer
      description: Maximum retry attempts for asset processing
      env: ASSET_PROCESSING_MAX_RETRIES
      default: 5

    ProcessingRetryDelaySeconds:
      type: integer
      description: Delay in seconds between processing retries
      env: ASSET_PROCESSING_RETRY_DELAY_SECONDS
      default: 30

    # === State Store Configuration (Tier 3) ===
    StatestoreName:
      type: string
      description: Name of the state store for asset metadata
      env: ASSET_STATESTORE_NAME
      default: asset-statestore

    ProcessorPoolStoreName:
      type: string
      description: Name of the state store for processor pool management
      env: ASSET_PROCESSOR_POOL_STORE_NAME
      default: asset-processor-pool

    # === Key Prefix Configuration (Tier 3) ===
    UploadSessionKeyPrefix:
      type: string
      description: Key prefix for upload session entries in state store
      env: ASSET_UPLOAD_SESSION_KEY_PREFIX
      default: "upload:"

    AssetKeyPrefix:
      type: string
      description: Key prefix for asset entries in state store
      env: ASSET_KEY_PREFIX
      default: "asset:"

    AssetIndexKeyPrefix:
      type: string
      description: Key prefix for asset index entries in state store
      env: ASSET_INDEX_KEY_PREFIX
      default: "asset-index:"

    BundleKeyPrefix:
      type: string
      description: Key prefix for bundle entries in state store
      env: ASSET_BUNDLE_KEY_PREFIX
      default: "bundle:"

    # === Processor Pool Type Names (Tier 3) ===
    TextureProcessorPoolType:
      type: string
      description: Pool type name for texture processing
      env: ASSET_TEXTURE_PROCESSOR_POOL_TYPE
      default: texture-processor

    ModelProcessorPoolType:
      type: string
      description: Pool type name for 3D model processing
      env: ASSET_MODEL_PROCESSOR_POOL_TYPE
      default: model-processor

    AudioProcessorPoolType:
      type: string
      description: Pool type name for audio processing
      env: ASSET_AUDIO_PROCESSOR_POOL_TYPE
      default: audio-processor

    DefaultProcessorPoolType:
      type: string
      description: Default pool type name for general asset processing
      env: ASSET_DEFAULT_PROCESSOR_POOL_TYPE
      default: asset-processor

    # === Content Type Extensions (Tier 3) ===
    AdditionalProcessableContentTypes:
      type: string
      nullable: true  # NRT: Optional config MUST be nullable (extends defaults)
      description: Comma-separated list of additional processable content types beyond defaults
      env: ASSET_ADDITIONAL_PROCESSABLE_CONTENT_TYPES

    AdditionalExtensionMappings:
      type: string
      nullable: true  # NRT: Optional config MUST be nullable (extends defaults)
      description: Comma-separated ext=type pairs for additional extension mappings (e.g., ".ktx=image/ktx")
      env: ASSET_ADDITIONAL_EXTENSION_MAPPINGS

    AdditionalForbiddenContentTypes:
      type: string
      nullable: true  # NRT: Optional config MUST be nullable (extends defaults)
      description: Comma-separated list of additional forbidden content types
      env: ASSET_ADDITIONAL_FORBIDDEN_CONTENT_TYPES
