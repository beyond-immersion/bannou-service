openapi: 3.0.3
info:
  title: Common Events API
  description: |
    Shared event schemas used across all Bannou services.
    These events enable service-to-service communication via RabbitMQ pub/sub.
  version: 1.0.0
  contact:
    name: Bannou Development Team

servers: []

paths: {}

components:
  schemas:
    ServiceRegistrationEvent:
      type: object
      description: |
        Published by any service during startup to register its API endpoints
        and permission requirements with the Permissions service.
      required:
        - eventId
        - timestamp
        - serviceId
        - version
        - appId
        - endpoints
      properties:
        eventId:
          type: string
          description: Unique identifier for this registration event
        timestamp:
          type: string
          format: date-time
          description: When the service registration occurred
        serviceId:
          type: string
          description: Service ID that registered (e.g., "behavior", "accounts")
        version:
          type: string
          description: Service API version for change tracking
        appId:
          type: string
          description: Dapr app-id for service routing (typically "bannou")
        endpoints:
          type: array
          items:
            $ref: '#/components/schemas/ServiceEndpoint'
          description: API endpoints registered by the service with permission requirements
        metadata:
          type: object
          additionalProperties: true
          nullable: true
          description: Additional service registration metadata

    ServiceEndpoint:
      type: object
      description: |
        Individual API endpoint with permission requirements.
        Extracted from OpenAPI schema x-permissions sections.
      required:
        - path
        - method
        - permissions
      properties:
        path:
          type: string
          description: API endpoint path (e.g., "/accounts/{id}")
        method:
          type: string
          enum: [GET, POST, PUT, DELETE, PATCH]
          description: HTTP method for this endpoint
        permissions:
          type: array
          items:
            $ref: '#/components/schemas/PermissionRequirement'
          description: Permission requirements for this endpoint
        description:
          type: string
          description: Human-readable endpoint description
        category:
          type: string
          description: API category (auth, accounts, game, social, etc.)

    PermissionRequirement:
      type: object
      description: |
        Permission requirement mapping role and state to endpoint access.
        Defines which roles can access an endpoint in which states.
      required:
        - role
        - requiredStates
      properties:
        role:
          type: string
          description: Role that can access this endpoint (e.g., "user", "admin", "npc")
        requiredStates:
          type: object
          additionalProperties:
            type: string
          description: |
            Map of service states required for access.
            Key: service_id, Value: required_state
            Example: {"auth": "authenticated", "game-session": "in_game"}
        description:
          type: string
          description: Optional human-readable permission description

    ServiceHeartbeatEvent:
      type: object
      description: |
        Published periodically by each bannou instance to indicate health and capacity.
        Contains aggregated information for ALL services hosted by this app instance.
        Used for load balancing and service discovery by the orchestrator.
      required:
        - eventId
        - timestamp
        - serviceId
        - appId
        - status
        - services
      properties:
        eventId:
          type: string
          description: Unique identifier for this heartbeat event
        timestamp:
          type: string
          format: date-time
          description: When the heartbeat was sent
        serviceId:
          type: string
          format: uuid
          description: Unique GUID identifying this bannou instance (for log correlation/debugging)
        appId:
          type: string
          description: Dapr app-id for this instance (e.g., "bannou", "jobberwocky")
        status:
          type: string
          enum: [healthy, degraded, overloaded, shutting_down, unavailable]
          description: Overall instance health status (worst of all services + app-level issues)
        services:
          type: array
          items:
            $ref: '#/components/schemas/ServiceStatus'
          description: Status of each service/plugin hosted by this instance
        capacity:
          nullable: true
          allOf:
            - $ref: '#/components/schemas/InstanceCapacity'
        issues:
          type: array
          nullable: true
          items:
            type: string
          description: List of current issues affecting this instance
        metadata:
          type: object
          additionalProperties: true
          nullable: true
          description: Additional instance-level metadata

    ServiceStatus:
      type: object
      description: Status of an individual service/plugin within an app instance
      required:
        - serviceId
        - serviceName
        - status
      properties:
        serviceId:
          type: string
          format: uuid
          description: Unique GUID identifying this plugin instance (for log correlation/debugging)
        serviceName:
          type: string
          description: Service name (e.g., "auth", "accounts", "behavior")
        status:
          type: string
          enum: [healthy, degraded, unavailable]
          description: Individual service health status
        version:
          type: string
          description: Service API version
        metadata:
          type: object
          additionalProperties: true
          nullable: true
          description: Service-specific metadata from OnHeartbeat callback

    InstanceCapacity:
      type: object
      description: Instance-level capacity and load information
      properties:
        maxConnections:
          type: integer
          description: Maximum connections this instance can handle
        currentConnections:
          type: integer
          description: Current active connections
        cpuUsage:
          type: number
          format: float
          description: CPU usage percentage (0.0 - 1.0)
        memoryUsage:
          type: number
          format: float
          description: Memory usage percentage (0.0 - 1.0)

    ServiceMappingEvent:
      type: object
      description: |
        Published when service-to-app-id mappings change for distributed deployment.
        Enables dynamic service routing without service restarts.
      required:
        - eventId
        - timestamp
        - serviceName
        - appId
        - action
      properties:
        eventId:
          type: string
          description: Unique identifier for this mapping event
        timestamp:
          type: string
          format: date-time
          description: When the mapping change occurred
        serviceName:
          type: string
          description: Service name being mapped (e.g., "behavior", "accounts")
        appId:
          type: string
          description: Target Dapr app-id for routing
        action:
          type: string
          enum: [register, unregister, update]
          description: Type of mapping operation
        region:
          type: string
          description: Optional regional routing information
        priority:
          type: integer
          description: Load balancing weight for this mapping
        metadata:
          type: object
          additionalProperties: true
          nullable: true
          description: Additional mapping metadata
