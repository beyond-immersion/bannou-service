openapi: 3.0.3
info:
  title: Common Events API
  description: |
    Shared event schemas used across all Bannou services.
    These events enable service-to-service communication via RabbitMQ pub/sub.

    **NRT Compliance**: AI agents MUST review docs/NRT-SCHEMA-RULES.md before
    modifying this schema. Optional reference types require `nullable: true`.
  version: 1.0.0
  contact:
    name: Bannou Development Team

servers: []

paths: {}

components:
  schemas:
    BaseServiceEvent:
      type: object
      additionalProperties: false
      description: |
        Base schema for all service-to-service events.
        All service events MUST include these fields and inherit from this schema.
        Implements IBannouEvent interface for uniform event handling in taps.
      required:
        - eventName
        - eventId
        - timestamp
      properties:
        eventName:
          type: string
          description: |
            Unique event type identifier (e.g., "connect.capability_manifest").
            Must be in the generated ClientEventWhitelist or will be rejected.
            Convention: {service}.{event_name}
        eventId:
          type: string
          format: uuid
          description: Unique identifier for this event instance (UUID string)
        timestamp:
          type: string
          format: date-time
          description: When the event was created (ISO 8601 format, UTC)

    ServiceRegistrationEvent:
      allOf:
        - $ref: '#/components/schemas/BaseServiceEvent'
      type: object
      additionalProperties: false
      description: |
        Published by any service during startup to register its API endpoints
        and permission requirements with the Permission service.
      required:
        - eventName
        - eventId
        - timestamp
        - serviceId
        - serviceName
        - version
        - appId
        - endpoints
      properties:
        eventName:
          type: string
          default: "service.registration"
          description: Fixed event type identifier
        serviceId:
          type: string
          format: uuid
          description: Unique GUID identifying this bannou instance (for log correlation/debugging)
        serviceName:
          type: string
          description: Service ID that registered (e.g., "behavior", "account")
        version:
          type: string
          description: Service API version for change tracking
        appId:
          type: string
          description: Bannou app-id for service routing (typically "bannou")
        endpoints:
          type: array
          items:
            $ref: '#/components/schemas/ServiceEndpoint'
          description: API endpoints registered by the service with permission requirements
        metadata:
          type: object
          additionalProperties: true
          nullable: true
          description: Additional service registration metadata

    ServiceEndpoint:
      type: object
      additionalProperties: false
      description: |
        Individual API endpoint with permission requirements.
        Extracted from OpenAPI schema x-permissions sections.
      required:
        - path
        - method
        - permissions
      properties:
        path:
          type: string
          description: API endpoint path (e.g., "/account/{id}")
        method:
          type: string
          enum: [GET, POST, PUT, DELETE, PATCH]
          description: HTTP method for this endpoint
        permissions:
          type: array
          items:
            $ref: '#/components/schemas/PermissionRequirement'
          description: Permission requirements for this endpoint
        description:
          type: string
          nullable: true  # NRT: Optional property MUST be nullable
          description: Human-readable endpoint description
        category:
          type: string
          nullable: true  # NRT: Optional property MUST be nullable
          description: API category (auth, account, game, social, etc.)

    PermissionRequirement:
      type: object
      additionalProperties: false
      description: |
        Permission requirement mapping role and state to endpoint access.
        Defines which roles can access an endpoint in which states.
      required:
        - role
        - requiredStates
      properties:
        role:
          type: string
          description: Role that can access this endpoint (e.g., "user", "admin", "npc")
        requiredStates:
          type: object
          additionalProperties:
            type: string
          description: |
            Map of service states required for access.
            Key: service_id, Value: required_state
            Example: {"game-session": "in_game", "character": "selected"}
        description:
          type: string
          nullable: true  # NRT: Optional property MUST be nullable
          description: Optional human-readable permission description

    ServiceHeartbeatEvent:
      allOf:
        - $ref: '#/components/schemas/BaseServiceEvent'
      type: object
      additionalProperties: false
      description: |
        Published periodically by each bannou instance to indicate health and capacity.
        Contains aggregated information for ALL services hosted by this app instance.
        Used for load balancing and service discovery by the orchestrator.
      required:
        - eventName
        - eventId
        - timestamp
        - serviceId
        - appId
        - status
        - services
      properties:
        eventName:
          type: string
          default: "service.heartbeat"
          description: Fixed event type identifier
        serviceId:
          type: string
          format: uuid
          description: Unique GUID identifying this bannou instance (for log correlation/debugging)
        appId:
          type: string
          description: Bannou app-id for this instance (e.g., "bannou", "jobberwocky")
        status:
          type: string
          enum: [healthy, degraded, overloaded, shutting_down, unavailable]
          description: Overall instance health status (worst of all services + app-level issues)
        services:
          type: array
          items:
            $ref: '#/components/schemas/ServiceStatus'
          description: Status of each service/plugin hosted by this instance
        capacity:
          nullable: true
          description: Capacity and load information for this instance
          allOf:
            - $ref: '#/components/schemas/InstanceCapacity'
        issues:
          type: array
          nullable: true
          items:
            type: string
          description: List of current issues affecting this instance
        metadata:
          type: object
          additionalProperties: true
          nullable: true
          description: Additional instance-level metadata

    ServiceStatus:
      type: object
      additionalProperties: false
      description: Status of an individual service/plugin within an app instance
      required:
        - serviceId
        - serviceName
        - status
      properties:
        serviceId:
          type: string
          format: uuid
          description: Unique GUID identifying this plugin instance (for log correlation/debugging)
        serviceName:
          type: string
          description: Service name (e.g., "auth", "account", "behavior")
        status:
          type: string
          enum: [healthy, degraded, unavailable]
          description: Individual service health status
        version:
          type: string
          nullable: true  # NRT: Optional property MUST be nullable
          description: Service API version
        metadata:
          type: object
          additionalProperties: true
          nullable: true
          description: Service-specific metadata from OnHeartbeat callback

    InstanceCapacity:
      type: object
      additionalProperties: false
      description: Instance-level capacity and load information
      properties:
        maxConnections:
          type: integer
          nullable: true  # NRT: Optional property MUST be nullable
          description: Maximum connections this instance can handle
        currentConnections:
          type: integer
          nullable: true  # NRT: Optional property MUST be nullable
          description: Current active connections
        cpuUsage:
          type: number
          format: float
          nullable: true  # NRT: Optional property MUST be nullable
          description: CPU usage ratio (0.0 - 1.0)
        memoryUsage:
          type: number
          format: float
          nullable: true  # NRT: Optional property MUST be nullable
          description: Memory usage ratio (0.0 - 1.0)

    ServiceErrorEvent:
      allOf:
        - $ref: '#/components/schemas/BaseServiceEvent'
      type: object
      additionalProperties: false
      description: |
        Structured error event for unexpected service failures (akin to Sentry).
        Use ONLY for internal faults, not for user/input errors.
      required:
        - eventName
        - eventId
        - timestamp
        - serviceId
        - serviceName
        - appId
        - operation
        - errorType
        - message
      properties:
        eventName:
          type: string
          default: "service.error"
          description: Fixed event type identifier
        serviceId:
          type: string
          format: uuid
          description: Unique GUID identifying this plugin instance (for log correlation/debugging)
        serviceName:
          type: string
          description: Logical service name emitting the error (e.g., "account")
        appId:
          type: string
          description: Bannou app-id of the instance emitting the error
        operation:
          type: string
          description: Operation/method name where the error occurred
        errorType:
          type: string
          description: High-level classification (e.g., "unexpected_exception", "dependency_failure")
        message:
          type: string
          description: Human-readable error summary
        correlationId:
          type: string
          nullable: true
          description: Correlation ID / request ID, if available
        severity:
          type: string
          enum: [info, warning, error, critical]
          default: error
          description: Severity for triage/routing
        dependency:
          type: string
          nullable: true
          description: Dependency implicated in the failure (e.g., redis, pubsub, http:account)
        endpoint:
          type: string
          nullable: true
          description: Service endpoint involved (e.g., POST /account/create)
        details:
          type: object
          nullable: true
          additionalProperties: true
          description: Redacted structured context (exclude PII/secrets)
        stack:
          type: string
          nullable: true
          description: Optional stack trace for debugging (avoid PII)
        cpuUsage:
          type: number
          format: float
          description: CPU usage percentage (0.0 - 1.0)
        memoryUsage:
          type: number
          format: float
          description: Memory usage percentage (0.0 - 1.0)

    FullServiceMappingsEvent:
      allOf:
        - $ref: '#/components/schemas/BaseServiceEvent'
      type: object
      additionalProperties: false
      description: |
        Published periodically by Orchestrator as the authoritative source of truth
        for all service-to-app-id mappings across the entire network.
        Consumed by all bannou instances to atomically update their routing tables.
        Published every 30 seconds AND immediately when routing changes.
      required:
        - eventName
        - eventId
        - timestamp
        - mappings
        - version
      properties:
        eventName:
          type: string
          default: "orchestrator.full_service_mappings"
          description: Fixed event type identifier
        mappings:
          type: object
          additionalProperties:
            type: string
          description: Complete dictionary of serviceName -> appId mappings
        defaultAppId:
          type: string
          nullable: true  # NRT: Optional property MUST be nullable
          description: Default app-id for unmapped services (usually "bannou")
        version:
          type: integer
          format: int64
          description: Monotonically increasing version for ordering. Consumers reject events with version <= current.
        sourceInstanceId:
          type: string
          format: uuid
          nullable: true  # NRT: Optional property MUST be nullable
          description: Orchestrator instance GUID that published this event
        totalServices:
          type: integer
          nullable: true  # NRT: Optional property MUST be nullable
          description: Total number of services in the mappings dictionary

    SessionConnectedEvent:
      allOf:
        - $ref: '#/components/schemas/BaseServiceEvent'
      type: object
      additionalProperties: false
      description: |
        Published by Connect service when a WebSocket connection is fully established.
        This event ensures the RabbitMQ exchange exists before any service publishes
        to the session-specific topic (CONNECT_SESSION_{sessionId}).
        Permission service uses this to track activeConnections and compile capabilities.
        The roles and authorizations enable event-driven capability compilation without
        synchronous API calls from Connect to Permission.
      required:
        - eventName
        - eventId
        - timestamp
        - sessionId
        - accountId
      properties:
        eventName:
          type: string
          default: "session.connected"
          description: Fixed event type identifier
        sessionId:
          type: string
          format: uuid
          description: Session ID that just connected via WebSocket
        accountId:
          type: string
          format: uuid
          description: Account ID owning the session
        roles:
          type: array
          items:
            type: string
          nullable: true
          description: User roles from JWT (e.g., ["user", "admin"]). Used by Permission to compile capabilities.
        authorizations:
          type: array
          items:
            type: string
          nullable: true
          description: Authorization states from JWT (e.g., ["arcadia:authorized"]). Format is "serviceId:state".
        connectInstanceId:
          type: string
          format: uuid
          nullable: true
          description: Connect service instance handling this connection (for debugging)
        peerGuid:
          type: string
          format: uuid
          nullable: true
          description: |
            Unique GUID for peer-to-peer routing. Other connections on the same Connect node
            can route messages directly to this connection using this GUID with the Client flag.
            Enables zero-copy message forwarding between Game Servers, Actor Pool Nodes, and clients.
        clientInfo:
          type: object
          nullable: true
          additionalProperties: true
          description: Optional client metadata (version, platform, etc.)

    SessionDisconnectedEvent:
      allOf:
        - $ref: '#/components/schemas/BaseServiceEvent'
      type: object
      additionalProperties: false
      description: |
        Published by Connect service when a WebSocket connection is closed.
        Used by Permission service to remove session from activeConnections.
        Also enables cleanup of session-specific resources across services.
      required:
        - eventName
        - eventId
        - timestamp
        - sessionId
      properties:
        eventName:
          type: string
          default: "session.disconnected"
          description: Fixed event type identifier
        sessionId:
          type: string
          format: uuid
          description: Session ID that disconnected
        accountId:
          type: string
          format: uuid
          nullable: true  # NRT: Optional property MUST be nullable
          description: Account ID that was disconnected
        reason:
          type: string
          nullable: true
          description: Disconnect reason (logout, timeout, error, server_shutdown)
        reconnectable:
          type: boolean
          default: false
          description: Whether session can reconnect within the reconnection window
        durationSeconds:
          type: integer
          nullable: true
          description: How long the session was connected (for metrics)

    SessionReconnectedEvent:
      allOf:
        - $ref: '#/components/schemas/BaseServiceEvent'
      type: object
      additionalProperties: false
      description: |
        Published by Connect service when a WebSocket session is restored after reconnection.
        Services should subscribe to this event to re-publish any session shortcuts they
        previously granted, as shortcuts are cleared on disconnect and do not persist.

        **Session Shortcuts Re-publication:**
        Services that publish session shortcuts should listen for this event and re-evaluate
        whether the session should receive shortcuts again (e.g., check subscription status,
        game state, etc.) and publish new ShortcutPublishedEvents as appropriate.
      required:
        - eventName
        - eventId
        - timestamp
        - sessionId
        - accountId
      properties:
        eventName:
          type: string
          default: "session.reconnected"
          description: Fixed event type identifier
        sessionId:
          type: string
          format: uuid
          description: Session ID that reconnected
        accountId:
          type: string
          format: uuid
          description: Account ID owning the reconnected session
        roles:
          type: array
          items:
            type: string
          nullable: true
          description: User roles preserved from previous session
        authorizations:
          type: array
          items:
            type: string
          nullable: true
          description: Authorization states preserved from previous session
        previousDisconnectAt:
          type: string
          format: date-time
          nullable: true
          description: When the previous connection was lost
        peerGuid:
          type: string
          format: uuid
          nullable: true
          description: |
            New peer GUID for this reconnected session. Note: This is a NEW GUID -
            peer GUIDs do not persist across reconnections. Peers must be notified
            of the new GUID to continue peer-to-peer routing.
        reconnectionContext:
          type: object
          additionalProperties: true
          nullable: true
          description: Optional context from the reconnection (client info, etc.)

    # === Character State Events (from Actor service) ===
    CharacterStateUpdateEvent:
      allOf:
        - $ref: '#/components/schemas/BaseServiceEvent'
      type: object
      additionalProperties: false
      description: |
        Published by Actor service when an actor updates a character's behavioral state.
        Game servers subscribe to receive state updates for characters they manage.

        This is NOT physics data (position, velocity) - that's Game Server territory.
        This is intent/emotional/goal state that the character's behavior stack reads as input.

        Note: Game servers have no knowledge of actors - they only see character state.
      required:
        - eventName
        - eventId
        - timestamp
        - characterId
      properties:
        eventName:
          type: string
          default: "character.state_update"
          description: Fixed event type identifier
        characterId:
          type: string
          format: uuid
          description: Character this update applies to
        actorId:
          type: string
          nullable: true
          description: Actor that produced this update (opaque to Game Server)
        feelings:
          description: Emotional state values for the character
          $ref: '#/components/schemas/FeelingState'
        goals:
          description: Goal state for the character
          $ref: '#/components/schemas/GoalState'
        memories:
          type: array
          nullable: true
          items:
            $ref: '#/components/schemas/MemoryUpdate'
          description: Memory updates (add/remove/modify)
        behaviorChange:
          description: Changes to the character's behavior composition
          $ref: '#/components/schemas/BehaviorCompositionChange'

    FeelingState:
      type: object
      additionalProperties: false
      nullable: true
      description: |
        Emotional state values (0.0 - 1.0 intensity).
        The character's behavior stack reads these as inputs to influence decisions.
      properties:
        angry:
          type: number
          format: float
          nullable: true
          minimum: 0
          maximum: 1
          description: Anger intensity (0 = calm, 1 = furious)
        fearful:
          type: number
          format: float
          nullable: true
          minimum: 0
          maximum: 1
          description: Fear intensity (0 = brave, 1 = terrified)
        happy:
          type: number
          format: float
          nullable: true
          minimum: 0
          maximum: 1
          description: Happiness intensity (0 = neutral, 1 = joyful)
        sad:
          type: number
          format: float
          nullable: true
          minimum: 0
          maximum: 1
          description: Sadness intensity (0 = content, 1 = devastated)
        alert:
          type: number
          format: float
          nullable: true
          minimum: 0
          maximum: 1
          description: Alertness intensity (0 = relaxed, 1 = hypervigilant)
        custom:
          type: object
          additionalProperties:
            type: number
            format: float
          nullable: true
          description: Additional custom emotional states (game-specific)

    GoalState:
      type: object
      additionalProperties: false
      nullable: true
      description: |
        Goal state for the character.
        Primary goal drives major decisions, secondary goals run in background.
      properties:
        primaryGoal:
          type: string
          nullable: true
          description: Current primary goal (e.g., "find_shelter", "confront_enemy")
        goalParameters:
          type: object
          additionalProperties: true
          nullable: true
          description: Parameters for the primary goal (e.g., target entity, location)
        secondaryGoals:
          type: array
          items:
            type: string
          nullable: true
          description: Secondary/background goals

    MemoryUpdate:
      type: object
      additionalProperties: false
      description: |
        A single memory update operation (add, remove, or modify).
        Memories affect character behavior through recall during cognition.
      required:
        - operation
        - memoryKey
      properties:
        operation:
          type: string
          enum:
            - add
            - remove
            - modify
          description: Memory operation type
        memoryKey:
          type: string
          description: Memory identifier (e.g., "betrayed_by", "friend_of", "witnessed_event")
        memoryValue:
          type: object
          additionalProperties: true
          nullable: true
          description: Memory value (entity ID, context, intensity, etc.)
        expiresAt:
          type: string
          format: date-time
          nullable: true
          description: When this memory expires (if temporary)

    BehaviorCompositionChange:
      type: object
      additionalProperties: false
      nullable: true
      description: |
        Changes to the character's behavior composition.
        RARE - only happens during learning/growth events.
        The character's behavior stack is self-sufficient; these changes add new capabilities.
      properties:
        added:
          type: array
          items:
            type: string
          nullable: true
          description: Behavior IDs added to composition (e.g., learned skills)
        removed:
          type: array
          items:
            type: string
          nullable: true
          description: Behavior IDs removed from composition
        reason:
          type: string
          nullable: true
          description: Why this change happened (for debugging/logging)
