openapi: 3.0.4
info:
  title: Item Service Configuration
  description: |
    Configuration schema for Item service.
    Properties are bound to environment variables with BANNOU_ prefix.

    **SCHEMA MODIFICATION GATE**: STOP. Before modifying this schema, you MUST:
    1. Read docs/reference/SCHEMA-RULES.md
    2. State which section applies to your change
    3. Only then proceed with edits
    Edits without stating the applicable rule are FORBIDDEN.
  version: 1.0.0
paths: {}
x-service-configuration:
  properties:
    defaultWeightPrecision:
      $ref: 'item-api.yaml#/components/schemas/WeightPrecision'
      env: ITEM_DEFAULT_WEIGHT_PRECISION
      default: decimal_2
      description: Default weight precision for new templates
    templateCacheTtlSeconds:
      type: integer
      minimum: 0
      env: ITEM_TEMPLATE_CACHE_TTL_SECONDS
      default: 3600
      description: TTL for template cache entries in seconds (templates change infrequently)
    instanceCacheTtlSeconds:
      type: integer
      minimum: 0
      env: ITEM_INSTANCE_CACHE_TTL_SECONDS
      default: 900
      description: TTL for instance cache entries in seconds (15 minutes for active gameplay)
    maxInstancesPerQuery:
      type: integer
      minimum: 1
      env: ITEM_MAX_INSTANCES_PER_QUERY
      default: 1000
      description: Maximum item instances returned in a single query
    bindingAllowAdminOverride:
      type: boolean
      env: ITEM_BINDING_ALLOW_ADMIN_OVERRIDE
      default: true
      description: Whether admins can unbind soulbound items
    defaultRarity:
      $ref: 'item-api.yaml#/components/schemas/ItemRarity'
      env: ITEM_DEFAULT_RARITY
      default: common
      description: Default rarity for new templates when not specified
    defaultSoulboundType:
      $ref: 'item-api.yaml#/components/schemas/SoulboundType'
      env: ITEM_DEFAULT_SOULBOUND_TYPE
      default: none
      description: Default soulbound type for new templates

    # List Operation Configuration
    listOperationMaxRetries:
      type: integer
      minimum: 1
      env: ITEM_LIST_OPERATION_MAX_RETRIES
      default: 3
      description: Maximum retry attempts for optimistic concurrency on list operations

    # Locking Configuration
    lockTimeoutSeconds:
      type: integer
      minimum: 1
      env: ITEM_LOCK_TIMEOUT_SECONDS
      default: 30
      description: Timeout in seconds for distributed locks on item instance modifications

    # Item Use Configuration
    useEventDeduplicationWindowSeconds:
      type: integer
      minimum: 1
      maximum: 3600
      env: ITEM_USE_EVENT_DEDUPLICATION_WINDOW_SECONDS
      default: 60
      description: Time window in seconds for deduplicating item use events by templateId+userId combination

    useEventBatchMaxSize:
      type: integer
      minimum: 1
      maximum: 1000
      env: ITEM_USE_EVENT_BATCH_MAX_SIZE
      default: 100
      description: Maximum number of use records per batched event before forced publish

    useMilestoneCode:
      type: string
      minLength: 1
      maxLength: 64
      env: ITEM_USE_MILESTONE_CODE
      default: "use"
      description: Milestone code to complete when using items via contract behavior

    systemPartyId:
      type: string
      format: uuid
      nullable: true
      env: ITEM_SYSTEM_PARTY_ID
      description: System party ID for item use contracts (null uses deterministic UUID from game ID)

    systemPartyType:
      $ref: 'item-api.yaml#/components/schemas/EntityType'
      env: ITEM_SYSTEM_PARTY_TYPE
      default: "system"
      description: Entity type for the system party in item use contracts

    # CanUse Validation Configuration
    canUseMilestoneCode:
      type: string
      minLength: 1
      maxLength: 64
      env: ITEM_CAN_USE_MILESTONE_CODE
      default: "validate"
      description: Milestone code to complete for CanUse validation contracts

    # OnUseFailed Handler Configuration
    onUseFailedMilestoneCode:
      type: string
      minLength: 1
      maxLength: 64
      env: ITEM_ON_USE_FAILED_MILESTONE_CODE
      default: "handle_failure"
      description: Milestone code to complete for OnUseFailed handler contracts

    # Multi-Step Use Configuration
    useStepLockTimeoutSeconds:
      type: integer
      minimum: 5
      maximum: 300
      env: ITEM_USE_STEP_LOCK_TIMEOUT_SECONDS
      default: 30
      description: Distributed lock timeout in seconds for UseItemStep operations (prevents race conditions)
