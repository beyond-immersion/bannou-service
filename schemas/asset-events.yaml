openapi: 3.0.4
info:
  title: Asset Service Events
  description: |
    Event models for Asset service RabbitMQ pub/sub via MassTransit.
    Contains asset-specific service-to-service events for upload tracking,
    processing coordination, and asset lifecycle management.

    **SCHEMA MODIFICATION GATE**: STOP. Before modifying this schema, you MUST:
    1. Read docs/reference/SCHEMA-RULES.md
    2. State which section applies to your change
    3. Only then proceed with edits
    Edits without stating the applicable rule are FORBIDDEN.
  version: 1.0.0
  x-event-subscriptions:
    # MinIO webhook notifications (processed internally, not via pub/sub)
    # No external subscriptions initially - Asset service is primarily a publisher
    []
  x-event-publications:
    # Upload lifecycle events
    - topic: asset.upload.requested
      event: AssetUploadRequestedEvent
      description: Published when a new upload is initiated
    - topic: asset.upload.completed
      event: AssetUploadCompletedEvent
      description: Published when an upload is completed and validated
    # Processing events
    - topic: asset.processing.queued
      event: AssetProcessingQueuedEvent
      description: Published when an asset is queued for processing
    - topic: asset.processing.completed
      event: AssetProcessingCompletedEvent
      description: Published when asset processing completes (success or failure)
    # Asset ready events
    - topic: asset.ready
      event: AssetReadyEvent
      description: Published when an asset is fully processed and available
    # Bundle events
    - topic: asset.bundle.created
      event: BundleCreatedEvent
      description: Published when a bundle is successfully created
    - topic: asset.metabundle.created
      event: MetabundleCreatedEvent
      description: Published when a metabundle is successfully composed from source bundles
    # Bundle management events
    - topic: asset.bundle.updated
      event: BundleUpdatedEvent
      description: Published when bundle metadata is updated
    - topic: asset.bundle.deleted
      event: BundleDeletedEvent
      description: Published when a bundle is soft-deleted or permanently deleted
    - topic: asset.bundle.restored
      event: BundleRestoredEvent
      description: Published when a soft-deleted bundle is restored

paths: {}  # Events don't have HTTP paths

components:
  schemas:
    # ==========================================================================
    # Upload Events
    # ==========================================================================

    AssetUploadRequestedEvent:
      allOf:
        - $ref: 'common-events.yaml#/components/schemas/BaseServiceEvent'
      type: object
      additionalProperties: false
      description: Event published when a new upload is initiated via requestUpload API
      required:
        - uploadId
        - owner
        - filename
        - size
        - contentType
      properties:
        uploadId:
          type: string
          format: uuid
          description: Upload session identifier
        owner:
          type: string
          description: |
            Owner of this asset operation. NOT a session ID.
            For user-initiated uploads: the accountId (UUID format).
            For service-initiated uploads: the service name (e.g., "behavior", "orchestrator").
        accountId:
          type: string
          format: uuid
          nullable: true
          description: Account ID of the requester
        filename:
          type: string
          description: Original filename
        size:
          type: integer
          format: int64
          description: Expected file size in bytes
        contentType:
          type: string
          description: MIME content type
        assetType:
          $ref: 'asset-api.yaml#/components/schemas/AssetType'
          description: Category of asset being uploaded
        realm:
          $ref: 'asset-api.yaml#/components/schemas/GameRealm'
          description: Game realm the asset belongs to
        isMultipart:
          type: boolean
          default: false
          description: Whether this is a multipart upload

    AssetUploadCompletedEvent:
      allOf:
        - $ref: 'common-events.yaml#/components/schemas/BaseServiceEvent'
      type: object
      additionalProperties: false
      description: Event published when an upload is completed and file is stored
      required:
        - assetId
        - uploadId
        - owner
        - bucket
        - key
        - size
        - contentHash
      properties:
        assetId:
          type: string
          description: Assigned asset identifier
        uploadId:
          type: string
          format: uuid
          description: Upload session identifier
        owner:
          type: string
          description: |
            Owner of this asset operation. NOT a session ID.
            For user-initiated uploads: the accountId (UUID format).
            For service-initiated uploads: the service name (e.g., "behavior", "orchestrator").
        accountId:
          type: string
          format: uuid
          nullable: true
          description: Account ID of the requester
        bucket:
          type: string
          description: Storage bucket name
        key:
          type: string
          description: Storage object key
        size:
          type: integer
          format: int64
          description: Actual file size in bytes
        contentHash:
          type: string
          description: SHA256 hash of the file contents
        contentType:
          type: string
          nullable: true  # NRT: Optional property MUST be nullable
          description: MIME content type

    # ==========================================================================
    # Processing Events
    # ==========================================================================

    AssetProcessingQueuedEvent:
      allOf:
        - $ref: 'common-events.yaml#/components/schemas/BaseServiceEvent'
      type: object
      additionalProperties: false
      description: Event published when an asset is queued for processing
      required:
        - assetId
        - processingType
      properties:
        assetId:
          type: string
          description: Asset identifier
        processingType:
          $ref: '#/components/schemas/ProcessingTypeEnum'
          description: Type of processing to be performed on the asset
        priority:
          type: integer
          default: 5
          description: Processing priority (1=highest, 10=lowest)
        processorAppId:
          type: string
          nullable: true
          description: Assigned processor app-id (if delegated to pool)
        estimatedDurationMs:
          type: integer
          nullable: true
          description: Estimated processing duration

    AssetProcessingCompletedEvent:
      allOf:
        - $ref: 'common-events.yaml#/components/schemas/BaseServiceEvent'
      type: object
      additionalProperties: false
      description: Event published when asset processing completes
      required:
        - assetId
        - processingType
        - success
      properties:
        assetId:
          type: string
          description: Asset identifier
        processingType:
          $ref: '#/components/schemas/ProcessingTypeEnum'
          description: Type of processing that was performed
        success:
          type: boolean
          description: Whether processing completed successfully
        errorMessage:
          type: string
          nullable: true
          description: Error message on failure
        outputs:
          type: array
          nullable: true
          description: Generated derivative assets from processing
          items:
            $ref: '#/components/schemas/ProcessingOutput'
        durationMs:
          type: integer
          nullable: true
          description: Actual processing duration in milliseconds

    # ==========================================================================
    # Asset Ready Events
    # ==========================================================================

    AssetReadyEvent:
      allOf:
        - $ref: 'common-events.yaml#/components/schemas/BaseServiceEvent'
      type: object
      additionalProperties: false
      description: Event published when an asset is fully processed and available
      required:
        - assetId
        - bucket
        - key
        - contentHash
      properties:
        assetId:
          type: string
          description: Asset identifier
        versionId:
          type: string
          nullable: true
          description: Version ID in storage
        bucket:
          type: string
          description: Storage bucket name
        key:
          type: string
          description: Storage object key
        contentHash:
          type: string
          description: SHA256 hash of the file contents
        size:
          type: integer
          format: int64
          nullable: true  # NRT: Optional property MUST be nullable
          description: File size in bytes
        contentType:
          type: string
          nullable: true  # NRT: Optional property MUST be nullable
          description: MIME content type
        assetType:
          $ref: 'asset-api.yaml#/components/schemas/AssetType'
          description: Category of the asset
        realm:
          $ref: 'asset-api.yaml#/components/schemas/GameRealm'
          description: Game realm the asset belongs to

    # ==========================================================================
    # Bundle Events
    # ==========================================================================

    BundleCreatedEvent:
      allOf:
        - $ref: 'common-events.yaml#/components/schemas/BaseServiceEvent'
      type: object
      additionalProperties: false
      description: Event published when a bundle is successfully created
      required:
        - bundleId
        - version
        - bucket
        - key
        - assetCount
      properties:
        bundleId:
          type: string
          description: Human-readable bundle identifier
        version:
          type: string
          description: Bundle version string
        bucket:
          type: string
          description: Storage bucket name
        key:
          type: string
          description: Storage object key
        size:
          type: integer
          format: int64
          nullable: true  # NRT: Optional property MUST be nullable
          description: Bundle file size in bytes
        assetCount:
          type: integer
          description: Number of assets in the bundle
        compression:
          $ref: 'asset-api.yaml#/components/schemas/CompressionType'
          description: Compression algorithm used for the bundle
        owner:
          type: string
          nullable: true
          description: |
            Owner of this bundle. NOT a session ID.
            For user-initiated bundles: the accountId (UUID format).
            For service-initiated bundles: the service name (e.g., "orchestrator").

    MetabundleCreatedEvent:
      allOf:
        - $ref: 'common-events.yaml#/components/schemas/BaseServiceEvent'
      type: object
      additionalProperties: false
      description: Event published when a metabundle is successfully created from source bundles
      required:
        - metabundleId
        - version
        - realm
        - sourceBundleCount
        - assetCount
        - bucket
        - key
      properties:
        metabundleId:
          type: string
          description: Human-readable metabundle identifier
        version:
          type: string
          description: Metabundle version string
        realm:
          $ref: 'asset-api.yaml#/components/schemas/GameRealm'
          description: Game realm for this metabundle
        sourceBundleCount:
          type: integer
          description: Number of source bundles composed
        sourceBundleIds:
          type: array
          nullable: true
          items:
            type: string
          description: List of human-readable source bundle IDs that were composed
        assetCount:
          type: integer
          description: Number of unique assets in the metabundle
        standaloneAssetCount:
          type: integer
          nullable: true
          description: Number of standalone assets included directly (not from bundles)
        bucket:
          type: string
          description: Storage bucket name
        key:
          type: string
          description: Storage object key
        sizeBytes:
          type: integer
          format: int64
          nullable: true
          description: Metabundle file size in bytes
        owner:
          type: string
          nullable: true
          description: |
            Owner of this metabundle. NOT a session ID.
            For user-initiated: the accountId (UUID format).
            For service-initiated: the service name.

    BundleUpdatedEvent:
      allOf:
        - $ref: 'common-events.yaml#/components/schemas/BaseServiceEvent'
      type: object
      additionalProperties: false
      description: Event published when bundle metadata is updated
      required:
        - bundleId
        - version
        - previousVersion
        - changes
        - updatedBy
      properties:
        bundleId:
          type: string
          description: Human-readable bundle identifier
        version:
          type: integer
          description: New metadata version number after update
        previousVersion:
          type: integer
          description: Previous metadata version number
        changes:
          type: array
          items:
            type: string
          description: List of changes made (e.g., "name changed", "tag 'env' added")
        reason:
          type: string
          nullable: true
          description: Reason provided for the update
        updatedBy:
          type: string
          description: Account ID or service name that performed the update
        realm:
          $ref: 'asset-api.yaml#/components/schemas/GameRealm'
          description: Game realm of the bundle

    BundleDeletedEvent:
      allOf:
        - $ref: 'common-events.yaml#/components/schemas/BaseServiceEvent'
      type: object
      additionalProperties: false
      description: Event published when a bundle is soft-deleted or permanently deleted
      required:
        - bundleId
        - permanent
        - deletedBy
      properties:
        bundleId:
          type: string
          description: Human-readable bundle identifier
        permanent:
          type: boolean
          description: True if permanently deleted, false for soft-delete
        retentionUntil:
          type: string
          format: date-time
          nullable: true
          description: When soft-deleted bundle will be permanently removed (null for permanent deletes)
        reason:
          type: string
          nullable: true
          description: Reason provided for the deletion
        deletedBy:
          type: string
          description: Account ID or service name that performed the deletion
        realm:
          $ref: 'asset-api.yaml#/components/schemas/GameRealm'
          description: Game realm of the bundle

    BundleRestoredEvent:
      allOf:
        - $ref: 'common-events.yaml#/components/schemas/BaseServiceEvent'
      type: object
      additionalProperties: false
      description: Event published when a soft-deleted bundle is restored
      required:
        - bundleId
        - restoredFromVersion
        - restoredBy
      properties:
        bundleId:
          type: string
          description: Human-readable bundle identifier
        restoredFromVersion:
          type: integer
          description: Metadata version the bundle was restored from
        reason:
          type: string
          nullable: true
          description: Reason provided for the restoration
        restoredBy:
          type: string
          description: Account ID or service name that performed the restoration
        realm:
          $ref: 'asset-api.yaml#/components/schemas/GameRealm'
          description: Game realm of the bundle

    # ==========================================================================
    # Supporting Types
    # NOTE: AssetType, Realm, and CompressionType are defined in asset-api.yaml
    # and referenced via $ref per IMPLEMENTATION TENETS (T26 schema hierarchy)
    # ==========================================================================

    ProcessingTypeEnum:
      type: string
      enum:
        - mipmaps
        - lod_generation
        - transcode
        - compression
        - validation
        - behavior_compile
      description: Type of processing being performed

    ProcessingOutput:
      type: object
      additionalProperties: false
      description: Information about a generated derivative asset
      required:  # NRT: Required event properties
        - outputType
        - key
      properties:
        outputType:
          type: string
          description: Type of output (e.g., "mipmap_level_1", "lod_2")
        key:
          type: string
          description: Storage key for the output
        size:
          type: integer
          format: int64
          nullable: true  # NRT: Optional property MUST be nullable
          description: Size of the output in bytes
