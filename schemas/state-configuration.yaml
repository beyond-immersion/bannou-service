# State Service Configuration Schema
# Defines connection settings for Redis and MySQL state stores
openapi: 3.0.3
info:
  title: State Service Configuration
  description: |
    Configuration schema for State service.
    Properties are bound to environment variables with STATE_ prefix.

    **SCHEMA MODIFICATION GATE**: STOP. Before modifying this schema, you MUST:
    1. Read docs/reference/SCHEMA-RULES.md
    2. State which section applies to your change
    3. Only then proceed with edits
    Edits without stating the applicable rule are FORBIDDEN.
  version: 1.0.0
paths: {}

# Flat configuration properties for environment variable binding (IMPLEMENTATION TENETS)
# Note: env keys use underscores where property names have case changes
# e.g., RedisConnectionString -> STATE_REDIS_CONNECTION_STRING
x-service-configuration:
  properties:
    UseInMemory:
      type: boolean
      description: "Use in-memory storage instead of Redis/MySQL. Data is NOT persisted. ONLY for testing/minimal infrastructure."
      env: STATE_USE_INMEMORY
      default: false
    RedisConnectionString:
      type: string
      nullable: true  # NRT: Optional when UseInMemory=true; service validates at startup
      description: Redis connection string (host:port format) for Redis-backed state stores
      env: STATE_REDIS_CONNECTION_STRING
      default: "bannou-redis:6379"
    MySqlConnectionString:
      type: string
      nullable: true  # NRT: Optional when UseInMemory=true; service validates at startup
      description: MySQL connection string for MySQL-backed state stores
      env: STATE_MYSQL_CONNECTION_STRING
      default: "server=bannou-mysql;database=bannou;user=guest;password=guest"
    ConnectionTimeoutSeconds:
      type: integer
      minimum: 1
      maximum: 300
      description: Total timeout in seconds for establishing Redis/MySQL connections
      env: STATE_CONNECTION_TIMEOUT_SECONDS
      default: 60
    ConnectionRetryCount:
      type: integer
      minimum: 0
      maximum: 100
      description: Maximum number of connection retry attempts for MySQL initialization
      env: STATE_CONNECTION_RETRY_COUNT
      default: 10
    MinRetryDelayMs:
      type: integer
      minimum: 100
      maximum: 60000
      description: Minimum delay in milliseconds between MySQL connection retry attempts
      env: STATE_MIN_RETRY_DELAY_MS
      default: 1000
    InMemoryFallbackLimit:
      type: integer
      minimum: 100
      maximum: 1000000
      description: Maximum entries for in-memory LINQ fallback before throwing InvalidOperationException. Use JsonQueryAsync for large datasets.
      env: STATE_INMEMORY_FALLBACK_LIMIT
      default: 10000
    # Note: DefaultConsistency was removed as dead config (IMPLEMENTATION TENETS T21).
    # Consistency is specified per-request via StateOptions.Consistency, not as a global default.
    # The ConsistencyLevel enum remains available in state-api.yaml for per-request use.
    # Note: Telemetry (metrics/tracing) is controlled centrally via lib-telemetry configuration.
    # When lib-telemetry is enabled, it automatically instruments state operations via ITelemetryProvider.
    # When disabled or not loaded, instrumentation is skipped entirely (zero overhead).
