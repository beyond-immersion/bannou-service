openapi: 3.0.0
info:
  title: Bannou Connect API
  version: 2.0.0
  description: |
    Real-time communication and WebSocket connection management for Bannou services.

    **POST-Only API Pattern**: This API uses POST for all service operations to support zero-copy
    WebSocket routing. Path parameters are passed in request bodies instead of URLs.
    See docs/BANNOU_DESIGN.md for architectural rationale.

    **Exception**: The `/connect` WebSocket endpoint uses GET/POST for the HTTP upgrade handshake,
    which is required by the WebSocket protocol specification.

    This API handles:
    - WebSocket connection establishment with JWT authentication
    - Bi-directional real-time messaging between clients and services
    - Binary protocol with message flags, channels, and service routing
    - Client reconnection and session management
    - Integration with Bannou mesh for service-to-service communication
    - Redis-backed connection state management

    ## Connection Protocol

    The connect service uses a custom binary protocol over WebSockets with the following features:

    - **Message Flags**: Control message behavior (binary, encrypted, compressed, high priority, events vs RPC)
    - **Channel System**: Support for sequential message processing on specific channels
    - **Service Routing**: Route messages to appropriate Bannou services via GUID-based service lookup
    - **Bi-directional RPC**: Services can make RPC calls back to connected clients
    - **Reconnection Support**: Clients can reconnect to existing sessions within a configurable time window

    **SCHEMA MODIFICATION GATE**: STOP. Before modifying this schema, you MUST:
    1. Read docs/reference/SCHEMA-RULES.md
    2. State which section applies to your change
    3. Only then proceed with edits
    Edits without stating the applicable rule are FORBIDDEN.
x-service-layer: AppFoundation
servers:
- url: http://localhost:5012
  description: Bannou service endpoint (internal only)

paths:
  /internal/proxy:
    post:
      summary: Internal API proxy for stateless requests
      operationId: proxyInternalRequest
      tags:
      - Internal Proxy
      description: |
        Stateless HTTP proxy for internal requests that don't require persistent sessions.
        Applies permission validation and rate limiting based on agent role and context.
        Perfect for AI agents making one-off API calls or bulk operations.
      x-permissions: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InternalProxyRequest'
      responses:
        '200':
          description: Request proxied successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InternalProxyResponse'
        '403':
          description: Permission denied
        '404':
          description: Target service or endpoint not found
        '429':
          description: Rate limit exceeded

  # NOTE: Service routing mappings (service-name → app-id) are now in Orchestrator API
  # at /orchestrator/service-routing. Connect service handles client capabilities only.

  /client-capabilities:
    post:
      summary: Get client capability manifest (GUID → API mappings)
      operationId: getClientCapabilities
      tags:
      - Client Capabilities
      x-permissions:
      - role: user
        states: {}
      description: |
        Returns the capability manifest for the authenticated client's session.
        Maps client-salted GUIDs to available API endpoints based on the client's
        current permissions and session state.

        **Security**: Each client receives unique GUIDs for the same API endpoints.
        This prevents cross-session exploitation and enables per-client rate limiting.

        **Dynamic Updates**: Capabilities may change during a session when:
        - Role changes occur (admin promotion, etc.)
        - Subscription status changes
        - Session state transitions

        Clients should listen for capability update events via WebSocket to stay current.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetClientCapabilitiesRequest'
      responses:
        '200':
          description: Client capabilities retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClientCapabilitiesResponse'
        '401':
          description: Not authenticated - requires valid session
        '500':
          description: Error retrieving capabilities

  /connect:
    get:
      summary: Establish WebSocket connection
      description: |
        Initiates a WebSocket connection for real-time communication.
        Requires JWT authentication via Authorization header.

        **Connection Flow:**
        1. Send HTTP GET request with `Connection: Upgrade` and `Upgrade: websocket` headers
        2. Include `Authorization: Bearer <jwt_token>` header for authentication
        3. Server validates JWT and extracts user claims (roles, scopes, services)
        4. Connection upgrades to WebSocket protocol
        5. Client can send binary messages using the custom protocol

        **Reconnection:**
        For existing sessions, use `Authorization: Reconnect <reconnect_token>` instead.
      operationId: ConnectWebSocket
      tags:
      - WebSocket Connection
      x-permissions: []
      x-controller-only: true
      parameters:
      - name: Connection
        in: header
        required: true
        schema:
          type: string
          enum: ["Upgrade"]
        description: Must be "Upgrade" to initiate WebSocket connection
      - name: Upgrade
        in: header
        required: true
        schema:
          type: string
          enum: ["websocket"]
        description: Must be "websocket" to specify protocol upgrade
      - name: Authorization
        in: header
        required: true
        schema:
          type: string
        description: |
          JWT Bearer token for new connections: "Bearer <jwt_token>"
          Reconnect token for existing sessions: "Reconnect <reconnect_token>"
        examples:
          new-connection:
            summary: New connection with JWT
            value: "Bearer eyJhbGciOiJSUzUxMiIsInR5cCI6IkpXVCJ9..."
          reconnection:
            summary: Reconnect to existing session
            value: "Reconnect abc123def456..."
      responses:
        '101':
          description: WebSocket connection established successfully
          headers:
            Upgrade:
              schema:
                type: string
                enum: ["websocket"]
              description: Confirms protocol upgrade to WebSocket
            Connection:
              schema:
                type: string
                enum: ["Upgrade"]
              description: Confirms connection upgrade
        '400':
          description: Bad request - missing required headers or invalid request format
        '403':
          description: Forbidden - invalid JWT token or reconnection token
        '500':
          description: Internal server error during connection setup
    post:
      summary: Establish WebSocket connection (POST variant)
      description: |
        Alternative POST method for establishing WebSocket connections.
        Functionally identical to the GET method but supports clients that
        require POST for WebSocket upgrades.
      operationId: ConnectWebSocketPost
      tags:
      - WebSocket Connection
      x-permissions: []
      x-controller-only: true
      parameters:
      - name: Connection
        in: header
        required: true
        schema:
          type: string
          enum: ["Upgrade"]
      - name: Upgrade
        in: header
        required: true
        schema:
          type: string
          enum: ["websocket"]
      - name: Authorization
        in: header
        required: true
        schema:
          type: string
      requestBody:
        description: Optional connection parameters
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConnectRequest'
            examples:
              empty-request:
                summary: Standard connection request
                value: {}
      responses:
        '101':
          description: WebSocket connection established successfully
        '400':
          description: Bad request
        '403':
          description: Forbidden
        '500':
          description: Internal server error

  /connect/broadcast:
    get:
      summary: Inter-node broadcast WebSocket endpoint
      description: |
        Internal WebSocket endpoint for the multi-node broadcast mesh.
        Other Connect instances connect here to relay broadcast messages.
        Requires service-token authentication (same as Internal connection mode).

        **Not client-facing.** This endpoint is used exclusively for
        inter-node communication between Connect instances in multi-instance
        deployments. Requires `instanceId` query parameter identifying the
        connecting peer.
      operationId: BroadcastWebSocket
      tags:
      - Inter-Node Broadcast
      x-permissions: []
      x-controller-only: true
      parameters:
      - name: instanceId
        in: query
        required: true
        schema:
          type: string
        description: Instance ID of the connecting peer Connect node
      - name: Connection
        in: header
        required: true
        schema:
          type: string
          enum: ["Upgrade"]
        description: Must be "Upgrade" to initiate WebSocket connection
      - name: Upgrade
        in: header
        required: true
        schema:
          type: string
          enum: ["websocket"]
        description: Must be "websocket" to specify protocol upgrade
      - name: X-Service-Token
        in: header
        required: false
        schema:
          type: string
        description: Service token for authentication (required when InternalAuthMode is ServiceToken)
      responses:
        '101':
          description: WebSocket connection established for broadcast relay
        '400':
          description: Not a WebSocket request, or missing/invalid instanceId
        '401':
          description: Invalid or missing service token

  /connect/get-endpoint-meta:
    post:
      summary: Permission-gated proxy for endpoint metadata
      operationId: GetEndpointMeta
      tags:
      - Meta Proxy
      description: |
        Accepts a full meta endpoint path (e.g., "/account/get/meta/info"),
        validates the caller's JWT, looks up their active WebSocket session
        via the JWT's sessionKey, checks the session's capability mappings
        for the underlying endpoint, and proxies the internal meta GET
        request if authorized. Returns the meta endpoint response directly.

        Requires an active WebSocket connection -- the session's compiled
        capability mappings in Connect's in-memory connection state are the
        permission source, exactly as for WebSocket meta requests.
      x-permissions: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetEndpointMetaRequest'
      responses:
        '200':
          description: Meta endpoint response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetEndpointMetaResponse'
        '401':
          description: Invalid or missing JWT, or no active WebSocket session
        '403':
          description: Session lacks permission for the underlying endpoint
        '404':
          description: Endpoint or meta type not found

  /connect/get-account-sessions:
    post:
      summary: Get all active WebSocket sessions for an account
      operationId: getAccountSessions
      tags:
      - Session Management
      x-permissions:
      - role: admin
        states: {}
      description: |
        Returns all active WebSocket session IDs for a specified account.
        This is an internal endpoint used by services that need to know which
        sessions are currently connected for a given account.

        **Use Cases:**
        - GameSessionService periodic cache sync
        - Service-to-service session discovery
        - Admin session management

        **Note:** Session IDs returned are those with active WebSocket connections.
        Sessions in reconnection windows may not appear in this list.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetAccountSessionsRequest'
      responses:
        '200':
          description: Account sessions retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetAccountSessionsResponse'
        '400':
          description: Invalid request (missing account ID)
        '403':
          description: Permission denied
        '500':
          description: Error retrieving sessions

components:
  schemas:
    # Meta Proxy Models
    GetEndpointMetaRequest:
      type: object
      description: Request to proxy a meta endpoint call with permission validation
      additionalProperties: false
      required:
      - path
      properties:
        path:
          type: string
          description: Full meta endpoint path including meta type suffix (e.g., "/account/get/meta/info" or "/character/create/meta/request-schema"). Connect parses the service name, base endpoint, and meta type from this path.

    GetEndpointMetaResponse:
      type: object
      description: Meta endpoint response mirroring the internal MetaResponse structure
      additionalProperties: false
      required:
      - metaType
      - serviceName
      - method
      - path
      - data
      - schemaVersion
      properties:
        metaType:
          type: string
          description: Type of metadata returned (endpoint-info, request-schema, response-schema, full-schema)
        serviceName:
          type: string
          description: Service name that owns this endpoint (e.g., "Account")
        method:
          type: string
          description: HTTP method for the endpoint (e.g., "POST")
        path:
          type: string
          description: Endpoint path (e.g., "/account/get")
        data:
          type: object
          additionalProperties: true
          description: |
            Metadata payload whose structure varies by metaType (endpoint-info returns
            summary/tags/operationId, request-schema and response-schema return JSON Schema
            objects, full-schema returns all three combined). Uses additionalProperties because
            this proxies opaque JSON from internal meta endpoints whose schemas are defined by
            each service's controller (client-opaque pass-through per FOUNDATION TENETS).
        schemaVersion:
          type: string
          description: Schema version (assembly version) for cache invalidation

    # Request Models for POST-only pattern
    GetAccountSessionsRequest:
      type: object
      description: Request to get all active WebSocket sessions for an account
      additionalProperties: false
      required:
      - accountId
      properties:
        accountId:
          type: string
          format: uuid
          description: Account ID to retrieve sessions for

    GetAccountSessionsResponse:
      type: object
      description: Response containing all active WebSocket session IDs for an account
      additionalProperties: false
      required:
      - accountId
      - sessionIds
      properties:
        accountId:
          type: string
          format: uuid
          description: Account ID the sessions belong to
        sessionIds:
          type: array
          items:
            type: string
            format: uuid
          description: List of active WebSocket session IDs for this account

    GetClientCapabilitiesRequest:
      type: object
      description: Request to get capability manifest for a connected session (debugging endpoint)
      additionalProperties: false
      required:
      - sessionId
      properties:
        sessionId:
          type: string
          format: uuid
          description: Session ID to retrieve capabilities for (must have active WebSocket connection)
        serviceFilter:
          type: string
          description: Optional filter by service name prefix
          nullable: true
        includeMetadata:
          type: boolean
          description: Include additional metadata about each capability
          default: false

    ClientCapabilitiesResponse:
      description: Response containing the client's capability manifest with available API endpoints and shortcuts
      type: object
      additionalProperties: false
      required:
      - sessionId
      - capabilities
      - version
      properties:
        sessionId:
          type: string
          format: uuid
          description: Session ID this capability manifest belongs to
        capabilities:
          type: array
          items:
            $ref: '#/components/schemas/ClientCapability'
          description: Available API capabilities for this client
        shortcuts:
          type: array
          items:
            $ref: '#/components/schemas/ClientShortcut'
          description: |
            Pre-bound API calls available for this session.
            Shortcuts are invoked like normal capabilities but Connect injects
            a pre-bound payload instead of using the client's payload.
          nullable: true
        version:
          type: integer
          description: Capability manifest version (increments on changes)
        expiresAt:
          type: string
          format: date-time
          description: When these capabilities expire and need refresh
          nullable: true

    ClientCapability:
      description: A single API capability available to the client, mapping a client-salted GUID to a service endpoint
      type: object
      additionalProperties: false
      required:
      - guid
      - service
      - endpoint
      - method
      properties:
        guid:
          type: string
          format: uuid
          description: Client-salted GUID for this API endpoint (unique per session)
        service:
          type: string
          description: Service name (e.g., "account", "auth")
        endpoint:
          type: string
          description: API endpoint path (e.g., "/account/create")
        method:
          $ref: '#/components/schemas/HttpMethodType'
          description: HTTP method for this endpoint
        description:
          type: string
          description: Human-readable description of this capability
          nullable: true
        channel:
          type: integer
          format: uint16
          description: Preferred WebSocket channel for this capability
          default: 0

    ClientShortcut:
      type: object
      description: |
        Session shortcut information sent to clients in the capability manifest.
        Shortcuts appear as invocable capabilities but Connect injects a pre-bound
        payload when the shortcut GUID is used, replacing any client-provided payload.
      additionalProperties: false
      required:
      - guid
      - targetService
      - targetEndpoint
      - name
      properties:
        guid:
          type: string
          format: uuid
          description: |
            GUID to use in WebSocket message header when invoking this shortcut.
            Uses UUID version 7 bits to distinguish from regular service GUIDs (version 5).
        targetService:
          type: string
          description: The service this shortcut invokes (for client display purposes).
        targetEndpoint:
          type: string
          description: The endpoint this shortcut invokes (for client display purposes).
        name:
          type: string
          description: Machine-readable shortcut identifier (e.g., "get_my_stats", "join_game").
        description:
          type: string
          description: Human-readable description of what this shortcut does.
          nullable: true
        displayName:
          type: string
          description: User-friendly name for display in client UIs.
          nullable: true
        sourceService:
          type: string
          description: The service that created this shortcut.
          nullable: true
        tags:
          type: array
          items:
            type: string
          description: Categorization tags for client-side organization.
          nullable: true
        expiresAt:
          type: string
          format: date-time
          description: When this shortcut expires (if time-limited).
          nullable: true

    InternalProxyRequest:
      description: Request to proxy an API call through the Connect service to a target backend service
      type: object
      additionalProperties: false
      required:
      - sessionId
      - targetService
      - targetEndpoint
      - method
      properties:
        sessionId:
          type: string
          format: uuid
          description: WebSocket session ID making the request
        targetService:
          type: string
          description: Target service name (e.g., "account", "auth", "behavior")
        targetEndpoint:
          type: string
          description: Target API endpoint path (e.g., "/account/{id}")
        method:
          $ref: '#/components/schemas/HttpMethodType'
          description: HTTP method for the target endpoint
        headers:
          type: object
          additionalProperties:
            type: string
          nullable: true
          description: Additional headers to forward to the service (null if none)
        body:
          type: object
          additionalProperties: true
          nullable: true
          description: |
            Request body to forward to target service (null for no body). Uses
            additionalProperties because this proxies arbitrary JSON payloads to any
            target service — the structure is defined by each target service's schema,
            not by Connect (client-opaque pass-through per FOUNDATION TENETS).
        pathParameters:
          type: object
          additionalProperties:
            type: string
          nullable: true
          description: Path parameters for the endpoint (null if none)
        queryParameters:
          type: object
          additionalProperties:
            type: string
          nullable: true
          description: Query string parameters for the endpoint (null if none)

    InternalProxyResponse:
      description: Response from a proxied API call containing the target service's response data
      type: object
      additionalProperties: false
      required:
      - statusCode
      properties:
        statusCode:
          type: integer
          description: HTTP status code from the target service
        response:
          type: string
          # NRT: Optional string MUST be nullable (Rule 2)
          nullable: true
          description: JSON response from the target service (as string)
        headers:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          # NRT: Optional object MUST be nullable (Rule 2)
          nullable: true
          description: Response headers from the target service
        error:
          type: string
          # NRT: Optional string MUST be nullable (Rule 2)
          nullable: true
          description: Error message if the request failed
        executionTime:
          type: integer
          description: Request execution time in milliseconds


    ConnectRequest:
      type: object
      description: |
        Request model for WebSocket connection establishment.
        Currently contains no specific fields but extends the base ApiRequest.
      properties: {}
      additionalProperties: false

    # NOTE: ServiceMappingsResponse moved to Orchestrator API as ServiceRoutingResponse

    # Binary Protocol Schemas (for documentation purposes)
    MessageFlags:
      type: integer
      format: byte
      description: |
        Bit flags controlling message behavior in the enhanced 31-byte binary protocol.

        **Flags:**
        - 0x00 (None): Default - JSON text, service request, unencrypted, standard priority, expects response
        - 0x01 (Binary): Message payload is binary data (not JSON)
        - 0x02 (Encrypted): Message payload is encrypted
        - 0x04 (Compressed): Message payload is compressed (gzip)
        - 0x08 (HighPriority): Deliver at high priority, skip to front of queues
        - 0x10 (Event): Fire-and-forget message, no response expected
        - 0x20 (Client): Route to another WebSocket client (not a Bannou service)
        - 0x40 (Response): Message is a response to an RPC (not a new request)
        - 0x80 (Reserved): Reserved for future use
      minimum: 0
      maximum: 255
      example: 0

    ResponseCodes:
      type: integer
      format: byte
      enum:
      - 0     # OK
      - 10    # RequestError
      - 11    # RequestTooLarge
      - 12    # TooManyRequests
      - 13    # InvalidRequestChannel
      - 14    # TextProtocolNotSupported
      - 20    # Unauthorized
      - 30    # ServiceNotFound
      - 31    # ClientNotFound
      - 32    # MessageNotFound
      - 40    # BroadcastNotAllowed
      - 50    # Service_BadRequest
      - 51    # Service_NotFound
      - 52    # Service_Unauthorized
      - 53    # Service_Conflict
      - 60    # Service_InternalServerError
      - 70    # ShortcutExpired
      - 71    # ShortcutTargetNotFound
      - 72    # ShortcutRevoked
      x-enumNames:
      - "OK"
      - "RequestError"
      - "RequestTooLarge"
      - "TooManyRequests"
      - "InvalidRequestChannel"
      - "TextProtocolNotSupported"
      - "Unauthorized"
      - "ServiceNotFound"
      - "ClientNotFound"
      - "MessageNotFound"
      - "BroadcastNotAllowed"
      - "Service_BadRequest"
      - "Service_NotFound"
      - "Service_Unauthorized"
      - "Service_Conflict"
      - "Service_InternalServerError"
      - "ShortcutExpired"
      - "ShortcutTargetNotFound"
      - "ShortcutRevoked"
      description: |
        Response codes used in the binary protocol for success/error indication.
        Provides fine-grained error reporting for different failure scenarios.

        **Request error codes (10-19):**
        - 10 (RequestError): Generic malformed request
        - 11 (RequestTooLarge): Payload exceeds maximum size
        - 12 (TooManyRequests): Rate limit exceeded
        - 13 (InvalidRequestChannel): Invalid channel number
        - 14 (TextProtocolNotSupported): Text WebSocket frames are not supported; use binary protocol

        **Broadcast error codes (40-49):**
        - 40 (BroadcastNotAllowed): Broadcast attempted in External mode where it is forbidden

        **Shortcut-specific error codes (70-79):**
        - 70 (ShortcutExpired): Session shortcut has expired (TTL exceeded)
        - 71 (ShortcutTargetNotFound): Shortcut's target capability no longer available
        - 72 (ShortcutRevoked): Session shortcut was explicitly revoked
      example: 0

    ServiceRequestMessage:
      type: object
      description: |
        Structure of a service request message in the enhanced 31-byte binary protocol.
        This schema is for documentation - actual messages are binary.

        **Binary Header Layout (31 bytes):**
        - Bytes 0: Message Flags (1 byte)
        - Bytes 1-2: Channel ID (2 bytes, big-endian)
        - Bytes 3-6: Sequence Number (4 bytes, big-endian)
        - Bytes 7-22: Service GUID (16 bytes)
        - Bytes 23-30: Message ID (8 bytes)
        - Bytes 31+: Payload (variable length)
      additionalProperties: false
      required:
      - flags
      - channel
      - sequenceNumber
      - serviceGuid
      - messageId
      - payload
      properties:
        flags:
          $ref: '#/components/schemas/MessageFlags'
          description: Bit flags controlling message behavior (binary, encrypted, compressed, etc.)
        channel:
          type: integer
          format: uint16
          description: Channel for sequential message processing (0-65535, 0 = default)
        sequenceNumber:
          type: integer
          format: uint32
          description: Per-channel sequence number for message ordering
        serviceGuid:
          type: string
          format: uuid
          description: Client-salted service GUID for routing
        messageId:
          type: integer
          format: int64
          description: Unique message ID for request/response correlation
        payload:
          type: string
          format: byte
          description: Message payload (JSON or binary data based on flags)

    ServiceResponseMessage:
      type: object
      description: |
        Structure of a service response message in the enhanced 31-byte binary protocol.
        This schema is for documentation - actual messages are binary.

        **Binary Header Layout (31 bytes):**
        - Same as ServiceRequestMessage but with Response flag (0x40) set
      additionalProperties: false
      required:
      - flags
      - channel
      - sequenceNumber
      - serviceGuid
      - messageId
      - responseCode
      properties:
        flags:
          $ref: '#/components/schemas/MessageFlags'
          description: Must have Response flag (0x40) set
        channel:
          type: integer
          format: uint16
          description: Matches the request channel
        sequenceNumber:
          type: integer
          format: uint32
          description: Matches the request sequence number
        serviceGuid:
          type: string
          format: uuid
          description: Matches the request service GUID
        messageId:
          type: integer
          format: int64
          description: Matches the request message ID
        responseCode:
          $ref: '#/components/schemas/ResponseCodes'
          description: Response status code indicating success or specific error condition
        payload:
          type: string
          format: byte
          description: Optional response payload
          nullable: true

    # NOTE: SessionCapabilityUpdateEvent removed - capability updates use SessionInvalidatedEvent from auth service

    AuthEvent:
      type: object
      description: |
        Authentication state change events (login, logout, token refresh).
        Triggers session capability updates for connected clients.
      additionalProperties: false
      required:
      - sessionId
      - eventType
      - timestamp
      properties:
        sessionId:
          type: string
          format: uuid
          description: Session ID affected by the auth event
        eventType:
          $ref: '#/components/schemas/AuthEventType'
          description: Type of authentication event (Login, Logout, TokenRefresh, PermissionChange)
        timestamp:
          type: string
          format: date-time
          description: When the auth event occurred
        userId:
          type: string
          format: uuid
          # NRT: Optional string MUST be nullable (Rule 2)
          nullable: true
          description: User ID associated with the session (optional for some events)
        metadata:
          type: object
          additionalProperties: true
          # NRT: Optional object MUST be nullable (Rule 2)
          nullable: true
          description: |
            Additional auth event metadata (device info, location, etc.). Uses
            additionalProperties because the metadata content is determined by the
            Auth service's event payload and varies by auth provider — Connect
            treats it as opaque context for logging (client-opaque pass-through
            per FOUNDATION TENETS). No Bannou plugin reads specific keys from
            this field by convention.

    AuthEventType:
      type: string
      enum:
      - Login
      - Logout
      - TokenRefresh
      - PermissionChange
      description: Type of authentication event that occurred

    # Note: ServiceRegistrationEvent is defined in common-events.yaml
    # Use BeyondImmersion.BannouService.Events.ServiceRegistrationEvent

    ClientMessageEvent:
      type: object
      description: |
        Event for server-to-client push messaging.
        Allows services to send messages directly to connected WebSocket clients.
      additionalProperties: false
      required:
      - clientId
      - serviceGuid
      - messageId
      - payload
      properties:
        clientId:
          type: string
          format: uuid
          description: Target client session ID
        serviceName:
          type: string
          # NRT: Optional string MUST be nullable (Rule 2)
          nullable: true
          description: Name of the service sending the message
        serviceGuid:
          type: string
          format: uuid
          description: Service GUID for routing
        messageId:
          type: integer
          format: int64
          description: Unique message ID for correlation
        payload:
          type: string
          format: byte
          description: Message payload (binary data)
        flags:
          $ref: '#/components/schemas/MessageFlags'
          description: Bit flags controlling message behavior (binary, encrypted, compressed, etc.)
        channel:
          type: integer
          format: uint16
          description: Channel for message routing
          default: 0
        timestamp:
          type: string
          format: date-time
          # NRT: Optional string MUST be nullable (Rule 2)
          nullable: true
          description: When the message was sent

    ClientRPCEvent:
      type: object
      description: |
        Event for bidirectional RPC where services call clients and expect responses.
        Extends ClientMessageEvent with response handling.
      additionalProperties: false
      required:
      - clientId
      - serviceGuid
      - messageId
      - payload
      - responseChannel
      properties:
        clientId:
          type: string
          format: uuid
          description: Target client session ID
        serviceName:
          type: string
          # NRT: Optional string MUST be nullable (Rule 2)
          nullable: true
          description: Name of the service making the RPC call
        serviceGuid:
          type: string
          format: uuid
          description: Service GUID for routing
        messageId:
          type: integer
          format: int64
          description: Unique message ID for correlation
        payload:
          type: string
          format: byte
          description: RPC request payload (binary data)
        flags:
          $ref: '#/components/schemas/MessageFlags'
          description: Bit flags controlling message behavior (binary, encrypted, compressed, etc.)
        channel:
          type: integer
          format: uint16
          description: Channel for message routing
          default: 0
        responseChannel:
          type: string
          description: RabbitMQ channel for sending response back to service
        timeoutSeconds:
          type: integer
          description: RPC timeout in seconds
          default: 30
        timestamp:
          type: string
          format: date-time
          # NRT: Optional string MUST be nullable (Rule 2)
          nullable: true
          description: When the RPC was initiated

    ClientRPCResponseEvent:
      type: object
      description: |
        Response event for bidirectional RPC from client back to service.
        Published by Connect when a client responds to a ClientRPCEvent.
      additionalProperties: false
      required:
      - clientId
      - messageId
      - payload
      - responseCode
      properties:
        clientId:
          type: string
          format: uuid
          description: Client session ID that sent the response
        serviceName:
          type: string
          # NRT: Optional string MUST be nullable (Rule 2)
          nullable: true
          description: Name of the service that initiated the RPC
        serviceGuid:
          type: string
          format: uuid
          # NRT: Optional string MUST be nullable (Rule 2)
          nullable: true
          description: Service GUID from the original RPC
        messageId:
          type: integer
          format: int64
          description: Message ID for correlation with original request
        payload:
          type: string
          format: byte
          description: RPC response payload (binary data)
        responseCode:
          type: integer
          format: uint16
          description: Response code (0 = success, non-zero = error)
        timestamp:
          type: string
          format: date-time
          # NRT: Optional string MUST be nullable (Rule 2)
          nullable: true
          description: When the response was received

    # NOTE: MessageFlags already defined above in Binary Protocol Schemas section

    HttpMethodType:
      type: string
      description: HTTP method for endpoint invocation
      enum:
        - GET
        - POST
        - PUT
        - DELETE
        - PATCH

    ConnectionMode:
      type: string
      description: WebSocket connection mode controlling broadcast and response behavior
      enum:
        - External
        - Relayed
        - Internal

    InternalAuthMode:
      type: string
      description: Authentication mode for internal WebSocket connections
      enum:
        - ServiceToken
        - NetworkTrust

    BroadcastMode:
      type: string
      description: Broadcast directionality mode for multi-node Connect deployments
      enum:
        - None
        - Send
        - Receive
        - Both

    CompanionRoomMode:
      type: string
      description: How Connect manages companion chat rooms for WebSocket sessions
      enum:
        - Disabled
        - AutoJoinLazy
        - AutoJoin
        - Manual

    # Note: SessionShortcut, SessionShortcutMetadata, ShortcutPublishedEvent, and ShortcutRevokedEvent
    # are defined in common-client-events.yaml (they are client event types extending BaseClientEvent).
    # The formerly orphaned connect-shortcuts.yaml was a dead design document, not the source of truth.

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT access token containing user claims:
        - jti: Client/User ID
        - roles: Array of role claims (e.g., ["user", "administrator"])
        - scopes: Array of scope claims (e.g., ["connect", "account"])
        - services: Array of accessible service names

    ReconnectAuth:
      type: apiKey
      in: header
      name: Authorization
      description: |
        Reconnection token in format: "Reconnect <token>"
        Used to reconnect to existing WebSocket sessions.

tags:
- name: WebSocket Connection
  description: |
    WebSocket connection establishment and management.

    **Protocol Flow:**
    1. HTTP upgrade request with JWT authentication
    2. WebSocket connection established
    3. Binary protocol messages exchanged
    4. Automatic reconnection support during connection drops

security:
- BearerAuth: []
- ReconnectAuth: []

externalDocs:
  description: Binary Protocol Documentation
  url: https://github.com/your-org/bannou/docs/connect-protocol.md
