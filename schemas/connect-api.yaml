openapi: 3.0.0
info:
  title: Bannou Connect API
  version: 2.0.0
  description: |
    Real-time communication and WebSocket connection management for Bannou services.

    **POST-Only API Pattern**: This API uses POST for all service operations to support zero-copy
    WebSocket routing. Path parameters are passed in request bodies instead of URLs.
    See API-DESIGN.md for architectural rationale.

    **Exception**: The `/connect` WebSocket endpoint uses GET/POST for the HTTP upgrade handshake,
    which is required by the WebSocket protocol specification.

    This API handles:
    - WebSocket connection establishment with JWT authentication
    - Bi-directional real-time messaging between clients and services
    - Binary protocol with message flags, channels, and service routing
    - Client reconnection and session management
    - Integration with Dapr service mesh for service-to-service communication
    - Redis-backed connection state management

    ## Connection Protocol

    The connect service uses a custom binary protocol over WebSockets with the following features:

    - **Message Flags**: Control message behavior (binary, encrypted, compressed, high priority, events vs RPC)
    - **Channel System**: Support for sequential message processing on specific channels
    - **Service Routing**: Route messages to appropriate Dapr services via GUID-based service lookup
    - **Bi-directional RPC**: Services can make RPC calls back to connected clients
    - **Reconnection Support**: Clients can reconnect to existing sessions within a configurable time window

servers:
  - url: http://localhost:3500/v1.0/invoke/bannou/method
    description: Dapr sidecar endpoint (internal only)

paths:
  /internal/proxy:
    post:
      summary: Internal API proxy for stateless requests
      operationId: proxyInternalRequest
      tags:
        - Internal Proxy
      description: |
        Stateless HTTP proxy for internal requests that don't require persistent sessions.
        Applies permission validation and rate limiting based on agent role and context.
        Perfect for AI agents making one-off API calls or bulk operations.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InternalProxyRequest'
      responses:
        '200':
          description: Request proxied successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InternalProxyResponse'
        '403':
          description: Permission denied
        '404':
          description: Target service or endpoint not found
        '429':
          description: Rate limit exceeded

  # NOTE: Service routing mappings (service-name → app-id) are now in Orchestrator API
  # at /orchestrator/service-routing. Connect service handles client capabilities only.

  /client-capabilities:
    post:
      summary: Get client capability manifest (GUID → API mappings)
      operationId: getClientCapabilities
      tags:
        - Client Capabilities
      x-permissions:
        - role: user
          states: {}
      description: |
        Returns the capability manifest for the authenticated client's session.
        Maps client-salted GUIDs to available API endpoints based on the client's
        current permissions and session state.

        **Security**: Each client receives unique GUIDs for the same API endpoints.
        This prevents cross-session exploitation and enables per-client rate limiting.

        **Dynamic Updates**: Capabilities may change during a session when:
        - Role changes occur (admin promotion, etc.)
        - Subscription status changes
        - Session state transitions

        Clients should listen for capability update events via WebSocket to stay current.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetClientCapabilitiesRequest'
      responses:
        '200':
          description: Client capabilities retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClientCapabilitiesResponse'
        '401':
          description: Not authenticated - requires valid session
        '500':
          description: Error retrieving capabilities

  /connect:
    get:
      summary: Establish WebSocket connection
      description: |
        Initiates a WebSocket connection for real-time communication.
        Requires JWT authentication via Authorization header.
        
        **Connection Flow:**
        1. Send HTTP GET request with `Connection: Upgrade` and `Upgrade: websocket` headers
        2. Include `Authorization: Bearer <jwt_token>` header for authentication
        3. Server validates JWT and extracts user claims (roles, scopes, services)
        4. Connection upgrades to WebSocket protocol
        5. Client can send binary messages using the custom protocol
        
        **Reconnection:**
        For existing sessions, use `Authorization: Reconnect <reconnect_token>` instead.
      operationId: ConnectWebSocket
      tags:
        - WebSocket Connection
      x-controller-only: true
      parameters:
        - name: Connection
          in: header
          required: true
          schema:
            type: string
            enum: ["Upgrade"]
          description: Must be "Upgrade" to initiate WebSocket connection
        - name: Upgrade
          in: header
          required: true
          schema:
            type: string
            enum: ["websocket"]
          description: Must be "websocket" to specify protocol upgrade
        - name: Authorization
          in: header
          required: true
          schema:
            type: string
          description: |
            JWT Bearer token for new connections: "Bearer <jwt_token>"
            Reconnect token for existing sessions: "Reconnect <reconnect_token>"
          examples:
            new-connection:
              summary: New connection with JWT
              value: "Bearer eyJhbGciOiJSUzUxMiIsInR5cCI6IkpXVCJ9..."
            reconnection:
              summary: Reconnect to existing session
              value: "Reconnect abc123def456..."
      responses:
        '101':
          description: WebSocket connection established successfully
          headers:
            Upgrade:
              schema:
                type: string
                enum: ["websocket"]
              description: Confirms protocol upgrade to WebSocket
            Connection:
              schema:
                type: string
                enum: ["Upgrade"]
              description: Confirms connection upgrade
        '400':
          description: Bad request - missing required headers or invalid request format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConnectErrorResponse'
              examples:
                missing-authorization:
                  summary: Missing authorization header
                  value:
                    error: "BadRequest"
                    message: "Authorization header is required for WebSocket connections"
                    status_code: 400
                not-websocket:
                  summary: Not a WebSocket request
                  value:
                    error: "BadRequest"
                    message: "Request must be a WebSocket upgrade request"
                    status_code: 400
        '403':
          description: Forbidden - invalid JWT token or reconnection token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConnectErrorResponse'
              examples:
                invalid-jwt:
                  summary: Invalid or expired JWT token
                  value:
                    error: "Forbidden"
                    message: "Invalid or expired authentication token"
                    status_code: 403
                reconnect-failed:
                  summary: Reconnection token not found or expired
                  value:
                    error: "Forbidden"
                    message: "Reconnection token is invalid or expired"
                    status_code: 403
        '500':
          description: Internal server error during connection setup
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConnectErrorResponse'
              examples:
                server-error:
                  summary: Internal server error
                  value:
                    error: "InternalServerError"
                    message: "An error occurred establishing the WebSocket connection"
                    status_code: 500
    post:
      summary: Establish WebSocket connection (POST variant)
      description: |
        Alternative POST method for establishing WebSocket connections.
        Functionally identical to the GET method but supports clients that
        require POST for WebSocket upgrades.
      operationId: ConnectWebSocketPost
      tags:
        - WebSocket Connection
      x-controller-only: true
      parameters:
        - name: Connection
          in: header
          required: true
          schema:
            type: string
            enum: ["Upgrade"]
        - name: Upgrade
          in: header
          required: true
          schema:
            type: string
            enum: ["websocket"]
        - name: Authorization
          in: header
          required: true
          schema:
            type: string
      requestBody:
        description: Optional connection parameters
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConnectRequest'
            examples:
              empty-request:
                summary: Standard connection request
                value: {}
      responses:
        '101':
          description: WebSocket connection established successfully
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConnectErrorResponse'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConnectErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConnectErrorResponse'

components:
  schemas:
    # Request Models for POST-only pattern
    GetClientCapabilitiesRequest:
      type: object
      description: Request to get client capability manifest (empty body allowed)
      properties:
        serviceFilter:
          type: string
          description: Optional filter by service name prefix
          nullable: true
        includeMetadata:
          type: boolean
          description: Include additional metadata about each capability
          default: false

    ClientCapabilitiesResponse:
      type: object
      required:
        - sessionId
        - capabilities
        - version
        - generatedAt
      properties:
        sessionId:
          type: string
          description: Session ID this capability manifest belongs to
        capabilities:
          type: array
          items:
            $ref: '#/components/schemas/ClientCapability'
          description: Available API capabilities for this client
        version:
          type: integer
          description: Capability manifest version (increments on changes)
        generatedAt:
          type: string
          format: date-time
          description: When this capability manifest was generated
        expiresAt:
          type: string
          format: date-time
          description: When these capabilities expire and need refresh
          nullable: true

    ClientCapability:
      type: object
      required:
        - guid
        - service
        - endpoint
        - method
      properties:
        guid:
          type: string
          format: uuid
          description: Client-salted GUID for this API endpoint (unique per session)
        service:
          type: string
          description: Service name (e.g., "accounts", "auth")
        endpoint:
          type: string
          description: API endpoint path (e.g., "/accounts/create")
        method:
          type: string
          enum: [GET, POST, PUT, DELETE, PATCH]
          description: HTTP method for this endpoint
        description:
          type: string
          description: Human-readable description of this capability
          nullable: true
        channel:
          type: integer
          format: uint16
          description: Preferred WebSocket channel for this capability
          default: 0

    InternalProxyRequest:
      type: object
      required:
        - sessionId
        - targetService
        - targetEndpoint
        - method
      properties:
        sessionId:
          type: string
          description: WebSocket session ID making the request
        targetService:
          type: string
          description: Target service name (e.g., "accounts", "auth", "behavior")
        targetEndpoint:
          type: string
          description: Target API endpoint path (e.g., "/accounts/{id}")
        method:
          type: string
          enum: [GET, POST, PUT, DELETE, PATCH]
          description: HTTP method for the target endpoint
        headers:
          type: object
          additionalProperties:
            type: string
          description: Additional headers to forward to the service
        body:
          type: object
          additionalProperties: true
          description: Request body to forward to target service
        pathParameters:
          type: object
          additionalProperties:
            type: string
          description: Path parameters for the endpoint
        queryParameters:
          type: object
          additionalProperties:
            type: string
          description: Query string parameters for the endpoint

    InternalProxyResponse:
      type: object
      required:
        - success
        - statusCode
      properties:
        success:
          type: boolean
          description: Whether the proxy request was successful
        statusCode:
          type: integer
          description: HTTP status code from the target service
        response:
          type: string
          description: JSON response from the target service (as string)
        headers:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          description: Response headers from the target service
        error:
          type: string
          description: Error message if the request failed
        executionTime:
          type: integer
          description: Request execution time in milliseconds


    ConnectRequest:
      type: object
      description: |
        Request model for WebSocket connection establishment.
        Currently contains no specific fields but extends the base ApiRequest.
      properties: {}
      additionalProperties: false

    ConnectionData:
      type: object
      description: |
        Connection state data returned for connection service requests.
        Currently a placeholder for future connection metadata.
      properties: {}
      additionalProperties: false

    ConnectErrorResponse:
      type: object
      required:
        - error
        - message
        - status_code
      properties:
        error:
          type: string
          description: Error type identifier
          enum:
            - "BadRequest"
            - "Forbidden"
            - "InternalServerError"
        message:
          type: string
          description: Human-readable error description
        status_code:
          type: integer
          description: HTTP status code
          enum: [400, 403, 500]
      additionalProperties: false

    # NOTE: ServiceMappingsResponse moved to Orchestrator API as ServiceRoutingResponse

    # Binary Protocol Schemas (for documentation purposes)
    MessageFlags:
      type: integer
      format: byte
      description: |
        Bit flags controlling message behavior in the enhanced 31-byte binary protocol.

        **Flags:**
        - 0x00 (None): Default - JSON text, service request, unencrypted, standard priority, expects response
        - 0x01 (Binary): Message payload is binary data (not JSON)
        - 0x02 (Encrypted): Message payload is encrypted
        - 0x04 (Compressed): Message payload is compressed (gzip)
        - 0x08 (HighPriority): Deliver at high priority, skip to front of queues
        - 0x10 (Event): Fire-and-forget message, no response expected
        - 0x20 (Client): Route to another WebSocket client (not a Dapr service)
        - 0x40 (Response): Message is a response to an RPC (not a new request)
        - 0x80 (Reserved): Reserved for future use
      minimum: 0
      maximum: 255
      example: 0

    ResponseCodes:
      type: integer
      format: byte
      enum:
        - 0   # OK
        - 10  # RequestError
        - 11  # RequestTooLarge
        - 12  # TooManyRequests
        - 13  # InvalidRequestChannel
        - 20  # Unauthorized
        - 30  # ServiceNotFound
        - 31  # ClientNotFound
        - 32  # MessageNotFound
        - 50  # Service_BadRequest
        - 51  # Service_NotFound
        - 52  # Service_Unauthorized
        - 53  # Service_Conflict
        - 60  # Service_InternalServerError
      x-enumNames:
        - "OK"
        - "RequestError"
        - "RequestTooLarge"
        - "TooManyRequests"
        - "InvalidRequestChannel"
        - "Unauthorized"
        - "ServiceNotFound"
        - "ClientNotFound"
        - "MessageNotFound"
        - "Service_BadRequest"
        - "Service_NotFound"
        - "Service_Unauthorized"
        - "Service_Conflict"
        - "Service_InternalServerError"
      description: |
        Response codes used in the binary protocol for success/error indication.
        Provides fine-grained error reporting for different failure scenarios.
      example: 0

    ServiceRequestMessage:
      type: object
      description: |
        Structure of a service request message in the enhanced 31-byte binary protocol.
        This schema is for documentation - actual messages are binary.

        **Binary Header Layout (31 bytes):**
        - Bytes 0: Message Flags (1 byte)
        - Bytes 1-2: Channel ID (2 bytes, big-endian)
        - Bytes 3-6: Sequence Number (4 bytes, big-endian)
        - Bytes 7-22: Service GUID (16 bytes)
        - Bytes 23-30: Message ID (8 bytes)
        - Bytes 31+: Payload (variable length)
      required:
        - flags
        - channel
        - sequenceNumber
        - serviceGuid
        - messageId
        - payload
      properties:
        flags:
          $ref: '#/components/schemas/MessageFlags'
        channel:
          type: integer
          format: uint16
          description: Channel for sequential message processing (0-65535, 0 = default)
        sequenceNumber:
          type: integer
          format: uint32
          description: Per-channel sequence number for message ordering
        serviceGuid:
          type: string
          format: uuid
          description: Client-salted service GUID for routing
        messageId:
          type: integer
          format: int64
          description: Unique message ID for request/response correlation
        payload:
          type: string
          format: byte
          description: Message payload (JSON or binary data based on flags)

    ServiceResponseMessage:
      type: object
      description: |
        Structure of a service response message in the enhanced 31-byte binary protocol.
        This schema is for documentation - actual messages are binary.

        **Binary Header Layout (31 bytes):**
        - Same as ServiceRequestMessage but with Response flag (0x40) set
      required:
        - flags
        - channel
        - sequenceNumber
        - serviceGuid
        - messageId
        - responseCode
      properties:
        flags:
          $ref: '#/components/schemas/MessageFlags'
          description: Must have Response flag (0x40) set
        channel:
          type: integer
          format: uint16
          description: Matches the request channel
        sequenceNumber:
          type: integer
          format: uint32
          description: Matches the request sequence number
        serviceGuid:
          type: string
          format: uuid
          description: Matches the request service GUID
        messageId:
          type: integer
          format: int64
          description: Matches the request message ID
        responseCode:
          $ref: '#/components/schemas/ResponseCodes'
        payload:
          type: string
          format: byte
          description: Optional response payload
          nullable: true

    ConnectionConfiguration:
      type: object
      description: |
        Configuration options for the connect service.
        These are server-side settings and not directly exposed via API.
      properties:
        obfuscate_not_found_response:
          type: boolean
          description: Return Unauthorized instead of NotFound for better security
          default: true
        client_request_max_size:
          type: integer
          format: uint32
          description: Maximum size for client requests in bytes
          default: 16384
        client_response_max_size:
          type: integer
          format: uint32
          description: Maximum size for client responses in bytes
          default: 16384
        client_reconnection_time:
          type: integer
          format: uint32
          description: Time in seconds to allow client reconnection
          default: 30
        token_public_key:
          type: string
          description: Base64-encoded RSA public key for JWT validation

    # RabbitMQ Event Models for Real-time Communication
    SessionCapabilityUpdateEvent:
      type: object
      description: |
        Event published when a session's capabilities change (permissions, role changes, etc.).
        Triggers real-time WebSocket updates to connected clients.
      required:
        - sessionId
        - version
      properties:
        sessionId:
          type: string
          description: Session ID that had capability changes
        addedCapabilities:
          type: array
          items:
            type: string
          description: New capabilities added to the session
        removedCapabilities:
          type: array
          items:
            type: string
          description: Capabilities removed from the session
        updatedServices:
          type: array
          items:
            type: string
          description: Services that had permission changes
        version:
          type: integer
          description: New capability version number
        expiresAt:
          type: string
          format: date-time
          description: When these capabilities expire and need refresh

    AuthEvent:
      type: object
      description: |
        Authentication state change events (login, logout, token refresh).
        Triggers session capability updates for connected clients.
      required:
        - sessionId
        - eventType
        - timestamp
      properties:
        sessionId:
          type: string
          description: Session ID affected by the auth event
        eventType:
          $ref: '#/components/schemas/AuthEventType'
        timestamp:
          type: string
          format: date-time
          description: When the auth event occurred
        userId:
          type: string
          description: User ID associated with the session (optional for some events)
        metadata:
          type: object
          additionalProperties: true
          description: Additional event metadata (device info, location, etc.)

    AuthEventType:
      type: string
      enum:
        - Login
        - Logout
        - TokenRefresh
        - PermissionChange
      description: Type of authentication event that occurred

    # Note: ServiceRegistrationEvent is defined in common-events.yaml
    # Use BeyondImmersion.BannouService.Events.ServiceRegistrationEvent

    ClientMessageEvent:
      type: object
      description: |
        Event for server-to-client push messaging.
        Allows services to send messages directly to connected WebSocket clients.
      required:
        - clientId
        - serviceGuid
        - messageId
        - payload
      properties:
        clientId:
          type: string
          description: Target client session ID
        serviceName:
          type: string
          description: Name of the service sending the message
        serviceGuid:
          type: string
          format: uuid
          description: Service GUID for routing
        messageId:
          type: integer
          format: int64
          description: Unique message ID for correlation
        payload:
          type: string
          format: byte
          description: Message payload (binary data)
        flags:
          $ref: '#/components/schemas/MessageFlags'
        channel:
          type: integer
          format: uint16
          description: Channel for message routing
          default: 0
        timestamp:
          type: string
          format: date-time
          description: When the message was sent

    ClientRPCEvent:
      type: object
      description: |
        Event for bidirectional RPC where services call clients and expect responses.
        Extends ClientMessageEvent with response handling.
      required:
        - clientId
        - serviceGuid
        - messageId
        - payload
        - responseChannel
      properties:
        clientId:
          type: string
          description: Target client session ID
        serviceName:
          type: string
          description: Name of the service making the RPC call
        serviceGuid:
          type: string
          format: uuid
          description: Service GUID for routing
        messageId:
          type: integer
          format: int64
          description: Unique message ID for correlation
        payload:
          type: string
          format: byte
          description: RPC request payload (binary data)
        flags:
          $ref: '#/components/schemas/MessageFlags'
        channel:
          type: integer
          format: uint16
          description: Channel for message routing
          default: 0
        responseChannel:
          type: string
          description: RabbitMQ channel for sending response back to service
        timeoutSeconds:
          type: integer
          description: RPC timeout in seconds
          default: 30
        timestamp:
          type: string
          format: date-time
          description: When the RPC was initiated

    MessageFlags:
      type: integer
      format: byte
      description: |
        Bit flags for binary protocol message control.

        Bit meanings:
        - 0x01: Binary payload (vs JSON)
        - 0x02: Encrypted payload
        - 0x04: Compressed payload
        - 0x08: Priority message
        - 0x10: Requires acknowledgment
        - 0x20: Broadcast message
        - 0x40: Response message
        - 0x80: Control message
      minimum: 0
      maximum: 255
      default: 0

    PermissionRecompileEvent:
      type: object
      description: |
        Event to trigger permission recompilation for all sessions.
        Published when services register new APIs or permission rules change.
      required:
        - eventId
        - timestamp
        - reason
      properties:
        eventId:
          type: string
          description: Unique identifier for this recompilation event
        timestamp:
          type: string
          format: date-time
          description: When the recompilation was triggered
        reason:
          type: string
          enum:
            - service_registered
            - permission_rules_changed
            - role_definitions_updated
            - manual_trigger
          description: Reason for triggering permission recompilation
        serviceId:
          type: string
          description: Service ID that triggered the recompilation (if applicable)
        metadata:
          type: object
          additionalProperties: true
          description: Additional context for the recompilation

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT access token containing user claims:
        - jti: Client/User ID
        - roles: Array of role claims (e.g., ["user", "administrator"])
        - scopes: Array of scope claims (e.g., ["connect", "accounts"])
        - services: Array of accessible service names

    ReconnectAuth:
      type: apiKey
      in: header
      name: Authorization
      description: |
        Reconnection token in format: "Reconnect <token>"
        Used to reconnect to existing WebSocket sessions.

tags:
  - name: WebSocket Connection
    description: |
      WebSocket connection establishment and management.
      
      **Protocol Flow:**
      1. HTTP upgrade request with JWT authentication
      2. WebSocket connection established
      3. Binary protocol messages exchanged
      4. Automatic reconnection support during connection drops

security:
  - BearerAuth: []
  - ReconnectAuth: []

x-service-configuration:
  properties:
    MaxConcurrentConnections:
      type: integer
      description: Maximum number of concurrent WebSocket connections
      default: 10000
    ConnectionTimeoutSeconds:
      type: integer
      description: WebSocket connection timeout in seconds
      default: 300
    HeartbeatIntervalSeconds:
      type: integer
      description: Interval between heartbeat messages
      default: 30
    MessageQueueSize:
      type: integer
      description: Maximum number of queued messages per connection
      default: 1000
    BinaryProtocolVersion:
      type: string
      description: Binary protocol version identifier
      default: "2.0"
    BufferSize:
      type: integer
      description: Size of message buffers in bytes
      default: 65536
    DefaultServices:
      type: array
      items:
        type: string
      description: Services available to unauthenticated connections
      default: ["auth", "website"]
    AuthenticatedServices:
      type: array
      items:
        type: string
      description: Additional services available to authenticated connections
      default: ["accounts", "behavior", "permissions", "gamesession"]
    EnableClientToClientRouting:
      type: boolean
      description: Enable routing messages between WebSocket clients
      default: true
    MaxMessagesPerMinute:
      type: integer
      description: Rate limit for messages per minute per client
      default: 1000
    RateLimitWindowMinutes:
      type: integer
      description: Rate limit window in minutes
      default: 1
    JwtPublicKey:
      type: string
      description: RSA public key for JWT validation (PEM format)

# Note: Event subscriptions are handled manually in ConnectEventsController.cs
# because they require specialized CloudEvents parsing and custom service method calls.
# Topics subscribed: session.invalidated, permissions.capabilities-updated

externalDocs:
  description: Binary Protocol Documentation
  url: https://github.com/your-org/bannou/docs/connect-protocol.md
