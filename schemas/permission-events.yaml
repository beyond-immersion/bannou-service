openapi: 3.0.4
info:
  title: Permission Service Events
  description: |
    Event models for Permission service RabbitMQ pub/sub via MassTransit.
    Handles session state management and capability compilation.

    **SCHEMA MODIFICATION GATE**: STOP. Before modifying this schema, you MUST:
    1. Read docs/reference/SCHEMA-RULES.md
    2. State which section applies to your change
    3. Only then proceed with edits
    Edits without stating the applicable rule are FORBIDDEN.
  version: 1.0.0
  x-event-subscriptions:
    # Session updates from Auth service (role/authorization changes).
    # This is the only remaining event subscription. Session connected/disconnected
    # are now handled via ISessionActivityListener DI listener pattern (GH#392)
    # since Connect and Permission are both L1 AppFoundation (always co-located).
    - topic: session.updated
      event: SessionUpdatedEvent
      handler: HandleSessionUpdated
  x-event-publications:
    # Permission capability updates sent to Connect service
    - topic: permission.capability-update
      event: PermissionCapabilityUpdate
      description: Published when session capabilities are compiled or updated

paths: {}  # Events don't have HTTP paths

components:
  schemas:
    # NOTE: Events the Permission service subscribes to (ServiceRegistrationEvent, SessionConnectedEvent, etc.)
    # are defined in their canonical locations and accessed via BeyondImmersion.BannouService.Events namespace

    PermissionCapabilityUpdate:
      allOf:
        - $ref: 'common-events.yaml#/components/schemas/BaseServiceEvent'
      type: object
      additionalProperties: false
      description: |
        Event published to specific Connect service instances (CONNECT_{session_id} channel).
        Contains compiled permission capabilities for a session with optional delta updates.
      required:
        - eventName
        - eventId
        - timestamp
        - sessionId
        - version
        - updateType
      properties:
        eventName:
          type: string
          default: "permission.capability-update"
          description: Fixed event type identifier
        sessionId:
          type: string
          format: uuid
          description: Session ID that had capability changes
        version:
          type: integer
          minimum: 0
          description: New capability version number (increments on each update)
        updateType:
          $ref: 'permission-api.yaml#/components/schemas/CapabilityUpdateType'
          description: Type of update â€” full capabilities or delta changes
        fullCapabilities:
          type: object
          nullable: true
          additionalProperties:
            type: array
            items:
              type: string
          description: |
            Complete capability map (for full updates or initial connection).
            Key: service_id, Value: array of allowed endpoints.
        addedCapabilities:
          type: object
          nullable: true
          additionalProperties:
            type: array
            items:
              type: string
          description: |
            New capabilities added to the session (for delta updates).
            Same format as fullCapabilities.
        removedCapabilities:
          type: object
          nullable: true
          additionalProperties:
            type: array
            items:
              type: string
          description: |
            Capabilities removed from the session (for delta updates).
            Same format as fullCapabilities.
        generatedAt:
          type: string
          format: date-time
          nullable: true
          description: When these capabilities were compiled
        expiresAt:
          type: string
          format: date-time
          nullable: true
          description: When these capabilities expire and need refresh
        reason:
          $ref: 'permission-api.yaml#/components/schemas/CapabilityUpdateReason'
          nullable: true
          description: Reason for the capability update

