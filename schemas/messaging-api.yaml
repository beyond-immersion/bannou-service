openapi: 3.0.4
info:
  title: Bannou Messaging Service API
  description: |
    Native RabbitMQ pub/sub messaging with native serialization.

    **INTERNAL SERVICE API**: These endpoints use empty x-permissions (internal-only).
    Service-to-service calls within the cluster are always permitted (per FOUNDATION TENETS).

    **POST-Only API Pattern**: All endpoints use POST with request bodies for
    consistency with WebSocket routing architecture.

    **SCHEMA MODIFICATION GATE**: STOP. Before modifying this schema, you MUST:
    1. Read docs/reference/SCHEMA-RULES.md
    2. State which section applies to your change
    3. Only then proceed with edits
    Edits without stating the applicable rule are FORBIDDEN.

  version: 1.0.0
x-service-layer: Infrastructure
servers:
- url: http://localhost:5012
  description: Bannou service endpoint

paths:
  /messaging/publish:
    post:
      operationId: publishEvent
      summary: Publish an event to a topic
      tags:
      - Messaging
      x-permissions: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PublishEventRequest'
      responses:
        '200':
          description: Event published successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PublishEventResponse'

  /messaging/subscribe:
    post:
      operationId: createSubscription
      summary: Create a dynamic subscription to a topic
      tags:
      - Messaging
      x-permissions: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateSubscriptionRequest'
      responses:
        '200':
          description: Subscription created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateSubscriptionResponse'

  /messaging/unsubscribe:
    post:
      operationId: removeSubscription
      summary: Remove a dynamic subscription
      tags:
      - Messaging
      x-permissions: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RemoveSubscriptionRequest'
      responses:
        '200':
          description: Subscription removed successfully
        '404':
          description: Subscription not found or no longer active

  /messaging/list-topics:
    post:
      operationId: listTopics
      summary: List all known topics
      tags:
      - Messaging
      x-permissions: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ListTopicsRequest'
      responses:
        '200':
          description: List of topics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListTopicsResponse'

components:
  schemas:
    PublishEventRequest:
      description: Request to publish an event to a messaging topic
      type: object
      additionalProperties: false
      required:
      - topic
      - payload
      properties:
        topic:
          type: string
          minLength: 1
          description: Topic/routing key for the event
        payload:
          type: object
          additionalProperties: true
          description: >-
            Arbitrary event payload (any valid JSON object). Wrapped opaquely in
            GenericMessageEnvelope for RabbitMQ routing. No Bannou plugin reads
            specific keys from this field by convention.
        options:
          $ref: '#/components/schemas/PublishOptions'
          nullable: true
          description: Optional publishing configuration for message delivery (null for defaults)

    PublishOptions:
      type: object
      description: Options for publishing messages to RabbitMQ
      additionalProperties: false
      properties:
        exchange:
          type: string
          default: bannou
          minLength: 1
          description: Exchange name for routing
        routingKey:
          type: string
          nullable: true
          description: Routing key for direct/topic exchanges (required for topic exchanges, ignored for fanout)
        exchangeType:
          $ref: '#/components/schemas/ExchangeType'
          default: topic
          nullable: true
          description: Exchange type - determines how messages are routed (topic routes by routing key pattern)
        persistent:
          type: boolean
          default: true
          description: Whether the message should be persisted to disk
        priority:
          type: integer
          minimum: 0
          maximum: 9
          default: 0
          description: Message priority (0-9)
        correlationId:
          type: string
          format: uuid
          nullable: true
          description: Correlation ID for request/response patterns
        expiration:
          type: string
          format: duration
          nullable: true
          description: Message expiration time (ISO 8601 duration format)
        headers:
          type: object
          additionalProperties: true
          nullable: true
          description: >-
            Caller-provided custom headers included with the message.
            No Bannou plugin reads specific keys from this field by convention.

    PublishEventResponse:
      description: Response confirming event publication with message identifier
      type: object
      additionalProperties: false
      required:  # NRT: Response properties server always sets (Rule 4)
      - messageId
      properties:
        messageId:
          type: string
          format: uuid
          description: Unique identifier assigned to the published message

    CreateSubscriptionRequest:
      description: Request to create a new subscription to a messaging topic
      type: object
      additionalProperties: false
      required:
      - topic
      - callbackUrl
      properties:
        topic:
          type: string
          minLength: 1
          description: Topic pattern to subscribe to for receiving events
        callbackUrl:
          type: string
          format: uri
          minLength: 1
          description: HTTP endpoint to receive events
        options:
          $ref: '#/components/schemas/SubscriptionOptions'
          nullable: true
          description: Optional subscription configuration for queue behavior (null for defaults)

    SubscriptionOptions:
      type: object
      description: Options for subscribing to RabbitMQ topics
      additionalProperties: false
      properties:
        durable:
          type: boolean
          default: true
          description: Whether the queue should survive broker restarts
        exclusive:
          type: boolean
          default: false
          description: Whether only this connection can consume from the queue
        autoAck:
          type: boolean
          nullable: true
          description: Whether messages should be auto-acknowledged (null uses DefaultAutoAck config)
        prefetchCount:
          type: integer
          default: 10
          minimum: 1
          maximum: 10000
          description: Number of messages to prefetch
        useDeadLetter:
          type: boolean
          default: true
          description: Whether to use dead letter exchange for failed messages
        consumerGroup:
          type: string
          nullable: true
          description: Name of the consumer group for load balancing

    CreateSubscriptionResponse:
      description: Response containing the created subscription details
      type: object
      additionalProperties: false
      required:  # NRT: Response properties server always sets (Rule 4)
      - subscriptionId
      - queueName
      properties:
        subscriptionId:
          type: string
          format: uuid
          description: Unique identifier for the created subscription
        queueName:
          type: string
          description: Name of the RabbitMQ queue created for this subscription

    RemoveSubscriptionRequest:
      description: Request to remove an existing subscription
      type: object
      additionalProperties: false
      required:
      - subscriptionId
      properties:
        subscriptionId:
          type: string
          format: uuid
          description: Unique identifier of the subscription to remove

    ListTopicsRequest:
      type: object
      description: Optional filters for topic listing (empty object returns all)
      additionalProperties: false
      properties:
        exchangeFilter:
          type: string
          nullable: true  # NRT: Optional string MUST be nullable (Rule 2)
          description: Filter topics by exchange name prefix

    ListTopicsResponse:
      description: Response containing a list of available messaging topics
      type: object
      additionalProperties: false
      required:  # NRT: Response properties server always sets (Rule 4)
      - topics
      properties:
        topics:
          type: array
          description: List of topics matching the filter criteria
          items:
            $ref: '#/components/schemas/TopicInfo'

    TopicInfo:
      description: Information about a messaging topic including its name and statistics
      type: object
      additionalProperties: false
      required:  # NRT: Response properties server always sets (Rule 4)
      - name
      - consumerCount
      properties:
        name:
          type: string
          description: Name of the topic/exchange
        consumerCount:
          type: integer
          description: Number of active consumers subscribed to this topic

    ExchangeType:
      type: string
      description: RabbitMQ exchange type determining how messages are routed
      enum: [fanout, direct, topic]

    DeadLetterOverflowBehavior:
      type: string
      description: Behavior when DLX queue exceeds max length (drop-head drops oldest, reject-publish blocks new messages)
      enum: [drop-head, reject-publish]
