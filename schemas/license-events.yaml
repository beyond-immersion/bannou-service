openapi: 3.0.3
info:
  title: License Service Events
  description: |
    Event subscription and publication declarations for License service.
    Lifecycle events (Created, Updated, Deleted) are auto-generated from x-lifecycle
    for both LicenseBoardTemplate and LicenseBoard entities.
    Custom events cover license unlock outcomes.

    **Event Categories**:
    - Board template lifecycle: created, updated, deleted (auto-generated)
    - Board instance lifecycle: created, updated, deleted (auto-generated)
    - Unlock events: license.unlocked, license.unlock-failed

    **Consumed Events**:
    - character.deleted: Cleanup all boards for deleted character

    **Topic Naming**: Uses dot-separated format (license.unlocked).

    **SCHEMA MODIFICATION GATE**: STOP. Before modifying this schema, you MUST:
    1. Read docs/reference/SCHEMA-RULES.md
    2. State which section applies to your change
    3. Only then proceed with edits
    Edits without stating the applicable rule are FORBIDDEN.
  version: 1.0.0
  x-event-publications:
    # Board template lifecycle events (auto-generated from x-lifecycle)
    - topic: license-board-template.created
      event: LicenseBoardTemplateCreatedEvent
      description: Published when a new board template is created
    - topic: license-board-template.updated
      event: LicenseBoardTemplateUpdatedEvent
      description: Published when a board template is updated
    - topic: license-board-template.deleted
      event: LicenseBoardTemplateDeletedEvent
      description: Published when a board template is deleted

    # Board instance lifecycle events (auto-generated from x-lifecycle)
    - topic: license-board.created
      event: LicenseBoardCreatedEvent
      description: Published when a board instance is created for a character
    - topic: license-board.updated
      event: LicenseBoardUpdatedEvent
      description: Published when a board instance is updated
    - topic: license-board.deleted
      event: LicenseBoardDeletedEvent
      description: Published when a board instance is deleted

    # Custom unlock events
    - topic: license.unlocked
      event: LicenseUnlockedEvent
      description: Published when a license is successfully unlocked on a board
    - topic: license.unlock-failed
      event: LicenseUnlockFailedEvent
      description: Published when a license unlock attempt fails

# Lifecycle events auto-generated from this definition
# Output: schemas/Generated/license-lifecycle-events.yaml
x-lifecycle:
  LicenseBoardTemplate:
    model:
      boardTemplateId: { type: string, format: uuid, primary: true, required: true, description: "Unique board template identifier" }
      gameServiceId: { type: string, format: uuid, required: true, description: "Game service this template belongs to" }
      name: { type: string, required: true, description: "Display name for the board template" }
      gridWidth: { type: integer, required: true, description: "Width of the board grid (columns)" }
      gridHeight: { type: integer, required: true, description: "Height of the board grid (rows)" }
      boardContractTemplateId: { type: string, format: uuid, required: true, description: "Contract template that controls unlock behavior" }
      adjacencyMode: { $ref: 'license-api.yaml#/components/schemas/AdjacencyMode', required: true, description: "Grid traversal mode for this template" }
      isActive: { type: boolean, required: true, description: "Whether the template is active" }
      createdAt: { type: string, format: date-time, required: true, description: "When the template was created" }
      updatedAt: { type: string, format: date-time, nullable: true, description: "When the template was last updated" }
    sensitive: []

  LicenseBoard:
    model:
      boardId: { type: string, format: uuid, primary: true, required: true, description: "Unique board instance identifier" }
      characterId: { type: string, format: uuid, required: true, description: "Character this board belongs to" }
      boardTemplateId: { type: string, format: uuid, required: true, description: "Board template this instance was created from" }
      gameServiceId: { type: string, format: uuid, required: true, description: "Game service this board belongs to" }
      containerId: { type: string, format: uuid, required: true, description: "Inventory container holding unlocked license items" }
      createdAt: { type: string, format: date-time, required: true, description: "When this board instance was created" }
    sensitive: []

paths: {}  # Events don't have HTTP paths

# Note: LicenseBoardTemplateCreatedEvent, LicenseBoardTemplateUpdatedEvent, LicenseBoardTemplateDeletedEvent,
# LicenseBoardCreatedEvent, LicenseBoardUpdatedEvent, LicenseBoardDeletedEvent
# are auto-generated from x-lifecycle. See: schemas/Generated/license-lifecycle-events.yaml

components:
  schemas:
    # =========================================================================
    # Custom Published Events (non-lifecycle)
    # =========================================================================

    LicenseUnlockedEvent:
      type: object
      additionalProperties: false
      description: Published when a license is successfully unlocked on a board
      required:
      - eventId
      - timestamp
      - boardId
      - characterId
      - gameServiceId
      - licenseCode
      - position
      - itemInstanceId
      - contractInstanceId
      - lpCost
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique event identifier
        timestamp:
          type: string
          format: date-time
          description: When the unlock occurred
        boardId:
          type: string
          format: uuid
          description: Board instance the license was unlocked on
        characterId:
          type: string
          format: uuid
          description: Character who unlocked the license
        gameServiceId:
          type: string
          format: uuid
          description: Game service context
        licenseCode:
          type: string
          description: License code that was unlocked
        position:
          $ref: 'license-api.yaml#/components/schemas/GridPosition'
          description: Grid position of the unlocked license
        itemInstanceId:
          type: string
          format: uuid
          description: Item instance created for this license
        contractInstanceId:
          type: string
          format: uuid
          description: Contract instance created for this unlock
        lpCost:
          type: integer
          description: LP cost that was deducted

    LicenseUnlockFailedEvent:
      type: object
      additionalProperties: false
      description: Published when a license unlock attempt fails
      required:
      - eventId
      - timestamp
      - boardId
      - characterId
      - licenseCode
      - reason
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique event identifier
        timestamp:
          type: string
          format: date-time
          description: When the failure occurred
        boardId:
          type: string
          format: uuid
          description: Board instance the unlock was attempted on
        characterId:
          type: string
          format: uuid
          description: Character who attempted the unlock
        licenseCode:
          type: string
          description: License code that failed to unlock
        reason:
          $ref: 'license-api.yaml#/components/schemas/UnlockFailureReason'
          description: Why the unlock attempt failed
