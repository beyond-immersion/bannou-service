openapi: 3.0.4
info:
  title: Game Session Client Events API
  description: |
    Server-to-client push events for the Game Session service.
    These events notify clients of game session state changes, player actions,
    chat messages, and game state updates delivered via WebSocket.

    All events inherit from BaseClientEvent (common-client-events.yaml) and use
    the "game_session.{event_type}" naming convention.

    **SCHEMA MODIFICATION GATE**: STOP. Before modifying this schema, you MUST:
    1. Read docs/reference/SCHEMA-RULES.md
    2. State which section applies to your change
    3. Only then proceed with edits
    Edits without stating the applicable rule are FORBIDDEN.
  version: 1.0.0
  contact:
    name: Bannou Development Team

servers: []

paths: {}

components:
  schemas:
    # ============================================
    # Session Lifecycle Events
    # ============================================

    SessionStateChangedClientEvent:
      allOf:
        - $ref: 'common-client-events.yaml#/components/schemas/BaseClientEvent'
      type: object
      additionalProperties: false
      x-client-event: true
      description: |
        Sent to all session participants when the session state changes.
        Examples: session starts, pauses, resumes, or ends.
      required:
        - eventName
        - eventId
        - timestamp
        - sessionId
        - previousState
        - newState
      properties:
        eventName:
          type: string
          default: "game_session.state_changed"
          description: Fixed event type identifier
        sessionId:
          type: string
          format: uuid
          description: ID of the game session
        previousState:
          $ref: 'game-session-api.yaml#/components/schemas/SessionStatus'
          description: State before the change
        newState:
          $ref: 'game-session-api.yaml#/components/schemas/SessionStatus'
          description: State after the change
        reason:
          type: string
          nullable: true
          description: Reason for state change (e.g., "host_started", "timeout", "admin_action")
        changedBy:
          type: string
          format: uuid
          nullable: true
          description: Account ID of user who triggered the change (if applicable)

    # ============================================
    # Player Events
    # ============================================

    PlayerJoinedClientEvent:
      allOf:
        - $ref: 'common-client-events.yaml#/components/schemas/BaseClientEvent'
      type: object
      additionalProperties: false
      x-client-event: true
      description: |
        Sent to all session participants when a new player joins.
      required:
        - eventName
        - eventId
        - timestamp
        - sessionId
        - player
      properties:
        eventName:
          type: string
          default: "game_session.player_joined"
          description: Fixed event type identifier
        sessionId:
          type: string
          format: uuid
          description: ID of the game session
        player:
          $ref: '#/components/schemas/PlayerInfo'
          description: Information about the player who joined the session
        currentPlayerCount:
          type: integer
          nullable: true  # NRT: Optional property MUST be nullable
          description: Total players in session after join
        maxPlayers:
          type: integer
          nullable: true  # NRT: Optional property MUST be nullable
          description: Maximum allowed players

    PlayerLeftClientEvent:
      allOf:
        - $ref: 'common-client-events.yaml#/components/schemas/BaseClientEvent'
      type: object
      additionalProperties: false
      x-client-event: true
      description: |
        Sent to all session participants when a player leaves voluntarily.
      required:
        - eventName
        - eventId
        - timestamp
        - sessionId
        - playerId
      properties:
        eventName:
          type: string
          default: "game_session.player_left"
          description: Fixed event type identifier
        sessionId:
          type: string
          format: uuid
          description: ID of the game session
        playerId:
          type: string
          format: uuid
          description: Account ID of player who left
        displayName:
          type: string
          nullable: true
          description: Display name for UI notification
        currentPlayerCount:
          type: integer
          nullable: true  # NRT: Optional property MUST be nullable
          description: Total players remaining after departure
        newOwnerId:
          type: string
          format: uuid
          nullable: true
          description: New session owner if ownership transferred

    PlayerKickedClientEvent:
      allOf:
        - $ref: 'common-client-events.yaml#/components/schemas/BaseClientEvent'
      type: object
      additionalProperties: false
      x-client-event: true
      description: |
        Sent to all session participants when a player is kicked.
        The kicked player receives this before being removed from the session.
      required:
        - eventName
        - eventId
        - timestamp
        - sessionId
        - kickedPlayerId
        - kickedBy
      properties:
        eventName:
          type: string
          default: "game_session.player_kicked"
          description: Fixed event type identifier
        sessionId:
          type: string
          format: uuid
          description: ID of the game session
        kickedPlayerId:
          type: string
          format: uuid
          description: Account ID of player who was kicked
        kickedPlayerName:
          type: string
          nullable: true
          description: Display name for UI notification
        kickedBy:
          type: string
          format: uuid
          description: Account ID of user who performed the kick
        reason:
          type: string
          nullable: true
          description: Reason provided for the kick

    SessionCancelledClientEvent:
      allOf:
        - $ref: 'common-client-events.yaml#/components/schemas/BaseClientEvent'
      type: object
      additionalProperties: false
      x-client-event: true
      description: |
        Sent to players who claimed their reservation when a matchmade session
        is cancelled due to not enough players joining before reservation expiry.
      required:
        - eventName
        - eventId
        - timestamp
        - sessionId
        - reason
      properties:
        eventName:
          type: string
          default: "game_session.session_cancelled"
          description: Fixed event type identifier
        sessionId:
          type: string
          format: uuid
          description: ID of the cancelled game session
        reason:
          type: string
          description: Reason for cancellation

    # ============================================
    # Chat Events
    # ============================================

    SessionChatReceivedClientEvent:
      allOf:
        - $ref: 'common-client-events.yaml#/components/schemas/BaseClientEvent'
      type: object
      additionalProperties: false
      x-client-event: true
      description: |
        Sent to recipients when a chat message is posted in the session.
        Public messages go to all participants, whispers only to the target.
      required:
        - eventName
        - eventId
        - timestamp
        - sessionId
        - messageId
        - senderId
        - message
        - messageType
      properties:
        eventName:
          type: string
          default: "game_session.chat_received"
          description: Fixed event type identifier
        sessionId:
          type: string
          format: uuid
          description: ID of the game session
        messageId:
          type: string
          format: uuid
          description: Unique identifier for this chat message
        senderId:
          type: string
          format: uuid
          description: Account ID of message sender
        senderName:
          type: string
          nullable: true
          description: Display name of sender
        message:
          type: string
          description: Chat message content
        messageType:
          $ref: 'game-session-api.yaml#/components/schemas/ChatMessageType'
          description: Type of chat message
        isWhisperToMe:
          type: boolean
          default: false
          description: True if this is a whisper directed at the receiving client

    # ============================================
    # Game State Events
    # ============================================

    GameStateUpdatedClientEvent:
      allOf:
        - $ref: 'common-client-events.yaml#/components/schemas/BaseClientEvent'
      type: object
      additionalProperties: false
      x-client-event: true
      description: |
        Sent when game state changes that all players should see.
        Contains partial state updates rather than full state for efficiency.
      required:
        - eventName
        - eventId
        - timestamp
        - sessionId
        - updateType
      properties:
        eventName:
          type: string
          default: "game_session.state_updated"
          description: Fixed event type identifier
        sessionId:
          type: string
          format: uuid
          description: ID of the game session
        updateType:
          type: string
          description: Type of update (game-specific, e.g., "turn_changed", "score_updated")
        stateDelta:
          type: object
          additionalProperties: true
          nullable: true
          description: Partial game state changes. No Bannou plugin reads specific keys from this field by convention.
        triggeredBy:
          type: string
          format: uuid
          nullable: true
          description: Account ID that triggered the state change
        sequenceNumber:
          type: integer
          nullable: true  # NRT: Optional property MUST be nullable
          description: Monotonically increasing sequence for ordering state updates

    GameActionResultClientEvent:
      allOf:
        - $ref: 'common-client-events.yaml#/components/schemas/BaseClientEvent'
      type: object
      additionalProperties: false
      x-client-event: true
      description: |
        Sent to relevant players when a game action produces results.
        May be sent to all players or just the acting player depending on visibility rules.
      required:
        - eventName
        - eventId
        - timestamp
        - sessionId
        - actionId
        - actionType
        - success
      properties:
        eventName:
          type: string
          default: "game_session.action_result"
          description: Fixed event type identifier
        sessionId:
          type: string
          format: uuid
          description: ID of the game session
        actionId:
          type: string
          format: uuid
          description: ID of the action that produced this result
        actionType:
          $ref: 'game-session-api.yaml#/components/schemas/GameActionType'
          description: Type of action performed
        actorId:
          type: string
          format: uuid
          nullable: true  # NRT: Optional property MUST be nullable
          description: Account ID of player who performed the action
        success:
          type: boolean
          description: Whether the action succeeded
        resultData:
          type: object
          additionalProperties: true
          nullable: true
          description: Action-specific result data. No Bannou plugin reads specific keys from this field by convention.
        visibleEffects:
          type: array
          items:
            $ref: '#/components/schemas/VisibleEffect'
          nullable: true
          description: Visual/audio effects other players should see

    # ============================================
    # Supporting Types
    # ============================================

    PlayerInfo:
      type: object
      additionalProperties: false
      description: Information about a player in the session
      required:
        - accountId
        - role
      properties:
        accountId:
          type: string
          format: uuid
          description: Player's account ID
        displayName:
          type: string
          nullable: true
          description: Player's display name
        role:
          $ref: 'game-session-api.yaml#/components/schemas/PlayerRole'
          description: Player's role in the session
        characterData:
          type: object
          additionalProperties: true
          nullable: true
          description: Game-specific character data. No Bannou plugin reads specific keys from this field by convention.

    VisibleEffect:
      type: object
      additionalProperties: false
      description: A visual or audio effect that should be rendered
      required:
        - effectType
      properties:
        effectType:
          type: string
          description: Type of effect (e.g., "damage_number", "particle", "sound")
        targetId:
          type: string
          format: uuid
          nullable: true
          description: Entity the effect targets
        position:
          nullable: true  # NRT: Optional property MUST be nullable
          description: World position for the effect in 3D space coordinates
          allOf:
            - $ref: '#/components/schemas/Position'
        effectData:
          type: object
          additionalProperties: true
          nullable: true
          description: Effect-specific parameters. No Bannou plugin reads specific keys from this field by convention.

    Position:
      type: object
      additionalProperties: false
      description: 3D world coordinates representing a position in game space
      required:  # NRT: Required event properties
        - x
        - y
        - z
      properties:
        x:
          type: number
          description: X coordinate in world space
        y:
          type: number
          description: Y coordinate in world space
        z:
          type: number
          description: Z coordinate in world space
