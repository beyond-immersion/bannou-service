openapi: 3.0.3
info:
  title: Orchestrator API
  version: 3.0.0
  description: |
    **Central intelligence for Bannou environment management and service orchestration.**

    **POST-Only API Pattern**: This API uses POST for all operations to support zero-copy
    WebSocket routing. Path parameters are passed in request bodies instead of URLs.
    See docs/BANNOU_DESIGN.md for architectural rationale.

    The orchestrator service provides comprehensive environment lifecycle management:
    - **Environment Provisioning**: Deploy complete environments via API (replaces Makefile/docker-compose)
    - **Dynamic Service Topology**: Reconfigure which services run on which containers at runtime
    - **Multi-Backend Support**: Docker Compose, Docker Swarm, Portainer, and Kubernetes
    - **Infrastructure Health**: Monitor Redis, RabbitMQ, and custom services
    - **Smart Service Management**: Restart, scale, and configure services based on health metrics
    - **Deployment Presets**: Testing is configured via deployment presets (e.g., http-tests, edge-tests)

    **Backend Priority** (automatic detection):
    1. Kubernetes (most enterprise)
    2. Portainer (API abstraction over Compose/Swarm)
    3. Docker Swarm (cluster orchestration)
    4. Docker Compose (single-host containers)

    **Architecture**: The orchestrator uses DIRECT connections to Redis, RabbitMQ,
    and container APIs for its own infrastructure monitoring. It ALSO runs as a plugin within
    bannou so other services can call its APIs via mesh
    service invocation through lib-mesh.

    **SCHEMA MODIFICATION GATE**: STOP. Before modifying this schema, you MUST:
    1. Read docs/reference/SCHEMA-RULES.md
    2. State which section applies to your change
    3. Only then proceed with edits
    Edits without stating the applicable rule are FORBIDDEN.
x-service-layer: AppFeatures
servers:
- url: http://localhost:5012
  description: Service endpoint for service-to-service invocation (orchestrator runs as plugin within bannou)

paths:
  /orchestrator/health/infrastructure:
    post:
      summary: Check infrastructure component health
      description: |
        Validates connectivity and health of core infrastructure components:
        - Redis (direct connection via StackExchange.Redis)
        - RabbitMQ (direct connection via RabbitMQ.Client)
        - 
      operationId: GetInfrastructureHealth
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InfrastructureHealthRequest'
      responses:
        '200':
          description: Infrastructure health status (check response body for component health)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InfrastructureHealthResponse'

  /orchestrator/health/services:
    post:
      summary: Get health status of all services
      description: |
        Retrieves health information from all services via Redis heartbeat monitoring.
        Uses existing ServiceHeartbeatEvent schema from common-events.yaml.
      operationId: GetServicesHealth
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ServiceHealthRequest'
      responses:
        '200':
          description: Service health report
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceHealthReport'

  /orchestrator/services/restart:
    post:
      summary: Restart service with optional configuration
      description: |
        Performs intelligent service restart based on health metrics.
        Only restarts if truly necessary (e.g., 5+ minute degradation).

        Supports optional environment variable updates during restart.
      operationId: RestartService
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ServiceRestartRequest'
      responses:
        '200':
          description: Service restarted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceRestartResult'
        '400':
          description: Invalid restart request
        '409':
          description: Service restart not needed (healthy status)

  /orchestrator/services/should-restart:
    post:
      summary: Check if service needs restart
      description: |
        Evaluates service health and determines if restart is necessary.

        Restart logic:
        - Healthy: No restart needed
        - Degraded < 5 min: No restart needed
        - Degraded > 5 min: Restart recommended
        - Unavailable: Restart needed
      operationId: ShouldRestartService
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ShouldRestartServiceRequest'
      responses:
        '200':
          description: Restart recommendation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RestartRecommendation'

  # ============================================================================
  # ENVIRONMENT MANAGEMENT APIs
  # ============================================================================

  /orchestrator/backends/list:
    post:
      summary: Detect available container orchestration backends
      description: |
        Detects which container orchestration backends are available on this system.
        Returns availability status and capabilities for each backend.

        **Priority Order** (for automatic selection):
        1. Kubernetes - Full cluster orchestration with operators
        2. Portainer - API abstraction over Compose/Swarm with web UI
        3. Docker Swarm - Native Docker cluster orchestration
        4. Docker Compose - Single-host container management

        Detection methods:
        - Kubernetes: Check for kubectl and cluster connectivity
        - Portainer: Check for Portainer API endpoint
        - Swarm: Check `docker info` for swarm mode
        - Compose: Check for docker compose v2 availability
      operationId: GetBackends
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ListBackendsRequest'
      responses:
        '200':
          description: Available backends with capabilities
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BackendsResponse'

  /orchestrator/presets/list:
    post:
      summary: List available deployment presets
      description: |
        Returns all available deployment presets from the orchestrator's preset directory.
        Presets define service combinations and configuration for specific use cases.

        Built-in presets:
        - `local-development`: All services in single container with mesh infrastructure
        - `local-testing`: Test environment with infrastructure services
        - `integration-http`: HTTP integration testing preset
        - `integration-edge`: WebSocket/edge testing preset
        - `split-auth-account`: Auth and Account in separate containers
        - `distributed-npc`: NPC processing distributed across nodes
      operationId: GetPresets
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ListPresetsRequest'
      responses:
        '200':
          description: Available deployment presets
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PresetsResponse'

  /orchestrator/deploy:
    post:
      summary: Deploy or update an environment
      description: |
        Deploys a complete environment using a preset or custom configuration.
        Supports graceful transitions, forced deployments, and clean rebuilds.

        **Deployment Modes**:
        - `graceful`: Wait for existing connections to drain before changing topology
        - `force`: Immediately apply changes (may interrupt active connections)
        - `clean`: Tear down completely and rebuild from scratch

        **Backend Selection**:
        - If `backend` not specified, uses highest-priority available backend
        - If `backend` specified but unavailable, returns error (no fallback)

        **Live Topology Changes**:
        Supports changing service distribution without full restart:
        - Move auth/account to separate container while keeping other services together
        - Scale specific services to additional nodes
        - Update environment variables without restart (where supported)
      operationId: Deploy
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeployRequest'
      responses:
        '200':
          description: Deployment initiated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeployResponse'
        '400':
          description: Invalid deployment configuration
        '409':
          description: Backend not available (when explicitly requested)
        '500':
          description: Deployment failed

  /orchestrator/service-routing:
    post:
      summary: Get current service-to-app-id routing mappings
      description: |
        Returns the current service-to-app-id routing mappings used for mesh service invocation through lib-mesh.
        This is the authoritative source of truth for how services are routed in the current deployment.

        In development, all services route to "bannou" by default. In production, services may be
        distributed across multiple app-ids based on deployment topology.

        **Use Cases**:
        - Services querying routing on startup
        - Debugging service communication issues
        - Monitoring deployment topology
      operationId: GetServiceRouting
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetServiceRoutingRequest'
      responses:
        '200':
          description: Service routing mappings
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceRoutingResponse'

  /orchestrator/status:
    post:
      summary: Get current environment status
      description: |
        Returns comprehensive status of the current deployment including:
        - Active backend and deployment configuration
        - Service topology (which services on which containers)
        - Container health and resource usage
        - Infrastructure component status
        - Active preset and any customizations
      operationId: GetStatus
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetStatusRequest'
      responses:
        '200':
          description: Current environment status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvironmentStatus'

  /orchestrator/teardown:
    post:
      summary: Tear down the current environment
      description: |
        Tears down all containers and services in the current deployment.
        Optionally preserves volumes and networks for faster redeployment.

        **Teardown Modes**:
        - `graceful`: Signal shutdown and wait for clean exit
        - `force`: Immediately stop all containers (SIGKILL)
        - `preserve-data`: Keep volumes and networks, only remove containers
      operationId: Teardown
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TeardownRequest'
      responses:
        '200':
          description: Teardown completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TeardownResponse'
        '500':
          description: Teardown failed

  /orchestrator/clean:
    post:
      summary: Clean up unused resources
      description: |
        Prunes unused Docker resources to reclaim disk space and clean up
        orphaned containers, networks, volumes, and images.

        Equivalent to running various `docker system prune` commands.

        **Clean Targets**:
        - `containers`: Remove stopped containers
        - `networks`: Remove unused networks
        - `volumes`: Remove unused volumes (CAUTION: data loss)
        - `images`: Remove dangling images
        - `all`: All of the above
      operationId: Clean
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CleanRequest'
      responses:
        '200':
          description: Cleanup completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CleanResponse'
        '500':
          description: Cleanup failed

  /orchestrator/logs:
    post:
      summary: Get service/container logs
      description: |
        Retrieves logs from services or containers with filtering options.
        Supports real-time streaming via WebSocket upgrade.
      operationId: GetLogs
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetLogsRequest'
      responses:
        '200':
          description: Log output
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LogsResponse'
            text/plain:
              schema:
                type: string
        '101':
          description: Switching to WebSocket for streaming (when follow=true)
        '404':
          description: Service or container not found

  /orchestrator/topology:
    post:
      summary: Update service topology without full redeploy
      description: |
        Changes which services run on which containers without tearing down
        the entire environment. Enables live topology changes.

        **Use Cases**:
        - Move auth service to dedicated container for scaling
        - Consolidate services during low-traffic periods
        - Split services for debugging/isolation
        - Add new service nodes to running environment
      operationId: UpdateTopology
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TopologyUpdateRequest'
      responses:
        '200':
          description: Topology update applied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TopologyUpdateResponse'
        '400':
          description: Invalid topology configuration
        '409':
          description: Topology change conflicts with current state
        '500':
          description: Topology update failed

  # ============================================================================
  # CONTAINER MANAGEMENT APIs (Self-Service Restart Pattern)
  # ============================================================================

  /orchestrator/containers/request-restart:
    post:
      summary: Request container restart (self-service pattern)
      description: |
        Plugins call this endpoint to request restart of their own container.
        This is part of the self-service configuration update pattern where
        plugins decide if they care about config changes and request restarts.

        **Flow**:
        1. Orchestrator publishes ConfigurationChangedEvent with changed keys
        2. Plugins check if any changed keys match their dependencies
        3. Plugins that care call this endpoint to request restart
        4. Orchestrator performs rolling restart of requested containers

        **Priority Levels**:
        - `graceful`: Rolling update, wait for healthy before cycling next instance
        - `immediate`: Rolling update but don't wait for connection drain
        - `force`: Kill all instances simultaneously (causes downtime)
      operationId: RequestContainerRestart
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ContainerRestartRequestBody'
      responses:
        '200':
          description: Restart request accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ContainerRestartResponse'
        '400':
          description: Invalid restart request
        '404':
          description: Container not found

  /orchestrator/containers/status:
    post:
      summary: Get container health and restart history
      description: |
        Returns detailed status of a container including health, restart history,
        running plugins, and current configuration.
      operationId: GetContainerStatus
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetContainerStatusRequest'
      responses:
        '200':
          description: Container status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ContainerStatus'
        '404':
          description: Container not found

  # ============================================================================
  # CONFIGURATION MANAGEMENT APIs
  # ============================================================================

  /orchestrator/config/rollback:
    post:
      summary: Rollback to previous configuration
      description: |
        Quickly rollback to the previous configuration without waiting for CI.
        Swaps currentConfig with previousConfig and publishes ConfigurationChangedEvent
        with the reverted keys so services can request restart.

        **Note**: This is a quick fix. GitHub secrets should still be corrected
        to prevent re-breaking on next orchestrator deploy.
      operationId: RollbackConfiguration
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConfigRollbackRequest'
      responses:
        '200':
          description: Rollback completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfigRollbackResponse'
        '400':
          description: No previous configuration to rollback to
        '500':
          description: Rollback failed

  /orchestrator/config/version:
    post:
      summary: Get current configuration version and metadata
      description: |
        Returns the current configuration version, last update time,
        and summary of configuration state (not actual values for security).
      operationId: GetConfigVersion
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetConfigVersionRequest'
      responses:
        '200':
          description: Configuration version info
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfigVersionResponse'

  /orchestrator/processing-pool/acquire:
    post:
      summary: Acquire a processor from a pool
      description: |
        Requests an available processor instance from the specified pool type.
        Returns the app-id of an available processor or 429 if none available.
        The processor is marked as busy until explicitly released.
      operationId: AcquireProcessor
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AcquireProcessorRequest'
      responses:
        '200':
          description: Processor acquired successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AcquireProcessorResponse'
        '429':
          description: No processors available (all busy or pool at capacity)

  /orchestrator/processing-pool/release:
    post:
      summary: Release a processor back to the pool
      description: |
        Releases a previously acquired processor, making it available for other requests.
        Should be called when processing is complete or on error cleanup.
      operationId: ReleaseProcessor
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReleaseProcessorRequest'
      responses:
        '200':
          description: Processor released successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReleaseProcessorResponse'
        '404':
          description: Processor or lease not found

  /orchestrator/processing-pool/status:
    post:
      summary: Get processing pool status
      description: |
        Returns current status of a processing pool including:
        - Total instances (running and available)
        - Current utilization
        - Queue depth (waiting requests)
        - Recent processing metrics
      operationId: GetPoolStatus
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetPoolStatusRequest'
      responses:
        '200':
          description: Pool status retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PoolStatusResponse'

  /orchestrator/processing-pool/scale:
    post:
      summary: Scale a processing pool
      description: |
        Manually adjust the size of a processing pool.
        Can scale up (add instances) or scale down (remove idle instances).
        Respects min/max constraints from pool configuration.
      operationId: ScalePool
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ScalePoolRequest'
      responses:
        '200':
          description: Pool scaled successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScalePoolResponse'
        '400':
          description: Invalid scale request (exceeds limits)

  /orchestrator/processing-pool/cleanup:
    post:
      summary: Cleanup idle processing pool instances
      description: |
        Scales pool back to minimum instances by removing idle processors.
        Used for resource reclamation during low-activity periods.
      operationId: CleanupPool
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CleanupPoolRequest'
      responses:
        '200':
          description: Cleanup completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CleanupPoolResponse'

components:
  schemas:
    # Request Models for POST-only pattern
    InfrastructureHealthRequest:
      type: object
      additionalProperties: false
      description: Request to check infrastructure health (empty body allowed)
      properties:
        components:
          type: array
          items:
            type: string
          description: Optional filter for specific components (redis, rabbitmq, placement)
          nullable: true

    ServiceHealthSource:
      type: string
      description: |
        Filter for which services to include in health reports.
        - all: Include both control plane services and deployed services (default)
        - control_plane_only: Only services running on the control plane (main bannou instance)
        - deployed_only: Only services running on explicitly deployed nodes (split topology)
      enum:
        - all
        - control_plane_only
        - deployed_only

    ServiceHealthRequest:
      type: object
      additionalProperties: false
      description: |
        Request to get service health status.
        Use 'source' to filter which services are included in the report.
        Note: A service may appear multiple times if it runs on both control plane
        and deployed nodes - use appId to distinguish between instances.
      properties:
        source:
          $ref: '#/components/schemas/ServiceHealthSource'
          description: |
            Which services to include. Defaults to 'all' which includes both
            control plane services and deployed services.
        serviceFilter:
          type: string
          description: Optional filter by service name (applied after source filter)
          nullable: true

    GetServiceRoutingRequest:
      type: object
      additionalProperties: false
      description: Request to get service routing mappings (empty body allowed)
      properties:
        serviceFilter:
          type: string
          description: Optional filter by service name prefix
          nullable: true

    ServiceRoutingResponse:
      description: Response containing service-to-app-id routing mappings for mesh invocation
      type: object
      additionalProperties: false
      required:
      - mappings
      - defaultAppId
      - generatedAt
      properties:
        mappings:
          type: object
          additionalProperties:
            type: string
          description: |
            Map of service names to Bannou app-id routing destinations.
            Example: { "account": "bannou", "behavior": "npc-processing-01" }
        defaultAppId:
          type: string
          description: Default app-id used when no specific mapping exists
          default: "bannou"
        generatedAt:
          type: string
          format: date-time
          description: When this routing information was generated
        totalServices:
          type: integer
          description: Total number of services with routing mappings
          minimum: 0
        deploymentId:
          type: string
          description: Current deployment identifier (if environment is deployed)
          nullable: true

    ListBackendsRequest:
      type: object
      additionalProperties: false
      description: Request to list available backends (empty body allowed)
      properties:
        refresh:
          type: boolean
          default: false
          description: Force refresh detection instead of using cached results

    ListPresetsRequest:
      type: object
      additionalProperties: false
      description: Request to list available presets (empty body allowed)
      properties:
        category:
          type: string
          enum: [development, testing, production, custom]
          description: Optional filter by category
          nullable: true

    GetStatusRequest:
      type: object
      additionalProperties: false
      description: Request to get environment status (empty body allowed)
      properties:
        includeResources:
          type: boolean
          default: true
          description: Include resource usage metrics

    GetLogsRequest:
      type: object
      additionalProperties: false
      description: Request to get service/container logs
      properties:
        service:
          type: string
          description: Service name to get logs for
          nullable: true
        container:
          type: string
          description: Container ID or name (alternative to service)
          nullable: true
        since:
          type: string
          description: Return logs since timestamp (RFC3339 or relative like "5m")
          nullable: true
        until:
          type: string
          description: Return logs until timestamp
          nullable: true
        tail:
          type: integer
          default: 100
          description: Number of lines from end of logs
        follow:
          type: boolean
          default: false
          description: Stream logs in real-time (WebSocket upgrade)

    ContainerRestartRequestBody:
      description: Request body for restarting a container by its app-id
      type: object
      additionalProperties: false
      required:
      - appName
      - reason
      properties:
        appName:
          type: string
          description: Container's app-id for mesh routing (e.g., "bannou", "npc-pool-01")
        reason:
          type: string
          description: Why restart is needed (for logging/auditing)
          example: "configuration_change"
        priority:
          $ref: '#/components/schemas/RestartPriority'
          description: Urgency level for the restart
        shutdownGracePeriod:
          type: integer
          default: 30
          description: Seconds to allow graceful shutdown before force-kill

    GetContainerStatusRequest:
      description: Request to retrieve the current status of a specific container
      type: object
      additionalProperties: false
      required:
      - appName
      properties:
        appName:
          type: string
          description: Container's app-id for mesh routing

    GetConfigVersionRequest:
      type: object
      additionalProperties: false
      description: Request to get configuration version (empty body allowed)
      properties:
        includeKeyPrefixes:
          type: boolean
          default: true
          description: Include list of configuration key prefixes

    InfrastructureHealthResponse:
      description: Response containing overall infrastructure health status and individual component details
      type: object
      additionalProperties: false
      required:
      - healthy
      - timestamp
      - components
      properties:
        healthy:
          type: boolean
          description: Overall infrastructure health status
        timestamp:
          type: string
          format: date-time
          description: When health check was performed
        components:
          type: array
          items:
            $ref: '#/components/schemas/ComponentHealth'
          description: Individual component health status

    ComponentHealth:
      description: Health status information for a single infrastructure component (Redis, RabbitMQ, etc.)
      type: object
      additionalProperties: false
      required:
      - name
      - status
      - lastSeen
      properties:
        name:
          type: string
          description: Component name (redis, rabbitmq, placement)
        status:
          type: string
          enum: [healthy, degraded, unavailable]
          description: Component health status
        lastSeen:
          type: string
          format: date-time
          description: Last successful connection time
        message:
          type: string
          nullable: true
          description: Additional status information (null if no additional context needed)
        metrics:
          type: object
          additionalProperties: true
          description: >-
            Component-specific metrics reported by the service.
            No Bannou plugin reads specific keys from this field by convention.

    Capacity:
      type: object
      additionalProperties: false
      description: Service capacity metrics from heartbeat monitoring including connection counts and resource usage
      properties:
        maxConnections:
          type: integer
          description: Maximum number of connections this service can handle
        currentConnections:
          type: integer
          description: Current number of active connections
        cpuUsage:
          type: number
          format: float
          description: CPU usage as a percentage (0.0 to 1.0)
        memoryUsage:
          type: number
          format: float
          description: Memory usage as a percentage (0.0 to 1.0)

    HealthChecks:
      type: object
      additionalProperties: false
      description: Health check information for a container including last check status and failure tracking
      properties:
        lastCheck:
          type: string
          format: date-time
          description: When the last health check was performed
        status:
          type: string
          description: Result of the last health check
        consecutiveFailures:
          type: integer
          description: Number of consecutive health check failures

    ServiceHealthReport:
      description: |
        Aggregated health report for services based on heartbeat monitoring.
        Services are categorized as healthy or unhealthy based on heartbeat recency.
        Use controlPlaneAppId to distinguish control plane services from deployed services.
      type: object
      additionalProperties: false
      required:
      - timestamp
      - totalServices
      - healthPercentage
      - healthyServices
      - unhealthyServices
      - controlPlaneAppId
      - source
      properties:
        timestamp:
          type: string
          format: date-time
          description: When report was generated
        source:
          $ref: '#/components/schemas/ServiceHealthSource'
          description: Which source filter was applied to generate this report
        controlPlaneAppId:
          type: string
          description: |
            App-id of the control plane (main bannou instance).
            Services with this appId are running on the control plane.
            Services with different appIds are running on deployed nodes.
        totalServices:
          type: integer
          description: Total number of services (may include duplicates if same service runs on multiple nodes)
        healthPercentage:
          type: number
          format: float
          description: Percentage of healthy services (0-100)
        healthyServices:
          type: array
          items:
            $ref: '#/components/schemas/ServiceHealthStatus'
          description: Services with recent heartbeats (status healthy/degraded)
        unhealthyServices:
          type: array
          items:
            $ref: '#/components/schemas/ServiceHealthStatus'
          description: Services with expired heartbeats or unhealthy status

    ServiceHealthStatus:
      type: object
      additionalProperties: false
      description: |
        Service health status from heartbeat monitoring.
        Uses ServiceHeartbeatEvent schema from common-events.yaml.
      required:
      - serviceId
      - appId
      - status
      - lastSeen
      properties:
        serviceId:
          type: string
          description: Service ID (e.g., "behavior", "account")
        appId:
          type: string
          description: App-id for mesh routing (e.g., "bannou", "npc-pool-01")
        status:
          type: string
          description: Service status from heartbeat
        lastSeen:
          type: string
          format: date-time
          description: Last heartbeat timestamp
        capacity:
          description: Current capacity metrics including load and available slots
          $ref: '#/components/schemas/Capacity'
          nullable: true
        metadata:
          type: object
          additionalProperties: true
          nullable: true
          description: >-
            Client-provided service metadata.
            No Bannou plugin reads specific keys from this field by convention.

    # NOTE: TestExecutionRequest/TestExecutionResult/TestResult removed - test execution is via Makefile, not API

    ServiceRestartRequest:
      description: Request to restart a specific service with optional configuration updates
      type: object
      additionalProperties: false
      required:
      - serviceName
      properties:
        serviceName:
          type: string
          description: Name of service to restart
        environment:
          type: object
          additionalProperties:
            type: string
          description: Optional environment variable updates
        force:
          type: boolean
          description: Force restart even if healthy (default false)
        timeout:
          type: integer
          description: Timeout for service to become healthy (seconds, default 120)

    ServiceRestartResult:
      description: Result of a service restart operation including timing and status information
      type: object
      additionalProperties: false
      required:
      - success
      - serviceName
      - duration
      properties:
        success:
          type: boolean
          description: Restart success status
        serviceName:
          type: string
          description: Service that was restarted
        duration:
          type: string
          description: Time taken to restart and become healthy
        previousStatus:
          type: string
          description: Service status before restart
        currentStatus:
          type: string
          description: Service status after restart
        message:
          type: string
          description: Restart result message

    ShouldRestartServiceRequest:
      description: Request to evaluate whether a service should be restarted based on health metrics
      type: object
      additionalProperties: false
      required:
      - serviceName
      properties:
        serviceName:
          type: string
          description: Name of service to evaluate

    RestartRecommendation:
      description: Recommendation on whether a service should be restarted with supporting rationale
      type: object
      additionalProperties: false
      required:
      - shouldRestart
      - serviceName
      - currentStatus
      - reason
      properties:
        shouldRestart:
          type: boolean
          description: Whether restart is recommended
        serviceName:
          type: string
          description: Service being evaluated
        currentStatus:
          type: string
          description: Current service health status
        lastSeen:
          type: string
          format: date-time
          description: Last heartbeat timestamp
        degradedDuration:
          type: string
          nullable: true
          description: How long service has been degraded (null if not degraded)
        reason:
          type: string
          description: Explanation for recommendation

    # ==========================================================================
    # ENVIRONMENT MANAGEMENT SCHEMAS
    # ==========================================================================

    BackendType:
      type: string
      enum: [kubernetes, portainer, swarm, compose]
      description: |
        Container orchestration backend type.
        Priority order: kubernetes > portainer > swarm > compose

    BackendInfo:
      description: Information about a container orchestration backend including availability and capabilities
      type: object
      additionalProperties: false
      required:
      - type
      - available
      - priority
      properties:
        type:
          $ref: '#/components/schemas/BackendType'
          description: Backend type identifier
        available:
          type: boolean
          description: Whether this backend is currently available
        priority:
          type: integer
          description: Selection priority (1 = highest)
        version:
          type: string
          description: Backend version (e.g., "1.28.0" for Docker)
        endpoint:
          type: string
          description: Backend API endpoint (if applicable)
        capabilities:
          type: array
          items:
            type: string
          description: |
            Supported capabilities for this backend:
            - live-topology: Can change service distribution without restart
            - scaling: Can scale services horizontally
            - rolling-update: Supports rolling deployments
            - secrets: Native secrets management
            - volumes: Persistent volume support
            - networks: Custom network creation
        error:
          type: string
          description: Error message if detection failed

    BackendsResponse:
      description: Response listing all detected container orchestration backends with recommended selection
      type: object
      additionalProperties: false
      required:
      - timestamp
      - backends
      - recommended
      properties:
        timestamp:
          type: string
          format: date-time
          description: When detection was performed
        backends:
          type: array
          items:
            $ref: '#/components/schemas/BackendInfo'
          description: All detected backends with status
        recommended:
          $ref: '#/components/schemas/BackendType'
          description: Highest priority available backend
        activeBackend:
          $ref: '#/components/schemas/BackendType'
          description: Currently active backend (if environment deployed)

    DeploymentPreset:
      description: Predefined deployment configuration defining service topology and environment settings
      type: object
      additionalProperties: false
      required:
      - name
      - description
      - topology
      properties:
        name:
          type: string
          description: Unique preset identifier (e.g., "local-development")
        description:
          type: string
          description: Human-readable preset description
        category:
          type: string
          enum: [development, testing, production, custom]
          description: Preset category
        topology:
          $ref: '#/components/schemas/ServiceTopology'
          description: Service topology defined by this preset
        environment:
          type: object
          additionalProperties:
            type: string
          description: Default environment variables for this preset
        requiredBackends:
          type: array
          items:
            $ref: '#/components/schemas/BackendType'
          description: Backends that support this preset (empty = all)
        builtIn:
          type: boolean
          description: Whether this is a built-in preset
        filePath:
          type: string
          description: Path to preset configuration file

    PresetsResponse:
      description: Response containing available deployment presets and the currently active preset
      type: object
      additionalProperties: false
      required:
      - presets
      properties:
        presets:
          type: array
          items:
            $ref: '#/components/schemas/DeploymentPreset'
          description: Available deployment presets
        activePreset:
          type: string
          description: Currently active preset name (if any)

    ServiceTopology:
      description: Service distribution topology defining which services run on which nodes
      type: object
      additionalProperties: false
      required:
      - nodes
      properties:
        nodes:
          type: array
          items:
            $ref: '#/components/schemas/TopologyNode'
          description: Container/pod definitions with service assignments
        infrastructure:
          $ref: '#/components/schemas/InfrastructureConfig'
          description: Infrastructure service configuration

    TopologyNode:
      description: A container or pod in the service topology with its assigned services and configuration
      type: object
      additionalProperties: false
      required:
      - name
      properties:
        name:
          type: string
          description: Node/container name (e.g., "bannou-main", "bannou-auth")
        layers:
          type: array
          items:
            type: string
            enum:
            - AppFoundation
            - GameFoundation
            - AppFeatures
            - GameFeatures
            - Extensions
          description: |
            Service layers to enable on this node. Listed layers are enabled,
            unlisted layers are disabled. When omitted, layer enablement is
            inherited from the container's environment.
            Individual services in the 'services' list override layer settings.
        services:
          type: array
          items:
            type: string
          description: |
            Individual services to enable on this node.
            When used with 'layers', these act as overrides for services
            outside the enabled layers.
            When used without 'layers', uses legacy SERVICES_ENABLED=false
            with per-service {SERVICE}_SERVICE_ENABLED=true pattern.
        replicas:
          type: integer
          default: 1
          description: Number of replicas for this node
        resources:
          $ref: '#/components/schemas/ResourceLimits'
          description: Resource limits and requests for this node
        environment:
          type: object
          additionalProperties:
            type: string
          description: Node-specific environment overrides
        meshEnabled:
          type: boolean
          default: true
          description: Whether mesh routing is enabled
        appId:
          type: string
          description: App-id override for mesh routing (default derives from node name)

    InfrastructureConfig:
      type: object
      additionalProperties: false
      description: Configuration for infrastructure services
      properties:
        redis:
          $ref: '#/components/schemas/InfraServiceConfig'
          description: Redis configuration
        rabbitmq:
          $ref: '#/components/schemas/InfraServiceConfig'
          description: RabbitMQ configuration
        mysql:
          $ref: '#/components/schemas/InfraServiceConfig'
          description: MySQL configuration
        ingress:
          $ref: '#/components/schemas/IngressConfig'
          description: Ingress/reverse proxy configuration

    InfraServiceConfig:
      type: object
      additionalProperties: false
      description: Configuration for an infrastructure service
      properties:
        enabled:
          type: boolean
          default: true
          description: Whether this infrastructure service is enabled
        image:
          type: string
          description: Docker image override
        resources:
          $ref: '#/components/schemas/ResourceLimits'
          description: Resource limits and requests
        environment:
          type: object
          additionalProperties:
            type: string
          description: Environment variables for this service
        volumes:
          type: array
          items:
            type: string
          description: Volume mounts

    IngressConfig:
      type: object
      additionalProperties: false
      description: Ingress/reverse proxy configuration
      properties:
        enabled:
          type: boolean
          default: true
          description: Whether ingress is enabled
        type:
          type: string
          enum: [openresty, nginx, traefik, none]
          default: openresty
          description: Type of ingress/reverse proxy to use
        ports:
          description: Port configuration for HTTP and HTTPS traffic
          $ref: '#/components/schemas/Ports'
        ssl:
          type: boolean
          default: false
          description: Whether SSL/TLS is enabled

    Ports:
      type: object
      additionalProperties: false
      description: Port configuration for ingress specifying HTTP and HTTPS port numbers
      properties:
        http:
          type: integer
          default: 80
          description: HTTP port number
        https:
          type: integer
          default: 443
          description: HTTPS port number

    ResourceLimits:
      type: object
      additionalProperties: false
      description: Resource limits and requests for container scheduling
      properties:
        cpuLimit:
          type: string
          description: CPU limit (e.g., "0.5", "2")
        memoryLimit:
          type: string
          description: Memory limit (e.g., "512m", "2g")
        cpuRequest:
          type: string
          description: CPU request (Kubernetes)
        memoryRequest:
          type: string
          description: Memory request (Kubernetes)

    DeploymentMode:
      type: string
      enum: [graceful, force, clean]
      description: |
        Deployment mode:
        - graceful: Wait for connections to drain
        - force: Apply immediately
        - clean: Tear down and rebuild

    DeployRequest:
      description: Request to deploy or update an environment using a preset or custom topology
      type: object
      additionalProperties: false
      properties:
        preset:
          type: string
          nullable: true
          description: Preset name to deploy (mutually exclusive with topology)
        topology:
          allOf:
          - $ref: '#/components/schemas/ServiceTopology'
          nullable: true
          description: Custom topology (mutually exclusive with preset)
        backend:
          allOf:
          - $ref: '#/components/schemas/BackendType'
          nullable: true
          description: Specific backend to use (fails if unavailable)
        mode:
          $ref: '#/components/schemas/DeploymentMode'
          default: graceful
          description: How the deployment should be performed
        environment:
          type: object
          additionalProperties:
            type: string
          nullable: true
          description: Environment variable overrides
        timeout:
          type: integer
          default: 300
          description: Deployment timeout in seconds
        waitForHealthy:
          type: boolean
          default: true
          description: Wait for all services to report healthy
        dryRun:
          type: boolean
          default: false
          description: Preview what would be deployed without making changes

    DeployResponse:
      description: Result of a deployment operation including status and deployed service information
      type: object
      additionalProperties: false
      required:
      - success
      - deploymentId
      - backend
      - duration
      properties:
        success:
          type: boolean
          description: Whether all nodes were deployed successfully (false indicates partial failure)
        deploymentId:
          type: string
          description: Unique deployment identifier for tracking
        backend:
          $ref: '#/components/schemas/BackendType'
          description: Container orchestration backend used for deployment
        preset:
          type: string
          description: Preset used (if applicable)
        duration:
          type: string
          description: Time taken to deploy
        topology:
          $ref: '#/components/schemas/ServiceTopology'
          description: Final applied topology
        services:
          type: array
          items:
            $ref: '#/components/schemas/DeployedService'
          description: Status of deployed services
        warnings:
          type: array
          items:
            type: string
          description: Non-fatal warnings during deployment
        message:
          type: string
          description: Human-readable deployment summary

    DeployedService:
      description: Status information for a single deployed service instance
      type: object
      additionalProperties: false
      required:
      - name
      - status
      - node
      properties:
        name:
          type: string
          description: Service name
        status:
          type: string
          enum: [starting, running, healthy, unhealthy, stopped]
          description: Current status of the deployed service
        node:
          type: string
          description: Node/container hosting this service
        containerId:
          type: string
          description: Container ID (Compose/Swarm)
        podName:
          type: string
          description: Pod name (Kubernetes)
        endpoints:
          type: array
          items:
            type: string
          description: Exposed endpoints

    EnvironmentStatus:
      description: Current status of the deployed environment including topology and resource usage
      type: object
      additionalProperties: false
      required:
      - deployed
      - timestamp
      properties:
        deployed:
          type: boolean
          description: Whether an environment is currently deployed
        timestamp:
          type: string
          format: date-time
          description: When this status was generated
        deploymentId:
          type: string
          description: Current deployment identifier
        backend:
          $ref: '#/components/schemas/BackendType'
          description: Container orchestration backend in use
        preset:
          type: string
          description: Active preset name
        topology:
          $ref: '#/components/schemas/ServiceTopology'
          description: Current topology configuration
        services:
          type: array
          items:
            $ref: '#/components/schemas/DeployedService'
          description: All deployed services with status
        infrastructure:
          $ref: '#/components/schemas/InfrastructureHealthResponse'
          description: Infrastructure component health
        resources:
          $ref: '#/components/schemas/ResourceUsage'
          description: Overall resource usage
        uptime:
          type: string
          description: Time since deployment

    ResourceUsage:
      description: System resource utilization metrics including CPU, memory, disk, and network
      type: object
      additionalProperties: false
      properties:
        cpuPercent:
          type: number
          format: float
          description: Total CPU usage percentage
        memoryUsedMb:
          type: integer
          description: Total memory used (MB)
        memoryTotalMb:
          type: integer
          description: Total memory available (MB)
        diskUsedGb:
          type: number
          format: float
          description: Disk space used (GB)
        networkInMb:
          type: number
          format: float
          description: Network input (MB)
        networkOutMb:
          type: number
          format: float
          description: Network output (MB)

    TeardownMode:
      type: string
      enum: [graceful, force, preserve-data]
      description: |
        Teardown mode:
        - graceful: Signal shutdown, wait for clean exit
        - force: Immediately stop (SIGKILL)
        - preserve-data: Keep volumes/networks, remove containers

    TeardownRequest:
      description: Request to tear down a deployed environment with options for data preservation
      type: object
      additionalProperties: false
      properties:
        dryRun:
          type: boolean
          default: false
          description: |
            When true, simulates teardown without actually stopping or removing containers.
            Returns what would be torn down. ALWAYS use dryRun=true first to preview the impact.
        mode:
          $ref: '#/components/schemas/TeardownMode'
          default: graceful
          description: How the teardown should be performed
        timeout:
          type: integer
          default: 60
          description: Graceful shutdown timeout in seconds
        removeVolumes:
          type: boolean
          default: false
          description: Also remove associated volumes
        removeNetworks:
          type: boolean
          default: false
          description: Also remove associated networks
        includeInfrastructure:
          type: boolean
          default: false
          description: |
            When true, also removes support infrastructure (Redis, RabbitMQ, MySQL, etc.).
            This is determined by scanning compose files or finding containers in the same
            Docker swarm/Kubernetes namespace as bannou services. USE WITH EXTREME CAUTION -
            this will destroy all data and require a full re-deployment.

    TeardownResponse:
      description: Result of an environment teardown including removed resources and any errors
      type: object
      additionalProperties: false
      required:
      - success
      - duration
      properties:
        success:
          type: boolean
          description: Whether all containers were torn down successfully (false indicates partial failure)
        duration:
          type: string
          description: Time taken to complete teardown
        stoppedContainers:
          type: array
          items:
            type: string
          description: Container IDs that were stopped
        removedVolumes:
          type: array
          items:
            type: string
          description: Volumes that were removed
        removedNetworks:
          type: array
          items:
            type: string
          description: Networks that were removed
        removedInfrastructure:
          type: array
          items:
            type: string
          description: Infrastructure services that were removed (Redis, RabbitMQ, MySQL, etc.)
        errors:
          type: array
          items:
            type: string
          description: Non-fatal errors during teardown
        message:
          type: string
          description: Human-readable teardown summary

    CleanTarget:
      type: string
      enum: [containers, networks, volumes, images, all]
      description: Type of resource to clean

    CleanRequest:
      description: Request to clean up Docker resources such as containers, volumes, and images
      type: object
      additionalProperties: false
      required:
      - targets
      properties:
        targets:
          type: array
          items:
            $ref: '#/components/schemas/CleanTarget'
          description: Resources to clean (or "all")
        force:
          type: boolean
          default: false
          description: Force removal without confirmation
        olderThan:
          type: string
          nullable: true
          description: Only clean resources older than (e.g., "24h", "7d")
        labelFilter:
          type: object
          additionalProperties:
            type: string
          nullable: true
          description: Only clean resources matching labels

    CleanResponse:
      description: Result of a cleanup operation including reclaimed space and removed resource counts
      type: object
      additionalProperties: false
      required:
      - success
      properties:
        success:
          type: boolean
          description: Whether all requested cleanup operations completed (false indicates partial failure)
        reclaimedSpaceMb:
          type: integer
          description: Disk space reclaimed (MB)
        removedContainers:
          type: integer
          description: Number of containers removed
        removedNetworks:
          type: integer
          description: Number of networks removed
        removedVolumes:
          type: integer
          description: Number of volumes removed
        removedImages:
          type: integer
          description: Number of images removed
        errors:
          type: array
          items:
            type: string
          description: Non-fatal errors during cleanup
        message:
          type: string
          description: Human-readable cleanup summary

    LogsResponse:
      description: Response containing log entries from a service or container
      type: object
      additionalProperties: false
      required:
      - logs
      properties:
        service:
          type: string
          description: Service name (if queried by service)
        container:
          type: string
          description: Container ID/name
        logs:
          type: array
          items:
            $ref: '#/components/schemas/LogEntry'
          description: Log entries matching the query
        truncated:
          type: boolean
          description: Whether output was truncated

    LogEntry:
      description: A single log entry with timestamp, stream, and message content
      type: object
      additionalProperties: false
      required:
      - timestamp
      - message
      properties:
        timestamp:
          type: string
          format: date-time
          description: When this log entry was recorded
        stream:
          type: string
          enum: [stdout, stderr]
          description: Output stream type (stdout or stderr)
        message:
          type: string
          description: Log message content

    TopologyUpdateRequest:
      description: Request to apply incremental changes to the current service topology
      type: object
      additionalProperties: false
      required:
      - changes
      properties:
        changes:
          type: array
          items:
            $ref: '#/components/schemas/TopologyChange'
          description: List of topology changes to apply
        mode:
          $ref: '#/components/schemas/DeploymentMode'
          default: graceful
          description: How the topology update should be performed
        timeout:
          type: integer
          default: 120
          description: Timeout for topology update

    TopologyChange:
      description: A single topology modification such as adding a node, moving a service, or scaling
      type: object
      additionalProperties: false
      required:
      - action
      properties:
        action:
          type: string
          enum: [add-node, remove-node, move-service, scale, update-env]
          description: Type of topology change
        nodeName:
          type: string
          description: Target node name
        services:
          type: array
          items:
            type: string
          description: Services affected by this change
        replicas:
          type: integer
          description: New replica count (for scale action)
        environment:
          type: object
          additionalProperties:
            type: string
          description: Environment updates (for update-env action)
        nodeConfig:
          $ref: '#/components/schemas/TopologyNode'
          description: Full node config (for add-node action)

    TopologyUpdateResponse:
      description: Result of a topology update including applied changes and the new topology state
      type: object
      additionalProperties: false
      required:
      - success
      - appliedChanges
      properties:
        success:
          type: boolean
          description: Whether all topology changes were applied successfully (false indicates partial failure)
        appliedChanges:
          type: array
          items:
            $ref: '#/components/schemas/AppliedChange'
          description: Details of each applied change
        topology:
          $ref: '#/components/schemas/ServiceTopology'
          description: New topology after changes
        duration:
          type: string
          description: Time taken to apply topology changes
        warnings:
          type: array
          items:
            type: string
          description: Non-fatal warnings during topology update
        message:
          type: string
          description: Human-readable update summary

    AppliedChange:
      description: Details of a single topology change that was applied, including success status
      type: object
      additionalProperties: false
      required:
      - action
      - success
      properties:
        action:
          type: string
          description: Type of topology change that was applied
        target:
          type: string
          description: Node or service affected
        success:
          type: boolean
          description: Whether this specific change was applied successfully
        error:
          type: string
          description: Error message if failed

    # ==========================================================================
    # EVENT SCHEMAS (for RabbitMQ pub/sub)
    # ==========================================================================

    DeploymentEvent:
      type: object
      additionalProperties: false
      description: |
        Published when deployment state changes.
        Topic: bannou.deployment-events
      required:
      - eventId
      - timestamp
      - action
      - deploymentId
      properties:
        eventId:
          type: string
          description: Unique identifier for this event
        timestamp:
          type: string
          format: date-time
          description: When this event occurred
        action:
          type: string
          enum: [started, completed, failed, topology-changed]
          description: Type of deployment action that triggered this event
        deploymentId:
          type: string
          description: Unique identifier for the deployment
        preset:
          type: string
          nullable: true
          description: Preset name used for deployment (if applicable)
        backend:
          $ref: '#/components/schemas/BackendType'
          description: Container orchestration backend used
        changes:
          type: array
          items:
            type: string
          description: Summary of changes made
        error:
          type: string
          nullable: true
          description: Error message if failed

    ServiceRestartEvent:
      type: object
      additionalProperties: false
      description: |
        Published when a service is restarted.
        Topic: bannou.service-lifecycle
      required:
      - eventId
      - serviceName
      - reason
      properties:
        eventId:
          type: string
          description: Unique identifier for this event
        serviceName:
          type: string
          description: Name of the service that was restarted
        reason:
          type: string
          description: Reason for the restart
        forced:
          type: boolean
          description: Whether restart was forced without waiting for graceful shutdown
        newEnvironment:
          type: object
          additionalProperties:
            type: string
          description: Environment variables updated during restart

    ConfigurationChangedEvent:
      type: object
      additionalProperties: false
      description: |
        Published by orchestrator when configuration or secrets change.
        All containers receive this event via RabbitMQ. Plugins decide if they care
        based on the changedKeys prefixes and request restart if needed.
        Topic: bannou.configuration-events
      required:
      - eventId
      - timestamp
      - configVersion
      - changedKeys
      properties:
        eventId:
          type: string
          description: Unique identifier for this event instance
        timestamp:
          type: string
          format: date-time
          description: When this configuration change occurred
        configVersion:
          type: integer
          description: Monotonically increasing version number
        changedKeys:
          type: array
          items:
            type: string
          description: |
            Configuration keys that changed (not values for security).
            Key prefixes indicate scope:
            - "auth.*" - Authentication-related
            - "database.*" - Database connections
            - "mesh.*" - Mesh components (typically global impact)
            - "connect.*" - WebSocket/connection settings

    # ==========================================================================
    # CONTAINER MANAGEMENT SCHEMAS
    # ==========================================================================

    RestartPriority:
      type: string
      enum: [graceful, immediate, force]
      description: |
        Restart urgency level:
        - graceful: Rolling update, wait for healthy before cycling next instance
        - immediate: Rolling update but don't wait for connection drain
        - force: Kill all instances simultaneously (causes downtime)

    ContainerRestartRequest:
      type: object
      additionalProperties: false
      description: Request to restart a container
      required:
      - reason
      properties:
        reason:
          type: string
          description: Why restart is needed (for logging/auditing)
          example: "configuration_change"
        priority:
          $ref: '#/components/schemas/RestartPriority'
          default: graceful
          description: Urgency level for the restart
        shutdownGracePeriod:
          type: integer
          default: 30
          description: Seconds to allow graceful shutdown before force-kill

    ContainerRestartResponse:
      description: Response after accepting a container restart request with scheduling details
      type: object
      additionalProperties: false
      required:
      - accepted
      - appName
      properties:
        accepted:
          type: boolean
          description: Whether the restart request was accepted
        appName:
          type: string
          description: Container that will be restarted
        scheduledFor:
          type: string
          format: date-time
          description: When restart is scheduled (may be queued)
        currentInstances:
          type: integer
          description: Number of running instances
        restartStrategy:
          type: string
          enum: [rolling, simultaneous]
          description: How restart will be performed
        message:
          type: string
          description: Additional information

    ContainerStatus:
      description: Current status of a container including health, restart history, and running plugins
      type: object
      additionalProperties: false
      required:
      - appName
      - status
      - timestamp
      properties:
        appName:
          type: string
          description: Container's app-id for mesh routing
        status:
          type: string
          enum: [running, starting, stopping, stopped, unhealthy]
          description: Current container status
        timestamp:
          type: string
          format: date-time
          description: When this status was captured
        instances:
          type: integer
          description: Number of running instances
        plugins:
          type: array
          items:
            type: string
          description: Plugins running in this container
        lastRestart:
          type: string
          format: date-time
          description: When container was last restarted
        restartCount:
          type: integer
          description: Number of restarts in last 24 hours
        restartHistory:
          type: array
          items:
            $ref: '#/components/schemas/RestartHistoryEntry'
          description: Recent restart history
        healthChecks:
          description: Health check configuration and current health status results
          $ref: '#/components/schemas/HealthChecks'
        labels:
          type: object
          additionalProperties:
            type: string
          description: Container labels for metadata and management

    RestartHistoryEntry:
      description: Record of a past container restart including reason, timing, and outcome
      type: object
      additionalProperties: false
      required:
      - timestamp
      - reason
      properties:
        timestamp:
          type: string
          format: date-time
          description: When the restart occurred
        reason:
          type: string
          description: Why the restart was triggered
        priority:
          $ref: '#/components/schemas/RestartPriority'
          description: Priority level used for the restart
        duration:
          type: string
          description: Time taken to restart
        success:
          type: boolean
          description: Whether the restart completed successfully
        error:
          type: string
          description: Error message if restart failed

    # ==========================================================================
    # CONFIGURATION MANAGEMENT SCHEMAS
    # ==========================================================================

    ConfigRollbackRequest:
      description: Request to rollback configuration to the previous version
      type: object
      additionalProperties: false
      required:
      - reason
      properties:
        reason:
          type: string
          description: Why rollback is needed (for auditing)
          example: "auth.jwt_secret broke authentication"

    ConfigRollbackResponse:
      description: Result of a configuration rollback including version changes and affected keys
      type: object
      additionalProperties: false
      required:
      - previousVersion
      - currentVersion
      properties:
        previousVersion:
          type: integer
          description: Config version before rollback
        currentVersion:
          type: integer
          description: Config version after rollback (now active)
        changedKeys:
          type: array
          items:
            type: string
          description: Keys that were reverted
        message:
          type: string
          description: Human-readable rollback summary

    ConfigVersionResponse:
      description: Current configuration version information with metadata about available keys
      type: object
      additionalProperties: false
      required:
      - version
      - timestamp
      properties:
        version:
          type: integer
          description: Current configuration version number
        timestamp:
          type: string
          format: date-time
          description: When current config was applied
        hasPreviousConfig:
          type: boolean
          description: Whether a previous config is available for rollback
        keyCount:
          type: integer
          description: Number of configuration keys (not values for security)
        keyPrefixes:
          type: array
          items:
            type: string
          description: Configuration key prefixes present (e.g., "auth", "database")

    # ============================================================
    # PROCESSING POOL MODELS
    # ============================================================

    AcquireProcessorRequest:
      description: Request to acquire a processor instance from a processing pool
      type: object
      additionalProperties: false
      required:
      - poolType
      properties:
        poolType:
          type: string
          description: Type of processing pool (e.g., "asset-processor", "texture-processor")
        priority:
          type: integer
          default: 0
          description: Request priority (higher = more urgent)
        timeoutSeconds:
          type: integer
          default: 300
          description: How long the lease is valid for
        metadata:
          type: object
          additionalProperties: true
          nullable: true
          description: >-
            Client-provided processing job metadata.
            No Bannou plugin reads specific keys from this field by convention.

    AcquireProcessorResponse:
      description: Response with acquired processor details including lease information
      type: object
      additionalProperties: false
      required:
      - processorId
      - appId
      - leaseId
      - expiresAt
      properties:
        processorId:
          type: string
          description: Unique identifier for this processor instance
        appId:
          type: string
          description: App-id for mesh service invocation to this processor
        leaseId:
          type: string
          format: uuid
          description: Unique lease identifier (used for release)
        expiresAt:
          type: string
          format: date-time
          description: When the lease expires (must release before this)

    ReleaseProcessorRequest:
      description: Request to release a processor back to the pool after processing completes
      type: object
      additionalProperties: false
      required:
      - leaseId
      properties:
        leaseId:
          type: string
          format: uuid
          description: The lease ID returned from AcquireProcessor
        success:
          type: boolean
          default: true
          description: Whether the processing completed successfully
        metrics:
          type: object
          additionalProperties: true
          description: >-
            Client-provided processing metrics (duration, items processed, etc.).
            No Bannou plugin reads specific keys from this field by convention.

    ReleaseProcessorResponse:
      description: Confirmation that a processor was released back to the pool
      type: object
      additionalProperties: false
      required:
      - released
      properties:
        released:
          type: boolean
          description: Whether the processor was successfully released
        processorId:
          type: string
          description: ID of the released processor

    GetPoolStatusRequest:
      description: Request to retrieve status and metrics for a processing pool
      type: object
      additionalProperties: false
      required:
      - poolType
      properties:
        poolType:
          type: string
          description: Type of processing pool to query
        includeMetrics:
          type: boolean
          default: true
          description: Include recent processing metrics

    PoolStatusResponse:
      description: Current status of a processing pool including instance counts and utilization
      type: object
      additionalProperties: false
      required:
      - poolType
      - totalInstances
      - availableInstances
      - busyInstances
      - utilization
      properties:
        poolType:
          type: string
          description: Pool type
        totalInstances:
          type: integer
          description: Total processor instances in the pool
        availableInstances:
          type: integer
          description: Instances ready to accept work
        busyInstances:
          type: integer
          description: Instances currently processing
        queueDepth:
          type: integer
          description: Number of requests waiting for a processor
        utilization:
          type: number
          format: float
          description: Current utilization percentage (0.0 to 1.0)
        minInstances:
          type: integer
          description: Minimum configured instances
        maxInstances:
          type: integer
          description: Maximum configured instances
        scaleUpThreshold:
          type: number
          format: float
          description: Utilization threshold for auto-scale-up
        recentMetrics:
          $ref: '#/components/schemas/PoolMetrics'
          description: Recent processing statistics

    PoolMetrics:
      type: object
      additionalProperties: false
      description: Processing pool performance metrics
      properties:
        jobsCompleted1h:
          type: integer
          description: Jobs completed in the last hour
        jobsFailed1h:
          type: integer
          description: Jobs failed in the last hour
        avgProcessingTimeMs:
          type: integer
          description: Average processing time in milliseconds
        lastScaleEvent:
          type: string
          format: date-time
          description: When the pool was last scaled

    ScalePoolRequest:
      description: Request to scale a processing pool to a target number of instances
      type: object
      additionalProperties: false
      required:
      - poolType
      - targetInstances
      properties:
        poolType:
          type: string
          description: Type of processing pool to scale
        targetInstances:
          type: integer
          minimum: 0
          description: Desired number of instances
        force:
          type: boolean
          default: false
          description: Force scale even if it would interrupt processing

    ScalePoolResponse:
      description: Result of a pool scaling operation with before and after instance counts
      type: object
      additionalProperties: false
      required:
      - poolType
      - previousInstances
      - currentInstances
      properties:
        poolType:
          type: string
          description: Pool type that was scaled
        previousInstances:
          type: integer
          description: Instance count before scaling
        currentInstances:
          type: integer
          description: Instance count after scaling
        scaledUp:
          type: integer
          description: Number of instances added
        scaledDown:
          type: integer
          description: Number of instances removed
        message:
          type: string
          description: Status message

    CleanupPoolRequest:
      description: Request to clean up idle processor instances from a pool
      type: object
      additionalProperties: false
      required:
      - poolType
      properties:
        poolType:
          type: string
          description: Type of processing pool to cleanup
        preserveMinimum:
          type: boolean
          default: true
          description: Keep at least minInstances running

    CleanupPoolResponse:
      description: Result of a pool cleanup operation with removed instance count
      type: object
      additionalProperties: false
      required:
      - poolType
      - instancesRemoved
      properties:
        poolType:
          type: string
          description: Pool type that was cleaned up
        instancesRemoved:
          type: integer
          description: Number of idle instances removed
        currentInstances:
          type: integer
          description: Instance count after cleanup
        message:
          type: string
          description: Status message

