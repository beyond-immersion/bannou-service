openapi: 3.0.3
info:
  title: Orchestrator API
  version: 3.0.0
  description: |
    **Central intelligence for Bannou environment management and service orchestration.**

    **POST-Only API Pattern**: This API uses POST for all operations to support zero-copy
    WebSocket routing. Path parameters are passed in request bodies instead of URLs.
    See docs/BANNOU_DESIGN.md for architectural rationale.

    The orchestrator service provides comprehensive environment lifecycle management:
    - **Environment Provisioning**: Deploy complete environments via API (replaces Makefile/docker-compose)
    - **Dynamic Service Topology**: Reconfigure which services run on which containers at runtime
    - **Multi-Backend Support**: Docker Compose, Docker Swarm, Portainer, and Kubernetes
    - **Infrastructure Health**: Monitor Redis, RabbitMQ, Dapr placement, and custom services
    - **Smart Service Management**: Restart, scale, and configure services based on health metrics
    - **Deployment Presets**: Testing is configured via deployment presets (e.g., http-tests, edge-tests)

    **Backend Priority** (automatic detection):
    1. Kubernetes (most enterprise)
    2. Portainer (API abstraction over Compose/Swarm)
    3. Docker Swarm (cluster orchestration)
    4. Docker Compose (single-host containers)

    **Architecture**: The orchestrator uses DIRECT connections to Redis, RabbitMQ,
    and container APIs for its own infrastructure monitoring. It ALSO has a Dapr
    sidecar (app-id: "orchestrator") so other services can call its APIs via Dapr
    service invocation.

servers:
- url: http://localhost:3500/v1.0/invoke/bannou/method
  description: Dapr sidecar endpoint for service-to-service invocation (orchestrator runs as plugin within bannou)

paths:
  /orchestrator/health/infrastructure:
    post:
      summary: Check infrastructure component health
      description: |
        Validates connectivity and health of core infrastructure components:
        - Redis (direct connection via StackExchange.Redis)
        - RabbitMQ (direct connection via RabbitMQ.Client)
        - Dapr Placement service
      operationId: GetInfrastructureHealth
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InfrastructureHealthRequest'
      responses:
        '200':
          description: Infrastructure health status (check response body for component health)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InfrastructureHealthResponse'

      x-request-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/InfrastructureHealthRequest\"\
        ,\n  \"$defs\": {\n    \"InfrastructureHealthRequest\": {\n      \"type\": \"object\",\n      \"description\": \"\
        Request to check infrastructure health (empty body allowed)\",\n      \"properties\": {\n        \"components\": {\n\
        \          \"type\": \"array\",\n          \"items\": {\n            \"type\": \"string\"\n          },\n        \
        \  \"description\": \"Optional filter for specific components (redis, rabbitmq, placement)\",\n          \"nullable\"\
        : true\n        }\n      }\n    }\n  }\n}"
      x-response-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/InfrastructureHealthResponse\"\
        ,\n  \"$defs\": {\n    \"InfrastructureHealthResponse\": {\n      \"type\": \"object\",\n      \"required\": [\n \
        \       \"healthy\",\n        \"timestamp\",\n        \"components\"\n      ],\n      \"properties\": {\n        \"\
        healthy\": {\n          \"type\": \"boolean\",\n          \"description\": \"Overall infrastructure health status\"\
        \n        },\n        \"timestamp\": {\n          \"type\": \"string\",\n          \"format\": \"date-time\",\n  \
        \        \"description\": \"When health check was performed\"\n        },\n        \"components\": {\n          \"\
        type\": \"array\",\n          \"items\": {\n            \"$ref\": \"#/$defs/ComponentHealth\"\n          },\n    \
        \      \"description\": \"Individual component health status\"\n        }\n      }\n    },\n    \"ComponentHealth\"\
        : {\n      \"type\": \"object\",\n      \"required\": [\n        \"name\",\n        \"status\",\n        \"lastSeen\"\
        \n      ],\n      \"properties\": {\n        \"name\": {\n          \"type\": \"string\",\n          \"description\"\
        : \"Component name (redis, rabbitmq, placement)\"\n        },\n        \"status\": {\n          \"type\": \"string\"\
        ,\n          \"enum\": [\n            \"healthy\",\n            \"degraded\",\n            \"unavailable\"\n     \
        \     ],\n          \"description\": \"Component health status\"\n        },\n        \"lastSeen\": {\n          \"\
        type\": \"string\",\n          \"format\": \"date-time\",\n          \"description\": \"Last successful connection
        time\"\n        },\n        \"message\": {\n          \"type\": \"string\",\n          \"description\": \"Additional
        status information\"\n        },\n        \"metrics\": {\n          \"type\": \"object\",\n          \"additionalProperties\"\
        : true,\n          \"description\": \"Component-specific metrics (e.g., ping time)\"\n        }\n      }\n    }\n\
        \  }\n}"
      x-endpoint-info-json: "{\n  \"summary\": \"Check infrastructure component health\",\n  \"description\": \"Validates
        connectivity and health of core infrastructure components:\\n- Redis (direct connection via StackExchange.Redis)\\
        n- RabbitMQ (direct connection via RabbitMQ.Client)\\n- Dapr Placement service\\n\",\n  \"tags\": [],\n  \"deprecated\"\
        : false,\n  \"operationId\": \"GetInfrastructureHealth\"\n}"
  /orchestrator/health/services:
    post:
      summary: Get health status of all services
      description: |
        Retrieves health information from all services via Redis heartbeat monitoring.
        Uses existing ServiceHeartbeatEvent schema from common-events.yaml.
      operationId: GetServicesHealth
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ServiceHealthRequest'
      responses:
        '200':
          description: Service health report
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceHealthReport'

      x-request-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/ServiceHealthRequest\"\
        ,\n  \"$defs\": {\n    \"ServiceHealthRequest\": {\n      \"type\": \"object\",\n      \"description\": \"Request
        to get service health status (empty body allowed)\",\n      \"properties\": {\n        \"serviceFilter\": {\n    \
        \      \"type\": \"string\",\n          \"description\": \"Optional filter by service name\",\n          \"nullable\"\
        : true\n        }\n      }\n    }\n  }\n}"
      x-response-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/ServiceHealthReport\"\
        ,\n  \"$defs\": {\n    \"ServiceHealthReport\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"\
        timestamp\",\n        \"totalServices\",\n        \"healthPercentage\",\n        \"healthyServices\",\n        \"\
        unhealthyServices\"\n      ],\n      \"properties\": {\n        \"timestamp\": {\n          \"type\": \"string\",\n\
        \          \"format\": \"date-time\",\n          \"description\": \"When report was generated\"\n        },\n    \
        \    \"totalServices\": {\n          \"type\": \"integer\",\n          \"description\": \"Total number of services\"\
        \n        },\n        \"healthPercentage\": {\n          \"type\": \"number\",\n          \"format\": \"float\",\n\
        \          \"description\": \"Percentage of healthy services (0-100)\"\n        },\n        \"healthyServices\": {\n\
        \          \"type\": \"array\",\n          \"items\": {\n            \"$ref\": \"#/$defs/ServiceHealthStatus\"\n \
        \         },\n          \"description\": \"Services with recent heartbeats\"\n        },\n        \"unhealthyServices\"\
        : {\n          \"type\": \"array\",\n          \"items\": {\n            \"$ref\": \"#/$defs/ServiceHealthStatus\"\
        \n          },\n          \"description\": \"Services with expired heartbeats\"\n        }\n      }\n    },\n    \"\
        ServiceHealthStatus\": {\n      \"type\": \"object\",\n      \"description\": \"Service health status from heartbeat
        monitoring.\\nUses ServiceHeartbeatEvent schema from common-events.yaml.\\n\",\n      \"required\": [\n        \"\
        serviceId\",\n        \"appId\",\n        \"status\",\n        \"lastSeen\"\n      ],\n      \"properties\": {\n \
        \       \"serviceId\": {\n          \"type\": \"string\",\n          \"description\": \"Service ID (e.g., \\\"behavior\\\
        \", \\\"accounts\\\")\"\n        },\n        \"appId\": {\n          \"type\": \"string\",\n          \"description\"\
        : \"Dapr app-id (e.g., \\\"bannou\\\", \\\"npc-omega-01\\\")\"\n        },\n        \"status\": {\n          \"type\"\
        : \"string\",\n          \"description\": \"Service status from heartbeat\"\n        },\n        \"lastSeen\": {\n\
        \          \"type\": \"string\",\n          \"format\": \"date-time\",\n          \"description\": \"Last heartbeat
        timestamp\"\n        },\n        \"capacity\": {\n          \"type\": \"object\",\n          \"description\": \"Service
        capacity from heartbeat\",\n          \"properties\": {\n            \"maxConnections\": {\n              \"type\"\
        : \"integer\"\n            },\n            \"currentConnections\": {\n              \"type\": \"integer\"\n      \
        \      },\n            \"cpuUsage\": {\n              \"type\": \"number\",\n              \"format\": \"float\"\n\
        \            },\n            \"memoryUsage\": {\n              \"type\": \"number\",\n              \"format\": \"\
        float\"\n            }\n          }\n        },\n        \"metadata\": {\n          \"type\": \"object\",\n      \
        \    \"additionalProperties\": true,\n          \"description\": \"Additional service metadata\"\n        }\n    \
        \  }\n    }\n  }\n}"
      x-endpoint-info-json: "{\n  \"summary\": \"Get health status of all services\",\n  \"description\": \"Retrieves health
        information from all services via Redis heartbeat monitoring.\\nUses existing ServiceHeartbeatEvent schema from common-events.yaml.\\\
        n\",\n  \"tags\": [],\n  \"deprecated\": false,\n  \"operationId\": \"GetServicesHealth\"\n}"
  /orchestrator/services/restart:
    post:
      summary: Restart service with optional configuration
      description: |
        Performs intelligent service restart based on health metrics.
        Only restarts if truly necessary (e.g., 5+ minute degradation).

        Supports optional environment variable updates during restart.
      operationId: RestartService
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ServiceRestartRequest'
      responses:
        '200':
          description: Service restarted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceRestartResult'
        '400':
          description: Invalid restart request
        '409':
          description: Service restart not needed (healthy status)

      x-request-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/ServiceRestartRequest\"\
        ,\n  \"$defs\": {\n    \"ServiceRestartRequest\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"\
        serviceName\"\n      ],\n      \"properties\": {\n        \"serviceName\": {\n          \"type\": \"string\",\n  \
        \        \"description\": \"Name of service to restart\"\n        },\n        \"environment\": {\n          \"type\"\
        : \"object\",\n          \"additionalProperties\": {\n            \"type\": \"string\"\n          },\n          \"\
        description\": \"Optional environment variable updates\"\n        },\n        \"force\": {\n          \"type\": \"\
        boolean\",\n          \"description\": \"Force restart even if healthy (default false)\"\n        },\n        \"timeout\"\
        : {\n          \"type\": \"integer\",\n          \"description\": \"Timeout for service to become healthy (seconds,
        default 120)\"\n        }\n      }\n    }\n  }\n}"
      x-response-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/ServiceRestartResult\"\
        ,\n  \"$defs\": {\n    \"ServiceRestartResult\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"\
        success\",\n        \"serviceName\",\n        \"duration\"\n      ],\n      \"properties\": {\n        \"success\"\
        : {\n          \"type\": \"boolean\",\n          \"description\": \"Restart success status\"\n        },\n       \
        \ \"serviceName\": {\n          \"type\": \"string\",\n          \"description\": \"Service that was restarted\"\n\
        \        },\n        \"duration\": {\n          \"type\": \"string\",\n          \"description\": \"Time taken to
        restart and become healthy\"\n        },\n        \"previousStatus\": {\n          \"type\": \"string\",\n       \
        \   \"description\": \"Service status before restart\"\n        },\n        \"currentStatus\": {\n          \"type\"\
        : \"string\",\n          \"description\": \"Service status after restart\"\n        },\n        \"message\": {\n \
        \         \"type\": \"string\",\n          \"description\": \"Restart result message\"\n        }\n      }\n    }\n\
        \  }\n}"
      x-endpoint-info-json: "{\n  \"summary\": \"Restart service with optional configuration\",\n  \"description\": \"Performs
        intelligent service restart based on health metrics.\\nOnly restarts if truly necessary (e.g., 5+ minute degradation).\\
        n\\nSupports optional environment variable updates during restart.\\n\",\n  \"tags\": [],\n  \"deprecated\": false,\n\
        \  \"operationId\": \"RestartService\"\n}"
  /orchestrator/services/should-restart:
    post:
      summary: Check if service needs restart
      description: |
        Evaluates service health and determines if restart is necessary.

        Restart logic:
        - Healthy: No restart needed
        - Degraded < 5 min: No restart needed
        - Degraded > 5 min: Restart recommended
        - Unavailable: Restart needed
      operationId: ShouldRestartService
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ShouldRestartServiceRequest'
      responses:
        '200':
          description: Restart recommendation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RestartRecommendation'

  # ============================================================================
  # ENVIRONMENT MANAGEMENT APIs
  # ============================================================================

      x-request-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/ShouldRestartServiceRequest\"\
        ,\n  \"$defs\": {\n    \"ShouldRestartServiceRequest\": {\n      \"type\": \"object\",\n      \"required\": [\n  \
        \      \"serviceName\"\n      ],\n      \"properties\": {\n        \"serviceName\": {\n          \"type\": \"string\"\
        ,\n          \"description\": \"Name of service to evaluate\"\n        }\n      }\n    }\n  }\n}"
      x-response-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/RestartRecommendation\"\
        ,\n  \"$defs\": {\n    \"RestartRecommendation\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"\
        shouldRestart\",\n        \"serviceName\",\n        \"currentStatus\",\n        \"reason\"\n      ],\n      \"properties\"\
        : {\n        \"shouldRestart\": {\n          \"type\": \"boolean\",\n          \"description\": \"Whether restart
        is recommended\"\n        },\n        \"serviceName\": {\n          \"type\": \"string\",\n          \"description\"\
        : \"Service being evaluated\"\n        },\n        \"currentStatus\": {\n          \"type\": \"string\",\n       \
        \   \"description\": \"Current service health status\"\n        },\n        \"lastSeen\": {\n          \"type\": \"\
        string\",\n          \"format\": \"date-time\",\n          \"description\": \"Last heartbeat timestamp\"\n       \
        \ },\n        \"degradedDuration\": {\n          \"type\": \"string\",\n          \"description\": \"How long service
        has been degraded\"\n        },\n        \"reason\": {\n          \"type\": \"string\",\n          \"description\"\
        : \"Explanation for recommendation\"\n        }\n      }\n    }\n  }\n}"
      x-endpoint-info-json: "{\n  \"summary\": \"Check if service needs restart\",\n  \"description\": \"Evaluates service
        health and determines if restart is necessary.\\n\\nRestart logic:\\n- Healthy: No restart needed\\n- Degraded < 5
        min: No restart needed\\n- Degraded > 5 min: Restart recommended\\n- Unavailable: Restart needed\\n\",\n  \"tags\"\
        : [],\n  \"deprecated\": false,\n  \"operationId\": \"ShouldRestartService\"\n}"
  /orchestrator/backends/list:
    post:
      summary: Detect available container orchestration backends
      description: |
        Detects which container orchestration backends are available on this system.
        Returns availability status and capabilities for each backend.

        **Priority Order** (for automatic selection):
        1. Kubernetes - Full cluster orchestration with operators
        2. Portainer - API abstraction over Compose/Swarm with web UI
        3. Docker Swarm - Native Docker cluster orchestration
        4. Docker Compose - Single-host container management

        Detection methods:
        - Kubernetes: Check for kubectl and cluster connectivity
        - Portainer: Check for Portainer API endpoint
        - Swarm: Check `docker info` for swarm mode
        - Compose: Check for docker compose v2 availability
      operationId: GetBackends
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ListBackendsRequest'
      responses:
        '200':
          description: Available backends with capabilities
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BackendsResponse'

      x-request-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/ListBackendsRequest\"\
        ,\n  \"$defs\": {\n    \"ListBackendsRequest\": {\n      \"type\": \"object\",\n      \"description\": \"Request to
        list available backends (empty body allowed)\",\n      \"properties\": {\n        \"refresh\": {\n          \"type\"\
        : \"boolean\",\n          \"default\": false,\n          \"description\": \"Force refresh detection instead of using
        cached results\"\n        }\n      }\n    }\n  }\n}"
      x-response-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/BackendsResponse\"\
        ,\n  \"$defs\": {\n    \"BackendsResponse\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"timestamp\"\
        ,\n        \"backends\",\n        \"recommended\"\n      ],\n      \"properties\": {\n        \"timestamp\": {\n \
        \         \"type\": \"string\",\n          \"format\": \"date-time\",\n          \"description\": \"When detection
        was performed\"\n        },\n        \"backends\": {\n          \"type\": \"array\",\n          \"items\": {\n   \
        \         \"$ref\": \"#/$defs/BackendInfo\"\n          },\n          \"description\": \"All detected backends with
        status\"\n        },\n        \"recommended\": {\n          \"$ref\": \"#/$defs/BackendType\"\n        },\n      \
        \  \"activeBackend\": {\n          \"$ref\": \"#/$defs/BackendType\",\n          \"description\": \"Currently active
        backend (if environment deployed)\"\n        }\n      }\n    },\n    \"BackendInfo\": {\n      \"type\": \"object\"\
        ,\n      \"required\": [\n        \"type\",\n        \"available\",\n        \"priority\"\n      ],\n      \"properties\"\
        : {\n        \"type\": {\n          \"$ref\": \"#/$defs/BackendType\"\n        },\n        \"available\": {\n    \
        \      \"type\": \"boolean\",\n          \"description\": \"Whether this backend is currently available\"\n      \
        \  },\n        \"priority\": {\n          \"type\": \"integer\",\n          \"description\": \"Selection priority
        (1 = highest)\"\n        },\n        \"version\": {\n          \"type\": \"string\",\n          \"description\": \"\
        Backend version (e.g., \\\"1.28.0\\\" for Docker)\"\n        },\n        \"endpoint\": {\n          \"type\": \"string\"\
        ,\n          \"description\": \"Backend API endpoint (if applicable)\"\n        },\n        \"capabilities\": {\n\
        \          \"type\": \"array\",\n          \"items\": {\n            \"type\": \"string\"\n          },\n        \
        \  \"description\": \"Supported capabilities for this backend:\\n- live-topology: Can change service distribution
        without restart\\n- scaling: Can scale services horizontally\\n- rolling-update: Supports rolling deployments\\n-
        secrets: Native secrets management\\n- volumes: Persistent volume support\\n- networks: Custom network creation\\\
        n\"\n        },\n        \"error\": {\n          \"type\": \"string\",\n          \"description\": \"Error message
        if detection failed\"\n        }\n      }\n    },\n    \"BackendType\": {\n      \"type\": \"string\",\n      \"enum\"\
        : [\n        \"kubernetes\",\n        \"portainer\",\n        \"swarm\",\n        \"compose\"\n      ],\n      \"\
        description\": \"Container orchestration backend type.\\nPriority order: kubernetes > portainer > swarm > compose\\\
        n\"\n    }\n  }\n}"
      x-endpoint-info-json: "{\n  \"summary\": \"Detect available container orchestration backends\",\n  \"description\":
        \"Detects which container orchestration backends are available on this system.\\nReturns availability status and capabilities
        for each backend.\\n\\n**Priority Order** (for automatic selection):\\n1. Kubernetes - Full cluster orchestration
        with operators\\n2. Portainer - API abstraction over Compose/Swarm with web UI\\n3. Docker Swarm - Native Docker cluster
        orchestration\\n4. Docker Compose - Single-host container management\\n\\nDetection methods:\\n- Kubernetes: Check
        for kubectl and cluster connectivity\\n- Portainer: Check for Portainer API endpoint\\n- Swarm: Check `docker info`
        for swarm mode\\n- Compose: Check for docker compose v2 availability\\n\",\n  \"tags\": [],\n  \"deprecated\": false,\n\
        \  \"operationId\": \"GetBackends\"\n}"
  /orchestrator/presets/list:
    post:
      summary: List available deployment presets
      description: |
        Returns all available deployment presets from the orchestrator's preset directory.
        Presets define service combinations and configuration for specific use cases.

        Built-in presets:
        - `local-development`: All services in single container with Dapr
        - `local-testing`: Test environment with infrastructure services
        - `integration-http`: HTTP integration testing preset
        - `integration-edge`: WebSocket/edge testing preset
        - `split-auth-accounts`: Auth and Accounts in separate containers
        - `distributed-npc`: NPC processing distributed across nodes
      operationId: GetPresets
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ListPresetsRequest'
      responses:
        '200':
          description: Available deployment presets
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PresetsResponse'

      x-request-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/ListPresetsRequest\"\
        ,\n  \"$defs\": {\n    \"ListPresetsRequest\": {\n      \"type\": \"object\",\n      \"description\": \"Request to
        list available presets (empty body allowed)\",\n      \"properties\": {\n        \"category\": {\n          \"type\"\
        : \"string\",\n          \"enum\": [\n            \"development\",\n            \"testing\",\n            \"production\"\
        ,\n            \"custom\"\n          ],\n          \"description\": \"Optional filter by category\",\n          \"\
        nullable\": true\n        }\n      }\n    }\n  }\n}"
      x-response-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/PresetsResponse\"\
        ,\n  \"$defs\": {\n    \"PresetsResponse\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"presets\"\
        \n      ],\n      \"properties\": {\n        \"presets\": {\n          \"type\": \"array\",\n          \"items\":
        {\n            \"$ref\": \"#/$defs/DeploymentPreset\"\n          },\n          \"description\": \"Available deployment
        presets\"\n        },\n        \"activePreset\": {\n          \"type\": \"string\",\n          \"description\": \"\
        Currently active preset name (if any)\"\n        }\n      }\n    },\n    \"DeploymentPreset\": {\n      \"type\":
        \"object\",\n      \"required\": [\n        \"name\",\n        \"description\",\n        \"topology\"\n      ],\n\
        \      \"properties\": {\n        \"name\": {\n          \"type\": \"string\",\n          \"description\": \"Unique
        preset identifier (e.g., \\\"local-development\\\")\"\n        },\n        \"description\": {\n          \"type\"\
        : \"string\",\n          \"description\": \"Human-readable preset description\"\n        },\n        \"category\"\
        : {\n          \"type\": \"string\",\n          \"enum\": [\n            \"development\",\n            \"testing\"\
        ,\n            \"production\",\n            \"custom\"\n          ],\n          \"description\": \"Preset category\"\
        \n        },\n        \"topology\": {\n          \"$ref\": \"#/$defs/ServiceTopology\"\n        },\n        \"environment\"\
        : {\n          \"type\": \"object\",\n          \"additionalProperties\": {\n            \"type\": \"string\"\n  \
        \        },\n          \"description\": \"Default environment variables for this preset\"\n        },\n        \"\
        requiredBackends\": {\n          \"type\": \"array\",\n          \"items\": {\n            \"$ref\": \"#/$defs/BackendType\"\
        \n          },\n          \"description\": \"Backends that support this preset (empty = all)\"\n        },\n     \
        \   \"builtIn\": {\n          \"type\": \"boolean\",\n          \"description\": \"Whether this is a built-in preset\"\
        \n        },\n        \"filePath\": {\n          \"type\": \"string\",\n          \"description\": \"Path to preset
        configuration file\"\n        }\n      }\n    },\n    \"ServiceTopology\": {\n      \"type\": \"object\",\n      \"\
        required\": [\n        \"nodes\"\n      ],\n      \"properties\": {\n        \"nodes\": {\n          \"type\": \"\
        array\",\n          \"items\": {\n            \"$ref\": \"#/$defs/TopologyNode\"\n          },\n          \"description\"\
        : \"Container/pod definitions with service assignments\"\n        },\n        \"infrastructure\": {\n          \"\
        $ref\": \"#/$defs/InfrastructureConfig\",\n          \"description\": \"Infrastructure service configuration\"\n \
        \       }\n      }\n    },\n    \"TopologyNode\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"\
        name\",\n        \"services\"\n      ],\n      \"properties\": {\n        \"name\": {\n          \"type\": \"string\"\
        ,\n          \"description\": \"Node/container name (e.g., \\\"bannou-main\\\", \\\"bannou-auth\\\")\"\n        },\n\
        \        \"services\": {\n          \"type\": \"array\",\n          \"items\": {\n            \"type\": \"string\"\
        \n          },\n          \"description\": \"Services enabled on this node.\\nUses {SERVICE}_SERVICE_ENABLED=true
        pattern.\\nExample: [\\\"accounts\\\", \\\"auth\\\", \\\"permissions\\\"]\\n\"\n        },\n        \"replicas\":
        {\n          \"type\": \"integer\",\n          \"default\": 1,\n          \"description\": \"Number of replicas for
        this node\"\n        },\n        \"resources\": {\n          \"$ref\": \"#/$defs/ResourceLimits\"\n        },\n  \
        \      \"environment\": {\n          \"type\": \"object\",\n          \"additionalProperties\": {\n            \"\
        type\": \"string\"\n          },\n          \"description\": \"Node-specific environment overrides\"\n        },\n\
        \        \"daprEnabled\": {\n          \"type\": \"boolean\",\n          \"default\": true,\n          \"description\"\
        : \"Whether to attach Dapr sidecar\"\n        },\n        \"daprAppId\": {\n          \"type\": \"string\",\n    \
        \      \"description\": \"Dapr app-id override (default derives from node name)\"\n        }\n      }\n    },\n  \
        \  \"ResourceLimits\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"cpuLimit\": {\n        \
        \  \"type\": \"string\",\n          \"description\": \"CPU limit (e.g., \\\"0.5\\\", \\\"2\\\")\"\n        },\n  \
        \      \"memoryLimit\": {\n          \"type\": \"string\",\n          \"description\": \"Memory limit (e.g., \\\"\
        512m\\\", \\\"2g\\\")\"\n        },\n        \"cpuRequest\": {\n          \"type\": \"string\",\n          \"description\"\
        : \"CPU request (Kubernetes)\"\n        },\n        \"memoryRequest\": {\n          \"type\": \"string\",\n      \
        \    \"description\": \"Memory request (Kubernetes)\"\n        }\n      }\n    },\n    \"InfrastructureConfig\": {\n\
        \      \"type\": \"object\",\n      \"properties\": {\n        \"redis\": {\n          \"$ref\": \"#/$defs/InfraServiceConfig\"\
        \n        },\n        \"rabbitmq\": {\n          \"$ref\": \"#/$defs/InfraServiceConfig\"\n        },\n        \"\
        mysql\": {\n          \"$ref\": \"#/$defs/InfraServiceConfig\"\n        },\n        \"placement\": {\n          \"\
        $ref\": \"#/$defs/InfraServiceConfig\",\n          \"description\": \"Dapr placement service\"\n        },\n     \
        \   \"ingress\": {\n          \"$ref\": \"#/$defs/IngressConfig\"\n        }\n      }\n    },\n    \"InfraServiceConfig\"\
        : {\n      \"type\": \"object\",\n      \"properties\": {\n        \"enabled\": {\n          \"type\": \"boolean\"\
        ,\n          \"default\": true\n        },\n        \"image\": {\n          \"type\": \"string\",\n          \"description\"\
        : \"Docker image override\"\n        },\n        \"resources\": {\n          \"$ref\": \"#/$defs/ResourceLimits\"\n\
        \        },\n        \"environment\": {\n          \"type\": \"object\",\n          \"additionalProperties\": {\n\
        \            \"type\": \"string\"\n          }\n        },\n        \"volumes\": {\n          \"type\": \"array\"\
        ,\n          \"items\": {\n            \"type\": \"string\"\n          },\n          \"description\": \"Volume mounts\"\
        \n        }\n      }\n    },\n    \"IngressConfig\": {\n      \"type\": \"object\",\n      \"properties\": {\n   \
        \     \"enabled\": {\n          \"type\": \"boolean\",\n          \"default\": true\n        },\n        \"type\"\
        : {\n          \"type\": \"string\",\n          \"enum\": [\n            \"openresty\",\n            \"nginx\",\n\
        \            \"traefik\",\n            \"none\"\n          ],\n          \"default\": \"openresty\"\n        },\n\
        \        \"ports\": {\n          \"type\": \"object\",\n          \"properties\": {\n            \"http\": {\n   \
        \           \"type\": \"integer\",\n              \"default\": 80\n            },\n            \"https\": {\n    \
        \          \"type\": \"integer\",\n              \"default\": 443\n            }\n          }\n        },\n      \
        \  \"ssl\": {\n          \"type\": \"boolean\",\n          \"default\": false\n        }\n      }\n    },\n    \"\
        BackendType\": {\n      \"type\": \"string\",\n      \"enum\": [\n        \"kubernetes\",\n        \"portainer\",\n\
        \        \"swarm\",\n        \"compose\"\n      ],\n      \"description\": \"Container orchestration backend type.\\
        nPriority order: kubernetes > portainer > swarm > compose\\n\"\n    }\n  }\n}"
      x-endpoint-info-json: "{\n  \"summary\": \"List available deployment presets\",\n  \"description\": \"Returns all available
        deployment presets from the orchestrator's preset directory.\\nPresets define service combinations and configuration
        for specific use cases.\\n\\nBuilt-in presets:\\n- `local-development`: All services in single container with Dapr\\
        n- `local-testing`: Test environment with infrastructure services\\n- `integration-http`: HTTP integration testing
        preset\\n- `integration-edge`: WebSocket/edge testing preset\\n- `split-auth-accounts`: Auth and Accounts in separate
        containers\\n- `distributed-npc`: NPC processing distributed across nodes\\n\",\n  \"tags\": [],\n  \"deprecated\"\
        : false,\n  \"operationId\": \"GetPresets\"\n}"
  /orchestrator/deploy:
    post:
      summary: Deploy or update an environment
      description: |
        Deploys a complete environment using a preset or custom configuration.
        Supports graceful transitions, forced deployments, and clean rebuilds.

        **Deployment Modes**:
        - `graceful`: Wait for existing connections to drain before changing topology
        - `force`: Immediately apply changes (may interrupt active connections)
        - `clean`: Tear down completely and rebuild from scratch

        **Backend Selection**:
        - If `backend` not specified, uses highest-priority available backend
        - If `backend` specified but unavailable, returns error (no fallback)

        **Live Topology Changes**:
        Supports changing service distribution without full restart:
        - Move auth/accounts to separate container while keeping other services together
        - Scale specific services to additional nodes
        - Update environment variables without restart (where supported)
      operationId: Deploy
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeployRequest'
      responses:
        '200':
          description: Deployment initiated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeployResponse'
        '400':
          description: Invalid deployment configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Backend not available (when explicitly requested)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Deployment failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

      x-request-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/DeployRequest\"\
        ,\n  \"$defs\": {\n    \"DeployRequest\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"preset\"\
        : {\n          \"type\": \"string\",\n          \"description\": \"Preset name to deploy (mutually exclusive with
        topology)\"\n        },\n        \"topology\": {\n          \"$ref\": \"#/$defs/ServiceTopology\",\n          \"description\"\
        : \"Custom topology (mutually exclusive with preset)\"\n        },\n        \"backend\": {\n          \"$ref\": \"\
        #/$defs/BackendType\",\n          \"description\": \"Specific backend to use (fails if unavailable)\"\n        },\n\
        \        \"mode\": {\n          \"$ref\": \"#/$defs/DeploymentMode\",\n          \"default\": \"graceful\"\n     \
        \   },\n        \"environment\": {\n          \"type\": \"object\",\n          \"additionalProperties\": {\n     \
        \       \"type\": \"string\"\n          },\n          \"description\": \"Environment variable overrides\"\n      \
        \  },\n        \"timeout\": {\n          \"type\": \"integer\",\n          \"default\": 300,\n          \"description\"\
        : \"Deployment timeout in seconds\"\n        },\n        \"waitForHealthy\": {\n          \"type\": \"boolean\",\n\
        \          \"default\": true,\n          \"description\": \"Wait for all services to report healthy\"\n        }\n\
        \      }\n    },\n    \"ServiceTopology\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"nodes\"\
        \n      ],\n      \"properties\": {\n        \"nodes\": {\n          \"type\": \"array\",\n          \"items\": {\n\
        \            \"$ref\": \"#/$defs/TopologyNode\"\n          },\n          \"description\": \"Container/pod definitions
        with service assignments\"\n        },\n        \"infrastructure\": {\n          \"$ref\": \"#/$defs/InfrastructureConfig\"\
        ,\n          \"description\": \"Infrastructure service configuration\"\n        }\n      }\n    },\n    \"TopologyNode\"\
        : {\n      \"type\": \"object\",\n      \"required\": [\n        \"name\",\n        \"services\"\n      ],\n     \
        \ \"properties\": {\n        \"name\": {\n          \"type\": \"string\",\n          \"description\": \"Node/container
        name (e.g., \\\"bannou-main\\\", \\\"bannou-auth\\\")\"\n        },\n        \"services\": {\n          \"type\":
        \"array\",\n          \"items\": {\n            \"type\": \"string\"\n          },\n          \"description\": \"\
        Services enabled on this node.\\nUses {SERVICE}_SERVICE_ENABLED=true pattern.\\nExample: [\\\"accounts\\\", \\\"auth\\\
        \", \\\"permissions\\\"]\\n\"\n        },\n        \"replicas\": {\n          \"type\": \"integer\",\n          \"\
        default\": 1,\n          \"description\": \"Number of replicas for this node\"\n        },\n        \"resources\"\
        : {\n          \"$ref\": \"#/$defs/ResourceLimits\"\n        },\n        \"environment\": {\n          \"type\": \"\
        object\",\n          \"additionalProperties\": {\n            \"type\": \"string\"\n          },\n          \"description\"\
        : \"Node-specific environment overrides\"\n        },\n        \"daprEnabled\": {\n          \"type\": \"boolean\"\
        ,\n          \"default\": true,\n          \"description\": \"Whether to attach Dapr sidecar\"\n        },\n     \
        \   \"daprAppId\": {\n          \"type\": \"string\",\n          \"description\": \"Dapr app-id override (default
        derives from node name)\"\n        }\n      }\n    },\n    \"ResourceLimits\": {\n      \"type\": \"object\",\n  \
        \    \"properties\": {\n        \"cpuLimit\": {\n          \"type\": \"string\",\n          \"description\": \"CPU
        limit (e.g., \\\"0.5\\\", \\\"2\\\")\"\n        },\n        \"memoryLimit\": {\n          \"type\": \"string\",\n\
        \          \"description\": \"Memory limit (e.g., \\\"512m\\\", \\\"2g\\\")\"\n        },\n        \"cpuRequest\"\
        : {\n          \"type\": \"string\",\n          \"description\": \"CPU request (Kubernetes)\"\n        },\n      \
        \  \"memoryRequest\": {\n          \"type\": \"string\",\n          \"description\": \"Memory request (Kubernetes)\"\
        \n        }\n      }\n    },\n    \"InfrastructureConfig\": {\n      \"type\": \"object\",\n      \"properties\":
        {\n        \"redis\": {\n          \"$ref\": \"#/$defs/InfraServiceConfig\"\n        },\n        \"rabbitmq\": {\n\
        \          \"$ref\": \"#/$defs/InfraServiceConfig\"\n        },\n        \"mysql\": {\n          \"$ref\": \"#/$defs/InfraServiceConfig\"\
        \n        },\n        \"placement\": {\n          \"$ref\": \"#/$defs/InfraServiceConfig\",\n          \"description\"\
        : \"Dapr placement service\"\n        },\n        \"ingress\": {\n          \"$ref\": \"#/$defs/IngressConfig\"\n\
        \        }\n      }\n    },\n    \"InfraServiceConfig\": {\n      \"type\": \"object\",\n      \"properties\": {\n\
        \        \"enabled\": {\n          \"type\": \"boolean\",\n          \"default\": true\n        },\n        \"image\"\
        : {\n          \"type\": \"string\",\n          \"description\": \"Docker image override\"\n        },\n        \"\
        resources\": {\n          \"$ref\": \"#/$defs/ResourceLimits\"\n        },\n        \"environment\": {\n         \
        \ \"type\": \"object\",\n          \"additionalProperties\": {\n            \"type\": \"string\"\n          }\n  \
        \      },\n        \"volumes\": {\n          \"type\": \"array\",\n          \"items\": {\n            \"type\": \"\
        string\"\n          },\n          \"description\": \"Volume mounts\"\n        }\n      }\n    },\n    \"IngressConfig\"\
        : {\n      \"type\": \"object\",\n      \"properties\": {\n        \"enabled\": {\n          \"type\": \"boolean\"\
        ,\n          \"default\": true\n        },\n        \"type\": {\n          \"type\": \"string\",\n          \"enum\"\
        : [\n            \"openresty\",\n            \"nginx\",\n            \"traefik\",\n            \"none\"\n        \
        \  ],\n          \"default\": \"openresty\"\n        },\n        \"ports\": {\n          \"type\": \"object\",\n \
        \         \"properties\": {\n            \"http\": {\n              \"type\": \"integer\",\n              \"default\"\
        : 80\n            },\n            \"https\": {\n              \"type\": \"integer\",\n              \"default\": 443\n\
        \            }\n          }\n        },\n        \"ssl\": {\n          \"type\": \"boolean\",\n          \"default\"\
        : false\n        }\n      }\n    },\n    \"BackendType\": {\n      \"type\": \"string\",\n      \"enum\": [\n    \
        \    \"kubernetes\",\n        \"portainer\",\n        \"swarm\",\n        \"compose\"\n      ],\n      \"description\"\
        : \"Container orchestration backend type.\\nPriority order: kubernetes > portainer > swarm > compose\\n\"\n    },\n\
        \    \"DeploymentMode\": {\n      \"type\": \"string\",\n      \"enum\": [\n        \"graceful\",\n        \"force\"\
        ,\n        \"clean\"\n      ],\n      \"description\": \"Deployment mode:\\n- graceful: Wait for connections to drain\\
        n- force: Apply immediately\\n- clean: Tear down and rebuild\\n\"\n    }\n  }\n}"
      x-response-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/DeployResponse\"\
        ,\n  \"$defs\": {\n    \"DeployResponse\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"success\"\
        ,\n        \"deploymentId\",\n        \"backend\",\n        \"duration\"\n      ],\n      \"properties\": {\n    \
        \    \"success\": {\n          \"type\": \"boolean\",\n          \"description\": \"Deployment succeeded\"\n     \
        \   },\n        \"deploymentId\": {\n          \"type\": \"string\",\n          \"description\": \"Unique deployment
        identifier for tracking\"\n        },\n        \"backend\": {\n          \"$ref\": \"#/$defs/BackendType\"\n     \
        \   },\n        \"preset\": {\n          \"type\": \"string\",\n          \"description\": \"Preset used (if applicable)\"\
        \n        },\n        \"duration\": {\n          \"type\": \"string\",\n          \"description\": \"Time taken to
        deploy\"\n        },\n        \"topology\": {\n          \"$ref\": \"#/$defs/ServiceTopology\",\n          \"description\"\
        : \"Final applied topology\"\n        },\n        \"services\": {\n          \"type\": \"array\",\n          \"items\"\
        : {\n            \"$ref\": \"#/$defs/DeployedService\"\n          },\n          \"description\": \"Status of deployed
        services\"\n        },\n        \"warnings\": {\n          \"type\": \"array\",\n          \"items\": {\n        \
        \    \"type\": \"string\"\n          },\n          \"description\": \"Non-fatal warnings during deployment\"\n   \
        \     },\n        \"message\": {\n          \"type\": \"string\",\n          \"description\": \"Human-readable deployment
        summary\"\n        }\n      }\n    },\n    \"BackendType\": {\n      \"type\": \"string\",\n      \"enum\": [\n  \
        \      \"kubernetes\",\n        \"portainer\",\n        \"swarm\",\n        \"compose\"\n      ],\n      \"description\"\
        : \"Container orchestration backend type.\\nPriority order: kubernetes > portainer > swarm > compose\\n\"\n    },\n\
        \    \"ServiceTopology\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"nodes\"\n      ],\n   \
        \   \"properties\": {\n        \"nodes\": {\n          \"type\": \"array\",\n          \"items\": {\n            \"\
        $ref\": \"#/$defs/TopologyNode\"\n          },\n          \"description\": \"Container/pod definitions with service
        assignments\"\n        },\n        \"infrastructure\": {\n          \"$ref\": \"#/$defs/InfrastructureConfig\",\n\
        \          \"description\": \"Infrastructure service configuration\"\n        }\n      }\n    },\n    \"TopologyNode\"\
        : {\n      \"type\": \"object\",\n      \"required\": [\n        \"name\",\n        \"services\"\n      ],\n     \
        \ \"properties\": {\n        \"name\": {\n          \"type\": \"string\",\n          \"description\": \"Node/container
        name (e.g., \\\"bannou-main\\\", \\\"bannou-auth\\\")\"\n        },\n        \"services\": {\n          \"type\":
        \"array\",\n          \"items\": {\n            \"type\": \"string\"\n          },\n          \"description\": \"\
        Services enabled on this node.\\nUses {SERVICE}_SERVICE_ENABLED=true pattern.\\nExample: [\\\"accounts\\\", \\\"auth\\\
        \", \\\"permissions\\\"]\\n\"\n        },\n        \"replicas\": {\n          \"type\": \"integer\",\n          \"\
        default\": 1,\n          \"description\": \"Number of replicas for this node\"\n        },\n        \"resources\"\
        : {\n          \"$ref\": \"#/$defs/ResourceLimits\"\n        },\n        \"environment\": {\n          \"type\": \"\
        object\",\n          \"additionalProperties\": {\n            \"type\": \"string\"\n          },\n          \"description\"\
        : \"Node-specific environment overrides\"\n        },\n        \"daprEnabled\": {\n          \"type\": \"boolean\"\
        ,\n          \"default\": true,\n          \"description\": \"Whether to attach Dapr sidecar\"\n        },\n     \
        \   \"daprAppId\": {\n          \"type\": \"string\",\n          \"description\": \"Dapr app-id override (default
        derives from node name)\"\n        }\n      }\n    },\n    \"ResourceLimits\": {\n      \"type\": \"object\",\n  \
        \    \"properties\": {\n        \"cpuLimit\": {\n          \"type\": \"string\",\n          \"description\": \"CPU
        limit (e.g., \\\"0.5\\\", \\\"2\\\")\"\n        },\n        \"memoryLimit\": {\n          \"type\": \"string\",\n\
        \          \"description\": \"Memory limit (e.g., \\\"512m\\\", \\\"2g\\\")\"\n        },\n        \"cpuRequest\"\
        : {\n          \"type\": \"string\",\n          \"description\": \"CPU request (Kubernetes)\"\n        },\n      \
        \  \"memoryRequest\": {\n          \"type\": \"string\",\n          \"description\": \"Memory request (Kubernetes)\"\
        \n        }\n      }\n    },\n    \"InfrastructureConfig\": {\n      \"type\": \"object\",\n      \"properties\":
        {\n        \"redis\": {\n          \"$ref\": \"#/$defs/InfraServiceConfig\"\n        },\n        \"rabbitmq\": {\n\
        \          \"$ref\": \"#/$defs/InfraServiceConfig\"\n        },\n        \"mysql\": {\n          \"$ref\": \"#/$defs/InfraServiceConfig\"\
        \n        },\n        \"placement\": {\n          \"$ref\": \"#/$defs/InfraServiceConfig\",\n          \"description\"\
        : \"Dapr placement service\"\n        },\n        \"ingress\": {\n          \"$ref\": \"#/$defs/IngressConfig\"\n\
        \        }\n      }\n    },\n    \"InfraServiceConfig\": {\n      \"type\": \"object\",\n      \"properties\": {\n\
        \        \"enabled\": {\n          \"type\": \"boolean\",\n          \"default\": true\n        },\n        \"image\"\
        : {\n          \"type\": \"string\",\n          \"description\": \"Docker image override\"\n        },\n        \"\
        resources\": {\n          \"$ref\": \"#/$defs/ResourceLimits\"\n        },\n        \"environment\": {\n         \
        \ \"type\": \"object\",\n          \"additionalProperties\": {\n            \"type\": \"string\"\n          }\n  \
        \      },\n        \"volumes\": {\n          \"type\": \"array\",\n          \"items\": {\n            \"type\": \"\
        string\"\n          },\n          \"description\": \"Volume mounts\"\n        }\n      }\n    },\n    \"IngressConfig\"\
        : {\n      \"type\": \"object\",\n      \"properties\": {\n        \"enabled\": {\n          \"type\": \"boolean\"\
        ,\n          \"default\": true\n        },\n        \"type\": {\n          \"type\": \"string\",\n          \"enum\"\
        : [\n            \"openresty\",\n            \"nginx\",\n            \"traefik\",\n            \"none\"\n        \
        \  ],\n          \"default\": \"openresty\"\n        },\n        \"ports\": {\n          \"type\": \"object\",\n \
        \         \"properties\": {\n            \"http\": {\n              \"type\": \"integer\",\n              \"default\"\
        : 80\n            },\n            \"https\": {\n              \"type\": \"integer\",\n              \"default\": 443\n\
        \            }\n          }\n        },\n        \"ssl\": {\n          \"type\": \"boolean\",\n          \"default\"\
        : false\n        }\n      }\n    },\n    \"DeployedService\": {\n      \"type\": \"object\",\n      \"required\":
        [\n        \"name\",\n        \"status\",\n        \"node\"\n      ],\n      \"properties\": {\n        \"name\":
        {\n          \"type\": \"string\",\n          \"description\": \"Service name\"\n        },\n        \"status\": {\n\
        \          \"type\": \"string\",\n          \"enum\": [\n            \"starting\",\n            \"running\",\n   \
        \         \"healthy\",\n            \"unhealthy\",\n            \"stopped\"\n          ]\n        },\n        \"node\"\
        : {\n          \"type\": \"string\",\n          \"description\": \"Node/container hosting this service\"\n       \
        \ },\n        \"containerId\": {\n          \"type\": \"string\",\n          \"description\": \"Container ID (Compose/Swarm)\"\
        \n        },\n        \"podName\": {\n          \"type\": \"string\",\n          \"description\": \"Pod name (Kubernetes)\"\
        \n        },\n        \"endpoints\": {\n          \"type\": \"array\",\n          \"items\": {\n            \"type\"\
        : \"string\"\n          },\n          \"description\": \"Exposed endpoints\"\n        }\n      }\n    }\n  }\n}"
      x-endpoint-info-json: "{\n  \"summary\": \"Deploy or update an environment\",\n  \"description\": \"Deploys a complete
        environment using a preset or custom configuration.\\nSupports graceful transitions, forced deployments, and clean
        rebuilds.\\n\\n**Deployment Modes**:\\n- `graceful`: Wait for existing connections to drain before changing topology\\
        n- `force`: Immediately apply changes (may interrupt active connections)\\n- `clean`: Tear down completely and rebuild
        from scratch\\n\\n**Backend Selection**:\\n- If `backend` not specified, uses highest-priority available backend\\
        n- If `backend` specified but unavailable, returns error (no fallback)\\n\\n**Live Topology Changes**:\\nSupports
        changing service distribution without full restart:\\n- Move auth/accounts to separate container while keeping other
        services together\\n- Scale specific services to additional nodes\\n- Update environment variables without restart
        (where supported)\\n\",\n  \"tags\": [],\n  \"deprecated\": false,\n  \"operationId\": \"Deploy\"\n}"
  /orchestrator/service-routing:
    post:
      summary: Get current service-to-app-id routing mappings
      description: |
        Returns the current service-to-app-id routing mappings used for Dapr service invocation.
        This is the authoritative source of truth for how services are routed in the current deployment.

        In development, all services route to "bannou" by default. In production, services may be
        distributed across multiple app-ids based on deployment topology.

        **Use Cases**:
        - Services querying routing on startup
        - Debugging service communication issues
        - Monitoring deployment topology
      operationId: GetServiceRouting
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetServiceRoutingRequest'
      responses:
        '200':
          description: Service routing mappings
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceRoutingResponse'

      x-request-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/GetServiceRoutingRequest\"\
        ,\n  \"$defs\": {\n    \"GetServiceRoutingRequest\": {\n      \"type\": \"object\",\n      \"description\": \"Request
        to get service routing mappings (empty body allowed)\",\n      \"properties\": {\n        \"serviceFilter\": {\n \
        \         \"type\": \"string\",\n          \"description\": \"Optional filter by service name prefix\",\n        \
        \  \"nullable\": true\n        }\n      }\n    }\n  }\n}"
      x-response-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/ServiceRoutingResponse\"\
        ,\n  \"$defs\": {\n    \"ServiceRoutingResponse\": {\n      \"type\": \"object\",\n      \"required\": [\n       \
        \ \"mappings\",\n        \"defaultAppId\",\n        \"generatedAt\"\n      ],\n      \"properties\": {\n        \"\
        mappings\": {\n          \"type\": \"object\",\n          \"additionalProperties\": {\n            \"type\": \"string\"\
        \n          },\n          \"description\": \"Map of service names to Dapr app-id routing destinations.\\nExample:
        { \\\"accounts\\\": \\\"bannou\\\", \\\"behavior\\\": \\\"npc-processing-01\\\" }\\n\"\n        },\n        \"defaultAppId\"\
        : {\n          \"type\": \"string\",\n          \"description\": \"Default app-id used when no specific mapping exists\"\
        ,\n          \"default\": \"bannou\"\n        },\n        \"generatedAt\": {\n          \"type\": \"string\",\n  \
        \        \"format\": \"date-time\",\n          \"description\": \"When this routing information was generated\"\n\
        \        },\n        \"totalServices\": {\n          \"type\": \"integer\",\n          \"description\": \"Total number
        of services with routing mappings\",\n          \"minimum\": 0\n        },\n        \"deploymentId\": {\n        \
        \  \"type\": \"string\",\n          \"description\": \"Current deployment identifier (if environment is deployed)\"\
        ,\n          \"nullable\": true\n        }\n      }\n    }\n  }\n}"
      x-endpoint-info-json: "{\n  \"summary\": \"Get current service-to-app-id routing mappings\",\n  \"description\": \"\
        Returns the current service-to-app-id routing mappings used for Dapr service invocation.\\nThis is the authoritative
        source of truth for how services are routed in the current deployment.\\n\\nIn development, all services route to
        \\\"bannou\\\" by default. In production, services may be\\ndistributed across multiple app-ids based on deployment
        topology.\\n\\n**Use Cases**:\\n- Services querying routing on startup\\n- Debugging service communication issues\\
        n- Monitoring deployment topology\\n\",\n  \"tags\": [],\n  \"deprecated\": false,\n  \"operationId\": \"GetServiceRouting\"\
        \n}"
  /orchestrator/status:
    post:
      summary: Get current environment status
      description: |
        Returns comprehensive status of the current deployment including:
        - Active backend and deployment configuration
        - Service topology (which services on which containers)
        - Container health and resource usage
        - Infrastructure component status
        - Active preset and any customizations
      operationId: GetStatus
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetStatusRequest'
      responses:
        '200':
          description: Current environment status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvironmentStatus'

      x-request-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/GetStatusRequest\"\
        ,\n  \"$defs\": {\n    \"GetStatusRequest\": {\n      \"type\": \"object\",\n      \"description\": \"Request to get
        environment status (empty body allowed)\",\n      \"properties\": {\n        \"includeResources\": {\n          \"\
        type\": \"boolean\",\n          \"default\": true,\n          \"description\": \"Include resource usage metrics\"\n\
        \        }\n      }\n    }\n  }\n}"
      x-response-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/EnvironmentStatus\"\
        ,\n  \"$defs\": {\n    \"EnvironmentStatus\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"deployed\"\
        ,\n        \"timestamp\"\n      ],\n      \"properties\": {\n        \"deployed\": {\n          \"type\": \"boolean\"\
        ,\n          \"description\": \"Whether an environment is currently deployed\"\n        },\n        \"timestamp\"\
        : {\n          \"type\": \"string\",\n          \"format\": \"date-time\"\n        },\n        \"deploymentId\": {\n\
        \          \"type\": \"string\",\n          \"description\": \"Current deployment identifier\"\n        },\n     \
        \   \"backend\": {\n          \"$ref\": \"#/$defs/BackendType\"\n        },\n        \"preset\": {\n          \"type\"\
        : \"string\",\n          \"description\": \"Active preset name\"\n        },\n        \"topology\": {\n          \"\
        $ref\": \"#/$defs/ServiceTopology\",\n          \"description\": \"Current topology configuration\"\n        },\n\
        \        \"services\": {\n          \"type\": \"array\",\n          \"items\": {\n            \"$ref\": \"#/$defs/DeployedService\"\
        \n          },\n          \"description\": \"All deployed services with status\"\n        },\n        \"infrastructure\"\
        : {\n          \"$ref\": \"#/$defs/InfrastructureHealthResponse\",\n          \"description\": \"Infrastructure component
        health\"\n        },\n        \"resources\": {\n          \"$ref\": \"#/$defs/ResourceUsage\",\n          \"description\"\
        : \"Overall resource usage\"\n        },\n        \"uptime\": {\n          \"type\": \"string\",\n          \"description\"\
        : \"Time since deployment\"\n        }\n      }\n    },\n    \"BackendType\": {\n      \"type\": \"string\",\n   \
        \   \"enum\": [\n        \"kubernetes\",\n        \"portainer\",\n        \"swarm\",\n        \"compose\"\n      ],\n\
        \      \"description\": \"Container orchestration backend type.\\nPriority order: kubernetes > portainer > swarm >
        compose\\n\"\n    },\n    \"ServiceTopology\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"nodes\"\
        \n      ],\n      \"properties\": {\n        \"nodes\": {\n          \"type\": \"array\",\n          \"items\": {\n\
        \            \"$ref\": \"#/$defs/TopologyNode\"\n          },\n          \"description\": \"Container/pod definitions
        with service assignments\"\n        },\n        \"infrastructure\": {\n          \"$ref\": \"#/$defs/InfrastructureConfig\"\
        ,\n          \"description\": \"Infrastructure service configuration\"\n        }\n      }\n    },\n    \"TopologyNode\"\
        : {\n      \"type\": \"object\",\n      \"required\": [\n        \"name\",\n        \"services\"\n      ],\n     \
        \ \"properties\": {\n        \"name\": {\n          \"type\": \"string\",\n          \"description\": \"Node/container
        name (e.g., \\\"bannou-main\\\", \\\"bannou-auth\\\")\"\n        },\n        \"services\": {\n          \"type\":
        \"array\",\n          \"items\": {\n            \"type\": \"string\"\n          },\n          \"description\": \"\
        Services enabled on this node.\\nUses {SERVICE}_SERVICE_ENABLED=true pattern.\\nExample: [\\\"accounts\\\", \\\"auth\\\
        \", \\\"permissions\\\"]\\n\"\n        },\n        \"replicas\": {\n          \"type\": \"integer\",\n          \"\
        default\": 1,\n          \"description\": \"Number of replicas for this node\"\n        },\n        \"resources\"\
        : {\n          \"$ref\": \"#/$defs/ResourceLimits\"\n        },\n        \"environment\": {\n          \"type\": \"\
        object\",\n          \"additionalProperties\": {\n            \"type\": \"string\"\n          },\n          \"description\"\
        : \"Node-specific environment overrides\"\n        },\n        \"daprEnabled\": {\n          \"type\": \"boolean\"\
        ,\n          \"default\": true,\n          \"description\": \"Whether to attach Dapr sidecar\"\n        },\n     \
        \   \"daprAppId\": {\n          \"type\": \"string\",\n          \"description\": \"Dapr app-id override (default
        derives from node name)\"\n        }\n      }\n    },\n    \"ResourceLimits\": {\n      \"type\": \"object\",\n  \
        \    \"properties\": {\n        \"cpuLimit\": {\n          \"type\": \"string\",\n          \"description\": \"CPU
        limit (e.g., \\\"0.5\\\", \\\"2\\\")\"\n        },\n        \"memoryLimit\": {\n          \"type\": \"string\",\n\
        \          \"description\": \"Memory limit (e.g., \\\"512m\\\", \\\"2g\\\")\"\n        },\n        \"cpuRequest\"\
        : {\n          \"type\": \"string\",\n          \"description\": \"CPU request (Kubernetes)\"\n        },\n      \
        \  \"memoryRequest\": {\n          \"type\": \"string\",\n          \"description\": \"Memory request (Kubernetes)\"\
        \n        }\n      }\n    },\n    \"InfrastructureConfig\": {\n      \"type\": \"object\",\n      \"properties\":
        {\n        \"redis\": {\n          \"$ref\": \"#/$defs/InfraServiceConfig\"\n        },\n        \"rabbitmq\": {\n\
        \          \"$ref\": \"#/$defs/InfraServiceConfig\"\n        },\n        \"mysql\": {\n          \"$ref\": \"#/$defs/InfraServiceConfig\"\
        \n        },\n        \"placement\": {\n          \"$ref\": \"#/$defs/InfraServiceConfig\",\n          \"description\"\
        : \"Dapr placement service\"\n        },\n        \"ingress\": {\n          \"$ref\": \"#/$defs/IngressConfig\"\n\
        \        }\n      }\n    },\n    \"InfraServiceConfig\": {\n      \"type\": \"object\",\n      \"properties\": {\n\
        \        \"enabled\": {\n          \"type\": \"boolean\",\n          \"default\": true\n        },\n        \"image\"\
        : {\n          \"type\": \"string\",\n          \"description\": \"Docker image override\"\n        },\n        \"\
        resources\": {\n          \"$ref\": \"#/$defs/ResourceLimits\"\n        },\n        \"environment\": {\n         \
        \ \"type\": \"object\",\n          \"additionalProperties\": {\n            \"type\": \"string\"\n          }\n  \
        \      },\n        \"volumes\": {\n          \"type\": \"array\",\n          \"items\": {\n            \"type\": \"\
        string\"\n          },\n          \"description\": \"Volume mounts\"\n        }\n      }\n    },\n    \"IngressConfig\"\
        : {\n      \"type\": \"object\",\n      \"properties\": {\n        \"enabled\": {\n          \"type\": \"boolean\"\
        ,\n          \"default\": true\n        },\n        \"type\": {\n          \"type\": \"string\",\n          \"enum\"\
        : [\n            \"openresty\",\n            \"nginx\",\n            \"traefik\",\n            \"none\"\n        \
        \  ],\n          \"default\": \"openresty\"\n        },\n        \"ports\": {\n          \"type\": \"object\",\n \
        \         \"properties\": {\n            \"http\": {\n              \"type\": \"integer\",\n              \"default\"\
        : 80\n            },\n            \"https\": {\n              \"type\": \"integer\",\n              \"default\": 443\n\
        \            }\n          }\n        },\n        \"ssl\": {\n          \"type\": \"boolean\",\n          \"default\"\
        : false\n        }\n      }\n    },\n    \"DeployedService\": {\n      \"type\": \"object\",\n      \"required\":
        [\n        \"name\",\n        \"status\",\n        \"node\"\n      ],\n      \"properties\": {\n        \"name\":
        {\n          \"type\": \"string\",\n          \"description\": \"Service name\"\n        },\n        \"status\": {\n\
        \          \"type\": \"string\",\n          \"enum\": [\n            \"starting\",\n            \"running\",\n   \
        \         \"healthy\",\n            \"unhealthy\",\n            \"stopped\"\n          ]\n        },\n        \"node\"\
        : {\n          \"type\": \"string\",\n          \"description\": \"Node/container hosting this service\"\n       \
        \ },\n        \"containerId\": {\n          \"type\": \"string\",\n          \"description\": \"Container ID (Compose/Swarm)\"\
        \n        },\n        \"podName\": {\n          \"type\": \"string\",\n          \"description\": \"Pod name (Kubernetes)\"\
        \n        },\n        \"endpoints\": {\n          \"type\": \"array\",\n          \"items\": {\n            \"type\"\
        : \"string\"\n          },\n          \"description\": \"Exposed endpoints\"\n        }\n      }\n    },\n    \"InfrastructureHealthResponse\"\
        : {\n      \"type\": \"object\",\n      \"required\": [\n        \"healthy\",\n        \"timestamp\",\n        \"\
        components\"\n      ],\n      \"properties\": {\n        \"healthy\": {\n          \"type\": \"boolean\",\n      \
        \    \"description\": \"Overall infrastructure health status\"\n        },\n        \"timestamp\": {\n          \"\
        type\": \"string\",\n          \"format\": \"date-time\",\n          \"description\": \"When health check was performed\"\
        \n        },\n        \"components\": {\n          \"type\": \"array\",\n          \"items\": {\n            \"$ref\"\
        : \"#/$defs/ComponentHealth\"\n          },\n          \"description\": \"Individual component health status\"\n \
        \       }\n      }\n    },\n    \"ComponentHealth\": {\n      \"type\": \"object\",\n      \"required\": [\n     \
        \   \"name\",\n        \"status\",\n        \"lastSeen\"\n      ],\n      \"properties\": {\n        \"name\": {\n\
        \          \"type\": \"string\",\n          \"description\": \"Component name (redis, rabbitmq, placement)\"\n   \
        \     },\n        \"status\": {\n          \"type\": \"string\",\n          \"enum\": [\n            \"healthy\",\n\
        \            \"degraded\",\n            \"unavailable\"\n          ],\n          \"description\": \"Component health
        status\"\n        },\n        \"lastSeen\": {\n          \"type\": \"string\",\n          \"format\": \"date-time\"\
        ,\n          \"description\": \"Last successful connection time\"\n        },\n        \"message\": {\n          \"\
        type\": \"string\",\n          \"description\": \"Additional status information\"\n        },\n        \"metrics\"\
        : {\n          \"type\": \"object\",\n          \"additionalProperties\": true,\n          \"description\": \"Component-specific
        metrics (e.g., ping time)\"\n        }\n      }\n    },\n    \"ResourceUsage\": {\n      \"type\": \"object\",\n \
        \     \"properties\": {\n        \"cpuPercent\": {\n          \"type\": \"number\",\n          \"format\": \"float\"\
        ,\n          \"description\": \"Total CPU usage percentage\"\n        },\n        \"memoryUsedMb\": {\n          \"\
        type\": \"integer\",\n          \"description\": \"Total memory used (MB)\"\n        },\n        \"memoryTotalMb\"\
        : {\n          \"type\": \"integer\",\n          \"description\": \"Total memory available (MB)\"\n        },\n  \
        \      \"diskUsedGb\": {\n          \"type\": \"number\",\n          \"format\": \"float\",\n          \"description\"\
        : \"Disk space used (GB)\"\n        },\n        \"networkInMb\": {\n          \"type\": \"number\",\n          \"\
        format\": \"float\",\n          \"description\": \"Network input (MB)\"\n        },\n        \"networkOutMb\": {\n\
        \          \"type\": \"number\",\n          \"format\": \"float\",\n          \"description\": \"Network output (MB)\"\
        \n        }\n      }\n    }\n  }\n}"
      x-endpoint-info-json: "{\n  \"summary\": \"Get current environment status\",\n  \"description\": \"Returns comprehensive
        status of the current deployment including:\\n- Active backend and deployment configuration\\n- Service topology (which
        services on which containers)\\n- Container health and resource usage\\n- Infrastructure component status\\n- Active
        preset and any customizations\\n\",\n  \"tags\": [],\n  \"deprecated\": false,\n  \"operationId\": \"GetStatus\"\n\
        }"
  /orchestrator/teardown:
    post:
      summary: Tear down the current environment
      description: |
        Tears down all containers and services in the current deployment.
        Optionally preserves volumes and networks for faster redeployment.

        **Teardown Modes**:
        - `graceful`: Signal shutdown and wait for clean exit
        - `force`: Immediately stop all containers (SIGKILL)
        - `preserve-data`: Keep volumes and networks, only remove containers
      operationId: Teardown
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TeardownRequest'
      responses:
        '200':
          description: Teardown completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TeardownResponse'
        '500':
          description: Teardown failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

      x-request-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/TeardownRequest\"\
        ,\n  \"$defs\": {\n    \"TeardownRequest\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"dryRun\"\
        : {\n          \"type\": \"boolean\",\n          \"default\": false,\n          \"description\": \"When true, simulates
        teardown without actually stopping or removing containers.\\nReturns what would be torn down. ALWAYS use dryRun=true
        first to preview the impact.\\n\"\n        },\n        \"mode\": {\n          \"$ref\": \"#/$defs/TeardownMode\",\n\
        \          \"default\": \"graceful\"\n        },\n        \"timeout\": {\n          \"type\": \"integer\",\n     \
        \     \"default\": 60,\n          \"description\": \"Graceful shutdown timeout in seconds\"\n        },\n        \"\
        removeVolumes\": {\n          \"type\": \"boolean\",\n          \"default\": false,\n          \"description\": \"\
        Also remove associated volumes\"\n        },\n        \"removeNetworks\": {\n          \"type\": \"boolean\",\n  \
        \        \"default\": false,\n          \"description\": \"Also remove associated networks\"\n        },\n       \
        \ \"includeInfrastructure\": {\n          \"type\": \"boolean\",\n          \"default\": false,\n          \"description\"\
        : \"When true, also removes support infrastructure (Redis, RabbitMQ, MySQL, etc.).\\nThis is determined by scanning
        compose files or finding containers in the same\\nDocker swarm/Kubernetes namespace as bannou services. USE WITH EXTREME
        CAUTION -\\nthis will destroy all data and require a full re-deployment.\\n\"\n        }\n      }\n    },\n    \"\
        TeardownMode\": {\n      \"type\": \"string\",\n      \"enum\": [\n        \"graceful\",\n        \"force\",\n   \
        \     \"preserve-data\"\n      ],\n      \"description\": \"Teardown mode:\\n- graceful: Signal shutdown, wait for
        clean exit\\n- force: Immediately stop (SIGKILL)\\n- preserve-data: Keep volumes/networks, remove containers\\n\"\n\
        \    }\n  }\n}"
      x-response-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/TeardownResponse\"\
        ,\n  \"$defs\": {\n    \"TeardownResponse\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"success\"\
        ,\n        \"duration\"\n      ],\n      \"properties\": {\n        \"success\": {\n          \"type\": \"boolean\"\
        \n        },\n        \"duration\": {\n          \"type\": \"string\"\n        },\n        \"stoppedContainers\":
        {\n          \"type\": \"array\",\n          \"items\": {\n            \"type\": \"string\"\n          },\n      \
        \    \"description\": \"Container IDs that were stopped\"\n        },\n        \"removedVolumes\": {\n          \"\
        type\": \"array\",\n          \"items\": {\n            \"type\": \"string\"\n          },\n          \"description\"\
        : \"Volumes that were removed\"\n        },\n        \"removedNetworks\": {\n          \"type\": \"array\",\n    \
        \      \"items\": {\n            \"type\": \"string\"\n          },\n          \"description\": \"Networks that were
        removed\"\n        },\n        \"removedInfrastructure\": {\n          \"type\": \"array\",\n          \"items\":
        {\n            \"type\": \"string\"\n          },\n          \"description\": \"Infrastructure services that were
        removed (Redis, RabbitMQ, MySQL, etc.)\"\n        },\n        \"errors\": {\n          \"type\": \"array\",\n    \
        \      \"items\": {\n            \"type\": \"string\"\n          },\n          \"description\": \"Non-fatal errors
        during teardown\"\n        },\n        \"message\": {\n          \"type\": \"string\"\n        }\n      }\n    }\n\
        \  }\n}"
      x-endpoint-info-json: "{\n  \"summary\": \"Tear down the current environment\",\n  \"description\": \"Tears down all
        containers and services in the current deployment.\\nOptionally preserves volumes and networks for faster redeployment.\\
        n\\n**Teardown Modes**:\\n- `graceful`: Signal shutdown and wait for clean exit\\n- `force`: Immediately stop all
        containers (SIGKILL)\\n- `preserve-data`: Keep volumes and networks, only remove containers\\n\",\n  \"tags\": [],\n\
        \  \"deprecated\": false,\n  \"operationId\": \"Teardown\"\n}"
  /orchestrator/clean:
    post:
      summary: Clean up unused resources
      description: |
        Prunes unused Docker resources to reclaim disk space and clean up
        orphaned containers, networks, volumes, and images.

        Equivalent to running various `docker system prune` commands.

        **Clean Targets**:
        - `containers`: Remove stopped containers
        - `networks`: Remove unused networks
        - `volumes`: Remove unused volumes (CAUTION: data loss)
        - `images`: Remove dangling images
        - `all`: All of the above
      operationId: Clean
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CleanRequest'
      responses:
        '200':
          description: Cleanup completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CleanResponse'
        '500':
          description: Cleanup failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

      x-request-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/CleanRequest\"\
        ,\n  \"$defs\": {\n    \"CleanRequest\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"targets\"\
        \n      ],\n      \"properties\": {\n        \"targets\": {\n          \"type\": \"array\",\n          \"items\":
        {\n            \"$ref\": \"#/$defs/CleanTarget\"\n          },\n          \"description\": \"Resources to clean (or
        \\\"all\\\")\"\n        },\n        \"force\": {\n          \"type\": \"boolean\",\n          \"default\": false,\n\
        \          \"description\": \"Force removal without confirmation\"\n        },\n        \"olderThan\": {\n       \
        \   \"type\": \"string\",\n          \"description\": \"Only clean resources older than (e.g., \\\"24h\\\", \\\"7d\\\
        \")\"\n        },\n        \"labelFilter\": {\n          \"type\": \"object\",\n          \"additionalProperties\"\
        : {\n            \"type\": \"string\"\n          },\n          \"description\": \"Only clean resources matching labels\"\
        \n        }\n      }\n    },\n    \"CleanTarget\": {\n      \"type\": \"string\",\n      \"enum\": [\n        \"containers\"\
        ,\n        \"networks\",\n        \"volumes\",\n        \"images\",\n        \"all\"\n      ],\n      \"description\"\
        : \"Type of resource to clean\"\n    }\n  }\n}"
      x-response-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/CleanResponse\"\
        ,\n  \"$defs\": {\n    \"CleanResponse\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"success\"\
        \n      ],\n      \"properties\": {\n        \"success\": {\n          \"type\": \"boolean\"\n        },\n       \
        \ \"reclaimedSpaceMb\": {\n          \"type\": \"integer\",\n          \"description\": \"Disk space reclaimed (MB)\"\
        \n        },\n        \"removedContainers\": {\n          \"type\": \"integer\"\n        },\n        \"removedNetworks\"\
        : {\n          \"type\": \"integer\"\n        },\n        \"removedVolumes\": {\n          \"type\": \"integer\"\n\
        \        },\n        \"removedImages\": {\n          \"type\": \"integer\"\n        },\n        \"errors\": {\n  \
        \        \"type\": \"array\",\n          \"items\": {\n            \"type\": \"string\"\n          }\n        },\n\
        \        \"message\": {\n          \"type\": \"string\"\n        }\n      }\n    }\n  }\n}"
      x-endpoint-info-json: "{\n  \"summary\": \"Clean up unused resources\",\n  \"description\": \"Prunes unused Docker resources
        to reclaim disk space and clean up\\norphaned containers, networks, volumes, and images.\\n\\nEquivalent to running
        various `docker system prune` commands.\\n\\n**Clean Targets**:\\n- `containers`: Remove stopped containers\\n- `networks`:
        Remove unused networks\\n- `volumes`: Remove unused volumes (CAUTION: data loss)\\n- `images`: Remove dangling images\\
        n- `all`: All of the above\\n\",\n  \"tags\": [],\n  \"deprecated\": false,\n  \"operationId\": \"Clean\"\n}"
  /orchestrator/logs:
    post:
      summary: Get service/container logs
      description: |
        Retrieves logs from services or containers with filtering options.
        Supports real-time streaming via WebSocket upgrade.
      operationId: GetLogs
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetLogsRequest'
      responses:
        '200':
          description: Log output
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LogsResponse'
            text/plain:
              schema:
                type: string
        '101':
          description: Switching to WebSocket for streaming (when follow=true)
        '404':
          description: Service or container not found

      x-request-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/GetLogsRequest\"\
        ,\n  \"$defs\": {\n    \"GetLogsRequest\": {\n      \"type\": \"object\",\n      \"description\": \"Request to get
        service/container logs\",\n      \"properties\": {\n        \"service\": {\n          \"type\": \"string\",\n    \
        \      \"description\": \"Service name to get logs for\",\n          \"nullable\": true\n        },\n        \"container\"\
        : {\n          \"type\": \"string\",\n          \"description\": \"Container ID or name (alternative to service)\"\
        ,\n          \"nullable\": true\n        },\n        \"since\": {\n          \"type\": \"string\",\n          \"description\"\
        : \"Return logs since timestamp (RFC3339 or relative like \\\"5m\\\")\",\n          \"nullable\": true\n        },\n\
        \        \"until\": {\n          \"type\": \"string\",\n          \"description\": \"Return logs until timestamp\"\
        ,\n          \"nullable\": true\n        },\n        \"tail\": {\n          \"type\": \"integer\",\n          \"default\"\
        : 100,\n          \"description\": \"Number of lines from end of logs\"\n        },\n        \"follow\": {\n     \
        \     \"type\": \"boolean\",\n          \"default\": false,\n          \"description\": \"Stream logs in real-time
        (WebSocket upgrade)\"\n        }\n      }\n    }\n  }\n}"
      x-response-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/LogsResponse\"\
        ,\n  \"$defs\": {\n    \"LogsResponse\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"logs\"\n\
        \      ],\n      \"properties\": {\n        \"service\": {\n          \"type\": \"string\",\n          \"description\"\
        : \"Service name (if queried by service)\"\n        },\n        \"container\": {\n          \"type\": \"string\",\n\
        \          \"description\": \"Container ID/name\"\n        },\n        \"logs\": {\n          \"type\": \"array\"\
        ,\n          \"items\": {\n            \"$ref\": \"#/$defs/LogEntry\"\n          }\n        },\n        \"truncated\"\
        : {\n          \"type\": \"boolean\",\n          \"description\": \"Whether output was truncated\"\n        }\n  \
        \    }\n    },\n    \"LogEntry\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"timestamp\",\n\
        \        \"message\"\n      ],\n      \"properties\": {\n        \"timestamp\": {\n          \"type\": \"string\"\
        ,\n          \"format\": \"date-time\"\n        },\n        \"stream\": {\n          \"type\": \"string\",\n     \
        \     \"enum\": [\n            \"stdout\",\n            \"stderr\"\n          ]\n        },\n        \"message\":
        {\n          \"type\": \"string\"\n        }\n      }\n    }\n  }\n}"
      x-endpoint-info-json: "{\n  \"summary\": \"Get service/container logs\",\n  \"description\": \"Retrieves logs from services
        or containers with filtering options.\\nSupports real-time streaming via WebSocket upgrade.\\n\",\n  \"tags\": [],\n\
        \  \"deprecated\": false,\n  \"operationId\": \"GetLogs\"\n}"
  /orchestrator/topology:
    post:
      summary: Update service topology without full redeploy
      description: |
        Changes which services run on which containers without tearing down
        the entire environment. Enables live topology changes.

        **Use Cases**:
        - Move auth service to dedicated container for scaling
        - Consolidate services during low-traffic periods
        - Split services for debugging/isolation
        - Add new service nodes to running environment
      operationId: UpdateTopology
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TopologyUpdateRequest'
      responses:
        '200':
          description: Topology update applied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TopologyUpdateResponse'
        '400':
          description: Invalid topology configuration
        '409':
          description: Topology change conflicts with current state
        '500':
          description: Topology update failed

  # ============================================================================
  # CONTAINER MANAGEMENT APIs (Self-Service Restart Pattern)
  # ============================================================================

      x-request-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/TopologyUpdateRequest\"\
        ,\n  \"$defs\": {\n    \"TopologyUpdateRequest\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"\
        changes\"\n      ],\n      \"properties\": {\n        \"changes\": {\n          \"type\": \"array\",\n          \"\
        items\": {\n            \"$ref\": \"#/$defs/TopologyChange\"\n          },\n          \"description\": \"List of topology
        changes to apply\"\n        },\n        \"mode\": {\n          \"$ref\": \"#/$defs/DeploymentMode\",\n          \"\
        default\": \"graceful\"\n        },\n        \"timeout\": {\n          \"type\": \"integer\",\n          \"default\"\
        : 120,\n          \"description\": \"Timeout for topology update\"\n        }\n      }\n    },\n    \"TopologyChange\"\
        : {\n      \"type\": \"object\",\n      \"required\": [\n        \"action\"\n      ],\n      \"properties\": {\n \
        \       \"action\": {\n          \"type\": \"string\",\n          \"enum\": [\n            \"add-node\",\n       \
        \     \"remove-node\",\n            \"move-service\",\n            \"scale\",\n            \"update-env\"\n      \
        \    ],\n          \"description\": \"Type of topology change\"\n        },\n        \"nodeName\": {\n          \"\
        type\": \"string\",\n          \"description\": \"Target node name\"\n        },\n        \"services\": {\n      \
        \    \"type\": \"array\",\n          \"items\": {\n            \"type\": \"string\"\n          },\n          \"description\"\
        : \"Services affected by this change\"\n        },\n        \"replicas\": {\n          \"type\": \"integer\",\n  \
        \        \"description\": \"New replica count (for scale action)\"\n        },\n        \"environment\": {\n     \
        \     \"type\": \"object\",\n          \"additionalProperties\": {\n            \"type\": \"string\"\n          },\n\
        \          \"description\": \"Environment updates (for update-env action)\"\n        },\n        \"nodeConfig\": {\n\
        \          \"$ref\": \"#/$defs/TopologyNode\",\n          \"description\": \"Full node config (for add-node action)\"\
        \n        }\n      }\n    },\n    \"TopologyNode\": {\n      \"type\": \"object\",\n      \"required\": [\n      \
        \  \"name\",\n        \"services\"\n      ],\n      \"properties\": {\n        \"name\": {\n          \"type\": \"\
        string\",\n          \"description\": \"Node/container name (e.g., \\\"bannou-main\\\", \\\"bannou-auth\\\")\"\n \
        \       },\n        \"services\": {\n          \"type\": \"array\",\n          \"items\": {\n            \"type\"\
        : \"string\"\n          },\n          \"description\": \"Services enabled on this node.\\nUses {SERVICE}_SERVICE_ENABLED=true
        pattern.\\nExample: [\\\"accounts\\\", \\\"auth\\\", \\\"permissions\\\"]\\n\"\n        },\n        \"replicas\":
        {\n          \"type\": \"integer\",\n          \"default\": 1,\n          \"description\": \"Number of replicas for
        this node\"\n        },\n        \"resources\": {\n          \"$ref\": \"#/$defs/ResourceLimits\"\n        },\n  \
        \      \"environment\": {\n          \"type\": \"object\",\n          \"additionalProperties\": {\n            \"\
        type\": \"string\"\n          },\n          \"description\": \"Node-specific environment overrides\"\n        },\n\
        \        \"daprEnabled\": {\n          \"type\": \"boolean\",\n          \"default\": true,\n          \"description\"\
        : \"Whether to attach Dapr sidecar\"\n        },\n        \"daprAppId\": {\n          \"type\": \"string\",\n    \
        \      \"description\": \"Dapr app-id override (default derives from node name)\"\n        }\n      }\n    },\n  \
        \  \"ResourceLimits\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"cpuLimit\": {\n        \
        \  \"type\": \"string\",\n          \"description\": \"CPU limit (e.g., \\\"0.5\\\", \\\"2\\\")\"\n        },\n  \
        \      \"memoryLimit\": {\n          \"type\": \"string\",\n          \"description\": \"Memory limit (e.g., \\\"\
        512m\\\", \\\"2g\\\")\"\n        },\n        \"cpuRequest\": {\n          \"type\": \"string\",\n          \"description\"\
        : \"CPU request (Kubernetes)\"\n        },\n        \"memoryRequest\": {\n          \"type\": \"string\",\n      \
        \    \"description\": \"Memory request (Kubernetes)\"\n        }\n      }\n    },\n    \"DeploymentMode\": {\n   \
        \   \"type\": \"string\",\n      \"enum\": [\n        \"graceful\",\n        \"force\",\n        \"clean\"\n     \
        \ ],\n      \"description\": \"Deployment mode:\\n- graceful: Wait for connections to drain\\n- force: Apply immediately\\
        n- clean: Tear down and rebuild\\n\"\n    }\n  }\n}"
      x-response-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/TopologyUpdateResponse\"\
        ,\n  \"$defs\": {\n    \"TopologyUpdateResponse\": {\n      \"type\": \"object\",\n      \"required\": [\n       \
        \ \"success\",\n        \"appliedChanges\"\n      ],\n      \"properties\": {\n        \"success\": {\n          \"\
        type\": \"boolean\"\n        },\n        \"appliedChanges\": {\n          \"type\": \"array\",\n          \"items\"\
        : {\n            \"$ref\": \"#/$defs/AppliedChange\"\n          }\n        },\n        \"topology\": {\n         \
        \ \"$ref\": \"#/$defs/ServiceTopology\",\n          \"description\": \"New topology after changes\"\n        },\n\
        \        \"duration\": {\n          \"type\": \"string\"\n        },\n        \"warnings\": {\n          \"type\"\
        : \"array\",\n          \"items\": {\n            \"type\": \"string\"\n          }\n        },\n        \"message\"\
        : {\n          \"type\": \"string\"\n        }\n      }\n    },\n    \"AppliedChange\": {\n      \"type\": \"object\"\
        ,\n      \"required\": [\n        \"action\",\n        \"success\"\n      ],\n      \"properties\": {\n        \"\
        action\": {\n          \"type\": \"string\"\n        },\n        \"target\": {\n          \"type\": \"string\",\n\
        \          \"description\": \"Node or service affected\"\n        },\n        \"success\": {\n          \"type\":
        \"boolean\"\n        },\n        \"error\": {\n          \"type\": \"string\",\n          \"description\": \"Error
        message if failed\"\n        }\n      }\n    },\n    \"ServiceTopology\": {\n      \"type\": \"object\",\n      \"\
        required\": [\n        \"nodes\"\n      ],\n      \"properties\": {\n        \"nodes\": {\n          \"type\": \"\
        array\",\n          \"items\": {\n            \"$ref\": \"#/$defs/TopologyNode\"\n          },\n          \"description\"\
        : \"Container/pod definitions with service assignments\"\n        },\n        \"infrastructure\": {\n          \"\
        $ref\": \"#/$defs/InfrastructureConfig\",\n          \"description\": \"Infrastructure service configuration\"\n \
        \       }\n      }\n    },\n    \"TopologyNode\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"\
        name\",\n        \"services\"\n      ],\n      \"properties\": {\n        \"name\": {\n          \"type\": \"string\"\
        ,\n          \"description\": \"Node/container name (e.g., \\\"bannou-main\\\", \\\"bannou-auth\\\")\"\n        },\n\
        \        \"services\": {\n          \"type\": \"array\",\n          \"items\": {\n            \"type\": \"string\"\
        \n          },\n          \"description\": \"Services enabled on this node.\\nUses {SERVICE}_SERVICE_ENABLED=true
        pattern.\\nExample: [\\\"accounts\\\", \\\"auth\\\", \\\"permissions\\\"]\\n\"\n        },\n        \"replicas\":
        {\n          \"type\": \"integer\",\n          \"default\": 1,\n          \"description\": \"Number of replicas for
        this node\"\n        },\n        \"resources\": {\n          \"$ref\": \"#/$defs/ResourceLimits\"\n        },\n  \
        \      \"environment\": {\n          \"type\": \"object\",\n          \"additionalProperties\": {\n            \"\
        type\": \"string\"\n          },\n          \"description\": \"Node-specific environment overrides\"\n        },\n\
        \        \"daprEnabled\": {\n          \"type\": \"boolean\",\n          \"default\": true,\n          \"description\"\
        : \"Whether to attach Dapr sidecar\"\n        },\n        \"daprAppId\": {\n          \"type\": \"string\",\n    \
        \      \"description\": \"Dapr app-id override (default derives from node name)\"\n        }\n      }\n    },\n  \
        \  \"ResourceLimits\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"cpuLimit\": {\n        \
        \  \"type\": \"string\",\n          \"description\": \"CPU limit (e.g., \\\"0.5\\\", \\\"2\\\")\"\n        },\n  \
        \      \"memoryLimit\": {\n          \"type\": \"string\",\n          \"description\": \"Memory limit (e.g., \\\"\
        512m\\\", \\\"2g\\\")\"\n        },\n        \"cpuRequest\": {\n          \"type\": \"string\",\n          \"description\"\
        : \"CPU request (Kubernetes)\"\n        },\n        \"memoryRequest\": {\n          \"type\": \"string\",\n      \
        \    \"description\": \"Memory request (Kubernetes)\"\n        }\n      }\n    },\n    \"InfrastructureConfig\": {\n\
        \      \"type\": \"object\",\n      \"properties\": {\n        \"redis\": {\n          \"$ref\": \"#/$defs/InfraServiceConfig\"\
        \n        },\n        \"rabbitmq\": {\n          \"$ref\": \"#/$defs/InfraServiceConfig\"\n        },\n        \"\
        mysql\": {\n          \"$ref\": \"#/$defs/InfraServiceConfig\"\n        },\n        \"placement\": {\n          \"\
        $ref\": \"#/$defs/InfraServiceConfig\",\n          \"description\": \"Dapr placement service\"\n        },\n     \
        \   \"ingress\": {\n          \"$ref\": \"#/$defs/IngressConfig\"\n        }\n      }\n    },\n    \"InfraServiceConfig\"\
        : {\n      \"type\": \"object\",\n      \"properties\": {\n        \"enabled\": {\n          \"type\": \"boolean\"\
        ,\n          \"default\": true\n        },\n        \"image\": {\n          \"type\": \"string\",\n          \"description\"\
        : \"Docker image override\"\n        },\n        \"resources\": {\n          \"$ref\": \"#/$defs/ResourceLimits\"\n\
        \        },\n        \"environment\": {\n          \"type\": \"object\",\n          \"additionalProperties\": {\n\
        \            \"type\": \"string\"\n          }\n        },\n        \"volumes\": {\n          \"type\": \"array\"\
        ,\n          \"items\": {\n            \"type\": \"string\"\n          },\n          \"description\": \"Volume mounts\"\
        \n        }\n      }\n    },\n    \"IngressConfig\": {\n      \"type\": \"object\",\n      \"properties\": {\n   \
        \     \"enabled\": {\n          \"type\": \"boolean\",\n          \"default\": true\n        },\n        \"type\"\
        : {\n          \"type\": \"string\",\n          \"enum\": [\n            \"openresty\",\n            \"nginx\",\n\
        \            \"traefik\",\n            \"none\"\n          ],\n          \"default\": \"openresty\"\n        },\n\
        \        \"ports\": {\n          \"type\": \"object\",\n          \"properties\": {\n            \"http\": {\n   \
        \           \"type\": \"integer\",\n              \"default\": 80\n            },\n            \"https\": {\n    \
        \          \"type\": \"integer\",\n              \"default\": 443\n            }\n          }\n        },\n      \
        \  \"ssl\": {\n          \"type\": \"boolean\",\n          \"default\": false\n        }\n      }\n    }\n  }\n}"
      x-endpoint-info-json: "{\n  \"summary\": \"Update service topology without full redeploy\",\n  \"description\": \"Changes
        which services run on which containers without tearing down\\nthe entire environment. Enables live topology changes.\\
        n\\n**Use Cases**:\\n- Move auth service to dedicated container for scaling\\n- Consolidate services during low-traffic
        periods\\n- Split services for debugging/isolation\\n- Add new service nodes to running environment\\n\",\n  \"tags\"\
        : [],\n  \"deprecated\": false,\n  \"operationId\": \"UpdateTopology\"\n}"
  /orchestrator/containers/request-restart:
    post:
      summary: Request container restart (self-service pattern)
      description: |
        Plugins call this endpoint to request restart of their own container.
        This is part of the self-service configuration update pattern where
        plugins decide if they care about config changes and request restarts.

        **Flow**:
        1. Orchestrator publishes ConfigurationChangedEvent with changed keys
        2. Plugins check if any changed keys match their dependencies
        3. Plugins that care call this endpoint to request restart
        4. Orchestrator performs rolling restart of requested containers

        **Priority Levels**:
        - `graceful`: Rolling update, wait for healthy before cycling next instance
        - `immediate`: Rolling update but don't wait for connection drain
        - `force`: Kill all instances simultaneously (causes downtime)
      operationId: RequestContainerRestart
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ContainerRestartRequestBody'
      responses:
        '200':
          description: Restart request accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ContainerRestartResponse'
        '400':
          description: Invalid restart request
        '404':
          description: Container not found

      x-request-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/ContainerRestartRequestBody\"\
        ,\n  \"$defs\": {\n    \"ContainerRestartRequestBody\": {\n      \"type\": \"object\",\n      \"required\": [\n  \
        \      \"appName\",\n        \"reason\"\n      ],\n      \"properties\": {\n        \"appName\": {\n          \"type\"\
        : \"string\",\n          \"description\": \"Container's Dapr app name (e.g., \\\"bannou\\\", \\\"npc-omega\\\")\"\n\
        \        },\n        \"reason\": {\n          \"type\": \"string\",\n          \"description\": \"Why restart is needed
        (for logging/auditing)\",\n          \"example\": \"configuration_change\"\n        },\n        \"priority\": {\n\
        \          \"$ref\": \"#/$defs/RestartPriority\"\n        },\n        \"shutdownGracePeriod\": {\n          \"type\"\
        : \"integer\",\n          \"default\": 30,\n          \"description\": \"Seconds to allow graceful shutdown before
        force-kill\"\n        }\n      }\n    },\n    \"RestartPriority\": {\n      \"type\": \"string\",\n      \"enum\"\
        : [\n        \"graceful\",\n        \"immediate\",\n        \"force\"\n      ],\n      \"description\": \"Restart
        urgency level:\\n- graceful: Rolling update, wait for healthy before cycling next instance\\n- immediate: Rolling
        update but don't wait for connection drain\\n- force: Kill all instances simultaneously (causes downtime)\\n\"\n \
        \   }\n  }\n}"
      x-response-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/ContainerRestartResponse\"\
        ,\n  \"$defs\": {\n    \"ContainerRestartResponse\": {\n      \"type\": \"object\",\n      \"required\": [\n     \
        \   \"accepted\",\n        \"appName\"\n      ],\n      \"properties\": {\n        \"accepted\": {\n          \"type\"\
        : \"boolean\",\n          \"description\": \"Whether the restart request was accepted\"\n        },\n        \"appName\"\
        : {\n          \"type\": \"string\",\n          \"description\": \"Container that will be restarted\"\n        },\n\
        \        \"scheduledFor\": {\n          \"type\": \"string\",\n          \"format\": \"date-time\",\n          \"\
        description\": \"When restart is scheduled (may be queued)\"\n        },\n        \"currentInstances\": {\n      \
        \    \"type\": \"integer\",\n          \"description\": \"Number of running instances\"\n        },\n        \"restartStrategy\"\
        : {\n          \"type\": \"string\",\n          \"enum\": [\n            \"rolling\",\n            \"simultaneous\"\
        \n          ],\n          \"description\": \"How restart will be performed\"\n        },\n        \"message\": {\n\
        \          \"type\": \"string\",\n          \"description\": \"Additional information\"\n        }\n      }\n    }\n\
        \  }\n}"
      x-endpoint-info-json: "{\n  \"summary\": \"Request container restart (self-service pattern)\",\n  \"description\": \"\
        Plugins call this endpoint to request restart of their own container.\\nThis is part of the self-service configuration
        update pattern where\\nplugins decide if they care about config changes and request restarts.\\n\\n**Flow**:\\n1.
        Orchestrator publishes ConfigurationChangedEvent with changed keys\\n2. Plugins check if any changed keys match their
        dependencies\\n3. Plugins that care call this endpoint to request restart\\n4. Orchestrator performs rolling restart
        of requested containers\\n\\n**Priority Levels**:\\n- `graceful`: Rolling update, wait for healthy before cycling
        next instance\\n- `immediate`: Rolling update but don't wait for connection drain\\n- `force`: Kill all instances
        simultaneously (causes downtime)\\n\",\n  \"tags\": [],\n  \"deprecated\": false,\n  \"operationId\": \"RequestContainerRestart\"\
        \n}"
  /orchestrator/containers/status:
    post:
      summary: Get container health and restart history
      description: |
        Returns detailed status of a container including health, restart history,
        running plugins, and current configuration.
      operationId: GetContainerStatus
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetContainerStatusRequest'
      responses:
        '200':
          description: Container status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ContainerStatus'
        '404':
          description: Container not found

  # ============================================================================
  # CONFIGURATION MANAGEMENT APIs
  # ============================================================================

      x-request-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/GetContainerStatusRequest\"\
        ,\n  \"$defs\": {\n    \"GetContainerStatusRequest\": {\n      \"type\": \"object\",\n      \"required\": [\n    \
        \    \"appName\"\n      ],\n      \"properties\": {\n        \"appName\": {\n          \"type\": \"string\",\n   \
        \       \"description\": \"Container's Dapr app name\"\n        }\n      }\n    }\n  }\n}"
      x-response-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/ContainerStatus\"\
        ,\n  \"$defs\": {\n    \"ContainerStatus\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"appName\"\
        ,\n        \"status\",\n        \"timestamp\"\n      ],\n      \"properties\": {\n        \"appName\": {\n       \
        \   \"type\": \"string\",\n          \"description\": \"Container's Dapr app name\"\n        },\n        \"status\"\
        : {\n          \"type\": \"string\",\n          \"enum\": [\n            \"running\",\n            \"starting\",\n\
        \            \"stopping\",\n            \"stopped\",\n            \"unhealthy\"\n          ]\n        },\n       \
        \ \"timestamp\": {\n          \"type\": \"string\",\n          \"format\": \"date-time\"\n        },\n        \"instances\"\
        : {\n          \"type\": \"integer\",\n          \"description\": \"Number of running instances\"\n        },\n  \
        \      \"plugins\": {\n          \"type\": \"array\",\n          \"items\": {\n            \"type\": \"string\"\n\
        \          },\n          \"description\": \"Plugins running in this container\"\n        },\n        \"lastRestart\"\
        : {\n          \"type\": \"string\",\n          \"format\": \"date-time\",\n          \"description\": \"When container
        was last restarted\"\n        },\n        \"restartCount\": {\n          \"type\": \"integer\",\n          \"description\"\
        : \"Number of restarts in last 24 hours\"\n        },\n        \"restartHistory\": {\n          \"type\": \"array\"\
        ,\n          \"items\": {\n            \"$ref\": \"#/$defs/RestartHistoryEntry\"\n          },\n          \"description\"\
        : \"Recent restart history\"\n        },\n        \"healthChecks\": {\n          \"type\": \"object\",\n         \
        \ \"properties\": {\n            \"lastCheck\": {\n              \"type\": \"string\",\n              \"format\":
        \"date-time\"\n            },\n            \"status\": {\n              \"type\": \"string\"\n            },\n   \
        \         \"consecutiveFailures\": {\n              \"type\": \"integer\"\n            }\n          }\n        },\n\
        \        \"labels\": {\n          \"type\": \"object\",\n          \"additionalProperties\": {\n            \"type\"\
        : \"string\"\n          },\n          \"description\": \"Container labels for metadata and management\"\n        }\n\
        \      }\n    },\n    \"RestartHistoryEntry\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"timestamp\"\
        ,\n        \"reason\"\n      ],\n      \"properties\": {\n        \"timestamp\": {\n          \"type\": \"string\"\
        ,\n          \"format\": \"date-time\"\n        },\n        \"reason\": {\n          \"type\": \"string\"\n      \
        \  },\n        \"priority\": {\n          \"$ref\": \"#/$defs/RestartPriority\"\n        },\n        \"duration\"\
        : {\n          \"type\": \"string\",\n          \"description\": \"Time taken to restart\"\n        },\n        \"\
        success\": {\n          \"type\": \"boolean\"\n        },\n        \"error\": {\n          \"type\": \"string\",\n\
        \          \"description\": \"Error message if restart failed\"\n        }\n      }\n    },\n    \"RestartPriority\"\
        : {\n      \"type\": \"string\",\n      \"enum\": [\n        \"graceful\",\n        \"immediate\",\n        \"force\"\
        \n      ],\n      \"description\": \"Restart urgency level:\\n- graceful: Rolling update, wait for healthy before
        cycling next instance\\n- immediate: Rolling update but don't wait for connection drain\\n- force: Kill all instances
        simultaneously (causes downtime)\\n\"\n    }\n  }\n}"
      x-endpoint-info-json: "{\n  \"summary\": \"Get container health and restart history\",\n  \"description\": \"Returns
        detailed status of a container including health, restart history,\\nrunning plugins, and current configuration.\\\
        n\",\n  \"tags\": [],\n  \"deprecated\": false,\n  \"operationId\": \"GetContainerStatus\"\n}"
  /orchestrator/config/rollback:
    post:
      summary: Rollback to previous configuration
      description: |
        Quickly rollback to the previous configuration without waiting for CI.
        Swaps currentConfig with previousConfig and publishes ConfigurationChangedEvent
        with the reverted keys so services can request restart.

        **Note**: This is a quick fix. GitHub secrets should still be corrected
        to prevent re-breaking on next orchestrator deploy.
      operationId: RollbackConfiguration
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConfigRollbackRequest'
      responses:
        '200':
          description: Rollback completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfigRollbackResponse'
        '400':
          description: No previous configuration to rollback to
        '500':
          description: Rollback failed

      x-request-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/ConfigRollbackRequest\"\
        ,\n  \"$defs\": {\n    \"ConfigRollbackRequest\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"\
        reason\"\n      ],\n      \"properties\": {\n        \"reason\": {\n          \"type\": \"string\",\n          \"\
        description\": \"Why rollback is needed (for auditing)\",\n          \"example\": \"auth.jwt_secret broke authentication\"\
        \n        }\n      }\n    }\n  }\n}"
      x-response-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/ConfigRollbackResponse\"\
        ,\n  \"$defs\": {\n    \"ConfigRollbackResponse\": {\n      \"type\": \"object\",\n      \"required\": [\n       \
        \ \"success\",\n        \"previousVersion\",\n        \"currentVersion\"\n      ],\n      \"properties\": {\n    \
        \    \"success\": {\n          \"type\": \"boolean\"\n        },\n        \"previousVersion\": {\n          \"type\"\
        : \"integer\",\n          \"description\": \"Config version before rollback\"\n        },\n        \"currentVersion\"\
        : {\n          \"type\": \"integer\",\n          \"description\": \"Config version after rollback (now active)\"\n\
        \        },\n        \"changedKeys\": {\n          \"type\": \"array\",\n          \"items\": {\n            \"type\"\
        : \"string\"\n          },\n          \"description\": \"Keys that were reverted\"\n        },\n        \"message\"\
        : {\n          \"type\": \"string\"\n        }\n      }\n    }\n  }\n}"
      x-endpoint-info-json: "{\n  \"summary\": \"Rollback to previous configuration\",\n  \"description\": \"Quickly rollback
        to the previous configuration without waiting for CI.\\nSwaps currentConfig with previousConfig and publishes ConfigurationChangedEvent\\
        nwith the reverted keys so services can request restart.\\n\\n**Note**: This is a quick fix. GitHub secrets should
        still be corrected\\nto prevent re-breaking on next orchestrator deploy.\\n\",\n  \"tags\": [],\n  \"deprecated\"\
        : false,\n  \"operationId\": \"RollbackConfiguration\"\n}"
  /orchestrator/config/version:
    post:
      summary: Get current configuration version and metadata
      description: |
        Returns the current configuration version, last update time,
        and summary of configuration state (not actual values for security).
      operationId: GetConfigVersion
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetConfigVersionRequest'
      responses:
        '200':
          description: Configuration version info
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfigVersionResponse'

      x-request-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/GetConfigVersionRequest\"\
        ,\n  \"$defs\": {\n    \"GetConfigVersionRequest\": {\n      \"type\": \"object\",\n      \"description\": \"Request
        to get configuration version (empty body allowed)\",\n      \"properties\": {\n        \"includeKeyPrefixes\": {\n\
        \          \"type\": \"boolean\",\n          \"default\": true,\n          \"description\": \"Include list of configuration
        key prefixes\"\n        }\n      }\n    }\n  }\n}"
      x-response-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/ConfigVersionResponse\"\
        ,\n  \"$defs\": {\n    \"ConfigVersionResponse\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"\
        version\",\n        \"timestamp\"\n      ],\n      \"properties\": {\n        \"version\": {\n          \"type\":
        \"integer\",\n          \"description\": \"Current configuration version number\"\n        },\n        \"timestamp\"\
        : {\n          \"type\": \"string\",\n          \"format\": \"date-time\",\n          \"description\": \"When current
        config was applied\"\n        },\n        \"hasPreviousConfig\": {\n          \"type\": \"boolean\",\n          \"\
        description\": \"Whether a previous config is available for rollback\"\n        },\n        \"keyCount\": {\n    \
        \      \"type\": \"integer\",\n          \"description\": \"Number of configuration keys (not values for security)\"\
        \n        },\n        \"keyPrefixes\": {\n          \"type\": \"array\",\n          \"items\": {\n            \"type\"\
        : \"string\"\n          },\n          \"description\": \"Configuration key prefixes present (e.g., \\\"auth\\\", \\\
        \"database\\\")\"\n        }\n      }\n    }\n  }\n}"
      x-endpoint-info-json: "{\n  \"summary\": \"Get current configuration version and metadata\",\n  \"description\": \"\
        Returns the current configuration version, last update time,\\nand summary of configuration state (not actual values
        for security).\\n\",\n  \"tags\": [],\n  \"deprecated\": false,\n  \"operationId\": \"GetConfigVersion\"\n}"

  # ============================================================
  # PROCESSING POOL MANAGEMENT
  # Manage pools of dedicated processing instances for heavy operations
  # ============================================================

  /orchestrator/processing-pool/acquire:
    post:
      summary: Acquire a processor from a pool
      description: |
        Requests an available processor instance from the specified pool type.
        Returns the app-id of an available processor or 429 if none available.
        The processor is marked as busy until explicitly released.
      operationId: AcquireProcessor
      x-permissions:
      - role: service
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AcquireProcessorRequest'
      responses:
        '200':
          description: Processor acquired successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AcquireProcessorResponse'
        '429':
          description: No processors available (all busy or pool at capacity)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PoolBusyResponse'

      x-request-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/AcquireProcessorRequest\"\
        ,\n  \"$defs\": {\n    \"AcquireProcessorRequest\": {\n      \"type\": \"object\",\n      \"required\": [\n      \
        \  \"pool_type\"\n      ],\n      \"properties\": {\n        \"pool_type\": {\n          \"type\": \"string\",\n \
        \         \"description\": \"Type of processing pool (e.g., \\\"asset-processor\\\", \\\"texture-processor\\\")\"\n\
        \        },\n        \"priority\": {\n          \"type\": \"integer\",\n          \"default\": 0,\n          \"description\"\
        : \"Request priority (higher = more urgent)\"\n        },\n        \"timeout_seconds\": {\n          \"type\": \"\
        integer\",\n          \"default\": 300,\n          \"description\": \"How long the lease is valid for\"\n        },\n\
        \        \"metadata\": {\n          \"type\": \"object\",\n          \"additionalProperties\": true,\n          \"\
        description\": \"Optional metadata about the processing job\"\n        }\n      }\n    }\n  }\n}"
      x-response-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/AcquireProcessorResponse\"\
        ,\n  \"$defs\": {\n    \"AcquireProcessorResponse\": {\n      \"type\": \"object\",\n      \"required\": [\n     \
        \   \"processor_id\",\n        \"app_id\",\n        \"lease_id\",\n        \"expires_at\"\n      ],\n      \"properties\"\
        : {\n        \"processor_id\": {\n          \"type\": \"string\",\n          \"description\": \"Unique identifier
        for this processor instance\"\n        },\n        \"app_id\": {\n          \"type\": \"string\",\n          \"description\"\
        : \"Dapr app-id for service invocation to this processor\"\n        },\n        \"lease_id\": {\n          \"type\"\
        : \"string\",\n          \"format\": \"uuid\",\n          \"description\": \"Unique lease identifier (used for release)\"\
        \n        },\n        \"expires_at\": {\n          \"type\": \"string\",\n          \"format\": \"date-time\",\n \
        \         \"description\": \"When the lease expires (must release before this)\"\n        }\n      }\n    }\n  }\n\
        }"
      x-endpoint-info-json: "{\n  \"summary\": \"Acquire a processor from a pool\",\n  \"description\": \"Requests an available
        processor instance from the specified pool type.\\nReturns the app-id of an available processor or 429 if none available.\\
        nThe processor is marked as busy until explicitly released.\\n\",\n  \"tags\": [],\n  \"deprecated\": false,\n  \"\
        operationId\": \"AcquireProcessor\"\n}"
  /orchestrator/processing-pool/release:
    post:
      summary: Release a processor back to the pool
      description: |
        Releases a previously acquired processor, making it available for other requests.
        Should be called when processing is complete or on error cleanup.
      operationId: ReleaseProcessor
      x-permissions:
      - role: service
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReleaseProcessorRequest'
      responses:
        '200':
          description: Processor released successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReleaseProcessorResponse'
        '404':
          description: Processor or lease not found

      x-request-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/ReleaseProcessorRequest\"\
        ,\n  \"$defs\": {\n    \"ReleaseProcessorRequest\": {\n      \"type\": \"object\",\n      \"required\": [\n      \
        \  \"lease_id\"\n      ],\n      \"properties\": {\n        \"lease_id\": {\n          \"type\": \"string\",\n   \
        \       \"format\": \"uuid\",\n          \"description\": \"The lease ID returned from AcquireProcessor\"\n      \
        \  },\n        \"success\": {\n          \"type\": \"boolean\",\n          \"default\": true,\n          \"description\"\
        : \"Whether the processing completed successfully\"\n        },\n        \"metrics\": {\n          \"type\": \"object\"\
        ,\n          \"additionalProperties\": true,\n          \"description\": \"Optional processing metrics (duration,
        items processed, etc.)\"\n        }\n      }\n    }\n  }\n}"
      x-response-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/ReleaseProcessorResponse\"\
        ,\n  \"$defs\": {\n    \"ReleaseProcessorResponse\": {\n      \"type\": \"object\",\n      \"required\": [\n     \
        \   \"released\"\n      ],\n      \"properties\": {\n        \"released\": {\n          \"type\": \"boolean\",\n \
        \         \"description\": \"Whether the processor was successfully released\"\n        },\n        \"processor_id\"\
        : {\n          \"type\": \"string\",\n          \"description\": \"ID of the released processor\"\n        }\n   \
        \   }\n    }\n  }\n}"
      x-endpoint-info-json: "{\n  \"summary\": \"Release a processor back to the pool\",\n  \"description\": \"Releases a
        previously acquired processor, making it available for other requests.\\nShould be called when processing is complete
        or on error cleanup.\\n\",\n  \"tags\": [],\n  \"deprecated\": false,\n  \"operationId\": \"ReleaseProcessor\"\n}"
  /orchestrator/processing-pool/status:
    post:
      summary: Get processing pool status
      description: |
        Returns current status of a processing pool including:
        - Total instances (running and available)
        - Current utilization
        - Queue depth (waiting requests)
        - Recent processing metrics
      operationId: GetPoolStatus
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetPoolStatusRequest'
      responses:
        '200':
          description: Pool status retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PoolStatusResponse'

      x-request-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/GetPoolStatusRequest\"\
        ,\n  \"$defs\": {\n    \"GetPoolStatusRequest\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"\
        pool_type\"\n      ],\n      \"properties\": {\n        \"pool_type\": {\n          \"type\": \"string\",\n      \
        \    \"description\": \"Type of processing pool to query\"\n        },\n        \"include_metrics\": {\n         \
        \ \"type\": \"boolean\",\n          \"default\": true,\n          \"description\": \"Include recent processing metrics\"\
        \n        }\n      }\n    }\n  }\n}"
      x-response-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/PoolStatusResponse\"\
        ,\n  \"$defs\": {\n    \"PoolStatusResponse\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"pool_type\"\
        ,\n        \"total_instances\",\n        \"available_instances\",\n        \"busy_instances\",\n        \"utilization\"\
        \n      ],\n      \"properties\": {\n        \"pool_type\": {\n          \"type\": \"string\",\n          \"description\"\
        : \"Pool type\"\n        },\n        \"total_instances\": {\n          \"type\": \"integer\",\n          \"description\"\
        : \"Total processor instances in the pool\"\n        },\n        \"available_instances\": {\n          \"type\": \"\
        integer\",\n          \"description\": \"Instances ready to accept work\"\n        },\n        \"busy_instances\"\
        : {\n          \"type\": \"integer\",\n          \"description\": \"Instances currently processing\"\n        },\n\
        \        \"queue_depth\": {\n          \"type\": \"integer\",\n          \"description\": \"Number of requests waiting
        for a processor\"\n        },\n        \"utilization\": {\n          \"type\": \"number\",\n          \"format\":
        \"float\",\n          \"description\": \"Current utilization percentage (0.0 to 1.0)\"\n        },\n        \"min_instances\"\
        : {\n          \"type\": \"integer\",\n          \"description\": \"Minimum configured instances\"\n        },\n \
        \       \"max_instances\": {\n          \"type\": \"integer\",\n          \"description\": \"Maximum configured instances\"\
        \n        },\n        \"scale_up_threshold\": {\n          \"type\": \"number\",\n          \"format\": \"float\"\
        ,\n          \"description\": \"Utilization threshold for auto-scale-up\"\n        },\n        \"recent_metrics\"\
        : {\n          \"$ref\": \"#/$defs/PoolMetrics\"\n        }\n      }\n    },\n    \"PoolMetrics\": {\n      \"type\"\
        : \"object\",\n      \"properties\": {\n        \"jobs_completed_1h\": {\n          \"type\": \"integer\",\n     \
        \     \"description\": \"Jobs completed in the last hour\"\n        },\n        \"jobs_failed_1h\": {\n          \"\
        type\": \"integer\",\n          \"description\": \"Jobs failed in the last hour\"\n        },\n        \"avg_processing_time_ms\"\
        : {\n          \"type\": \"integer\",\n          \"description\": \"Average processing time in milliseconds\"\n  \
        \      },\n        \"last_scale_event\": {\n          \"type\": \"string\",\n          \"format\": \"date-time\",\n\
        \          \"description\": \"When the pool was last scaled\"\n        }\n      }\n    }\n  }\n}"
      x-endpoint-info-json: "{\n  \"summary\": \"Get processing pool status\",\n  \"description\": \"Returns current status
        of a processing pool including:\\n- Total instances (running and available)\\n- Current utilization\\n- Queue depth
        (waiting requests)\\n- Recent processing metrics\\n\",\n  \"tags\": [],\n  \"deprecated\": false,\n  \"operationId\"\
        : \"GetPoolStatus\"\n}"
  /orchestrator/processing-pool/scale:
    post:
      summary: Scale a processing pool
      description: |
        Manually adjust the size of a processing pool.
        Can scale up (add instances) or scale down (remove idle instances).
        Respects min/max constraints from pool configuration.
      operationId: ScalePool
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ScalePoolRequest'
      responses:
        '200':
          description: Pool scaled successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScalePoolResponse'
        '400':
          description: Invalid scale request (exceeds limits)

      x-request-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/ScalePoolRequest\"\
        ,\n  \"$defs\": {\n    \"ScalePoolRequest\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"pool_type\"\
        ,\n        \"target_instances\"\n      ],\n      \"properties\": {\n        \"pool_type\": {\n          \"type\":
        \"string\",\n          \"description\": \"Type of processing pool to scale\"\n        },\n        \"target_instances\"\
        : {\n          \"type\": \"integer\",\n          \"minimum\": 0,\n          \"description\": \"Desired number of instances\"\
        \n        },\n        \"force\": {\n          \"type\": \"boolean\",\n          \"default\": false,\n          \"\
        description\": \"Force scale even if it would interrupt processing\"\n        }\n      }\n    }\n  }\n}"
      x-response-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/ScalePoolResponse\"\
        ,\n  \"$defs\": {\n    \"ScalePoolResponse\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"pool_type\"\
        ,\n        \"previous_instances\",\n        \"current_instances\"\n      ],\n      \"properties\": {\n        \"pool_type\"\
        : {\n          \"type\": \"string\",\n          \"description\": \"Pool type that was scaled\"\n        },\n     \
        \   \"previous_instances\": {\n          \"type\": \"integer\",\n          \"description\": \"Instance count before
        scaling\"\n        },\n        \"current_instances\": {\n          \"type\": \"integer\",\n          \"description\"\
        : \"Instance count after scaling\"\n        },\n        \"scaled_up\": {\n          \"type\": \"integer\",\n     \
        \     \"description\": \"Number of instances added\"\n        },\n        \"scaled_down\": {\n          \"type\":
        \"integer\",\n          \"description\": \"Number of instances removed\"\n        },\n        \"message\": {\n   \
        \       \"type\": \"string\",\n          \"description\": \"Status message\"\n        }\n      }\n    }\n  }\n}"
      x-endpoint-info-json: "{\n  \"summary\": \"Scale a processing pool\",\n  \"description\": \"Manually adjust the size
        of a processing pool.\\nCan scale up (add instances) or scale down (remove idle instances).\\nRespects min/max constraints
        from pool configuration.\\n\",\n  \"tags\": [],\n  \"deprecated\": false,\n  \"operationId\": \"ScalePool\"\n}"
  /orchestrator/processing-pool/cleanup:
    post:
      summary: Cleanup idle processing pool instances
      description: |
        Scales pool back to minimum instances by removing idle processors.
        Used for resource reclamation during low-activity periods.
      operationId: CleanupPool
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CleanupPoolRequest'
      responses:
        '200':
          description: Cleanup completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CleanupPoolResponse'

      x-request-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/CleanupPoolRequest\"\
        ,\n  \"$defs\": {\n    \"CleanupPoolRequest\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"pool_type\"\
        \n      ],\n      \"properties\": {\n        \"pool_type\": {\n          \"type\": \"string\",\n          \"description\"\
        : \"Type of processing pool to cleanup\"\n        },\n        \"preserve_minimum\": {\n          \"type\": \"boolean\"\
        ,\n          \"default\": true,\n          \"description\": \"Keep at least min_instances running\"\n        }\n \
        \     }\n    }\n  }\n}"
      x-response-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/CleanupPoolResponse\"\
        ,\n  \"$defs\": {\n    \"CleanupPoolResponse\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"\
        pool_type\",\n        \"instances_removed\"\n      ],\n      \"properties\": {\n        \"pool_type\": {\n       \
        \   \"type\": \"string\",\n          \"description\": \"Pool type that was cleaned up\"\n        },\n        \"instances_removed\"\
        : {\n          \"type\": \"integer\",\n          \"description\": \"Number of idle instances removed\"\n        },\n\
        \        \"current_instances\": {\n          \"type\": \"integer\",\n          \"description\": \"Instance count after
        cleanup\"\n        },\n        \"message\": {\n          \"type\": \"string\",\n          \"description\": \"Status
        message\"\n        }\n      }\n    }\n  }\n}"
      x-endpoint-info-json: "{\n  \"summary\": \"Cleanup idle processing pool instances\",\n  \"description\": \"Scales pool
        back to minimum instances by removing idle processors.\\nUsed for resource reclamation during low-activity periods.\\\
        n\",\n  \"tags\": [],\n  \"deprecated\": false,\n  \"operationId\": \"CleanupPool\"\n}"
components:
  schemas:
    # Request Models for POST-only pattern
    InfrastructureHealthRequest:
      type: object
      description: Request to check infrastructure health (empty body allowed)
      properties:
        components:
          type: array
          items:
            type: string
          description: Optional filter for specific components (redis, rabbitmq, placement)
          nullable: true

    ServiceHealthRequest:
      type: object
      description: Request to get service health status (empty body allowed)
      properties:
        serviceFilter:
          type: string
          description: Optional filter by service name
          nullable: true

    GetServiceRoutingRequest:
      type: object
      description: Request to get service routing mappings (empty body allowed)
      properties:
        serviceFilter:
          type: string
          description: Optional filter by service name prefix
          nullable: true

    ServiceRoutingResponse:
      type: object
      required:
      - mappings
      - defaultAppId
      - generatedAt
      properties:
        mappings:
          type: object
          additionalProperties:
            type: string
          description: |
            Map of service names to Dapr app-id routing destinations.
            Example: { "accounts": "bannou", "behavior": "npc-processing-01" }
        defaultAppId:
          type: string
          description: Default app-id used when no specific mapping exists
          default: "bannou"
        generatedAt:
          type: string
          format: date-time
          description: When this routing information was generated
        totalServices:
          type: integer
          description: Total number of services with routing mappings
          minimum: 0
        deploymentId:
          type: string
          description: Current deployment identifier (if environment is deployed)
          nullable: true

    ListBackendsRequest:
      type: object
      description: Request to list available backends (empty body allowed)
      properties:
        refresh:
          type: boolean
          default: false
          description: Force refresh detection instead of using cached results

    ListPresetsRequest:
      type: object
      description: Request to list available presets (empty body allowed)
      properties:
        category:
          type: string
          enum: [development, testing, production, custom]
          description: Optional filter by category
          nullable: true

    GetStatusRequest:
      type: object
      description: Request to get environment status (empty body allowed)
      properties:
        includeResources:
          type: boolean
          default: true
          description: Include resource usage metrics

    GetLogsRequest:
      type: object
      description: Request to get service/container logs
      properties:
        service:
          type: string
          description: Service name to get logs for
          nullable: true
        container:
          type: string
          description: Container ID or name (alternative to service)
          nullable: true
        since:
          type: string
          description: Return logs since timestamp (RFC3339 or relative like "5m")
          nullable: true
        until:
          type: string
          description: Return logs until timestamp
          nullable: true
        tail:
          type: integer
          default: 100
          description: Number of lines from end of logs
        follow:
          type: boolean
          default: false
          description: Stream logs in real-time (WebSocket upgrade)

    ContainerRestartRequestBody:
      type: object
      required:
      - appName
      - reason
      properties:
        appName:
          type: string
          description: Container's Dapr app name (e.g., "bannou", "npc-omega")
        reason:
          type: string
          description: Why restart is needed (for logging/auditing)
          example: "configuration_change"
        priority:
          $ref: '#/components/schemas/RestartPriority'
        shutdownGracePeriod:
          type: integer
          default: 30
          description: Seconds to allow graceful shutdown before force-kill

    GetContainerStatusRequest:
      type: object
      required:
      - appName
      properties:
        appName:
          type: string
          description: Container's Dapr app name

    GetConfigVersionRequest:
      type: object
      description: Request to get configuration version (empty body allowed)
      properties:
        includeKeyPrefixes:
          type: boolean
          default: true
          description: Include list of configuration key prefixes

    InfrastructureHealthResponse:
      type: object
      required:
      - healthy
      - timestamp
      - components
      properties:
        healthy:
          type: boolean
          description: Overall infrastructure health status
        timestamp:
          type: string
          format: date-time
          description: When health check was performed
        components:
          type: array
          items:
            $ref: '#/components/schemas/ComponentHealth'
          description: Individual component health status

    ComponentHealth:
      type: object
      required:
      - name
      - status
      - lastSeen
      properties:
        name:
          type: string
          description: Component name (redis, rabbitmq, placement)
        status:
          type: string
          enum: [healthy, degraded, unavailable]
          description: Component health status
        lastSeen:
          type: string
          format: date-time
          description: Last successful connection time
        message:
          type: string
          description: Additional status information
        metrics:
          type: object
          additionalProperties: true
          description: Component-specific metrics (e.g., ping time)

    ServiceHealthReport:
      type: object
      required:
      - timestamp
      - totalServices
      - healthPercentage
      - healthyServices
      - unhealthyServices
      properties:
        timestamp:
          type: string
          format: date-time
          description: When report was generated
        totalServices:
          type: integer
          description: Total number of services
        healthPercentage:
          type: number
          format: float
          description: Percentage of healthy services (0-100)
        healthyServices:
          type: array
          items:
            $ref: '#/components/schemas/ServiceHealthStatus'
          description: Services with recent heartbeats
        unhealthyServices:
          type: array
          items:
            $ref: '#/components/schemas/ServiceHealthStatus'
          description: Services with expired heartbeats

    ServiceHealthStatus:
      type: object
      description: |
        Service health status from heartbeat monitoring.
        Uses ServiceHeartbeatEvent schema from common-events.yaml.
      required:
      - serviceId
      - appId
      - status
      - lastSeen
      properties:
        serviceId:
          type: string
          description: Service ID (e.g., "behavior", "accounts")
        appId:
          type: string
          description: Dapr app-id (e.g., "bannou", "npc-omega-01")
        status:
          type: string
          description: Service status from heartbeat
        lastSeen:
          type: string
          format: date-time
          description: Last heartbeat timestamp
        capacity:
          type: object
          description: Service capacity from heartbeat
          properties:
            maxConnections:
              type: integer
            currentConnections:
              type: integer
            cpuUsage:
              type: number
              format: float
            memoryUsage:
              type: number
              format: float
        metadata:
          type: object
          additionalProperties: true
          description: Additional service metadata

    TestExecutionRequest:
      type: object
      required:
      - testType
      properties:
        testType:
          type: string
          enum: [infrastructure, http, edge]
          description: Type of tests to execute
        plugin:
          type: string
          description: Specific plugin to test (for http tests)
        configuration:
          type: object
          additionalProperties: true
          description: Additional test configuration parameters
        timeout:
          type: integer
          description: Test timeout in seconds (default 300)

    TestExecutionResult:
      type: object
      required:
      - success
      - testType
      - duration
      properties:
        success:
          type: boolean
          description: Overall test success status
        testType:
          type: string
          description: Type of tests executed
        duration:
          type: string
          description: Total execution time
        results:
          type: array
          items:
            $ref: '#/components/schemas/TestResult'
          description: Individual test results
        summary:
          type: string
          description: Human-readable test summary
        error:
          type: string
          description: Error message if test execution failed

    TestResult:
      type: object
      required:
      - name
      - passed
      properties:
        name:
          type: string
          description: Test name
        passed:
          type: boolean
          description: Test pass/fail status
        duration:
          type: string
          description: Test execution time
        message:
          type: string
          description: Test result message
        stackTrace:
          type: string
          description: Stack trace if test failed

    ServiceRestartRequest:
      type: object
      required:
      - serviceName
      properties:
        serviceName:
          type: string
          description: Name of service to restart
        environment:
          type: object
          additionalProperties:
            type: string
          description: Optional environment variable updates
        force:
          type: boolean
          description: Force restart even if healthy (default false)
        timeout:
          type: integer
          description: Timeout for service to become healthy (seconds, default 120)

    ServiceRestartResult:
      type: object
      required:
      - success
      - serviceName
      - duration
      properties:
        success:
          type: boolean
          description: Restart success status
        serviceName:
          type: string
          description: Service that was restarted
        duration:
          type: string
          description: Time taken to restart and become healthy
        previousStatus:
          type: string
          description: Service status before restart
        currentStatus:
          type: string
          description: Service status after restart
        message:
          type: string
          description: Restart result message

    ShouldRestartServiceRequest:
      type: object
      required:
      - serviceName
      properties:
        serviceName:
          type: string
          description: Name of service to evaluate

    RestartRecommendation:
      type: object
      required:
      - shouldRestart
      - serviceName
      - currentStatus
      - reason
      properties:
        shouldRestart:
          type: boolean
          description: Whether restart is recommended
        serviceName:
          type: string
          description: Service being evaluated
        currentStatus:
          type: string
          description: Current service health status
        lastSeen:
          type: string
          format: date-time
          description: Last heartbeat timestamp
        degradedDuration:
          type: string
          description: How long service has been degraded
        reason:
          type: string
          description: Explanation for recommendation

    # ==========================================================================
    # ENVIRONMENT MANAGEMENT SCHEMAS
    # ==========================================================================

    BackendType:
      type: string
      enum: [kubernetes, portainer, swarm, compose]
      description: |
        Container orchestration backend type.
        Priority order: kubernetes > portainer > swarm > compose

    BackendInfo:
      type: object
      required:
      - type
      - available
      - priority
      properties:
        type:
          $ref: '#/components/schemas/BackendType'
        available:
          type: boolean
          description: Whether this backend is currently available
        priority:
          type: integer
          description: Selection priority (1 = highest)
        version:
          type: string
          description: Backend version (e.g., "1.28.0" for Docker)
        endpoint:
          type: string
          description: Backend API endpoint (if applicable)
        capabilities:
          type: array
          items:
            type: string
          description: |
            Supported capabilities for this backend:
            - live-topology: Can change service distribution without restart
            - scaling: Can scale services horizontally
            - rolling-update: Supports rolling deployments
            - secrets: Native secrets management
            - volumes: Persistent volume support
            - networks: Custom network creation
        error:
          type: string
          description: Error message if detection failed

    BackendsResponse:
      type: object
      required:
      - timestamp
      - backends
      - recommended
      properties:
        timestamp:
          type: string
          format: date-time
          description: When detection was performed
        backends:
          type: array
          items:
            $ref: '#/components/schemas/BackendInfo'
          description: All detected backends with status
        recommended:
          $ref: '#/components/schemas/BackendType'
        activeBackend:
          $ref: '#/components/schemas/BackendType'
          description: Currently active backend (if environment deployed)

    DeploymentPreset:
      type: object
      required:
      - name
      - description
      - topology
      properties:
        name:
          type: string
          description: Unique preset identifier (e.g., "local-development")
        description:
          type: string
          description: Human-readable preset description
        category:
          type: string
          enum: [development, testing, production, custom]
          description: Preset category
        topology:
          $ref: '#/components/schemas/ServiceTopology'
        environment:
          type: object
          additionalProperties:
            type: string
          description: Default environment variables for this preset
        requiredBackends:
          type: array
          items:
            $ref: '#/components/schemas/BackendType'
          description: Backends that support this preset (empty = all)
        builtIn:
          type: boolean
          description: Whether this is a built-in preset
        filePath:
          type: string
          description: Path to preset configuration file

    PresetsResponse:
      type: object
      required:
      - presets
      properties:
        presets:
          type: array
          items:
            $ref: '#/components/schemas/DeploymentPreset'
          description: Available deployment presets
        activePreset:
          type: string
          description: Currently active preset name (if any)

    ServiceTopology:
      type: object
      required:
      - nodes
      properties:
        nodes:
          type: array
          items:
            $ref: '#/components/schemas/TopologyNode'
          description: Container/pod definitions with service assignments
        infrastructure:
          $ref: '#/components/schemas/InfrastructureConfig'
          description: Infrastructure service configuration

    TopologyNode:
      type: object
      required:
      - name
      - services
      properties:
        name:
          type: string
          description: Node/container name (e.g., "bannou-main", "bannou-auth")
        services:
          type: array
          items:
            type: string
          description: |
            Services enabled on this node.
            Uses {SERVICE}_SERVICE_ENABLED=true pattern.
            Example: ["accounts", "auth", "permissions"]
        replicas:
          type: integer
          default: 1
          description: Number of replicas for this node
        resources:
          $ref: '#/components/schemas/ResourceLimits'
        environment:
          type: object
          additionalProperties:
            type: string
          description: Node-specific environment overrides
        daprEnabled:
          type: boolean
          default: true
          description: Whether to attach Dapr sidecar
        daprAppId:
          type: string
          description: Dapr app-id override (default derives from node name)

    InfrastructureConfig:
      type: object
      properties:
        redis:
          $ref: '#/components/schemas/InfraServiceConfig'
        rabbitmq:
          $ref: '#/components/schemas/InfraServiceConfig'
        mysql:
          $ref: '#/components/schemas/InfraServiceConfig'
        placement:
          $ref: '#/components/schemas/InfraServiceConfig'
          description: Dapr placement service
        ingress:
          $ref: '#/components/schemas/IngressConfig'

    InfraServiceConfig:
      type: object
      properties:
        enabled:
          type: boolean
          default: true
        image:
          type: string
          description: Docker image override
        resources:
          $ref: '#/components/schemas/ResourceLimits'
        environment:
          type: object
          additionalProperties:
            type: string
        volumes:
          type: array
          items:
            type: string
          description: Volume mounts

    IngressConfig:
      type: object
      properties:
        enabled:
          type: boolean
          default: true
        type:
          type: string
          enum: [openresty, nginx, traefik, none]
          default: openresty
        ports:
          type: object
          properties:
            http:
              type: integer
              default: 80
            https:
              type: integer
              default: 443
        ssl:
          type: boolean
          default: false

    ResourceLimits:
      type: object
      properties:
        cpuLimit:
          type: string
          description: CPU limit (e.g., "0.5", "2")
        memoryLimit:
          type: string
          description: Memory limit (e.g., "512m", "2g")
        cpuRequest:
          type: string
          description: CPU request (Kubernetes)
        memoryRequest:
          type: string
          description: Memory request (Kubernetes)

    DeploymentMode:
      type: string
      enum: [graceful, force, clean]
      description: |
        Deployment mode:
        - graceful: Wait for connections to drain
        - force: Apply immediately
        - clean: Tear down and rebuild

    DeployRequest:
      type: object
      properties:
        preset:
          type: string
          description: Preset name to deploy (mutually exclusive with topology)
        topology:
          $ref: '#/components/schemas/ServiceTopology'
          description: Custom topology (mutually exclusive with preset)
        backend:
          $ref: '#/components/schemas/BackendType'
          description: Specific backend to use (fails if unavailable)
        mode:
          $ref: '#/components/schemas/DeploymentMode'
          default: graceful
        environment:
          type: object
          additionalProperties:
            type: string
          description: Environment variable overrides
        timeout:
          type: integer
          default: 300
          description: Deployment timeout in seconds
        waitForHealthy:
          type: boolean
          default: true
          description: Wait for all services to report healthy

    DeployResponse:
      type: object
      required:
      - success
      - deploymentId
      - backend
      - duration
      properties:
        success:
          type: boolean
          description: Deployment succeeded
        deploymentId:
          type: string
          description: Unique deployment identifier for tracking
        backend:
          $ref: '#/components/schemas/BackendType'
        preset:
          type: string
          description: Preset used (if applicable)
        duration:
          type: string
          description: Time taken to deploy
        topology:
          $ref: '#/components/schemas/ServiceTopology'
          description: Final applied topology
        services:
          type: array
          items:
            $ref: '#/components/schemas/DeployedService'
          description: Status of deployed services
        warnings:
          type: array
          items:
            type: string
          description: Non-fatal warnings during deployment
        message:
          type: string
          description: Human-readable deployment summary

    DeployedService:
      type: object
      required:
      - name
      - status
      - node
      properties:
        name:
          type: string
          description: Service name
        status:
          type: string
          enum: [starting, running, healthy, unhealthy, stopped]
        node:
          type: string
          description: Node/container hosting this service
        containerId:
          type: string
          description: Container ID (Compose/Swarm)
        podName:
          type: string
          description: Pod name (Kubernetes)
        endpoints:
          type: array
          items:
            type: string
          description: Exposed endpoints

    EnvironmentStatus:
      type: object
      required:
      - deployed
      - timestamp
      properties:
        deployed:
          type: boolean
          description: Whether an environment is currently deployed
        timestamp:
          type: string
          format: date-time
        deploymentId:
          type: string
          description: Current deployment identifier
        backend:
          $ref: '#/components/schemas/BackendType'
        preset:
          type: string
          description: Active preset name
        topology:
          $ref: '#/components/schemas/ServiceTopology'
          description: Current topology configuration
        services:
          type: array
          items:
            $ref: '#/components/schemas/DeployedService'
          description: All deployed services with status
        infrastructure:
          $ref: '#/components/schemas/InfrastructureHealthResponse'
          description: Infrastructure component health
        resources:
          $ref: '#/components/schemas/ResourceUsage'
          description: Overall resource usage
        uptime:
          type: string
          description: Time since deployment

    ResourceUsage:
      type: object
      properties:
        cpuPercent:
          type: number
          format: float
          description: Total CPU usage percentage
        memoryUsedMb:
          type: integer
          description: Total memory used (MB)
        memoryTotalMb:
          type: integer
          description: Total memory available (MB)
        diskUsedGb:
          type: number
          format: float
          description: Disk space used (GB)
        networkInMb:
          type: number
          format: float
          description: Network input (MB)
        networkOutMb:
          type: number
          format: float
          description: Network output (MB)

    TeardownMode:
      type: string
      enum: [graceful, force, preserve-data]
      description: |
        Teardown mode:
        - graceful: Signal shutdown, wait for clean exit
        - force: Immediately stop (SIGKILL)
        - preserve-data: Keep volumes/networks, remove containers

    TeardownRequest:
      type: object
      properties:
        dryRun:
          type: boolean
          default: false
          description: |
            When true, simulates teardown without actually stopping or removing containers.
            Returns what would be torn down. ALWAYS use dryRun=true first to preview the impact.
        mode:
          $ref: '#/components/schemas/TeardownMode'
          default: graceful
        timeout:
          type: integer
          default: 60
          description: Graceful shutdown timeout in seconds
        removeVolumes:
          type: boolean
          default: false
          description: Also remove associated volumes
        removeNetworks:
          type: boolean
          default: false
          description: Also remove associated networks
        includeInfrastructure:
          type: boolean
          default: false
          description: |
            When true, also removes support infrastructure (Redis, RabbitMQ, MySQL, etc.).
            This is determined by scanning compose files or finding containers in the same
            Docker swarm/Kubernetes namespace as bannou services. USE WITH EXTREME CAUTION -
            this will destroy all data and require a full re-deployment.

    TeardownResponse:
      type: object
      required:
      - success
      - duration
      properties:
        success:
          type: boolean
        duration:
          type: string
        stoppedContainers:
          type: array
          items:
            type: string
          description: Container IDs that were stopped
        removedVolumes:
          type: array
          items:
            type: string
          description: Volumes that were removed
        removedNetworks:
          type: array
          items:
            type: string
          description: Networks that were removed
        removedInfrastructure:
          type: array
          items:
            type: string
          description: Infrastructure services that were removed (Redis, RabbitMQ, MySQL, etc.)
        errors:
          type: array
          items:
            type: string
          description: Non-fatal errors during teardown
        message:
          type: string

    CleanTarget:
      type: string
      enum: [containers, networks, volumes, images, all]
      description: Type of resource to clean

    CleanRequest:
      type: object
      required:
      - targets
      properties:
        targets:
          type: array
          items:
            $ref: '#/components/schemas/CleanTarget'
          description: Resources to clean (or "all")
        force:
          type: boolean
          default: false
          description: Force removal without confirmation
        olderThan:
          type: string
          description: Only clean resources older than (e.g., "24h", "7d")
        labelFilter:
          type: object
          additionalProperties:
            type: string
          description: Only clean resources matching labels

    CleanResponse:
      type: object
      required:
      - success
      properties:
        success:
          type: boolean
        reclaimedSpaceMb:
          type: integer
          description: Disk space reclaimed (MB)
        removedContainers:
          type: integer
        removedNetworks:
          type: integer
        removedVolumes:
          type: integer
        removedImages:
          type: integer
        errors:
          type: array
          items:
            type: string
        message:
          type: string

    LogsResponse:
      type: object
      required:
      - logs
      properties:
        service:
          type: string
          description: Service name (if queried by service)
        container:
          type: string
          description: Container ID/name
        logs:
          type: array
          items:
            $ref: '#/components/schemas/LogEntry'
        truncated:
          type: boolean
          description: Whether output was truncated

    LogEntry:
      type: object
      required:
      - timestamp
      - message
      properties:
        timestamp:
          type: string
          format: date-time
        stream:
          type: string
          enum: [stdout, stderr]
        message:
          type: string

    TopologyUpdateRequest:
      type: object
      required:
      - changes
      properties:
        changes:
          type: array
          items:
            $ref: '#/components/schemas/TopologyChange'
          description: List of topology changes to apply
        mode:
          $ref: '#/components/schemas/DeploymentMode'
          default: graceful
        timeout:
          type: integer
          default: 120
          description: Timeout for topology update

    TopologyChange:
      type: object
      required:
      - action
      properties:
        action:
          type: string
          enum: [add-node, remove-node, move-service, scale, update-env]
          description: Type of topology change
        nodeName:
          type: string
          description: Target node name
        services:
          type: array
          items:
            type: string
          description: Services affected by this change
        replicas:
          type: integer
          description: New replica count (for scale action)
        environment:
          type: object
          additionalProperties:
            type: string
          description: Environment updates (for update-env action)
        nodeConfig:
          $ref: '#/components/schemas/TopologyNode'
          description: Full node config (for add-node action)

    TopologyUpdateResponse:
      type: object
      required:
      - success
      - appliedChanges
      properties:
        success:
          type: boolean
        appliedChanges:
          type: array
          items:
            $ref: '#/components/schemas/AppliedChange'
        topology:
          $ref: '#/components/schemas/ServiceTopology'
          description: New topology after changes
        duration:
          type: string
        warnings:
          type: array
          items:
            type: string
        message:
          type: string

    AppliedChange:
      type: object
      required:
      - action
      - success
      properties:
        action:
          type: string
        target:
          type: string
          description: Node or service affected
        success:
          type: boolean
        error:
          type: string
          description: Error message if failed

    ErrorResponse:
      type: object
      required:
      - error
      - message
      properties:
        error:
          type: string
          description: Error code
        message:
          type: string
          description: Human-readable error message
        details:
          type: object
          additionalProperties: true
          description: Additional error context

    # ==========================================================================
    # EVENT SCHEMAS (for RabbitMQ pub/sub)
    # ==========================================================================

    DeploymentEvent:
      type: object
      description: |
        Published when deployment state changes.
        Topic: bannou-deployment-events
      required:
      - eventId
      - timestamp
      - action
      - deploymentId
      properties:
        eventId:
          type: string
        timestamp:
          type: string
          format: date-time
        action:
          type: string
          enum: [started, completed, failed, topology-changed]
        deploymentId:
          type: string
        preset:
          type: string
        backend:
          $ref: '#/components/schemas/BackendType'
        changes:
          type: array
          items:
            type: string
          description: Summary of changes made
        error:
          type: string
          nullable: true
          description: Error message if failed

    ServiceRestartEvent:
      type: object
      description: |
        Published when a service is restarted.
        Topic: bannou-service-lifecycle
      required:
      - eventId
      - serviceName
      - reason
      properties:
        eventId:
          type: string
        serviceName:
          type: string
        reason:
          type: string
        forced:
          type: boolean
        newEnvironment:
          type: object
          additionalProperties:
            type: string

    ConfigurationChangedEvent:
      type: object
      description: |
        Published by orchestrator when configuration or secrets change.
        All containers receive this event via RabbitMQ. Plugins decide if they care
        based on the changedKeys prefixes and request restart if needed.
        Topic: bannou-configuration-events
      required:
      - eventId
      - timestamp
      - configVersion
      - changedKeys
      properties:
        eventId:
          type: string
          format: uuid
        timestamp:
          type: string
          format: date-time
        configVersion:
          type: integer
          description: Monotonically increasing version number
        changedKeys:
          type: array
          items:
            type: string
          description: |
            Configuration keys that changed (not values for security).
            Key prefixes indicate scope:
            - "auth.*" - Authentication-related
            - "database.*" - Database connections
            - "dapr.*" - Dapr components (typically global impact)
            - "connect.*" - WebSocket/connection settings

    # ==========================================================================
    # CONTAINER MANAGEMENT SCHEMAS
    # ==========================================================================

    RestartPriority:
      type: string
      enum: [graceful, immediate, force]
      description: |
        Restart urgency level:
        - graceful: Rolling update, wait for healthy before cycling next instance
        - immediate: Rolling update but don't wait for connection drain
        - force: Kill all instances simultaneously (causes downtime)

    ContainerRestartRequest:
      type: object
      required:
      - reason
      properties:
        reason:
          type: string
          description: Why restart is needed (for logging/auditing)
          example: "configuration_change"
        priority:
          $ref: '#/components/schemas/RestartPriority'
          default: graceful
        shutdownGracePeriod:
          type: integer
          default: 30
          description: Seconds to allow graceful shutdown before force-kill

    ContainerRestartResponse:
      type: object
      required:
      - accepted
      - appName
      properties:
        accepted:
          type: boolean
          description: Whether the restart request was accepted
        appName:
          type: string
          description: Container that will be restarted
        scheduledFor:
          type: string
          format: date-time
          description: When restart is scheduled (may be queued)
        currentInstances:
          type: integer
          description: Number of running instances
        restartStrategy:
          type: string
          enum: [rolling, simultaneous]
          description: How restart will be performed
        message:
          type: string
          description: Additional information

    ContainerStatus:
      type: object
      required:
      - appName
      - status
      - timestamp
      properties:
        appName:
          type: string
          description: Container's Dapr app name
        status:
          type: string
          enum: [running, starting, stopping, stopped, unhealthy]
        timestamp:
          type: string
          format: date-time
        instances:
          type: integer
          description: Number of running instances
        plugins:
          type: array
          items:
            type: string
          description: Plugins running in this container
        lastRestart:
          type: string
          format: date-time
          description: When container was last restarted
        restartCount:
          type: integer
          description: Number of restarts in last 24 hours
        restartHistory:
          type: array
          items:
            $ref: '#/components/schemas/RestartHistoryEntry'
          description: Recent restart history
        healthChecks:
          type: object
          properties:
            lastCheck:
              type: string
              format: date-time
            status:
              type: string
            consecutiveFailures:
              type: integer
        labels:
          type: object
          additionalProperties:
            type: string
          description: Container labels for metadata and management

    RestartHistoryEntry:
      type: object
      required:
      - timestamp
      - reason
      properties:
        timestamp:
          type: string
          format: date-time
        reason:
          type: string
        priority:
          $ref: '#/components/schemas/RestartPriority'
        duration:
          type: string
          description: Time taken to restart
        success:
          type: boolean
        error:
          type: string
          description: Error message if restart failed

    # ==========================================================================
    # CONFIGURATION MANAGEMENT SCHEMAS
    # ==========================================================================

    ConfigRollbackRequest:
      type: object
      required:
      - reason
      properties:
        reason:
          type: string
          description: Why rollback is needed (for auditing)
          example: "auth.jwt_secret broke authentication"

    ConfigRollbackResponse:
      type: object
      required:
      - success
      - previousVersion
      - currentVersion
      properties:
        success:
          type: boolean
        previousVersion:
          type: integer
          description: Config version before rollback
        currentVersion:
          type: integer
          description: Config version after rollback (now active)
        changedKeys:
          type: array
          items:
            type: string
          description: Keys that were reverted
        message:
          type: string

    ConfigVersionResponse:
      type: object
      required:
      - version
      - timestamp
      properties:
        version:
          type: integer
          description: Current configuration version number
        timestamp:
          type: string
          format: date-time
          description: When current config was applied
        hasPreviousConfig:
          type: boolean
          description: Whether a previous config is available for rollback
        keyCount:
          type: integer
          description: Number of configuration keys (not values for security)
        keyPrefixes:
          type: array
          items:
            type: string
          description: Configuration key prefixes present (e.g., "auth", "database")

    # ============================================================
    # PROCESSING POOL MODELS
    # ============================================================

    AcquireProcessorRequest:
      type: object
      required:
      - pool_type
      properties:
        pool_type:
          type: string
          description: Type of processing pool (e.g., "asset-processor", "texture-processor")
        priority:
          type: integer
          default: 0
          description: Request priority (higher = more urgent)
        timeout_seconds:
          type: integer
          default: 300
          description: How long the lease is valid for
        metadata:
          type: object
          additionalProperties: true
          description: Optional metadata about the processing job

    AcquireProcessorResponse:
      type: object
      required:
      - processor_id
      - app_id
      - lease_id
      - expires_at
      properties:
        processor_id:
          type: string
          description: Unique identifier for this processor instance
        app_id:
          type: string
          description: Dapr app-id for service invocation to this processor
        lease_id:
          type: string
          format: uuid
          description: Unique lease identifier (used for release)
        expires_at:
          type: string
          format: date-time
          description: When the lease expires (must release before this)

    PoolBusyResponse:
      type: object
      required:
      - pool_type
      - queue_position
      - estimated_wait_seconds
      properties:
        pool_type:
          type: string
          description: Pool type that is busy
        queue_position:
          type: integer
          description: Position in the wait queue (0 = not queued)
        estimated_wait_seconds:
          type: integer
          description: Estimated wait time until a processor is available
        message:
          type: string
          description: Human-readable status message

    ReleaseProcessorRequest:
      type: object
      required:
      - lease_id
      properties:
        lease_id:
          type: string
          format: uuid
          description: The lease ID returned from AcquireProcessor
        success:
          type: boolean
          default: true
          description: Whether the processing completed successfully
        metrics:
          type: object
          additionalProperties: true
          description: Optional processing metrics (duration, items processed, etc.)

    ReleaseProcessorResponse:
      type: object
      required:
      - released
      properties:
        released:
          type: boolean
          description: Whether the processor was successfully released
        processor_id:
          type: string
          description: ID of the released processor

    GetPoolStatusRequest:
      type: object
      required:
      - pool_type
      properties:
        pool_type:
          type: string
          description: Type of processing pool to query
        include_metrics:
          type: boolean
          default: true
          description: Include recent processing metrics

    PoolStatusResponse:
      type: object
      required:
      - pool_type
      - total_instances
      - available_instances
      - busy_instances
      - utilization
      properties:
        pool_type:
          type: string
          description: Pool type
        total_instances:
          type: integer
          description: Total processor instances in the pool
        available_instances:
          type: integer
          description: Instances ready to accept work
        busy_instances:
          type: integer
          description: Instances currently processing
        queue_depth:
          type: integer
          description: Number of requests waiting for a processor
        utilization:
          type: number
          format: float
          description: Current utilization percentage (0.0 to 1.0)
        min_instances:
          type: integer
          description: Minimum configured instances
        max_instances:
          type: integer
          description: Maximum configured instances
        scale_up_threshold:
          type: number
          format: float
          description: Utilization threshold for auto-scale-up
        recent_metrics:
          $ref: '#/components/schemas/PoolMetrics'

    PoolMetrics:
      type: object
      properties:
        jobs_completed_1h:
          type: integer
          description: Jobs completed in the last hour
        jobs_failed_1h:
          type: integer
          description: Jobs failed in the last hour
        avg_processing_time_ms:
          type: integer
          description: Average processing time in milliseconds
        last_scale_event:
          type: string
          format: date-time
          description: When the pool was last scaled

    ScalePoolRequest:
      type: object
      required:
      - pool_type
      - target_instances
      properties:
        pool_type:
          type: string
          description: Type of processing pool to scale
        target_instances:
          type: integer
          minimum: 0
          description: Desired number of instances
        force:
          type: boolean
          default: false
          description: Force scale even if it would interrupt processing

    ScalePoolResponse:
      type: object
      required:
      - pool_type
      - previous_instances
      - current_instances
      properties:
        pool_type:
          type: string
          description: Pool type that was scaled
        previous_instances:
          type: integer
          description: Instance count before scaling
        current_instances:
          type: integer
          description: Instance count after scaling
        scaled_up:
          type: integer
          description: Number of instances added
        scaled_down:
          type: integer
          description: Number of instances removed
        message:
          type: string
          description: Status message

    CleanupPoolRequest:
      type: object
      required:
      - pool_type
      properties:
        pool_type:
          type: string
          description: Type of processing pool to cleanup
        preserve_minimum:
          type: boolean
          default: true
          description: Keep at least min_instances running

    CleanupPoolResponse:
      type: object
      required:
      - pool_type
      - instances_removed
      properties:
        pool_type:
          type: string
          description: Pool type that was cleaned up
        instances_removed:
          type: integer
          description: Number of idle instances removed
        current_instances:
          type: integer
          description: Instance count after cleanup
        message:
          type: string
          description: Status message

