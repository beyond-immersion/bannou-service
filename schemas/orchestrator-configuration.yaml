openapi: 3.0.4
info:
  title: Orchestrator Service Configuration
  description: |
    Configuration schema for Orchestrator service.
    Properties are bound to environment variables with BANNOU_ prefix.

    **SCHEMA MODIFICATION GATE**: STOP. Before modifying this schema, you MUST:
    1. Read docs/reference/SCHEMA-RULES.md
    2. State which section applies to your change
    3. Only then proceed with edits
    Edits without stating the applicable rule are FORBIDDEN.
  version: 1.0.0
paths: {}
x-service-configuration:
  properties:
    # Security Configuration
    SecureWebsocket:
      type: boolean
      description: When true, publishes blank permission registration making orchestrator inaccessible via WebSocket. Set false for testing.
      env: ORCHESTRATOR_SECURE_WEBSOCKET
      default: true

    # Backend Configuration
    DefaultBackend:
      $ref: 'orchestrator-api.yaml#/components/schemas/BackendType'
      description: Default container orchestration backend when not specified in deploy request
      env: ORCHESTRATOR_DEFAULT_BACKEND
      default: "compose"

    # Heartbeat Configuration
    HeartbeatTimeoutSeconds:
      type: integer
      description: Service heartbeat timeout in seconds
      env: ORCHESTRATOR_HEARTBEAT_TIMEOUT_SECONDS
      default: 90
      minimum: 1
    DegradationThresholdMinutes:
      type: integer
      description: Time in minutes before a service is marked as degraded
      env: ORCHESTRATOR_DEGRADATION_THRESHOLD_MINUTES
      default: 5
      minimum: 1

    # Portainer Configuration (Docker Swarm/Compose backend)
    PortainerUrl:
      type: string
      nullable: true  # NRT: Optional config MUST be nullable (only needed for Portainer backend)
      description: Portainer API URL
      env: ORCHESTRATOR_PORTAINER_URL
      example: "https://portainer.example.com:9443"
    PortainerApiKey:
      type: string
      nullable: true  # NRT: Optional config MUST be nullable (only needed for Portainer backend)
      description: Portainer API key
      env: ORCHESTRATOR_PORTAINER_API_KEY
      example: "ptr_your-portainer-api-key-here"
    PortainerEndpointId:
      type: integer
      description: Portainer endpoint ID
      env: ORCHESTRATOR_PORTAINER_ENDPOINT_ID
      default: 1
      minimum: 1
    PortainerRequestTimeoutSeconds:
      type: integer
      description: HTTP request timeout in seconds for Portainer API calls
      env: ORCHESTRATOR_PORTAINER_REQUEST_TIMEOUT_SECONDS
      default: 30
      minimum: 1

    # Docker Configuration (Docker Compose backend)
    DockerImageName:
      type: string
      description: Docker image name for deployed Bannou containers
      env: ORCHESTRATOR_DOCKER_IMAGE_NAME
      default: "bannou:latest"
    DockerHost:
      type: string
      description: Docker host for direct Docker API access
      env: ORCHESTRATOR_DOCKER_HOST
      default: "unix:///var/run/docker.sock"
    DockerNetwork:
      type: string
      description: Docker network name for deployed containers
      env: ORCHESTRATOR_DOCKER_NETWORK
      default: "bannou_default"
    CertificatesHostPath:
      type: string
      description: Host path for TLS certificates
      env: ORCHESTRATOR_CERTIFICATES_HOST_PATH
      default: "/app/provisioning/certificates"
    PresetsHostPath:
      type: string
      description: Host path for orchestrator deployment presets
      env: ORCHESTRATOR_PRESETS_HOST_PATH
      default: "/app/provisioning/orchestrator/presets"
    LogsVolumeName:
      type: string
      description: Docker volume name for logs
      env: ORCHESTRATOR_LOGS_VOLUME
      default: "logs-data"

    # OpenResty Configuration (routing cache invalidation)
    OpenRestyHost:
      type: string
      description: OpenResty hostname for cache invalidation calls
      env: ORCHESTRATOR_OPENRESTY_HOST
      default: "openresty"
    OpenRestyPort:
      type: integer
      description: OpenResty port for cache invalidation calls
      env: ORCHESTRATOR_OPENRESTY_PORT
      default: 80
      minimum: 1
      maximum: 65535
    OpenRestyRequestTimeoutSeconds:
      type: integer
      description: Timeout in seconds for OpenResty HTTP requests
      env: ORCHESTRATOR_OPENRESTY_REQUEST_TIMEOUT_SECONDS
      default: 5
      minimum: 1

    # Kubernetes Configuration
    KubernetesNamespace:
      type: string
      description: Kubernetes namespace for deployments
      env: ORCHESTRATOR_KUBERNETES_NAMESPACE
      default: "default"
    KubeconfigPath:
      type: string
      nullable: true
      description: Path to kubeconfig file (null uses default ~/.kube/config)
      env: ORCHESTRATOR_KUBECONFIG_PATH
      example: "/path/to/.kube/config"

    # State Manager TTL Configuration
    HeartbeatTtlSeconds:
      type: integer
      description: TTL in seconds for service heartbeat entries in state store
      env: ORCHESTRATOR_HEARTBEAT_TTL_SECONDS
      default: 90
      minimum: 1
    RoutingTtlSeconds:
      type: integer
      description: TTL in seconds for service routing entries in state store
      env: ORCHESTRATOR_ROUTING_TTL_SECONDS
      default: 300
      minimum: 1
    ConfigHistoryTtlDays:
      type: integer
      description: TTL in days for configuration history entries in state store
      env: ORCHESTRATOR_CONFIG_HISTORY_TTL_DAYS
      default: 30
      minimum: 1

    # Smart Restart Configuration
    RestartTimeoutSeconds:
      type: integer
      description: Default timeout in seconds for container restart operations
      env: ORCHESTRATOR_RESTART_TIMEOUT_SECONDS
      default: 120
      minimum: 1
    HealthCheckIntervalMs:
      type: integer
      description: Interval in milliseconds between health checks during restart
      env: ORCHESTRATOR_HEALTH_CHECK_INTERVAL_MS
      default: 2000
      minimum: 100
    DefaultWaitBeforeKillSeconds:
      type: integer
      description: Default seconds to wait before killing a container during stop
      env: ORCHESTRATOR_DEFAULT_WAIT_BEFORE_KILL_SECONDS
      default: 30
      minimum: 1

    # Polling Configuration
    ContainerStatusPollIntervalSeconds:
      type: integer
      description: Interval in seconds for polling container status during deploy
      env: ORCHESTRATOR_CONTAINER_STATUS_POLL_INTERVAL_SECONDS
      default: 2
      minimum: 1

    # Service Mesh Broadcasting
    FullMappingsIntervalSeconds:
      type: integer
      description: Interval in seconds for publishing full service-to-appId mappings broadcast
      env: ORCHESTRATOR_FULL_MAPPINGS_INTERVAL_SECONDS
      default: 30
      minimum: 1

    # Orphan Container Detection
    OrphanContainerThresholdHours:
      type: integer
      description: Hours since last heartbeat before a container is considered orphaned
      env: ORCHESTRATOR_ORPHAN_CONTAINER_THRESHOLD_HOURS
      default: 24
      minimum: 1

    # State Manager Retry Configuration
    IndexUpdateMaxRetries:
      type: integer
      description: Maximum number of retry attempts for state index update operations
      env: ORCHESTRATOR_INDEX_UPDATE_MAX_RETRIES
      default: 3
      minimum: 1

    # Processing Pool Configuration
    DefaultPoolLeaseTimeoutSeconds:
      type: integer
      description: Default lease timeout in seconds for acquired processing pool instances
      env: ORCHESTRATOR_DEFAULT_POOL_LEASE_TIMEOUT_SECONDS
      default: 300
      minimum: 1
    PoolLockTimeoutSeconds:
      type: integer
      description: Timeout in seconds for acquiring distributed locks on processing pool operations
      env: ORCHESTRATOR_POOL_LOCK_TIMEOUT_SECONDS
      default: 15
      minimum: 1

    # Service Discovery Configuration
    DefaultServicePort:
      type: integer
      description: Default HTTP port for discovered service instances used in health checks and mesh registration
      env: ORCHESTRATOR_DEFAULT_SERVICE_PORT
      default: 80
      minimum: 1
      maximum: 65535

    # Infrastructure Connection Strings
    RedisConnectionString:
      type: string
      description: Redis connection string for orchestrator state.
      env: ORCHESTRATOR_REDIS_CONNECTION_STRING
      default: "bannou-redis:6379"
