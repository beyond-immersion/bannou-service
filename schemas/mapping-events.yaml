openapi: 3.0.3
info:
  title: Mapping Service Events
  description: |
    Event models for Mapping service RabbitMQ pub/sub via MassTransit.

    The Mapping service publishes events when map data changes.
    Consumers (Event Actors, Game Servers, Analytics) subscribe to relevant topics.

    **Topic Patterns**:
    - `map.{regionId}.{kind}.updated` - Map data updated
    - `map.{regionId}.{kind}.snapshot` - Full snapshot published
    - `map.{regionId}.{kind}.objects.changed` - Objects changed
    - `map.ingest.{channelId}` - High-throughput ingest (service subscribes)
    - `map.warnings.unauthorized_publish` - Non-authority publish attempts

    **NRT Compliance**: AI agents MUST review docs/NRT-SCHEMA-RULES.md before
    modifying this schema. Optional reference types require `nullable: true`.
  version: 1.0.0

  x-event-subscriptions:
    # The mapping service dynamically subscribes to ingest topics per-channel.
    # This cannot be expressed statically - handled in MappingServiceEvents.cs
    - topic: map.ingest.*
      event: MapIngestEvent
      description: Dynamic subscription per-channel for authority event publishing

  x-event-publications:
    # Map channel lifecycle events (auto-generated from x-lifecycle)
    - topic: mapping.channel.created
      event: MappingChannelCreatedEvent
      description: Published when a new map channel is created
    - topic: mapping.channel.updated
      event: MappingChannelUpdatedEvent
      description: Published when a map channel is updated
    - topic: mapping.channel.deleted
      event: MappingChannelDeletedEvent
      description: Published when a map channel is deleted

    # Map data events (published dynamically per region/kind)
    - topic: map.{regionId}.{kind}.updated
      event: MapUpdatedEvent
      description: Published when map data is updated
    - topic: map.{regionId}.{kind}.snapshot
      event: MapSnapshotEvent
      description: Published when a full snapshot is available
    - topic: map.{regionId}.{kind}.objects.changed
      event: MapObjectsChangedEvent
      description: Published when map objects are created/updated/deleted

    # Warning events
    - topic: map.warnings.unauthorized_publish
      event: MapUnauthorizedPublishWarning
      description: Published when non-authority attempts to publish

    # Authority lifecycle events
    - topic: mapping.authority.granted
      event: MappingAuthorityGrantedEvent
      description: Published when authority is granted over a channel
    - topic: mapping.authority.released
      event: MappingAuthorityReleasedEvent
      description: Published when authority is explicitly released
    - topic: mapping.authority.expired
      event: MappingAuthorityExpiredEvent
      description: Published when authority expires (detected during validation)

# Lifecycle events auto-generated from this definition
# Output: schemas/Generated/mapping-lifecycle-events.yaml
x-lifecycle:
  MappingChannel:
    model:
      channelId: { type: string, format: uuid, primary: true, required: true, description: "Unique identifier for the channel (region+kind)" }
      regionId: { type: string, format: uuid, required: true, description: "Region this channel serves" }
      kind: { type: string, required: true, description: "Map kind (terrain, static_geometry, etc.)" }
      authorityAppId: { type: string, nullable: true, description: "App ID of current authority (null if unassigned)" }
      authorityToken: { type: string, nullable: true, description: "Current authority token (null if unassigned)" }
      authorityExpiresAt: { type: string, format: date-time, nullable: true, description: "When current authority expires" }
      nonAuthorityHandling: { $ref: '../mapping-api.yaml#/components/schemas/NonAuthorityHandlingMode', required: true, description: "How to handle non-authority publishes" }
      version: { type: integer, format: int64, required: true, description: "Current version number" }
      createdAt: { type: string, format: date-time, required: true, description: "When the channel was created" }
      updatedAt: { type: string, format: date-time, required: true, description: "When the channel was last updated" }

paths: {}

components:
  schemas:
    # ========== SPATIAL PRIMITIVES (inline for NSwag compatibility) ==========
    EventPosition3D:
      type: object
      description: A point in 3D space (event version)
      required:
        - x
        - y
        - z
      properties:
        x:
          type: number
          format: double
          description: X coordinate
        y:
          type: number
          format: double
          description: Y coordinate
        z:
          type: number
          format: double
          description: Z coordinate

    EventBounds:
      type: object
      description: An axis-aligned bounding box in 3D space (event version)
      required:
        - min
        - max
      properties:
        min:
          $ref: '#/components/schemas/EventPosition3D'
          description: Minimum corner
        max:
          $ref: '#/components/schemas/EventPosition3D'
          description: Maximum corner

    # ========== MAP OBJECT (for events) ==========
    EventMapObject:
      type: object
      description: A map object in an event
      required:
        - objectId
        - regionId
        - kind
        - objectType
      properties:
        objectId:
          type: string
          format: uuid
          description: Unique identifier
        regionId:
          type: string
          format: uuid
          description: Region this object belongs to
        kind:
          type: string
          description: Map kind
        objectType:
          type: string
          description: Publisher-defined type
        position:
          $ref: '#/components/schemas/EventPosition3D'
          description: Position for point objects
          nullable: true
        bounds:
          $ref: '#/components/schemas/EventBounds'
          description: Bounding box for area objects
          nullable: true
        data:
          type: object
          additionalProperties: true
          description: Schema-less object data (publisher-defined)
          nullable: true
        version:
          type: integer
          format: int64
          description: Object version

    # ========== INGEST EVENT (Authority -> Service) ==========
    MapIngestEvent:
      type: object
      description: |
        Event published by authority to ingest topic for high-throughput updates.
        lib-mapping validates authority and broadcasts to consumers.
        Published to: map.ingest.{channelId}
      required:
        - authorityToken
        - timestamp
        - payloads
      properties:
        authorityToken:
          type: string
          description: Token proving authority over this channel
        timestamp:
          type: string
          format: date-time
          description: When the event was created
        payloads:
          type: array
          maxItems: 100
          items:
            $ref: '#/components/schemas/IngestPayload'
          description: Schema-less payloads to ingest

    IngestPayload:
      type: object
      description: A single payload in an ingest event
      required:
        - objectType
      properties:
        objectId:
          type: string
          format: uuid
          description: Object ID (generated if not provided)
          nullable: true
        objectType:
          type: string
          description: Publisher-defined type
        action:
          type: string
          enum: [create, update, delete]
          default: update
          description: Type of change
        position:
          $ref: '#/components/schemas/EventPosition3D'
          description: Position for point objects
          nullable: true
        bounds:
          $ref: '#/components/schemas/EventBounds'
          description: Bounding box for area objects
          nullable: true
        data:
          type: object
          additionalProperties: true
          description: Schema-less object data (publisher-defined)
          nullable: true

    # ========== BROADCAST EVENTS (Service -> Consumers) ==========
    MapUpdatedEvent:
      type: object
      description: |
        Published when map layer data changes.
        Topic: map.{regionId}.{kind}.updated
      required:
        - eventId
        - timestamp
        - regionId
        - kind
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique event identifier
        timestamp:
          type: string
          format: date-time
          description: When the update occurred
        regionId:
          type: string
          format: uuid
          description: Region containing this map data
        kind:
          type: string
          description: Map kind (terrain, static_geometry, etc.)
        channelId:
          type: string
          format: uuid
          description: Channel that published this update
          nullable: true
        bounds:
          $ref: '#/components/schemas/EventBounds'
          description: Affected area (null means entire region)
          nullable: true
        version:
          type: integer
          format: int64
          description: Monotonic version for ordering
          nullable: true
        deltaType:
          allOf:
          - $ref: '../mapping-api.yaml#/components/schemas/DeltaType'
          nullable: true
          description: Whether this is incremental or full
        sourceAppId:
          type: string
          description: App-id of publisher
          nullable: true
        payload:
          type: object
          additionalProperties: true
          description: Schema-less payload data
          nullable: true
        payloadRef:
          type: string
          description: Asset reference for large payloads
          nullable: true

    MapSnapshotEvent:
      type: object
      description: |
        Published when a full snapshot is available.
        Topic: map.{regionId}.{kind}.snapshot
      required:
        - eventId
        - timestamp
        - regionId
        - kind
        - version
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique event identifier
        timestamp:
          type: string
          format: date-time
          description: When the snapshot was created
        regionId:
          type: string
          format: uuid
          description: Region this snapshot covers
        kind:
          type: string
          description: Map kind
        channelId:
          type: string
          format: uuid
          description: Channel that owns this data
          nullable: true
        version:
          type: integer
          format: int64
          description: Snapshot version
        objectCount:
          type: integer
          description: Number of objects in snapshot
          nullable: true
        bounds:
          $ref: '#/components/schemas/EventBounds'
          description: Bounds of snapshot (null means full region)
          nullable: true
        payloadRef:
          type: string
          description: Asset reference for snapshot data (large payloads)
          nullable: true
        objects:
          type: array
          items:
            $ref: '#/components/schemas/EventMapObject'
          description: Inline objects (for small snapshots)
          nullable: true

    MapObjectsChangedEvent:
      type: object
      description: |
        Published when metadata objects change in a map.
        Topic: map.{regionId}.{kind}.objects.changed
      required:
        - eventId
        - timestamp
        - regionId
        - kind
        - changes
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique event identifier
        timestamp:
          type: string
          format: date-time
          description: When the changes occurred
        regionId:
          type: string
          format: uuid
          description: Region containing these objects
        kind:
          type: string
          description: Map kind
        channelId:
          type: string
          format: uuid
          description: Channel that published these changes
          nullable: true
        version:
          type: integer
          format: int64
          description: Version after changes
          nullable: true
        sourceAppId:
          type: string
          description: App-id of authority that published these changes
          nullable: true
        changes:
          type: array
          items:
            $ref: '#/components/schemas/ObjectChangeEvent'
          description: List of object changes

    ObjectChangeEvent:
      type: object
      description: A single object change in an event
      required:
        - objectId
        - action
      properties:
        objectId:
          type: string
          format: uuid
          description: ID of the changed object
        action:
          type: string
          enum: [created, updated, deleted]
          description: Type of change
        objectType:
          type: string
          description: Object type
          nullable: true
        position:
          $ref: '#/components/schemas/EventPosition3D'
          description: Object position (for created/updated)
          nullable: true
        bounds:
          $ref: '#/components/schemas/EventBounds'
          description: Object bounds (for created/updated)
          nullable: true
        data:
          type: object
          additionalProperties: true
          description: Object data (for created/updated)
          nullable: true
        previousVersion:
          type: integer
          format: int64
          description: Version before this change
          nullable: true

    # ========== WARNING EVENTS ==========
    MapUnauthorizedPublishWarning:
      type: object
      description: |
        Published when a non-authority attempts to publish.
        Topic: map.warnings.unauthorized_publish
      required:
        - timestamp
        - channelId
        - attemptedPublisher
        - handlingMode
      properties:
        timestamp:
          type: string
          format: date-time
          description: When the attempt occurred
        channelId:
          type: string
          format: uuid
          description: Channel that was targeted
        regionId:
          type: string
          format: uuid
          description: Region of the channel
          nullable: true
        kind:
          type: string
          description: Map kind of the channel
          nullable: true
        attemptedPublisher:
          type: string
          description: App-id that tried to publish
        currentAuthority:
          type: string
          description: App-id that currently has authority
          nullable: true
        handlingMode:
          $ref: '../mapping-api.yaml#/components/schemas/NonAuthorityHandlingMode'
          description: How the attempt was handled
        publishAccepted:
          type: boolean
          description: Whether the publish was actually accepted
        payloadSummary:
          type: string
          description: Truncated payload (if includePayloadSummary enabled)
          nullable: true

    # ========== SNAPSHOT REQUEST EVENT ==========
    MapSnapshotRequestedEvent:
      type: object
      description: |
        Published when a consumer needs a full snapshot.
        The authority responds with a MapSnapshotEvent.
      required:
        - eventId
        - timestamp
        - requesterId
        - regionId
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique event identifier
        timestamp:
          type: string
          format: date-time
          description: When the request was made
        requesterId:
          type: string
          description: App-id of requester
        regionId:
          type: string
          format: uuid
          description: Region to snapshot
        kinds:
          type: array
          items:
            type: string
          description: Which kinds to snapshot (null means all)
          nullable: true
        bounds:
          $ref: '#/components/schemas/EventBounds'
          description: Optional bounds filter
          nullable: true

    # ========== AUTHORITY LIFECYCLE EVENTS ==========
    MappingAuthorityGrantedEvent:
      type: object
      description: |
        Published when authority is granted over a mapping channel.
        Topic: mapping.authority.granted
      required:
        - eventId
        - timestamp
        - channelId
        - regionId
        - kind
        - authorityAppId
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique event identifier
        timestamp:
          type: string
          format: date-time
          description: When authority was granted
        channelId:
          type: string
          format: uuid
          description: Channel authority was granted for
        regionId:
          type: string
          format: uuid
          description: Region of the channel
        kind:
          type: string
          description: Map kind of the channel
        authorityAppId:
          type: string
          description: App-id that was granted authority
        expiresAt:
          type: string
          format: date-time
          description: When the authority expires
        isNewChannel:
          type: boolean
          description: True if this is a new channel, false if takeover

    MappingAuthorityReleasedEvent:
      type: object
      description: |
        Published when authority is explicitly released over a mapping channel.
        Topic: mapping.authority.released
      required:
        - eventId
        - timestamp
        - channelId
        - authorityAppId
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique event identifier
        timestamp:
          type: string
          format: date-time
          description: When authority was released
        channelId:
          type: string
          format: uuid
          description: Channel authority was released for
        regionId:
          type: string
          format: uuid
          description: Region of the channel
          nullable: true
        kind:
          type: string
          description: Map kind of the channel
          nullable: true
        authorityAppId:
          type: string
          description: App-id that released authority

    MappingAuthorityExpiredEvent:
      type: object
      description: |
        Published when authority expires (detected during validation).
        Topic: mapping.authority.expired
      required:
        - eventId
        - timestamp
        - channelId
        - expiredAt
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique event identifier
        timestamp:
          type: string
          format: date-time
          description: When expiration was detected
        channelId:
          type: string
          format: uuid
          description: Channel whose authority expired
        regionId:
          type: string
          format: uuid
          description: Region of the channel
          nullable: true
        kind:
          type: string
          description: Map kind of the channel
          nullable: true
        expiredAuthorityAppId:
          type: string
          description: App-id whose authority expired
          nullable: true
        expiredAt:
          type: string
          format: date-time
          description: When the authority actually expired
