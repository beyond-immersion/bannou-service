openapi: 3.0.4
info:
  title: Voice Client Events API
  description: |
    Server-to-client push events for the Voice service.
    These events notify clients of voice room state changes, peer connections,
    and tier upgrades delivered via WebSocket.

    All events inherit from BaseClientEvent (common-client-events.yaml) and use
    the "voice.{event_type}" naming convention.

    **Event Delivery**: Events are published to the session-specific RabbitMQ
    channel (CONNECT_SESSION_{sessionId}) and delivered to the client via WebSocket.

    **SCHEMA MODIFICATION GATE**: STOP. Before modifying this schema, you MUST:
    1. Read docs/reference/SCHEMA-RULES.md
    2. State which section applies to your change
    3. Only then proceed with edits
    Edits without stating the applicable rule are FORBIDDEN.
  version: 1.0.0
  contact:
    name: Bannou Development Team

servers: []

paths: {}

components:
  schemas:
    # ============================================
    # Room State Events
    # ============================================

    VoiceRoomStateClientEvent:
      allOf:
        - $ref: 'common-client-events.yaml#/components/schemas/BaseClientEvent'
      type: object
      additionalProperties: false
      x-client-event: true
      description: |
        Sent to a client when they join a voice room.
        Contains full room state including peer list and connection info.
      required:
        - eventName
        - eventId
        - timestamp
        - roomId
        - tier
        - peers
      properties:
        eventName:
          type: string
          default: "voice.room.state"
          description: Fixed event type identifier
        roomId:
          type: string
          format: uuid
          description: Voice room ID
        sessionId:
          type: string
          format: uuid
          nullable: true  # NRT: Optional property MUST be nullable
          description: Associated game session ID
        tier:
          $ref: 'voice-api.yaml#/components/schemas/VoiceTier'
          description: Current voice tier
        codec:
          allOf:
          - $ref: 'voice-api.yaml#/components/schemas/VoiceCodec'
          nullable: true  # NRT: Optional property MUST be nullable
          description: Audio codec to use
        peers:
          type: array
          items:
            $ref: '#/components/schemas/VoicePeerInfo'
          description: List of peers to connect to (P2P mode)
        rtpServerUri:
          type: string
          nullable: true
          description: RTP server URI (scaled mode only)
        stunServers:
          type: array
          items:
            type: string
          nullable: true  # NRT: Optional property MUST be nullable
          description: STUN server URIs for NAT traversal

    # ============================================
    # Peer Events
    # ============================================

    VoicePeerJoinedClientEvent:
      allOf:
        - $ref: 'common-client-events.yaml#/components/schemas/BaseClientEvent'
      type: object
      additionalProperties: false
      x-client-event: true
      description: |
        Sent to existing room participants when a new peer joins.
        Contains the new peer's connection details for P2P mode.
      required:
        - eventName
        - eventId
        - timestamp
        - roomId
        - peer
      properties:
        eventName:
          type: string
          default: "voice.peer.joined"
          description: Fixed event type identifier
        roomId:
          type: string
          format: uuid
          description: Voice room ID
        peer:
          $ref: '#/components/schemas/VoicePeerInfo'
          description: New peer's connection details
        currentParticipantCount:
          type: integer
          description: Total participants after join

    VoicePeerLeftClientEvent:
      allOf:
        - $ref: 'common-client-events.yaml#/components/schemas/BaseClientEvent'
      type: object
      additionalProperties: false
      x-client-event: true
      description: |
        Sent to remaining room participants when a peer leaves.
      required:
        - eventName
        - eventId
        - timestamp
        - roomId
        - peerSessionId
      properties:
        eventName:
          type: string
          default: "voice.peer.left"
          description: Fixed event type identifier
        roomId:
          type: string
          format: uuid
          description: Voice room ID
        peerSessionId:
          type: string
          format: uuid
          description: WebSocket session ID of the peer who left
        displayName:
          type: string
          nullable: true
          description: Display name for UI notification
        remainingParticipantCount:
          type: integer
          description: Participants remaining after departure

    VoicePeerUpdatedClientEvent:
      allOf:
        - $ref: 'common-client-events.yaml#/components/schemas/BaseClientEvent'
      type: object
      additionalProperties: false
      x-client-event: true
      description: |
        Sent when a peer updates their SIP endpoint (e.g., ICE candidate change).
        Clients should update their connection to this peer.
      required:
        - eventName
        - eventId
        - timestamp
        - roomId
        - peer
      properties:
        eventName:
          type: string
          default: "voice.peer.updated"
          description: Fixed event type identifier
        roomId:
          type: string
          format: uuid
          description: Voice room ID
        peer:
          $ref: '#/components/schemas/VoicePeerInfo'
          description: Updated peer connection details

    # ============================================
    # Tier Events
    # ============================================

    VoiceTierUpgradeClientEvent:
      allOf:
        - $ref: 'common-client-events.yaml#/components/schemas/BaseClientEvent'
      type: object
      additionalProperties: false
      x-client-event: true
      description: |
        Sent to all room participants when the voice tier upgrades.
        Clients should disconnect P2P connections and connect to the RTP server.
        SIP credentials are provided for authenticating with the Kamailio SIP proxy.
      required:
        - eventName
        - eventId
        - timestamp
        - roomId
        - newTier
        - rtpServerUri
        - sipCredentials
      properties:
        eventName:
          type: string
          default: "voice.tier-upgrade"
          description: Fixed event type identifier
        roomId:
          type: string
          format: uuid
          description: Voice room ID
        previousTier:
          allOf:
            - $ref: 'voice-api.yaml#/components/schemas/VoiceTier'
          nullable: true  # NRT: Optional property MUST be nullable
          description: Previous tier (always p2p for upgrade events)
        newTier:
          $ref: 'voice-api.yaml#/components/schemas/VoiceTier'
          description: New tier after upgrade (always scaled for upgrade events)
        rtpServerUri:
          type: string
          description: RTP server URI to connect to
        sipCredentials:
          $ref: '#/components/schemas/SipCredentials'
          description: Credentials for SIP registration with Kamailio
        migrationDeadlineMs:
          type: integer
          default: 5000
          description: Milliseconds to complete migration before P2P disconnects

    # ============================================
    # Room Lifecycle Events
    # ============================================

    VoiceRoomClosedClientEvent:
      allOf:
        - $ref: 'common-client-events.yaml#/components/schemas/BaseClientEvent'
      type: object
      additionalProperties: false
      x-client-event: true
      description: |
        Sent to all room participants when the voice room is closed.
        Clients should disconnect all voice connections.
      required:
        - eventName
        - eventId
        - timestamp
        - roomId
        - reason
      properties:
        eventName:
          type: string
          default: "voice.room.closed"
          description: Fixed event type identifier
        roomId:
          type: string
          format: uuid
          description: Voice room ID that was closed
        reason:
          $ref: 'voice-api.yaml#/components/schemas/VoiceRoomDeletedReason'
          description: Reason the room was closed

    # ============================================
    # Broadcast Consent Events
    # ============================================

    VoiceBroadcastConsentRequestClientEvent:
      allOf:
        - $ref: 'common-client-events.yaml#/components/schemas/BaseClientEvent'
      type: object
      additionalProperties: false
      x-client-event: true
      description: >
        Sent to all room participants when someone requests broadcast consent.
        Each participant should respond via /voice/room/broadcast/consent.
      required:
        - eventName
        - eventId
        - timestamp
        - roomId
      properties:
        eventName:
          type: string
          default: "voice.broadcast.consent-request"
          description: Fixed event type identifier
        roomId:
          type: string
          format: uuid
          description: Voice room ID
        requestedBySessionId:
          type: string
          format: uuid
          nullable: true
          description: Who initiated the broadcast request (null if server-derived from auth context)
        requestedByDisplayName:
          type: string
          nullable: true
          description: Display name of requester for UI

    VoiceBroadcastConsentUpdateClientEvent:
      allOf:
        - $ref: 'common-client-events.yaml#/components/schemas/BaseClientEvent'
      type: object
      additionalProperties: false
      x-client-event: true
      description: >
        Sent to all room participants when the broadcast consent state changes
        (someone consented, someone declined, broadcast started, broadcast stopped).
      required:
        - eventName
        - eventId
        - timestamp
        - roomId
        - state
      properties:
        eventName:
          type: string
          default: "voice.broadcast.consent-update"
          description: Fixed event type identifier
        roomId:
          type: string
          format: uuid
          description: Voice room ID
        state:
          $ref: 'voice-api.yaml#/components/schemas/BroadcastConsentState'
          description: Current broadcast consent state
        consentedCount:
          type: integer
          description: How many participants have consented
        totalCount:
          type: integer
          description: Total participants who need to consent
        declinedByDisplayName:
          type: string
          nullable: true
          description: If declined, who declined (for UI feedback)

    # ============================================
    # Supporting Types
    # ============================================

    VoicePeerInfo:
      type: object
      additionalProperties: false
      description: Peer connection information for P2P voice
      required:
        - peerSessionId
        - sdpOffer
      properties:
        peerSessionId:
          type: string
          format: uuid
          description: WebSocket session ID for this peer
        displayName:
          type: string
          nullable: true
          description: Peer's display name
        sdpOffer:
          type: string
          description: SDP offer for WebRTC negotiation
        iceCandidates:
          type: array
          items:
            type: string
          nullable: true
          description: ICE candidates for NAT traversal
        isMuted:
          type: boolean
          default: false
          description: Whether peer is currently muted

    SipCredentials:
      type: object
      additionalProperties: false
      description: |
        SIP credentials for authenticating with the Kamailio SIP proxy in scaled tier mode.
        These credentials are dynamically generated per-user per-room and should be used
        for SIP REGISTER and subsequent INVITE requests.
      required:
        - username
        - password
        - domain
      properties:
        username:
          type: string
          description: SIP username (typically sessionId or a hash-derived identifier)
        password:
          type: string
          description: SIP password (dynamically generated, short-lived)
        domain:
          type: string
          description: SIP domain/realm for authentication (e.g., "voice.bannou.local")
        expiresAt:
          type: string
          format: date-time
          nullable: true
          description: When these credentials expire (clients should re-authenticate before this)
