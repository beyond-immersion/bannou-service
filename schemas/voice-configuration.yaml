openapi: 3.0.3
info:
  title: Voice Service Configuration
  description: |
    Configuration schema for Voice service.
    Properties are bound to environment variables with BANNOU_ prefix.

    **SCHEMA MODIFICATION GATE**: STOP. Before modifying this schema, you MUST:
    1. Read docs/reference/SCHEMA-RULES.md
    2. State which section applies to your change
    3. Only then proceed with edits
    Edits without stating the applicable rule are FORBIDDEN.
  version: 1.0.0
paths: {}
x-service-configuration:
  properties:
    # Tier Configuration
    ScaledTierEnabled:
      type: boolean
      description: Enable scaled tier voice communication (SIP-based)
      env: VOICE_SCALED_TIER_ENABLED
      default: false
    TierUpgradeEnabled:
      type: boolean
      description: Enable automatic tier upgrade from P2P to scaled
      env: VOICE_TIER_UPGRADE_ENABLED
      default: false
    TierUpgradeMigrationDeadlineMs:
      type: integer
      description: Migration deadline in milliseconds when upgrading tiers
      env: VOICE_TIER_UPGRADE_MIGRATION_DEADLINE_MS
      default: 30000

    # Participant Limits
    P2PMaxParticipants:
      type: integer
      description: Maximum participants in P2P voice sessions
      env: VOICE_P2P_MAX_PARTICIPANTS
      default: 8
      minimum: 2
      maximum: 16
    ScaledMaxParticipants:
      type: integer
      description: Maximum participants in scaled tier voice sessions
      env: VOICE_SCALED_MAX_PARTICIPANTS
      default: 100
      minimum: 1
      maximum: 500

    # STUN/TURN Servers (comma-separated)
    StunServers:
      type: string
      description: Comma-separated list of STUN server URLs for WebRTC
      env: VOICE_STUN_SERVERS
      default: "stun:stun.l.google.com:19302"

    # SIP Configuration
    SipPasswordSalt:
      type: string
      nullable: true  # NRT: Optional config MUST be nullable (only required when ScaledTierEnabled=true)
      description: Salt for SIP password generation. Required only when ScaledTierEnabled=true - service fails fast if missing when scaled tier is enabled.
      env: VOICE_SIP_PASSWORD_SALT
      example: "your-sip-password-salt-for-voice"
    SipDomain:
      type: string
      description: SIP domain for voice communication
      env: VOICE_SIP_DOMAIN
      default: "voice.bannou.local"

    # Kamailio Configuration
    KamailioHost:
      type: string
      description: Kamailio SIP server host
      env: VOICE_KAMAILIO_HOST
      default: "localhost"
    KamailioRpcPort:
      type: integer
      description: Kamailio JSON-RPC port (typically 5080, not SIP port 5060)
      env: VOICE_KAMAILIO_RPC_PORT
      default: 5080
    KamailioSipPort:
      type: integer
      description: Kamailio SIP signaling port for client registration
      env: VOICE_KAMAILIO_SIP_PORT
      default: 5060

    # RTPEngine Configuration
    RtpEngineHost:
      type: string
      description: RTPEngine media relay host
      env: VOICE_RTPENGINE_HOST
      default: "localhost"
    RtpEnginePort:
      type: integer
      description: RTPEngine control port
      env: VOICE_RTPENGINE_PORT
      default: 22222
      minimum: 1
      maximum: 65535

    # Request Timeout Configuration
    KamailioRequestTimeoutSeconds:
      type: integer
      description: Timeout in seconds for Kamailio service requests
      env: VOICE_KAMAILIO_REQUEST_TIMEOUT_SECONDS
      default: 5
      minimum: 1
      maximum: 300

    # SIP Credential Configuration
    SipCredentialExpirationHours:
      type: integer
      description: Hours until SIP credentials expire (clients should re-authenticate before expiration)
      env: VOICE_SIP_CREDENTIAL_EXPIRATION_HOURS
      default: 24
