openapi: 3.0.4
info:
  title: Voice Service Configuration
  description: |
    Configuration schema for Voice service.
    Properties are bound to environment variables with BANNOU_ prefix.

    **SCHEMA MODIFICATION GATE**: STOP. Before modifying this schema, you MUST:
    1. Read docs/reference/SCHEMA-RULES.md
    2. State which section applies to your change
    3. Only then proceed with edits
    Edits without stating the applicable rule are FORBIDDEN.
  version: 1.0.0
paths: {}
x-service-configuration:
  properties:
    # Tier Configuration
    ScaledTierEnabled:
      type: boolean
      description: Enable scaled tier voice communication (SIP-based)
      env: VOICE_SCALED_TIER_ENABLED
      default: false
    TierUpgradeEnabled:
      type: boolean
      description: Enable automatic tier upgrade from P2P to scaled
      env: VOICE_TIER_UPGRADE_ENABLED
      default: false
    TierUpgradeMigrationDeadlineMs:
      type: integer
      description: Migration deadline in milliseconds when upgrading tiers
      env: VOICE_TIER_UPGRADE_MIGRATION_DEADLINE_MS
      default: 30000

    # Participant Limits
    P2PMaxParticipants:
      type: integer
      description: Maximum participants in P2P voice sessions
      env: VOICE_P2P_MAX_PARTICIPANTS
      default: 8
      minimum: 2
      maximum: 16
    ScaledMaxParticipants:
      type: integer
      description: Maximum participants in scaled tier voice sessions
      env: VOICE_SCALED_MAX_PARTICIPANTS
      default: 100
      minimum: 1
      maximum: 500

    # STUN/TURN Servers (comma-separated)
    StunServers:
      type: string
      description: Comma-separated list of STUN server URLs for WebRTC
      env: VOICE_STUN_SERVERS
      default: "stun:stun.l.google.com:19302"

    # SIP Configuration
    SipPasswordSalt:
      type: string
      nullable: true  # NRT: Optional config MUST be nullable (only required when ScaledTierEnabled=true)
      description: Salt for SIP password generation. Required only when ScaledTierEnabled=true - service fails fast if missing when scaled tier is enabled.
      env: VOICE_SIP_PASSWORD_SALT
      example: "your-sip-password-salt-for-voice"
    SipDomain:
      type: string
      description: SIP domain for voice communication
      env: VOICE_SIP_DOMAIN
      default: "voice.bannou.local"

    # Kamailio Configuration
    KamailioHost:
      type: string
      description: Kamailio SIP server host
      env: VOICE_KAMAILIO_HOST
      default: "localhost"
    KamailioRpcPort:
      type: integer
      description: Kamailio JSON-RPC port (typically 5080, not SIP port 5060)
      env: VOICE_KAMAILIO_RPC_PORT
      default: 5080
    KamailioSipPort:
      type: integer
      description: Kamailio SIP signaling port for client registration
      env: VOICE_KAMAILIO_SIP_PORT
      default: 5060

    # RTPEngine Configuration
    RtpEngineHost:
      type: string
      description: RTPEngine media relay host
      env: VOICE_RTPENGINE_HOST
      default: "localhost"
    RtpEnginePort:
      type: integer
      description: RTPEngine control port
      env: VOICE_RTPENGINE_PORT
      default: 22222
      minimum: 1
      maximum: 65535
    RtpEngineTimeoutSeconds:
      type: integer
      description: Timeout in seconds for RTPEngine UDP requests
      env: VOICE_RTPENGINE_TIMEOUT_SECONDS
      default: 5
      minimum: 1
      maximum: 60

    # Request Timeout Configuration
    KamailioRequestTimeoutSeconds:
      type: integer
      description: Timeout in seconds for Kamailio service requests
      env: VOICE_KAMAILIO_REQUEST_TIMEOUT_SECONDS
      default: 5
      minimum: 1
      maximum: 300

    # SIP Credential Configuration
    SipCredentialExpirationHours:
      type: integer
      description: Hours until SIP credentials expire (clients should re-authenticate before expiration)
      env: VOICE_SIP_CREDENTIAL_EXPIRATION_HOURS
      default: 24

    # Eviction Worker
    EvictionWorkerInitialDelaySeconds:
      type: integer
      description: Seconds to wait after startup before the first eviction cycle runs
      env: VOICE_EVICTION_WORKER_INITIAL_DELAY_SECONDS
      default: 10
      minimum: 0
      maximum: 120

    # Participant TTL enforcement
    ParticipantHeartbeatTimeoutSeconds:
      type: integer
      description: Seconds of missed heartbeats before participant is evicted
      env: VOICE_PARTICIPANT_HEARTBEAT_TIMEOUT_SECONDS
      default: 60
      minimum: 10
      maximum: 600
    ParticipantEvictionCheckIntervalSeconds:
      type: integer
      description: How often the background worker checks for stale participants
      env: VOICE_PARTICIPANT_EVICTION_CHECK_INTERVAL_SECONDS
      default: 15
      minimum: 5
      maximum: 120

    # Broadcast consent
    BroadcastConsentTimeoutSeconds:
      type: integer
      description: Seconds to wait for all participants to respond before auto-declining
      env: VOICE_BROADCAST_CONSENT_TIMEOUT_SECONDS
      default: 30
      minimum: 10
      maximum: 120

    # Ad-hoc room support
    AdHocRoomsEnabled:
      type: boolean
      description: If true, joining a non-existent room auto-creates it with autoCleanup enabled
      env: VOICE_AD_HOC_ROOMS_ENABLED
      default: false
    EmptyRoomGracePeriodSeconds:
      type: integer
      description: Seconds an empty autoCleanup room persists before auto-deletion
      env: VOICE_EMPTY_ROOM_GRACE_PERIOD_SECONDS
      default: 300
      minimum: 0
      maximum: 3600
