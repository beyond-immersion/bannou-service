openapi: 3.0.3
info:
  title: Save-Load Service Events
  version: 1.0.0
  description: |
    Events published by the Save-Load service.

    **SCHEMA MODIFICATION GATE**: STOP. Before modifying this schema, you MUST:
    1. Read docs/reference/SCHEMA-RULES.md
    2. State which section applies to your change
    3. Only then proceed with edits
    Edits without stating the applicable rule are FORBIDDEN.

  x-event-subscriptions: []  # Save-Load service doesn't subscribe to external events
  x-event-publications:
    # SaveSlot lifecycle events (auto-generated from x-lifecycle)
    - topic: save-slot.created
      event: SaveSlotCreatedEvent
      description: Published when a new save slot is created
    - topic: save-slot.updated
      event: SaveSlotUpdatedEvent
      description: Published when a save slot is updated
    - topic: save-slot.deleted
      event: SaveSlotDeletedEvent
      description: Published when a save slot is deleted
    # Custom save events
    - topic: save.created
      event: SaveCreatedEvent
      description: Published when a new save version is created
    - topic: save.loaded
      event: SaveLoadedEvent
      description: Published when a save is loaded
    - topic: save.migrated
      event: SaveMigratedEvent
      description: Published when a save is migrated to a new schema version
    - topic: save.version-pinned
      event: VersionPinnedEvent
      description: Published when a version is pinned as checkpoint
    - topic: save.version-unpinned
      event: VersionUnpinnedEvent
      description: Published when a version is unpinned
    - topic: save.version-deleted
      event: VersionDeletedEvent
      description: Published when a version is deleted
    - topic: save.cleanup-completed
      event: CleanupCompletedEvent
      description: Published when automatic cleanup completes
    # Async upload events
    - topic: save.queued
      event: SaveQueuedEvent
      description: Published when a save is queued for async upload
    - topic: save.upload-completed
      event: SaveUploadCompletedEvent
      description: Published when async upload to MinIO completes
    - topic: save.upload-failed
      event: SaveUploadFailedEvent
      description: Published when async upload fails
    - topic: save.circuit-breaker-changed
      event: CircuitBreakerStateChangedEvent
      description: Published when storage circuit breaker changes state

paths: {}  # Events don't have HTTP paths

# Lifecycle events auto-generated from this definition
# Output: schemas/Generated/save-load-lifecycle-events.yaml
x-lifecycle:
  SaveSlot:
    model:
      slotId: { type: string, format: uuid, primary: true, required: true, description: "Unique slot identifier" }
      gameId: { type: string, required: true, description: "Game identifier for namespace isolation" }
      ownerId: { type: string, format: uuid, required: true, description: "ID of the owning entity" }
      ownerType: { $ref: 'save-load-api.yaml#/components/schemas/OwnerType', required: true, description: "Type of entity that owns this save slot" }
      slotName: { type: string, required: true, description: "Slot name" }
      category: { $ref: 'save-load-api.yaml#/components/schemas/SaveCategory', required: true, description: "Save category determining retention and cleanup behavior" }
      maxVersions: { type: integer, required: true, description: "Maximum versions to retain" }
      retentionDays: { type: integer, nullable: true, description: "Days to retain versions (null = indefinite)" }
      compressionType: { $ref: 'save-load-api.yaml#/components/schemas/CompressionType', required: true, description: "Compression algorithm used for save data" }
      versionCount: { type: integer, required: true, description: "Current number of versions in slot" }
      latestVersion: { type: integer, nullable: true, description: "Latest version number (null if empty)" }
      totalSizeBytes: { type: integer, format: int64, required: true, description: "Total storage used by all versions" }
      createdAt: { type: string, format: date-time, required: true, description: "Slot creation timestamp" }
      updatedAt: { type: string, format: date-time, required: true, description: "Last modification timestamp" }
    sensitive: []

components:
  schemas:
    # Custom events beyond lifecycle (SaveSlot lifecycle events auto-generated)

    SaveCreatedEvent:
      allOf:
        - $ref: 'common-events.yaml#/components/schemas/BaseServiceEvent'
      type: object
      additionalProperties: false
      description: Published when a new save version is created
      required:
        - eventName
        - eventId
        - timestamp
        - slotId
        - versionNumber
        - ownerId
        - ownerType
        - sizeBytes
      properties:
        eventName:
          type: string
          default: "save.created"
          description: Event type identifier
        slotId:
          type: string
          format: uuid
          description: Slot identifier
        slotName:
          type: string
          nullable: true
          description: Slot name
        versionNumber:
          type: integer
          description: New version number
        ownerId:
          type: string
          format: uuid
          description: Owner entity ID
        ownerType:
          $ref: 'save-load-api.yaml#/components/schemas/OwnerType'
          description: Owner entity type
        category:
          $ref: 'save-load-api.yaml#/components/schemas/SaveCategory'
          description: Save category
        sizeBytes:
          type: integer
          format: int64
          description: Save size in bytes
        schemaVersion:
          type: string
          nullable: true
          description: Schema version if specified
        pinned:
          type: boolean
          default: false
          description: Whether version is pinned
        checkpointName:
          type: string
          nullable: true
          description: Checkpoint name if pinned

    SaveLoadedEvent:
      allOf:
        - $ref: 'common-events.yaml#/components/schemas/BaseServiceEvent'
      type: object
      additionalProperties: false
      description: Published when a save is loaded
      required:
        - eventName
        - eventId
        - timestamp
        - slotId
        - versionNumber
        - ownerId
        - ownerType
      properties:
        eventName:
          type: string
          default: "save.loaded"
          description: Event type identifier
        slotId:
          type: string
          format: uuid
          description: Slot identifier
        slotName:
          type: string
          nullable: true
          description: Slot name
        versionNumber:
          type: integer
          description: Loaded version number
        ownerId:
          type: string
          format: uuid
          description: Owner entity ID
        ownerType:
          $ref: 'save-load-api.yaml#/components/schemas/OwnerType'
          description: Owner entity type

    SaveMigratedEvent:
      allOf:
        - $ref: 'common-events.yaml#/components/schemas/BaseServiceEvent'
      type: object
      additionalProperties: false
      description: Published when a save is migrated to a new schema version
      required:
        - eventName
        - eventId
        - timestamp
        - slotId
        - fromSchemaVersion
        - toSchemaVersion
      properties:
        eventName:
          type: string
          default: "save.migrated"
          description: Event type identifier
        slotId:
          type: string
          format: uuid
          description: Slot identifier
        slotName:
          type: string
          nullable: true
          description: Slot name
        originalVersionNumber:
          type: integer
          nullable: true
          description: Original version that was migrated
        newVersionNumber:
          type: integer
          nullable: true
          description: New version with migrated data
        fromSchemaVersion:
          type: string
          description: Original schema version
        toSchemaVersion:
          type: string
          description: Target schema version
        ownerId:
          type: string
          format: uuid
          nullable: true
          description: Owner entity ID
        ownerType:
          $ref: 'save-load-api.yaml#/components/schemas/OwnerType'
          description: Owner entity type

    VersionPinnedEvent:
      allOf:
        - $ref: 'common-events.yaml#/components/schemas/BaseServiceEvent'
      type: object
      additionalProperties: false
      description: Published when a version is pinned as checkpoint
      required:
        - eventName
        - eventId
        - timestamp
        - slotId
        - versionNumber
      properties:
        eventName:
          type: string
          default: "save.version-pinned"
          description: Event type identifier
        slotId:
          type: string
          format: uuid
          description: Slot identifier
        slotName:
          type: string
          nullable: true
          description: Slot name
        versionNumber:
          type: integer
          description: Pinned version number
        checkpointName:
          type: string
          nullable: true
          description: Checkpoint name if assigned
        ownerId:
          type: string
          format: uuid
          nullable: true
          description: Owner entity ID
        ownerType:
          $ref: 'save-load-api.yaml#/components/schemas/OwnerType'
          description: Owner entity type

    VersionUnpinnedEvent:
      allOf:
        - $ref: 'common-events.yaml#/components/schemas/BaseServiceEvent'
      type: object
      additionalProperties: false
      description: Published when a version is unpinned
      required:
        - eventName
        - eventId
        - timestamp
        - slotId
        - versionNumber
      properties:
        eventName:
          type: string
          default: "save.version-unpinned"
          description: Event type identifier
        slotId:
          type: string
          format: uuid
          description: Slot identifier
        slotName:
          type: string
          nullable: true
          description: Slot name
        versionNumber:
          type: integer
          description: Unpinned version number
        previousCheckpointName:
          type: string
          nullable: true
          description: Previous checkpoint name before unpinning
        ownerId:
          type: string
          format: uuid
          nullable: true
          description: Owner entity ID
        ownerType:
          $ref: 'save-load-api.yaml#/components/schemas/OwnerType'
          description: Owner entity type

    VersionDeletedEvent:
      allOf:
        - $ref: 'common-events.yaml#/components/schemas/BaseServiceEvent'
      type: object
      additionalProperties: false
      description: Published when a version is deleted
      required:
        - eventName
        - eventId
        - timestamp
        - slotId
        - versionNumber
        - bytesFreed
      properties:
        eventName:
          type: string
          default: "save.version-deleted"
          description: Event type identifier
        slotId:
          type: string
          format: uuid
          description: Slot identifier
        slotName:
          type: string
          nullable: true
          description: Slot name
        versionNumber:
          type: integer
          description: Deleted version number
        bytesFreed:
          type: integer
          format: int64
          description: Storage freed in bytes
        ownerId:
          type: string
          format: uuid
          nullable: true
          description: Owner entity ID
        ownerType:
          $ref: 'save-load-api.yaml#/components/schemas/OwnerType'
          description: Owner entity type

    CleanupCompletedEvent:
      allOf:
        - $ref: 'common-events.yaml#/components/schemas/BaseServiceEvent'
      type: object
      additionalProperties: false
      description: Published when automatic cleanup completes
      required:
        - eventName
        - eventId
        - timestamp
        - versionsDeleted
        - bytesFreed
      properties:
        eventName:
          type: string
          default: "save.cleanup-completed"
          description: Event type identifier
        versionsDeleted:
          type: integer
          description: Number of versions cleaned up
        slotsDeleted:
          type: integer
          nullable: true
          description: Number of empty slots removed
        bytesFreed:
          type: integer
          format: int64
          description: Storage freed in bytes
        durationMs:
          type: integer
          nullable: true
          description: Cleanup duration in milliseconds

    # ═══════════════════════════════════════════════════════════════════════════
    # ASYNC UPLOAD EVENTS
    # ═══════════════════════════════════════════════════════════════════════════

    SaveQueuedEvent:
      allOf:
        - $ref: 'common-events.yaml#/components/schemas/BaseServiceEvent'
      type: object
      additionalProperties: false
      description: |
        Published when a save is queued for async upload.
        The save data is in Redis and immediately loadable, but not yet in MinIO.
      required:
        - eventName
        - eventId
        - timestamp
        - slotId
        - versionNumber
        - ownerId
        - ownerType
      properties:
        eventName:
          type: string
          default: "save.queued"
          description: Event type identifier
        slotId:
          type: string
          format: uuid
          description: Save slot identifier
        slotName:
          type: string
          nullable: true
          description: Human-readable slot name
        versionNumber:
          type: integer
          description: Version number that was queued
        ownerId:
          type: string
          format: uuid
          description: Owner entity ID
        ownerType:
          $ref: 'save-load-api.yaml#/components/schemas/OwnerType'
          description: Type of entity that owns this save
        sizeBytes:
          type: integer
          format: int64
          nullable: true
          description: Size of the queued save data in bytes
        queueDepth:
          type: integer
          nullable: true
          description: Current number of pending uploads in queue

    SaveUploadCompletedEvent:
      allOf:
        - $ref: 'common-events.yaml#/components/schemas/BaseServiceEvent'
      type: object
      additionalProperties: false
      description: Published when async upload to MinIO completes successfully
      required:
        - eventName
        - eventId
        - timestamp
        - slotId
        - versionNumber
        - assetId
      properties:
        eventName:
          type: string
          default: "save.upload-completed"
          description: Event type identifier
        slotId:
          type: string
          format: uuid
          description: Save slot identifier
        slotName:
          type: string
          nullable: true
          description: Human-readable slot name
        versionNumber:
          type: integer
          description: Version number that was uploaded
        assetId:
          type: string
          format: uuid
          description: Asset ID in MinIO
        uploadDurationMs:
          type: integer
          nullable: true
          description: Time from queue to upload completion
        queueWaitMs:
          type: integer
          nullable: true
          description: Time spent waiting in queue

    SaveUploadFailedEvent:
      allOf:
        - $ref: 'common-events.yaml#/components/schemas/BaseServiceEvent'
      type: object
      additionalProperties: false
      description: |
        Published when async upload fails after all retry attempts.
        The save data may still be in Redis hot cache but will expire.
      required:
        - eventName
        - eventId
        - timestamp
        - slotId
        - versionNumber
        - errorMessage
        - retryCount
      properties:
        eventName:
          type: string
          default: "save.upload-failed"
          description: Event type identifier
        slotId:
          type: string
          format: uuid
          description: Save slot identifier
        slotName:
          type: string
          nullable: true
          description: Human-readable slot name
        versionNumber:
          type: integer
          description: Version number that failed to upload
        ownerId:
          type: string
          format: uuid
          nullable: true
          description: Owner entity ID
        ownerType:
          $ref: 'save-load-api.yaml#/components/schemas/OwnerType'
          description: Type of entity that owns this save
        errorMessage:
          type: string
          description: Last error message
        retryCount:
          type: integer
          description: Number of retry attempts made
        willRetry:
          type: boolean
          default: false
          description: Whether more retries will be attempted

    CircuitBreakerStateChangedEvent:
      allOf:
        - $ref: 'common-events.yaml#/components/schemas/BaseServiceEvent'
      type: object
      additionalProperties: false
      description: Published when storage circuit breaker changes state
      required:
        - eventName
        - eventId
        - timestamp
        - previousState
        - newState
      properties:
        eventName:
          type: string
          default: "save.circuit-breaker-changed"
          description: Event type identifier
        previousState:
          type: string
          enum: [CLOSED, OPEN, HALF_OPEN]
          description: Previous circuit breaker state before the transition
        newState:
          type: string
          enum: [CLOSED, OPEN, HALF_OPEN]
          description: New circuit breaker state after the transition
        failureCount:
          type: integer
          nullable: true
          description: Consecutive failures (when opening)
        successCount:
          type: integer
          nullable: true
          description: Successful probes (when closing from half-open)
        pendingUploads:
          type: integer
          nullable: true
          description: Current queue depth when state changed
