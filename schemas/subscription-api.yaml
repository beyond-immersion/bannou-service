openapi: 3.0.0
info:
  title: Bannou Subscription Service API
  description: |
    Manages user subscriptions to game services.
    Tracks which accounts have access to which services (games/applications) with time-limited subscriptions.

    **POST-Only API Pattern**: This API uses POST for all operations to support zero-copy
    WebSocket routing. Path parameters are passed in request bodies instead of URLs.
    See docs/BANNOU_DESIGN.md for architectural rationale.

    **SCHEMA MODIFICATION GATE**: STOP. Before modifying this schema, you MUST:
    1. Read docs/reference/SCHEMA-RULES.md
    2. State which section applies to your change
    3. Only then proceed with edits
    Edits without stating the applicable rule are FORBIDDEN.
  version: 1.0.0
x-service-layer: GameFoundation
servers:
- url: http://localhost:5012
  description: Bannou service endpoint (internal only)

paths:
  /subscription/account/list:
    post:
      summary: Get subscriptions for an account
      description: Returns all subscriptions for a given account, with optional filtering.
      operationId: getAccountSubscriptions
      tags:
      - Subscription Management
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetAccountSubscriptionsRequest'
      responses:
        '200':
          description: Subscriptions retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubscriptionListResponse'

  /subscription/query:
    post:
      summary: Query current (active, non-expired) subscriptions
      description: |
        Returns active, non-expired subscriptions. Can query by:
        - accountId: Get subscriptions for a specific account
        - stubName: Get all accounts subscribed to a specific service
        - Both: Check if a specific account is subscribed to a specific service
        At least one of accountId or stubName must be provided.
        Used by Auth service during session creation and GameSession service for subscriber discovery.
      operationId: queryCurrentSubscriptions
      tags:
      - Subscription Management
      x-permissions: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QueryCurrentSubscriptionsRequest'
      responses:
        '200':
          description: Subscriptions retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QuerySubscriptionsResponse'
        '400':
          description: Neither accountId nor stubName provided
  /subscription/get:
    post:
      summary: Get a specific subscription by ID
      operationId: getSubscription
      tags:
      - Subscription Management
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetSubscriptionRequest'
      responses:
        '200':
          description: Subscription retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubscriptionInfo'
        '404':
          description: Subscription not found

  /subscription/create:
    post:
      summary: Create a new subscription
      description: Admin-only endpoint to create a new subscription for an account.
      operationId: createSubscription
      tags:
      - Subscription Management
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateSubscriptionRequest'
      responses:
        '200':
          description: Subscription created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubscriptionInfo'
        '400':
          description: Invalid subscription data
        '404':
          description: Account or service not found
        '409':
          description: Subscription already exists for this account and service

  /subscription/update:
    post:
      summary: Update a subscription
      description: Admin-only endpoint to update an existing subscription.
      operationId: updateSubscription
      tags:
      - Subscription Management
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateSubscriptionRequest'
      responses:
        '200':
          description: Subscription updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubscriptionInfo'
        '404':
          description: Subscription not found

  /subscription/cancel:
    post:
      summary: Cancel a subscription
      description: |
        Cancels a subscription. Users can cancel their own subscriptions,
        admins can cancel any subscription.
      operationId: cancelSubscription
      tags:
      - Subscription Management
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CancelSubscriptionRequest'
      responses:
        '200':
          description: Subscription cancelled successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubscriptionInfo'
        '404':
          description: Subscription not found
        '403':
          description: Not authorized to cancel this subscription

  /subscription/renew:
    post:
      summary: Renew or extend a subscription
      description: Admin-only endpoint to renew or extend an existing subscription.
      operationId: renewSubscription
      tags:
      - Subscription Management
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RenewSubscriptionRequest'
      responses:
        '200':
          description: Subscription renewed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubscriptionInfo'
        '404':
          description: Subscription not found

components:
  schemas:
    # Request Models
    GetAccountSubscriptionsRequest:
      type: object
      additionalProperties: false
      description: Request to get subscriptions for an account
      required:
      - accountId
      properties:
        accountId:
          type: string
          format: uuid
          description: ID of the account to get subscriptions for
        includeInactive:
          type: boolean
          default: false
          description: If true, include cancelled subscriptions
        includeExpired:
          type: boolean
          default: false
          description: If true, include expired subscriptions

    QueryCurrentSubscriptionsRequest:
      type: object
      additionalProperties: false
      description: |
        Request to query current active subscriptions.
        Provide accountId to get subscriptions for a specific account,
        or stubName to get all accounts subscribed to a specific service,
        or both to check if a specific account is subscribed to a specific service.
        At least one of accountId or stubName must be provided.
      properties:
        accountId:
          type: string
          format: uuid
          nullable: true
          description: ID of the account to get current subscriptions for. Optional if stubName is provided.
        stubName:
          type: string
          nullable: true
          description: Stub name of the service to filter by (e.g., "my-game"). Returns all accounts subscribed to this
            service.

    GetSubscriptionRequest:
      type: object
      additionalProperties: false
      description: Request to get a specific subscription
      required:
      - subscriptionId
      properties:
        subscriptionId:
          type: string
          format: uuid
          description: ID of the subscription to retrieve

    CreateSubscriptionRequest:
      type: object
      additionalProperties: false
      description: Request to create a new subscription
      required:
      - accountId
      - serviceId
      properties:
        accountId:
          type: string
          format: uuid
          description: ID of the account to create subscription for
        serviceId:
          type: string
          format: uuid
          description: ID of the service (game) to subscribe to
        startDate:
          type: string
          format: date-time
          nullable: true
          description: When the subscription starts (defaults to now)
        expirationDate:
          type: string
          format: date-time
          nullable: true
          description: When the subscription expires (null for unlimited)
        durationDays:
          type: integer
          nullable: true
          description: Alternative to expirationDate - number of days from startDate

    UpdateSubscriptionRequest:
      type: object
      additionalProperties: false
      description: Request to update an existing subscription
      required:
      - subscriptionId
      properties:
        subscriptionId:
          type: string
          format: uuid
          description: ID of the subscription to update
        expirationDate:
          type: string
          format: date-time
          nullable: true
          description: New expiration date
        isActive:
          type: boolean
          nullable: true
          description: New active status

    CancelSubscriptionRequest:
      type: object
      additionalProperties: false
      description: Request to cancel a subscription
      required:
      - subscriptionId
      properties:
        subscriptionId:
          type: string
          format: uuid
          description: ID of the subscription to cancel
        reason:
          type: string
          nullable: true
          maxLength: 500
          description: Optional reason for cancellation

    RenewSubscriptionRequest:
      type: object
      additionalProperties: false
      description: Request to renew or extend a subscription
      required:
      - subscriptionId
      properties:
        subscriptionId:
          type: string
          format: uuid
          description: ID of the subscription to renew
        extensionDays:
          type: integer
          description: Number of days to extend the subscription
        newExpirationDate:
          type: string
          format: date-time
          nullable: true
          description: Alternative to extensionDays - set specific new expiration

    # Response Models
    SubscriptionInfo:
      type: object
      additionalProperties: false
      description: Information about a subscription
      required:
      - subscriptionId
      - accountId
      - serviceId
      - stubName
      - startDate
      - isActive
      - createdAt
      properties:
        subscriptionId:
          type: string
          format: uuid
          description: Unique identifier for the subscription
        accountId:
          type: string
          format: uuid
          description: ID of the account this subscription belongs to
        serviceId:
          type: string
          format: uuid
          description: ID of the subscribed service (game)
        stubName:
          type: string
          description: Stub name of the service (denormalized for efficiency)
        displayName:
          type: string
          description: Display name of the service (denormalized for efficiency)
        startDate:
          type: string
          format: date-time
          description: When the subscription started
        expirationDate:
          type: string
          format: date-time
          nullable: true
          description: When the subscription expires (null for unlimited)
        isActive:
          type: boolean
          description: Whether the subscription is currently active
        cancelledAt:
          type: string
          format: date-time
          nullable: true
          description: When the subscription was cancelled (if applicable)
        cancellationReason:
          type: string
          nullable: true
          description: Reason for cancellation (if applicable)
        createdAt:
          type: string
          format: date-time
          description: When the subscription was created
        updatedAt:
          type: string
          format: date-time
          nullable: true
          description: When the subscription was last updated

    # NOTE: CurrentSubscriptionsResponse removed - superseded by QuerySubscriptionsResponse

    QuerySubscriptionsResponse:
      type: object
      additionalProperties: false
      description: |
        Response from querying current subscriptions.
        Returns subscriptions matching the query criteria (by account, by stub, or both).
      required:
      - subscriptions
      - totalCount
      properties:
        subscriptions:
          type: array
          items:
            $ref: '#/components/schemas/SubscriptionInfo'
          description: List of active subscriptions matching the query
        totalCount:
          type: integer
          description: Total number of subscriptions returned
        accountIds:
          type: array
          items:
            type: string
            format: uuid
          description: Unique account IDs in the result set (useful when querying by stubName)

    SubscriptionListResponse:
      type: object
      additionalProperties: false
      description: Response containing list of subscriptions
      required:
      - subscriptions
      - totalCount
      properties:
        subscriptions:
          type: array
          items:
            $ref: '#/components/schemas/SubscriptionInfo'
          description: List of subscriptions matching the filter criteria
        totalCount:
          type: integer
          description: Total number of subscriptions matching the filter

