openapi: 3.0.0
info:
  title: Bannou Permission System API
  description: |
    Redis-backed high-performance permission system for WebSocket services.

    **POST-Only API Pattern**: This API uses POST for all operations to support zero-copy
    WebSocket routing. Path parameters are passed in request bodies instead of URLs.
    See docs/BANNOU_DESIGN.md for architectural rationale.
  version: 3.0.0
  # NOTE: Event subscriptions moved to permissions-events.yaml (x-event-subscriptions)
servers:
- url: http://localhost:5012
  description: Bannou service endpoint (internal only)

paths:
  /permissions/capabilities:
    post:
      summary: Get available API methods for session
      description: Returns compiled list of methods available to this session
      operationId: getCapabilities
      tags:
      - Permission Lookup
      x-permissions: []  # Internal only - not exposed to WebSocket clients
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CapabilityRequest'
      responses:
        '200':
          description: Session capabilities retrieved from Redis
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CapabilityResponse'

      x-request-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/CapabilityRequest\"\
        ,\n  \"$defs\": {\n    \"CapabilityRequest\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"sessionId\"\
        \n      ],\n      \"properties\": {\n        \"sessionId\": {\n          \"type\": \"string\",\n          \"description\"\
        : \"Session ID for lookup in Redis\"\n        },\n        \"serviceIds\": {\n          \"type\": \"array\",\n    \
        \      \"items\": {\n            \"type\": \"string\"\n          },\n          \"description\": \"Optional filter
        for specific services\"\n        }\n      }\n    }\n  }\n}"
      x-response-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/CapabilityResponse\"\
        ,\n  \"$defs\": {\n    \"CapabilityResponse\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"sessionId\"\
        ,\n        \"permissions\"\n      ],\n      \"properties\": {\n        \"sessionId\": {\n          \"type\": \"string\"\
        \n        },\n        \"permissions\": {\n          \"type\": \"object\",\n          \"additionalProperties\": {\n\
        \            \"type\": \"array\",\n            \"items\": {\n              \"type\": \"string\"\n            }\n \
        \         },\n          \"description\": \"Map of ServiceID -> List of available methods\"\n        },\n        \"\
        generatedAt\": {\n          \"type\": \"string\",\n          \"format\": \"date-time\",\n          \"description\"\
        : \"When these permissions were compiled\"\n        }\n      }\n    }\n  }\n}"
      x-endpoint-info-json: "{\n  \"summary\": \"Get available API methods for session\",\n  \"description\": \"Returns compiled
        list of methods available to this session\",\n  \"tags\": [\n    \"Permission Lookup\"\n  ],\n  \"deprecated\": false,\n\
        \  \"operationId\": \"getCapabilities\"\n}"
  /permissions/validate:
    post:
      summary: Validate specific API access for session
      description: Fast O(1) validation using Redis lookup
      operationId: validateApiAccess
      tags:
      - Permission Validation
      x-permissions: []  # Internal only - not exposed to WebSocket clients
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ValidationRequest'
      responses:
        '200':
          description: Permission validation result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationResponse'

      x-request-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/ValidationRequest\"\
        ,\n  \"$defs\": {\n    \"ValidationRequest\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"sessionId\"\
        ,\n        \"serviceId\",\n        \"method\"\n      ],\n      \"properties\": {\n        \"sessionId\": {\n     \
        \     \"type\": \"string\"\n        },\n        \"serviceId\": {\n          \"type\": \"string\",\n          \"description\"\
        : \"Target service ID\"\n        },\n        \"method\": {\n          \"type\": \"string\",\n          \"description\"\
        : \"Method name being accessed\"\n        }\n      }\n    }\n  }\n}"
      x-response-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/ValidationResponse\"\
        ,\n  \"$defs\": {\n    \"ValidationResponse\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"allowed\"\
        ,\n        \"sessionId\"\n      ],\n      \"properties\": {\n        \"allowed\": {\n          \"type\": \"boolean\"\
        ,\n          \"description\": \"Whether access is permitted\"\n        },\n        \"sessionId\": {\n          \"\
        type\": \"string\"\n        },\n        \"reason\": {\n          \"type\": \"string\",\n          \"description\"\
        : \"Reason for denial (if applicable)\"\n        }\n      }\n    }\n  }\n}"
      x-endpoint-info-json: "{\n  \"summary\": \"Validate specific API access for session\",\n  \"description\": \"Fast O(1)
        validation using Redis lookup\",\n  \"tags\": [\n    \"Permission Validation\"\n  ],\n  \"deprecated\": false,\n \
        \ \"operationId\": \"validateApiAccess\"\n}"
  /permissions/register-service:
    post:
      summary: Register or update service permission matrix
      description: Updates Redis with ServiceID -> State -> Role -> Methods structure
      operationId: registerServicePermissions
      tags:
      - Service Management
      x-permissions: []  # Internal only - not exposed to WebSocket clients
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ServicePermissionMatrix'
      responses:
        '200':
          description: Service permissions registered and sessions recompiled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RegistrationResponse'

      x-request-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/ServicePermissionMatrix\"\
        ,\n  \"$defs\": {\n    \"ServicePermissionMatrix\": {\n      \"type\": \"object\",\n      \"required\": [\n      \
        \  \"serviceId\",\n        \"permissions\"\n      ],\n      \"properties\": {\n        \"serviceId\": {\n        \
        \  \"type\": \"string\",\n          \"description\": \"Unique service identifier\"\n        },\n        \"serviceName\"\
        : {\n          \"type\": \"string\",\n          \"description\": \"Human-readable service name\"\n        },\n   \
        \     \"permissions\": {\n          \"type\": \"object\",\n          \"additionalProperties\": {\n            \"$ref\"\
        : \"#/$defs/StatePermissions\"\n          },\n          \"description\": \"Map of State -> Role -> Methods structure\"\
        \n        },\n        \"version\": {\n          \"type\": \"string\",\n          \"description\": \"Service API version
        for change tracking\"\n        }\n      }\n    },\n    \"StatePermissions\": {\n      \"type\": \"object\",\n    \
        \  \"additionalProperties\": {\n        \"type\": \"array\",\n        \"items\": {\n          \"type\": \"string\"\
        \n        }\n      },\n      \"description\": \"Map of Role -> List of Methods for this state\",\n      \"example\"\
        : {\n        \"user\": [\n          \"ListGameSessions\",\n          \"GetGameSession\"\n        ],\n        \"admin\"\
        : [\n          \"ListGameSessions\",\n          \"GetGameSession\",\n          \"CreateGameSession\"\n        ]\n\
        \      }\n    }\n  }\n}"
      x-response-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/RegistrationResponse\"\
        ,\n  \"$defs\": {\n    \"RegistrationResponse\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"\
        serviceId\",\n        \"success\",\n        \"affectedSessions\"\n      ],\n      \"properties\": {\n        \"serviceId\"\
        : {\n          \"type\": \"string\"\n        },\n        \"success\": {\n          \"type\": \"boolean\",\n      \
        \    \"description\": \"Whether registration was successful\"\n        },\n        \"message\": {\n          \"type\"\
        : \"string\",\n          \"description\": \"Success or error message\"\n        },\n        \"registered\": {\n  \
        \        \"type\": \"boolean\",\n          \"description\": \"Whether registration was successful\"\n        },\n\
        \        \"affectedSessions\": {\n          \"type\": \"integer\",\n          \"description\": \"Number of sessions
        that had permissions recompiled\"\n        },\n        \"recompiledAt\": {\n          \"type\": \"string\",\n    \
        \      \"format\": \"date-time\"\n        }\n      }\n    }\n  }\n}"
      x-endpoint-info-json: "{\n  \"summary\": \"Register or update service permission matrix\",\n  \"description\": \"Updates
        Redis with ServiceID -> State -> Role -> Methods structure\",\n  \"tags\": [\n    \"Service Management\"\n  ],\n \
        \ \"deprecated\": false,\n  \"operationId\": \"registerServicePermissions\"\n}"
  /permissions/update-session-state:
    post:
      summary: Update session state for specific service
      description: Updates SessionID -> ServiceID -> State and recompiles permissions
      operationId: updateSessionState
      tags:
      - Session Management
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SessionStateUpdate'
      responses:
        '200':
          description: Session state updated and permissions recompiled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionUpdateResponse'

      x-request-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/SessionStateUpdate\"\
        ,\n  \"$defs\": {\n    \"SessionStateUpdate\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"sessionId\"\
        ,\n        \"serviceId\",\n        \"newState\"\n      ],\n      \"properties\": {\n        \"sessionId\": {\n   \
        \       \"type\": \"string\"\n        },\n        \"serviceId\": {\n          \"type\": \"string\",\n          \"\
        description\": \"Service whose state is changing for this session\"\n        },\n        \"newState\": {\n       \
        \   \"type\": \"string\",\n          \"description\": \"New state value (lobby, in_game, etc.)\"\n        },\n   \
        \     \"previousState\": {\n          \"type\": \"string\",\n          \"description\": \"Previous state value (null
        for initial state)\",\n          \"nullable\": true\n        },\n        \"metadata\": {\n          \"type\": \"object\"\
        ,\n          \"additionalProperties\": true,\n          \"description\": \"Optional context data\"\n        }\n  \
        \    }\n    }\n  }\n}"
      x-response-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/SessionUpdateResponse\"\
        ,\n  \"$defs\": {\n    \"SessionUpdateResponse\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"\
        sessionId\",\n        \"success\",\n        \"permissionsChanged\"\n      ],\n      \"properties\": {\n        \"\
        sessionId\": {\n          \"type\": \"string\"\n        },\n        \"success\": {\n          \"type\": \"boolean\"\
        ,\n          \"description\": \"Whether update was successful\"\n        },\n        \"message\": {\n          \"\
        type\": \"string\",\n          \"description\": \"Success or error message\"\n        },\n        \"permissionsChanged\"\
        : {\n          \"type\": \"boolean\",\n          \"description\": \"Whether compiled permissions actually changed\"\
        \n        },\n        \"newPermissions\": {\n          \"type\": \"object\",\n          \"additionalProperties\":
        {\n            \"type\": \"array\",\n            \"items\": {\n              \"type\": \"string\"\n            }\n\
        \          },\n          \"description\": \"Updated ServiceID -> Methods if permissions changed\"\n        },\n  \
        \      \"updatedAt\": {\n          \"type\": \"string\",\n          \"format\": \"date-time\"\n        }\n      }\n\
        \    }\n  }\n}"
      x-endpoint-info-json: "{\n  \"summary\": \"Update session state for specific service\",\n  \"description\": \"Updates
        SessionID -> ServiceID -> State and recompiles permissions\",\n  \"tags\": [\n    \"Session Management\"\n  ],\n \
        \ \"deprecated\": false,\n  \"operationId\": \"updateSessionState\"\n}"
  /permissions/update-session-role:
    post:
      summary: Update session role (affects all services)
      description: Updates SessionID -> Role and recompiles all service permissions
      operationId: updateSessionRole
      tags:
      - Session Management
      x-permissions: []  # Internal only - not exposed to WebSocket clients
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SessionRoleUpdate'
      responses:
        '200':
          description: Session role updated and all permissions recompiled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionUpdateResponse'

      x-request-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/SessionRoleUpdate\"\
        ,\n  \"$defs\": {\n    \"SessionRoleUpdate\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"sessionId\"\
        ,\n        \"newRole\"\n      ],\n      \"properties\": {\n        \"sessionId\": {\n          \"type\": \"string\"\
        \n        },\n        \"newRole\": {\n          \"type\": \"string\",\n          \"description\": \"New role (user,
        admin, etc.)\"\n        },\n        \"previousRole\": {\n          \"type\": \"string\",\n          \"description\"\
        : \"Previous role (null for initial role)\",\n          \"nullable\": true\n        }\n      }\n    }\n  }\n}"
      x-response-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/SessionUpdateResponse\"\
        ,\n  \"$defs\": {\n    \"SessionUpdateResponse\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"\
        sessionId\",\n        \"success\",\n        \"permissionsChanged\"\n      ],\n      \"properties\": {\n        \"\
        sessionId\": {\n          \"type\": \"string\"\n        },\n        \"success\": {\n          \"type\": \"boolean\"\
        ,\n          \"description\": \"Whether update was successful\"\n        },\n        \"message\": {\n          \"\
        type\": \"string\",\n          \"description\": \"Success or error message\"\n        },\n        \"permissionsChanged\"\
        : {\n          \"type\": \"boolean\",\n          \"description\": \"Whether compiled permissions actually changed\"\
        \n        },\n        \"newPermissions\": {\n          \"type\": \"object\",\n          \"additionalProperties\":
        {\n            \"type\": \"array\",\n            \"items\": {\n              \"type\": \"string\"\n            }\n\
        \          },\n          \"description\": \"Updated ServiceID -> Methods if permissions changed\"\n        },\n  \
        \      \"updatedAt\": {\n          \"type\": \"string\",\n          \"format\": \"date-time\"\n        }\n      }\n\
        \    }\n  }\n}"
      x-endpoint-info-json: "{\n  \"summary\": \"Update session role (affects all services)\",\n  \"description\": \"Updates
        SessionID -> Role and recompiles all service permissions\",\n  \"tags\": [\n    \"Session Management\"\n  ],\n  \"\
        deprecated\": false,\n  \"operationId\": \"updateSessionRole\"\n}"
  /permissions/clear-session-state:
    post:
      summary: Clear session state for specific service
      description: |
        Removes state for a specific service from the session and recompiles permissions.
        If states list is provided, only clears if current state matches one of the values.
        If states list is empty or not provided, clears the state unconditionally.
      operationId: clearSessionState
      tags:
      - Session Management
      x-permissions: []  # Internal only - not exposed to WebSocket clients
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ClearSessionStateRequest'
      responses:
        '200':
          description: Session state cleared and permissions recompiled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionUpdateResponse'

      x-request-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/ClearSessionStateRequest\"\
        ,\n  \"$defs\": {\n    \"ClearSessionStateRequest\": {\n      \"type\": \"object\",\n      \"required\": [\n     \
        \   \"sessionId\",\n        \"serviceId\"\n      ],\n      \"properties\": {\n        \"sessionId\": {\n         \
        \ \"type\": \"string\",\n          \"description\": \"Session ID to clear state from\"\n        },\n        \"serviceId\"\
        : {\n          \"type\": \"string\",\n          \"description\": \"Service whose state should be cleared\"\n     \
        \   },\n        \"states\": {\n          \"type\": \"array\",\n          \"items\": {\n            \"type\": \"string\"\
        \n          },\n          \"description\": \"Optional list of state values to match. If provided, only clears if\\
        ncurrent state matches one of these values. If empty or not provided,\\nclears the state unconditionally.\\n\",\n\
        \          \"nullable\": true\n        }\n      }\n    }\n  }\n}"
      x-response-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/SessionUpdateResponse\"\
        ,\n  \"$defs\": {\n    \"SessionUpdateResponse\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"\
        sessionId\",\n        \"success\",\n        \"permissionsChanged\"\n      ],\n      \"properties\": {\n        \"\
        sessionId\": {\n          \"type\": \"string\"\n        },\n        \"success\": {\n          \"type\": \"boolean\"\
        ,\n          \"description\": \"Whether update was successful\"\n        },\n        \"message\": {\n          \"\
        type\": \"string\",\n          \"description\": \"Success or error message\"\n        },\n        \"permissionsChanged\"\
        : {\n          \"type\": \"boolean\",\n          \"description\": \"Whether compiled permissions actually changed\"\
        \n        },\n        \"newPermissions\": {\n          \"type\": \"object\",\n          \"additionalProperties\":
        {\n            \"type\": \"array\",\n            \"items\": {\n              \"type\": \"string\"\n            }\n\
        \          },\n          \"description\": \"Updated ServiceID -> Methods if permissions changed\"\n        },\n  \
        \      \"updatedAt\": {\n          \"type\": \"string\",\n          \"format\": \"date-time\"\n        }\n      }\n\
        \    }\n  }\n}"
      x-endpoint-info-json: "{\n  \"summary\": \"Clear session state for specific service\",\n  \"description\": \"Removes
        state for a specific service from the session and recompiles permissions.\\nIf states list is provided, only clears
        if current state matches one of the values.\\nIf states list is empty or not provided, clears the state unconditionally.\\\
        n\",\n  \"tags\": [\n    \"Session Management\"\n  ],\n  \"deprecated\": false,\n  \"operationId\": \"clearSessionState\"\
        \n}"
  /permissions/get-session-info:
    post:
      summary: Get complete session information
      description: Returns current states, role, and compiled permissions
      operationId: getSessionInfo
      tags:
      - Session Management
      x-permissions: []  # Internal only - not exposed to WebSocket clients
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SessionInfoRequest'
      responses:
        '200':
          description: Complete session information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionInfo'

      x-request-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/SessionInfoRequest\"\
        ,\n  \"$defs\": {\n    \"SessionInfoRequest\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"sessionId\"\
        \n      ],\n      \"properties\": {\n        \"sessionId\": {\n          \"type\": \"string\"\n        }\n      }\n\
        \    }\n  }\n}"
      x-response-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/SessionInfo\"\
        ,\n  \"$defs\": {\n    \"SessionInfo\": {\n      \"type\": \"object\",\n      \"required\": [\n        \"sessionId\"\
        ,\n        \"role\",\n        \"states\",\n        \"permissions\"\n      ],\n      \"properties\": {\n        \"\
        sessionId\": {\n          \"type\": \"string\"\n        },\n        \"role\": {\n          \"type\": \"string\",\n\
        \          \"description\": \"Current session role\"\n        },\n        \"states\": {\n          \"type\": \"object\"\
        ,\n          \"additionalProperties\": {\n            \"type\": \"string\"\n          },\n          \"description\"\
        : \"Map of ServiceID -> Current State\"\n        },\n        \"permissions\": {\n          \"type\": \"object\",\n\
        \          \"additionalProperties\": {\n            \"type\": \"array\",\n            \"items\": {\n             \
        \ \"type\": \"string\"\n            }\n          },\n          \"description\": \"Map of ServiceID -> List of available
        methods\"\n        },\n        \"compiledPermissions\": {\n          \"type\": \"object\",\n          \"additionalProperties\"\
        : {\n            \"type\": \"array\",\n            \"items\": {\n              \"type\": \"string\"\n            }\n\
        \          },\n          \"description\": \"Map of ServiceID -> List of available methods\"\n        },\n        \"\
        version\": {\n          \"type\": \"integer\",\n          \"description\": \"Permission version number\"\n       \
        \ },\n        \"lastUpdated\": {\n          \"type\": \"string\",\n          \"format\": \"date-time\",\n        \
        \  \"description\": \"When permissions were last recompiled\"\n        }\n      }\n    }\n  }\n}"
      x-endpoint-info-json: "{\n  \"summary\": \"Get complete session information\",\n  \"description\": \"Returns current
        states, role, and compiled permissions\",\n  \"tags\": [\n    \"Session Management\"\n  ],\n  \"deprecated\": false,\n\
        \  \"operationId\": \"getSessionInfo\"\n}"
  /permissions/services/list:
    post:
      summary: List all registered services
      description: |
        Returns list of all services that have registered their permissions.
        This endpoint is used by testers to wait for service readiness - a service
        appearing in this list means it has completed startup and registered its
        API permissions, indicating it's ready to handle requests.

        For service-to-service calls (via mesh), this endpoint is unrestricted.
        For client calls through WebSocket/Connect, only admin users can access it.
      operationId: getRegisteredServices
      tags:
      - Service Management
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ListServicesRequest'
      responses:
        '200':
          description: List of registered services
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RegisteredServicesResponse'

      x-request-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/ListServicesRequest\"\
        ,\n  \"$defs\": {\n    \"ListServicesRequest\": {\n      \"type\": \"object\",\n      \"description\": \"Request to
        list registered services (empty body allowed for listing all)\",\n      \"properties\": {\n        \"serviceIdFilter\"\
        : {\n          \"type\": \"string\",\n          \"description\": \"Optional filter by service ID prefix\",\n     \
        \     \"nullable\": true\n        }\n      }\n    }\n  }\n}"
      x-response-schema-json: "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$ref\": \"#/$defs/RegisteredServicesResponse\"\
        ,\n  \"$defs\": {\n    \"RegisteredServicesResponse\": {\n      \"type\": \"object\",\n      \"required\": [\n   \
        \     \"services\",\n        \"timestamp\"\n      ],\n      \"properties\": {\n        \"services\": {\n         \
        \ \"type\": \"array\",\n          \"items\": {\n            \"$ref\": \"#/$defs/RegisteredServiceInfo\"\n        \
        \  },\n          \"description\": \"List of all registered services\"\n        },\n        \"timestamp\": {\n    \
        \      \"type\": \"string\",\n          \"format\": \"date-time\",\n          \"description\": \"When this response
        was generated\"\n        }\n      }\n    },\n    \"RegisteredServiceInfo\": {\n      \"type\": \"object\",\n     \
        \ \"required\": [\n        \"serviceId\",\n        \"registeredAt\",\n        \"endpointCount\"\n      ],\n      \"\
        properties\": {\n        \"serviceId\": {\n          \"type\": \"string\",\n          \"description\": \"Unique service
        identifier\"\n        },\n        \"serviceName\": {\n          \"type\": \"string\",\n          \"description\":
        \"Human-readable service name\"\n        },\n        \"version\": {\n          \"type\": \"string\",\n          \"\
        description\": \"Service API version\"\n        },\n        \"registeredAt\": {\n          \"type\": \"string\",\n\
        \          \"format\": \"date-time\",\n          \"description\": \"When the service registered its permissions\"\n\
        \        },\n        \"endpointCount\": {\n          \"type\": \"integer\",\n          \"description\": \"Number of
        API endpoints registered by this service\"\n        }\n      }\n    }\n  }\n}"
      x-endpoint-info-json: "{\n  \"summary\": \"List all registered services\",\n  \"description\": \"Returns list of all
        services that have registered their permissions.\\nThis endpoint is used by testers to wait for service readiness
        - a service\\nappearing in this list means it has completed startup and registered its\\nAPI permissions, indicating
        it's ready to handle requests.\\n\\nFor service-to-service calls (via mesh), this endpoint is unrestricted.\\nFor
        client calls through WebSocket/Connect, only admin users can access it.\\n\",\n  \"tags\": [\n    \"Service Management\"\
        \n  ],\n  \"deprecated\": false,\n  \"operationId\": \"getRegisteredServices\"\n}"
components:
  schemas:
    # Request Models for POST-only pattern
    ListServicesRequest:
      type: object
      description: Request to list registered services (empty body allowed for listing all)
      properties:
        serviceIdFilter:
          type: string
          description: Optional filter by service ID prefix
          nullable: true

    # Core API Request/Response Models
    CapabilityRequest:
      type: object
      required:
      - sessionId
      properties:
        sessionId:
          type: string
          format: uuid
          description: Session ID for lookup in Redis
        serviceIds:
          type: array
          items:
            type: string
          description: Optional filter for specific services

    CapabilityResponse:
      type: object
      required:
      - sessionId
      - permissions
      properties:
        sessionId:
          type: string
          format: uuid
        permissions:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          description: Map of ServiceID -> List of available methods
        generatedAt:
          type: string
          format: date-time
          description: When these permissions were compiled

    ValidationRequest:
      type: object
      required:
      - sessionId
      - serviceId
      - method
      properties:
        sessionId:
          type: string
          format: uuid
        serviceId:
          type: string
          description: Target service ID
        method:
          type: string
          description: Method name being accessed

    ValidationResponse:
      type: object
      required:
      - allowed
      - sessionId
      properties:
        allowed:
          type: boolean
          description: Whether access is permitted
        sessionId:
          type: string
          format: uuid
        reason:
          type: string
          description: Reason for denial (if applicable)

    # Service Management Models
    ServicePermissionMatrix:
      type: object
      required:
      - serviceId
      - permissions
      properties:
        serviceId:
          type: string
          description: Unique service identifier
        serviceName:
          type: string
          description: Human-readable service name
        permissions:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/StatePermissions'
          description: Map of State -> Role -> Methods structure
        version:
          type: string
          description: Service API version for change tracking

    StatePermissions:
      type: object
      additionalProperties:
        type: array
        items:
          type: string
      description: Map of Role -> List of Methods for this state
      example:
        user: ["ListGameSessions", "GetGameSession"]
        admin: ["ListGameSessions", "GetGameSession", "CreateGameSession"]

    RegistrationResponse:
      type: object
      required:
      - serviceId
      - success
      - affectedSessions
      properties:
        serviceId:
          type: string
        success:
          type: boolean
          description: Whether registration was successful
        message:
          type: string
          description: Success or error message
        registered:
          type: boolean
          description: Whether registration was successful
        affectedSessions:
          type: integer
          description: Number of sessions that had permissions recompiled
        recompiledAt:
          type: string
          format: date-time

    # Session Management Models
    SessionStateUpdate:
      type: object
      required:
      - sessionId
      - serviceId
      - newState
      properties:
        sessionId:
          type: string
          format: uuid
        serviceId:
          type: string
          description: Service whose state is changing for this session
        newState:
          type: string
          description: New state value (lobby, in_game, etc.)
        previousState:
          type: string
          description: Previous state value (null for initial state)
          nullable: true
        metadata:
          type: object
          additionalProperties: true
          description: Optional context data

    SessionRoleUpdate:
      type: object
      required:
      - sessionId
      - newRole
      properties:
        sessionId:
          type: string
          format: uuid
        newRole:
          type: string
          description: New role (user, admin, etc.)
        previousRole:
          type: string
          description: Previous role (null for initial role)
          nullable: true

    ClearSessionStateRequest:
      type: object
      required:
      - sessionId
      - serviceId
      properties:
        sessionId:
          type: string
          format: uuid
          description: Session ID to clear state from
        serviceId:
          type: string
          description: Service whose state should be cleared
        states:
          type: array
          items:
            type: string
          description: |
            Optional list of state values to match. If provided, only clears if
            current state matches one of these values. If empty or not provided,
            clears the state unconditionally.
          nullable: true

    SessionUpdateResponse:
      type: object
      required:
      - sessionId
      - success
      - permissionsChanged
      properties:
        sessionId:
          type: string
          format: uuid
        success:
          type: boolean
          description: Whether update was successful
        message:
          type: string
          description: Success or error message
        permissionsChanged:
          type: boolean
          description: Whether compiled permissions actually changed
        newPermissions:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          description: Updated ServiceID -> Methods if permissions changed
        updatedAt:
          type: string
          format: date-time

    # Session Information Models
    SessionInfoRequest:
      type: object
      required:
      - sessionId
      properties:
        sessionId:
          type: string
          format: uuid

    SessionInfo:
      type: object
      required:
      - sessionId
      - role
      - states
      - permissions
      properties:
        sessionId:
          type: string
          format: uuid
        role:
          type: string
          description: Current session role
        states:
          type: object
          additionalProperties:
            type: string
          description: Map of ServiceID -> Current State
        permissions:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          description: Map of ServiceID -> List of available methods
        compiledPermissions:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          description: Map of ServiceID -> List of available methods
        version:
          type: integer
          description: Permission version number
        lastUpdated:
          type: string
          format: date-time
          description: When permissions were last recompiled

    # Service Readiness Models
    RegisteredServicesResponse:
      type: object
      required:
      - services
      - timestamp
      properties:
        services:
          type: array
          items:
            $ref: '#/components/schemas/RegisteredServiceInfo'
          description: List of all registered services
        timestamp:
          type: string
          format: date-time
          description: When this response was generated

    RegisteredServiceInfo:
      type: object
      required:
      - serviceId
      - registeredAt
      - endpointCount
      properties:
        serviceId:
          type: string
          description: Unique service identifier
        serviceName:
          type: string
          description: Human-readable service name
        version:
          type: string
          description: Service API version
        registeredAt:
          type: string
          format: date-time
          description: When the service registered its permissions
        endpointCount:
          type: integer
          description: Number of API endpoints registered by this service

# NOTE: Event subscriptions are defined in permissions-events.yaml
# They are processed by generate-event-subscriptions.sh to generate PermissionsEventsController.cs
