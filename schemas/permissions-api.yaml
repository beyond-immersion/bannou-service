openapi: 3.0.0
info:
  title: Bannou Permission System API
  description: |
    Redis-backed high-performance permission system for WebSocket services.

    **POST-Only API Pattern**: This API uses POST for all operations to support zero-copy
    WebSocket routing. Path parameters are passed in request bodies instead of URLs.
    See API-DESIGN.md for architectural rationale.
  version: 3.0.0
servers:
  - url: http://localhost:3500/v1.0/invoke/bannou/method
    description: Dapr sidecar endpoint (internal only)

paths:
  /permissions/capabilities:
    post:
      summary: Get available API methods for session
      description: Returns compiled list of methods available to this session
      operationId: getCapabilities
      tags:
        - Permission Lookup
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CapabilityRequest'
      responses:
        '200':
          description: Session capabilities retrieved from Redis
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CapabilityResponse'

  /permissions/validate:
    post:
      summary: Validate specific API access for session
      description: Fast O(1) validation using Redis lookup
      operationId: validateApiAccess
      tags:
        - Permission Validation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ValidationRequest'
      responses:
        '200':
          description: Permission validation result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationResponse'

  /permissions/register-service:
    post:
      summary: Register or update service permission matrix
      description: Updates Redis with ServiceID -> State -> Role -> Methods structure
      operationId: registerServicePermissions
      tags:
        - Service Management
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ServicePermissionMatrix'
      responses:
        '200':
          description: Service permissions registered and sessions recompiled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RegistrationResponse'

  /permissions/update-session-state:
    post:
      summary: Update session state for specific service
      description: Updates SessionID -> ServiceID -> State and recompiles permissions
      operationId: updateSessionState
      tags:
        - Session Management
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SessionStateUpdate'
      responses:
        '200':
          description: Session state updated and permissions recompiled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionUpdateResponse'

  /permissions/update-session-role:
    post:
      summary: Update session role (affects all services)
      description: Updates SessionID -> Role and recompiles all service permissions
      operationId: updateSessionRole
      tags:
        - Session Management
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SessionRoleUpdate'
      responses:
        '200':
          description: Session role updated and all permissions recompiled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionUpdateResponse'

  /permissions/clear-session-state:
    post:
      summary: Clear session state for specific service
      description: |
        Removes state for a specific service from the session and recompiles permissions.
        If states list is provided, only clears if current state matches one of the values.
        If states list is empty or not provided, clears the state unconditionally.
      operationId: clearSessionState
      tags:
        - Session Management
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ClearSessionStateRequest'
      responses:
        '200':
          description: Session state cleared and permissions recompiled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionUpdateResponse'

  /permissions/get-session-info:
    post:
      summary: Get complete session information
      description: Returns current states, role, and compiled permissions
      operationId: getSessionInfo
      tags:
        - Session Management
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SessionInfoRequest'
      responses:
        '200':
          description: Complete session information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionInfo'

  /permissions/services/list:
    post:
      summary: List all registered services
      description: |
        Returns list of all services that have registered their permissions.
        This endpoint is used by testers to wait for service readiness - a service
        appearing in this list means it has completed startup and registered its
        API permissions, indicating it's ready to handle requests.

        For service-to-service calls (via Dapr), this endpoint is unrestricted.
        For client calls through WebSocket/Connect, only admin users can access it.
      operationId: getRegisteredServices
      tags:
        - Service Management
      x-permissions:
        - role: admin
          requiredStates: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ListServicesRequest'
      responses:
        '200':
          description: List of registered services
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RegisteredServicesResponse'

components:
  schemas:
    # Request Models for POST-only pattern
    ListServicesRequest:
      type: object
      description: Request to list registered services (empty body allowed for listing all)
      properties:
        serviceIdFilter:
          type: string
          description: Optional filter by service ID prefix
          nullable: true

    # Core API Request/Response Models
    CapabilityRequest:
      type: object
      required:
        - sessionId
      properties:
        sessionId:
          type: string
          description: Session ID for lookup in Redis
        serviceIds:
          type: array
          items:
            type: string
          description: Optional filter for specific services

    CapabilityResponse:
      type: object
      required:
        - sessionId
        - permissions
      properties:
        sessionId:
          type: string
        permissions:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          description: Map of ServiceID -> List of available methods
        generatedAt:
          type: string
          format: date-time
          description: When these permissions were compiled

    ValidationRequest:
      type: object
      required:
        - sessionId
        - serviceId
        - method
      properties:
        sessionId:
          type: string
        serviceId:
          type: string
          description: Target service ID
        method:
          type: string
          description: Method name being accessed

    ValidationResponse:
      type: object
      required:
        - allowed
        - sessionId
      properties:
        allowed:
          type: boolean
          description: Whether access is permitted
        sessionId:
          type: string
        reason:
          type: string
          description: Reason for denial (if applicable)

    # Service Management Models
    ServicePermissionMatrix:
      type: object
      required:
        - serviceId
        - permissions
      properties:
        serviceId:
          type: string
          description: Unique service identifier
        serviceName:
          type: string
          description: Human-readable service name
        permissions:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/StatePermissions'
          description: Map of State -> Role -> Methods structure
        version:
          type: string
          description: Service API version for change tracking

    StatePermissions:
      type: object
      additionalProperties:
        type: array
        items:
          type: string
      description: Map of Role -> List of Methods for this state
      example:
        user: ["ListGameSessions", "GetGameSession"]
        admin: ["ListGameSessions", "GetGameSession", "CreateGameSession"]

    RegistrationResponse:
      type: object
      required:
        - serviceId
        - success
        - affectedSessions
      properties:
        serviceId:
          type: string
        success:
          type: boolean
          description: Whether registration was successful
        message:
          type: string
          description: Success or error message
        registered:
          type: boolean
          description: Whether registration was successful
        affectedSessions:
          type: integer
          description: Number of sessions that had permissions recompiled
        recompiledAt:
          type: string
          format: date-time

    # Session Management Models
    SessionStateUpdate:
      type: object
      required:
        - sessionId
        - serviceId
        - newState
      properties:
        sessionId:
          type: string
        serviceId:
          type: string
          description: Service whose state is changing for this session
        newState:
          type: string
          description: New state value (lobby, in_game, etc.)
        previousState:
          type: string
          description: Previous state value (null for initial state)
          nullable: true
        metadata:
          type: object
          additionalProperties: true
          description: Optional context data

    SessionRoleUpdate:
      type: object
      required:
        - sessionId
        - newRole
      properties:
        sessionId:
          type: string
        newRole:
          type: string
          description: New role (user, admin, etc.)
        previousRole:
          type: string
          description: Previous role (null for initial role)
          nullable: true

    ClearSessionStateRequest:
      type: object
      required:
        - sessionId
        - serviceId
      properties:
        sessionId:
          type: string
          description: Session ID to clear state from
        serviceId:
          type: string
          description: Service whose state should be cleared
        states:
          type: array
          items:
            type: string
          description: |
            Optional list of state values to match. If provided, only clears if
            current state matches one of these values. If empty or not provided,
            clears the state unconditionally.
          nullable: true

    SessionUpdateResponse:
      type: object
      required:
        - sessionId
        - success
        - permissionsChanged
      properties:
        sessionId:
          type: string
        success:
          type: boolean
          description: Whether update was successful
        message:
          type: string
          description: Success or error message
        permissionsChanged:
          type: boolean
          description: Whether compiled permissions actually changed
        newPermissions:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          description: Updated ServiceID -> Methods if permissions changed
        updatedAt:
          type: string
          format: date-time

    # Session Information Models
    SessionInfoRequest:
      type: object
      required:
        - sessionId
      properties:
        sessionId:
          type: string

    SessionInfo:
      type: object
      required:
        - sessionId
        - role
        - states
        - permissions
      properties:
        sessionId:
          type: string
        role:
          type: string
          description: Current session role
        states:
          type: object
          additionalProperties:
            type: string
          description: Map of ServiceID -> Current State
        permissions:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          description: Map of ServiceID -> List of available methods
        compiledPermissions:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          description: Map of ServiceID -> List of available methods
        version:
          type: integer
          description: Permission version number
        lastUpdated:
          type: string
          format: date-time
          description: When permissions were last recompiled

    # Service Readiness Models
    RegisteredServicesResponse:
      type: object
      required:
        - services
        - timestamp
      properties:
        services:
          type: array
          items:
            $ref: '#/components/schemas/RegisteredServiceInfo'
          description: List of all registered services
        timestamp:
          type: string
          format: date-time
          description: When this response was generated

    RegisteredServiceInfo:
      type: object
      required:
        - serviceId
        - registeredAt
        - endpointCount
      properties:
        serviceId:
          type: string
          description: Unique service identifier
        serviceName:
          type: string
          description: Human-readable service name
        version:
          type: string
          description: Service API version
        registeredAt:
          type: string
          format: date-time
          description: When the service registered its permissions
        endpointCount:
          type: integer
          description: Number of API endpoints registered by this service

# Event subscriptions - topics this service listens to
x-event-subscriptions:
  - topic: session.updated
    pubsub: bannou-pubsub
    path: handle-session-updated
    description: Handle session updates from Auth service to update role and authorization states.
    schema:
      $ref: 'auth-api.yaml#/components/schemas/SessionUpdatedEvent'
