openapi: 3.0.3
info:
  title: Behavior Service Events
  description: |
    Event models for Behavior service RabbitMQ pub/sub via MassTransit.
    Lifecycle events are auto-generated from x-lifecycle definition.

    These events enable other services to be notified when:
    - New behaviors are compiled and stored (BehaviorCreatedEvent)
    - Existing behaviors are recompiled/updated (BehaviorUpdatedEvent)
    - Behaviors are deleted/invalidated (BehaviorDeletedEvent)

    **SCHEMA MODIFICATION GATE**: STOP. Before modifying this schema, you MUST:
    1. Read docs/reference/SCHEMA-RULES.md
    2. State which section applies to your change
    3. Only then proceed with edits
    Edits without stating the applicable rule are FORBIDDEN.
  version: 1.0.0
  x-event-subscriptions: []  # Behavior service doesn't subscribe to external events
  x-event-publications:
    # Behavior lifecycle events (auto-generated from x-lifecycle)
    - topic: behavior.created
      event: BehaviorCreatedEvent
      description: Published when a new behavior is compiled and stored
    - topic: behavior.updated
      event: BehaviorUpdatedEvent
      description: Published when a behavior is recompiled/updated
    - topic: behavior.deleted
      event: BehaviorDeletedEvent
      description: Published when a behavior is deleted/invalidated
    # Cinematic streaming events
    - topic: character.cinematic_extension
      event: CinematicExtensionAvailableEvent
      description: Published when a cinematic extension is available for injection at a continuation point
    # Compilation failure events
    - topic: behavior.compilation-failed
      event: BehaviorCompilationFailedEvent
      description: Published when ABML compilation fails (for monitoring/alerting)
    # GOAP planning events
    - topic: behavior.goap.plan-generated
      event: GoapPlanGeneratedEvent
      description: Published when GOAP planner generates a new plan

# Lifecycle events auto-generated from this definition
# Output: schemas/Generated/behavior-lifecycle-events.yaml
x-lifecycle:
  Behavior:
    model:
      behaviorId: { type: string, primary: true, required: true, description: "Unique identifier for the behavior" }
      name: { type: string, required: true, description: "Human-readable name of the behavior" }
      category: { type: string, required: true, description: "Category classification for the behavior" }
      bundleId: { type: string, nullable: true, description: "Identifier of the bundle this behavior belongs to. Null if not bundled." }
      assetId: { type: string, required: true, description: "Identifier of the asset associated with this behavior" }
      bytecodeSize: { type: integer, format: int32, nullable: true, description: "Size of the compiled bytecode in bytes" }  # NRT: Optional property MUST be nullable
      schemaVersion: { type: string, nullable: true, description: "Version of the schema used for this behavior" }  # NRT: Optional property MUST be nullable
      createdAt: { type: string, format: date-time, required: true, description: "Timestamp when the behavior was created" }
      updatedAt: { type: string, format: date-time, nullable: true, description: "Timestamp when the behavior was last updated" }  # NRT: Optional property MUST be nullable
    sensitive: []  # No sensitive fields

  BehaviorBundle:
    model:
      bundleId: { type: string, primary: true, required: true, description: "Unique identifier for the behavior bundle" }
      name: { type: string, required: true, description: "Human-readable name of the bundle" }
      behaviorCount: { type: integer, format: int32, required: true, description: "Number of behaviors in the bundle" }
      totalBytecodeSize: { type: integer, format: int64, nullable: true, description: "Total size of all compiled bytecode in bytes" }
      createdAt: { type: string, format: date-time, required: true, description: "Timestamp when the bundle was created" }
      updatedAt: { type: string, format: date-time, nullable: true, description: "Timestamp when the bundle was last updated" }
    events:
      - created
      - updated
      - deleted
    sensitive: []

paths: {}  # Events don't have HTTP paths

# NOTE: Lifecycle events (BehaviorCreatedEvent, BehaviorUpdatedEvent, BehaviorDeletedEvent)
# are auto-generated to schemas/Generated/behavior-lifecycle-events.yaml
# Custom events are defined below in components/schemas.

components:
  schemas:
    CinematicExtensionAvailableEvent:
      type: object
      description: Event published when a cinematic extension is available for injection at a continuation point.
      required:
        - eventId
        - timestamp
        - characterId
        - cinematicId
        - continuationPointName
        - extensionBytecode
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique identifier for this event instance.
        timestamp:
          type: string
          format: date-time
          description: When the event was generated.
        characterId:
          type: string
          format: uuid
          description: The character whose cinematic is being extended.
        cinematicId:
          type: string
          format: uuid
          description: The cinematic behavior model being extended.
        continuationPointName:
          type: string
          description: The name of the continuation point where the extension should be injected.
        extensionBytecode:
          type: string
          format: byte
          description: Base64-encoded compiled ABML bytecode for the extension.
        sourceAppId:
          type: string
          nullable: true
          description: App ID that generated this extension, for direct mesh routing. Null for pub/sub delivery.
        expiresAtEpochMs:
          type: integer
          format: int64
          nullable: true
          description: Epoch milliseconds when this extension expires. Null if no expiration.

    BehaviorCompilationFailedEvent:
      type: object
      description: Event published when ABML compilation fails. Used for monitoring and alerting.
      required:
        - eventId
        - timestamp
        - errorCount
        - errors
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique identifier for this event instance.
        timestamp:
          type: string
          format: date-time
          description: When the event was generated.
        behaviorName:
          type: string
          nullable: true
          description: Name of the behavior being compiled (if provided).
        errorCount:
          type: integer
          format: int32
          description: Number of compilation errors.
        errors:
          type: array
          items:
            type: string
          description: List of compilation error messages.
        contentHash:
          type: string
          nullable: true
          description: Hash of the ABML content for deduplication.

    GoapPlanGeneratedEvent:
      type: object
      description: Event published when the GOAP planner generates a new plan. Useful for debugging and analytics.
      required:
        - eventId
        - timestamp
        - goalId
        - planStepCount
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique identifier for this event instance.
        timestamp:
          type: string
          format: date-time
          description: When the event was generated.
        actorId:
          type: string
          nullable: true
          description: Actor that requested the plan (if applicable).
        goalId:
          type: string
          description: The goal that was planned for.
        planStepCount:
          type: integer
          format: int32
          description: Number of steps in the generated plan.
        planningTimeMs:
          type: integer
          format: int32
          nullable: true
          description: Time taken to generate the plan in milliseconds.
