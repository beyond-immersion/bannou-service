openapi: 3.0.0
info:
  title: Bannou RelationshipType Service API
  description: |
    Relationship type management service for game worlds.

    **POST-Only API Pattern**: This API uses POST for all operations to support zero-copy
    WebSocket routing. Path parameters are passed in request bodies instead of URLs.
    See docs/BANNOU_DESIGN.md for architectural rationale.

    Relationship types define the kinds of relationships entities can have with each other
    (e.g., parent, child, friend, enemy). Types support hierarchical parent relationships,
    allowing "son" to match "child" for flexible querying.

    **Hierarchy System**: Each type can have a parentTypeId, creating hierarchies like:
    - FAMILY → PARENT → MOTHER, FATHER
    - FAMILY → CHILD → SON, DAUGHTER
    - SOCIAL → FRIEND → CLOSE_FRIEND

    **Deprecation System**: Types can be deprecated instead of deleted directly.
    Deprecated types remain queryable but cannot be used for new relationships.
    Use the merge endpoint to migrate relationships from deprecated types to active ones.
    The special VOID type serves as a sink for relationships whose type should be removed.

    **Two-Step Deletion**:
    1. Deprecate the type (soft delete, prevents new usage)
    2. Merge deprecated type into another type (or VOID to effectively delete)
    3. Optionally hard-delete the deprecated type after merge

    **Seed-Based**: Types are typically seeded at startup from YAML configuration,
    though admin CRUD operations are available for runtime modifications.

    **Schema Rules**: AI agents MUST review docs/reference/SCHEMA-RULES.md before modifying this schema. Optional reference types require `nullable: true`.
  version: 2.0.0
servers:
- url: http://localhost:5012
  description: Bannou service endpoint (internal only)

# NOTE: x-lifecycle moved to relationship-type-events.yaml

paths:
  /relationship-type/get:
    post:
      summary: Get relationship type by ID
      operationId: getRelationshipType
      tags:
      - RelationshipType
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetRelationshipTypeRequest'
      responses:
        '200':
          description: Relationship type retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RelationshipTypeResponse'
        '404':
          description: Relationship type not found

  /relationship-type/get-by-code:
    post:
      summary: Get relationship type by code
      description: Retrieve a relationship type using its unique code (e.g., "SON", "MOTHER", "FRIEND")
      operationId: getRelationshipTypeByCode
      tags:
      - RelationshipType
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetRelationshipTypeByCodeRequest'
      responses:
        '200':
          description: Relationship type retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RelationshipTypeResponse'
        '404':
          description: Relationship type not found

  /relationship-type/list:
    post:
      summary: List all relationship types
      description: Retrieve all relationship types with optional hierarchy filtering
      operationId: listRelationshipTypes
      tags:
      - RelationshipType
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ListRelationshipTypesRequest'
      responses:
        '200':
          description: Relationship types retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RelationshipTypeListResponse'

  /relationship-type/get-children:
    post:
      summary: Get child types for a parent type
      description: Retrieve all relationship types that have the specified type as their parent
      operationId: getChildRelationshipTypes
      tags:
      - RelationshipType
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetChildRelationshipTypesRequest'
      responses:
        '200':
          description: Child relationship types retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RelationshipTypeListResponse'
        '404':
          description: Parent relationship type not found

  /relationship-type/matches-hierarchy:
    post:
      summary: Check if type matches ancestor in hierarchy
      description: |
        Checks if a relationship type matches or descends from an ancestor type.
        For example, "SON" matches "CHILD" because CHILD is an ancestor of SON.
        This enables queries like "find all CHILD relationships" to match SON, DAUGHTER, etc.
      operationId: matchesHierarchy
      tags:
      - RelationshipType
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MatchesHierarchyRequest'
      responses:
        '200':
          description: Hierarchy match result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MatchesHierarchyResponse'
        '404':
          description: One or both relationship types not found

  /relationship-type/get-ancestors:
    post:
      summary: Get all ancestors of a relationship type
      description: |
        Returns the full ancestry chain from the specified type up to the root.
        For example, for "SON" might return ["CHILD", "FAMILY"].
      operationId: getAncestors
      tags:
      - RelationshipType
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetAncestorsRequest'
      responses:
        '200':
          description: Ancestors retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RelationshipTypeListResponse'
        '404':
          description: Relationship type not found

  /relationship-type/create:
    post:
      summary: Create new relationship type
      operationId: createRelationshipType
      tags:
      - RelationshipType Admin
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateRelationshipTypeRequest'
      responses:
        '200':
          description: Relationship type created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RelationshipTypeResponse'
        '400':
          description: Invalid relationship type data
        '409':
          description: Relationship type with this code already exists

  /relationship-type/update:
    post:
      summary: Update relationship type
      operationId: updateRelationshipType
      tags:
      - RelationshipType Admin
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateRelationshipTypeRequest'
      responses:
        '200':
          description: Relationship type updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RelationshipTypeResponse'
        '404':
          description: Relationship type not found
        '400':
          description: Invalid update data

  /relationship-type/delete:
    post:
      summary: Delete relationship type
      description: |
        Hard delete a relationship type. This will fail if the type is still in use.
        For safe removal, first deprecate the type, then merge it into another type
        (or VOID), then delete. Only deprecated types with zero references can be deleted.
      operationId: deleteRelationshipType
      tags:
      - RelationshipType Admin
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeleteRelationshipTypeRequest'
      responses:
        '200':
          description: Relationship type deleted successfully
        '404':
          description: Relationship type not found
        '409':
          description: Cannot delete - type is in use by relationships or has child types

  /relationship-type/deprecate:
    post:
      summary: Deprecate a relationship type
      description: |
        Soft-delete a relationship type by marking it as deprecated.
        Deprecated types:
        - Remain queryable for historical data
        - Cannot be used for creating new relationships
        - Can be merged into other types using the merge endpoint
        - Can be hard-deleted after all references are removed
      operationId: deprecateRelationshipType
      tags:
      - RelationshipType Admin
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeprecateRelationshipTypeRequest'
      responses:
        '200':
          description: Relationship type deprecated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RelationshipTypeResponse'
        '404':
          description: Relationship type not found
        '409':
          description: Relationship type is already deprecated

  /relationship-type/undeprecate:
    post:
      summary: Restore a deprecated relationship type
      description: |
        Remove the deprecated status from a relationship type, making it
        available for new relationships again.
      operationId: undeprecateRelationshipType
      tags:
      - RelationshipType Admin
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UndeprecateRelationshipTypeRequest'
      responses:
        '200':
          description: Relationship type restored successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RelationshipTypeResponse'
        '404':
          description: Relationship type not found
        '400':
          description: Relationship type is not deprecated

  /relationship-type/merge:
    post:
      summary: Merge a deprecated type into another type
      description: |
        Migrate all relationships using a deprecated type to a target type.
        This is the recommended way to handle type removal:
        1. Deprecate the source type
        2. Merge into the target type (or VOID for effective deletion)
        3. Optionally hard-delete the now-empty deprecated type

        The merge operation:
        - Updates all relationships using sourceTypeId to use targetTypeId
        - Publishes events for each affected relationship
        - Returns count of migrated relationships
        - Fails if source is not deprecated (safety check)
      operationId: mergeRelationshipType
      tags:
      - RelationshipType Admin
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MergeRelationshipTypeRequest'
      responses:
        '200':
          description: Merge completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MergeRelationshipTypeResponse'
        '404':
          description: Source or target relationship type not found
        '400':
          description: Source type must be deprecated before merging
        '409':
          description: Cannot merge into a deprecated type

  /relationship-type/seed:
    post:
      summary: Seed relationship types from configuration
      description: |
        Idempotent operation to seed relationship types from provided data.
        Creates types that don't exist, optionally updates existing types.
        Typically called at service startup with YAML-defined types.
      operationId: seedRelationshipTypes
      tags:
      - RelationshipType Admin
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SeedRelationshipTypesRequest'
      responses:
        '200':
          description: Seed operation completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SeedRelationshipTypesResponse'
        '400':
          description: Invalid seed data

components:
  schemas:
    # Request schemas
    GetRelationshipTypeRequest:
      description: Request to retrieve a relationship type by its unique identifier
      type: object
      additionalProperties: false
      required:
      - relationshipTypeId
      properties:
        relationshipTypeId:
          type: string
          format: uuid
          description: Unique identifier of the relationship type

    GetRelationshipTypeByCodeRequest:
      description: Request to retrieve a relationship type by its unique code string
      type: object
      additionalProperties: false
      required:
      - code
      properties:
        code:
          type: string
          minLength: 1
          maxLength: 50
          pattern: '^[A-Z][A-Z0-9_]*$'
          description: Unique code for the relationship type (e.g., "SON", "MOTHER", "FRIEND")

    ListRelationshipTypesRequest:
      description: Request to list relationship types with optional filtering by category, hierarchy, and deprecation 
        status
      type: object
      additionalProperties: false
      properties:
        category:
          type: string
          nullable: true
          description: Filter by category (e.g., "FAMILY", "SOCIAL", "ECONOMIC") (null to include all)
        includeChildren:
          type: boolean
          default: true
          description: Whether to include child types in the response
        rootsOnly:
          type: boolean
          default: false
          description: Only return types with no parent (root types)
        includeDeprecated:
          type: boolean
          default: false
          description: Whether to include deprecated types in the response

    GetChildRelationshipTypesRequest:
      description: Request to retrieve all child relationship types for a given parent type
      type: object
      additionalProperties: false
      required:
      - parentTypeId
      properties:
        parentTypeId:
          type: string
          format: uuid
          description: ID of the parent relationship type
        recursive:
          type: boolean
          default: false
          description: Include all descendants, not just direct children

    MatchesHierarchyRequest:
      description: Request to check if a relationship type matches or descends from an ancestor type in the hierarchy
      type: object
      additionalProperties: false
      required:
      - typeId
      - ancestorTypeId
      properties:
        typeId:
          type: string
          format: uuid
          description: The relationship type to check
        ancestorTypeId:
          type: string
          format: uuid
          description: The potential ancestor type

    GetAncestorsRequest:
      description: Request to retrieve all ancestor types in the hierarchy chain from a relationship type up to the root
      type: object
      additionalProperties: false
      required:
      - typeId
      properties:
        typeId:
          type: string
          format: uuid
          description: The relationship type to get ancestors for

    CreateRelationshipTypeRequest:
      description: Request to create a new relationship type with code, name, and optional hierarchy and inverse 
        settings
      type: object
      additionalProperties: false
      required:
      - code
      - name
      properties:
        code:
          type: string
          minLength: 1
          maxLength: 50
          pattern: '^[A-Z][A-Z0-9_]*$'
          description: Unique code for the relationship type (e.g., "SON", "MOTHER")
        name:
          type: string
          minLength: 1
          maxLength: 100
          description: Display name for the relationship type
        description:
          type: string
          maxLength: 500
          nullable: true
          description: Description of the relationship type (null if not provided)
        category:
          type: string
          maxLength: 50
          nullable: true
          description: Category for grouping (e.g., "FAMILY", "SOCIAL", "ECONOMIC") (null if not categorized)
        parentTypeId:
          type: string
          format: uuid
          nullable: true
          description: Parent type ID for hierarchy (null for root types)
        inverseTypeCode:
          type: string
          maxLength: 50
          nullable: true
          description: Code of the inverse relationship (e.g., "PARENT" for "CHILD")
        isBidirectional:
          type: boolean
          default: false
          description: Whether the relationship is the same in both directions (e.g., "SIBLING")
        metadata:
          type: object
          additionalProperties: true
          nullable: true
          description: Additional metadata for the relationship type

    UpdateRelationshipTypeRequest:
      description: Request to update an existing relationship type's properties such as name, description, category, or 
        hierarchy
      type: object
      additionalProperties: false
      required:
      - relationshipTypeId
      properties:
        relationshipTypeId:
          type: string
          format: uuid
          description: ID of the relationship type to update
        name:
          type: string
          minLength: 1
          maxLength: 100
          nullable: true
          description: Display name for the relationship type
        description:
          type: string
          maxLength: 500
          nullable: true
          description: Description of the relationship type
        category:
          type: string
          maxLength: 50
          nullable: true
          description: Category for grouping
        parentTypeId:
          type: string
          format: uuid
          nullable: true
          description: Parent type ID for hierarchy
        inverseTypeCode:
          type: string
          maxLength: 50
          nullable: true
          description: Code of the inverse relationship
        isBidirectional:
          type: boolean
          nullable: true
          description: Whether the relationship is bidirectional
        metadata:
          type: object
          additionalProperties: true
          nullable: true
          description: Additional metadata

    DeleteRelationshipTypeRequest:
      description: Request to permanently delete a relationship type (typically after deprecation and merge)
      type: object
      additionalProperties: false
      required:
      - relationshipTypeId
      properties:
        relationshipTypeId:
          type: string
          format: uuid
          description: ID of the relationship type to delete

    DeprecateRelationshipTypeRequest:
      description: Request to deprecate a relationship type, preventing its use for new relationships while preserving 
        existing ones
      type: object
      additionalProperties: false
      required:
      - relationshipTypeId
      properties:
        relationshipTypeId:
          type: string
          format: uuid
          description: ID of the relationship type to deprecate
        reason:
          type: string
          maxLength: 500
          nullable: true
          description: Optional reason for deprecation (for audit purposes)

    UndeprecateRelationshipTypeRequest:
      description: Request to restore a deprecated relationship type back to active status
      type: object
      additionalProperties: false
      required:
      - relationshipTypeId
      properties:
        relationshipTypeId:
          type: string
          format: uuid
          description: ID of the relationship type to restore

    MergeRelationshipTypeRequest:
      description: Request to migrate all relationships from a deprecated source type to a target type
      type: object
      additionalProperties: false
      required:
      - sourceTypeId
      - targetTypeId
      properties:
        sourceTypeId:
          type: string
          format: uuid
          description: ID of the deprecated type to merge from (must be deprecated)
        targetTypeId:
          type: string
          format: uuid
          description: ID of the type to merge into (can be VOID for effective deletion)
        deleteAfterMerge:
          type: boolean
          default: false
          description: If true, hard-delete the source type after successful merge

    SeedRelationshipTypesRequest:
      description: Request to bulk seed relationship types from configuration, typically used at startup
      type: object
      additionalProperties: false
      required:
      - types
      properties:
        types:
          type: array
          items:
            $ref: '#/components/schemas/SeedRelationshipType'
          description: List of relationship types to seed
        updateExisting:
          type: boolean
          default: false
          description: Whether to update types that already exist

    SeedRelationshipType:
      description: A relationship type definition used for seeding, with code-based parent and inverse references
      type: object
      additionalProperties: false
      required:
      - code
      - name
      properties:
        code:
          type: string
          description: Unique code for the relationship type
        name:
          type: string
          description: Display name for the relationship type
        description:
          type: string
          nullable: true
          description: Human-readable description of the relationship type (null if not provided)
        category:
          type: string
          nullable: true
          description: Category for grouping relationship types (null if not categorized)
        parentTypeCode:
          type: string
          nullable: true
          description: Code of the parent type (resolved during seeding) (null for root types)
        inverseTypeCode:
          type: string
          nullable: true
          description: Code of the inverse relationship (null if not applicable)
        isBidirectional:
          type: boolean
          default: false
          description: Whether the relationship is the same in both directions
        metadata:
          type: object
          additionalProperties: true
          nullable: true
          description: Additional custom metadata for the relationship type (null if none)

    # Response schemas
    RelationshipTypeResponse:
      description: Complete representation of a relationship type including hierarchy, inverse, and deprecation 
        information
      type: object
      additionalProperties: false
      required:
      - relationshipTypeId
      - code
      - name
      - isBidirectional
      - isDeprecated
      - depth
      - createdAt
      - updatedAt
      properties:
        relationshipTypeId:
          type: string
          format: uuid
          description: Unique identifier of the relationship type
        code:
          type: string
          description: Unique code for the relationship type (e.g., "SON", "MOTHER")
        name:
          type: string
          description: Human-readable display name for the relationship type
        description:
          type: string
          nullable: true
          description: Detailed description of the relationship type
        category:
          type: string
          nullable: true
          description: Category for grouping relationship types (e.g., "FAMILY", "SOCIAL")
        parentTypeId:
          type: string
          format: uuid
          nullable: true
          description: ID of the parent type in the hierarchy (null for root types)
        parentTypeCode:
          type: string
          nullable: true
          description: Code of the parent type (for convenience)
        inverseTypeId:
          type: string
          format: uuid
          nullable: true
          description: ID of the inverse relationship type (e.g., PARENT is inverse of CHILD)
        inverseTypeCode:
          type: string
          nullable: true
          description: Code of the inverse relationship type (for convenience)
        isBidirectional:
          type: boolean
          description: Whether the relationship is the same in both directions (e.g., SIBLING)
        isDeprecated:
          type: boolean
          description: Whether this type is deprecated and cannot be used for new relationships
        deprecatedAt:
          type: string
          format: date-time
          nullable: true
          description: Timestamp when this type was deprecated
        deprecationReason:
          type: string
          nullable: true
          description: Optional reason for deprecation
        depth:
          type: integer
          description: Depth in the hierarchy (0 for root types)
        metadata:
          type: object
          additionalProperties: true
          nullable: true
          description: Additional custom metadata for the relationship type
        createdAt:
          type: string
          format: date-time
          description: Timestamp when the relationship type was created
        updatedAt:
          type: string
          format: date-time
          description: Timestamp when the relationship type was last updated

    RelationshipTypeListResponse:
      description: Response containing a list of relationship types with total count
      type: object
      additionalProperties: false
      required:
      - types
      - totalCount
      properties:
        types:
          type: array
          items:
            $ref: '#/components/schemas/RelationshipTypeResponse'
          description: List of relationship types matching the query
        totalCount:
          type: integer
          description: Total number of relationship types returned

    MatchesHierarchyResponse:
      description: Response indicating whether a type matches an ancestor in the hierarchy and the depth between them
      type: object
      additionalProperties: false
      required:
      - matches
      properties:
        matches:
          type: boolean
          description: True if typeId equals or descends from ancestorTypeId
        depth:
          type: integer
          description: Number of levels between the types (0 if same, -1 if no match)

    SeedRelationshipTypesResponse:
      description: Response summarizing the results of a bulk seed operation with counts of created, updated, and 
        skipped types
      type: object
      additionalProperties: false
      required:
      - created
      - updated
      - skipped
      - errors
      properties:
        created:
          type: integer
          description: Number of new types created
        updated:
          type: integer
          description: Number of existing types updated
        skipped:
          type: integer
          description: Number of types skipped (already exist, updateExisting=false)
        errors:
          type: array
          items:
            type: string
          description: List of error messages for types that failed to seed

    MergeRelationshipTypeResponse:
      description: Response summarizing the results of a merge operation including the number of relationships migrated 
        and any failures
      type: object
      additionalProperties: false
      required:
      - sourceTypeId
      - targetTypeId
      - relationshipsMigrated
      - relationshipsFailed
      - sourceDeleted
      properties:
        sourceTypeId:
          type: string
          format: uuid
          description: ID of the deprecated type that was merged from
        targetTypeId:
          type: string
          format: uuid
          description: ID of the type that relationships were merged into
        relationshipsMigrated:
          type: integer
          description: Number of relationships successfully updated to use the target type
        relationshipsFailed:
          type: integer
          description: Number of relationships that failed to migrate
        sourceDeleted:
          type: boolean
          description: Whether the source type was hard-deleted after merge
        migrationErrors:
          type: array
          items:
            $ref: '#/components/schemas/MigrationError'
          description: Details of individual migration failures (limited to first 100)

    MigrationError:
      description: Details of a single relationship that failed to migrate
      type: object
      additionalProperties: false
      required:
      - relationshipId
      - error
      properties:
        relationshipId:
          type: string
          format: uuid
          description: ID of the relationship that failed to migrate
        error:
          type: string
          description: Error message explaining why the migration failed
