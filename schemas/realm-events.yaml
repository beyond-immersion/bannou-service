openapi: 3.0.4
info:
  title: Realm Service Events
  description: |
    Event models for Realm service RabbitMQ pub/sub via MassTransit.
    Lifecycle events are auto-generated from x-lifecycle definition.

    **SCHEMA MODIFICATION GATE**: STOP. Before modifying this schema, you MUST:
    1. Read docs/reference/SCHEMA-RULES.md
    2. State which section applies to your change
    3. Only then proceed with edits
    Edits without stating the applicable rule are FORBIDDEN.
  version: 1.0.0
  x-event-subscriptions: []  # Realm service doesn't subscribe to external events
  x-event-publications:
    # Realm lifecycle events (auto-generated from x-lifecycle)
    - topic: realm.created
      event: RealmCreatedEvent
      description: Published when a new realm is created
    - topic: realm.updated
      event: RealmUpdatedEvent
      description: Published when a realm is updated
    - topic: realm.deleted
      event: RealmDeletedEvent
      description: Published when a realm is soft-deleted
    - topic: realm.merged
      event: RealmMergedEvent
      description: Published when a realm is merged into another realm

# Lifecycle events auto-generated from this definition
# Output: schemas/Generated/realm-lifecycle-events.yaml
x-lifecycle:
  Realm:
    model:
      realmId: { type: string, format: uuid, primary: true, required: true, description: "Unique identifier for the realm" }
      code: { type: string, required: true, description: "Short code identifier for the realm used in URLs and references" }
      name: { type: string, required: true, description: "Display name of the realm" }
      gameServiceId: { type: string, format: uuid, required: true, description: "ID of the game service this realm belongs to" }
      description: { type: string, nullable: true, description: "Detailed description of the realm and its purpose" }
      category: { type: string, nullable: true, description: "Category classification for organizing realms" }
      isActive: { type: boolean, required: true, description: "Whether the realm is currently active and accessible" }
      isSystemType: { type: boolean, required: true, description: "Whether this realm is a system infrastructure realm (e.g., VOID)" }
      isDeprecated: { type: boolean, required: true, description: "Whether the realm has been marked as deprecated" }
      deprecatedAt: { type: string, format: date-time, nullable: true, description: "Timestamp when the realm was deprecated" }
      deprecationReason: { type: string, nullable: true, description: "Explanation for why the realm was deprecated" }
      metadata: { type: object, additionalProperties: true, nullable: true, description: "Client-only metadata. No Bannou plugin reads specific keys from this field by convention." }
      createdAt: { type: string, format: date-time, required: true, description: "Timestamp when the realm was created" }
      updatedAt: { type: string, format: date-time, required: true, description: "Timestamp when the realm was last updated" }
    resource_mapping:
      resource_type: realm
      # resource_id_field defaults to realmId (primary key)
      # source_type defaults to realm

paths: {}  # Events don't have HTTP paths

components:
  schemas:
    # Realm merge event (not auto-generated from lifecycle)
    RealmMergedEvent:
      allOf:
        - $ref: 'common-events.yaml#/components/schemas/BaseServiceEvent'
      type: object
      additionalProperties: false
      description: Published when a deprecated realm is merged into another realm
      required:
        - sourceRealmId
        - targetRealmId
        - speciesMigrated
        - speciesFailed
        - locationsMigrated
        - locationsFailed
        - charactersMigrated
        - charactersFailed
      properties:
        sourceRealmId:
          type: string
          format: uuid
          description: ID of the source realm that was merged
        sourceRealmCode:
          type: string
          nullable: true
          description: Code of the source realm
        targetRealmId:
          type: string
          format: uuid
          description: ID of the target realm that received entities
        targetRealmCode:
          type: string
          nullable: true
          description: Code of the target realm
        speciesMigrated:
          type: integer
          description: Number of species successfully migrated to the target realm
        speciesFailed:
          type: integer
          description: Number of species that failed to migrate
        locationsMigrated:
          type: integer
          description: Number of locations successfully transferred to the target realm
        locationsFailed:
          type: integer
          description: Number of locations that failed to transfer
        charactersMigrated:
          type: integer
          description: Number of characters successfully transferred to the target realm
        charactersFailed:
          type: integer
          description: Number of characters that failed to transfer
