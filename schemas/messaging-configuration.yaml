openapi: 3.0.3
info:
  title: Messaging Service Configuration
  description: |
    Configuration schema for Messaging service.
    Properties are bound to environment variables with BANNOU_ prefix.

    **SCHEMA MODIFICATION GATE**: STOP. Before modifying this schema, you MUST:
    1. Read docs/reference/SCHEMA-RULES.md
    2. State which section applies to your change
    3. Only then proceed with edits
    Edits without stating the applicable rule are FORBIDDEN.

  version: 1.0.0
paths: {}
x-service-configuration:
  properties:
    # In-Memory Mode (for testing/minimal infrastructure)
    UseInMemory:
      type: boolean
      description: "Use in-memory messaging instead of RabbitMQ. Messages are NOT persisted. ONLY for testing/minimal infrastructure."
      env: MESSAGING_USE_INMEMORY
      default: false

    # RabbitMQ Connection Settings
    RabbitMQHost:
      type: string
      description: RabbitMQ server hostname
      env: MESSAGING_RABBITMQ_HOST
      default: "rabbitmq"
      minLength: 1
    RabbitMQPort:
      type: integer
      description: RabbitMQ server port
      env: MESSAGING_RABBITMQ_PORT
      default: 5672
      minimum: 1
      maximum: 65535
    RabbitMQUsername:
      type: string
      description: RabbitMQ username
      env: MESSAGING_RABBITMQ_USERNAME
      default: "guest"
    RabbitMQPassword:
      type: string
      description: RabbitMQ password
      env: MESSAGING_RABBITMQ_PASSWORD
      default: "guest"
    RabbitMQVirtualHost:
      type: string
      description: RabbitMQ virtual host
      env: MESSAGING_RABBITMQ_VHOST
      default: "/"
    DefaultExchange:
      type: string
      description: Default exchange name for publishing
      env: MESSAGING_DEFAULT_EXCHANGE
      default: "bannou"
      minLength: 1
    EnablePublisherConfirms:
      type: boolean
      description: Enable RabbitMQ publisher confirms for reliability. When enabled, BasicPublishAsync waits for broker confirmation (RabbitMQ.Client 7.x pattern).
      env: MESSAGING_ENABLE_PUBLISHER_CONFIRMS
      default: true
    ConnectionRetryCount:
      type: integer
      description: Number of connection retry attempts
      env: MESSAGING_CONNECTION_RETRY_COUNT
      default: 5
      minimum: 0
      maximum: 100
    ConnectionRetryDelayMs:
      type: integer
      description: Delay between connection retry attempts in milliseconds
      env: MESSAGING_CONNECTION_RETRY_DELAY_MS
      default: 1000
      minimum: 100
      maximum: 30000
    ConnectionMaxBackoffMs:
      type: integer
      description: Maximum backoff delay for connection retries in milliseconds
      env: MESSAGING_CONNECTION_MAX_BACKOFF_MS
      default: 60000
      minimum: 1000
      maximum: 300000
    ChannelPoolSize:
      type: integer
      description: Maximum number of channels in the publisher channel pool
      env: MESSAGING_CHANNEL_POOL_SIZE
      default: 100
      minimum: 10
      maximum: 500
    MaxConcurrentChannelCreation:
      type: integer
      description: Maximum concurrent channel creation requests (backpressure semaphore count)
      env: MESSAGING_MAX_CONCURRENT_CHANNEL_CREATION
      default: 50
      minimum: 10
      maximum: 200
    MaxTotalChannels:
      type: integer
      description: Hard limit on total active channels per connection (RabbitMQ typically allows 2048)
      env: MESSAGING_MAX_TOTAL_CHANNELS
      default: 1000
      minimum: 100
      maximum: 2000
    # Subscription Settings
    DefaultPrefetchCount:
      type: integer
      description: Default prefetch count for subscriptions
      env: MESSAGING_DEFAULT_PREFETCH_COUNT
      default: 10
      minimum: 1
      maximum: 10000
    DefaultAutoAck:
      type: boolean
      description: Default auto-acknowledge setting for subscriptions
      env: MESSAGING_DEFAULT_AUTO_ACK
      default: false
    DeadLetterExchange:
      type: string
      description: Dead letter exchange name for failed messages
      env: MESSAGING_DEAD_LETTER_EXCHANGE
      default: "bannou-dlx"
      minLength: 1
    DeadLetterMaxLength:
      type: integer
      description: Maximum messages in dead letter queue before oldest dropped
      env: MESSAGING_DEAD_LETTER_MAX_LENGTH
      default: 100000
      minimum: 1000
      maximum: 10000000
    DeadLetterTtlMs:
      type: integer
      description: Time-to-live for dead letter messages in milliseconds (default 7 days)
      env: MESSAGING_DEAD_LETTER_TTL_MS
      default: 604800000
      minimum: 3600000
      maximum: 2592000000
    DeadLetterOverflowBehavior:
      $ref: 'messaging-api.yaml#/components/schemas/DeadLetterOverflowBehavior'
      description: Behavior when DLX queue exceeds max length (drop-head drops oldest, reject-publish blocks new messages)
      env: MESSAGING_DEAD_LETTER_OVERFLOW_BEHAVIOR
      default: "drop-head"
    RetryMaxAttempts:
      type: integer
      description: Maximum retry attempts before discarding message to dead-letter topic
      env: MESSAGING_RETRY_MAX_ATTEMPTS
      default: 5
      minimum: 1
      maximum: 20
    RetryDelayMs:
      type: integer
      description: Base delay between retry attempts in milliseconds (doubles with each retry)
      env: MESSAGING_RETRY_DELAY_MS
      default: 5000
      minimum: 100
      maximum: 60000
    RetryMaxBackoffMs:
      type: integer
      description: Maximum backoff delay between retries in milliseconds (caps exponential growth)
      env: MESSAGING_RETRY_MAX_BACKOFF_MS
      default: 60000
      minimum: 1000
      maximum: 300000

    # Retry Buffer Settings (for handling transient publish failures)
    RetryBufferEnabled:
      type: boolean
      description: Enable retry buffer for failed event publishes
      env: MESSAGING_RETRY_BUFFER_ENABLED
      default: true
    RetryBufferMaxSize:
      type: integer
      description: Maximum number of messages in retry buffer before node crash (500k = ~5s at 100k msg/sec)
      env: MESSAGING_RETRY_BUFFER_MAX_SIZE
      default: 500000
      minimum: 10000
      maximum: 2000000
    RetryBufferMaxAgeSeconds:
      type: integer
      description: Maximum age of buffered messages before node crash (gives operators time to respond)
      env: MESSAGING_RETRY_BUFFER_MAX_AGE_SECONDS
      default: 600
      minimum: 60
      maximum: 1800
    RetryBufferIntervalSeconds:
      type: integer
      description: Interval between retry attempts for buffered messages
      env: MESSAGING_RETRY_BUFFER_INTERVAL_SECONDS
      default: 5
      minimum: 1
      maximum: 60
    RetryBufferBackpressureThreshold:
      type: number
      description: When buffer reaches this percentage full, start rejecting new publishes (0.0-1.0)
      env: MESSAGING_RETRY_BUFFER_BACKPRESSURE_THRESHOLD
      default: 0.8
      minimum: 0.5
      maximum: 0.95

    # Publish Batching Settings (for high-throughput scenarios)
    EnablePublishBatching:
      type: boolean
      description: Enable batched publishing for high-throughput scenarios. When enabled, messages are queued and sent in batches to reduce broker overhead.
      env: MESSAGING_ENABLE_PUBLISH_BATCHING
      default: false
    PublishBatchSize:
      type: integer
      description: Maximum number of messages to batch before sending. Batch is flushed when this size is reached.
      env: MESSAGING_PUBLISH_BATCH_SIZE
      default: 100
      minimum: 10
      maximum: 1000
    PublishBatchTimeoutMs:
      type: integer
      description: Maximum delay in milliseconds before flushing a partial batch. Ensures low-throughput periods don't accumulate stale messages.
      env: MESSAGING_PUBLISH_BATCH_TIMEOUT_MS
      default: 10
      minimum: 1
      maximum: 100

    # HTTP Callback Settings (for dynamic subscriptions)
    CallbackRetryMaxAttempts:
      type: integer
      description: Maximum retry attempts for HTTP callback delivery (network failures only)
      env: MESSAGING_CALLBACK_RETRY_MAX_ATTEMPTS
      default: 3
      minimum: 0
      maximum: 10
    CallbackRetryDelayMs:
      type: integer
      description: Delay between HTTP callback retry attempts in milliseconds
      env: MESSAGING_CALLBACK_RETRY_DELAY_MS
      default: 1000
      minimum: 100
      maximum: 30000

    # Note: Telemetry (metrics/tracing) is controlled centrally via lib-telemetry configuration.
    # When lib-telemetry is enabled, it automatically instruments messaging operations via ITelemetryProvider.
    # When disabled or not loaded, instrumentation is skipped entirely (zero overhead).

    # Subscription Recovery Service Configuration
    SubscriptionTtlRefreshIntervalHours:
      type: integer
      description: Interval in hours between subscription TTL refresh operations
      default: 6
      env: MESSAGING_SUBSCRIPTION_TTL_REFRESH_INTERVAL_HOURS
      minimum: 1
      maximum: 24
    SubscriptionRecoveryStartupDelaySeconds:
      type: integer
      description: Delay in seconds before starting subscription recovery service
      default: 2
      env: MESSAGING_SUBSCRIPTION_RECOVERY_STARTUP_DELAY_SECONDS
      minimum: 0
      maximum: 60
    # RabbitMQ Connection Recovery
    RabbitMQNetworkRecoveryIntervalSeconds:
      type: integer
      description: Interval in seconds between RabbitMQ connection recovery attempts
      default: 10
      env: MESSAGING_RABBITMQ_NETWORK_RECOVERY_INTERVAL_SECONDS
      minimum: 1
      maximum: 300

    # External Subscription Configuration
    ExternalSubscriptionTtlSeconds:
      type: integer
      description: TTL in seconds for external HTTP callback subscriptions (default 24 hours)
      default: 86400
      env: MESSAGING_EXTERNAL_SUBSCRIPTION_TTL_SECONDS
      minimum: 3600
      maximum: 2592000
