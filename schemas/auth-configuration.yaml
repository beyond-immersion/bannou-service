openapi: 3.0.3
info:
  title: Auth Service Configuration
  description: |
    Configuration schema for Auth service.
    Properties are bound to environment variables with BANNOU_ prefix.

    **SCHEMA MODIFICATION GATE**: STOP. Before modifying this schema, you MUST:
    1. Read docs/reference/SCHEMA-RULES.md
    2. State which section applies to your change
    3. Only then proceed with edits
    Edits without stating the applicable rule are FORBIDDEN.
  version: 1.0.0
paths: {}
x-service-configuration:
  properties:
    # JWT Configuration
    # NOTE: JwtSecret, JwtIssuer, JwtAudience are now in core AppConfiguration (BANNOU_JWT_*)
    # Auth service uses Program.Configuration for these to avoid duplication
    JwtExpirationMinutes:
      type: integer
      description: JWT token expiration time in minutes
      env: AUTH_JWT_EXPIRATION_MINUTES
      default: 60

    # Connect Service URL
    ConnectUrl:
      type: string
      description: URL to Connect service for WebSocket connections. Defaults to wss://{BANNOU_SERVICE_DOMAIN}/connect if domain set, else ws://localhost:5014/connect.
      env: AUTH_CONNECT_URL
      default: "ws://localhost:5014/connect"

    # Mock Providers for Testing
    MockProviders:
      type: boolean
      description: Enable mock OAuth providers for testing
      env: AUTH_MOCK_PROVIDERS
      default: false
    MockDiscordId:
      type: string
      description: Mock Discord user ID for testing
      env: AUTH_MOCK_DISCORD_ID
      default: "mock-discord-123456"
    MockGoogleId:
      type: string
      description: Mock Google user ID for testing
      env: AUTH_MOCK_GOOGLE_ID
      default: "mock-google-123456"
    MockTwitchId:
      type: string
      description: Mock Twitch user ID for testing
      env: AUTH_MOCK_TWITCH_ID
      default: "mock-twitch-123456"
    MockSteamId:
      type: string
      description: Mock Steam user ID for testing
      env: AUTH_MOCK_STEAM_ID
      default: "76561198000000000"

    # Discord OAuth
    DiscordClientId:
      type: string
      nullable: true  # NRT: Optional config MUST be nullable (provider disabled if not set)
      description: Discord OAuth client ID
      env: AUTH_DISCORD_CLIENT_ID
    DiscordClientSecret:
      type: string
      nullable: true  # NRT: Optional config MUST be nullable (provider disabled if not set)
      description: Discord OAuth client secret
      env: AUTH_DISCORD_CLIENT_SECRET
    DiscordRedirectUri:
      type: string
      nullable: true  # NRT: Optional config MUST be nullable (defaults to ServiceDomain if not set)
      description: Discord OAuth redirect URI. Optional if BANNOU_SERVICE_DOMAIN is set (defaults to https://{domain}/auth/oauth/discord/callback).
      env: AUTH_DISCORD_REDIRECT_URI
      example: "https://your-domain.com/auth/oauth/discord/callback"

    # Google OAuth
    GoogleClientId:
      type: string
      nullable: true  # NRT: Optional config MUST be nullable (provider disabled if not set)
      description: Google OAuth client ID
      env: AUTH_GOOGLE_CLIENT_ID
    GoogleClientSecret:
      type: string
      nullable: true  # NRT: Optional config MUST be nullable (provider disabled if not set)
      description: Google OAuth client secret
      env: AUTH_GOOGLE_CLIENT_SECRET
    GoogleRedirectUri:
      type: string
      nullable: true  # NRT: Optional config MUST be nullable (defaults to ServiceDomain if not set)
      description: Google OAuth redirect URI. Optional if BANNOU_SERVICE_DOMAIN is set (defaults to https://{domain}/auth/oauth/google/callback).
      env: AUTH_GOOGLE_REDIRECT_URI
      example: "https://your-domain.com/auth/oauth/google/callback"

    # Twitch OAuth
    TwitchClientId:
      type: string
      nullable: true  # NRT: Optional config MUST be nullable (provider disabled if not set)
      description: Twitch OAuth client ID
      env: AUTH_TWITCH_CLIENT_ID
    TwitchClientSecret:
      type: string
      nullable: true  # NRT: Optional config MUST be nullable (provider disabled if not set)
      description: Twitch OAuth client secret
      env: AUTH_TWITCH_CLIENT_SECRET
    TwitchRedirectUri:
      type: string
      nullable: true  # NRT: Optional config MUST be nullable (defaults to ServiceDomain if not set)
      description: Twitch OAuth redirect URI. Optional if BANNOU_SERVICE_DOMAIN is set (defaults to https://{domain}/auth/oauth/twitch/callback).
      env: AUTH_TWITCH_REDIRECT_URI
      example: "https://your-domain.com/auth/oauth/twitch/callback"

    # Steam Authentication
    SteamApiKey:
      type: string
      nullable: true  # NRT: Optional config MUST be nullable (provider disabled if not set)
      description: Steam Web API key for session ticket validation
      env: AUTH_STEAM_API_KEY
    SteamAppId:
      type: string
      nullable: true  # NRT: Optional config MUST be nullable (provider disabled if not set)
      description: Steam application ID
      env: AUTH_STEAM_APP_ID
      example: "480"

    # Password Reset
    PasswordResetTokenTtlMinutes:
      type: integer
      description: Password reset token expiration time in minutes
      env: AUTH_PASSWORD_RESET_TOKEN_TTL_MINUTES
      default: 30
    PasswordResetBaseUrl:
      type: string
      nullable: true  # NRT: Optional config MUST be nullable
      description: Base URL for password reset page
      env: AUTH_PASSWORD_RESET_BASE_URL
      example: "https://your-domain.com/reset-password"

    # Rate Limiting
    MaxLoginAttempts:
      type: integer
      description: Maximum failed login attempts before lockout. After this many consecutive failures for an email, further attempts return 429 until the lockout expires.
      env: AUTH_MAX_LOGIN_ATTEMPTS
      default: 5
      minimum: 1
      maximum: 100
    LoginLockoutMinutes:
      type: integer
      description: Duration in minutes to lock out an email after exceeding MaxLoginAttempts. The lockout counter resets on successful login.
      env: AUTH_LOGIN_LOCKOUT_MINUTES
      default: 15
      minimum: 1
      maximum: 1440

    # Security
    BcryptWorkFactor:
      type: integer
      description: BCrypt work factor for password hashing. Higher values are more secure but slower. Existing hashes at lower factors continue to validate.
      env: AUTH_BCRYPT_WORK_FACTOR
      default: 12

    # Session Configuration
    SessionTokenTtlDays:
      type: integer
      description: Session token TTL in days for persistent sessions
      env: AUTH_SESSION_TOKEN_TTL_DAYS
      default: 7

    # Edge Revocation - Master Switch
    EdgeRevocationEnabled:
      type: boolean
      default: false
      description: Master switch for edge-layer token revocation. When enabled, revoked tokens are pushed to configured edge providers for CDN/firewall-level blocking. Disabled by default.
      env: AUTH_EDGE_REVOCATION_ENABLED

    EdgeRevocationTimeoutSeconds:
      type: integer
      default: 5
      minimum: 1
      maximum: 30
      description: Timeout in seconds for edge provider push operations. Operations exceeding this timeout are logged and added to the failed-pushes retry set.
      env: AUTH_EDGE_REVOCATION_TIMEOUT_SECONDS

    EdgeRevocationMaxRetryAttempts:
      type: integer
      default: 3
      minimum: 1
      maximum: 10
      description: Maximum retry attempts for failed edge pushes before giving up and logging an error.
      env: AUTH_EDGE_REVOCATION_MAX_RETRY_ATTEMPTS

    # CloudFlare Provider
    CloudflareEdgeEnabled:
      type: boolean
      default: false
      description: Enable CloudFlare Workers KV edge revocation. Requires CloudflareAccountId, CloudflareKvNamespaceId, and CloudflareApiToken to be configured.
      env: AUTH_CLOUDFLARE_EDGE_ENABLED

    CloudflareAccountId:
      type: string
      nullable: true
      description: CloudFlare account ID for KV API access. Required when CloudflareEdgeEnabled is true.
      env: AUTH_CLOUDFLARE_ACCOUNT_ID

    CloudflareKvNamespaceId:
      type: string
      nullable: true
      description: CloudFlare KV namespace ID where revoked tokens are stored. Create via CloudFlare dashboard or API.
      env: AUTH_CLOUDFLARE_KV_NAMESPACE_ID

    CloudflareApiToken:
      type: string
      nullable: true
      description: CloudFlare API token with Workers KV write permissions. Use a scoped token with only KV Edit permission for security.
      env: AUTH_CLOUDFLARE_API_TOKEN

    # OpenResty/Redis Provider
    OpenrestyEdgeEnabled:
      type: boolean
      default: false
      description: Enable OpenResty/NGINX edge revocation verification. When enabled, the OpenResty Lua scripts read revocation entries directly from Redis (auth:edge prefix) to block revoked tokens at the edge layer before requests reach upstream services.
      env: AUTH_OPENRESTY_EDGE_ENABLED
