openapi: 3.0.4
info:
  title: Transit Service API
  version: 1.0.0
  description: |
    Geographic connectivity graph, transit mode registry, and journey tracking
    service (L2 GameFoundation). Provides edges (connections between locations)
    to complement Location's nodes (hierarchical place tree), a type registry
    for movement modes, and temporal journey tracking computed against
    Worldstate's game clock. Internal-only, never internet-facing.

    **SCHEMA MODIFICATION GATE**: STOP. Before modifying this schema, you MUST:
    1. Read docs/reference/SCHEMA-RULES.md
    2. State which section applies to your change
    3. Only then proceed with edits
    Edits without stating the applicable rule are FORBIDDEN.

  x-references:
    - target: location
      sourceType: transit
      field: fromLocationId
      onDelete: cascade
      cleanup:
        endpoint: /transit/cleanup-by-location
        payloadTemplate: '{"locationId": "{{resourceId}}"}'
    - target: character
      sourceType: transit
      field: entityId
      onDelete: cascade
      cleanup:
        endpoint: /transit/cleanup-by-character
        payloadTemplate: '{"characterId": "{{resourceId}}"}'

x-service-layer: GameFoundation

servers:
  - url: http://localhost:5012

paths:
  # ── Mode Management ──────────────────────────────────────────────────

  /transit/mode/register:
    post:
      operationId: registerMode
      summary: Register a new transit mode type
      description: |
        Register a new transit mode type with movement properties, terrain
        compatibility, entity restrictions, and requirements. Mode codes are
        unique string identifiers (e.g., "walking", "horseback", "wagon").
      tags:
        - Mode
      x-permissions:
        - role: developer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterModeRequest'
      responses:
        '200':
          description: Mode registered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ModeResponse'
        '409':
          description: Mode code already exists

  /transit/mode/get:
    post:
      operationId: getMode
      summary: Get a transit mode by code
      description: Retrieve a transit mode definition by its unique code.
      tags:
        - Mode
      x-permissions:
        - role: user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetModeRequest'
      responses:
        '200':
          description: Mode found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ModeResponse'
        '404':
          description: Mode not found

  /transit/mode/list:
    post:
      operationId: listModes
      summary: List all registered transit modes
      description: |
        List transit modes with optional filtering by realm availability,
        terrain compatibility, tags, and deprecation status.
      tags:
        - Mode
      x-permissions:
        - role: user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ListModesRequest'
      responses:
        '200':
          description: Modes listed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListModesResponse'

  /transit/mode/update:
    post:
      operationId: updateMode
      summary: Update a transit mode's properties
      description: |
        Update properties of an existing transit mode. Only provided fields
        are updated; null fields are left unchanged.
      tags:
        - Mode
      x-permissions:
        - role: developer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateModeRequest'
      responses:
        '200':
          description: Mode updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ModeResponse'
        '404':
          description: Mode not found

  /transit/mode/deprecate:
    post:
      operationId: deprecateMode
      summary: Deprecate a transit mode
      description: |
        Deprecate a transit mode. Existing journeys using this mode continue,
        but new journeys cannot use it. Sets the triple-field deprecation model:
        isDeprecated=true, deprecatedAt=now, deprecationReason=reason.
        Idempotent: returns OK if already deprecated (caller's intent is satisfied).
        Category A per IMPLEMENTATION TENETS: connections store compatibleModes
        and journeys store primaryModeCode/legModes referencing mode codes.
      tags:
        - Mode
      x-permissions:
        - role: developer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeprecateModeRequest'
      responses:
        '200':
          description: Mode deprecated (or already deprecated)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ModeResponse'
        '404':
          description: Mode not found

  /transit/mode/undeprecate:
    post:
      operationId: undeprecateMode
      summary: Reverse deprecation of a transit mode
      description: |
        Reverse deprecation of a transit mode (Category A — undeprecate is required).
        Clears isDeprecated, deprecatedAt, deprecationReason.
        Idempotent: returns OK if not currently deprecated.
      tags:
        - Mode
      x-permissions:
        - role: developer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UndeprecateModeRequest'
      responses:
        '200':
          description: Mode undeprecated (or was not deprecated)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ModeResponse'
        '404':
          description: Mode not found

  /transit/mode/delete:
    post:
      operationId: deleteMode
      summary: Delete a deprecated transit mode
      description: |
        Delete a deprecated transit mode (Category A — must be deprecated before
        deletion). Rejects if active journeys use this mode or if connections
        still list this mode in compatibleModes. Archived journeys retain the
        mode code as historical data.
      tags:
        - Mode
      x-permissions:
        - role: developer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeleteModeRequest'
      responses:
        '200':
          description: Mode deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeleteModeResponse'
        '400':
          description: Mode is not deprecated (must deprecate before deleting)
        '404':
          description: Mode not found
        '409':
          description: ACTIVE_JOURNEYS_EXIST (active journeys use this mode) or CONNECTIONS_REFERENCE_MODE (connections list this mode in compatibleModes)

  /transit/mode/check-availability:
    post:
      operationId: checkModeAvailability
      summary: Check which transit modes an entity can currently use
      description: |
        Check mode availability for an entity based on item requirements,
        species restrictions, entity type restrictions, and optional location
        context. Also applies ITransitCostModifierProvider enrichment to
        compute preferenceCost and effectiveSpeed adjustments.
      tags:
        - Mode
      x-permissions:
        - role: user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CheckModeAvailabilityRequest'
      responses:
        '200':
          description: Availability checked
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CheckModeAvailabilityResponse'

  # ── Connection Management ────────────────────────────────────────────

  /transit/connection/create:
    post:
      operationId: createConnection
      summary: Create a connection between two locations
      description: |
        Create a directed or bidirectional connection between two locations.
        fromRealmId, toRealmId, and crossRealm are derived from the locations
        via the Location service. Season keys in seasonalAvailability are
        validated against the realm's Worldstate season codes.
      tags:
        - Connection
      x-permissions:
        - role: developer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateConnectionRequest'
      responses:
        '200':
          description: Connection created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConnectionResponse'
        '400':
          description: Same location, invalid mode code, or invalid season key
        '404':
          description: One or both locations not found
        '409':
          description: Connection already exists between these locations

  /transit/connection/get:
    post:
      operationId: getConnection
      summary: Get a connection by ID or code
      description: Retrieve a connection by its unique ID or code. One of connectionId or code must be provided.
      tags:
        - Connection
      x-permissions:
        - role: user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetConnectionRequest'
      responses:
        '200':
          description: Connection found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConnectionResponse'
        '404':
          description: Connection not found

  /transit/connection/query:
    post:
      operationId: queryConnections
      summary: Query connections by location, terrain, mode, or status
      description: |
        Query connections with optional filters. All filters are optional;
        an empty request returns all connections paginated.
      tags:
        - Connection
      x-permissions:
        - role: user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QueryConnectionsRequest'
      responses:
        '200':
          description: Connections queried
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueryConnectionsResponse'

  /transit/connection/update:
    post:
      operationId: updateConnection
      summary: Update a connection's properties
      description: |
        Update properties of an existing connection. Does not update status —
        use update-status for operational status changes. Only provided fields
        are updated; null fields are left unchanged.
      tags:
        - Connection
      x-permissions:
        - role: developer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateConnectionRequest'
      responses:
        '200':
          description: Connection updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConnectionResponse'
        '404':
          description: Connection not found

  /transit/connection/update-status:
    post:
      operationId: updateConnectionStatus
      summary: Transition a connection's operational status with optimistic concurrency
      description: |
        Transition a connection's operational status using optimistic concurrency.
        Caller specifies currentStatus (what they believe the status is) and
        newStatus. If the actual status does not match currentStatus, returns
        Bad Request with the actual status. Use forceUpdate=true for administrative
        overrides where currentStatus is ignored. The seasonal_closed status is
        typically only set by the Seasonal Connection Worker via forceUpdate=true.
      tags:
        - Connection
      x-permissions:
        - role: user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateConnectionStatusRequest'
      responses:
        '200':
          description: Status updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConnectionResponse'
        '404':
          description: Connection not found
        '400':
          description: Status mismatch — actual status differs from currentStatus (Bad Request forces caller to refresh and retry)

  /transit/connection/delete:
    post:
      operationId: deleteConnection
      summary: Delete a connection between locations
      description: |
        Delete a connection. Rejects if active journeys are currently using
        this connection.
      tags:
        - Connection
      x-permissions:
        - role: developer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeleteConnectionRequest'
      responses:
        '200':
          description: Connection deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeleteConnectionResponse'
        '404':
          description: Connection not found
        '409':
          description: ACTIVE_JOURNEYS_EXIST (cannot delete while journeys are using this connection)

  /transit/connection/bulk-seed:
    post:
      operationId: bulkSeedConnections
      summary: Seed connections from configuration
      description: |
        Seed connections from configuration using location codes resolved via
        the Location service. Two-pass resolution: first pass creates connections
        with location code lookup, second pass validates all mode codes exist.
        When realmId is provided, location codes are resolved within that realm
        and replaceExisting deletes connections for that realm only.
      tags:
        - Connection
      x-permissions:
        - role: developer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BulkSeedConnectionsRequest'
      responses:
        '200':
          description: Bulk seed completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BulkSeedConnectionsResponse'

  # ── Journey Lifecycle ────────────────────────────────────────────────

  /transit/journey/create:
    post:
      operationId: createJourney
      summary: Plan a journey (status preparing)
      description: |
        Plan a journey from origin to destination. Internally calls route/calculate
        to find the best path and populate legs. Checks mode compatibility via
        check-availability. Does NOT start the journey — call /transit/journey/depart
        for that. When preferMultiModal is true, each leg gets the fastest compatible
        mode the entity can use on that connection.
      tags:
        - Journey
      x-permissions:
        - role: user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateJourneyRequest'
      responses:
        '200':
          description: Journey planned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JourneyResponse'
        '400':
          description: Mode deprecated, requirements not met, or entity type not allowed
        '404':
          description: Origin, destination, or mode not found; no route available

  /transit/journey/depart:
    post:
      operationId: departJourney
      summary: Start a prepared journey
      description: |
        Start a prepared journey, transitioning status from preparing to in_transit.
        Publishes transit.journey.departed event.
      tags:
        - Journey
      x-permissions:
        - role: user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DepartJourneyRequest'
      responses:
        '200':
          description: Journey started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JourneyResponse'
        '400':
          description: Invalid status (must be preparing) or first leg connection closed
        '404':
          description: Journey not found

  /transit/journey/resume:
    post:
      operationId: resumeJourney
      summary: Resume an interrupted journey
      description: |
        Resume an interrupted journey, transitioning status from interrupted
        to in_transit. Distinct from depart: depart is for initial departure
        (preparing to in_transit), resume is for continuing after interruption.
        Publishes transit.journey.resumed event.
      tags:
        - Journey
      x-permissions:
        - role: user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResumeJourneyRequest'
      responses:
        '200':
          description: Journey resumed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JourneyResponse'
        '400':
          description: Invalid status (must be interrupted) or current leg connection closed
        '404':
          description: Journey not found

  /transit/journey/advance:
    post:
      operationId: advanceJourney
      summary: Mark arrival at next waypoint
      description: |
        Mark arrival at the next waypoint, completing the current leg and
        starting the next. If this completes the final leg, journey status
        transitions to arrived. Publishes transit.journey.waypoint-reached
        or transit.journey.arrived accordingly.
      tags:
        - Journey
      x-permissions:
        - role: user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AdvanceJourneyRequest'
      responses:
        '200':
          description: Journey advanced
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JourneyResponse'
        '400':
          description: Invalid status (must be in_transit) or no current leg
        '404':
          description: Journey not found

  /transit/journey/advance-batch:
    post:
      operationId: advanceBatchJourneys
      summary: Advance multiple journeys in a single call
      description: |
        Advance multiple journeys in a single call for game SDK efficiency at
        NPC scale (10,000+ concurrent journeys). Each advance is processed
        independently — failure of one does not roll back others. Results
        include per-journey success/failure with error details. Ordering within
        the batch is preserved for cases where the same journeyId appears
        multiple times (advancing through multiple waypoints in a single tick).
      tags:
        - Journey
      x-permissions:
        - role: user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AdvanceBatchRequest'
      responses:
        '200':
          description: Batch processed (check individual results for per-journey errors)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdvanceBatchResponse'

  /transit/journey/arrive:
    post:
      operationId: arriveJourney
      summary: Force-arrive a journey at destination
      description: |
        Force-arrive a journey at its destination, skipping remaining legs.
        Remaining legs are marked as skipped rather than completed. Used for
        narrative fast-travel, teleportation, or game-driven skip.
        Publishes transit.journey.arrived event.
      tags:
        - Journey
      x-permissions:
        - role: user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ArriveJourneyRequest'
      responses:
        '200':
          description: Journey force-arrived
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JourneyResponse'
        '400':
          description: Invalid status (must be in_transit or at_waypoint)
        '404':
          description: Journey not found

  /transit/journey/interrupt:
    post:
      operationId: interruptJourney
      summary: Interrupt an active journey
      description: |
        Interrupt an active journey due to combat, event, or breakdown.
        Transitions status to interrupted. To resume, call /transit/journey/resume.
        To abandon, call /transit/journey/abandon.
        Publishes transit.journey.interrupted event.
      tags:
        - Journey
      x-permissions:
        - role: user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InterruptJourneyRequest'
      responses:
        '200':
          description: Journey interrupted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JourneyResponse'
        '400':
          description: Invalid status (must be in_transit)
        '404':
          description: Journey not found

  /transit/journey/abandon:
    post:
      operationId: abandonJourney
      summary: Abandon a journey
      description: |
        Abandon a journey. The entity stays at its current location.
        Publishes transit.journey.abandoned event.
      tags:
        - Journey
      x-permissions:
        - role: user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AbandonJourneyRequest'
      responses:
        '200':
          description: Journey abandoned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JourneyResponse'
        '400':
          description: Invalid status (must be preparing, in_transit, at_waypoint, or interrupted)
        '404':
          description: Journey not found

  /transit/journey/get:
    post:
      operationId: getJourney
      summary: Get a journey by ID
      description: Retrieve a journey by its unique ID.
      tags:
        - Journey
      x-permissions:
        - role: user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetJourneyRequest'
      responses:
        '200':
          description: Journey found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JourneyResponse'
        '404':
          description: Journey not found

  /transit/journey/query-by-connection:
    post:
      operationId: queryJourneysByConnection
      summary: List active journeys on a specific connection
      description: |
        List active journeys currently traversing a specific connection.
        Enables queries like "who is on this road?" for encounter generation,
        bandit ambush targeting, caravan interception, and road traffic monitoring.
      tags:
        - Journey
      x-permissions:
        - role: user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QueryJourneysByConnectionRequest'
      responses:
        '200':
          description: Journeys queried
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListJourneysResponse'
        '404':
          description: Connection not found

  /transit/journey/list:
    post:
      operationId: listJourneys
      summary: List journeys for an entity or within a realm
      description: |
        List journeys with optional filtering by entity, entity type, realm,
        cross-realm status, journey status, and active-only flag.
      tags:
        - Journey
      x-permissions:
        - role: user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ListJourneysRequest'
      responses:
        '200':
          description: Journeys listed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListJourneysResponse'

  /transit/journey/query-archive:
    post:
      operationId: queryJourneyArchive
      summary: Query archived journeys from MySQL historical store
      description: |
        Query archived (completed/abandoned) journeys from the MySQL historical
        store. Used by Trade (velocity calculations), Analytics (travel patterns),
        and Character History (travel biography generation).
      tags:
        - Journey
      x-permissions:
        - role: user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QueryJourneyArchiveRequest'
      responses:
        '200':
          description: Archived journeys queried
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListJourneysResponse'

  # ── Route Calculation ────────────────────────────────────────────────

  /transit/route/calculate:
    post:
      operationId: calculateRoute
      summary: Calculate route options between two locations
      description: |
        Calculate route options between two locations. Pure computation endpoint
        with no state mutation. Performs Dijkstra graph search over the connection
        graph filtered by mode compatibility, seasonal availability, and discovery
        status. Does NOT apply entity-specific DI cost modifiers (those are applied
        by the variable provider when GOAP evaluates the results).
      tags:
        - Route
      x-permissions:
        - role: user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CalculateRouteRequest'
      responses:
        '200':
          description: Route options calculated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CalculateRouteResponse'
        '404':
          description: Locations not found or no route available

  # ── Connection Discovery ─────────────────────────────────────────────

  /transit/discovery/reveal:
    post:
      operationId: revealDiscovery
      summary: Reveal a discoverable connection to an entity
      description: |
        Reveal a discoverable connection to an entity via explicit grant.
        Also called internally by journey/advance when a leg uses a discoverable
        connection. Hearsay (L4) calls this when propagating route knowledge
        via rumor. Publishes transit.discovery.revealed event for new discoveries.
      tags:
        - Discovery
      x-permissions:
        - role: user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RevealDiscoveryRequest'
      responses:
        '200':
          description: Discovery recorded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RevealDiscoveryResponse'
        '400':
          description: Connection is not marked as discoverable
        '404':
          description: Connection not found

  /transit/discovery/list:
    post:
      operationId: listDiscoveries
      summary: List connections an entity has discovered
      description: List all discoverable connections that an entity has discovered, with optional realm filtering.
      tags:
        - Discovery
      x-permissions:
        - role: user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ListDiscoveriesRequest'
      responses:
        '200':
          description: Discoveries listed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListDiscoveriesResponse'

  /transit/discovery/check:
    post:
      operationId: checkDiscoveries
      summary: Check if an entity has discovered specific connections
      description: Check whether an entity has discovered each of the specified connections.
      tags:
        - Discovery
      x-permissions:
        - role: user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CheckDiscoveriesRequest'
      responses:
        '200':
          description: Discovery status checked
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CheckDiscoveriesResponse'

  # ── Resource Cleanup (Internal) ──────────────────────────────────────

  /transit/cleanup-by-location:
    post:
      operationId: cleanupByLocation
      summary: Clean up transit data for a deleted location
      description: |
        Called by lib-resource when a location is deleted. Closes all connections
        referencing the deleted location and interrupts active journeys passing
        through it. Internal cleanup callback, not exposed to WebSocket clients.
      tags:
        - Cleanup
      x-permissions: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CleanupByLocationRequest'
      responses:
        '200':
          description: Cleanup completed

  /transit/cleanup-by-character:
    post:
      operationId: cleanupByCharacter
      summary: Clean up transit data for a deleted character
      description: |
        Called by lib-resource when a character is deleted. Clears discovery
        data for the deleted entity and abandons any active journeys.
        Internal cleanup callback, not exposed to WebSocket clients.
      tags:
        - Cleanup
      x-permissions: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CleanupByCharacterRequest'
      responses:
        '200':
          description: Cleanup completed

components:
  schemas:

    # ── Enums ────────────────────────────────────────────────────────────

    ConnectionStatus:
      type: string
      description: Operational status of a transit connection
      enum:
        - open
        - closed
        - dangerous
        - blocked
        - seasonal_closed

    SettableConnectionStatus:
      type: string
      description: Connection statuses that can be set via the update-status endpoint (excludes seasonal_closed which is managed by the Seasonal Connection Worker)
      enum:
        - open
        - closed
        - dangerous
        - blocked

    JourneyStatus:
      type: string
      description: Lifecycle status of a transit journey
      enum:
        - preparing
        - in_transit
        - at_waypoint
        - arrived
        - interrupted
        - abandoned

    JourneyLegStatus:
      type: string
      description: Lifecycle status of a journey leg
      enum:
        - pending
        - in_progress
        - completed
        - skipped

    RouteSortBy:
      type: string
      description: Sort criteria for route calculation results
      enum:
        - fastest
        - safest
        - shortest

    # ── Sub-Models ───────────────────────────────────────────────────────

    TerrainSpeedModifier:
      type: object
      additionalProperties: false
      description: Per-terrain speed multiplier applied to a mode's base speed
      required:
        - terrainType
        - multiplier
      properties:
        terrainType:
          type: string
          description: Terrain type code (e.g., "road", "trail", "forest"). Category B content code (game-configurable).
        multiplier:
          type: number
          format: decimal
          minimum: 0.01
          description: Speed multiplier applied to base speed (1.0 = no change, 0.5 = half speed, 1.2 = 20% faster)

    SeasonalAvailabilityEntry:
      type: object
      additionalProperties: false
      description: Per-season availability for a connection. Season codes must match the realm's Worldstate calendar template.
      required:
        - season
        - available
      properties:
        season:
          type: string
          description: Season code matching the realm's Worldstate calendar template (e.g., "winter", "wet", "dry")
        available:
          type: boolean
          description: Whether the connection is open during this season

    TransitModeRequirements:
      type: object
      additionalProperties: false
      description: Requirements that must be met to use a transit mode (applies to character entities only)
      properties:
        requiredItemTag:
          type: string
          nullable: true
          description: Item tag required to use this mode (e.g., "mount_horse"). Null means no item needed.
        allowedSpeciesCodes:
          type: array
          nullable: true
          description: Species codes allowed to use this mode. Null means any species.
          items:
            type: string
        excludedSpeciesCodes:
          type: array
          nullable: true
          description: Species codes that cannot use this mode. Null means no exclusions.
          items:
            type: string
        minimumPartySize:
          type: integer
          minimum: 1
          default: 1
          description: Minimum party size required (e.g., ocean_vessel requires crew of 3)
        maximumEntitySizeCategory:
          type: string
          nullable: true
          description: Maximum entity size category allowed (e.g., "small", "medium", "large"). Category B content code. Null means no size restriction.

    TransitJourneyLeg:
      type: object
      additionalProperties: false
      description: A single leg of a journey following one connection
      required:
        - connectionId
        - fromLocationId
        - toLocationId
        - modeCode
        - distanceKm
        - terrainType
        - estimatedDurationGameHours
        - status
      properties:
        connectionId:
          type: string
          format: uuid
          description: Transit connection this leg follows
        fromLocationId:
          type: string
          format: uuid
          description: Starting location of this leg
        toLocationId:
          type: string
          format: uuid
          description: Ending location of this leg
        modeCode:
          type: string
          description: Transit mode for this leg. May differ from the journey's primaryModeCode for multi-modal journeys.
        distanceKm:
          type: number
          format: decimal
          minimum: 0.01
          description: Distance in game-kilometers (copied from connection)
        terrainType:
          type: string
          description: Terrain type of this leg's connection. Category B content code.
        estimatedDurationGameHours:
          type: number
          format: decimal
          minimum: 0
          description: Estimated duration for this leg in game-hours
        waypointTransferTimeGameHours:
          type: number
          format: decimal
          nullable: true
          minimum: 0
          description: Delay at the waypoint before starting this leg. Models intra-location transfer time (disembarking, changing mounts, crossing a city). Null or 0 means no delay.
        status:
          allOf:
            - $ref: '#/components/schemas/JourneyLegStatus'
          description: Current status of this journey leg
        completedAtGameTime:
          type: number
          format: decimal
          nullable: true
          description: Game-time when this leg was completed. Null if pending or in_progress.

    TransitInterruption:
      type: object
      additionalProperties: false
      description: A recorded interruption during a journey
      required:
        - legIndex
        - gameTime
        - reason
        - durationGameHours
        - resolved
      properties:
        legIndex:
          type: integer
          description: Which leg was interrupted (0-based index)
        gameTime:
          type: number
          format: decimal
          description: Game-time when the interruption occurred
        reason:
          type: string
          description: Reason for interruption (e.g., "bandit_attack", "storm", "breakdown", "encounter")
        durationGameHours:
          type: number
          format: decimal
          minimum: 0
          description: How long the interruption lasted in game-hours. 0 if unresolved or resolved immediately.
        resolved:
          type: boolean
          description: Whether travel resumed after this interruption. Stored entity state, not derivable from durationGameHours.

    SeasonalRouteWarning:
      type: object
      additionalProperties: false
      description: Warning about an upcoming seasonal closure on a route leg
      required:
        - connectionId
        - legIndex
        - currentSeason
        - closingSeason
        - closingSeasonIndex
      properties:
        connectionId:
          type: string
          format: uuid
          description: Connection with the seasonal risk
        connectionName:
          type: string
          nullable: true
          description: Human-readable connection name for display
        legIndex:
          type: integer
          description: Which leg in the route uses this connection
        currentSeason:
          type: string
          description: Current season code (from Worldstate)
        closingSeason:
          type: string
          description: Season code when this connection closes
        closingSeasonIndex:
          type: integer
          description: How many season transitions until closure (1 = next season)

    ModeAvailabilityResult:
      type: object
      additionalProperties: false
      description: Availability result for a single transit mode for an entity
      required:
        - code
        - available
        - effectiveSpeed
        - preferenceCost
      properties:
        code:
          type: string
          description: Transit mode code
        available:
          type: boolean
          description: Whether the entity can currently use this mode
        unavailableReason:
          type: string
          nullable: true
          description: Why the mode is unavailable. Null if available.
        effectiveSpeed:
          type: number
          format: decimal
          minimum: 0
          description: Effective speed in km/game-hour adjusted for cargo weight
        preferenceCost:
          type: number
          format: decimal
          minimum: 0
          description: GOAP preference cost from DI cost modifier providers (0.0 = neutral, 1.0 = extreme aversion)

    BatchAdvanceEntry:
      type: object
      additionalProperties: false
      description: A single advance entry in a batch advance request
      required:
        - journeyId
        - arrivedAtGameTime
      properties:
        journeyId:
          type: string
          format: uuid
          description: Journey to advance
        arrivedAtGameTime:
          type: number
          format: decimal
          description: Game-time when the waypoint was reached
        incidents:
          type: array
          nullable: true
          description: Events that occurred during this leg
          items:
            $ref: '#/components/schemas/JourneyIncident'

    BatchAdvanceResult:
      type: object
      additionalProperties: false
      description: Result for a single journey in a batch advance
      required:
        - journeyId
      properties:
        journeyId:
          type: string
          format: uuid
          description: Journey that was advanced
        error:
          type: string
          nullable: true
          description: Error code on failure. Null on success.
        journey:
          allOf:
            - $ref: '#/components/schemas/TransitJourney'
          nullable: true
          description: Updated journey on success. Null on failure.

    JourneyIncident:
      type: object
      additionalProperties: false
      description: An incident that occurred during a journey leg
      required:
        - reason
        - durationGameHours
      properties:
        reason:
          type: string
          description: Type of incident (e.g., "bandit_attack", "storm_delay", "detour")
        durationGameHours:
          type: number
          format: decimal
          minimum: 0
          description: How much game-time the incident added
        description:
          type: string
          nullable: true
          description: Optional narrative description of the incident

    DiscoveryRecord:
      type: object
      additionalProperties: false
      description: Record of a connection discovery by an entity
      required:
        - entityId
        - connectionId
        - source
        - discoveredAt
        - isNew
      properties:
        entityId:
          type: string
          format: uuid
          description: Entity that discovered the connection
        connectionId:
          type: string
          format: uuid
          description: Connection that was discovered
        source:
          type: string
          description: How the connection was discovered (e.g., "travel", "guide", "hearsay", "map", "quest_reward")
        discoveredAt:
          type: string
          format: date-time
          description: When discovery occurred (now for new, original time if already known)
        isNew:
          type: boolean
          description: Whether this was a new discovery (true) or already known (false). Stored entity state needed by Collection to distinguish first discovery from re-revelation.

    DiscoveryCheckResult:
      type: object
      additionalProperties: false
      description: Discovery status for a single connection
      required:
        - connectionId
        - discovered
      properties:
        connectionId:
          type: string
          format: uuid
          description: Connection checked
        discovered:
          type: boolean
          description: Whether the entity has discovered this connection
        discoveredAt:
          type: string
          format: date-time
          nullable: true
          description: When it was discovered. Null if not discovered.
        source:
          type: string
          nullable: true
          description: How it was discovered. Null if not discovered.

    BulkSeedConnectionEntry:
      type: object
      additionalProperties: false
      description: A single connection entry in a bulk seed request
      required:
        - fromLocationCode
        - toLocationCode
        - bidirectional
        - distanceKm
        - terrainType
        - compatibleModes
        - baseRiskLevel
      properties:
        fromLocationCode:
          type: string
          description: Location code for the starting point (resolved via Location service)
        toLocationCode:
          type: string
          description: Location code for the ending point (resolved via Location service)
        bidirectional:
          type: boolean
          description: Whether the connection is traversable both ways
        distanceKm:
          type: number
          format: decimal
          minimum: 0.01
          description: Distance in game-kilometers
        terrainType:
          type: string
          description: Terrain type code. Category B content code.
        compatibleModes:
          type: array
          description: Transit mode codes that can use this connection
          items:
            type: string
        seasonalAvailability:
          type: array
          nullable: true
          description: Per-season availability restrictions. Null means always available.
          items:
            $ref: '#/components/schemas/SeasonalAvailabilityEntry'
        baseRiskLevel:
          type: number
          format: decimal
          minimum: 0
          maximum: 1
          description: Base risk level from 0.0 (safe) to 1.0 (extremely dangerous)
        name:
          type: string
          nullable: true
          description: Human-readable connection name
        code:
          type: string
          nullable: true
          description: Unique code for lookup
        tags:
          type: array
          nullable: true
          description: Freeform classification tags
          items:
            type: string

    # ── Entity Models ────────────────────────────────────────────────────

    TransitMode:
      type: object
      additionalProperties: false
      description: A transit mode defining movement capabilities (e.g., walking, horseback, wagon)
      required:
        - code
        - name
        - description
        - baseSpeedKmPerGameHour
        - passengerCapacity
        - cargoCapacityKg
        - compatibleTerrainTypes
        - requirements
        - fatigueRatePerGameHour
        - noiseLevelNormalized
        - isDeprecated
        - createdAt
        - modifiedAt
      properties:
        code:
          type: string
          description: Unique string identifier for this mode (e.g., "walking", "horseback", "wagon")
        name:
          type: string
          description: Human-readable display name
        description:
          type: string
          description: Detailed description of this transit mode
        baseSpeedKmPerGameHour:
          type: number
          format: decimal
          minimum: 0.1
          description: Base speed in game-kilometers per game-hour. Used when no terrain-specific speed modifier is defined.
        terrainSpeedModifiers:
          type: array
          nullable: true
          description: Per-terrain speed multipliers. Null means base speed applies uniformly across all compatible terrain.
          items:
            $ref: '#/components/schemas/TerrainSpeedModifier'
        passengerCapacity:
          type: integer
          minimum: 1
          description: How many entities can ride (1 for horse, 20 for ship)
        cargoCapacityKg:
          type: number
          format: decimal
          minimum: 0
          description: Weight capacity in game-kg (0 for walking, 500 for wagon)
        cargoSpeedPenaltyRate:
          type: number
          format: decimal
          nullable: true
          minimum: 0
          maximum: 1
          description: Per-mode cargo speed penalty rate. Overrides the plugin-level DefaultCargoSpeedPenaltyRate. Null means use plugin config default. 0.0 means no cargo penalty.
        compatibleTerrainTypes:
          type: array
          description: Terrain types this mode can traverse. Empty array means all terrain (e.g., walking, flying).
          items:
            type: string
        validEntityTypes:
          type: array
          nullable: true
          description: Entity types allowed to use this mode. Null means no entity type restriction. Characters are not exempt.
          items:
            type: string
        requirements:
          allOf:
            - $ref: '#/components/schemas/TransitModeRequirements'
          description: Requirements that must be met to use this mode
        fatigueRatePerGameHour:
          type: number
          format: decimal
          minimum: 0
          description: Stamina cost per game-hour of travel (0 = no fatigue)
        noiseLevelNormalized:
          type: number
          format: decimal
          minimum: 0
          maximum: 1
          description: Noise level from 0.0 (silent) to 1.0 (loud) affecting detection risk
        realmRestrictions:
          type: array
          nullable: true
          description: Realm IDs where this mode is available. Null means available in all realms.
          items:
            type: string
            format: uuid
        isDeprecated:
          type: boolean
          description: Whether this mode is deprecated
        deprecatedAt:
          type: string
          format: date-time
          nullable: true
          description: When deprecation occurred. Null if not deprecated.
        deprecationReason:
          type: string
          nullable: true
          description: Why this mode was deprecated. Null if not deprecated.
        tags:
          type: array
          nullable: true
          description: Freeform classification tags (e.g., "mount", "vehicle", "magical", "aquatic"). Null means no tags.
          items:
            type: string
        createdAt:
          type: string
          format: date-time
          description: When this mode was registered
        modifiedAt:
          type: string
          format: date-time
          description: When this mode was last modified

    TransitConnection:
      type: object
      additionalProperties: false
      description: A connection (edge) between two locations in the transit connectivity graph
      required:
        - id
        - fromLocationId
        - toLocationId
        - bidirectional
        - distanceKm
        - terrainType
        - compatibleModes
        - baseRiskLevel
        - status
        - statusChangedAt
        - discoverable
        - fromRealmId
        - toRealmId
        - crossRealm
        - createdAt
        - modifiedAt
      properties:
        id:
          type: string
          format: uuid
          description: Unique identifier for this connection
        fromLocationId:
          type: string
          format: uuid
          description: Starting location (Location service entity)
        toLocationId:
          type: string
          format: uuid
          description: Ending location (Location service entity)
        bidirectional:
          type: boolean
          description: Whether this connection is traversable both ways
        distanceKm:
          type: number
          format: decimal
          minimum: 0.01
          description: Distance in game-kilometers
        terrainType:
          type: string
          description: Terrain classification (e.g., "road", "trail", "forest", "mountain", "river"). Category B content code.
        compatibleModes:
          type: array
          description: Transit mode codes that can use this connection. Empty means walking only.
          items:
            type: string
        seasonalAvailability:
          type: array
          nullable: true
          description: Per-season availability restrictions. Season codes must match the realm's Worldstate calendar template. Null means always available.
          items:
            $ref: '#/components/schemas/SeasonalAvailabilityEntry'
        baseRiskLevel:
          type: number
          format: decimal
          minimum: 0
          maximum: 1
          description: Base risk level from 0.0 (safe) to 1.0 (extremely dangerous)
        riskDescription:
          type: string
          nullable: true
          description: Human-readable risk description (e.g., "Bandit territory", "Avalanche prone"). Null means no specific risk.
        status:
          allOf:
            - $ref: '#/components/schemas/ConnectionStatus'
          description: Current operational status of this connection
        statusReason:
          type: string
          nullable: true
          description: Why the connection is in its current status. Null when open with no special reason.
        statusChangedAt:
          type: string
          format: date-time
          description: When the status was last changed
        discoverable:
          type: boolean
          description: Whether this connection requires discovery. False means common knowledge visible to all route queries.
        name:
          type: string
          nullable: true
          description: Human-readable connection name (e.g., "The King's Road", "Serpent River")
        code:
          type: string
          nullable: true
          description: Unique code for lookup (e.g., "kings_road")
        tags:
          type: array
          nullable: true
          description: Freeform classification tags (e.g., "trade_route", "military", "smuggler_path"). Null means no tags.
          items:
            type: string
        fromRealmId:
          type: string
          format: uuid
          description: Realm of fromLocationId (derived, not caller-specified)
        toRealmId:
          type: string
          format: uuid
          description: Realm of toLocationId (derived, not caller-specified)
        crossRealm:
          type: boolean
          description: Whether fromRealmId differs from toRealmId (derived convenience flag)
        createdAt:
          type: string
          format: date-time
          description: When this connection was created
        modifiedAt:
          type: string
          format: date-time
          description: When this connection was last modified

    TransitJourney:
      type: object
      additionalProperties: false
      description: An active or completed transit journey tracking entity movement across connections
      required:
        - id
        - entityId
        - entityType
        - legs
        - currentLegIndex
        - primaryModeCode
        - effectiveSpeedKmPerGameHour
        - plannedDepartureGameTime
        - estimatedArrivalGameTime
        - originLocationId
        - destinationLocationId
        - currentLocationId
        - status
        - interruptions
        - partySize
        - cargoWeightKg
        - createdAt
        - modifiedAt
      properties:
        id:
          type: string
          format: uuid
          description: Unique identifier for this journey
        entityId:
          type: string
          format: uuid
          description: Entity that is traveling
        entityType:
          type: string
          description: Type of traveling entity (e.g., "character", "npc", "caravan", "army", "creature"). Category B content code.
        legs:
          type: array
          description: Ordered list of connections to traverse
          items:
            $ref: '#/components/schemas/TransitJourneyLeg'
        currentLegIndex:
          type: integer
          description: Which leg the entity is currently on (0-based)
        primaryModeCode:
          type: string
          description: Primary transit mode for this journey
        effectiveSpeedKmPerGameHour:
          type: number
          format: decimal
          description: Current effective speed accounting for modifiers
        plannedDepartureGameTime:
          type: number
          format: decimal
          description: Game-time timestamp of planned departure
        actualDepartureGameTime:
          type: number
          format: decimal
          nullable: true
          description: Game-time timestamp of actual departure. Null if not yet departed.
        estimatedArrivalGameTime:
          type: number
          format: decimal
          description: Estimated arrival game-time based on route, speed, and worldstate
        actualArrivalGameTime:
          type: number
          format: decimal
          nullable: true
          description: Game-time timestamp of actual arrival. Null if not yet arrived.
        originLocationId:
          type: string
          format: uuid
          description: Starting location
        destinationLocationId:
          type: string
          format: uuid
          description: Final destination
        currentLocationId:
          type: string
          format: uuid
          description: Last known position (most recently departed-from or arrived-at location)
        status:
          allOf:
            - $ref: '#/components/schemas/JourneyStatus'
          description: Current journey lifecycle status
        statusReason:
          type: string
          nullable: true
          description: Reason for interruption or abandonment. Null for normal status transitions.
        interruptions:
          type: array
          description: Recorded interruptions during this journey
          items:
            $ref: '#/components/schemas/TransitInterruption'
        partySize:
          type: integer
          minimum: 1
          description: Number of entities traveling together
        cargoWeightKg:
          type: number
          format: decimal
          minimum: 0
          description: Total cargo weight affecting speed on some modes
        createdAt:
          type: string
          format: date-time
          description: When this journey was created
        modifiedAt:
          type: string
          format: date-time
          description: When this journey was last modified

    TransitRouteOption:
      type: object
      additionalProperties: false
      description: A computed route option returned by route calculation (not persisted)
      required:
        - waypoints
        - connections
        - legCount
        - primaryModeCode
        - legModes
        - totalDistanceKm
        - totalGameHours
        - totalRealMinutes
        - averageRisk
        - maxLegRisk
        - allLegsOpen
        - rank
      properties:
        waypoints:
          type: array
          description: Ordered location IDs from source to destination
          items:
            type: string
            format: uuid
        connections:
          type: array
          description: Ordered connection IDs
          items:
            type: string
            format: uuid
        legCount:
          type: integer
          description: Number of legs in this route
        primaryModeCode:
          type: string
          description: Dominant transit mode for this option
        legModes:
          type: array
          description: Per-leg mode codes (may differ from primary on multi-modal routes)
          items:
            type: string
        totalDistanceKm:
          type: number
          format: decimal
          description: Sum of all leg distances in game-kilometers
        totalGameHours:
          type: number
          format: decimal
          description: Estimated total travel time in game-hours (includes waypoint transfer times)
        totalRealMinutes:
          type: number
          format: decimal
          description: Approximate real-time equivalent at current time ratio (may change during travel)
        averageRisk:
          type: number
          format: decimal
          description: Weighted average risk across legs
        maxLegRisk:
          type: number
          format: decimal
          description: Highest risk on any single leg
        allLegsOpen:
          type: boolean
          description: Whether all legs are currently open
        seasonalWarnings:
          type: array
          nullable: true
          description: Warnings for legs with upcoming seasonal closures. Null means no warnings.
          items:
            $ref: '#/components/schemas/SeasonalRouteWarning'
        rank:
          type: integer
          description: Rank within results (1 = best option by sort criteria)

    # ── Request Models ───────────────────────────────────────────────────

    RegisterModeRequest:
      type: object
      additionalProperties: false
      description: Request to register a new transit mode
      required:
        - code
        - name
        - description
        - baseSpeedKmPerGameHour
        - passengerCapacity
        - cargoCapacityKg
        - compatibleTerrainTypes
        - requirements
        - fatigueRatePerGameHour
        - noiseLevelNormalized
      properties:
        code:
          type: string
          description: Unique mode code (e.g., "walking", "horseback", "wagon")
        name:
          type: string
          description: Human-readable display name
        description:
          type: string
          description: Detailed description of this transit mode
        baseSpeedKmPerGameHour:
          type: number
          format: decimal
          minimum: 0.1
          description: Base speed in game-kilometers per game-hour
        terrainSpeedModifiers:
          type: array
          nullable: true
          description: Per-terrain speed multipliers. Null means base speed applies uniformly.
          items:
            $ref: '#/components/schemas/TerrainSpeedModifier'
        passengerCapacity:
          type: integer
          minimum: 1
          description: How many entities can ride
        cargoCapacityKg:
          type: number
          format: decimal
          minimum: 0
          description: Weight capacity in game-kg
        cargoSpeedPenaltyRate:
          type: number
          format: decimal
          nullable: true
          minimum: 0
          maximum: 1
          description: Per-mode cargo speed penalty rate override. Null means use plugin config default.
        compatibleTerrainTypes:
          type: array
          description: Terrain types this mode can traverse. Empty array means all terrain.
          items:
            type: string
        validEntityTypes:
          type: array
          nullable: true
          description: Entity types allowed to use this mode. Null means no restriction.
          items:
            type: string
        requirements:
          allOf:
            - $ref: '#/components/schemas/TransitModeRequirements'
          description: Requirements that must be met to use this mode
        fatigueRatePerGameHour:
          type: number
          format: decimal
          minimum: 0
          description: Stamina cost per game-hour of travel
        noiseLevelNormalized:
          type: number
          format: decimal
          minimum: 0
          maximum: 1
          description: Noise level from 0.0 (silent) to 1.0 (loud)
        realmRestrictions:
          type: array
          nullable: true
          description: Realm IDs where this mode is available. Null means all realms.
          items:
            type: string
            format: uuid
        tags:
          type: array
          nullable: true
          description: Freeform classification tags
          items:
            type: string

    GetModeRequest:
      type: object
      additionalProperties: false
      description: Request to get a transit mode by code
      required:
        - code
      properties:
        code:
          type: string
          description: Transit mode code to look up

    ListModesRequest:
      type: object
      additionalProperties: false
      description: Request to list transit modes with optional filters
      properties:
        realmId:
          type: string
          format: uuid
          nullable: true
          description: Filter by realm availability
        terrainType:
          type: string
          nullable: true
          description: Filter by terrain compatibility
        tags:
          type: array
          nullable: true
          description: Filter by tags (modes matching any tag are included)
          items:
            type: string
        includeDeprecated:
          type: boolean
          default: false
          description: Whether to include deprecated modes in results

    UpdateModeRequest:
      type: object
      additionalProperties: false
      description: Request to update a transit mode. Only provided fields are updated.
      required:
        - code
      properties:
        code:
          type: string
          description: Mode code to update (identifier, not updatable)
        name:
          type: string
          nullable: true
          description: Updated display name
        description:
          type: string
          nullable: true
          description: Updated description
        baseSpeedKmPerGameHour:
          type: number
          format: decimal
          nullable: true
          minimum: 0.1
          description: Updated base speed
        terrainSpeedModifiers:
          type: array
          nullable: true
          description: Updated per-terrain speed multipliers
          items:
            $ref: '#/components/schemas/TerrainSpeedModifier'
        passengerCapacity:
          type: integer
          nullable: true
          minimum: 1
          description: Updated passenger capacity
        cargoCapacityKg:
          type: number
          format: decimal
          nullable: true
          minimum: 0
          description: Updated cargo capacity
        cargoSpeedPenaltyRate:
          type: number
          format: decimal
          nullable: true
          minimum: 0
          maximum: 1
          description: Updated per-mode cargo speed penalty rate
        compatibleTerrainTypes:
          type: array
          nullable: true
          description: Updated terrain compatibility list
          items:
            type: string
        validEntityTypes:
          type: array
          nullable: true
          description: Updated entity type restrictions
          items:
            type: string
        requirements:
          allOf:
            - $ref: '#/components/schemas/TransitModeRequirements'
          nullable: true
          description: Updated mode requirements
        fatigueRatePerGameHour:
          type: number
          format: decimal
          nullable: true
          minimum: 0
          description: Updated fatigue rate
        noiseLevelNormalized:
          type: number
          format: decimal
          nullable: true
          minimum: 0
          maximum: 1
          description: Updated noise level
        realmRestrictions:
          type: array
          nullable: true
          description: Updated realm restrictions
          items:
            type: string
            format: uuid
        tags:
          type: array
          nullable: true
          description: Updated tags
          items:
            type: string

    DeprecateModeRequest:
      type: object
      additionalProperties: false
      description: Request to deprecate a transit mode
      required:
        - code
        - reason
      properties:
        code:
          type: string
          description: Mode code to deprecate
        reason:
          type: string
          description: Why this mode is being deprecated

    UndeprecateModeRequest:
      type: object
      additionalProperties: false
      description: Request to reverse deprecation of a transit mode
      required:
        - code
      properties:
        code:
          type: string
          description: Mode code to undeprecate

    DeleteModeRequest:
      type: object
      additionalProperties: false
      description: Request to delete a deprecated transit mode
      required:
        - code
      properties:
        code:
          type: string
          description: Mode code to delete

    CheckModeAvailabilityRequest:
      type: object
      additionalProperties: false
      description: Request to check which transit modes an entity can use
      required:
        - entityId
        - entityType
      properties:
        entityId:
          type: string
          format: uuid
          description: Entity to check availability for
        entityType:
          type: string
          description: Type of entity (e.g., "character", "npc", "caravan")
        locationId:
          type: string
          format: uuid
          nullable: true
          description: Only check modes available at this location
        modeCode:
          type: string
          nullable: true
          description: Check specific mode only (omit to check all modes)

    CreateConnectionRequest:
      type: object
      additionalProperties: false
      description: Request to create a connection between two locations
      required:
        - fromLocationId
        - toLocationId
        - bidirectional
        - distanceKm
        - terrainType
        - compatibleModes
        - baseRiskLevel
      properties:
        fromLocationId:
          type: string
          format: uuid
          description: Starting location ID
        toLocationId:
          type: string
          format: uuid
          description: Ending location ID
        bidirectional:
          type: boolean
          description: Whether the connection is traversable both ways
        distanceKm:
          type: number
          format: decimal
          minimum: 0.01
          description: Distance in game-kilometers
        terrainType:
          type: string
          description: Terrain type code. Category B content code.
        compatibleModes:
          type: array
          description: Transit mode codes that can use this connection
          items:
            type: string
        seasonalAvailability:
          type: array
          nullable: true
          description: Per-season availability restrictions. Season keys validated against realm's Worldstate seasons.
          items:
            $ref: '#/components/schemas/SeasonalAvailabilityEntry'
        baseRiskLevel:
          type: number
          format: decimal
          minimum: 0
          maximum: 1
          description: Base risk level from 0.0 (safe) to 1.0 (extremely dangerous)
        riskDescription:
          type: string
          nullable: true
          description: Human-readable risk description
        discoverable:
          type: boolean
          default: false
          description: Whether this connection requires discovery to appear in route queries
        name:
          type: string
          nullable: true
          description: Human-readable connection name
        code:
          type: string
          nullable: true
          description: Unique code for lookup
        tags:
          type: array
          nullable: true
          description: Freeform classification tags
          items:
            type: string

    GetConnectionRequest:
      type: object
      additionalProperties: false
      description: Request to get a connection by ID or code. One of connectionId or code must be provided.
      properties:
        connectionId:
          type: string
          format: uuid
          nullable: true
          description: Connection ID to look up
        code:
          type: string
          nullable: true
          description: Connection code to look up

    QueryConnectionsRequest:
      type: object
      additionalProperties: false
      description: Request to query connections with optional filters
      properties:
        fromLocationId:
          type: string
          format: uuid
          nullable: true
          description: Filter to connections FROM this location
        toLocationId:
          type: string
          format: uuid
          nullable: true
          description: Filter to connections TO this location
        locationId:
          type: string
          format: uuid
          nullable: true
          description: Filter to connections involving this location (either end)
        realmId:
          type: string
          format: uuid
          nullable: true
          description: Filter to connections touching this realm
        crossRealm:
          type: boolean
          nullable: true
          description: Filter to only cross-realm (true) or intra-realm (false) connections
        terrainType:
          type: string
          nullable: true
          description: Filter by terrain type
        modeCode:
          type: string
          nullable: true
          description: Filter by mode compatibility
        status:
          allOf:
            - $ref: '#/components/schemas/ConnectionStatus'
          nullable: true
          description: Filter by connection status
        tags:
          type: array
          nullable: true
          description: Filter by tags
          items:
            type: string
        includeSeasonalClosed:
          type: boolean
          default: true
          description: Whether to include seasonally closed connections
        page:
          type: integer
          minimum: 1
          default: 1
          description: Page number (1-indexed)
        pageSize:
          type: integer
          minimum: 1
          maximum: 100
          default: 20
          description: Number of results per page

    UpdateConnectionRequest:
      type: object
      additionalProperties: false
      description: Request to update a connection's properties. Does not update status. Only provided fields are updated.
      required:
        - connectionId
      properties:
        connectionId:
          type: string
          format: uuid
          description: Connection to update
        distanceKm:
          type: number
          format: decimal
          nullable: true
          minimum: 0.01
          description: Updated distance
        terrainType:
          type: string
          nullable: true
          description: Updated terrain type
        compatibleModes:
          type: array
          nullable: true
          description: Updated mode compatibility list
          items:
            type: string
        seasonalAvailability:
          type: array
          nullable: true
          description: Updated seasonal availability
          items:
            $ref: '#/components/schemas/SeasonalAvailabilityEntry'
        baseRiskLevel:
          type: number
          format: decimal
          nullable: true
          minimum: 0
          maximum: 1
          description: Updated base risk level
        riskDescription:
          type: string
          nullable: true
          description: Updated risk description
        discoverable:
          type: boolean
          nullable: true
          description: Updated discoverability flag
        name:
          type: string
          nullable: true
          description: Updated connection name
        code:
          type: string
          nullable: true
          description: Updated connection code
        tags:
          type: array
          nullable: true
          description: Updated tags
          items:
            type: string

    UpdateConnectionStatusRequest:
      type: object
      additionalProperties: false
      description: Request to transition a connection's operational status with optimistic concurrency
      required:
        - connectionId
        - newStatus
        - reason
      properties:
        connectionId:
          type: string
          format: uuid
          description: Connection to update
        currentStatus:
          allOf:
            - $ref: '#/components/schemas/ConnectionStatus'
          nullable: true
          description: What the caller believes the current status is. Required when forceUpdate is false. Ignored when forceUpdate is true.
        newStatus:
          allOf:
            - $ref: '#/components/schemas/SettableConnectionStatus'
          description: Target status for the connection (seasonal_closed is excluded -- managed by the Seasonal Connection Worker)
        reason:
          type: string
          description: Why the status is changing
        forceUpdate:
          type: boolean
          default: false
          description: When true, currentStatus is ignored and the status is set unconditionally. Use for administrative overrides.

    DeleteConnectionRequest:
      type: object
      additionalProperties: false
      description: Request to delete a connection
      required:
        - connectionId
      properties:
        connectionId:
          type: string
          format: uuid
          description: Connection to delete

    BulkSeedConnectionsRequest:
      type: object
      additionalProperties: false
      description: Request to seed connections from configuration
      required:
        - connections
      properties:
        realmId:
          type: string
          format: uuid
          nullable: true
          description: Scope location code resolution to this realm. When provided, replaceExisting deletes connections for this realm only.
        connections:
          type: array
          description: Connection entries to seed
          items:
            $ref: '#/components/schemas/BulkSeedConnectionEntry'
        replaceExisting:
          type: boolean
          default: false
          description: If true, delete existing connections scoped by realmId before seeding

    CreateJourneyRequest:
      type: object
      additionalProperties: false
      description: Request to plan a journey (creates in preparing status)
      required:
        - entityId
        - entityType
        - originLocationId
        - destinationLocationId
        - primaryModeCode
      properties:
        entityId:
          type: string
          format: uuid
          description: Entity that will travel
        entityType:
          type: string
          description: Type of traveling entity (e.g., "character", "npc", "caravan")
        originLocationId:
          type: string
          format: uuid
          description: Starting location
        destinationLocationId:
          type: string
          format: uuid
          description: Final destination
        primaryModeCode:
          type: string
          description: Preferred transit mode. Used for all legs unless overridden by multi-modal.
        preferMultiModal:
          type: boolean
          default: false
          description: When true, route calculation selects the best mode per leg
        plannedDepartureGameTime:
          type: number
          format: decimal
          nullable: true
          description: Planned departure game-time. Defaults to current game-time if null.
        partySize:
          type: integer
          minimum: 1
          default: 1
          description: Number of entities traveling together
        cargoWeightKg:
          type: number
          format: decimal
          minimum: 0
          default: 0
          description: Total cargo weight in game-kg

    DepartJourneyRequest:
      type: object
      additionalProperties: false
      description: Request to start a prepared journey
      required:
        - journeyId
      properties:
        journeyId:
          type: string
          format: uuid
          description: Journey to start

    ResumeJourneyRequest:
      type: object
      additionalProperties: false
      description: Request to resume an interrupted journey
      required:
        - journeyId
      properties:
        journeyId:
          type: string
          format: uuid
          description: Journey to resume

    AdvanceJourneyRequest:
      type: object
      additionalProperties: false
      description: Request to mark arrival at the next waypoint
      required:
        - journeyId
        - arrivedAtGameTime
      properties:
        journeyId:
          type: string
          format: uuid
          description: Journey to advance
        arrivedAtGameTime:
          type: number
          format: decimal
          description: Game-time when the waypoint was reached
        incidents:
          type: array
          nullable: true
          description: Events that occurred during this leg
          items:
            $ref: '#/components/schemas/JourneyIncident'

    AdvanceBatchRequest:
      type: object
      additionalProperties: false
      description: Request to advance multiple journeys in a single call
      required:
        - advances
      properties:
        advances:
          type: array
          description: Individual advance entries
          items:
            $ref: '#/components/schemas/BatchAdvanceEntry'

    ArriveJourneyRequest:
      type: object
      additionalProperties: false
      description: Request to force-arrive a journey at destination (skips remaining legs)
      required:
        - journeyId
        - arrivedAtGameTime
        - reason
      properties:
        journeyId:
          type: string
          format: uuid
          description: Journey to force-arrive
        arrivedAtGameTime:
          type: number
          format: decimal
          description: Game-time of arrival
        reason:
          type: string
          description: Why legs were skipped (e.g., "teleported", "fast_travel", "narrative")

    InterruptJourneyRequest:
      type: object
      additionalProperties: false
      description: Request to interrupt an active journey
      required:
        - journeyId
        - reason
        - gameTime
      properties:
        journeyId:
          type: string
          format: uuid
          description: Journey to interrupt
        reason:
          type: string
          description: Reason for interruption (e.g., "bandit_attack", "storm", "breakdown")
        gameTime:
          type: number
          format: decimal
          description: Game-time when the interruption occurred

    AbandonJourneyRequest:
      type: object
      additionalProperties: false
      description: Request to abandon a journey
      required:
        - journeyId
        - reason
      properties:
        journeyId:
          type: string
          format: uuid
          description: Journey to abandon
        reason:
          type: string
          description: Reason for abandonment

    GetJourneyRequest:
      type: object
      additionalProperties: false
      description: Request to get a journey by ID
      required:
        - journeyId
      properties:
        journeyId:
          type: string
          format: uuid
          description: Journey to retrieve

    QueryJourneysByConnectionRequest:
      type: object
      additionalProperties: false
      description: Request to list active journeys on a specific connection
      required:
        - connectionId
      properties:
        connectionId:
          type: string
          format: uuid
          description: Connection to query journeys for
        status:
          allOf:
            - $ref: '#/components/schemas/JourneyStatus'
          nullable: true
          description: Filter by journey status (defaults to in_transit in service logic)
        page:
          type: integer
          minimum: 1
          default: 1
          description: Page number (1-indexed)
        pageSize:
          type: integer
          minimum: 1
          maximum: 100
          default: 20
          description: Number of results per page

    ListJourneysRequest:
      type: object
      additionalProperties: false
      description: Request to list journeys with optional filters
      properties:
        entityId:
          type: string
          format: uuid
          nullable: true
          description: Filter to journeys for this entity
        entityType:
          type: string
          nullable: true
          description: Filter by entity type
        realmId:
          type: string
          format: uuid
          nullable: true
          description: Filter to journeys touching this realm (origin or destination)
        crossRealm:
          type: boolean
          nullable: true
          description: Filter to cross-realm journeys only
        status:
          allOf:
            - $ref: '#/components/schemas/JourneyStatus'
          nullable: true
          description: Filter by journey status
        activeOnly:
          type: boolean
          default: true
          description: When true, excludes arrived and abandoned journeys
        page:
          type: integer
          minimum: 1
          default: 1
          description: Page number (1-indexed)
        pageSize:
          type: integer
          minimum: 1
          maximum: 100
          default: 20
          description: Number of results per page

    QueryJourneyArchiveRequest:
      type: object
      additionalProperties: false
      description: Request to query archived journeys from MySQL historical store
      properties:
        entityId:
          type: string
          format: uuid
          nullable: true
          description: Filter by entity
        entityType:
          type: string
          nullable: true
          description: Filter by entity type
        realmId:
          type: string
          format: uuid
          nullable: true
          description: Filter to journeys touching this realm
        crossRealm:
          type: boolean
          nullable: true
          description: Filter to cross-realm journeys only
        originLocationId:
          type: string
          format: uuid
          nullable: true
          description: Filter by origin location
        destinationLocationId:
          type: string
          format: uuid
          nullable: true
          description: Filter by destination location
        modeCode:
          type: string
          nullable: true
          description: Filter by primary mode code
        status:
          allOf:
            - $ref: '#/components/schemas/JourneyStatus'
          nullable: true
          description: Filter by status (typically arrived or abandoned)
        fromGameTime:
          type: number
          format: decimal
          nullable: true
          description: Filter to journeys departed after this game-time
        toGameTime:
          type: number
          format: decimal
          nullable: true
          description: Filter to journeys departed before this game-time
        page:
          type: integer
          minimum: 1
          default: 1
          description: Page number (1-indexed)
        pageSize:
          type: integer
          minimum: 1
          maximum: 100
          default: 20
          description: Number of results per page

    CalculateRouteRequest:
      type: object
      additionalProperties: false
      description: Request to calculate route options between two locations (pure computation)
      required:
        - fromLocationId
        - toLocationId
      properties:
        fromLocationId:
          type: string
          format: uuid
          description: Starting location
        toLocationId:
          type: string
          format: uuid
          description: Destination location
        modeCode:
          type: string
          nullable: true
          description: Specific mode to calculate for. Null means try all modes.
        preferMultiModal:
          type: boolean
          default: false
          description: When true, selects best mode per leg
        entityId:
          type: string
          format: uuid
          nullable: true
          description: Entity for discovery filtering. When provided, discoverable connections are filtered to only those this entity has discovered. Null means discoverable connections are excluded entirely.
        maxLegs:
          type: integer
          nullable: true
          minimum: 1
          description: Maximum legs to consider. Uses service config default if null.
        sortBy:
          allOf:
            - $ref: '#/components/schemas/RouteSortBy'
          nullable: true
          description: Sort criteria for results. Defaults to fastest.
        maxOptions:
          type: integer
          nullable: true
          minimum: 1
          description: Maximum route options to return. Uses service config default if null.
        includeSeasonalClosed:
          type: boolean
          default: false
          description: Whether to include currently seasonally closed routes

    RevealDiscoveryRequest:
      type: object
      additionalProperties: false
      description: Request to reveal a discoverable connection to an entity
      required:
        - entityId
        - connectionId
        - source
      properties:
        entityId:
          type: string
          format: uuid
          description: Entity to reveal the connection to
        connectionId:
          type: string
          format: uuid
          description: Discoverable connection to reveal
        source:
          type: string
          description: How the connection was discovered (e.g., "travel", "guide", "hearsay", "map", "quest_reward")

    ListDiscoveriesRequest:
      type: object
      additionalProperties: false
      description: Request to list connections an entity has discovered
      required:
        - entityId
      properties:
        entityId:
          type: string
          format: uuid
          description: Entity to list discoveries for
        realmId:
          type: string
          format: uuid
          nullable: true
          description: Filter by realm (fromRealmId or toRealmId)

    CheckDiscoveriesRequest:
      type: object
      additionalProperties: false
      description: Request to check if an entity has discovered specific connections
      required:
        - entityId
        - connectionIds
      properties:
        entityId:
          type: string
          format: uuid
          description: Entity to check discoveries for
        connectionIds:
          type: array
          description: Connection IDs to check
          items:
            type: string
            format: uuid

    CleanupByLocationRequest:
      type: object
      additionalProperties: false
      description: Internal cleanup request when a location is deleted via lib-resource
      required:
        - locationId
      properties:
        locationId:
          type: string
          format: uuid
          description: Deleted location ID

    CleanupByCharacterRequest:
      type: object
      additionalProperties: false
      description: Internal cleanup request when a character is deleted via lib-resource
      required:
        - characterId
      properties:
        characterId:
          type: string
          format: uuid
          description: Deleted character ID

    # ── Response Models ──────────────────────────────────────────────────

    ModeResponse:
      type: object
      additionalProperties: false
      description: Response containing a single transit mode
      required:
        - mode
      properties:
        mode:
          allOf:
            - $ref: '#/components/schemas/TransitMode'
          description: The transit mode

    ListModesResponse:
      type: object
      additionalProperties: false
      description: Response containing a list of transit modes
      required:
        - modes
      properties:
        modes:
          type: array
          description: Transit modes matching the query
          items:
            $ref: '#/components/schemas/TransitMode'

    DeleteModeResponse:
      type: object
      additionalProperties: false
      description: Confirms successful mode deletion
      properties: {}

    ConnectionResponse:
      type: object
      additionalProperties: false
      description: Response containing a single transit connection
      required:
        - connection
      properties:
        connection:
          allOf:
            - $ref: '#/components/schemas/TransitConnection'
          description: The transit connection

    QueryConnectionsResponse:
      type: object
      additionalProperties: false
      description: Response containing a paginated list of connections
      required:
        - connections
        - totalCount
      properties:
        connections:
          type: array
          description: Connections matching the query
          items:
            $ref: '#/components/schemas/TransitConnection'
        totalCount:
          type: integer
          minimum: 0
          description: Total matching connections across all pages

    DeleteConnectionResponse:
      type: object
      additionalProperties: false
      description: Confirms successful connection deletion
      properties: {}

    BulkSeedConnectionsResponse:
      type: object
      additionalProperties: false
      description: Response from bulk seed operation
      required:
        - created
        - updated
        - errors
      properties:
        created:
          type: integer
          minimum: 0
          description: Number of connections created
        updated:
          type: integer
          minimum: 0
          description: Number of connections updated
        errors:
          type: array
          description: Error messages for individual entries that failed
          items:
            type: string

    JourneyResponse:
      type: object
      additionalProperties: false
      description: Response containing a single transit journey
      required:
        - journey
      properties:
        journey:
          allOf:
            - $ref: '#/components/schemas/TransitJourney'
          description: The transit journey

    ListJourneysResponse:
      type: object
      additionalProperties: false
      description: Response containing a paginated list of journeys
      required:
        - journeys
        - totalCount
      properties:
        journeys:
          type: array
          description: Journeys matching the query
          items:
            $ref: '#/components/schemas/TransitJourney'
        totalCount:
          type: integer
          minimum: 0
          description: Total matching journeys across all pages

    AdvanceBatchResponse:
      type: object
      additionalProperties: false
      description: Response from batch advance operation with per-journey results
      required:
        - results
      properties:
        results:
          type: array
          description: Per-journey advance results
          items:
            $ref: '#/components/schemas/BatchAdvanceResult'

    CalculateRouteResponse:
      type: object
      additionalProperties: false
      description: Response containing calculated route options
      required:
        - options
      properties:
        options:
          type: array
          description: Route options ranked by sort criteria
          items:
            $ref: '#/components/schemas/TransitRouteOption'

    CheckModeAvailabilityResponse:
      type: object
      additionalProperties: false
      description: Response containing mode availability results for an entity
      required:
        - availableModes
      properties:
        availableModes:
          type: array
          description: Availability status for each checked mode
          items:
            $ref: '#/components/schemas/ModeAvailabilityResult'

    RevealDiscoveryResponse:
      type: object
      additionalProperties: false
      description: Response containing the discovery record
      required:
        - discovery
      properties:
        discovery:
          allOf:
            - $ref: '#/components/schemas/DiscoveryRecord'
          description: The discovery record

    ListDiscoveriesResponse:
      type: object
      additionalProperties: false
      description: Response containing discovered connection IDs
      required:
        - connectionIds
      properties:
        connectionIds:
          type: array
          description: IDs of connections this entity has discovered
          items:
            type: string
            format: uuid

    CheckDiscoveriesResponse:
      type: object
      additionalProperties: false
      description: Response containing discovery check results
      required:
        - results
      properties:
        results:
          type: array
          description: Per-connection discovery status
          items:
            $ref: '#/components/schemas/DiscoveryCheckResult'
