openapi: 3.0.4
info:
  title: Obligation Service Configuration
  description: |
    Configuration schema for Obligation service.
    Properties are bound to environment variables with OBLIGATION_ prefix.

    **SCHEMA MODIFICATION GATE**: STOP. Before modifying this schema, you MUST:
    1. Read docs/reference/SCHEMA-RULES.md
    2. State which section applies to your change
    3. Only then proceed with edits
    Edits without stating the applicable rule are FORBIDDEN.
  version: 1.0.0
paths: {}
x-service-configuration:
  properties:
    # Cache Configuration
    CacheTtlMinutes:
      type: integer
      description: TTL in minutes for obligation manifest cache entries per character
      default: 10
      minimum: 1
      maximum: 1440
      env: OBLIGATION_CACHE_TTL_MINUTES

    # Evaluation Configuration
    MaxObligationsPerCharacter:
      type: integer
      description: Safety limit on cached obligations per character (prevents runaway contract accumulation)
      default: 200
      minimum: 10
      maximum: 1000
      env: OBLIGATION_MAX_OBLIGATIONS_PER_CHARACTER

    # Violation Configuration
    BreachReportEnabled:
      type: boolean
      description: Whether to auto-report violations as breaches to the contract service
      default: true
      env: OBLIGATION_BREACH_REPORT_ENABLED

    IdempotencyTtlSeconds:
      type: integer
      description: TTL in seconds for violation report idempotency keys
      default: 86400
      minimum: 3600
      maximum: 604800
      env: OBLIGATION_IDEMPOTENCY_TTL_SECONDS

    # Pagination
    DefaultPageSize:
      type: integer
      description: Default page size for paginated queries
      default: 20
      minimum: 1
      maximum: 100
      env: OBLIGATION_DEFAULT_PAGE_SIZE

    # Distributed Lock Configuration
    LockTimeoutSeconds:
      type: integer
      description: Timeout in seconds for distributed locks on obligation cache operations
      default: 30
      minimum: 5
      maximum: 120
      env: OBLIGATION_LOCK_TIMEOUT_SECONDS

    # Contract Query Configuration
    MaxActiveContractsQuery:
      type: integer
      description: Maximum number of active contracts to query per character during cache rebuild
      default: 100
      minimum: 10
      maximum: 500
      env: OBLIGATION_MAX_ACTIVE_CONTRACTS_QUERY

    # Norm Resolution Configuration
    NormResolutionMode:
      type: string
      description: |
        How norm-based obligation costs are resolved when the Hearsay service is unavailable.
        PerfectKnowledge: Query Faction directly for ground-truth norms (NPC knows all applicable norms instantly).
        UncertaintySimulation: Apply a configurable random variance to norm penalties, simulating imperfect social knowledge without Hearsay's full belief propagation system.
        When Hearsay IS available, this setting is ignored and belief-filtered costs are used instead.
      default: PerfectKnowledge
      enum:
        - PerfectKnowledge
        - UncertaintySimulation
      env: OBLIGATION_NORM_RESOLUTION_MODE

    NormUncertaintyVariance:
      type: number
      format: float
      description: |
        Maximum variance applied to norm penalties when NormResolutionMode is UncertaintySimulation.
        A value of 0.3 means penalties are randomly adjusted by up to +/-30% per evaluation.
        Only used when NormResolutionMode is UncertaintySimulation; ignored in PerfectKnowledge mode.
      default: 0.2
      minimum: 0.0
      maximum: 0.5
      env: OBLIGATION_NORM_UNCERTAINTY_VARIANCE
