openapi: 3.0.4
info:
  title: Bannou Species Service API
  description: |
    Species management service for game worlds.

    **POST-Only API Pattern**: This API uses POST for all operations to support zero-copy
    WebSocket routing. Path parameters are passed in request bodies instead of URLs.
    See docs/BANNOU_DESIGN.md for architectural rationale.

    Species define the playable and NPC races in each realm. Each species has unique
    traits, abilities, and cultural characteristics. Species are realm-specific,
    allowing different realms to have distinct species populations.

    **Realm Association**: Each species belongs to one or more realms, enabling
    cross-realm species (e.g., humans in all realms) and realm-specific species
    (e.g., elves only in a specific realm).

    **Trait System**: Species define base trait modifiers that affect character
    creation and development.

    **Deprecation System**: Species can be deprecated instead of deleted directly.
    Deprecated species remain queryable but cannot be used for new characters.
    Use the merge endpoint to migrate characters from deprecated species to active ones.
    The special VOID species serves as a sink for characters whose species should be removed.

    **Two-Step Deletion**:
    1. Deprecate the species (soft delete, prevents new usage)
    2. Merge deprecated species into another species (or VOID to effectively delete)
    3. Optionally hard-delete the deprecated species after merge

    **SCHEMA MODIFICATION GATE**: STOP. Before modifying this schema, you MUST:
    1. Read docs/reference/SCHEMA-RULES.md
    2. State which section applies to your change
    3. Only then proceed with edits
    Edits without stating the applicable rule are FORBIDDEN.
  version: 2.0.0
x-service-layer: GameFoundation
servers:
- url: http://localhost:5012
  description: Bannou service endpoint (internal only)

# NOTE: x-lifecycle moved to species-events.yaml

paths:
  /species/get:
    post:
      summary: Get species by ID
      operationId: getSpecies
      tags:
      - Species
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetSpeciesRequest'
      responses:
        '200':
          description: Species retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SpeciesResponse'
        '404':
          description: Species not found

  /species/get-by-code:
    post:
      summary: Get species by code
      description: Retrieve a species using its unique code (e.g., "HUMAN", "ELF", "DWARF")
      operationId: getSpeciesByCode
      tags:
      - Species
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetSpeciesByCodeRequest'
      responses:
        '200':
          description: Species retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SpeciesResponse'
        '404':
          description: Species not found

  /species/list:
    post:
      summary: List all species
      description: Retrieve all species with optional realm filtering
      operationId: listSpecies
      tags:
      - Species
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ListSpeciesRequest'
      responses:
        '200':
          description: Species retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SpeciesListResponse'

  /species/list-by-realm:
    post:
      summary: List species available in a realm
      description: Retrieve all species that are available in a specific realm
      operationId: listSpeciesByRealm
      tags:
      - Species
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ListSpeciesByRealmRequest'
      responses:
        '200':
          description: Species retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SpeciesListResponse'
        '404':
          description: Realm not found

  /species/create:
    post:
      summary: Create new species
      operationId: createSpecies
      tags:
      - Species Admin
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateSpeciesRequest'
      responses:
        '200':
          description: Species created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SpeciesResponse'
        '400':
          description: Invalid species data
        '409':
          description: Species with this code already exists

  /species/update:
    post:
      summary: Update species
      operationId: updateSpecies
      tags:
      - Species Admin
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateSpeciesRequest'
      responses:
        '200':
          description: Species updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SpeciesResponse'
        '404':
          description: Species not found
        '400':
          description: Invalid update data

  /species/delete:
    post:
      summary: Delete species
      description: |
        Hard delete a species. This will fail if the species is still in use.
        For safe removal, first deprecate the species, then merge it into another species
        (or VOID), then delete. Only deprecated species with zero references can be deleted.
      operationId: deleteSpecies
      tags:
      - Species Admin
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeleteSpeciesRequest'
      responses:
        '200':
          description: Species deleted successfully
        '404':
          description: Species not found
        '409':
          description: Cannot delete - species is in use by characters

  /species/deprecate:
    post:
      summary: Deprecate a species
      description: |
        Soft-delete a species by marking it as deprecated.
        Deprecated species:
        - Remain queryable for historical data
        - Cannot be used for creating new characters
        - Can be merged into other species using the merge endpoint
        - Can be hard-deleted after all references are removed
      operationId: deprecateSpecies
      tags:
      - Species Admin
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeprecateSpeciesRequest'
      responses:
        '200':
          description: Species deprecated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SpeciesResponse'
        '404':
          description: Species not found

  /species/undeprecate:
    post:
      summary: Restore a deprecated species
      description: |
        Remove the deprecated status from a species, making it
        available for new characters again.
      operationId: undeprecateSpecies
      tags:
      - Species Admin
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UndeprecateSpeciesRequest'
      responses:
        '200':
          description: Species restored successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SpeciesResponse'
        '404':
          description: Species not found

  /species/merge:
    post:
      summary: Merge a deprecated species into another species
      description: |
        Migrate all characters using a deprecated species to a target species.
        This is the recommended way to handle species removal:
        1. Deprecate the source species
        2. Merge into the target species (or VOID for effective deletion)
        3. Optionally hard-delete the now-empty deprecated species

        The merge operation:
        - Updates all characters using sourceSpeciesId to use targetSpeciesId
        - Publishes events for each affected character
        - Returns count of migrated characters
        - Fails if source is not deprecated (safety check)
      operationId: mergeSpecies
      tags:
      - Species Admin
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MergeSpeciesRequest'
      responses:
        '200':
          description: Merge completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MergeSpeciesResponse'
        '404':
          description: Source or target species not found
        '400':
          description: Source species must be deprecated before merging
        '409':
          description: Cannot merge into a deprecated species

  /species/add-to-realm:
    post:
      summary: Add species to a realm
      description: Make a species available in an additional realm
      operationId: addSpeciesToRealm
      tags:
      - Species Admin
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddSpeciesToRealmRequest'
      responses:
        '200':
          description: Species added to realm successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SpeciesResponse'
        '404':
          description: Species or realm not found
        '409':
          description: Species already in realm

  /species/remove-from-realm:
    post:
      summary: Remove species from a realm
      description: Remove a species from a realm (species must not have characters in that realm)
      operationId: removeSpeciesFromRealm
      tags:
      - Species Admin
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RemoveSpeciesFromRealmRequest'
      responses:
        '200':
          description: Species removed from realm successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SpeciesResponse'
        '404':
          description: Species not found or not in realm
        '409':
          description: Cannot remove - characters of this species exist in realm

  /species/seed:
    post:
      summary: Seed species from configuration
      description: |
        Idempotent operation to seed species from provided data.
        Creates species that don't exist, optionally updates existing species.
        Typically called at service startup with YAML-defined species.
      operationId: seedSpecies
      tags:
      - Species Admin
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SeedSpeciesRequest'
      responses:
        '200':
          description: Seed operation completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SeedSpeciesResponse'
        '400':
          description: Invalid seed data

components:
  schemas:
    # Request schemas
    GetSpeciesRequest:
      description: Request to retrieve a single species by its unique identifier
      type: object
      additionalProperties: false
      required:
      - speciesId
      properties:
        speciesId:
          type: string
          format: uuid
          description: Unique identifier of the species

    GetSpeciesByCodeRequest:
      description: Request to retrieve a species by its unique code identifier
      type: object
      additionalProperties: false
      required:
      - code
      properties:
        code:
          type: string
          minLength: 1
          maxLength: 50
          pattern: '^[A-Z][A-Z0-9_]*$'
          description: Unique code for the species (e.g., "HUMAN", "ELF", "DWARF")

    ListSpeciesRequest:
      description: Request to list species with optional filtering and pagination
      type: object
      additionalProperties: false
      properties:
        category:
          type: string
          nullable: true
          description: Filter by category (e.g., "HUMANOID", "BEAST", "MAGICAL")
        isPlayable:
          type: boolean
          nullable: true
          description: Filter by playable status
        includeDeprecated:
          type: boolean
          default: false
          description: Whether to include deprecated species in the response
        page:
          type: integer
          minimum: 1
          default: 1
          description: Page number for pagination (1-based)
        pageSize:
          type: integer
          minimum: 1
          maximum: 100
          default: 20
          description: Number of items per page

    ListSpeciesByRealmRequest:
      description: Request to list species available within a specific realm
      type: object
      additionalProperties: false
      required:
      - realmId
      properties:
        realmId:
          type: string
          format: uuid
          description: ID of the realm to filter by
        isPlayable:
          type: boolean
          nullable: true
          description: Filter by playable status
        includeDeprecated:
          type: boolean
          default: false
          description: Whether to include deprecated species in results
        page:
          type: integer
          minimum: 1
          default: 1
          description: Page number for pagination (1-based)
        pageSize:
          type: integer
          minimum: 1
          maximum: 100
          default: 20
          description: Number of items per page

    CreateSpeciesRequest:
      description: Request to create a new species with its attributes and realm associations
      type: object
      additionalProperties: false
      required:
      - code
      - name
      properties:
        code:
          type: string
          minLength: 1
          maxLength: 50
          pattern: '^[A-Z][A-Z0-9_]*$'
          description: Unique code for the species (e.g., "HUMAN", "ELF")
        name:
          type: string
          minLength: 1
          maxLength: 100
          description: Display name for the species
        description:
          type: string
          maxLength: 1000
          nullable: true
          description: Description of the species
        category:
          type: string
          maxLength: 50
          nullable: true
          description: Category for grouping (e.g., "HUMANOID", "BEAST", "MAGICAL")
        isPlayable:
          type: boolean
          default: true
          description: Whether players can create characters of this species
        baseLifespan:
          type: integer
          minimum: 1
          nullable: true
          description: Base lifespan in game years
        maturityAge:
          type: integer
          minimum: 0
          nullable: true
          description: Age at which the species reaches maturity
        traitModifiers:
          type: object
          additionalProperties: true
          nullable: true
          description: "Client-only trait modifiers. No Bannou plugin reads specific keys from this field by convention."
        realmIds:
          type: array
          items:
            type: string
            format: uuid
          nullable: true
          description: Initial realms where this species is available (null to skip realm assignment)
        metadata:
          type: object
          additionalProperties: true
          nullable: true
          description: "Client-only metadata. No Bannou plugin reads specific keys from this field by convention."

    UpdateSpeciesRequest:
      description: Request to update an existing species with partial attribute changes
      type: object
      additionalProperties: false
      required:
      - speciesId
      properties:
        speciesId:
          type: string
          format: uuid
          description: ID of the species to update
        name:
          type: string
          minLength: 1
          maxLength: 100
          nullable: true
          description: Display name for the species
        description:
          type: string
          maxLength: 1000
          nullable: true
          description: Description of the species
        category:
          type: string
          maxLength: 50
          nullable: true
          description: Category for grouping
        isPlayable:
          type: boolean
          nullable: true
          description: Whether players can create characters of this species
        baseLifespan:
          type: integer
          minimum: 1
          nullable: true
          description: Base lifespan in game years
        maturityAge:
          type: integer
          minimum: 0
          nullable: true
          description: Age at which the species reaches maturity
        traitModifiers:
          type: object
          additionalProperties: true
          nullable: true
          description: "Client-only trait modifiers. No Bannou plugin reads specific keys from this field by convention."
        metadata:
          type: object
          additionalProperties: true
          nullable: true
          description: "Client-only metadata. No Bannou plugin reads specific keys from this field by convention."

    DeleteSpeciesRequest:
      description: Request to hard-delete a deprecated species with no remaining references
      type: object
      additionalProperties: false
      required:
      - speciesId
      properties:
        speciesId:
          type: string
          format: uuid
          description: ID of the species to delete

    DeprecateSpeciesRequest:
      description: Request to soft-delete a species, preventing new character creation
      type: object
      additionalProperties: false
      required:
      - speciesId
      properties:
        speciesId:
          type: string
          format: uuid
          description: ID of the species to deprecate
        deprecationReason:
          type: string
          maxLength: 500
          nullable: true
          description: Audit reason for deprecation, explaining why this species is being phased out

    UndeprecateSpeciesRequest:
      description: Request to restore a deprecated species to active status
      type: object
      additionalProperties: false
      required:
      - speciesId
      properties:
        speciesId:
          type: string
          format: uuid
          description: ID of the species to restore

    MergeSpeciesRequest:
      description: Request to migrate all characters from a deprecated species to a target species
      type: object
      additionalProperties: false
      required:
      - sourceSpeciesId
      - targetSpeciesId
      properties:
        sourceSpeciesId:
          type: string
          format: uuid
          description: ID of the deprecated species to merge from (must be deprecated)
        targetSpeciesId:
          type: string
          format: uuid
          description: ID of the species to merge into (can be VOID for effective deletion)
        deleteAfterMerge:
          type: boolean
          default: false
          description: If true, hard-delete the source species after successful merge

    AddSpeciesToRealmRequest:
      description: Request to make a species available for character creation in a realm
      type: object
      additionalProperties: false
      required:
      - speciesId
      - realmId
      properties:
        speciesId:
          type: string
          format: uuid
          description: ID of the species
        realmId:
          type: string
          format: uuid
          description: ID of the realm to add the species to

    RemoveSpeciesFromRealmRequest:
      description: Request to remove a species from availability in a realm
      type: object
      additionalProperties: false
      required:
      - speciesId
      - realmId
      properties:
        speciesId:
          type: string
          format: uuid
          description: ID of the species
        realmId:
          type: string
          format: uuid
          description: ID of the realm to remove the species from

    SeedSpeciesRequest:
      description: Request to bulk-create or update species from a predefined list
      type: object
      additionalProperties: false
      required:
      - species
      properties:
        species:
          type: array
          items:
            $ref: '#/components/schemas/SeedSpecies'
          description: List of species to seed
        updateExisting:
          type: boolean
          default: false
          description: Whether to update species that already exist

    SeedSpecies:
      description: Species definition used in bulk seeding operations
      type: object
      additionalProperties: false
      required:
      - code
      - name
      properties:
        code:
          type: string
          minLength: 1
          maxLength: 50
          pattern: '^[A-Z][A-Z0-9_]*$'
          description: Unique code for the species (e.g., "HUMAN", "ELF")
        name:
          type: string
          minLength: 1
          maxLength: 100
          description: Display name for the species
        description:
          type: string
          maxLength: 1000
          nullable: true
          description: Description of the species (null if not provided)
        category:
          type: string
          maxLength: 50
          nullable: true
          description: Category for grouping (null if not categorized)
        isPlayable:
          type: boolean
          default: true
          description: Whether players can create characters of this species
        baseLifespan:
          type: integer
          nullable: true
          description: Base lifespan in game years (null for default)
        maturityAge:
          type: integer
          nullable: true
          description: Age at maturity (null for default)
        traitModifiers:
          type: object
          additionalProperties: true
          nullable: true
          description: "Client-only trait modifiers. No Bannou plugin reads specific keys from this field by convention."
        realmCodes:
          type: array
          items:
            type: string
          nullable: true
          description: Codes of realms where this species is available (null to skip realm assignment)
        metadata:
          type: object
          additionalProperties: true
          nullable: true
          description: "Client-only metadata. No Bannou plugin reads specific keys from this field by convention."

    # Response schemas
    SpeciesResponse:
      description: Complete species data including all attributes and realm associations
      type: object
      additionalProperties: false
      required:
      - speciesId
      - code
      - name
      - isPlayable
      - isDeprecated
      - createdAt
      - updatedAt
      properties:
        speciesId:
          type: string
          format: uuid
          description: Unique identifier of the species
        code:
          type: string
          description: Unique code for the species (e.g., "HUMAN", "ELF")
        name:
          type: string
          description: Display name for the species
        description:
          type: string
          nullable: true
          description: Description of the species
        category:
          type: string
          nullable: true
          description: Category for grouping (e.g., "HUMANOID", "BEAST", "MAGICAL")
        isPlayable:
          type: boolean
          description: Whether players can create characters of this species
        isDeprecated:
          type: boolean
          description: Whether this species is deprecated and cannot be used for new characters
        deprecatedAt:
          type: string
          format: date-time
          nullable: true
          description: Timestamp when this species was deprecated
        deprecationReason:
          type: string
          nullable: true
          description: Optional reason for deprecation
        baseLifespan:
          type: integer
          nullable: true
          description: Base lifespan in game years
        maturityAge:
          type: integer
          nullable: true
          description: Age at which the species reaches maturity
        traitModifiers:
          type: object
          additionalProperties: true
          nullable: true
          description: "Client-only trait modifiers. No Bannou plugin reads specific keys from this field by convention."
        realmIds:
          type: array
          items:
            type: string
            format: uuid
          description: Realms where this species is available
        metadata:
          type: object
          additionalProperties: true
          nullable: true
          description: "Client-only metadata. No Bannou plugin reads specific keys from this field by convention."
        createdAt:
          type: string
          format: date-time
          description: Timestamp when the species was created
        updatedAt:
          type: string
          format: date-time
          description: Timestamp when the species was last updated

    SpeciesListResponse:
      description: Paginated list of species with total count for pagination
      type: object
      additionalProperties: false
      required:
      - species
      - totalCount
      properties:
        species:
          type: array
          items:
            $ref: '#/components/schemas/SpeciesResponse'
          description: List of species matching the query
        totalCount:
          type: integer
          description: Total number of species matching the query (for pagination)

    SeedSpeciesResponse:
      description: Summary of a bulk species seeding operation with counts and errors
      type: object
      additionalProperties: false
      required:
      - created
      - updated
      - skipped
      - errors
      properties:
        created:
          type: integer
          description: Number of new species created
        updated:
          type: integer
          description: Number of existing species updated
        skipped:
          type: integer
          description: Number of species skipped (already exist, updateExisting=false)
        errors:
          type: array
          items:
            type: string
          description: List of error messages for species that failed to seed

    MergeSpeciesResponse:
      description: Result of a species merge operation including migration statistics
      type: object
      additionalProperties: false
      required:
      - charactersMigrated
      - sourceDeleted
      properties:
        charactersMigrated:
          type: integer
          description: Number of characters successfully migrated to the target species
        sourceDeleted:
          type: boolean
          description: Whether the source species was hard-deleted after merge (skipped on partial failure)
        failedEntityIds:
          type: array
          items:
            type: string
            format: uuid
          nullable: true
          description: Character IDs that failed migration, null if no failures occurred
