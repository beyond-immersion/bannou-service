openapi: 3.0.4
info:
  title: Bannou Voice Service API
  description: |
    Voice room coordination service. Internal service accessed by other services via lib-mesh.

    **Two Communication Modes**:
    - **P2P Mode**: Registry-based coordination for peer-to-peer voice (up to 6 participants)
    - **Scaled Mode**: RTP server integration for larger conferences (stubbed in Phase 1)

    **Event-Only Client Flow**:
    1. Clients receive VoicePeerJoinedEvent when another peer joins (includes their SDP offer)
    2. Client generates SDP answer and calls /voice/peer/answer (enabled via voice:ringing state)
    3. Other peer receives VoicePeerUpdatedEvent with the SDP answer
    4. WebRTC connection established

    **Broadcast Consent Flow**:
    1. Any in-room participant requests broadcast consent via /voice/room/broadcast/request
    2. All participants receive VoiceBroadcastConsentRequestEvent
    3. Each participant responds via /voice/room/broadcast/consent
    4. If all consent, voice.room.broadcast.approved is published
    5. If any decline or timeout, voice.room.broadcast.declined is published

    **Dual Room Modes**:
    - **Persistent**: Created via API, explicit delete required unless autoCleanup=true
    - **Ad-hoc**: Auto-created on join when AdHocRoomsEnabled config is true, always auto-cleaned

    **POST-Only API Pattern**: This API uses POST for all operations to support zero-copy
    WebSocket routing. Path parameters are passed in request bodies instead of URLs.
    See docs/BANNOU_DESIGN.md for architectural rationale.

    **SCHEMA MODIFICATION GATE**: STOP. Before modifying this schema, you MUST:
    1. Read docs/reference/SCHEMA-RULES.md
    2. State which section applies to your change
    3. Only then proceed with edits
    Edits without stating the applicable rule are FORBIDDEN.
  version: 2.0.0
x-service-layer: AppFeatures
servers:
- url: http://localhost:5012
  description: Bannou service endpoint (internal only)

paths:
  # ============================================
  # Room Management (internal-only)
  # ============================================

  /voice/room/create:
    post:
      summary: Create a new voice room
      description: |
        Creates a new voice room associated with a session. Any service can call this.
        Returns room ID and initial configuration.
      operationId: createVoiceRoom
      tags:
      - Voice Rooms
      x-permissions: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateVoiceRoomRequest'
      responses:
        '200':
          description: Voice room created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VoiceRoomResponse'
        '400':
          description: Invalid request parameters
        '409':
          description: Voice room already exists for this session

  /voice/room/get:
    post:
      summary: Get voice room details
      description: |
        Retrieves current state of a voice room including participant list.
      operationId: getVoiceRoom
      tags:
      - Voice Rooms
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetVoiceRoomRequest'
      responses:
        '200':
          description: Voice room retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VoiceRoomResponse'
        '404':
          description: Voice room not found

  /voice/room/join:
    post:
      summary: Join voice room and register SIP endpoint
      description: |
        Registers a participant in the voice room. If AdHocRoomsEnabled and room
        doesn't exist, auto-creates it.
        Returns connection info and current peer list for P2P mode,
        or RTP server details for scaled mode.
      operationId: joinVoiceRoom
      tags:
      - Voice Rooms
      x-permissions: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JoinVoiceRoomRequest'
      responses:
        '200':
          description: Successfully joined voice room
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JoinVoiceRoomResponse'
        '404':
          description: Voice room not found
        '409':
          description: Room full or already joined
        '500':
          description: Voice tier unavailable (P2P full, scaled tier disabled)

  /voice/room/leave:
    post:
      summary: Leave voice room
      description: |
        Removes a participant from the voice room.
      operationId: leaveVoiceRoom
      tags:
      - Voice Rooms
      x-permissions: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LeaveVoiceRoomRequest'
      responses:
        '200':
          description: Successfully left voice room
        '404':
          description: Voice room or participant not found

  /voice/room/delete:
    post:
      summary: Delete voice room
      description: |
        Deletes a voice room and notifies all participants.
      operationId: deleteVoiceRoom
      tags:
      - Voice Rooms
      x-permissions: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeleteVoiceRoomRequest'
      responses:
        '200':
          description: Voice room deleted successfully
        '404':
          description: Voice room not found

  # ============================================
  # Peer Management
  # ============================================

  /voice/peer/heartbeat:
    post:
      summary: Update peer endpoint TTL
      description: |
        Refreshes the TTL for a participant's endpoint registration.
        Should be called periodically to prevent endpoint expiration.
      operationId: peerHeartbeat
      tags:
      - Voice Peers
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PeerHeartbeatRequest'
      responses:
        '200':
          description: Heartbeat acknowledged
        '404':
          description: Peer not found in room

  /voice/peer/answer:
    post:
      summary: Send SDP answer to complete WebRTC handshake
      description: |
        Called by clients after receiving a VoicePeerJoinedEvent containing an SDP offer.
        The client generates an SDP answer and sends it via this endpoint.
        The answering peer is notified via VoicePeerUpdatedEvent.

        **Access Control**: This endpoint requires the `voice:ringing` state, which is
        automatically set by the Voice service when a VoicePeerJoinedEvent is sent to the client.
        The state is cleared after the answer is processed or times out.
      operationId: answerPeer
      tags:
      - Voice Peers
      x-permissions:
      - role: user
        states:
          voice: ringing
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AnswerPeerRequest'
      responses:
        '200':
          description: SDP answer processed, peer notified
        '404':
          description: Peer or room not found
        '403':
          description: Not in voice:ringing state (no pending offers)

  # ============================================
  # Broadcast Consent
  # ============================================

  /voice/room/broadcast/request:
    post:
      summary: Request broadcast consent from all room participants
      description: >
        Initiates the broadcast consent flow. All current room participants
        receive a VoiceBroadcastConsentRequestEvent. Broadcasting only starts
        after all participants consent. If ANY participant declines, the
        broadcast request is denied.

        This endpoint is the ONLY way to initiate voice room broadcasting.
        lib-stream subscribes to the resulting approval/decline events.
      operationId: requestBroadcastConsent
      tags:
      - Voice Broadcasting
      x-permissions:
      - role: user
        states:
          voice: in_room
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BroadcastConsentRequest'
      responses:
        '200':
          description: Consent request sent to all participants
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BroadcastConsentStatus'
        '404':
          description: Room not found
        '409':
          description: Broadcast already active or consent pending

  /voice/room/broadcast/consent:
    post:
      summary: Respond to a broadcast consent request
      description: >
        Called by each participant to consent or decline broadcasting.
        When all participants consent, lib-voice publishes
        voice.room.broadcast.approved. If any participant declines,
        lib-voice publishes voice.room.broadcast.declined.
      operationId: respondBroadcastConsent
      tags:
      - Voice Broadcasting
      x-permissions:
      - role: user
        states:
          voice: consent_pending
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BroadcastConsentResponse'
      responses:
        '200':
          description: Consent response recorded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BroadcastConsentStatus'
        '404':
          description: Room not found or no pending consent request

  /voice/room/broadcast/stop:
    post:
      summary: Stop broadcasting from a voice room
      description: >
        Any participant can stop an active broadcast at any time.
        This is equivalent to revoking consent. Publishes
        voice.room.broadcast.stopped with reason ConsentRevoked.
      operationId: stopBroadcast
      tags:
      - Voice Broadcasting
      x-permissions:
      - role: user
        states:
          voice: in_room
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StopBroadcastConsentRequest'
      responses:
        '200':
          description: Broadcast stopped
        '404':
          description: Room not found or not broadcasting

  /voice/room/broadcast/status:
    post:
      summary: Get broadcast status for a voice room
      description: >
        Returns the current broadcast state: whether consent is pending,
        active, or inactive.
      operationId: getBroadcastStatus
      tags:
      - Voice Broadcasting
      x-permissions:
      - role: user
        states:
          voice: in_room
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BroadcastStatusRequest'
      responses:
        '200':
          description: Broadcast status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BroadcastConsentStatus'
        '404':
          description: Room not found

components:
  schemas:
    # ============================================
    # Enums
    # ============================================

    VoiceTier:
      type: string
      enum: [p2p, scaled]
      description: |
        Voice communication tier:
        - p2p: Direct peer-to-peer connections (up to 6 participants)
        - scaled: RTP server-mediated communication (unlimited participants)

    VoiceCodec:
      type: string
      enum: [opus, g711, g722]
      description: Audio codec for voice communication

    BroadcastConsentState:
      type: string
      enum: [Inactive, Pending, Approved]
      description: >
        Current state of broadcast consent for a room.
        Inactive: No broadcast request pending.
        Pending: Consent request sent, awaiting all responses.
        Approved: All participants consented. Voice treats this as terminal.

    VoiceRoomDeletedReason:
      type: string
      enum: [Manual, Empty, Error]
      description: Reason a voice room was deleted

    VoiceBroadcastStoppedReason:
      type: string
      enum: [ConsentRevoked, RoomClosed, Manual, Error]
      description: Reason broadcasting was stopped

    # ============================================
    # Request Models
    # ============================================

    CreateVoiceRoomRequest:
      type: object
      additionalProperties: false
      description: Request to create a voice room
      required:
      - sessionId
      properties:
        sessionId:
          type: string
          format: uuid
          description: Session ID this voice room is associated with
        preferredTier:
          $ref: '#/components/schemas/VoiceTier'
          description: Preferred voice tier (defaults to p2p)
        maxParticipants:
          type: integer
          minimum: 2
          maximum: 100
          default: 6
          description: Maximum participants before tier upgrade
        codec:
          $ref: '#/components/schemas/VoiceCodec'
          description: Preferred audio codec (defaults to opus)
        autoCleanup:
          type: boolean
          default: false
          description: If true, room auto-deletes when empty after grace period
        password:
          type: string
          nullable: true
          description: Optional room password for access control

    GetVoiceRoomRequest:
      type: object
      additionalProperties: false
      description: Request to get voice room details
      required:
      - roomId
      properties:
        roomId:
          type: string
          format: uuid
          description: Voice room ID to retrieve

    JoinVoiceRoomRequest:
      type: object
      additionalProperties: false
      description: Request to join a voice room
      required:
      - roomId
      - sessionId
      - sipEndpoint
      properties:
        roomId:
          type: string
          format: uuid
          description: Voice room ID to join
        sessionId:
          type: string
          format: uuid
          description: WebSocket session ID (unique participant identifier)
        sipEndpoint:
          $ref: '#/components/schemas/SipEndpoint'
          description: Participant's SIP endpoint details
        displayName:
          type: string
          maxLength: 50
          description: Display name for UI
        password:
          type: string
          nullable: true
          description: Room password (required if room is password-protected)

    LeaveVoiceRoomRequest:
      type: object
      additionalProperties: false
      description: Request to leave a voice room
      required:
      - roomId
      - sessionId
      properties:
        roomId:
          type: string
          format: uuid
          description: Voice room ID to leave
        sessionId:
          type: string
          format: uuid
          description: WebSocket session ID of the leaving participant

    DeleteVoiceRoomRequest:
      type: object
      additionalProperties: false
      description: Request to delete a voice room
      required:
      - roomId
      properties:
        roomId:
          type: string
          format: uuid
          description: Voice room ID to delete
        reason:
          type: string
          description: Reason for deletion

    PeerHeartbeatRequest:
      type: object
      additionalProperties: false
      description: Heartbeat to keep peer registration active
      required:
      - roomId
      - sessionId
      properties:
        roomId:
          type: string
          format: uuid
          description: Voice room ID
        sessionId:
          type: string
          format: uuid
          description: WebSocket session ID of the peer

    AnswerPeerRequest:
      type: object
      additionalProperties: false
      description: |
        Request to send an SDP answer to complete a WebRTC handshake.
        Sent by clients after receiving a VoicePeerJoinedEvent with an SDP offer.
      required:
      - roomId
      - senderSessionId
      - targetSessionId
      - sdpAnswer
      properties:
        roomId:
          type: string
          format: uuid
          description: Voice room ID
        senderSessionId:
          type: string
          format: uuid
          description: Session ID of the answering peer (caller of this endpoint)
        targetSessionId:
          type: string
          format: uuid
          description: Session ID of the peer whose offer we're answering
        sdpAnswer:
          type: string
          description: SDP answer generated by this client's WebRTC stack
        iceCandidates:
          type: array
          items:
            type: string
          description: ICE candidates for NAT traversal (can be trickled later)

    BroadcastConsentRequest:
      type: object
      additionalProperties: false
      description: Request to initiate broadcast consent for a voice room
      required:
      - roomId
      properties:
        roomId:
          type: string
          format: uuid
          description: Voice room to broadcast
        requestingSessionId:
          type: string
          format: uuid
          nullable: true
          description: Session ID of the participant requesting broadcast (server can derive from auth context)

    BroadcastConsentResponse:
      type: object
      additionalProperties: false
      description: Response to a broadcast consent request from a participant
      required:
      - roomId
      - sessionId
      - consented
      properties:
        roomId:
          type: string
          format: uuid
          description: Voice room ID
        sessionId:
          type: string
          format: uuid
          description: Session ID of the responding participant
        consented:
          type: boolean
          description: True if participant consents to broadcasting

    StopBroadcastConsentRequest:
      type: object
      additionalProperties: false
      description: Request to stop broadcasting from a voice room
      required:
      - roomId
      properties:
        roomId:
          type: string
          format: uuid
          description: Voice room ID
        sessionId:
          type: string
          format: uuid
          nullable: true
          description: Session ID of the participant stopping the broadcast

    BroadcastStatusRequest:
      type: object
      additionalProperties: false
      description: Request to get broadcast consent status for a voice room
      required:
      - roomId
      properties:
        roomId:
          type: string
          format: uuid
          description: Voice room ID

    # ============================================
    # Response Models
    # ============================================

    VoiceRoomResponse:
      type: object
      additionalProperties: false
      description: Voice room details
      required:
      - roomId
      - sessionId
      - tier
      - createdAt
      properties:
        roomId:
          type: string
          format: uuid
          description: Unique voice room identifier
        sessionId:
          type: string
          format: uuid
          description: Associated session ID
        tier:
          $ref: '#/components/schemas/VoiceTier'
          description: Current voice tier
        codec:
          $ref: '#/components/schemas/VoiceCodec'
          description: Active audio codec
        maxParticipants:
          type: integer
          description: Maximum participants before tier upgrade
        currentParticipants:
          type: integer
          description: Current number of participants
        participants:
          type: array
          items:
            $ref: '#/components/schemas/VoiceParticipant'
          description: List of current participants
        createdAt:
          type: string
          format: date-time
          description: When the room was created
        rtpServerUri:
          type: string
          nullable: true
          description: RTP server URI (only present in scaled tier)
        autoCleanup:
          type: boolean
          description: Whether the room auto-deletes when empty
        isPasswordProtected:
          type: boolean
          description: Whether the room requires a password to join
        isBroadcasting:
          type: boolean
          description: Whether the room is currently broadcasting (Approved state)
        broadcastState:
          $ref: '#/components/schemas/BroadcastConsentState'
          description: Current broadcast consent state

    JoinVoiceRoomResponse:
      type: object
      additionalProperties: false
      description: Response after joining a voice room
      required:
      - roomId
      - tier
      properties:
        roomId:
          type: string
          format: uuid
          description: Voice room ID
        tier:
          $ref: '#/components/schemas/VoiceTier'
          description: Current voice tier
        codec:
          $ref: '#/components/schemas/VoiceCodec'
          description: Codec to use
        peers:
          type: array
          items:
            $ref: '#/components/schemas/VoicePeer'
          description: Current peers to connect to (P2P mode only)
        rtpServerUri:
          type: string
          nullable: true
          description: RTP server URI (scaled mode only)
        stunServers:
          type: array
          items:
            type: string
          description: STUN server URIs for NAT traversal
        tierUpgradePending:
          type: boolean
          default: false
          description: True if room is about to upgrade to scaled tier
        isBroadcasting:
          type: boolean
          description: Whether the room is currently broadcasting (Approved state)
        broadcastState:
          $ref: '#/components/schemas/BroadcastConsentState'
          description: Current broadcast consent state

    BroadcastConsentStatus:
      type: object
      additionalProperties: false
      description: Current broadcast consent status for a voice room
      properties:
        roomId:
          type: string
          format: uuid
          description: Voice room ID
        state:
          $ref: '#/components/schemas/BroadcastConsentState'
          description: Current broadcast consent state
        requestedBySessionId:
          type: string
          format: uuid
          nullable: true
          description: Who initiated the broadcast request (null if inactive)
        consentedSessionIds:
          type: array
          items:
            type: string
            format: uuid
          description: Sessions that have consented so far
        pendingSessionIds:
          type: array
          items:
            type: string
            format: uuid
          description: Sessions that haven't responded yet
        rtpAudioEndpoint:
          type: string
          nullable: true
          description: >
            RTP audio endpoint for the room's mixed audio output. Only populated
            when room is in scaled tier. Provided to lib-stream so it can connect
            its RTMP output to the voice room's audio.

    # ============================================
    # Supporting Types
    # ============================================

    SipEndpoint:
      type: object
      additionalProperties: false
      description: SIP/WebRTC endpoint details for a participant
      required:
      - sdpOffer
      properties:
        sdpOffer:
          type: string
          description: SDP offer for WebRTC negotiation
        iceCandidates:
          type: array
          items:
            type: string
          description: ICE candidates for NAT traversal
        publicIp:
          type: string
          nullable: true
          description: Public IP address if known
        port:
          type: integer
          nullable: true
          description: UDP port for RTP

    VoiceParticipant:
      type: object
      additionalProperties: false
      description: Participant in a voice room
      required:
      - sessionId
      - joinedAt
      properties:
        sessionId:
          type: string
          format: uuid
          description: WebSocket session ID (unique participant identifier)
        displayName:
          type: string
          nullable: true
          description: Display name
        joinedAt:
          type: string
          format: date-time
          description: When the participant joined
        isMuted:
          type: boolean
          default: false
          description: Whether participant is muted

    VoicePeer:
      type: object
      additionalProperties: false
      description: Peer endpoint details for P2P connection
      required:
      - sessionId
      - sipEndpoint
      properties:
        sessionId:
          type: string
          format: uuid
          description: WebSocket session ID for this peer (ephemeral identifier)
        displayName:
          type: string
          nullable: true
          description: Display name
        sipEndpoint:
          $ref: '#/components/schemas/SipEndpoint'
          description: Peer's SIP endpoint for direct connection

# Service Registration Information
x-service-registration:
  serviceId: "voice-service-guid"
  serviceName: "Voice Service"
  version: "2.0.0"
  categories:
  - communication
  - voice
