openapi: 3.0.3
info:
  title: Voice Service Events API
  description: |
    Service-to-service pub/sub events for the Voice service.
    These events enable asynchronous communication between Voice service
    and other services (e.g., GameSession, Orchestrator) via RabbitMQ.
  version: 1.0.0
  contact:
    name: Bannou Development Team

servers: []

paths: {}

components:
  schemas:
    # Base event schema for $ref resolution
    BaseServiceEvent:
      type: object
      required:
        - eventId
        - timestamp
      properties:
        eventId:
          type: string
          description: Unique identifier for this event instance
        timestamp:
          type: string
          format: date-time
          description: When the event was created (UTC)

    # ============================================
    # Voice Room Lifecycle Events
    # ============================================

    VoiceRoomCreatedEvent:
      allOf:
        - $ref: '#/components/schemas/BaseServiceEvent'
      type: object
      description: |
        Published when a new voice room is created.
        Consumed by Orchestrator for resource tracking.
      required:
        - roomId
        - sessionId
        - tier
      properties:
        roomId:
          type: string
          format: uuid
          description: Created voice room ID
        sessionId:
          type: string
          format: uuid
          description: Associated game session ID
        tier:
          type: string
          enum: [p2p, scaled]
          description: Initial voice tier
        maxParticipants:
          type: integer
          description: Maximum participants before tier upgrade
        codec:
          type: string
          enum: [opus, g711, g722]
          description: Audio codec

    VoiceRoomDeletedEvent:
      allOf:
        - $ref: '#/components/schemas/BaseServiceEvent'
      type: object
      description: |
        Published when a voice room is deleted.
        Consumed by Orchestrator to release resources.
      required:
        - roomId
        - sessionId
      properties:
        roomId:
          type: string
          format: uuid
          description: Deleted voice room ID
        sessionId:
          type: string
          format: uuid
          description: Associated game session ID
        reason:
          type: string
          nullable: true
          description: Reason for deletion
        finalParticipantCount:
          type: integer
          description: Number of participants when deleted

    # ============================================
    # Tier Management Events
    # ============================================

    VoiceTierUpgradeRequestedEvent:
      allOf:
        - $ref: '#/components/schemas/BaseServiceEvent'
      type: object
      description: |
        Published when a voice room needs to upgrade from P2P to scaled tier.
        Consumed by Orchestrator to provision RTP server resources.
      required:
        - roomId
        - sessionId
        - currentParticipants
        - requestedTier
      properties:
        roomId:
          type: string
          format: uuid
          description: Voice room requesting upgrade
        sessionId:
          type: string
          format: uuid
          description: Associated game session ID
        currentParticipants:
          type: integer
          description: Current number of participants
        requestedTier:
          type: string
          enum: [scaled]
          description: Tier to upgrade to

    VoiceTierUpgradeCompletedEvent:
      allOf:
        - $ref: '#/components/schemas/BaseServiceEvent'
      type: object
      description: |
        Published when a voice room tier upgrade is complete.
        Voice service publishes this after receiving RTP server assignment
        from Orchestrator.
      required:
        - roomId
        - sessionId
        - newTier
      properties:
        roomId:
          type: string
          format: uuid
          description: Upgraded voice room ID
        sessionId:
          type: string
          format: uuid
          description: Associated game session ID
        previousTier:
          type: string
          enum: [p2p]
          description: Previous tier
        newTier:
          type: string
          enum: [scaled]
          description: New tier after upgrade
        rtpServerUri:
          type: string
          description: Assigned RTP server URI

    # ============================================
    # Participant Events (for metrics/logging)
    # ============================================

    VoiceParticipantJoinedEvent:
      allOf:
        - $ref: '#/components/schemas/BaseServiceEvent'
      type: object
      description: |
        Published when a participant joins a voice room.
        Used for metrics and capacity tracking.
      required:
        - roomId
        - accountId
      properties:
        roomId:
          type: string
          format: uuid
          description: Voice room ID
        accountId:
          type: string
          format: uuid
          description: Joining participant's account ID
        currentParticipantCount:
          type: integer
          description: Total participants after join
        tier:
          type: string
          enum: [p2p, scaled]
          description: Current tier

    VoiceParticipantLeftEvent:
      allOf:
        - $ref: '#/components/schemas/BaseServiceEvent'
      type: object
      description: |
        Published when a participant leaves a voice room.
        Used for metrics and capacity tracking.
      required:
        - roomId
        - accountId
      properties:
        roomId:
          type: string
          format: uuid
          description: Voice room ID
        accountId:
          type: string
          format: uuid
          description: Leaving participant's account ID
        remainingParticipantCount:
          type: integer
          description: Participants remaining after departure
        reason:
          type: string
          nullable: true
          enum: [voluntary, kicked, timeout, session_ended]
          description: Reason for leaving
