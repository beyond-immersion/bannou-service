openapi: 3.0.4
info:
  title: Voice Service Events API
  description: |
    Service-to-service pub/sub events for the Voice service.
    These events enable asynchronous communication between Voice service
    and other services via RabbitMQ. Voice publishes room lifecycle events
    and broadcast consent events. Voice does not consume external events.

    **SCHEMA MODIFICATION GATE**: STOP. Before modifying this schema, you MUST:
    1. Read docs/reference/SCHEMA-RULES.md
    2. State which section applies to your change
    3. Only then proceed with edits
    Edits without stating the applicable rule are FORBIDDEN.
  version: 2.0.0
  contact:
    name: Bannou Development Team
  x-event-subscriptions: []
  x-event-publications:
    - topic: voice.room.created
      event: VoiceRoomCreatedEvent
      description: Published when a voice room is created
    - topic: voice.room.deleted
      event: VoiceRoomDeletedEvent
      description: Published when a voice room is deleted
    - topic: voice.room.tier-upgraded
      event: VoiceRoomTierUpgradedEvent
      description: Published when a room upgrades from P2P to scaled tier
    - topic: voice.peer.joined
      event: VoicePeerJoinedEvent
      description: Published when a peer joins a room
    - topic: voice.peer.left
      event: VoicePeerLeftEvent
      description: Published when a peer leaves a room
    - topic: voice.broadcast.approved
      event: VoiceBroadcastApprovedEvent
      description: All participants consented to broadcasting
    - topic: voice.broadcast.declined
      event: VoiceBroadcastDeclinedEvent
      description: A participant declined broadcast consent
    - topic: voice.broadcast.stopped
      event: VoiceBroadcastStoppedEvent
      description: Broadcasting stopped (consent revoked, room closed, or manual stop)

servers: []

paths: {}

components:
  schemas:
    # ============================================
    # Room Lifecycle Events
    # ============================================

    VoiceRoomCreatedEvent:
      type: object
      additionalProperties: false
      description: Published when a voice room is created
      required: [eventId, timestamp, roomId, sessionId, tier, maxParticipants]
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique event identifier
        timestamp:
          type: string
          format: date-time
          description: When the event occurred
        roomId:
          type: string
          format: uuid
          description: Voice room ID
        sessionId:
          type: string
          format: uuid
          description: Connect/Auth session ID of the room creator
        tier:
          $ref: 'voice-api.yaml#/components/schemas/VoiceTier'
          description: Initial voice tier for the room
        maxParticipants:
          type: integer
          description: Maximum participants configured for the room

    VoiceRoomDeletedEvent:
      type: object
      additionalProperties: false
      description: Published when a voice room is deleted
      required: [eventId, timestamp, roomId, reason]
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique event identifier
        timestamp:
          type: string
          format: date-time
          description: When the event occurred
        roomId:
          type: string
          format: uuid
          description: Voice room ID
        reason:
          $ref: 'voice-api.yaml#/components/schemas/VoiceRoomDeletedReason'
          description: Reason the room was deleted

    VoiceRoomTierUpgradedEvent:
      type: object
      additionalProperties: false
      description: Published when a room upgrades from P2P to scaled tier
      required: [eventId, timestamp, roomId, previousTier, newTier]
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique event identifier
        timestamp:
          type: string
          format: date-time
          description: When the event occurred
        roomId:
          type: string
          format: uuid
          description: Voice room ID
        previousTier:
          $ref: 'voice-api.yaml#/components/schemas/VoiceTier'
          description: Tier before upgrade
        newTier:
          $ref: 'voice-api.yaml#/components/schemas/VoiceTier'
          description: Tier after upgrade
        rtpAudioEndpoint:
          type: string
          nullable: true
          description: RTP mixed audio endpoint (for lib-stream to connect to)

    # ============================================
    # Peer Events
    # ============================================

    VoicePeerJoinedEvent:
      type: object
      additionalProperties: false
      description: Published when a peer joins a room
      required: [eventId, timestamp, roomId, peerSessionId, currentCount]
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique event identifier
        timestamp:
          type: string
          format: date-time
          description: When the event occurred
        roomId:
          type: string
          format: uuid
          description: Voice room ID
        peerSessionId:
          type: string
          format: uuid
          description: WebSocket session ID of the peer who joined
        currentCount:
          type: integer
          description: Total peers after join

    VoicePeerLeftEvent:
      type: object
      additionalProperties: false
      description: Published when a peer leaves a room
      required: [eventId, timestamp, roomId, peerSessionId, remainingCount]
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique event identifier
        timestamp:
          type: string
          format: date-time
          description: When the event occurred
        roomId:
          type: string
          format: uuid
          description: Voice room ID
        peerSessionId:
          type: string
          format: uuid
          description: WebSocket session ID of the peer who left
        remainingCount:
          type: integer
          description: Peers remaining after departure

    # ============================================
    # Broadcast Consent Events
    # ============================================

    VoiceBroadcastApprovedEvent:
      type: object
      additionalProperties: false
      description: >
        All participants consented to broadcasting. lib-stream subscribes
        to this to start RTMP output from the room's audio source.
      required: [eventId, timestamp, roomId]
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique event identifier
        timestamp:
          type: string
          format: date-time
          description: When the event occurred
        roomId:
          type: string
          format: uuid
          description: Voice room ID
        requestedBySessionId:
          type: string
          format: uuid
          nullable: true
          description: Session ID of the participant who initiated the broadcast request (null if server-derived)
        rtpAudioEndpoint:
          type: string
          nullable: true
          description: RTP endpoint for mixed audio (for lib-stream to connect RTMP output)

    VoiceBroadcastDeclinedEvent:
      type: object
      additionalProperties: false
      description: A participant declined broadcast consent
      required: [eventId, timestamp, roomId]
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique event identifier
        timestamp:
          type: string
          format: date-time
          description: When the event occurred
        roomId:
          type: string
          format: uuid
          description: Voice room ID
        declinedBySessionId:
          type: string
          format: uuid
          nullable: true
          description: Session ID of the participant who declined (null if auto-declined by consent timeout)

    VoiceBroadcastStoppedEvent:
      type: object
      additionalProperties: false
      description: Broadcasting stopped
      required: [eventId, timestamp, roomId, reason]
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique event identifier
        timestamp:
          type: string
          format: date-time
          description: When the event occurred
        roomId:
          type: string
          format: uuid
          description: Voice room ID
        reason:
          $ref: 'voice-api.yaml#/components/schemas/VoiceBroadcastStoppedReason'
          description: Reason broadcasting was stopped
