openapi: 3.0.4
info:
  title: Item Service API
  version: 1.0.0
  description: |
    Item template and instance management service.

    lib-item provides foundational item management with templates (definitions) and instances
    (occurrences). Items are always contained in containers managed by lib-inventory.
    Ownership is derived from the container - items do not track their own owner.

    **What lib-item Does**:
    - Item template CRUD (create, read, update, deprecate)
    - Item instance lifecycle (create, modify, destroy)
    - Durability tracking
    - Soulbound/binding system
    - Multiple quantity models (discrete, continuous, unique)

    **What lib-item Does NOT Do**:
    - Container/inventory management (lib-inventory)
    - Item placement and movement (lib-inventory)
    - Affixes and modifiers (future lib-affix)
    - Sockets and gems (future lib-socket)
    - Crafting (future lib-crafting)

    **POST-Only API Pattern**: This API uses POST for all operations to support
    zero-copy WebSocket routing. Path parameters are passed in request bodies.

    **SCHEMA MODIFICATION GATE**: STOP. Before modifying this schema, you MUST:
    1. Read docs/reference/SCHEMA-RULES.md
    2. State which section applies to your change
    3. Only then proceed with edits
    Edits without stating the applicable rule are FORBIDDEN.
x-service-layer: GameFoundation

servers:
- url: http://localhost:5012
  description: Bannou service endpoint (internal only)

paths:
  # ===========================================================================
  # Item Template (5 endpoints)
  # ===========================================================================

  /item/template/create:
    post:
      operationId: createItemTemplate
      tags:
      - Item Template
      summary: Create a new item template
      description: |
        Creates a new item definition for a game. Code, gameId, quantityModel, and scope
        are immutable after creation.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateItemTemplateRequest'
      responses:
        '200':
          description: Item template created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ItemTemplateResponse'
        '400':
          description: Invalid request (validation error)
        '409':
          description: Code already exists for this gameId
      x-permissions:
      - role: developer
        states: {}

  /item/template/get:
    post:
      operationId: getItemTemplate
      tags:
      - Item Template
      summary: Get item template by ID or code
      description: |
        Retrieves an item template by its unique ID or by code+gameId combination.
        At least one of templateId or (code + gameId) must be provided.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetItemTemplateRequest'
      responses:
        '200':
          description: Item template retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ItemTemplateResponse'
        '400':
          description: Neither templateId nor code+gameId provided
        '404':
          description: Item template not found
      x-permissions:
      - role: user
        states: {}

  /item/template/list:
    post:
      operationId: listItemTemplates
      tags:
      - Item Template
      summary: List item templates with filters
      description: |
        Lists item templates with optional filtering by gameId, category, tags,
        rarity, scope, and active status.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ListItemTemplatesRequest'
      responses:
        '200':
          description: Item templates retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListItemTemplatesResponse'
      x-permissions:
      - role: user
        states: {}

  /item/template/update:
    post:
      operationId: updateItemTemplate
      tags:
      - Item Template
      summary: Update mutable fields of an item template
      description: |
        Updates mutable fields of an item template. Code, gameId, quantityModel, and scope
        are immutable after creation and cannot be changed.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateItemTemplateRequest'
      responses:
        '200':
          description: Item template updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ItemTemplateResponse'
        '400':
          description: Attempted to change immutable field
        '404':
          description: Item template not found
      x-permissions:
      - role: developer
        states: {}

  /item/template/deprecate:
    post:
      operationId: deprecateItemTemplate
      tags:
      - Item Template
      summary: Deprecate an item template
      description: |
        Marks an item template as deprecated. Deprecated templates cannot be used
        to create new instances but existing instances remain valid. Optionally
        specify a migration target template.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeprecateItemTemplateRequest'
      responses:
        '200':
          description: Item template deprecated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ItemTemplateResponse'
        '404':
          description: Item template not found
        '409':
          description: Template already deprecated
      x-permissions:
      - role: admin
        states: {}

  # ===========================================================================
  # Item Instance (5 endpoints)
  # ===========================================================================

  /item/instance/create:
    post:
      operationId: createItemInstance
      tags:
      - Item Instance
      summary: Create a new item instance
      description: |
        Creates a new item instance from a template. The instance must be placed
        in a container (containerId required). Use lib-inventory's /inventory/add
        for most use cases - this endpoint is for low-level instance creation.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateItemInstanceRequest'
      responses:
        '200':
          description: Item instance created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ItemInstanceResponse'
        '400':
          description: Invalid request (validation error)
        '404':
          description: Template not found
        '409':
          description: Template is deprecated
      x-permissions:
      - role: developer
        states: {}

  /item/instance/get:
    post:
      operationId: getItemInstance
      tags:
      - Item Instance
      summary: Get item instance by ID
      description: Retrieves an item instance by its unique ID.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetItemInstanceRequest'
      responses:
        '200':
          description: Item instance retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ItemInstanceResponse'
        '404':
          description: Item instance not found
      x-permissions:
      - role: user
        states: {}

  /item/instance/modify:
    post:
      operationId: modifyItemInstance
      tags:
      - Item Instance
      summary: Modify item instance state
      description: |
        Modifies an item instance's mutable state: durability, custom stats,
        custom name, and metadata. Cannot modify bound items unless admin.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ModifyItemInstanceRequest'
      responses:
        '200':
          description: Item instance modified successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ItemInstanceResponse'
        '400':
          description: Invalid modification (e.g., negative durability)
        '404':
          description: Item instance not found
        '409':
          description: Item is corrupted/mirrored and cannot be modified
      x-permissions:
      - role: developer
        states: {}

  /item/instance/bind:
    post:
      operationId: bindItemInstance
      tags:
      - Item Instance
      summary: Bind item to character
      description: |
        Binds an item instance to a character. The bind type must be allowed by
        the template's soulboundType. Once bound, the item cannot be traded.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BindItemInstanceRequest'
      responses:
        '200':
          description: Item instance bound successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ItemInstanceResponse'
        '400':
          description: Item cannot be bound (template doesn't allow binding)
        '404':
          description: Item instance not found
        '409':
          description: Item already bound
      x-permissions:
      - role: developer
        states: {}

  /item/instance/unbind:
    post:
      operationId: unbindItemInstance
      tags:
      - Item Instance
      summary: Unbind item from character
      description: |
        Removes the binding from a soulbound item. This is an admin-only operation
        for returning bound items to tradeable state. Requires a reason for audit trail.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UnbindItemInstanceRequest'
      responses:
        '200':
          description: Item instance unbound successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ItemInstanceResponse'
        '400':
          description: Item is not bound
        '404':
          description: Item instance not found
      x-permissions:
      - role: admin
        states: {}

  /item/instance/destroy:
    post:
      operationId: destroyItemInstance
      tags:
      - Item Instance
      summary: Destroy item instance
      description: |
        Permanently destroys an item instance. The reason is recorded for audit.
        Cannot destroy bound items unless admin or reason is 'admin'.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DestroyItemInstanceRequest'
      responses:
        '200':
          description: Item instance destroyed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DestroyItemInstanceResponse'
        '404':
          description: Item instance not found
        '409':
          description: Item is bound and cannot be destroyed
      x-permissions:
      - role: developer
        states: {}

  /item/use:
    post:
      operationId: useItem
      tags:
      - Item Instance
      summary: Use an item (execute its behavior contract)
      description: |
        Uses an item by executing its behavior contract. The item's template must have
        a useBehaviorContractTemplateId defined. Creates a transient contract instance,
        completes the "use" milestone (triggering prebound APIs), and consumes the item
        on success if the template defines it as consumable. Returns failure if the
        contract's prebound APIs fail.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UseItemRequest'
      responses:
        '200':
          description: Item used successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UseItemResponse'
        '400':
          description: Item template has no behavior contract or invalid request
        '404':
          description: Item instance not found
        '422':
          description: Item use failed (contract prebound APIs failed)
      x-permissions:
      - role: user
        states: {}

  /item/use-step:
    post:
      operationId: useItemStep
      tags:
      - Item Instance
      summary: Complete a specific step of a multi-step item use
      description: |
        For items with multi-milestone use behaviors, completes a specific milestone.
        The first call (without an existing contractInstanceId on the item) creates
        the contract instance and stores it on the item; subsequent calls progress
        the existing contract. Item is consumed only when all required milestones
        are complete (per itemUseBehavior).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UseItemStepRequest'
      responses:
        '200':
          description: Step completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UseItemStepResponse'
        '400':
          description: Invalid request or item template has no behavior contract
        '404':
          description: Item instance not found
        '409':
          description: Another operation is in progress on this item (distributed lock held)
        '422':
          description: Step execution failed (CanUse validation or milestone completion)
      x-permissions:
      - role: user
        states: {}

  # ===========================================================================
  # Item Queries (3 endpoints)
  # ===========================================================================

  /item/instance/list-by-container:
    post:
      operationId: listItemsByContainer
      tags:
      - Item Query
      summary: List items in a container
      description: Returns all item instances in the specified container.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ListItemsByContainerRequest'
      responses:
        '200':
          description: Items retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListItemsResponse'
      x-permissions:
      - role: user
        states: {}

  /item/instance/list-by-template:
    post:
      operationId: listItemsByTemplate
      tags:
      - Item Query
      summary: List instances of a template
      description: |
        Returns item instances of the specified template, optionally filtered by realm.
        Useful for admin queries and analytics.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ListItemsByTemplateRequest'
      responses:
        '200':
          description: Items retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListItemsResponse'
      x-permissions:
      - role: admin
        states: {}

  /item/instance/batch-get:
    post:
      operationId: batchGetItemInstances
      tags:
      - Item Query
      summary: Get multiple item instances by ID
      description: Retrieves multiple item instances in a single request.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BatchGetItemInstancesRequest'
      responses:
        '200':
          description: Items retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchGetItemInstancesResponse'
      x-permissions:
      - role: user
        states: {}

components:
  schemas:
    # =========================================================================
    # Enums
    # =========================================================================

    ItemCategory:
      type: string
      description: Item classification category
      enum:
      - weapon
      - armor
      - accessory
      - consumable
      - material
      - container
      - quest
      - currency_like
      - misc
      - custom

    QuantityModel:
      type: string
      description: How quantities are tracked for this item type
      enum:
      - discrete
      - continuous
      - unique

    ItemRarity:
      type: string
      description: Item rarity tier
      enum:
      - common
      - uncommon
      - rare
      - epic
      - legendary
      - custom

    SoulboundType:
      type: string
      description: When item becomes bound to a character
      enum:
      - none
      - on_pickup
      - on_equip
      - on_use

    ItemScope:
      type: string
      description: Realm availability scope (consistent with CurrencyScope)
      enum:
      - global
      - realm_specific
      - multi_realm

    WeightPrecision:
      type: string
      description: Precision for weight values (consistent with CurrencyPrecision)
      enum:
      - integer
      - decimal_1
      - decimal_2
      - decimal_3

    ItemOriginType:
      type: string
      description: How an item instance was created
      enum:
      - loot
      - quest
      - craft
      - trade
      - purchase
      - spawn
      - other

    ItemUseBehavior:
      type: string
      description: |
        Controls item consumption on use.
        - disabled: Item cannot be used (/item/use returns 400)
        - destroy_on_success: Item consumed only if use behavior succeeds (default)
        - destroy_always: Item consumed regardless of success/failure
      enum:
      - disabled
      - destroy_on_success
      - destroy_always

    CanUseBehavior:
      type: string
      description: |
        Controls CanUse validation behavior.
        - disabled: Skip CanUse validation even if template is configured
        - block: CanUse failure prevents use (default)
        - warn_and_proceed: CanUse failure logs warning but proceeds with use
      enum:
      - disabled
      - block
      - warn_and_proceed

    ContractBindingType:
      type: string
      description: |
        Type of contract binding on an item instance.
        - none: No contract bound
        - session: Temporary binding for multi-step use (managed by Item service)
        - lifecycle: Persistent binding for status effects, licenses, etc. (managed by external orchestrators)
      enum:
      - none
      - session
      - lifecycle

    DestroyReason:
      type: string
      description: Reason for destroying an item instance
      enum:
      - consumed
      - destroyed
      - expired
      - admin

    UnbindReason:
      type: string
      description: Reason for unbinding an item from a character
      enum:
      - admin
      - expiration
      - transfer_override

    # =========================================================================
    # Item Template Models
    # =========================================================================

    CreateItemTemplateRequest:
      type: object
      description: Request to create a new item template
      additionalProperties: false
      required:
      - code
      - gameId
      - name
      - category
      - quantityModel
      - maxStackSize
      - scope
      properties:
        code:
          type: string
          minLength: 2
          maxLength: 64
          pattern: "^[a-z][a-z0-9_]{1,63}$"
          description: Unique code within the game (immutable after creation)
        gameId:
          type: string
          minLength: 1
          maxLength: 64
          description: Game service this template belongs to (immutable after creation)
        name:
          type: string
          minLength: 1
          maxLength: 128
          description: Human-readable display name
        description:
          type: string
          maxLength: 1000
          nullable: true
          description: Detailed description of this item
        category:
          $ref: '#/components/schemas/ItemCategory'
          description: Item classification category
        subcategory:
          type: string
          maxLength: 64
          nullable: true
          description: Game-defined subcategory (e.g., sword, helmet)
        tags:
          type: array
          items:
            type: string
            maxLength: 32
          nullable: true
          description: Flexible filtering tags
        rarity:
          $ref: '#/components/schemas/ItemRarity'
          nullable: true
          description: Item rarity tier (defaults to config when not specified)
        quantityModel:
          $ref: '#/components/schemas/QuantityModel'
          description: How quantities are tracked for this item
        maxStackSize:
          type: integer
          minimum: 1
          description: Maximum stack size (1 for unique items)
        unitOfMeasure:
          type: string
          maxLength: 32
          nullable: true
          description: Unit for continuous quantities (e.g., liters, kg)
        weightPrecision:
          $ref: '#/components/schemas/WeightPrecision'
          nullable: true
          description: Precision for weight values (defaults to config when not specified)
        weight:
          type: number
          format: double
          nullable: true
          description: Weight value (interpreted per weightPrecision)
        volume:
          type: number
          format: double
          nullable: true
          description: Volume for volumetric inventories
        gridWidth:
          type: integer
          minimum: 1
          nullable: true
          description: Width in grid-based inventories
        gridHeight:
          type: integer
          minimum: 1
          nullable: true
          description: Height in grid-based inventories
        canRotate:
          type: boolean
          nullable: true
          description: Whether item can be rotated in grid
        baseValue:
          type: number
          format: double
          nullable: true
          description: Reference price for vendors/markets
        tradeable:
          type: boolean
          default: true
          description: Whether item can be traded/auctioned
        destroyable:
          type: boolean
          default: true
          description: Whether item can be destroyed/discarded
        soulboundType:
          $ref: '#/components/schemas/SoulboundType'
          nullable: true
          description: Binding behavior when item is acquired (defaults to config when not specified)
        hasDurability:
          type: boolean
          default: false
          description: Whether item has durability tracking
        maxDurability:
          type: integer
          nullable: true
          description: Maximum durability value
        scope:
          $ref: '#/components/schemas/ItemScope'
          description: Realm availability scope
        availableRealms:
          type: array
          items:
            type: string
            format: uuid
          nullable: true
          description: Realm IDs where this template is available (for realm_specific or multi_realm)
        stats:
          type: object
          nullable: true
          description: Game-defined stats (e.g., attack, defense). Opaque to Bannou; no plugin reads keys by convention.
        effects:
          type: object
          nullable: true
          description: Game-defined effects (e.g., on_use, on_equip). Opaque to Bannou; no plugin reads keys by convention.
        requirements:
          type: object
          nullable: true
          description: Game-defined requirements (e.g., level, strength). Opaque to Bannou; no plugin reads keys by convention.
        display:
          type: object
          nullable: true
          description: Display properties (e.g., iconId, modelId). Opaque to Bannou; no plugin reads keys by convention.
        metadata:
          type: object
          nullable: true
          description: Additional game-specific data. Opaque to Bannou; no plugin reads keys by convention.
        useBehaviorContractTemplateId:
          type: string
          format: uuid
          nullable: true
          description: Contract template ID for executable item behavior. When set, the item can be "used" via /item/use, which creates a transient contract instance, completes its "use" milestone (triggering prebound APIs), and optionally consumes the item.
        canUseBehaviorContractTemplateId:
          type: string
          format: uuid
          nullable: true
          description: |
            Contract template for pre-use validation. When set, /item/use first executes
            this contract's "validate" milestone before proceeding. If validation fails,
            the item is NOT consumed and the main use behavior is NOT executed.
        onUseFailedBehaviorContractTemplateId:
          type: string
          format: uuid
          nullable: true
          description: |
            Contract template executed when the main use behavior fails. Enables cleanup,
            partial rollback, or consequence application. Item is NOT consumed on failure
            regardless of this template's outcome.
        itemUseBehavior:
          $ref: '#/components/schemas/ItemUseBehavior'
          nullable: true
          description: How the item should behave when used (defaults to destroy_on_success)
        canUseBehavior:
          $ref: '#/components/schemas/CanUseBehavior'
          nullable: true
          description: How CanUse validation failures should be handled (defaults to block)

    GetItemTemplateRequest:
      type: object
      description: Request to get an item template
      additionalProperties: false
      properties:
        templateId:
          type: string
          format: uuid
          nullable: true
          description: Template ID (provide this or code+gameId)
        code:
          type: string
          nullable: true
          description: Item code (provide with gameId)
        gameId:
          type: string
          nullable: true
          description: Game service ID (provide with code)

    ListItemTemplatesRequest:
      type: object
      description: Request to list item templates
      additionalProperties: false
      properties:
        gameId:
          type: string
          nullable: true
          description: Filter by game service
        category:
          $ref: '#/components/schemas/ItemCategory'
          nullable: true
          description: Filter by item category
        subcategory:
          type: string
          nullable: true
          description: Filter by subcategory
        tags:
          type: array
          items:
            type: string
          nullable: true
          description: Filter by tags (items must have all specified tags)
        rarity:
          $ref: '#/components/schemas/ItemRarity'
          nullable: true
          description: Filter by rarity tier
        scope:
          $ref: '#/components/schemas/ItemScope'
          nullable: true
          description: Filter by realm scope
        realmId:
          type: string
          format: uuid
          nullable: true
          description: Filter by realm availability
        includeInactive:
          type: boolean
          default: false
          description: Include inactive templates
        includeDeprecated:
          type: boolean
          default: false
          description: Include deprecated templates
        search:
          type: string
          nullable: true
          description: Search in name and description
        offset:
          type: integer
          minimum: 0
          default: 0
          description: Pagination offset
        limit:
          type: integer
          minimum: 1
          maximum: 200
          default: 50
          description: Maximum results to return

    UpdateItemTemplateRequest:
      type: object
      description: Request to update mutable fields of an item template
      additionalProperties: false
      required:
      - templateId
      properties:
        templateId:
          type: string
          format: uuid
          description: Template ID to update
        name:
          type: string
          maxLength: 128
          nullable: true
          description: New display name
        description:
          type: string
          maxLength: 1000
          nullable: true
          description: New description
        subcategory:
          type: string
          maxLength: 64
          nullable: true
          description: New subcategory
        tags:
          type: array
          items:
            type: string
          nullable: true
          description: New tags (replaces existing)
        rarity:
          $ref: '#/components/schemas/ItemRarity'
          nullable: true
          description: New rarity tier
        weight:
          type: number
          format: double
          nullable: true
          description: New weight value
        volume:
          type: number
          format: double
          nullable: true
          description: New volume value
        gridWidth:
          type: integer
          nullable: true
          description: New grid width
        gridHeight:
          type: integer
          nullable: true
          description: New grid height
        canRotate:
          type: boolean
          nullable: true
          description: New rotation setting
        baseValue:
          type: number
          format: double
          nullable: true
          description: New base value
        tradeable:
          type: boolean
          nullable: true
          description: New tradeable setting
        destroyable:
          type: boolean
          nullable: true
          description: New destroyable setting
        maxDurability:
          type: integer
          nullable: true
          description: New max durability
        availableRealms:
          type: array
          items:
            type: string
            format: uuid
          nullable: true
          description: New available realms
        stats:
          type: object
          nullable: true
          description: New stats. Opaque to Bannou; no plugin reads keys by convention.
        effects:
          type: object
          nullable: true
          description: New effects. Opaque to Bannou; no plugin reads keys by convention.
        requirements:
          type: object
          nullable: true
          description: New requirements. Opaque to Bannou; no plugin reads keys by convention.
        display:
          type: object
          nullable: true
          description: New display properties. Opaque to Bannou; no plugin reads keys by convention.
        metadata:
          type: object
          nullable: true
          description: New metadata. Opaque to Bannou; no plugin reads keys by convention.
        isActive:
          type: boolean
          nullable: true
          description: Active status
        useBehaviorContractTemplateId:
          type: string
          format: uuid
          nullable: true
          description: Contract template ID for executable item behavior (null to clear)
        canUseBehaviorContractTemplateId:
          type: string
          format: uuid
          nullable: true
          description: Contract template for pre-use validation (null to clear)
        onUseFailedBehaviorContractTemplateId:
          type: string
          format: uuid
          nullable: true
          description: Contract template for use failure handling (null to clear)
        itemUseBehavior:
          $ref: '#/components/schemas/ItemUseBehavior'
          nullable: true
          description: How the item should behave when used
        canUseBehavior:
          $ref: '#/components/schemas/CanUseBehavior'
          nullable: true
          description: How CanUse validation failures should be handled

    DeprecateItemTemplateRequest:
      type: object
      description: Request to deprecate an item template
      additionalProperties: false
      required:
      - templateId
      properties:
        templateId:
          type: string
          format: uuid
          description: Template ID to deprecate
        migrationTargetId:
          type: string
          format: uuid
          nullable: true
          description: Optional template to migrate existing instances to
        reason:
          type: string
          maxLength: 500
          nullable: true
          description: Reason for deprecation

    ItemTemplateResponse:
      type: object
      description: Item template details
      additionalProperties: false
      required:
      - templateId
      - code
      - gameId
      - name
      - category
      - quantityModel
      - maxStackSize
      - rarity
      - weightPrecision
      - scope
      - tradeable
      - destroyable
      - soulboundType
      - hasDurability
      - tags
      - isActive
      - isDeprecated
      - createdAt
      - updatedAt
      properties:
        templateId:
          type: string
          format: uuid
          description: Unique template identifier
        code:
          type: string
          description: Unique code within the game
        gameId:
          type: string
          description: Game service this template belongs to
        name:
          type: string
          description: Human-readable display name
        description:
          type: string
          nullable: true
          description: Detailed description
        category:
          $ref: '#/components/schemas/ItemCategory'
          description: Item classification category
        subcategory:
          type: string
          nullable: true
          description: Game-defined subcategory
        tags:
          type: array
          items:
            type: string
          description: Filtering tags
        rarity:
          $ref: '#/components/schemas/ItemRarity'
          description: Item rarity tier
        quantityModel:
          $ref: '#/components/schemas/QuantityModel'
          description: How quantities are tracked
        maxStackSize:
          type: integer
          description: Maximum stack size
        unitOfMeasure:
          type: string
          nullable: true
          description: Unit for continuous quantities
        weightPrecision:
          $ref: '#/components/schemas/WeightPrecision'
          description: Precision for weight values
        weight:
          type: number
          format: double
          nullable: true
          description: Weight value
        volume:
          type: number
          format: double
          nullable: true
          description: Volume for volumetric inventories
        gridWidth:
          type: integer
          nullable: true
          description: Width in grid-based inventories
        gridHeight:
          type: integer
          nullable: true
          description: Height in grid-based inventories
        canRotate:
          type: boolean
          nullable: true
          description: Whether item can be rotated in grid
        baseValue:
          type: number
          format: double
          nullable: true
          description: Reference price
        tradeable:
          type: boolean
          description: Whether item can be traded
        destroyable:
          type: boolean
          description: Whether item can be destroyed
        soulboundType:
          $ref: '#/components/schemas/SoulboundType'
          description: Binding behavior type
        hasDurability:
          type: boolean
          description: Whether item has durability
        maxDurability:
          type: integer
          nullable: true
          description: Maximum durability value
        scope:
          $ref: '#/components/schemas/ItemScope'
          description: Realm availability scope
        availableRealms:
          type: array
          items:
            type: string
            format: uuid
          nullable: true
          description: Available realms
        stats:
          type: object
          nullable: true
          description: Game-defined stats. Opaque to Bannou; no plugin reads keys by convention.
        effects:
          type: object
          nullable: true
          description: Game-defined effects. Opaque to Bannou; no plugin reads keys by convention.
        requirements:
          type: object
          nullable: true
          description: Game-defined requirements. Opaque to Bannou; no plugin reads keys by convention.
        display:
          type: object
          nullable: true
          description: Display properties. Opaque to Bannou; no plugin reads keys by convention.
        metadata:
          type: object
          nullable: true
          description: Additional game-specific data. Opaque to Bannou; no plugin reads keys by convention.
        useBehaviorContractTemplateId:
          type: string
          format: uuid
          nullable: true
          description: Contract template ID for executable item behavior (null if not usable)
        canUseBehaviorContractTemplateId:
          type: string
          format: uuid
          nullable: true
          description: Contract template for pre-use validation (null if not configured)
        onUseFailedBehaviorContractTemplateId:
          type: string
          format: uuid
          nullable: true
          description: Contract template for use failure handling (null if not configured)
        itemUseBehavior:
          $ref: '#/components/schemas/ItemUseBehavior'
          nullable: true
          description: How the item behaves when used (null defaults to destroy_on_success)
        canUseBehavior:
          $ref: '#/components/schemas/CanUseBehavior'
          nullable: true
          description: How CanUse validation failures are handled (null defaults to block)
        isActive:
          type: boolean
          description: Whether template is active
        isDeprecated:
          type: boolean
          description: Whether template is deprecated
        deprecatedAt:
          type: string
          format: date-time
          nullable: true
          description: When template was deprecated
        deprecationReason:
          type: string
          nullable: true
          maxLength: 500
          description: Reason for deprecation
        migrationTargetId:
          type: string
          format: uuid
          nullable: true
          description: Migration target template
        createdAt:
          type: string
          format: date-time
          description: Creation timestamp
        updatedAt:
          type: string
          format: date-time
          description: Last update timestamp

    ListItemTemplatesResponse:
      type: object
      description: Paginated list of item templates
      additionalProperties: false
      required:
      - templates
      - totalCount
      properties:
        templates:
          type: array
          items:
            $ref: '#/components/schemas/ItemTemplateResponse'
          description: List of templates
        totalCount:
          type: integer
          description: Total number of matching templates

    # =========================================================================
    # Item Instance Models
    # =========================================================================

    CreateItemInstanceRequest:
      type: object
      description: Request to create a new item instance
      additionalProperties: false
      required:
      - templateId
      - containerId
      - realmId
      - quantity
      - originType
      properties:
        templateId:
          type: string
          format: uuid
          description: Template to instantiate
        containerId:
          type: string
          format: uuid
          description: Container to place the item in
        realmId:
          type: string
          format: uuid
          description: Realm this instance exists in
        quantity:
          type: number
          format: double
          minimum: 0
          exclusiveMinimum: true
          description: Item quantity (respects template's quantityModel)
        slotIndex:
          type: integer
          nullable: true
          description: Slot position in slot-based containers
        slotX:
          type: integer
          nullable: true
          description: X position in grid-based containers
        slotY:
          type: integer
          nullable: true
          description: Y position in grid-based containers
        rotated:
          type: boolean
          nullable: true
          description: Whether item is rotated in grid
        currentDurability:
          type: integer
          nullable: true
          description: Initial durability (defaults to template's maxDurability)
        customStats:
          type: object
          nullable: true
          description: Instance-specific stat modifications. Opaque to Bannou; no plugin reads keys by convention.
        customName:
          type: string
          maxLength: 128
          nullable: true
          description: Player-assigned custom name
        instanceMetadata:
          type: object
          nullable: true
          description: Additional instance-specific data. Opaque to Bannou; no plugin reads keys by convention.
        originType:
          $ref: '#/components/schemas/ItemOriginType'
          description: How this item instance was created
        originId:
          type: string
          format: uuid
          nullable: true
          description: Source entity ID (quest ID, creature ID, etc.)
        contractInstanceId:
          type: string
          format: uuid
          nullable: true
          description: |
            Bound contract instance ID. For persistent item-contract bindings (status effects,
            licenses, memberships), this references the controlling contract. NULL for items
            without persistent contract relationships.
        contractBindingType:
          $ref: '#/components/schemas/ContractBindingType'
          nullable: true
          description: |
            Type of contract binding. When contractInstanceId is provided, this indicates
            whether it's a lifecycle binding (managed externally) or session binding
            (managed by Item service). Defaults to 'lifecycle' when contractInstanceId is set.

    GetItemInstanceRequest:
      type: object
      description: Request to get an item instance
      additionalProperties: false
      required:
      - instanceId
      properties:
        instanceId:
          type: string
          format: uuid
          description: Instance ID to retrieve

    ModifyItemInstanceRequest:
      type: object
      description: Request to modify item instance state
      additionalProperties: false
      required:
      - instanceId
      properties:
        instanceId:
          type: string
          format: uuid
          description: Instance ID to modify
        durabilityDelta:
          type: integer
          nullable: true
          description: Change to durability (positive to repair, negative for damage)
        customStats:
          type: object
          nullable: true
          description: New custom stats (merges with existing). Opaque to Bannou; no plugin reads keys by convention.
        customName:
          type: string
          maxLength: 128
          nullable: true
          description: New custom name
        quantityDelta:
          type: number
          format: double
          nullable: true
          description: Change to quantity (positive to add, negative to subtract). Only valid for stackable items.
        instanceMetadata:
          type: object
          nullable: true
          description: New instance metadata (merges with existing). Opaque to Bannou; no plugin reads keys by convention.
        newContainerId:
          type: string
          format: uuid
          nullable: true
          description: Move item to a different container. Used by inventory service for item movement.
        newSlotIndex:
          type: integer
          nullable: true
          description: New slot index within the container
        newSlotX:
          type: integer
          nullable: true
          description: New X position for grid-based containers
        newSlotY:
          type: integer
          nullable: true
          description: New Y position for grid-based containers

    BindItemInstanceRequest:
      type: object
      description: Request to bind an item to a character
      additionalProperties: false
      required:
      - instanceId
      - characterId
      - bindType
      properties:
        instanceId:
          type: string
          format: uuid
          description: Instance ID to bind
        characterId:
          type: string
          format: uuid
          description: Character to bind the item to
        bindType:
          $ref: '#/components/schemas/SoulboundType'
          description: Type of binding to apply

    UnbindItemInstanceRequest:
      type: object
      description: Request to unbind an item from a character
      additionalProperties: false
      required:
      - instanceId
      - reason
      properties:
        instanceId:
          type: string
          format: uuid
          description: Instance ID to unbind
        reason:
          $ref: '#/components/schemas/UnbindReason'
          description: Reason for unbinding

    DestroyItemInstanceRequest:
      type: object
      description: Request to destroy an item instance
      additionalProperties: false
      required:
      - instanceId
      - reason
      properties:
        instanceId:
          type: string
          format: uuid
          description: Instance ID to destroy
        reason:
          $ref: '#/components/schemas/DestroyReason'
          description: Reason for destruction

    ItemInstanceResponse:
      type: object
      description: Item instance details
      additionalProperties: false
      required:
      - instanceId
      - templateId
      - containerId
      - realmId
      - quantity
      - originType
      - createdAt
      properties:
        instanceId:
          type: string
          format: uuid
          description: Unique instance identifier
        templateId:
          type: string
          format: uuid
          description: Reference to the item template
        containerId:
          type: string
          format: uuid
          description: Container holding this item
        realmId:
          type: string
          format: uuid
          description: Realm this instance exists in
        quantity:
          type: number
          format: double
          description: Item quantity
        slotIndex:
          type: integer
          nullable: true
          description: Slot position in slot-based containers
        slotX:
          type: integer
          nullable: true
          description: X position in grid-based containers
        slotY:
          type: integer
          nullable: true
          description: Y position in grid-based containers
        rotated:
          type: boolean
          nullable: true
          description: Whether item is rotated in grid
        currentDurability:
          type: integer
          nullable: true
          description: Current durability
        boundToId:
          type: string
          format: uuid
          nullable: true
          description: Character ID this item is bound to
        boundAt:
          type: string
          format: date-time
          nullable: true
          description: When item was bound
        customStats:
          type: object
          nullable: true
          description: Instance-specific stat modifications. Opaque to Bannou; no plugin reads keys by convention.
        customName:
          type: string
          nullable: true
          description: Player-assigned custom name
        instanceMetadata:
          type: object
          nullable: true
          description: Additional instance-specific data. Opaque to Bannou; no plugin reads keys by convention.
        originType:
          $ref: '#/components/schemas/ItemOriginType'
          description: How this item instance was created
        originId:
          type: string
          format: uuid
          nullable: true
          description: Source entity ID
        contractInstanceId:
          type: string
          format: uuid
          nullable: true
          description: |
            Bound contract instance ID. For persistent item-contract bindings or active
            multi-step use sessions, this references the controlling contract.
        contractBindingType:
          $ref: '#/components/schemas/ContractBindingType'
          nullable: true
          description: |
            Type of contract binding. 'session' for multi-step use in progress,
            'lifecycle' for external orchestrator-managed bindings, null/none otherwise.
        createdAt:
          type: string
          format: date-time
          description: Instance creation timestamp
        modifiedAt:
          type: string
          format: date-time
          nullable: true
          description: Last modification timestamp

    DestroyItemInstanceResponse:
      type: object
      description: Response after destroying an item instance
      additionalProperties: false
      required:
      - templateId
      properties:
        templateId:
          type: string
          format: uuid
          description: Template of the destroyed instance

    # =========================================================================
    # Query Models
    # =========================================================================

    ListItemsByContainerRequest:
      type: object
      description: Request to list items in a container
      additionalProperties: false
      required:
      - containerId
      properties:
        containerId:
          type: string
          format: uuid
          description: Container to list items from

    ListItemsByTemplateRequest:
      type: object
      description: Request to list instances of a template
      additionalProperties: false
      required:
      - templateId
      properties:
        templateId:
          type: string
          format: uuid
          description: Template to find instances of
        realmId:
          type: string
          format: uuid
          nullable: true
          description: Filter by realm
        offset:
          type: integer
          minimum: 0
          default: 0
          description: Pagination offset
        limit:
          type: integer
          minimum: 1
          maximum: 200
          default: 50
          description: Maximum results to return

    ListItemsResponse:
      type: object
      description: List of item instances
      additionalProperties: false
      required:
      - items
      - totalCount
      - wasTruncated
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/ItemInstanceResponse'
          description: List of items
        totalCount:
          type: integer
          description: Total number of matching items (actual count, may exceed items returned)
        wasTruncated:
          type: boolean
          description: True if the result was truncated due to MaxInstancesPerQuery limit
          default: false

    BatchGetItemInstancesRequest:
      type: object
      description: Request to get multiple item instances
      additionalProperties: false
      required:
      - instanceIds
      properties:
        instanceIds:
          type: array
          items:
            type: string
            format: uuid
          minItems: 1
          maxItems: 100
          description: Instance IDs to retrieve

    BatchGetItemInstancesResponse:
      type: object
      description: Multiple item instances
      additionalProperties: false
      required:
      - items
      - notFound
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/ItemInstanceResponse'
          description: Found items
        notFound:
          type: array
          items:
            type: string
            format: uuid
          description: Instance IDs that were not found

    # =========================================================================
    # Item Use Models
    # =========================================================================

    UseItemRequest:
      type: object
      description: Request to use an item instance by executing its behavior contract
      additionalProperties: false
      required:
      - instanceId
      - userId
      - userType
      properties:
        instanceId:
          type: string
          format: uuid
          description: Unique identifier of the item instance to use
        userId:
          type: string
          format: uuid
          description: Unique identifier of the entity using the item (character, account, or actor)
        userType:
          $ref: 'common-api.yaml#/components/schemas/EntityType'
          description: Type of user entity performing the use action
        targetId:
          type: string
          format: uuid
          nullable: true
          description: Optional unique identifier of the target entity for directional item effects
        targetType:
          $ref: 'common-api.yaml#/components/schemas/EntityType'
          nullable: true
          description: Type of target entity when targetId is provided
        context:
          type: object
          additionalProperties: true
          nullable: true
          description: >-
            Caller-provided context merged into contract gameMetadata for template value substitution.
            No Bannou plugin reads specific keys from this field by convention.

    UseItemResponse:
      type: object
      description: Response containing the result of an item use attempt
      additionalProperties: false
      required:
      - templateId
      - consumed
      properties:
        templateId:
          type: string
          format: uuid
          description: Unique identifier of the item template defining the used item
        contractInstanceId:
          type: string
          format: uuid
          nullable: true
          description: Unique identifier of the contract instance created for this use (null if creation failed)
        consumed:
          type: boolean
          description: Whether the item was consumed (quantity decremented or destroyed)
        remainingQuantity:
          type: number
          format: double
          nullable: true
          description: Remaining quantity after use (null if item was fully consumed or destroyed)
        failureReason:
          type: string
          nullable: true
          description: Human-readable reason for failure when success is false

    # =========================================================================
    # Multi-Step Item Use Models
    # =========================================================================

    UseItemStepRequest:
      type: object
      description: Request to complete a step of a multi-step item use
      additionalProperties: false
      required:
      - instanceId
      - userId
      - userType
      - milestoneCode
      properties:
        instanceId:
          type: string
          format: uuid
          description: Item instance being used
        userId:
          type: string
          format: uuid
          description: User performing the step
        userType:
          $ref: 'common-api.yaml#/components/schemas/EntityType'
          description: Type of user entity performing the step
        milestoneCode:
          type: string
          maxLength: 64
          description: Milestone code to complete in the use behavior contract
        evidence:
          type: object
          additionalProperties: true
          nullable: true
          description: >-
            Evidence data passed through to Contract milestone completion.
            No Bannou plugin reads specific keys from this field by convention.
        context:
          type: object
          additionalProperties: true
          nullable: true
          description: >-
            Caller-provided context merged into contract gameMetadata for template value substitution.
            No Bannou plugin reads specific keys from this field by convention.

    UseItemStepResponse:
      type: object
      description: Response from completing a multi-step item use milestone
      additionalProperties: false
      required:
      - instanceId
      - contractInstanceId
      - completedMilestone
      - isComplete
      - consumed
      properties:
        instanceId:
          type: string
          format: uuid
          description: Item instance ID
        contractInstanceId:
          type: string
          format: uuid
          description: Contract instance tracking this use session
        completedMilestone:
          type: string
          description: The milestone that was completed
        remainingMilestones:
          type: array
          items:
            type: string
          nullable: true
          description: Milestones still to be completed (null if complete or failed)
        isComplete:
          type: boolean
          description: Whether all required milestones are complete
        consumed:
          type: boolean
          description: Whether item was consumed (only true when all steps complete per itemUseBehavior)
        failureReason:
          type: string
          nullable: true
          description: Human-readable reason for failure when success is false
