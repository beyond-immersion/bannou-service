openapi: 3.0.0
info:
  title: Bannou Auth Service API
  description: Generic authentication service supporting email/password, OAuth2, and Steam
  version: 2.0.0
servers:
  - url: http://localhost:3500/v1.0/invoke/bannou/method
    description: Dapr sidecar endpoint

paths:
  /auth/register:
    post:
      summary: Register new account with email/password
      operationId: register
      tags:
        - Registration
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '201':
          description: Account created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RegisterResponse'
        '400':
          description: Invalid registration data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Email already registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/login:
    post:
      summary: Login with email/password
      operationId: login
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          description: Too many login attempts
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/oauth/{provider}/init:
    get:
      summary: Initialize OAuth2 flow
      operationId: initOAuth
      tags:
        - OAuth
      parameters:
        - name: provider
          in: path
          required: true
          schema:
            type: string
            enum: [google, discord, twitch]
        - name: redirectUri
          in: query
          required: true
          schema:
            type: string
            format: uri
        - name: state
          in: query
          schema:
            type: string
          description: Client state to maintain across OAuth flow
      responses:
        '302':
          description: Redirect to OAuth provider
          headers:
            Location:
              schema:
                type: string
                format: uri
        '400':
          description: Invalid provider or parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/oauth/{provider}/callback:
    post:
      summary: Complete OAuth2 flow
      operationId: completeOAuth
      tags:
        - OAuth
      parameters:
        - name: provider
          in: path
          required: true
          schema:
            type: string
            enum: [google, discord, twitch]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OAuthCallbackRequest'
      responses:
        '200':
          description: OAuth authentication successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          description: OAuth flow failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/steam/init:
    get:
      summary: Initialize Steam authentication
      operationId: initSteamAuth
      tags:
        - Steam
      parameters:
        - name: returnUrl
          in: query
          required: true
          schema:
            type: string
            format: uri
          description: URL to return to after Steam authentication
      responses:
        '302':
          description: Redirect to Steam login
          headers:
            Location:
              schema:
                type: string
                format: uri
        '400':
          description: Invalid parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/steam/verify:
    post:
      summary: Verify Steam authentication response
      operationId: verifySteamAuth
      tags:
        - Steam
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SteamVerifyRequest'
      responses:
        '200':
          description: Steam authentication successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: Steam verification failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/link:
    post:
      summary: Link external account to existing account
      operationId: linkAccount
      tags:
        - Account Linking
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LinkAccountRequest'
      responses:
        '200':
          description: Account linked successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LinkAccountResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: External account already linked
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/unlink:
    post:
      summary: Unlink external account
      operationId: unlinkAccount
      tags:
        - Account Linking
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UnlinkAccountRequest'
      responses:
        '200':
          description: Account unlinked successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenericResponse'
        '400':
          description: Cannot unlink last authentication method
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/refresh:
    post:
      summary: Refresh access token
      operationId: refreshToken
      tags:
        - Tokens
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshRequest'
      responses:
        '200':
          description: Token refreshed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: Invalid refresh token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/validate:
    post:
      summary: Validate access token
      operationId: validateToken
      tags:
        - Tokens
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Token is valid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationResponse'
        '401':
          description: Invalid token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/logout:
    post:
      summary: Logout and invalidate tokens
      operationId: logout
      tags:
        - Authentication
      security:
        - BearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LogoutRequest'
      responses:
        '200':
          description: Logged out successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenericResponse'

  /auth/sessions:
    get:
      summary: Get active sessions for account
      operationId: getSessions
      tags:
        - Sessions
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Active sessions retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionsResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/sessions/{sessionId}:
    delete:
      summary: Terminate specific session
      operationId: terminateSession
      tags:
        - Sessions
      security:
        - BearerAuth: []
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Session terminated
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/password/reset:
    post:
      summary: Request password reset
      operationId: requestPasswordReset
      tags:
        - Password
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PasswordResetRequest'
      responses:
        '200':
          description: Reset email sent if account exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenericResponse'

  /auth/password/confirm:
    post:
      summary: Confirm password reset with token
      operationId: confirmPasswordReset
      tags:
        - Password
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PasswordResetConfirmRequest'
      responses:
        '200':
          description: Password reset successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenericResponse'
        '400':
          description: Invalid or expired token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    RegisterRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          format: password
          minLength: 8
        displayName:
          type: string
          nullable: true
          maxLength: 32
        acceptTerms:
          type: boolean
          default: false
        acceptMarketing:
          type: boolean
          default: false
        metadata:
          type: object
          additionalProperties: true
          description: Game-specific metadata

    RegisterResponse:
      type: object
      required:
        - accountId
        - message
      properties:
        accountId:
          type: string
          format: uuid
        message:
          type: string
        requiresVerification:
          type: boolean
          default: true

    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          format: password
        rememberMe:
          type: boolean
          default: false
        deviceInfo:
          $ref: '#/components/schemas/DeviceInfo'

    AuthResponse:
      type: object
      required:
        - accountId
        - accessToken
        - refreshToken
        - expiresIn
        - connectUrl
      properties:
        accountId:
          type: string
          format: uuid
        accessToken:
          type: string
        refreshToken:
          type: string
        expiresIn:
          type: integer
          description: Seconds until access token expires
        connectUrl:
          type: string
          format: uri
          description: WebSocket endpoint for Connect service
        roles:
          type: array
          items:
            type: string
        authMethods:
          type: array
          items:
            $ref: '#/components/schemas/AuthMethod'
        requiresTwoFactor:
          type: boolean
          default: false

    OAuthCallbackRequest:
      type: object
      required:
        - code
      properties:
        code:
          type: string
        state:
          type: string
          nullable: true
        deviceInfo:
          $ref: '#/components/schemas/DeviceInfo'

    SteamVerifyRequest:
      type: object
      required:
        - ticket
      properties:
        ticket:
          type: string
          description: Steam session ticket
        steamId:
          type: string
        deviceInfo:
          $ref: '#/components/schemas/DeviceInfo'

    LinkAccountRequest:
      type: object
      required:
        - provider
      properties:
        provider:
          type: string
          enum: [google, steam, discord, twitch]
        code:
          type: string
          description: OAuth code or Steam ticket
        redirectUri:
          type: string
          format: uri
          nullable: true

    LinkAccountResponse:
      type: object
      required:
        - success
        - linkedProvider
      properties:
        success:
          type: boolean
        linkedProvider:
          type: string
        authMethods:
          type: array
          items:
            $ref: '#/components/schemas/AuthMethod'

    UnlinkAccountRequest:
      type: object
      required:
        - provider
      properties:
        provider:
          type: string
          enum: [google, steam, discord, twitch]

    RefreshRequest:
      type: object
      required:
        - refreshToken
      properties:
        refreshToken:
          type: string

    ValidationResponse:
      type: object
      required:
        - valid
        - accountId
      properties:
        valid:
          type: boolean
        accountId:
          type: string
          format: uuid
        roles:
          type: array
          items:
            type: string
        remainingTime:
          type: integer
          description: Seconds until expiration
        authMethods:
          type: array
          items:
            $ref: '#/components/schemas/AuthMethod'

    LogoutRequest:
      type: object
      properties:
        allSessions:
          type: boolean
          default: false
          description: Logout from all sessions/devices

    SessionsResponse:
      type: object
      required:
        - sessions
      properties:
        sessions:
          type: array
          items:
            $ref: '#/components/schemas/SessionInfo'

    SessionInfo:
      type: object
      required:
        - sessionId
        - createdAt
        - lastActive
      properties:
        sessionId:
          type: string
          format: uuid
        deviceInfo:
          $ref: '#/components/schemas/DeviceInfo'
        createdAt:
          type: string
          format: date-time
        lastActive:
          type: string
          format: date-time
        ipAddress:
          type: string
        location:
          type: string
          nullable: true

    DeviceInfo:
      type: object
      properties:
        deviceType:
          type: string
          enum: [desktop, mobile, tablet, console]
        platform:
          type: string
        browser:
          type: string
          nullable: true
        appVersion:
          type: string
          nullable: true

    AuthMethod:
      type: object
      required:
        - provider
        - linkedAt
      properties:
        provider:
          type: string
          enum: [email, google, steam, discord, twitch]
        externalId:
          type: string
          nullable: true
        displayName:
          type: string
          nullable: true
        linkedAt:
          type: string
          format: date-time

    PasswordResetRequest:
      type: object
      required:
        - email
      properties:
        email:
          type: string
          format: email

    PasswordResetConfirmRequest:
      type: object
      required:
        - token
        - newPassword
      properties:
        token:
          type: string
        newPassword:
          type: string
          format: password
          minLength: 8

    GenericResponse:
      type: object
      required:
        - success
        - message
      properties:
        success:
          type: boolean
        message:
          type: string

    ErrorResponse:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
        message:
          type: string
        details:
          type: object
          additionalProperties: true
          nullable: true
