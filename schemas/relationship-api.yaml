openapi: 3.0.0
info:
  title: Relationship Service API
  version: 1.0.0
  description: |
    Generic relationship management service for entity-to-entity relationships.

    This service manages relationships between ANY two entities in the system,
    not just characters. Supported entity types include characters, NPCs,
    monsters, items, locations, organizations, factions, and more.

    Key features:
    - Entity-agnostic relationship management
    - Composite uniqueness validation (entity1 + entity2 + type = unique)
    - Bidirectional relationship support
    - Type-specific metadata storage
    - Soft-delete via endedAt (relationships can be re-created after ending)

    **SCHEMA MODIFICATION GATE**: STOP. Before modifying this schema, you MUST:
    1. Read docs/reference/SCHEMA-RULES.md
    2. State which section applies to your change
    3. Only then proceed with edits
    Edits without stating the applicable rule are FORBIDDEN.
x-service-layer: GameFoundation
servers:
- url: http://localhost:5012

# NOTE: x-lifecycle moved to relationship-events.yaml

paths:
  /relationship/create:
    post:
      operationId: createRelationship
      tags:
      - Relationship Management
      summary: Create a new relationship between two entities
      description: |
        Creates a relationship between two entities.
        Duplicate relationships (same entities + same type) are prevented.
        Relationships can be re-created after being ended.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateRelationshipRequest'
      responses:
        '200':
          description: Relationship created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RelationshipResponse'
        '400':
          description: Invalid request (missing fields, invalid entity types)
        '409':
          description: Relationship already exists between these entities with this type
      x-permissions:
      - role: admin
        states: {}

  /relationship/get:
    post:
      operationId: getRelationship
      tags:
      - Relationship Management
      summary: Get a relationship by ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetRelationshipRequest'
      responses:
        '200':
          description: Relationship retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RelationshipResponse'
        '404':
          description: Relationship not found
      x-permissions:
      - role: user
        states: {}

  /relationship/list-by-entity:
    post:
      operationId: listRelationshipsByEntity
      tags:
      - Relationship Management
      summary: List all relationships for an entity
      description: |
        Returns all relationships where the specified entity is either
        entity1 or entity2. Supports filtering by relationship type,
        other entity type, and whether to include ended relationships.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ListRelationshipsByEntityRequest'
      responses:
        '200':
          description: Relationships retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RelationshipListResponse'
      x-permissions:
      - role: user
        states: {}

  /relationship/get-between:
    post:
      operationId: getRelationshipsBetween
      tags:
      - Relationship Management
      summary: Get all relationships between two specific entities
      description: |
        Returns all relationships that exist between two specific entities,
        regardless of which is entity1 or entity2.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetRelationshipsBetweenRequest'
      responses:
        '200':
          description: Relationships retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RelationshipListResponse'
      x-permissions:
      - role: user
        states: {}

  /relationship/list-by-type:
    post:
      operationId: listRelationshipsByType
      tags:
      - Relationship Management
      summary: List all relationships of a specific type
      description: |
        Returns all relationships that use a specific relationship type.
        Useful for finding all "FRIEND" relationships, for example.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ListRelationshipsByTypeRequest'
      responses:
        '200':
          description: Relationships retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RelationshipListResponse'
      x-permissions:
      - role: user
        states: {}

  /relationship/update:
    post:
      operationId: updateRelationship
      tags:
      - Relationship Management
      summary: Update relationship metadata
      description: Only metadata can be updated. Entity IDs and types cannot be changed.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateRelationshipRequest'
      responses:
        '200':
          description: Relationship updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RelationshipResponse'
        '404':
          description: Relationship not found
      x-permissions:
      - role: admin
        states: {}

  /relationship/end:
    post:
      operationId: endRelationship
      tags:
      - Relationship Management
      summary: End a relationship
      description: |
        Marks a relationship as ended with a timestamp.
        Ended relationships are preserved for history and can be re-created.
        The composite uniqueness key is cleared, allowing new relationships
        between the same entities with the same type.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EndRelationshipRequest'
      responses:
        '200':
          description: Relationship ended successfully
        '404':
          description: Relationship not found
      x-permissions:
      - role: admin
        states: {}

components:
  schemas:
    # Request Models
    CreateRelationshipRequest:
      description: Request to create a new relationship between two entities
      type: object
      additionalProperties: false
      required:
      - entity1Id
      - entity1Type
      - entity2Id
      - entity2Type
      - relationshipTypeId
      - startedAt
      properties:
        entity1Id:
          type: string
          format: uuid
          description: ID of the first entity in the relationship
        entity1Type:
          $ref: 'common-api.yaml#/components/schemas/EntityType'
          description: Type of the first entity in the relationship
        entity2Id:
          type: string
          format: uuid
          description: ID of the second entity in the relationship
        entity2Type:
          $ref: 'common-api.yaml#/components/schemas/EntityType'
          description: Type of the second entity in the relationship
        relationshipTypeId:
          type: string
          format: uuid
          description: Relationship type ID (from RelationshipType service)
        startedAt:
          type: string
          format: date-time
          description: In-game timestamp when relationship started
        metadata:
          type: object
          additionalProperties: true
          nullable: true
          description: Type-specific relationship data (JSON)

    GetRelationshipRequest:
      description: Request to retrieve a specific relationship by its ID
      type: object
      additionalProperties: false
      required:
      - relationshipId
      properties:
        relationshipId:
          type: string
          format: uuid
          description: ID of the relationship to retrieve

    ListRelationshipsByEntityRequest:
      description: Request to list all relationships for a specific entity with optional filters
      type: object
      additionalProperties: false
      required:
      - entityId
      - entityType
      properties:
        entityId:
          type: string
          format: uuid
          description: ID of the entity to get relationships for
        entityType:
          $ref: 'common-api.yaml#/components/schemas/EntityType'
          description: Type of the entity to get relationships for
        relationshipTypeId:
          type: string
          format: uuid
          nullable: true
          description: Optional filter by relationship type
        otherEntityType:
          $ref: 'common-api.yaml#/components/schemas/EntityType'
          nullable: true
          description: Optional filter by the other entity's type
        includeEnded:
          type: boolean
          default: false
          description: Include relationships that have ended
        page:
          type: integer
          minimum: 1
          default: 1
          description: Page number for paginated results (1-based)
        pageSize:
          type: integer
          minimum: 1
          maximum: 100
          default: 20
          description: Number of results per page (max 100)

    GetRelationshipsBetweenRequest:
      description: Request to get all relationships between two specific entities
      type: object
      additionalProperties: false
      required:
      - entity1Id
      - entity1Type
      - entity2Id
      - entity2Type
      properties:
        entity1Id:
          type: string
          format: uuid
          description: ID of the first entity to check relationships for
        entity1Type:
          $ref: 'common-api.yaml#/components/schemas/EntityType'
          description: Type of the first entity
        entity2Id:
          type: string
          format: uuid
          description: ID of the second entity to check relationships for
        entity2Type:
          $ref: 'common-api.yaml#/components/schemas/EntityType'
          description: Type of the second entity
        relationshipTypeId:
          type: string
          format: uuid
          nullable: true
          description: Optional filter by relationship type
        includeEnded:
          type: boolean
          default: false
          description: Include relationships that have ended

    ListRelationshipsByTypeRequest:
      description: Request to list all relationships of a specific relationship type
      type: object
      additionalProperties: false
      required:
      - relationshipTypeId
      properties:
        relationshipTypeId:
          type: string
          format: uuid
          description: Relationship type to filter by
        entity1Type:
          $ref: 'common-api.yaml#/components/schemas/EntityType'
          nullable: true
          description: Optional filter by entity1 type
        entity2Type:
          $ref: 'common-api.yaml#/components/schemas/EntityType'
          nullable: true
          description: Optional filter by entity2 type
        includeEnded:
          type: boolean
          default: false
          description: Include relationships that have ended
        page:
          type: integer
          minimum: 1
          default: 1
          description: Page number for paginated results (1-based)
        pageSize:
          type: integer
          minimum: 1
          maximum: 100
          default: 20
          description: Number of results per page (max 100)

    UpdateRelationshipRequest:
      description: Request to update the metadata or type of an existing relationship
      type: object
      additionalProperties: false
      required:
      - relationshipId
      properties:
        relationshipId:
          type: string
          format: uuid
          description: ID of the relationship to update
        relationshipTypeId:
          type: string
          format: uuid
          nullable: true
          description: Update relationship type (used for type merge migrations)
        metadata:
          type: object
          additionalProperties: true
          nullable: true
          description: Updated type-specific relationship data

    EndRelationshipRequest:
      description: Request to end an existing relationship with an optional timestamp and reason
      type: object
      additionalProperties: false
      required:
      - relationshipId
      properties:
        relationshipId:
          type: string
          format: uuid
          description: ID of the relationship to end
        endedAt:
          type: string
          format: date-time
          description: In-game timestamp when relationship ended (defaults to now)
        reason:
          type: string
          nullable: true
          maxLength: 500
          description: Optional reason for ending the relationship

    # Response Models
    RelationshipResponse:
      description: Complete details of a relationship between two entities
      type: object
      additionalProperties: false
      required:
      - relationshipId
      - entity1Id
      - entity1Type
      - entity2Id
      - entity2Type
      - relationshipTypeId
      - startedAt
      - createdAt
      properties:
        relationshipId:
          type: string
          format: uuid
          description: Unique identifier of the relationship
        entity1Id:
          type: string
          format: uuid
          description: ID of the first entity in the relationship
        entity1Type:
          $ref: 'common-api.yaml#/components/schemas/EntityType'
          description: Type of the first entity in the relationship
        entity2Id:
          type: string
          format: uuid
          description: ID of the second entity in the relationship
        entity2Type:
          $ref: 'common-api.yaml#/components/schemas/EntityType'
          description: Type of the second entity in the relationship
        relationshipTypeId:
          type: string
          format: uuid
          description: Relationship type ID (from RelationshipType service)
        startedAt:
          type: string
          format: date-time
          description: In-game timestamp when relationship started
        endedAt:
          type: string
          format: date-time
          nullable: true
          description: In-game timestamp when relationship ended, null if still active
        metadata:
          type: object
          additionalProperties: true
          nullable: true
          description: Type-specific relationship data
        createdAt:
          type: string
          format: date-time
          description: System timestamp when the relationship record was created
        updatedAt:
          type: string
          format: date-time
          nullable: true
          description: System timestamp when the relationship record was last updated

    RelationshipListResponse:
      description: Paginated list of relationships with metadata for navigation
      type: object
      additionalProperties: false
      required:
      - relationships
      - totalCount
      - page
      - pageSize
      properties:
        relationships:
          type: array
          items:
            $ref: '#/components/schemas/RelationshipResponse'
          description: List of relationships matching the query
        totalCount:
          type: integer
          description: Total number of relationships matching the query
        page:
          type: integer
          description: Current page number (1-based)
        pageSize:
          type: integer
          description: Number of results per page
        hasNextPage:
          type: boolean
          description: Whether there are more results on the next page
        hasPreviousPage:
          type: boolean
          description: Whether there are results on the previous page
