openapi: 3.0.3
info:
  title: Mesh Service Configuration
  description: |
    Configuration schema for the native service mesh plugin.
    Properties are bound to environment variables with MESH_ prefix.

    **State Management**: Mesh uses lib-state for Redis access via IStateStoreFactory.
    State store configuration is managed in schemas/state-stores.yaml.

    **Heartbeat Configuration**: Controls endpoint TTL and health monitoring.

    **Load Balancing**: Algorithm selection and routing behavior.

    **NRT Compliance**: AI agents MUST review docs/NRT-SCHEMA-RULES.md before
    modifying this schema. Optional reference types require `nullable: true`.
  version: 2.0.0
paths: {}
x-service-configuration:
  properties:
    # =========================================================================
    # Local Mode (for testing/minimal infrastructure)
    # =========================================================================
    UseLocalRouting:
      type: boolean
      description: "Use local-only routing instead of lib-state. All calls route to local instance. ONLY for testing/minimal infrastructure."
      env: MESH_USE_LOCAL_ROUTING
      default: false

    # =========================================================================
    # Endpoint Registration Configuration
    # =========================================================================
    EndpointHost:
      type: string
      description: Hostname/IP for mesh endpoint registration. Defaults to app-id for Docker Compose compatibility.
      env: MESH_ENDPOINT_HOST
      nullable: true
      example: "bannou-service"

    EndpointPort:
      type: integer
      description: Port for mesh endpoint registration.
      env: MESH_ENDPOINT_PORT
      default: 80

    # =========================================================================
    # Heartbeat and TTL Configuration
    # =========================================================================
    HeartbeatIntervalSeconds:
      type: integer
      description: Recommended interval between heartbeats
      env: MESH_HEARTBEAT_INTERVAL_SECONDS
      default: 30

    EndpointTtlSeconds:
      type: integer
      description: TTL for endpoint registration (should be > 2x heartbeat interval)
      env: MESH_ENDPOINT_TTL_SECONDS
      default: 90

    DegradationThresholdSeconds:
      type: integer
      description: Time without heartbeat before marking endpoint as degraded
      env: MESH_DEGRADATION_THRESHOLD_SECONDS
      default: 60

    # =========================================================================
    # Load Balancing Configuration
    # =========================================================================
    DefaultLoadBalancer:
      type: string
      description: Default load balancing algorithm (RoundRobin, LeastConnections, Weighted, Random)
      env: MESH_DEFAULT_LOAD_BALANCER
      default: "RoundRobin"

    LoadThresholdPercent:
      type: integer
      description: Load percentage above which an endpoint is considered high-load
      env: MESH_LOAD_THRESHOLD_PERCENT
      default: 80

    # =========================================================================
    # Routing Configuration
    # =========================================================================
    EnableServiceMappingSync:
      type: boolean
      description: Whether to subscribe to FullServiceMappingsEvent for routing updates
      env: MESH_ENABLE_SERVICE_MAPPING_SYNC
      default: true

    # =========================================================================
    # Health Check Configuration
    # =========================================================================
    HealthCheckEnabled:
      type: boolean
      description: Whether to perform active health checks on endpoints
      env: MESH_HEALTH_CHECK_ENABLED
      default: false

    HealthCheckIntervalSeconds:
      type: integer
      description: Interval between active health checks
      env: MESH_HEALTH_CHECK_INTERVAL_SECONDS
      default: 60

    HealthCheckTimeoutSeconds:
      type: integer
      description: Timeout for health check requests
      env: MESH_HEALTH_CHECK_TIMEOUT_SECONDS
      default: 5

    # =========================================================================
    # Circuit Breaker Configuration
    # =========================================================================
    CircuitBreakerEnabled:
      type: boolean
      description: Whether to enable circuit breaker for failed endpoints
      env: MESH_CIRCUIT_BREAKER_ENABLED
      default: true

    CircuitBreakerThreshold:
      type: integer
      description: Number of consecutive failures before opening circuit
      env: MESH_CIRCUIT_BREAKER_THRESHOLD
      default: 5

    CircuitBreakerResetSeconds:
      type: integer
      description: Seconds before attempting to close circuit
      env: MESH_CIRCUIT_BREAKER_RESET_SECONDS
      default: 30

    # =========================================================================
    # Retry Configuration
    # =========================================================================
    MaxRetries:
      type: integer
      description: Maximum retry attempts for failed service calls
      env: MESH_MAX_RETRIES
      default: 3

    RetryDelayMilliseconds:
      type: integer
      description: Initial delay between retries (doubles on each retry)
      env: MESH_RETRY_DELAY_MILLISECONDS
      default: 100

    # =========================================================================
    # Logging and Diagnostics
    # =========================================================================
    EnableDetailedLogging:
      type: boolean
      description: Whether to log detailed routing decisions
      env: MESH_ENABLE_DETAILED_LOGGING
      default: false

    MetricsEnabled:
      type: boolean
      description: Whether to collect routing metrics
      env: MESH_METRICS_ENABLED
      default: true
