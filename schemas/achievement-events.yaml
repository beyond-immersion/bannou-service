openapi: 3.0.3
info:
  title: Achievement Service Events
  description: |
    Event subscription and publication declarations for Achievement service.

    **Data Flow**: Achievement subscribes to analytics events for progress tracking:
    - Subscribes to analytics.score.updated for automatic progress
    - Subscribes to analytics.milestone.reached for milestone achievements
    - Publishes achievement.unlocked for client notifications and other services

    **NRT Compliance**: AI agents MUST review docs/NRT-SCHEMA-RULES.md before
    modifying this schema. Optional reference types require `nullable: true`.
  version: 1.0.0
  x-event-subscriptions:
    # Analytics events for automatic progress tracking
    - topic: analytics.score.updated
      event: AnalyticsScoreUpdatedEvent
      handler: HandleScoreUpdated
    - topic: analytics.milestone.reached
      event: AnalyticsMilestoneReachedEvent
      handler: HandleMilestoneReached
    # Leaderboard events for ranking achievements
    - topic: leaderboard.rank.changed
      event: LeaderboardRankChangedEvent
      handler: HandleRankChanged
  x-event-publications:
    # Achievement definition lifecycle events
    - topic: achievement.definition.created
      event: AchievementDefinitionCreatedEvent
      description: Published when a new achievement definition is created
    - topic: achievement.definition.updated
      event: AchievementDefinitionUpdatedEvent
      description: Published when an achievement definition is updated
    - topic: achievement.definition.deleted
      event: AchievementDefinitionDeletedEvent
      description: Published when an achievement definition is deleted
    # Published when an achievement is unlocked
    - topic: achievement.unlocked
      event: AchievementUnlockedEvent
      description: Published when an entity unlocks an achievement
    # Published when progress is made toward an achievement
    - topic: achievement.progress.updated
      event: AchievementProgressUpdatedEvent
      description: Published when progress is made on a progressive achievement
    # Published when platform sync completes
    - topic: achievement.platform.synced
      event: AchievementPlatformSyncedEvent
      description: Published when achievement is synced to external platform

paths: {}  # Events don't have HTTP paths

components:
  schemas:
    # ============================================
    # Published Events
    # ============================================
    AchievementUnlockedEvent:
      type: object
      additionalProperties: false
      description: Published when an entity unlocks an achievement
      required:
        - eventId
        - timestamp
        - gameServiceId
        - achievementId
        - entityId
        - entityType
        - points
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique identifier for this event
        timestamp:
          type: string
          format: date-time
          description: When the achievement was unlocked
        gameServiceId:
          type: string
          format: uuid
          description: ID of the game service
        achievementId:
          type: string
          description: ID of the unlocked achievement
        displayName:
          type: string
          description: Achievement display name
        description:
          type: string
          description: Achievement description
        entityId:
          type: string
          format: uuid
          description: ID of the entity that unlocked it
        entityType:
          type: string
          enum:
            - account
            - character
            - guild
            - actor
            - custom
          description: Type of entity
        points:
          type: integer
          description: Points earned from this achievement
        totalPoints:
          type: integer
          description: Entity's new total achievement points
        iconUrl:
          type: string
          format: uri
          nullable: true
          description: Achievement icon URL
        isRare:
          type: boolean
          description: Whether this is a rare achievement (earned by <5% of players)
        rarity:
          type: number
          format: double
          nullable: true
          description: Percentage of players who have earned this (0-100)

    AchievementProgressUpdatedEvent:
      type: object
      additionalProperties: false
      description: Published when progress is made on a progressive achievement
      required:
        - eventId
        - timestamp
        - gameServiceId
        - achievementId
        - entityId
        - entityType
        - previousProgress
        - newProgress
        - targetProgress
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique identifier for this event
        timestamp:
          type: string
          format: date-time
          description: When the progress was updated
        gameServiceId:
          type: string
          format: uuid
          description: ID of the game service
        achievementId:
          type: string
          description: ID of the achievement
        displayName:
          type: string
          description: Achievement display name
        entityId:
          type: string
          format: uuid
          description: ID of the entity
        entityType:
          type: string
          enum:
            - account
            - character
            - guild
            - actor
            - custom
          description: Type of entity
        previousProgress:
          type: integer
          description: Progress before update
        newProgress:
          type: integer
          description: Progress after update
        targetProgress:
          type: integer
          description: Target to unlock
        percentComplete:
          type: number
          format: double
          description: Completion percentage (0-100)

    AchievementPlatformSyncedEvent:
      type: object
      additionalProperties: false
      description: Published when an achievement is synced to an external platform
      required:
        - eventId
        - timestamp
        - gameServiceId
        - achievementId
        - entityId
        - entityType
        - platform
        - success
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique identifier for this event
        timestamp:
          type: string
          format: date-time
          description: When the sync occurred
        gameServiceId:
          type: string
          format: uuid
          description: ID of the game service
        achievementId:
          type: string
          description: ID of the achievement
        entityId:
          type: string
          format: uuid
          description: ID of the entity (account for platform sync)
        entityType:
          type: string
          enum:
            - account
            - character
            - guild
            - actor
            - custom
          description: Type of entity
        platform:
          type: string
          enum:
            - steam
            - xbox
            - playstation
            - internal
          description: Platform that was synced to
        platformAchievementId:
          type: string
          nullable: true
          description: Platform-specific achievement ID
        success:
          type: boolean
          description: Whether sync was successful
        errorMessage:
          type: string
          nullable: true
          description: Error message if sync failed

    # ============================================
    # Definition Lifecycle Events
    # ============================================
    AchievementDefinitionCreatedEvent:
      type: object
      additionalProperties: false
      description: Published when a new achievement definition is created
      required:
        - eventId
        - timestamp
        - gameServiceId
        - achievementId
        - displayName
        - achievementType
        - points
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique identifier for this event
        timestamp:
          type: string
          format: date-time
          description: When the definition was created
        gameServiceId:
          type: string
          format: uuid
          description: ID of the game service this achievement belongs to
        achievementId:
          type: string
          description: Unique identifier for the achievement within the game service
        displayName:
          type: string
          description: Human-readable display name for the achievement
        description:
          type: string
          nullable: true
          description: Detailed description of how to earn the achievement
        achievementType:
          type: string
          enum:
            - standard
            - progressive
            - hidden
            - secret
          description: Type of achievement
        points:
          type: integer
          description: Points awarded for unlocking this achievement
        progressTarget:
          type: integer
          nullable: true
          description: Target value for progressive achievements
        platforms:
          type: array
          items:
            type: string
            enum:
              - steam
              - xbox
              - playstation
              - internal
          description: Platforms where this achievement is available

    AchievementDefinitionUpdatedEvent:
      type: object
      additionalProperties: false
      description: Published when an achievement definition is updated
      required:
        - eventId
        - timestamp
        - gameServiceId
        - achievementId
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique identifier for this event
        timestamp:
          type: string
          format: date-time
          description: When the definition was updated
        gameServiceId:
          type: string
          format: uuid
          description: ID of the game service
        achievementId:
          type: string
          description: Unique identifier for the achievement
        displayName:
          type: string
          nullable: true
          description: Updated display name (if changed)
        description:
          type: string
          nullable: true
          description: Updated description (if changed)
        points:
          type: integer
          nullable: true
          description: Updated points value (if changed)
        progressTarget:
          type: integer
          nullable: true
          description: Updated progress target (if changed)

    AchievementDefinitionDeletedEvent:
      type: object
      additionalProperties: false
      description: Published when an achievement definition is deleted
      required:
        - eventId
        - timestamp
        - gameServiceId
        - achievementId
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique identifier for this event
        timestamp:
          type: string
          format: date-time
          description: When the definition was deleted
        gameServiceId:
          type: string
          format: uuid
          description: ID of the game service
        achievementId:
          type: string
          description: ID of the deleted achievement
        displayName:
          type: string
          nullable: true
          description: Display name of the deleted achievement (for logging/audit)
