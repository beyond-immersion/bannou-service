openapi: 3.0.0
info:
  title: Bannou Matchmaking Service API
  description: |
    Matchmaking service for competitive and casual game matching.

    **POST-Only API Pattern**: This API uses POST for all operations to support zero-copy
    WebSocket routing. Path parameters are passed in request bodies instead of URLs.
    See docs/BANNOU_DESIGN.md for architectural rationale.

    **SCHEMA MODIFICATION GATE**: STOP. Before modifying this schema, you MUST:
    1. Read docs/reference/SCHEMA-RULES.md
    2. State which section applies to your change
    3. Only then proceed with edits
    Edits without stating the applicable rule are FORBIDDEN.

    **Features**:
    - Ticket-based matchmaking with properties and queries
    - Lucene-like query syntax for player compatibility matching
    - Configurable skill window expansion
    - Party support with configurable skill aggregation
    - Queue-based organization with exclusive groups
    - Immediate + interval-based match formation

  version: 1.0.0
servers:
- url: http://localhost:5012
  description: Bannou service endpoint (internal only)

paths:
  /matchmaking/queue/list:
    post:
      summary: List available matchmaking queues
      description: |
        List all available matchmaking queues that players can join.
        Returns queue configuration details including skill settings.
      operationId: listQueues
      tags:
      - Queues
      x-permissions:
      - role: user
      x-rate-limit:
        requestsPerMinute: 30
        requestsPerHour: 500
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ListQueuesRequest'
      responses:
        '200':
          description: Queues retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListQueuesResponse'

  /matchmaking/queue/get:
    post:
      summary: Get queue details
      description: |
        Get detailed configuration for a specific matchmaking queue.
      operationId: getQueue
      tags:
      - Queues
      x-permissions:
      - role: user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetQueueRequest'
      responses:
        '200':
          description: Queue details retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueueResponse'
        '404':
          description: Queue not found

  /matchmaking/queue/create:
    post:
      summary: Create a new matchmaking queue
      description: |
        Create a new matchmaking queue with specified configuration.
        Admin only. Queue configuration includes skill settings, party limits,
        and exclusive group membership.
      operationId: createQueue
      tags:
      - Queue Administration
      x-permissions:
      - role: admin
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateQueueRequest'
      responses:
        '200':
          description: Queue created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueueResponse'
        '409':
          description: Queue with this ID already exists

  /matchmaking/queue/update:
    post:
      summary: Update a matchmaking queue
      description: |
        Update configuration of an existing matchmaking queue.
        Admin only. Changes take effect for new tickets only.
      operationId: updateQueue
      tags:
      - Queue Administration
      x-permissions:
      - role: admin
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateQueueRequest'
      responses:
        '200':
          description: Queue updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueueResponse'
        '404':
          description: Queue not found

  /matchmaking/queue/delete:
    post:
      summary: Delete a matchmaking queue
      description: |
        Delete a matchmaking queue. Admin only.
        Existing tickets in the queue will be cancelled with reason 'queue_disabled'.
      operationId: deleteQueue
      tags:
      - Queue Administration
      x-permissions:
      - role: admin
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeleteQueueRequest'
      responses:
        '200':
          description: Queue deleted successfully
        '404':
          description: Queue not found

  /matchmaking/join:
    post:
      summary: Join matchmaking queue
      description: |
        Join a matchmaking queue with specified properties and query.
        Creates a matchmaking ticket and begins searching for compatible players.
        Returns immediately after ticket creation. Match results are delivered
        via WebSocket push events.
      operationId: joinMatchmaking
      tags:
      - Matchmaking
      x-permissions:
      - role: user
      x-rate-limit:
        requestsPerMinute: 10
        requestsPerHour: 100
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JoinMatchmakingRequest'
      responses:
        '200':
          description: Successfully joined matchmaking queue
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JoinMatchmakingResponse'
        '400':
          description: Invalid query syntax or properties
        '409':
          description: Already in queue, queue limit reached, or exclusive group conflict

  /matchmaking/leave:
    post:
      summary: Leave matchmaking queue
      description: |
        Leave a matchmaking queue and cancel the ticket.
        Only available when actively in a queue (shortcut/prebound).
      operationId: leaveMatchmaking
      tags:
      - Matchmaking
      x-permissions:
      - role: user
        states:
          matchmaking: in_queue
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LeaveMatchmakingRequest'
      responses:
        '200':
          description: Successfully left matchmaking queue
        '404':
          description: Ticket not found or not in queue

  /matchmaking/status:
    post:
      summary: Get matchmaking status
      description: |
        Get current matchmaking status for the player's active ticket.
        Only available when actively in a queue (shortcut/prebound).
      operationId: getMatchmakingStatus
      tags:
      - Matchmaking
      x-permissions:
      - role: user
        states:
          matchmaking: in_queue
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetMatchmakingStatusRequest'
      responses:
        '200':
          description: Status retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MatchmakingStatusResponse'
        '404':
          description: No active matchmaking ticket

  /matchmaking/accept:
    post:
      summary: Accept a formed match
      description: |
        Accept a match that has been formed. Only available when a match
        is pending acceptance (shortcut/prebound after match formation).
        All players must accept within the timeout for the match to start.
      operationId: acceptMatch
      tags:
      - Matchmaking
      x-permissions:
      - role: user
        states:
          matchmaking: match_pending
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AcceptMatchRequest'
      responses:
        '200':
          description: Match acceptance recorded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AcceptMatchResponse'
        '404':
          description: No pending match or already processed

  /matchmaking/decline:
    post:
      summary: Decline a formed match
      description: |
        Decline a match that has been formed. Only available when a match
        is pending acceptance (shortcut/prebound after match formation).
        Declining cancels the match for all participants.
      operationId: declineMatch
      tags:
      - Matchmaking
      x-permissions:
      - role: user
        states:
          matchmaking: match_pending
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeclineMatchRequest'
      responses:
        '200':
          description: Match declined
        '404':
          description: No pending match or already processed

  /matchmaking/stats:
    post:
      summary: Get queue statistics
      description: |
        Get operational statistics for matchmaking queues.
        Includes queue depths, average wait times, and match rates.
      operationId: getMatchmakingStats
      tags:
      - Statistics
      x-permissions:
      - role: user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetMatchmakingStatsRequest'
      responses:
        '200':
          description: Statistics retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MatchmakingStatsResponse'

components:
  schemas:
    # ============================================
    # Queue Management Types
    # ============================================

    ListQueuesRequest:
      type: object
      description: Request to list available matchmaking queues
      additionalProperties: false
      properties:
        gameId:
          type: string
          nullable: true
          description: Filter by game ID (null for all games)
        includeDisabled:
          type: boolean
          default: false
          description: Include disabled queues in the list (admin only)

    ListQueuesResponse:
      type: object
      description: Response containing available matchmaking queues
      additionalProperties: false
      required:
      - queues
      properties:
        queues:
          type: array
          items:
            $ref: '#/components/schemas/QueueSummary'
          description: List of available queues

    QueueSummary:
      type: object
      description: Summary information about a matchmaking queue
      additionalProperties: false
      required:
      - queueId
      - gameId
      - displayName
      - enabled
      - minCount
      - maxCount
      properties:
        queueId:
          type: string
          description: Unique identifier for the queue
        gameId:
          type: string
          description: Game this queue is for
        displayName:
          type: string
          description: Human-readable queue name
        enabled:
          type: boolean
          description: Whether the queue is currently accepting tickets
        minCount:
          type: integer
          description: Minimum players required for a match
        maxCount:
          type: integer
          description: Maximum players in a match
        currentTickets:
          type: integer
          nullable: true
          description: Current number of tickets in queue (if available)
        averageWaitSeconds:
          type: number
          nullable: true
          description: Average wait time in seconds (if available)

    GetQueueRequest:
      type: object
      description: Request to get details of a specific queue
      additionalProperties: false
      required:
      - queueId
      properties:
        queueId:
          type: string
          description: ID of the queue to retrieve

    QueueResponse:
      type: object
      description: Full configuration details of a matchmaking queue
      additionalProperties: false
      required:
      - queueId
      - gameId
      - displayName
      - enabled
      - minCount
      - maxCount
      - countMultiple
      - intervalSeconds
      - maxIntervals
      - createdAt
      properties:
        queueId:
          type: string
          description: Unique identifier for the queue
        gameId:
          type: string
          description: Game this queue is for
        sessionGameType:
          $ref: '#/components/schemas/SessionGameType'
          description: Game type for created sessions (maps to game-session service)
        displayName:
          type: string
          description: Human-readable queue name
        description:
          type: string
          nullable: true
          description: Detailed description of the queue
        enabled:
          type: boolean
          description: Whether the queue is currently accepting tickets
        minCount:
          type: integer
          minimum: 2
          description: Minimum players required for a match
        maxCount:
          type: integer
          maximum: 200
          description: Maximum players in a match
        countMultiple:
          type: integer
          minimum: 1
          description: Player count must be divisible by this (e.g., 2 for pairs)
        intervalSeconds:
          type: integer
          minimum: 1
          description: Seconds between match processing intervals
        maxIntervals:
          type: integer
          minimum: 1
          description: Maximum intervals before relaxing to minCount
        skillExpansion:
          type: array
          items:
            $ref: '#/components/schemas/SkillExpansionStep'
          nullable: true
          description: Skill window expansion steps
        partySkillAggregation:
          $ref: '#/components/schemas/PartySkillAggregation'
          description: How to calculate party skill rating
        partySkillWeights:
          type: array
          items:
            type: number
          nullable: true
          description: Weights for weighted party skill aggregation
        partyMaxSize:
          type: integer
          nullable: true
          description: Maximum party size for this queue
        allowConcurrent:
          type: boolean
          default: true
          description: Whether players can be in multiple queues
        exclusiveGroup:
          type: string
          nullable: true
          description: Exclusive group name (player can only be in one queue of the group)
        useSkillRating:
          type: boolean
          default: true
          description: Whether to use lib-analytics skill rating for matching
        ratingCategory:
          type: string
          nullable: true
          description: lib-analytics rating category to use
        startWhenMinimumReached:
          type: boolean
          default: false
          description: Start match with minCount after maxIntervals (for large lobbies)
        requiresRegistration:
          type: boolean
          default: false
          description: Whether players must be registered for a tournament
        tournamentIdRequired:
          type: boolean
          default: false
          description: Whether a tournament ID is required to join
        matchAcceptTimeoutSeconds:
          type: integer
          default: 30
          description: Seconds players have to accept/decline a formed match
        createdAt:
          type: string
          format: date-time
          description: When the queue was created
        updatedAt:
          type: string
          format: date-time
          nullable: true
          description: When the queue was last updated

    CreateQueueRequest:
      type: object
      description: Request to create a new matchmaking queue
      additionalProperties: false
      required:
      - queueId
      - gameId
      - displayName
      - minCount
      - maxCount
      properties:
        queueId:
          type: string
          minLength: 1
          maxLength: 64
          pattern: '^[a-z0-9-]+$'
          description: Unique identifier for the queue (lowercase alphanumeric with hyphens)
        gameId:
          type: string
          description: Game this queue is for
        sessionGameType:
          $ref: '#/components/schemas/SessionGameType'
          nullable: true
          description: Game type for created sessions (maps to game-session service). Defaults to 'generic' if not provided.
        displayName:
          type: string
          maxLength: 100
          description: Human-readable queue name
        description:
          type: string
          nullable: true
          maxLength: 500
          description: Detailed description of the queue
        minCount:
          type: integer
          minimum: 2
          maximum: 200
          description: Minimum players required for a match
        maxCount:
          type: integer
          minimum: 2
          maximum: 200
          description: Maximum players in a match
        countMultiple:
          type: integer
          minimum: 1
          default: 1
          description: Player count must be divisible by this
        intervalSeconds:
          type: integer
          minimum: 1
          maximum: 300
          default: 15
          description: Seconds between match processing intervals
        maxIntervals:
          type: integer
          minimum: 1
          maximum: 100
          default: 6
          description: Maximum intervals before relaxing to minCount
        skillExpansion:
          type: array
          items:
            $ref: '#/components/schemas/SkillExpansionStep'
          nullable: true
          description: Skill window expansion steps
        partySkillAggregation:
          $ref: '#/components/schemas/PartySkillAggregation'
          description: How to calculate party skill rating
        partySkillWeights:
          type: array
          items:
            type: number
          nullable: true
          description: Weights for weighted party skill aggregation
        partyMaxSize:
          type: integer
          minimum: 1
          nullable: true
          description: Maximum party size for this queue
        allowConcurrent:
          type: boolean
          default: true
          description: Whether players can be in multiple queues
        exclusiveGroup:
          type: string
          nullable: true
          maxLength: 64
          description: Exclusive group name
        useSkillRating:
          type: boolean
          default: true
          description: Whether to use lib-analytics skill rating
        ratingCategory:
          type: string
          nullable: true
          description: lib-analytics rating category to use
        startWhenMinimumReached:
          type: boolean
          default: false
          description: Start match with minCount after maxIntervals
        requiresRegistration:
          type: boolean
          default: false
          description: Require tournament registration
        tournamentIdRequired:
          type: boolean
          default: false
          description: Require tournament ID to join
        matchAcceptTimeoutSeconds:
          type: integer
          minimum: 10
          maximum: 120
          default: 30
          description: Seconds to accept/decline a match

    UpdateQueueRequest:
      type: object
      description: Request to update a matchmaking queue
      additionalProperties: false
      required:
      - queueId
      properties:
        queueId:
          type: string
          description: ID of the queue to update
        displayName:
          type: string
          nullable: true
          maxLength: 100
          description: New display name
        description:
          type: string
          nullable: true
          maxLength: 500
          description: New description
        enabled:
          type: boolean
          nullable: true
          description: Enable or disable the queue
        minCount:
          type: integer
          minimum: 2
          nullable: true
          description: New minimum count
        maxCount:
          type: integer
          maximum: 200
          nullable: true
          description: New maximum count
        countMultiple:
          type: integer
          minimum: 1
          nullable: true
          description: New count multiple
        intervalSeconds:
          type: integer
          minimum: 1
          maximum: 300
          nullable: true
          description: New interval seconds
        maxIntervals:
          type: integer
          minimum: 1
          maximum: 100
          nullable: true
          description: New max intervals
        skillExpansion:
          type: array
          items:
            $ref: '#/components/schemas/SkillExpansionStep'
          nullable: true
          description: New skill expansion steps
        partySkillAggregation:
          $ref: '#/components/schemas/PartySkillAggregation'
          nullable: true
          description: New party skill aggregation method
        partyMaxSize:
          type: integer
          minimum: 1
          nullable: true
          description: New party max size
        matchAcceptTimeoutSeconds:
          type: integer
          minimum: 10
          maximum: 120
          nullable: true
          description: New match accept timeout

    DeleteQueueRequest:
      type: object
      description: Request to delete a matchmaking queue
      additionalProperties: false
      required:
      - queueId
      properties:
        queueId:
          type: string
          description: ID of the queue to delete

    SkillExpansionStep:
      type: object
      description: A step in the skill window expansion curve
      additionalProperties: false
      required:
      - intervals
      properties:
        intervals:
          type: integer
          minimum: 0
          description: Number of intervals after which this step applies
        range:
          type: integer
          nullable: true
          minimum: 0
          description: Skill range (null means any skill level)

    PartySkillAggregation:
      type: string
      description: Method for aggregating party member skills
      enum: [highest, average, weighted]

    SessionGameType:
      type: string
      description: Game service stub name for created sessions. Use the game service's stubName property (e.g., "my-game"). Use "generic" for non-game-specific sessions.
      default: generic

    # ============================================
    # Matchmaking Operations Types
    # ============================================

    JoinMatchmakingRequest:
      type: object
      description: Request to join a matchmaking queue
      additionalProperties: false
      required:
      - webSocketSessionId
      - accountId
      - queueId
      properties:
        webSocketSessionId:
          type: string
          format: uuid
          description: WebSocket session ID for event delivery
        accountId:
          type: string
          format: uuid
          description: Account ID of the player joining
        queueId:
          type: string
          description: ID of the queue to join
        partyId:
          type: string
          format: uuid
          nullable: true
          description: Party ID if joining as part of a party
        partyMembers:
          type: array
          items:
            $ref: '#/components/schemas/PartyMemberInfo'
          nullable: true
          description: Party member information (required if partyId provided)
        stringProperties:
          type: object
          additionalProperties:
            type: string
          nullable: true
          description: String properties for query matching
        numericProperties:
          type: object
          additionalProperties:
            type: number
          nullable: true
          description: Numeric properties for query matching
        query:
          type: string
          nullable: true
          maxLength: 1000
          description: Lucene-like query for opponent matching
        tournamentId:
          type: string
          format: uuid
          nullable: true
          description: Tournament ID if joining tournament queue

    PartyMemberInfo:
      type: object
      description: Information about a party member for matchmaking
      additionalProperties: false
      required:
      - accountId
      - webSocketSessionId
      properties:
        accountId:
          type: string
          format: uuid
          description: Account ID of the party member
        webSocketSessionId:
          type: string
          format: uuid
          description: WebSocket session ID for event delivery
        skillRating:
          type: number
          nullable: true
          description: Pre-fetched skill rating (optional, will be looked up if not provided)

    JoinMatchmakingResponse:
      type: object
      description: Response after joining a matchmaking queue
      additionalProperties: false
      required:
      - ticketId
      - queueId
      - estimatedWaitSeconds
      properties:
        ticketId:
          type: string
          format: uuid
          description: Unique identifier for this matchmaking ticket
        queueId:
          type: string
          description: Queue that was joined
        estimatedWaitSeconds:
          type: integer
          nullable: true
          description: Estimated wait time based on current queue (null if unknown)
        position:
          type: integer
          nullable: true
          description: Approximate position in queue (null if not tracked)

    LeaveMatchmakingRequest:
      type: object
      description: Request to leave a matchmaking queue
      additionalProperties: false
      required:
      - webSocketSessionId
      - accountId
      - ticketId
      properties:
        webSocketSessionId:
          type: string
          format: uuid
          description: WebSocket session ID
        accountId:
          type: string
          format: uuid
          description: Account ID of the player
        ticketId:
          type: string
          format: uuid
          description: ID of the ticket to cancel

    GetMatchmakingStatusRequest:
      type: object
      description: Request to get matchmaking status
      additionalProperties: false
      required:
      - webSocketSessionId
      - accountId
      - ticketId
      properties:
        webSocketSessionId:
          type: string
          format: uuid
          description: WebSocket session ID
        accountId:
          type: string
          format: uuid
          description: Account ID of the player
        ticketId:
          type: string
          format: uuid
          description: ID of the ticket to query

    MatchmakingStatusResponse:
      type: object
      description: Current matchmaking status for a ticket
      additionalProperties: false
      required:
      - ticketId
      - queueId
      - status
      - intervalsElapsed
      - createdAt
      properties:
        ticketId:
          type: string
          format: uuid
          description: Ticket identifier
        queueId:
          type: string
          description: Queue the ticket is in
        status:
          $ref: '#/components/schemas/TicketStatus'
          description: Current ticket status
        intervalsElapsed:
          type: integer
          description: Number of processing intervals elapsed
        currentSkillRange:
          type: integer
          nullable: true
          description: Current skill matching range (null if skill not used)
        estimatedWaitSeconds:
          type: integer
          nullable: true
          description: Updated estimated wait time
        createdAt:
          type: string
          format: date-time
          description: When the ticket was created
        matchId:
          type: string
          format: uuid
          nullable: true
          description: Match ID if a match has been found

    TicketStatus:
      type: string
      description: Current status of a matchmaking ticket
      enum: [searching, match_found, match_accepted, cancelled, expired]

    AcceptMatchRequest:
      type: object
      description: Request to accept a formed match
      additionalProperties: false
      required:
      - webSocketSessionId
      - accountId
      - matchId
      properties:
        webSocketSessionId:
          type: string
          format: uuid
          description: WebSocket session ID
        accountId:
          type: string
          format: uuid
          description: Account ID of the player
        matchId:
          type: string
          format: uuid
          description: ID of the match to accept

    AcceptMatchResponse:
      type: object
      description: Response after accepting a match
      additionalProperties: false
      required:
      - matchId
      - allAccepted
      properties:
        matchId:
          type: string
          format: uuid
          description: Match identifier
        allAccepted:
          type: boolean
          description: Whether all players have accepted
        acceptedCount:
          type: integer
          nullable: true
          description: Number of players who have accepted
        totalCount:
          type: integer
          nullable: true
          description: Total players who need to accept
        gameSessionId:
          type: string
          format: uuid
          nullable: true
          description: Game session ID (set when all players accept)

    DeclineMatchRequest:
      type: object
      description: Request to decline a formed match
      additionalProperties: false
      required:
      - webSocketSessionId
      - accountId
      - matchId
      properties:
        webSocketSessionId:
          type: string
          format: uuid
          description: WebSocket session ID
        accountId:
          type: string
          format: uuid
          description: Account ID of the player
        matchId:
          type: string
          format: uuid
          description: ID of the match to decline

    # ============================================
    # Statistics Types
    # ============================================

    GetMatchmakingStatsRequest:
      type: object
      description: Request to get matchmaking statistics
      additionalProperties: false
      properties:
        queueId:
          type: string
          nullable: true
          description: Filter by specific queue (null for all queues)
        gameId:
          type: string
          nullable: true
          description: Filter by game ID

    MatchmakingStatsResponse:
      type: object
      description: Matchmaking operational statistics
      additionalProperties: false
      required:
      - timestamp
      - queueStats
      properties:
        timestamp:
          type: string
          format: date-time
          description: When these stats were collected
        queueStats:
          type: array
          items:
            $ref: '#/components/schemas/QueueStats'
          description: Statistics per queue

    QueueStats:
      type: object
      description: Statistics for a single matchmaking queue
      additionalProperties: false
      required:
      - queueId
      - currentTickets
      - matchesFormedLastHour
      - averageWaitSeconds
      properties:
        queueId:
          type: string
          description: Queue identifier
        currentTickets:
          type: integer
          description: Number of active tickets
        matchesFormedLastHour:
          type: integer
          description: Matches formed in the last hour
        averageWaitSeconds:
          type: number
          description: Average wait time in seconds
        medianWaitSeconds:
          type: number
          nullable: true
          description: Median wait time in seconds
        timeoutRatePercent:
          type: number
          nullable: true
          description: Percentage of tickets that timed out
        cancelRatePercent:
          type: number
          nullable: true
          description: Percentage of tickets cancelled by user

    # ============================================
    # Cancel Reason Codes
    # ============================================

    CancelReason:
      type: string
      description: Reason codes for matchmaking cancellation
      enum:
      - cancelled_by_user
      - timeout
      - session_disconnected
      - party_disbanded
      - match_declined
      - queue_disabled

# Service Registration Information
x-service-registration:
  serviceId: "matchmaking"
  serviceName: "Matchmaking Service"
  version: "1.0.0"
  categories:
  - gaming
  - matchmaking
  # Session states this service can set on clients:
  # - matchmaking: in_queue (set when joining a queue)
  # - matchmaking: match_pending (set when match formed, awaiting accept/decline)
