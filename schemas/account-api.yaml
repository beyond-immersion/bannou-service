openapi: 3.0.0
info:
  title: Bannou Account Service API
  description: |
    Internal account management service (CRUD operations only, never exposed to internet).

    **POST-Only API Pattern**: This API uses POST for all operations to support zero-copy
    WebSocket routing. Path parameters are passed in request bodies instead of URLs.
    See docs/BANNOU_DESIGN.md for architectural rationale.

    **NRT Compliance**: AI agents MUST review docs/NRT-SCHEMA-RULES.md before modifying this schema. Optional reference types require `nullable: true`.
  version: 2.0.0
servers:
- url: http://localhost:5012
  description: Bannou service endpoint (internal only)

# NOTE: x-lifecycle moved to account-events.yaml

paths:
  /account/list:
    post:
      summary: List accounts with filtering
      operationId: listAccounts
      tags:
      - Account Management
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ListAccountsRequest'
      responses:
        '200':
          description: Accounts retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AccountListResponse'

  /account/create:
    post:
      summary: Create new account
      operationId: createAccount
      tags:
      - Account Management
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateAccountRequest'
      responses:
        '200':
          description: Account created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AccountResponse'
        '400':
          description: Invalid account data
        '409':
          description: Account already exists

  /account/get:
    post:
      summary: Get account by ID
      operationId: getAccount
      tags:
      - Account Management
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetAccountRequest'
      responses:
        '200':
          description: Account retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AccountResponse'
        '404':
          description: Account not found

  /account/update:
    post:
      summary: Update account
      operationId: updateAccount
      tags:
      - Account Management
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateAccountRequest'
      responses:
        '200':
          description: Account updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AccountResponse'
        '404':
          description: Account not found
        '400':
          description: Invalid update data

  /account/delete:
    post:
      summary: Delete account
      operationId: deleteAccount
      tags:
      - Account Management
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeleteAccountRequest'
      responses:
        '200':
          description: Account deleted successfully
        '404':
          description: Account not found
        '409':
          description: Account cannot be deleted (active sessions exist)

  /account/by-email:
    post:
      summary: Get account by email
      operationId: getAccountByEmail
      tags:
      - Account Lookup
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetAccountByEmailRequest'
      responses:
        '200':
          description: Account retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AccountResponse'
        '404':
          description: Account not found

  /account/auth-methods/list:
    post:
      summary: Get authentication methods for account
      operationId: getAuthMethods
      tags:
      - Authentication Methods
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetAuthMethodsRequest'
      responses:
        '200':
          description: Authentication methods retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthMethodsResponse'
        '404':
          description: Account not found

  /account/auth-methods/add:
    post:
      summary: Add authentication method to account
      operationId: addAuthMethod
      tags:
      - Authentication Methods
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddAuthMethodRequest'
      responses:
        '200':
          description: Authentication method added successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthMethodResponse'
        '404':
          description: Account not found
        '409':
          description: Authentication method already exists

  /account/auth-methods/remove:
    post:
      summary: Remove authentication method from account
      operationId: removeAuthMethod
      tags:
      - Authentication Methods
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RemoveAuthMethodRequest'
      responses:
        '200':
          description: Authentication method removed successfully
        '404':
          description: Account or method not found
        '400':
          description: Cannot remove last authentication method

  /account/by-provider:
    post:
      summary: Get account by external provider ID
      operationId: getAccountByProvider
      tags:
      - Account Lookup
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetAccountByProviderRequest'
      responses:
        '200':
          description: Account retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AccountResponse'
        '404':
          description: Account not found

  /account/profile/update:
    post:
      summary: Update account profile
      operationId: updateProfile
      tags:
      - Profile Management
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateProfileRequest'
      responses:
        '200':
          description: Profile updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AccountResponse'
        '404':
          description: Account not found

  /account/password/update:
    post:
      summary: Update account password hash
      operationId: updatePasswordHash
      tags:
      - Account Management
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdatePasswordRequest'
      responses:
        '200':
          description: Password hash updated successfully
        '404':
          description: Account not found

  /account/batch-get:
    post:
      summary: Get multiple accounts by ID
      operationId: batchGetAccounts
      tags:
      - Account Management
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BatchGetAccountsRequest'
      responses:
        '200':
          description: Batch get completed (partial results possible)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchGetAccountsResponse'

  /account/count:
    post:
      summary: Count accounts matching filters
      operationId: countAccounts
      tags:
      - Account Management
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CountAccountsRequest'
      responses:
        '200':
          description: Account count retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CountAccountsResponse'

  /account/roles/bulk-update:
    post:
      summary: Bulk update roles for multiple accounts
      operationId: bulkUpdateRoles
      tags:
      - Account Management
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BulkUpdateRolesRequest'
      responses:
        '200':
          description: Bulk update completed (partial success possible)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BulkUpdateRolesResponse'

  /account/verification/update:
    post:
      summary: Update email verification status
      operationId: updateVerificationStatus
      tags:
      - Account Management
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateVerificationRequest'
      responses:
        '200':
          description: Verification status updated successfully
        '404':
          description: Account not found

components:
  schemas:
    # Shared Enum Definitions (consolidated to avoid duplication)
    AuthProvider:
      type: string
      description: All authentication provider types including email
      enum: [email, google, discord, twitch, steam]

    OAuthProvider:
      type: string
      description: OAuth provider types (excludes email)
      enum: [google, discord, twitch, steam]

    # Request Models for POST-only pattern
    ListAccountsRequest:
      type: object
      description: Request to list accounts with optional filtering
      additionalProperties: false
      properties:
        email:
          type: string
          format: email
          nullable: true
          description: Filter accounts by email address
        displayName:
          type: string
          nullable: true
          description: Filter accounts by display name
        provider:
          allOf:
          - $ref: '#/components/schemas/AuthProvider'
          nullable: true
          description: Filter accounts by authentication provider
        verified:
          type: boolean
          nullable: true
          description: Filter accounts by email verification status
        page:
          type: integer
          minimum: 1
          default: 1
          description: Page number for pagination
        pageSize:
          type: integer
          minimum: 1
          maximum: 100
          default: 20
          description: Number of accounts per page

    GetAccountRequest:
      type: object
      description: Request to get a specific account by ID
      additionalProperties: false
      required:
      - accountId
      properties:
        accountId:
          type: string
          format: uuid
          description: ID of the account to retrieve

    DeleteAccountRequest:
      type: object
      description: Request to delete a specific account
      additionalProperties: false
      required:
      - accountId
      properties:
        accountId:
          type: string
          format: uuid
          description: ID of the account to delete

    GetAccountByEmailRequest:
      type: object
      description: Request to get account by email address
      additionalProperties: false
      required:
      - email
      properties:
        email:
          type: string
          format: email
          description: Email address to look up

    GetAuthMethodsRequest:
      type: object
      description: Request to get authentication methods for an account
      additionalProperties: false
      required:
      - accountId
      properties:
        accountId:
          type: string
          format: uuid
          description: ID of the account

    RemoveAuthMethodRequest:
      type: object
      description: Request to remove an authentication method from an account
      additionalProperties: false
      required:
      - accountId
      - methodId
      properties:
        accountId:
          type: string
          format: uuid
          description: ID of the account
        methodId:
          type: string
          format: uuid
          description: ID of the authentication method to remove

    GetAccountByProviderRequest:
      type: object
      description: Request to get account by external provider ID
      additionalProperties: false
      required:
      - provider
      - externalId
      properties:
        provider:
          $ref: '#/components/schemas/OAuthProvider'
          description: OAuth provider type
        externalId:
          type: string
          description: External ID from the provider

    CreateAccountRequest:
      type: object
      description: Request to create a new account
      additionalProperties: false
      required:
      - email
      properties:
        email:
          type: string
          format: email
          description: Email address for the new account
        passwordHash:
          type: string
          nullable: true
          description: Pre-hashed password from Auth service
        displayName:
          type: string
          nullable: true
          maxLength: 100
          description: Display name for the account
        emailVerified:
          type: boolean
          default: false
          description: Whether the email address has been verified
        roles:
          type: array
          items:
            type: string
          nullable: true
          description: List of roles assigned to the account (null defaults to empty)
        metadata:
          type: object
          additionalProperties: true
          nullable: true
          description: Custom metadata associated with the account

    UpdateAccountRequest:
      type: object
      description: Request to update an existing account
      additionalProperties: false
      required:
      - accountId
      properties:
        accountId:
          type: string
          format: uuid
          description: ID of the account to update
        displayName:
          type: string
          nullable: true
          maxLength: 100
          description: New display name for the account
        roles:
          type: array
          items:
            type: string
          nullable: true
          description: Updated list of roles for the account (null to keep unchanged)
        metadata:
          type: object
          additionalProperties: true
          nullable: true
          description: Updated custom metadata for the account

    UpdateProfileRequest:
      type: object
      description: Request to update an account profile
      additionalProperties: false
      required:
      - accountId
      properties:
        accountId:
          type: string
          format: uuid
          description: ID of the account to update
        displayName:
          type: string
          nullable: true
          maxLength: 100
          description: New display name for the account
        metadata:
          type: object
          additionalProperties: true
          nullable: true
          description: Updated custom metadata for the account

    UpdatePasswordRequest:
      type: object
      description: Request to update an account password
      additionalProperties: false
      required:
      - accountId
      - passwordHash
      properties:
        accountId:
          type: string
          format: uuid
          description: ID of the account to update
        passwordHash:
          type: string
          description: New pre-hashed password from Auth service

    UpdateVerificationRequest:
      type: object
      description: Request to update email verification status
      additionalProperties: false
      required:
      - accountId
      - emailVerified
      properties:
        accountId:
          type: string
          format: uuid
          description: ID of the account to update
        emailVerified:
          type: boolean
          description: New email verification status

    AddAuthMethodRequest:
      type: object
      description: Request to add an authentication method to an account
      additionalProperties: false
      required:
      - accountId
      - provider
      properties:
        accountId:
          type: string
          format: uuid
          description: ID of the account to add auth method to
        provider:
          $ref: '#/components/schemas/OAuthProvider'
          description: OAuth provider type to add
        externalId:
          type: string
          # NRT: Optional string MUST be nullable (Rule 2)
          nullable: true
          description: External user ID from the OAuth provider
        displayName:
          type: string
          nullable: true
          description: Display name from the OAuth provider

    # Response Models
    AccountResponse:
      type: object
      description: Account information response
      additionalProperties: false
      required:
      - accountId
      - email
      - createdAt
      - emailVerified
      - roles
      properties:
        accountId:
          type: string
          format: uuid
          description: Unique identifier for the account
        email:
          type: string
          format: email
          description: Email address associated with the account
        displayName:
          type: string
          nullable: true
          description: Display name for the account
        passwordHash:
          type: string
          nullable: true
          description: BCrypt hashed password for authentication
        createdAt:
          type: string
          format: date-time
          description: Timestamp when the account was created
        updatedAt:
          type: string
          format: date-time
          nullable: true
          description: Timestamp when the account was last updated
        emailVerified:
          type: boolean
          description: Whether the email address has been verified
        roles:
          type: array
          items:
            type: string
          description: List of roles assigned to the account
        authMethods:
          type: array
          items:
            $ref: '#/components/schemas/AuthMethodInfo'
          description: List of authentication methods linked to the account
        metadata:
          type: object
          additionalProperties: true
          nullable: true
          description: Custom metadata associated with the account

    AuthMethodInfo:
      type: object
      description: Information about a linked authentication method
      additionalProperties: false
      required:
      - provider
      - linkedAt
      properties:
        methodId:
          type: string
          format: uuid
          # NRT: Optional string MUST be nullable (Rule 2)
          nullable: true
          description: Unique identifier for the authentication method
        provider:
          $ref: '#/components/schemas/AuthProvider'
          description: Authentication provider type
        externalId:
          type: string
          nullable: true
          description: External user ID from the authentication provider
        displayName:
          type: string
          nullable: true
          description: Display name from the authentication provider
        linkedAt:
          type: string
          format: date-time
          description: Timestamp when the authentication method was linked

    AuthMethodResponse:
      type: object
      description: Response after adding an authentication method
      additionalProperties: false
      required:
      - methodId
      - provider
      - linkedAt
      properties:
        methodId:
          type: string
          format: uuid
          description: Unique identifier for the authentication method
        provider:
          $ref: '#/components/schemas/OAuthProvider'
          description: OAuth provider type
        externalId:
          type: string
          # NRT: Optional string MUST be nullable (Rule 2)
          nullable: true
          description: External user ID from the OAuth provider
        displayName:
          type: string
          nullable: true
          description: Display name from the OAuth provider
        linkedAt:
          type: string
          format: date-time
          description: Timestamp when the authentication method was linked

    AuthMethodsResponse:
      type: object
      description: Response containing list of authentication methods
      additionalProperties: false
      required:
      - authMethods
      properties:
        authMethods:
          type: array
          items:
            $ref: '#/components/schemas/AuthMethodInfo'
          description: List of authentication methods linked to the account

    AccountListResponse:
      type: object
      description: Paginated list of accounts
      additionalProperties: false
      required:
      - accounts
      - totalCount
      - page
      - pageSize
      properties:
        accounts:
          type: array
          items:
            $ref: '#/components/schemas/AccountResponse'
          description: List of accounts for the current page
        totalCount:
          type: integer
          description: Total number of accounts matching the filter
        page:
          type: integer
          description: Current page number
        pageSize:
          type: integer
          description: Number of accounts per page
        hasNextPage:
          type: boolean
          description: Whether there are more pages after this one
        hasPreviousPage:
          type: boolean
          description: Whether there are pages before this one

    # Bulk Operation Request Models
    BatchGetAccountsRequest:
      type: object
      description: Request to get multiple accounts by ID
      additionalProperties: false
      required:
      - accountIds
      properties:
        accountIds:
          type: array
          items:
            type: string
            format: uuid
          minItems: 1
          maxItems: 100
          description: List of account IDs to retrieve (max 100)

    CountAccountsRequest:
      type: object
      description: Request to count accounts matching optional filters
      additionalProperties: false
      properties:
        email:
          type: string
          nullable: true
          description: Filter by email (contains match)
        displayName:
          type: string
          nullable: true
          description: Filter by display name (contains match)
        verified:
          type: boolean
          nullable: true
          description: Filter by verification status
        role:
          type: string
          nullable: true
          description: Filter by role membership (checks JSON array containment)

    BulkUpdateRolesRequest:
      type: object
      description: Request to update roles for multiple accounts
      additionalProperties: false
      required:
      - accountIds
      properties:
        accountIds:
          type: array
          items:
            type: string
            format: uuid
          minItems: 1
          maxItems: 100
          description: List of account IDs to update (max 100)
        addRoles:
          type: array
          items:
            type: string
          nullable: true
          description: Roles to add to all specified accounts (null to skip)
        removeRoles:
          type: array
          items:
            type: string
          nullable: true
          description: Roles to remove from all specified accounts (null to skip)

    # Bulk Operation Response Models
    BatchGetAccountsResponse:
      type: object
      description: Response containing found accounts and IDs not found
      additionalProperties: false
      required:
      - accounts
      - notFound
      properties:
        accounts:
          type: array
          items:
            $ref: '#/components/schemas/AccountResponse'
          description: Successfully retrieved accounts
        notFound:
          type: array
          items:
            type: string
            format: uuid
          description: Account IDs that were not found or are deleted

    CountAccountsResponse:
      type: object
      description: Response containing account count
      additionalProperties: false
      required:
      - count
      properties:
        count:
          type: integer
          format: int64
          description: Number of accounts matching the filters

    BulkUpdateRolesResponse:
      type: object
      description: Response containing bulk update results (partial success)
      additionalProperties: false
      required:
      - succeeded
      - failed
      properties:
        succeeded:
          type: array
          items:
            type: string
            format: uuid
          description: Account IDs that were successfully updated
        failed:
          type: array
          items:
            $ref: '#/components/schemas/BulkOperationFailure'
          description: Account IDs that failed with reasons

    BulkOperationFailure:
      type: object
      description: Details of a failed bulk operation item
      additionalProperties: false
      required:
      - accountId
      - error
      properties:
        accountId:
          type: string
          format: uuid
          description: Account ID that failed
        error:
          type: string
          description: Human-readable error reason
