openapi: 3.0.0
info:
  title: Bannou Analytics Service API
  description: |
    Event ingestion, entity statistics, skill ratings (Glicko-2), and controller history tracking.

    **POST-Only API Pattern**: This API uses POST for all operations to support zero-copy
    WebSocket routing. Path parameters are passed in request bodies instead of URLs.
    See docs/BANNOU_DESIGN.md for architectural rationale.

    **Polymorphic Entity Model**: Analytics tracks entities by `entityId + entityType`,
    allowing statistics for accounts, characters, guilds, actors, or custom types.

    **Schema Rules**: AI agents MUST review docs/reference/SCHEMA-RULES.md before modifying
    this schema. Optional reference types require `nullable: true`.
  version: 1.0.0
servers:
- url: http://localhost:5012
  description: Bannou service endpoint (internal only)

paths:
  /analytics/event/ingest:
    post:
      summary: Ingest a single analytics event
      description: |
        High-throughput event ingestion endpoint for recording game events.
        Events are buffered in memory and periodically flushed to persistent storage.
        Service-only endpoint - not exposed to clients.
      operationId: ingestEvent
      tags:
      - Event Ingestion
      x-permissions: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IngestEventRequest'
      responses:
        '200':
          description: Event ingested successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IngestEventResponse'

  /analytics/event/ingest-batch:
    post:
      summary: Ingest multiple analytics events
      description: |
        Batch event ingestion for high-volume scenarios. Accepts up to 1000 events per request.
        Service-only endpoint - not exposed to clients.
      operationId: ingestEventBatch
      tags:
      - Event Ingestion
      x-permissions: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IngestEventBatchRequest'
      responses:
        '200':
          description: Events ingested successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IngestEventBatchResponse'

  /analytics/summary/get:
    post:
      summary: Get entity statistics summary
      description: |
        Retrieve aggregated statistics for an entity. Summaries include total counts,
        averages, and derived metrics computed from ingested events.
      operationId: getEntitySummary
      tags:
      - Statistics
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetEntitySummaryRequest'
      responses:
        '200':
          description: Entity summary retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EntitySummaryResponse'
        '404':
          description: Entity not found

  /analytics/summary/query:
    post:
      summary: Query entity summaries with filters
      description: |
        Query multiple entity summaries with filtering and sorting options.
        Useful for dashboards and reporting.
      operationId: queryEntitySummaries
      tags:
      - Statistics
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QueryEntitySummariesRequest'
      responses:
        '200':
          description: Query executed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueryEntitySummariesResponse'

  /analytics/rating/get:
    post:
      summary: Get entity Glicko-2 skill rating
      description: |
        Retrieve the current Glicko-2 skill rating for an entity.
        Returns rating, rating deviation (RD), and volatility.
      operationId: getSkillRating
      tags:
      - Skill Ratings
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetSkillRatingRequest'
      responses:
        '200':
          description: Skill rating retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SkillRatingResponse'
        '404':
          description: Entity has no skill rating

  /analytics/rating/update:
    post:
      summary: Update entity skill rating after match
      description: |
        Update skill ratings for entities after a match result.
        Uses Glicko-2 algorithm to compute new ratings based on outcomes.
        Service-only endpoint - typically called by game-session service.
      operationId: updateSkillRating
      tags:
      - Skill Ratings
      x-permissions: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateSkillRatingRequest'
      responses:
        '200':
          description: Skill ratings updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UpdateSkillRatingResponse'

  /analytics/controller-history/record:
    post:
      summary: Record controller possession event
      description: |
        Record when an account takes or releases control of an entity.
        Used for tracking which player controlled which character/actor at what time.
        Service-only endpoint.
      operationId: recordControllerEvent
      tags:
      - Controller History
      x-permissions: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RecordControllerEventRequest'
      responses:
        '200':
          description: Controller event recorded successfully

  /analytics/controller-history/query:
    post:
      summary: Query controller history
      description: |
        Query who controlled what entity during a time range.
        Useful for audit trails and replays.
      operationId: queryControllerHistory
      tags:
      - Controller History
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QueryControllerHistoryRequest'
      responses:
        '200':
          description: Controller history retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueryControllerHistoryResponse'

  /analytics/controller-history/cleanup:
    post:
      summary: Cleanup expired controller history
      description: |
        Deletes controller history records older than the configured retention period.
        Runs in batches to avoid overwhelming the database. Returns count of deleted records.
      operationId: cleanupControllerHistory
      tags:
      - Controller History
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CleanupControllerHistoryRequest'
      responses:
        '200':
          description: Cleanup completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CleanupControllerHistoryResponse'

components:
  schemas:
    # ============================================
    # Shared Enums
    # ============================================

    ControllerAction:
      type: string
      description: Type of controller action
      enum:
      - possess
      - release

    # ============================================
    # Event Ingestion
    # ============================================
    IngestEventRequest:
      type: object
      description: Request to ingest a single analytics event
      additionalProperties: false
      required:
      - gameServiceId
      - eventType
      - entityId
      - entityType
      - timestamp
      properties:
        gameServiceId:
          type: string
          format: uuid
          description: ID of the game service that generated this event
        eventType:
          type: string
          description: Type of event (e.g., kill, death, score, action)
        entityId:
          type: string
          format: uuid
          description: ID of the entity this event relates to
        entityType:
          $ref: 'common-api.yaml#/components/schemas/EntityType'
          description: Entity type the event is attributed to
        timestamp:
          type: string
          format: date-time
          description: When the event occurred
        value:
          type: number
          format: double
          description: Numeric value associated with the event (e.g., score amount)
        metadata:
          type: object
          additionalProperties: true
          nullable: true
          description: Additional event-specific data

    IngestEventResponse:
      type: object
      description: Response after ingesting an event
      additionalProperties: false
      required:
      - eventId
      - accepted
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique identifier assigned to this event
        accepted:
          type: boolean
          description: Whether the event was accepted for processing

    IngestEventBatchRequest:
      type: object
      description: Request to ingest multiple analytics events
      additionalProperties: false
      required:
      - events
      properties:
        events:
          type: array
          items:
            $ref: '#/components/schemas/IngestEventRequest'
          maxItems: 1000
          description: List of events to ingest (max 1000)

    IngestEventBatchResponse:
      type: object
      description: Response after batch event ingestion
      additionalProperties: false
      required:
      - accepted
      - rejected
      properties:
        accepted:
          type: integer
          description: Number of events accepted
        rejected:
          type: integer
          description: Number of events rejected
        errors:
          type: array
          items:
            type: string
          nullable: true
          description: Error messages for rejected events

    # ============================================
    # Entity Statistics
    # ============================================
    GetEntitySummaryRequest:
      type: object
      description: Request to get statistics for an entity
      additionalProperties: false
      required:
      - gameServiceId
      - entityId
      - entityType
      properties:
        gameServiceId:
          type: string
          format: uuid
          description: ID of the game service
        entityId:
          type: string
          format: uuid
          description: ID of the entity
        entityType:
          $ref: 'common-api.yaml#/components/schemas/EntityType'
          description: Entity type to summarize

    EntitySummaryResponse:
      type: object
      description: Aggregated statistics for an entity
      additionalProperties: false
      required:
      - entityId
      - entityType
      - totalEvents
      - firstEventAt
      - lastEventAt
      properties:
        entityId:
          type: string
          format: uuid
          description: ID of the entity
        entityType:
          $ref: 'common-api.yaml#/components/schemas/EntityType'
          description: Entity type for this summary
        totalEvents:
          type: integer
          format: int64
          description: Total number of events recorded
        firstEventAt:
          type: string
          format: date-time
          description: Timestamp of first recorded event
        lastEventAt:
          type: string
          format: date-time
          description: Timestamp of most recent event
        eventCounts:
          type: object
          additionalProperties:
            type: integer
            format: int64
          description: Count of events by type
        aggregates:
          type: object
          additionalProperties:
            type: number
            format: double
          description: Aggregated numeric values (sums, averages)

    QueryEntitySummariesRequest:
      type: object
      description: Request to query multiple entity summaries
      additionalProperties: false
      required:
      - gameServiceId
      properties:
        gameServiceId:
          type: string
          format: uuid
          description: ID of the game service
        entityType:
          $ref: 'common-api.yaml#/components/schemas/EntityType'
          nullable: true
          description: Optional filter by entity type
        eventType:
          type: string
          nullable: true
          description: Filter by event type
        minEvents:
          type: integer
          description: Minimum number of events
        sortBy:
          type: string
          nullable: true
          description: Field to sort by
        sortDescending:
          type: boolean
          default: true
          description: Sort in descending order
        limit:
          type: integer
          default: 100
          maximum: 1000
          description: Maximum results to return
        offset:
          type: integer
          default: 0
          description: Number of results to skip

    QueryEntitySummariesResponse:
      type: object
      description: Response containing queried entity summaries
      additionalProperties: false
      required:
      - summaries
      - total
      properties:
        summaries:
          type: array
          items:
            $ref: '#/components/schemas/EntitySummaryResponse'
          description: List of matching entity summaries
        total:
          type: integer
          format: int64
          description: Total number of matching entities

    # ============================================
    # Skill Ratings (Glicko-2)
    # ============================================
    GetSkillRatingRequest:
      type: object
      description: Request to get skill rating for an entity
      additionalProperties: false
      required:
      - gameServiceId
      - entityId
      - entityType
      - ratingType
      properties:
        gameServiceId:
          type: string
          format: uuid
          description: ID of the game service
        entityId:
          type: string
          format: uuid
          description: ID of the entity
        entityType:
          $ref: 'common-api.yaml#/components/schemas/EntityType'
          description: Entity type whose rating is requested
        ratingType:
          type: string
          description: Type of rating (e.g., overall, ranked, casual)

    SkillRatingResponse:
      type: object
      description: Glicko-2 skill rating for an entity
      additionalProperties: false
      required:
      - entityId
      - entityType
      - ratingType
      - rating
      - ratingDeviation
      - volatility
      - matchesPlayed
      properties:
        entityId:
          type: string
          format: uuid
          description: ID of the entity
        entityType:
          $ref: 'common-api.yaml#/components/schemas/EntityType'
          description: Entity type for this rating record
        ratingType:
          type: string
          description: Type of rating
        rating:
          type: number
          format: double
          description: Current Glicko-2 rating (typically 1500 start)
        ratingDeviation:
          type: number
          format: double
          description: Rating deviation (uncertainty) - lower is more confident
        volatility:
          type: number
          format: double
          description: Rating volatility (consistency of performance)
        matchesPlayed:
          type: integer
          description: Number of rated matches played
        lastMatchAt:
          type: string
          format: date-time
          nullable: true
          description: Timestamp of last rated match

    UpdateSkillRatingRequest:
      type: object
      description: Request to update skill ratings after a match
      additionalProperties: false
      required:
      - gameServiceId
      - ratingType
      - matchId
      - results
      properties:
        gameServiceId:
          type: string
          format: uuid
          description: ID of the game service
        ratingType:
          type: string
          description: Type of rating to update
        matchId:
          type: string
          format: uuid
          description: Unique identifier for this match
        results:
          type: array
          items:
            $ref: '#/components/schemas/MatchResult'
          minItems: 2
          description: Results for all participants (min 2)

    MatchResult:
      type: object
      description: Individual result in a match
      additionalProperties: false
      required:
      - entityId
      - entityType
      - outcome
      properties:
        entityId:
          type: string
          format: uuid
          description: ID of the participating entity
        entityType:
          $ref: 'common-api.yaml#/components/schemas/EntityType'
          description: Entity type for this match participant
        outcome:
          type: number
          format: double
          minimum: 0
          maximum: 1
          description: Match outcome (1.0 = win, 0.5 = draw, 0.0 = loss)
        score:
          type: number
          format: double
          nullable: true
          description: Optional numeric score for the match

    UpdateSkillRatingResponse:
      type: object
      description: Response after updating skill ratings
      additionalProperties: false
      required:
      - matchId
      - updatedRatings
      properties:
        matchId:
          type: string
          format: uuid
          description: ID of the processed match
        updatedRatings:
          type: array
          items:
            $ref: '#/components/schemas/SkillRatingChange'
          description: Updated ratings for all participants

    SkillRatingChange:
      type: object
      description: Rating change for a single entity
      additionalProperties: false
      required:
      - entityId
      - entityType
      - previousRating
      - newRating
      - ratingChange
      properties:
        entityId:
          type: string
          format: uuid
          description: ID of the entity
        entityType:
          $ref: 'common-api.yaml#/components/schemas/EntityType'
          description: Entity type for this rating change
        previousRating:
          type: number
          format: double
          description: Rating before this match
        newRating:
          type: number
          format: double
          description: Rating after this match
        ratingChange:
          type: number
          format: double
          description: Change in rating (can be negative)

    # ============================================
    # Controller History
    # ============================================
    RecordControllerEventRequest:
      type: object
      description: Request to record a controller possession/release event
      additionalProperties: false
      required:
      - gameServiceId
      - accountId
      - targetEntityId
      - targetEntityType
      - action
      - timestamp
      properties:
        gameServiceId:
          type: string
          format: uuid
          description: ID of the game service
        accountId:
          type: string
          format: uuid
          description: ID of the account taking/releasing control
        targetEntityId:
          type: string
          format: uuid
          description: ID of the entity being controlled
        targetEntityType:
          $ref: 'common-api.yaml#/components/schemas/EntityType'
          description: Entity type being controlled
        action:
          $ref: '#/components/schemas/ControllerAction'
          description: Whether control was possessed or released
        timestamp:
          type: string
          format: date-time
          description: When the control event occurred
        sessionId:
          type: string
          format: uuid
          nullable: true
          description: Game session ID (if applicable)

    QueryControllerHistoryRequest:
      type: object
      description: Request to query controller history
      additionalProperties: false
      required:
      - gameServiceId
      properties:
        gameServiceId:
          type: string
          format: uuid
          description: ID of the game service
        accountId:
          type: string
          format: uuid
          nullable: true
          description: Filter by controlling account
        targetEntityId:
          type: string
          format: uuid
          nullable: true
          description: Filter by controlled entity
        targetEntityType:
          $ref: 'common-api.yaml#/components/schemas/EntityType'
          nullable: true
          description: Filter by entity type
        startTime:
          type: string
          format: date-time
          nullable: true
          description: Start of time range
        endTime:
          type: string
          format: date-time
          nullable: true
          description: End of time range
        limit:
          type: integer
          default: 100
          maximum: 1000
          description: Maximum results to return

    QueryControllerHistoryResponse:
      type: object
      description: Response containing controller history
      additionalProperties: false
      required:
      - events
      properties:
        events:
          type: array
          items:
            $ref: '#/components/schemas/ControllerHistoryEvent'
          description: Controller events matching the query

    ControllerHistoryEvent:
      type: object
      description: A single controller possession/release event
      additionalProperties: false
      required:
      - eventId
      - accountId
      - targetEntityId
      - targetEntityType
      - action
      - timestamp
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique identifier for this event
        accountId:
          type: string
          format: uuid
          description: ID of the controlling account
        targetEntityId:
          type: string
          format: uuid
          description: ID of the controlled entity
        targetEntityType:
          $ref: 'common-api.yaml#/components/schemas/EntityType'
          description: Entity type that was controlled
        action:
          $ref: '#/components/schemas/ControllerAction'
          description: Control action that occurred (possess/release)
        timestamp:
          type: string
          format: date-time
          description: When the event occurred
        sessionId:
          type: string
          format: uuid
          nullable: true
          description: Associated game session ID

    CleanupControllerHistoryRequest:
      type: object
      description: Request to cleanup expired controller history records
      additionalProperties: false
      properties:
        dryRun:
          type: boolean
          description: Preview cleanup without deleting records
          default: true
        olderThanDays:
          type: integer
          nullable: true
          description: Override configured retention period (null uses ControllerHistoryRetentionDays config)
        gameServiceId:
          type: string
          format: uuid
          nullable: true
          description: Limit cleanup to specific game service (null cleans all)

    CleanupControllerHistoryResponse:
      type: object
      description: Result of controller history cleanup
      additionalProperties: false
      required:
      - recordsDeleted
      - dryRun
      properties:
        recordsDeleted:
          type: integer
          format: int64
          description: Records deleted (or would be deleted if dry run)
        dryRun:
          type: boolean
          description: Whether this was a preview-only run

# Service Registration Information
x-service-registration:
  serviceId: "analytics"
  serviceName: "Analytics Service"
  version: "1.0.0"
  categories:
  - analytics
  - telemetry
