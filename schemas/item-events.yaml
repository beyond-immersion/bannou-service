openapi: 3.0.4
info:
  title: Item Service Events
  description: |
    Event models for Item service RabbitMQ pub/sub via MassTransit.
    Lifecycle events are auto-generated from x-lifecycle definition.

    **Event Categories**:
    - Template lifecycle: created, updated, deprecated
    - Instance lifecycle: created, modified, destroyed
    - Binding events: bound, unbound

    **Topic Naming**: Uses kebab-case for multi-word entities (item-template, item-instance).

    **SCHEMA MODIFICATION GATE**: STOP. Before modifying this schema, you MUST:
    1. Read docs/reference/SCHEMA-RULES.md
    2. State which section applies to your change
    3. Only then proceed with edits
    Edits without stating the applicable rule are FORBIDDEN.
  version: 1.0.0
  x-event-subscriptions: []
  x-event-publications:
    # Template lifecycle events (auto-generated from x-lifecycle)
    - topic: item-template.created
      event: ItemTemplateCreatedEvent
      description: Published when a new item template is created
    - topic: item-template.updated
      event: ItemTemplateUpdatedEvent
      description: Published when an item template is updated
    - topic: item-template.deprecated
      event: ItemTemplateDeprecatedEvent
      description: Published when an item template is deprecated

    # Instance lifecycle events (auto-generated from x-lifecycle)
    - topic: item-instance.created
      event: ItemInstanceCreatedEvent
      description: Published when a new item instance is created
    - topic: item-instance.modified
      event: ItemInstanceModifiedEvent
      description: Published when an item instance is modified (durability, stats, etc.)
    - topic: item-instance.destroyed
      event: ItemInstanceDestroyedEvent
      description: Published when an item instance is destroyed

    # Binding events (non-lifecycle)
    - topic: item-instance.bound
      event: ItemInstanceBoundEvent
      description: Published when an item is bound to a character (soulbound)
    - topic: item-instance.unbound
      event: ItemInstanceUnboundEvent
      description: Published when an item binding is removed (admin action, expiration)

    # Item use events (batched with deduplication)
    - topic: item.used
      event: ItemUsedEvent
      description: Published when items are successfully used (batched with deduplication by templateId+userId)
    - topic: item.use-failed
      event: ItemUseFailedEvent
      description: Published when item use attempts fail (batched with deduplication by templateId+userId)

    # Multi-step use events
    - topic: item.use-step-completed
      event: ItemUseStepCompletedEvent
      description: Published when a multi-step item use milestone is completed
    - topic: item.use-step-failed
      event: ItemUseStepFailedEvent
      description: Published when a multi-step item use milestone fails

# Lifecycle events auto-generated from this definition.
# Note: The generator produces standard Created/Updated/Deleted events for both entities.
# Item uses custom event names for non-creation lifecycle states:
#   - ItemTemplate: "deprecated" instead of "deleted" (templates are soft-disabled, not deleted)
#   - ItemInstance: "modified" instead of "updated", "destroyed" instead of "deleted"
# The custom events are defined in components/schemas below and listed in x-event-publications.
# The auto-generated Updated/Deleted variants exist in Generated/ but are not published.
x-lifecycle:
  ItemTemplate:
    model:
      templateId: { type: string, format: uuid, primary: true, required: true, description: "Unique identifier for the item template" }
      code: { type: string, required: true, description: "Unique item code within game" }
      gameId: { type: string, required: true, description: "Game service this template belongs to" }
      name: { type: string, required: true, description: "Human-readable display name" }
      description: { type: string, nullable: true, description: "Detailed item description" }
      category: { $ref: 'item-api.yaml#/components/schemas/ItemCategory', required: true, description: "Item classification category" }
      rarity: { $ref: 'item-api.yaml#/components/schemas/ItemRarity', required: true, description: "Item rarity tier" }
      quantityModel: { $ref: 'item-api.yaml#/components/schemas/QuantityModel', required: true, description: "How quantities are tracked" }
      maxStackSize: { type: integer, required: true, description: "Maximum stack size for this item" }
      scope: { $ref: 'item-api.yaml#/components/schemas/ItemScope', required: true, description: "Realm availability scope" }
      soulboundType: { $ref: 'item-api.yaml#/components/schemas/SoulboundType', required: true, description: "When item becomes bound to a character" }
      tradeable: { type: boolean, required: true, description: "Whether item can be traded between characters" }
      destroyable: { type: boolean, required: true, description: "Whether item can be destroyed by the owner" }
      hasDurability: { type: boolean, required: true, description: "Whether item has durability system" }
      maxDurability: { type: integer, nullable: true, description: "Maximum durability value (if hasDurability is true)" }
      isActive: { type: boolean, required: true, description: "Whether template is currently active" }
      isDeprecated: { type: boolean, required: true, description: "Whether template is deprecated" }
      deprecatedAt: { type: string, format: date-time, nullable: true, description: "When the template was deprecated" }
      migrationTargetId: { type: string, format: uuid, nullable: true, description: "Template ID to migrate existing instances to" }
      createdAt: { type: string, format: date-time, required: true, description: "When the template was created" }
      updatedAt: { type: string, format: date-time, nullable: true, description: "When the template was last modified" }
    sensitive: []

  ItemInstance:
    model:
      instanceId: { type: string, format: uuid, primary: true, required: true, description: "Unique identifier for this item instance" }
      templateId: { type: string, format: uuid, required: true, description: "Reference to the item template" }
      containerId: { type: string, format: uuid, required: true, description: "Container holding this item (ownership derived from container)" }
      realmId: { type: string, format: uuid, required: true, description: "Realm this instance exists in" }
      quantity: { type: number, format: double, required: true, description: "Item quantity (1 for unique, integer for discrete, decimal for continuous)" }
      slotIndex: { type: integer, nullable: true, description: "Slot position in slot-based containers" }
      slotX: { type: integer, nullable: true, description: "X position in grid-based containers" }
      slotY: { type: integer, nullable: true, description: "Y position in grid-based containers" }
      rotated: { type: boolean, nullable: true, description: "Whether item is rotated in grid-based containers" }
      currentDurability: { type: integer, nullable: true, description: "Current durability value" }
      boundToId: { type: string, format: uuid, nullable: true, description: "Character ID this item is bound to (if soulbound)" }
      boundAt: { type: string, format: date-time, nullable: true, description: "When the item was bound to a character" }
      customName: { type: string, nullable: true, description: "Player-assigned custom name for this instance" }
      originType: { $ref: 'item-api.yaml#/components/schemas/ItemOriginType', required: true, description: "How this item instance was created" }
      originId: { type: string, format: uuid, nullable: true, description: "Source entity ID for the origin (e.g., crafting recipe, vendor)" }
      createdAt: { type: string, format: date-time, required: true, description: "When the instance was created" }
      modifiedAt: { type: string, format: date-time, nullable: true, description: "When the instance was last modified" }
    sensitive: []

paths: {}

components:
  schemas:
    # =========================================================================
    # Custom Lifecycle Events (non-standard lifecycle states)
    # =========================================================================

    ItemTemplateDeprecatedEvent:
      type: object
      description: Event published when an item template is deprecated (soft-disable with optional migration)
      additionalProperties: false
      required:
      - eventId
      - timestamp
      - templateId
      - code
      - gameId
      - name
      - category
      - rarity
      - quantityModel
      - scope
      - isActive
      - createdAt
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique event identifier
        timestamp:
          type: string
          format: date-time
          description: When the event occurred
        templateId:
          type: string
          format: uuid
          description: Deprecated template ID
        code:
          type: string
          description: Item template code
        gameId:
          type: string
          description: Game service ID
        name:
          type: string
          description: Template display name
        category:
          $ref: 'item-api.yaml#/components/schemas/ItemCategory'
          description: Item category
        rarity:
          $ref: 'item-api.yaml#/components/schemas/ItemRarity'
          description: Item rarity tier
        quantityModel:
          $ref: 'item-api.yaml#/components/schemas/QuantityModel'
          description: Quantity tracking model
        scope:
          $ref: 'item-api.yaml#/components/schemas/ItemScope'
          description: Realm availability scope
        isActive:
          type: boolean
          description: Whether template is still active
        createdAt:
          type: string
          format: date-time
          description: When the template was created
        updatedAt:
          type: string
          format: date-time
          nullable: true
          description: When the template was last modified
        migrationTargetId:
          type: string
          format: uuid
          nullable: true
          description: Template ID to migrate existing instances to

    ItemInstanceModifiedEvent:
      type: object
      description: Event published when an item instance is modified (durability, stats, name changes)
      additionalProperties: false
      required:
      - eventId
      - timestamp
      - instanceId
      - templateId
      - containerId
      - realmId
      - quantity
      - originType
      - createdAt
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique event identifier
        timestamp:
          type: string
          format: date-time
          description: When the event occurred
        instanceId:
          type: string
          format: uuid
          description: Modified item instance ID
        templateId:
          type: string
          format: uuid
          description: Item template reference
        containerId:
          type: string
          format: uuid
          description: Container holding this item
        realmId:
          type: string
          format: uuid
          description: Realm this instance exists in
        quantity:
          type: number
          format: double
          description: Current quantity
        originType:
          $ref: 'item-api.yaml#/components/schemas/ItemOriginType'
          description: How this instance was created
        createdAt:
          type: string
          format: date-time
          description: When the instance was created
        modifiedAt:
          type: string
          format: date-time
          nullable: true
          description: When the instance was modified

    ItemInstanceDestroyedEvent:
      type: object
      description: Event published when an item instance is permanently destroyed
      additionalProperties: false
      required:
      - eventId
      - timestamp
      - instanceId
      - templateId
      - containerId
      - realmId
      - quantity
      - originType
      - createdAt
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique event identifier
        timestamp:
          type: string
          format: date-time
          description: When the event occurred
        instanceId:
          type: string
          format: uuid
          description: Destroyed item instance ID
        templateId:
          type: string
          format: uuid
          description: Item template reference
        containerId:
          type: string
          format: uuid
          description: Container that held this item
        realmId:
          type: string
          format: uuid
          description: Realm this instance existed in
        quantity:
          type: number
          format: double
          description: Quantity at time of destruction
        originType:
          $ref: 'item-api.yaml#/components/schemas/ItemOriginType'
          description: How this instance was created
        createdAt:
          type: string
          format: date-time
          description: When the instance was created
        modifiedAt:
          type: string
          format: date-time
          nullable: true
          description: When the instance was last modified

    # =========================================================================
    # Binding Events (non-lifecycle)
    # =========================================================================

    ItemInstanceBoundEvent:
      type: object
      description: Event published when an item is bound to a character (soulbound)
      additionalProperties: false
      required:
      - eventId
      - timestamp
      - instanceId
      - templateId
      - templateCode
      - realmId
      - characterId
      - bindType
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique event identifier
        timestamp:
          type: string
          format: date-time
          description: When the event occurred
        instanceId:
          type: string
          format: uuid
          description: Bound item instance ID
        templateId:
          type: string
          format: uuid
          description: Item template ID
        templateCode:
          type: string
          description: Item template code for debugging
        realmId:
          type: string
          format: uuid
          description: Realm where binding occurred
        characterId:
          type: string
          format: uuid
          description: Character the item is bound to
        bindType:
          $ref: 'item-api.yaml#/components/schemas/SoulboundType'
          description: Type of binding

    ItemInstanceUnboundEvent:
      type: object
      description: Event published when an item binding is removed (admin action, expiration)
      additionalProperties: false
      required:
      - eventId
      - timestamp
      - instanceId
      - templateId
      - templateCode
      - realmId
      - previousCharacterId
      - reason
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique event identifier
        timestamp:
          type: string
          format: date-time
          description: When the event occurred
        instanceId:
          type: string
          format: uuid
          description: Unbound item instance ID
        templateId:
          type: string
          format: uuid
          description: Item template ID
        templateCode:
          type: string
          description: Item template code for debugging
        realmId:
          type: string
          format: uuid
          description: Realm where unbinding occurred
        previousCharacterId:
          type: string
          format: uuid
          description: Character the item was previously bound to
        reason:
          $ref: 'item-api.yaml#/components/schemas/UnbindReason'
          description: Reason for unbinding
        unboundBy:
          type: string
          format: uuid
          nullable: true
          description: Account ID of admin who performed unbinding (if admin action)

    # =========================================================================
    # Item Use Events (batched with deduplication)
    # =========================================================================

    ItemUsedEvent:
      type: object
      description: Published when items are successfully used, batched with deduplication by templateId+userId
      additionalProperties: false
      required:
      - eventId
      - timestamp
      - batchId
      - uses
      - totalCount
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique identifier for this event instance
        timestamp:
          type: string
          format: date-time
          description: When this batched event was published
        batchId:
          type: string
          format: uuid
          description: Unique identifier for this deduplication batch window
        uses:
          type: array
          description: Individual item use records included in this batch
          items:
            $ref: '#/components/schemas/ItemUseRecord'
        totalCount:
          type: integer
          description: Total number of uses in this deduplication window including any deduplicated entries

    ItemUseFailedEvent:
      type: object
      description: Published when item use attempts fail, batched with deduplication by templateId+userId
      additionalProperties: false
      required:
      - eventId
      - timestamp
      - batchId
      - failures
      - totalCount
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique identifier for this event instance
        timestamp:
          type: string
          format: date-time
          description: When this batched event was published
        batchId:
          type: string
          format: uuid
          description: Unique identifier for this deduplication batch window
        failures:
          type: array
          description: Individual item use failure records included in this batch
          items:
            $ref: '#/components/schemas/ItemUseFailureRecord'
        totalCount:
          type: integer
          description: Total number of failures in this deduplication window including any deduplicated entries

    ItemUseRecord:
      type: object
      description: Record of a single successful item use within a batched event
      additionalProperties: false
      required:
      - instanceId
      - templateId
      - templateCode
      - userId
      - userType
      - usedAt
      - consumed
      properties:
        instanceId:
          type: string
          format: uuid
          description: Unique identifier of the item instance that was used
        templateId:
          type: string
          format: uuid
          description: Unique identifier of the item template
        templateCode:
          type: string
          description: Human-readable code of the item template for debugging and analytics
        userId:
          type: string
          format: uuid
          description: Unique identifier of the entity that used the item
        userType:
          $ref: 'common-api.yaml#/components/schemas/EntityType'
          description: Type of user entity
        targetId:
          type: string
          format: uuid
          nullable: true
          description: Unique identifier of the target entity if item was used on a target
        targetType:
          $ref: 'common-api.yaml#/components/schemas/EntityType'
          nullable: true
          description: Type of target entity when targetId is present
        usedAt:
          type: string
          format: date-time
          description: Timestamp when the item was successfully used
        consumed:
          type: boolean
          description: Whether the item was consumed (quantity decremented or item destroyed)
        contractInstanceId:
          type: string
          format: uuid
          nullable: true
          description: Unique identifier of the contract instance that executed the use behavior

    ItemUseFailureRecord:
      type: object
      description: Record of a single failed item use attempt within a batched event
      additionalProperties: false
      required:
      - instanceId
      - templateId
      - templateCode
      - userId
      - userType
      - failedAt
      - reason
      properties:
        instanceId:
          type: string
          format: uuid
          description: Unique identifier of the item instance that failed to be used
        templateId:
          type: string
          format: uuid
          description: Unique identifier of the item template
        templateCode:
          type: string
          description: Human-readable code of the item template for debugging and analytics
        userId:
          type: string
          format: uuid
          description: Unique identifier of the entity that attempted to use the item
        userType:
          $ref: 'common-api.yaml#/components/schemas/EntityType'
          description: Type of user entity
        failedAt:
          type: string
          format: date-time
          description: Timestamp when the use attempt failed
        reason:
          type: string
          description: Human-readable reason why the item use failed

    # =========================================================================
    # Multi-Step Item Use Events
    # =========================================================================

    ItemUseStepCompletedEvent:
      type: object
      description: Published when a multi-step item use milestone is completed
      additionalProperties: false
      required:
      - eventId
      - timestamp
      - instanceId
      - templateId
      - templateCode
      - userId
      - userType
      - contractInstanceId
      - milestoneCode
      - isComplete
      - consumed
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique event identifier
        timestamp:
          type: string
          format: date-time
          description: When the event occurred
        instanceId:
          type: string
          format: uuid
          description: Item instance ID
        templateId:
          type: string
          format: uuid
          description: Item template ID
        templateCode:
          type: string
          description: Item template code for debugging
        userId:
          type: string
          format: uuid
          description: User who completed the step
        userType:
          $ref: 'common-api.yaml#/components/schemas/EntityType'
          description: Type of user entity
        contractInstanceId:
          type: string
          format: uuid
          description: Contract instance tracking this use session
        milestoneCode:
          type: string
          description: The milestone that was completed
        remainingMilestones:
          type: array
          items:
            type: string
          nullable: true
          description: Milestones still to be completed
        isComplete:
          type: boolean
          description: Whether all required milestones are complete
        consumed:
          type: boolean
          description: Whether item was consumed

    ItemUseStepFailedEvent:
      type: object
      description: Published when a multi-step item use milestone fails
      additionalProperties: false
      required:
      - eventId
      - timestamp
      - instanceId
      - templateId
      - templateCode
      - userId
      - userType
      - contractInstanceId
      - milestoneCode
      - reason
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique event identifier
        timestamp:
          type: string
          format: date-time
          description: When the event occurred
        instanceId:
          type: string
          format: uuid
          description: Item instance ID
        templateId:
          type: string
          format: uuid
          description: Item template ID
        templateCode:
          type: string
          description: Item template code for debugging
        userId:
          type: string
          format: uuid
          description: User who attempted the step
        userType:
          $ref: 'common-api.yaml#/components/schemas/EntityType'
          description: Type of user entity
        contractInstanceId:
          type: string
          format: uuid
          description: Contract instance tracking this use session
        milestoneCode:
          type: string
          description: The milestone that failed
        reason:
          type: string
          description: Human-readable reason for failure
