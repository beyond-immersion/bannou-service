openapi: 3.0.3
info:
  title: Item Service Events
  description: |
    Event models for Item service RabbitMQ pub/sub via MassTransit.
    Lifecycle events are auto-generated from x-lifecycle definition.

    **Event Categories**:
    - Template lifecycle: created, updated, deprecated
    - Instance lifecycle: created, modified, destroyed
    - Binding events: bound, unbound

    **Topic Naming**: Uses kebab-case for multi-word entities (item-template, item-instance).

    **NRT Compliance**: AI agents MUST review docs/NRT-SCHEMA-RULES.md before
    modifying this schema. Optional reference types require `nullable: true`.
  version: 1.0.0
  x-event-subscriptions: []
  x-event-publications:
    # Template lifecycle events (auto-generated from x-lifecycle)
    - topic: item-template.created
      event: ItemTemplateCreatedEvent
      description: Published when a new item template is created
    - topic: item-template.updated
      event: ItemTemplateUpdatedEvent
      description: Published when an item template is updated
    - topic: item-template.deprecated
      event: ItemTemplateDeprecatedEvent
      description: Published when an item template is deprecated

    # Instance lifecycle events (auto-generated from x-lifecycle)
    - topic: item-instance.created
      event: ItemInstanceCreatedEvent
      description: Published when a new item instance is created
    - topic: item-instance.modified
      event: ItemInstanceModifiedEvent
      description: Published when an item instance is modified (durability, stats, etc.)
    - topic: item-instance.destroyed
      event: ItemInstanceDestroyedEvent
      description: Published when an item instance is destroyed

    # Binding events (non-lifecycle)
    - topic: item-instance.bound
      event: ItemInstanceBoundEvent
      description: Published when an item is bound to a character (soulbound)
    - topic: item-instance.unbound
      event: ItemInstanceUnboundEvent
      description: Published when an item binding is removed (admin action, expiration)

# Lifecycle events auto-generated from this definition
x-lifecycle:
  ItemTemplate:
    model:
      templateId: { type: string, format: uuid, primary: true, required: true, description: "Unique identifier for the item template" }
      code: { type: string, required: true, description: "Unique item code within game" }
      gameId: { type: string, required: true, description: "Game service this template belongs to" }
      name: { type: string, required: true, description: "Human-readable display name" }
      category: { $ref: '../item-api.yaml#/components/schemas/ItemCategory', required: true, description: "Item classification category" }
      rarity: { $ref: '../item-api.yaml#/components/schemas/ItemRarity', required: true, description: "Item rarity tier" }
      quantityModel: { $ref: '../item-api.yaml#/components/schemas/QuantityModel', required: true, description: "How quantities are tracked" }
      scope: { $ref: '../item-api.yaml#/components/schemas/ItemScope', required: true, description: "Realm availability scope" }
      isActive: { type: boolean, required: true, description: "Whether template is currently active" }
      createdAt: { type: string, format: date-time, required: true, description: "When the template was created" }
      updatedAt: { type: string, format: date-time, nullable: true, description: "When the template was last modified" }
    sensitive: []

  ItemInstance:
    model:
      instanceId: { type: string, format: uuid, primary: true, required: true, description: "Unique identifier for this item instance" }
      templateId: { type: string, format: uuid, required: true, description: "Reference to the item template" }
      containerId: { type: string, format: uuid, required: true, description: "Container holding this item (ownership derived from container)" }
      realmId: { type: string, format: uuid, required: true, description: "Realm this instance exists in" }
      quantity: { type: number, format: double, required: true, description: "Item quantity (1 for unique, integer for discrete, decimal for continuous)" }
      originType: { $ref: '../item-api.yaml#/components/schemas/ItemOriginType', required: true, description: "How this item instance was created" }
      createdAt: { type: string, format: date-time, required: true, description: "When the instance was created" }
      modifiedAt: { type: string, format: date-time, nullable: true, description: "When the instance was last modified" }
    sensitive: []

paths: {}

components:
  schemas:
    # =========================================================================
    # Custom Lifecycle Events (non-standard lifecycle states)
    # =========================================================================

    ItemTemplateDeprecatedEvent:
      type: object
      description: Event published when an item template is deprecated (soft-disable with optional migration)
      additionalProperties: false
      required:
      - eventId
      - timestamp
      - templateId
      - code
      - gameId
      - name
      - category
      - rarity
      - quantityModel
      - scope
      - isActive
      - createdAt
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique event identifier
        timestamp:
          type: string
          format: date-time
          description: When the event occurred
        templateId:
          type: string
          format: uuid
          description: Deprecated template ID
        code:
          type: string
          description: Item template code
        gameId:
          type: string
          description: Game service ID
        name:
          type: string
          description: Template display name
        category:
          type: string
          description: Item category
        rarity:
          type: string
          description: Item rarity tier
        quantityModel:
          type: string
          description: Quantity tracking model
        scope:
          type: string
          description: Realm availability scope
        isActive:
          type: boolean
          description: Whether template is still active
        createdAt:
          type: string
          format: date-time
          description: When the template was created
        updatedAt:
          type: string
          format: date-time
          nullable: true
          description: When the template was last modified
        migrationTargetId:
          type: string
          format: uuid
          nullable: true
          description: Template ID to migrate existing instances to

    ItemInstanceModifiedEvent:
      type: object
      description: Event published when an item instance is modified (durability, stats, name changes)
      additionalProperties: false
      required:
      - eventId
      - timestamp
      - instanceId
      - templateId
      - containerId
      - realmId
      - quantity
      - originType
      - createdAt
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique event identifier
        timestamp:
          type: string
          format: date-time
          description: When the event occurred
        instanceId:
          type: string
          format: uuid
          description: Modified item instance ID
        templateId:
          type: string
          format: uuid
          description: Item template reference
        containerId:
          type: string
          format: uuid
          description: Container holding this item
        realmId:
          type: string
          format: uuid
          description: Realm this instance exists in
        quantity:
          type: number
          format: double
          description: Current quantity
        originType:
          $ref: '../item-api.yaml#/components/schemas/ItemOriginType'
          description: How this instance was created
        createdAt:
          type: string
          format: date-time
          description: When the instance was created
        modifiedAt:
          type: string
          format: date-time
          nullable: true
          description: When the instance was modified

    ItemInstanceDestroyedEvent:
      type: object
      description: Event published when an item instance is permanently destroyed
      additionalProperties: false
      required:
      - eventId
      - timestamp
      - instanceId
      - templateId
      - containerId
      - realmId
      - quantity
      - originType
      - createdAt
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique event identifier
        timestamp:
          type: string
          format: date-time
          description: When the event occurred
        instanceId:
          type: string
          format: uuid
          description: Destroyed item instance ID
        templateId:
          type: string
          format: uuid
          description: Item template reference
        containerId:
          type: string
          format: uuid
          description: Container that held this item
        realmId:
          type: string
          format: uuid
          description: Realm this instance existed in
        quantity:
          type: number
          format: double
          description: Quantity at time of destruction
        originType:
          $ref: '../item-api.yaml#/components/schemas/ItemOriginType'
          description: How this instance was created
        createdAt:
          type: string
          format: date-time
          description: When the instance was created
        modifiedAt:
          type: string
          format: date-time
          nullable: true
          description: When the instance was last modified

    # =========================================================================
    # Binding Events (non-lifecycle)
    # =========================================================================

    ItemInstanceBoundEvent:
      type: object
      description: Event published when an item is bound to a character (soulbound)
      additionalProperties: false
      required:
      - eventId
      - timestamp
      - instanceId
      - templateId
      - templateCode
      - realmId
      - characterId
      - bindType
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique event identifier
        timestamp:
          type: string
          format: date-time
          description: When the event occurred
        instanceId:
          type: string
          format: uuid
          description: Bound item instance ID
        templateId:
          type: string
          format: uuid
          description: Item template ID
        templateCode:
          type: string
          description: Item template code for debugging
        realmId:
          type: string
          format: uuid
          description: Realm where binding occurred
        characterId:
          type: string
          format: uuid
          description: Character the item is bound to
        bindType:
          $ref: '../item-api.yaml#/components/schemas/SoulboundType'
          description: Type of binding

    ItemInstanceUnboundEvent:
      type: object
      description: Event published when an item binding is removed (admin action, expiration)
      additionalProperties: false
      required:
      - eventId
      - timestamp
      - instanceId
      - templateId
      - templateCode
      - realmId
      - previousCharacterId
      - reason
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique event identifier
        timestamp:
          type: string
          format: date-time
          description: When the event occurred
        instanceId:
          type: string
          format: uuid
          description: Unbound item instance ID
        templateId:
          type: string
          format: uuid
          description: Item template ID
        templateCode:
          type: string
          description: Item template code for debugging
        realmId:
          type: string
          format: uuid
          description: Realm where unbinding occurred
        previousCharacterId:
          type: string
          format: uuid
          description: Character the item was previously bound to
        reason:
          type: string
          description: Reason for unbinding (admin, expiration, transfer_override)
        unboundBy:
          type: string
          format: uuid
          nullable: true
          description: Account ID of admin who performed unbinding (if admin action)
