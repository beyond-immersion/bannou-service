openapi: 3.0.0
info:
  title: ABML Behavior Management API
  version: 3.0.0
  description: |
    Arcadia Behavior Markup Language (ABML) API for character behavior management.

    **POST-Only API Pattern**: This API uses POST for all operations to support zero-copy
    WebSocket routing. Path parameters are passed in request bodies instead of URLs.
    See docs/BANNOU_DESIGN.md for architectural rationale.

    This API handles:
    - YAML-based behavior definition parsing and compilation
    - Stackable behavior set management with priority resolution
    - GOAP (Goal-Oriented Action Planning) integration
    - Cultural adaptation and context-aware behavior modification
    - Real-time behavior state management and caching
    - Integration with Bannou mesh for distributed character agents

    **SCHEMA MODIFICATION GATE**: STOP. Before modifying this schema, you MUST:
    1. Read docs/reference/SCHEMA-RULES.md
    2. State which section applies to your change
    3. Only then proceed with edits
    Edits without stating the applicable rule are FORBIDDEN.
servers:
- url: http://localhost:5012
  description: Bannou service endpoint (internal only)

x-service-layer: GameFeatures

paths:
  /compile:
    post:
      summary: Compile ABML behavior definition
      description: |
        Compiles a YAML-based ABML behavior definition into executable behavior trees.
        Handles stackable behavior sets, cultural adaptations, and context variable resolution.
      operationId: CompileAbmlBehavior
      tags:
      - ABML
      x-permissions:
      - role: developer
        states: {}
      requestBody:
        required: true
        content:
          application/yaml:
            schema:
              type: string
              description: Raw ABML YAML content
            example: |
              version: "1.0.0"
              metadata:
                id: "blacksmith_daily_routine"
                category: "profession"
                priority: 60
                description: "Daily routine for a master blacksmith NPC"

              context:
                variables:
                  energy_level: "${npc.stats.energy}"
                  skill_level: "${npc.skills.blacksmithing}"
                  shop_reputation: "${npc.reputation.local}"

                services:
                  - name: "crafting_service"
                    required: true
                  - name: "economy_service"
                    required: true

              behaviors:
                morning_startup:
                  triggers:
                    - time_range: "06:00-09:00"
                    - condition: "${context.energy_level > 0.7}"
                  actions:
                    - wake_up:
                        animation: "stretch_and_yawn"
                        duration: 3
                        energy_cost: -0.05
          application/json:
            schema:
              $ref: '#/components/schemas/CompileBehaviorRequest'
      responses:
        '200':
          description: ABML behavior compiled successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CompileBehaviorResponse'
        '400':
          description: Invalid ABML definition or compilation error
        '403':
          description: Forbidden - insufficient permissions
        '500':
          description: Internal server error

  /validate:
    post:
      summary: Validate ABML definition
      description: |
        Validates ABML YAML against schema and checks for semantic correctness.
        Includes context variable validation and service dependency checking.
      operationId: ValidateAbml
      tags:
      - Validation
      x-permissions:
      - role: developer
        states: {}
      requestBody:
        required: true
        content:
          application/yaml:
            schema:
              type: string
              description: Raw ABML YAML content to validate
          application/json:
            schema:
              $ref: '#/components/schemas/ValidateAbmlRequest'
      responses:
        '200':
          description: Validation completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidateAbmlResponse'

  /cache/get:
    post:
      summary: Get cached compiled behavior
      description: |
        Retrieves a previously compiled behavior from the cache.
        Used for performance optimization in high-frequency behavior execution.
      operationId: GetCachedBehavior
      tags:
      - Cache
      x-permissions:
      - role: developer
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetCachedBehaviorRequest'
      responses:
        '200':
          description: Cached behavior retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CachedBehaviorResponse'
        '404':
          description: Behavior not found in cache

  /cache/invalidate:
    post:
      summary: Invalidate cached behavior
      description: |
        Removes a behavior from the cache, forcing recompilation on next access.
        Used when behavior definitions are updated.
      operationId: InvalidateCachedBehavior
      tags:
      - Cache
      x-permissions:
      - role: developer
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InvalidateCacheRequest'
      responses:
        '200':
          description: Cache invalidated successfully
        '404':
          description: Behavior not found in cache

  /goap/plan:
    post:
      summary: Generate GOAP plan
      description: |
        Generates a GOAP plan to achieve a goal from the current world state.
        Uses A* search to find the optimal sequence of actions.
      operationId: GenerateGoapPlan
      tags:
      - GOAP
      x-permissions:
      - role: developer
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GoapPlanRequest'
      responses:
        '200':
          description: Plan generated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GoapPlanResponse'
        '400':
          description: Invalid request or planning failed

  /goap/validate-plan:
    post:
      summary: Validate existing GOAP plan
      description: |
        Validates an existing GOAP plan against the current world state.
        Returns whether the plan is still valid or needs replanning.
      operationId: ValidateGoapPlan
      tags:
      - GOAP
      x-permissions:
      - role: developer
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ValidateGoapPlanRequest'
      responses:
        '200':
          description: Plan validation completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidateGoapPlanResponse'
        '400':
          description: Invalid request

components:
  schemas:
    # Request Models for POST-only pattern
    GetCachedBehaviorRequest:
      type: object
      additionalProperties: false
      description: Request to get a cached compiled behavior
      required:
      - behaviorId
      properties:
        behaviorId:
          type: string
          description: Unique identifier for the cached behavior

    InvalidateCacheRequest:
      type: object
      additionalProperties: false
      description: Request to invalidate a cached behavior
      required:
      - behaviorId
      properties:
        behaviorId:
          type: string
          description: Unique identifier for the cached behavior to invalidate

    CompileBehaviorRequest:
      description: Request to compile an ABML behavior definition into executable behavior trees
      type: object
      additionalProperties: false
      required:
      - abmlContent
      properties:
        abmlContent:
          type: string
          description: Raw ABML YAML content to compile
          example: |
            version: "1.0.0"
            metadata:
              id: "example_behavior"
              category: "basic"
            behaviors:
              example:
                triggers:
                  - condition: "true"
                actions:
                  - log:
                      message: "Hello World"
        behaviorName:
          type: string
          # NRT: Optional string MUST be nullable (Rule 2)
          nullable: true
          description: |
            Optional human-readable name for the behavior.
            If not provided, extracted from ABML metadata.id or generated from content hash.
          example: "blacksmith_daily_routine"
        behaviorCategory:
          type: string
          description: |
            Category for organizing behaviors (e.g., profession, cultural, situational).
            Used for filtering and grouping in bundles.
          enum: [base, cultural, professional, personal, situational, ambient]
          # NRT: Optional enum MUST be nullable (Rule 2)
          nullable: true
          example: "professional"
        bundleId:
          type: string
          # NRT: Optional string MUST be nullable (Rule 2)
          nullable: true
          description: |
            Optional bundle identifier for grouping related behaviors.
            When specified, the compiled behavior will be added to a bundle with this ID.
            Clients can then download entire bundles for efficient bulk loading.
            If the bundle doesn't exist, it will be created.
          example: "blacksmith-behaviors-v1"
        characterContext:
          $ref: '#/components/schemas/CharacterContext'
          # NRT: Optional object MUST be nullable (Rule 2)
          nullable: true
          description: Character context for context variable resolution during compilation
        compilationOptions:
          $ref: '#/components/schemas/CompilationOptions'
          # NRT: Optional object MUST be nullable (Rule 2)
          nullable: true
          description: Options controlling the compilation process

    # NOTE: BehaviorStackRequest removed - see docs/guides/ABML.md for rationale

    ValidateAbmlRequest:
      description: Request to validate ABML YAML content against schema and semantic rules
      type: object
      additionalProperties: false
      required:
      - abmlContent
      properties:
        abmlContent:
          type: string
          description: Raw ABML YAML content to validate
        strictMode:
          type: boolean
          default: false
          description: Enable strict validation mode with enhanced checking

    # NOTE: ResolveContextRequest removed - see docs/guides/ABML.md for rationale

    # Response Models
    CompileBehaviorResponse:
      description: Response containing the results of an ABML behavior compilation
      type: object
      additionalProperties: false
      required:
      - behaviorId
      properties:
        behaviorId:
          type: string
          description: Unique identifier for the compiled behavior (content-addressable hash)
          example: "behavior-a1b2c3d4e5f6g7h8"
        behaviorName:
          type: string
          # NRT: Optional string MUST be nullable (Rule 2)
          nullable: true
          description: Human-readable name of the behavior
          example: "blacksmith_daily_routine"
        compiledBehavior:
          $ref: '#/components/schemas/CompiledBehavior'
          # NRT: Optional object MUST be nullable (Rule 2)
          nullable: true
          description: The compiled behavior data including behavior tree and metadata
        compilationTimeMs:
          type: integer
          description: Time taken to compile the behavior in milliseconds
        assetId:
          type: string
          nullable: true
          description: Asset service ID where the compiled bytecode is stored. Null only when caching is explicitly 
            disabled.
        bundleId:
          type: string
          nullable: true
          description: Bundle ID if the behavior was added to a bundle. Null if not bundled.
        isUpdate:
          type: boolean
          description: True if this replaced an existing behavior with the same content hash
        warnings:
          type: array
          items:
            type: string
          # NRT: Optional array MUST be nullable (Rule 2)
          nullable: true
          description: Non-fatal warnings during compilation

    ValidateAbmlResponse:
      description: Response containing the results of ABML validation including errors and warnings
      type: object
      additionalProperties: false
      required:
      - isValid
      properties:
        isValid:
          type: boolean
          description: Whether the ABML definition is valid
        validationErrors:
          type: array
          items:
            $ref: '#/components/schemas/ValidationError'
          # NRT: Optional array MUST be nullable (Rule 2)
          nullable: true
          description: List of validation errors if invalid
        semanticWarnings:
          type: array
          items:
            type: string
          # NRT: Optional array MUST be nullable (Rule 2)
          nullable: true
          description: Semantic warnings that don't prevent compilation
        schemaVersion:
          type: string
          # NRT: Optional string MUST be nullable (Rule 2)
          nullable: true
          description: ABML schema version used for validation

    CachedBehaviorResponse:
      description: Response containing a previously compiled behavior retrieved from cache
      type: object
      additionalProperties: false
      required:
      - behaviorId
      - compiledBehavior
      properties:
        behaviorId:
          type: string
          description: Unique identifier for the cached behavior
        compiledBehavior:
          $ref: '#/components/schemas/CompiledBehavior'
          description: The compiled behavior data retrieved from cache
        cacheTimestamp:
          type: string
          format: date-time
          # NRT: Optional string MUST be nullable (Rule 2)
          nullable: true
          description: When the behavior was cached
        cacheHit:
          type: boolean
          description: Whether this was a cache hit or miss

    # NOTE: ResolveContextResponse removed - see docs/guides/ABML.md for rationale
    # NOTE: BehaviorSetDefinition removed - see docs/guides/ABML.md for rationale

    # Core Data Models
    CharacterContext:
      type: object
      additionalProperties: false
      description: Context information about a character for behavior resolution
      properties:
        npcId:
          type: string
          # NRT: Optional string MUST be nullable (Rule 2)
          nullable: true
          description: Unique identifier for the NPC
          example: "npc_12345"
        culture:
          type: string
          # NRT: Optional string MUST be nullable (Rule 2)
          nullable: true
          description: Cultural background identifier
          example: "european_medieval"
        profession:
          type: string
          # NRT: Optional string MUST be nullable (Rule 2)
          nullable: true
          description: Character profession identifier
          example: "blacksmith"
        stats:
          type: object
          additionalProperties:
            type: number
          # NRT: Optional object MUST be nullable (Rule 2)
          nullable: true
          description: Character statistics and attributes
          example:
            energy: 0.8
            health: 1.0
            hunger: 0.3
        skills:
          type: object
          additionalProperties:
            type: number
          # NRT: Optional object MUST be nullable (Rule 2)
          nullable: true
          description: Character skill levels
          example:
            blacksmithing: 85
            trading: 42
        location:
          $ref: '#/components/schemas/Location'
          # NRT: Optional object MUST be nullable (Rule 2)
          nullable: true
          description: Current location information for the character
        relationships:
          type: object
          additionalProperties:
            type: number
          # NRT: Optional object MUST be nullable (Rule 2)
          nullable: true
          description: Relationship values with other characters
        worldState:
          type: object
          additionalProperties: true
          # NRT: Optional object MUST be nullable (Rule 2)
          nullable: true
          description: Relevant world state information

    BehaviorTreeData:
      type: object
      additionalProperties: false
      description: Compiled behavior tree data with bytecode or download reference
      properties:
        bytecode:
          type: string
          # NRT: Optional string MUST be nullable (Rule 2)
          nullable: true
          description: Base64-encoded compiled bytecode for the behavior tree
        bytecodeSize:
          type: integer
          description: Size of the bytecode in bytes
        downloadUrl:
          type: string
          # NRT: Optional string MUST be nullable (Rule 2)
          nullable: true
          description: URL to download the compiled behavior asset

    ContextSchemaData:
      type: object
      description: Schema defining required context variables for behavior execution
      additionalProperties: true

    CompiledBehavior:
      description: Compiled behavior containing behavior tree, context schema, and GOAP integration data
      type: object
      additionalProperties: false
      required:
      - behaviorTree
      - contextSchema
      properties:
        behaviorTree:
          $ref: '#/components/schemas/BehaviorTreeData'
          description: Compiled behavior tree data with bytecode or download reference
        contextSchema:
          $ref: '#/components/schemas/ContextSchemaData'
          description: Schema defining required context variables for execution
        serviceDependencies:
          type: array
          items:
            type: string
          # NRT: Optional array MUST be nullable (Rule 2)
          nullable: true
          description: List of required services for this behavior
        goapGoals:
          type: array
          items:
            $ref: '#/components/schemas/GoapGoal'
          # NRT: Optional array MUST be nullable (Rule 2)
          nullable: true
          description: GOAP goals extracted from the behavior
        executionMetadata:
          $ref: '#/components/schemas/ExecutionMetadata'
          # NRT: Optional object MUST be nullable (Rule 2)
          nullable: true
          description: Metadata for behavior execution including performance hints and resource requirements

    Location:
      type: object
      additionalProperties: false
      description: Character location information including current position, region, and 3D coordinates
      properties:
        current:
          type: string
          # NRT: Optional string MUST be nullable (Rule 2)
          nullable: true
          description: Current location name or identifier
        region:
          type: string
          # NRT: Optional string MUST be nullable (Rule 2)
          nullable: true
          description: Region or zone the character is in
        coordinates:
          $ref: '#/components/schemas/Coordinates'
          # NRT: Optional object MUST be nullable (Rule 2)
          nullable: true
          description: 3D spatial coordinates of the character's position in the game world

    Coordinates:
      type: object
      additionalProperties: false
      description: 3D spatial coordinates representing a position in the game world
      properties:
        x:
          type: number
          description: X coordinate position
        y:
          type: number
          description: Y coordinate position
        z:
          type: number
          description: Z coordinate position

    ExecutionMetadata:
      type: object
      additionalProperties: false
      description: Metadata about behavior execution requirements including timing, resources, and interrupt conditions
      properties:
        estimatedDuration:
          type: integer
          description: Estimated execution time in seconds
        resourceRequirements:
          type: object
          additionalProperties:
            type: number
          # NRT: Optional object MUST be nullable (Rule 2)
          nullable: true
          description: Resource requirements for behavior execution
        interruptConditions:
          type: array
          items:
            type: string
          # NRT: Optional array MUST be nullable (Rule 2)
          nullable: true
          description: Conditions that can interrupt behavior execution

    GoapGoal:
      description: Goal definition for GOAP planning with conditions and priority
      type: object
      additionalProperties: false
      required:
      - name
      - conditions
      - priority
      properties:
        name:
          type: string
          description: Name of the goal
          example: "satisfy_hunger"
        description:
          type: string
          # NRT: Optional string MUST be nullable (Rule 2)
          nullable: true
          description: Human-readable description of the goal
        conditions:
          type: object
          additionalProperties:
            type: string
          description: World state conditions that satisfy this goal (literal conditions)
          example:
            hunger: "<= 0.3"
            gold: ">= 50"
        priority:
          type: integer
          minimum: 1
          maximum: 100
          description: Priority of this goal relative to others
        preconditions:
          type: object
          additionalProperties:
            type: string
          # NRT: Optional object MUST be nullable (Rule 2)
          nullable: true
          description: World state conditions required to pursue this goal

    GoapPlanRequest:
      description: Request to generate a GOAP plan to achieve a goal from current world state
      type: object
      additionalProperties: false
      required:
      - goal
      - worldState
      - behaviorId
      properties:
        agentId:
          type: string
          # NRT: Optional string MUST be nullable (Rule 2)
          nullable: true
          description: Unique identifier for the agent requesting the plan
        goal:
          $ref: '#/components/schemas/GoapGoal'
          description: The goal to achieve through planning
        worldState:
          type: object
          additionalProperties: true
          description: Current world state as key-value pairs
          example:
            hunger: 0.8
            gold: 50
            location: "home"
        behaviorId:
          type: string
          description: ID of compiled behavior containing GOAP actions
        options:
          $ref: '#/components/schemas/GoapPlanningOptions'
          # NRT: Optional object MUST be nullable (Rule 2)
          nullable: true
          description: Options controlling the planning process

    GoapPlanResponse:
      description: Response containing the generated GOAP plan. If no plan could be found, plan is null and 
        failureReason explains why.
      type: object
      additionalProperties: false
      properties:
        plan:
          $ref: '#/components/schemas/GoapPlanResult'
          # NRT: Optional object MUST be nullable (Rule 2)
          nullable: true
          description: The generated plan if successful
        planningTimeMs:
          type: integer
          description: Time spent planning in milliseconds
        nodesExpanded:
          type: integer
          description: Number of nodes expanded during A* search
        failureReason:
          type: string
          # NRT: Optional string MUST be nullable (Rule 2)
          nullable: true
          description: Reason for planning failure if unsuccessful
          example: "No plan found - goal unreachable"

    GoapPlanResult:
      description: Result of GOAP planning containing the ordered sequence of actions to achieve a goal
      type: object
      additionalProperties: false
      required:
      - goalId
      - actions
      - totalCost
      properties:
        goalId:
          type: string
          description: ID of the goal this plan achieves
        actions:
          type: array
          items:
            $ref: '#/components/schemas/PlannedActionResponse'
          description: Ordered sequence of actions to execute
        totalCost:
          type: number
          format: float
          description: Total cost of all actions in the plan

    PlannedActionResponse:
      description: Single action within a GOAP plan with position and cost information
      type: object
      additionalProperties: false
      required:
      - actionId
      - index
      - cost
      properties:
        actionId:
          type: string
          description: ID of the action (flow name)
        index:
          type: integer
          description: Position in the plan sequence
        cost:
          type: number
          format: float
          description: Cost of this action

    ValidateGoapPlanRequest:
      description: Request to validate an existing GOAP plan against current world state
      type: object
      additionalProperties: false
      required:
      - plan
      - currentActionIndex
      - worldState
      properties:
        plan:
          $ref: '#/components/schemas/GoapPlanResult'
          description: The plan to validate
        currentActionIndex:
          type: integer
          description: Index of the action currently being executed
        worldState:
          type: object
          additionalProperties: true
          description: Current world state
        activeGoals:
          type: array
          items:
            $ref: '#/components/schemas/GoapGoal'
          # NRT: Optional array MUST be nullable (Rule 2)
          nullable: true
          description: All active goals for priority checking

    ValidateGoapPlanResponse:
      description: Response indicating whether a GOAP plan is still valid and suggested next action
      type: object
      additionalProperties: false
      required:
      - isValid
      - reason
      - suggestedAction
      properties:
        isValid:
          type: boolean
          description: Whether the plan is still valid
        reason:
          type: string
          enum:
          - none
          - preconditionInvalidated
          - actionFailed
          - betterGoalAvailable
          - planCompleted
          - goalAlreadySatisfied
          - suboptimalPlan
          description: Reason for the validation result
        suggestedAction:
          type: string
          enum:
          - continue
          - replan
          - abort
          description: Suggested action based on validation
        invalidatedAtIndex:
          type: integer
          description: Index where plan became invalid (if applicable)
        message:
          type: string
          nullable: true
          description: Additional details about the validation result. Null when no additional context is needed.

    GoapPlanningOptions:
      description: Options controlling the GOAP planning process including depth and timeout limits
      type: object
      additionalProperties: false
      properties:
        maxDepth:
          type: integer
          default: 10
          description: Maximum plan depth (number of actions)
        maxNodes:
          type: integer
          default: 1000
          description: Maximum nodes to expand during search
        timeoutMs:
          type: integer
          default: 100
          description: Planning timeout in milliseconds

    CompilationOptions:
      description: Options controlling the ABML compilation process including optimizations and caching
      type: object
      additionalProperties: false
      properties:
        enableOptimizations:
          type: boolean
          default: true
          description: Enable behavior tree optimizations
        cacheCompiledResult:
          type: boolean
          default: true
          description: Cache the compiled behavior for reuse
        strictValidation:
          type: boolean
          default: false
          description: Enable strict validation mode
        culturalAdaptations:
          type: boolean
          default: true
          description: Apply cultural adaptations during compilation
        goapIntegration:
          type: boolean
          default: true
          description: Generate GOAP goals from behaviors

    ValidationError:
      description: Detailed validation error with type, location, and message information
      type: object
      additionalProperties: false
      required:
      - type
      - message
      properties:
        type:
          type: string
          enum: [syntax, semantic, schema, context, service_dependency]
          description: Type of validation error
        message:
          type: string
          description: Human-readable error message
        lineNumber:
          type: integer
          description: Line number where the error occurred (if applicable)
        columnNumber:
          type: integer
          description: Column number where the error occurred (if applicable)
        yamlPath:
          type: string
          # NRT: Optional string MUST be nullable (Rule 2)
          nullable: true
          description: YAML path to the problematic element
          example: "behaviors.morning_startup.actions[0]"

tags:
- name: ABML
  description: Core ABML compilation and management operations
- name: BehaviorStacks
  description: Stackable behavior set compilation and merging
- name: Validation
  description: ABML validation and semantic checking
- name: Cache
  description: Behavior compilation caching operations
- name: Context
  description: Context variable resolution and management
- name: GOAP
  description: Goal-Oriented Action Planning for NPC behavior
