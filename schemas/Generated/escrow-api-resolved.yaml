openapi: 3.0.4
info:
  title: Escrow Service API
  version: 1.0.0
  description: |
    Full-custody orchestration layer for multi-party asset exchanges.

    lib-escrow sits ABOVE the foundational asset plugins (lib-currency, lib-inventory,
    lib-contract). It creates its own wallets, containers, and contract locks to take
    complete possession of assets during multi-party agreements.

    **Key Design Principle**: The contract is the brain, escrow is the vault. The bound
    contract defines what assets are needed, how they should be distributed, and what
    fees apply. The escrow holds assets and gates access.

    **Per-Party Infrastructure**: Each party gets their own dedicated escrow wallet and
    container (owned by the escrow entity). This enables clean refunds, contribution
    tracking, and ownership validation.

    **POST-Only API Pattern**: This API uses POST for all operations to support
    zero-copy WebSocket routing. Path parameters are passed in request bodies.

    **SCHEMA MODIFICATION GATE**: STOP. Before modifying this schema, you MUST:
    1. Read docs/reference/SCHEMA-RULES.md
    2. State which section applies to your change
    3. Only then proceed with edits
    Edits without stating the applicable rule are FORBIDDEN.

servers:
- url: http://localhost:5012
  description: Bannou service endpoint (internal only)

x-service-layer: GameFeatures

paths:
  # ===========================================================================
  # Lifecycle (4 endpoints)
  # ===========================================================================

  /escrow/create:
    post:
      operationId: createEscrow
      tags:
      - Lifecycle
      summary: Create a new escrow agreement
      description: |
        Create a new escrow agreement. For each party, creates a dedicated escrow wallet
        and container (owned by escrow entity). Issues deposit tokens and returns ALL
        tokens to the creating service, which is responsible for distributing them to
        parties through appropriate channels. Sets template values on bound contract.
      x-permissions:
      - role: developer
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateEscrowRequest'
      responses:
        '200':
          description: Escrow created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateEscrowResponse'
        '400':
          description: Invalid request
  /escrow/get:
    post:
      operationId: getEscrow
      tags:
      - Lifecycle
      summary: Get escrow details
      description: Get escrow agreement details by ID.
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetEscrowRequest'
      responses:
        '200':
          description: Escrow details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetEscrowResponse'
        '404':
          description: Escrow not found
  /escrow/list:
    post:
      operationId: listEscrows
      tags:
      - Lifecycle
      summary: List escrows for a party
      description: List escrow agreements with filtering options.
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ListEscrowsRequest'
      responses:
        '200':
          description: List of escrows
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListEscrowsResponse'

  /escrow/get-my-token:
    post:
      operationId: getMyToken
      tags:
      - Lifecycle
      summary: Get deposit or release token for a party
      description: |
        Get the deposit or release token for a specific party. Internal-only endpoint
        accessed via Shortcut APIs (prebound). Direct user access is prohibited to prevent
        token snooping. The party is identified by ownerId/ownerType (works for characters,
        NPCs, guilds, etc.).
      x-permissions: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetMyTokenRequest'
      responses:
        '200':
          description: Token information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetMyTokenResponse'
        '404':
          description: Escrow or party not found
  # ===========================================================================
  # Deposits (3 endpoints)
  # ===========================================================================

  /escrow/deposit:
    post:
      operationId: deposit
      tags:
      - Deposits
      summary: Deposit assets into escrow
      description: |
        Deposit assets into escrow. Transfers currency from party's own wallet to that
        party's escrow wallet. Moves items from party's own container to that party's
        escrow container. Locks contracts with escrow as guardian.
        Rejects soulbound/non-tradeable items. After each deposit, queries bound contract
        to check if all asset requirements are satisfied.
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DepositRequest'
      responses:
        '200':
          description: Deposit successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DepositResponse'
        '400':
          description: Deposit failed
  /escrow/deposit/validate:
    post:
      operationId: validateDeposit
      tags:
      - Deposits
      summary: Validate a deposit without executing
      description: Validate a deposit without executing (dry run).
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ValidateDepositRequest'
      responses:
        '200':
          description: Validation result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidateDepositResponse'

  /escrow/deposit/status:
    post:
      operationId: getDepositStatus
      tags:
      - Deposits
      summary: Get deposit status for a party
      description: Get deposit status for a party in an escrow.
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetDepositStatusRequest'
      responses:
        '200':
          description: Deposit status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetDepositStatusResponse'

  # ===========================================================================
  # Consent (2 endpoints)
  # ===========================================================================

  /escrow/consent:
    post:
      operationId: recordConsent
      tags:
      - Consent
      summary: Record party consent
      description: Record party consent for release, refund, or re-affirmation.
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConsentRequest'
      responses:
        '200':
          description: Consent recorded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConsentResponse'
        '400':
          description: Consent failed
  /escrow/consent/status:
    post:
      operationId: getConsentStatus
      tags:
      - Consent
      summary: Get consent status for escrow
      description: Get consent status for all parties in an escrow.
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetConsentStatusRequest'
      responses:
        '200':
          description: Consent status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetConsentStatusResponse'

  # ===========================================================================
  # Completion (4 endpoints)
  # ===========================================================================

  /escrow/release:
    post:
      operationId: release
      tags:
      - Completion
      summary: Trigger release
      description: |
        Trigger release (for trusted modes or after consent).
        If boundContractId is set, checks contract status first (must be fulfilled).
        Runs finalization flow before releasing remaining assets.
      x-permissions:
      - role: developer
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReleaseRequest'
      responses:
        '200':
          description: Release result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReleaseResponse'
        '400':
          description: Release failed
  /escrow/refund:
    post:
      operationId: refund
      tags:
      - Completion
      summary: Trigger refund
      description: Trigger refund (for trusted modes or consent).
      x-permissions:
      - role: developer
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefundRequest'
      responses:
        '200':
          description: Refund result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RefundResponse'
        '400':
          description: Refund failed
  /escrow/cancel:
    post:
      operationId: cancel
      tags:
      - Completion
      summary: Cancel escrow before fully funded
      description: Cancel escrow before fully funded, refunding any deposits.
      x-permissions:
      - role: developer
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CancelRequest'
      responses:
        '200':
          description: Cancel result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CancelResponse'
        '400':
          description: Cancel failed
  /escrow/dispute:
    post:
      operationId: dispute
      tags:
      - Completion
      summary: Raise a dispute on funded escrow
      description: Raise a dispute on a funded escrow.
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DisputeRequest'
      responses:
        '200':
          description: Dispute raised
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DisputeResponse'
        '400':
          description: Dispute failed
  /escrow/confirm-release:
    post:
      operationId: confirmRelease
      tags:
      - Completion
      summary: Confirm receipt of released assets
      description: |
        Called by parties to confirm they received their released assets.
        Required when ReleaseMode is party_required or service_and_party.
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConfirmReleaseRequest'
      responses:
        '200':
          description: Confirmation recorded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfirmReleaseResponse'
        '400':
          description: Confirmation failed
        '404':
          description: Escrow not found
  /escrow/confirm-refund:
    post:
      operationId: confirmRefund
      tags:
      - Completion
      summary: Confirm receipt of refunded assets
      description: |
        Called by parties to confirm they received their refunded deposits.
        Required when RefundMode is party_required.
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConfirmRefundRequest'
      responses:
        '200':
          description: Confirmation recorded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfirmRefundResponse'
        '400':
          description: Confirmation failed
        '404':
          description: Escrow not found
  # ===========================================================================
  # Arbiter (1 endpoint)
  # ===========================================================================

  /escrow/resolve:
    post:
      operationId: resolve
      tags:
      - Arbiter
      summary: Arbiter resolves disputed escrow
      description: Arbiter resolves a disputed escrow.
      x-permissions:
      - role: developer
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResolveRequest'
      responses:
        '200':
          description: Resolution result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ResolveResponse'
        '400':
          description: Resolution failed
  # ===========================================================================
  # Condition (1 endpoint)
  # ===========================================================================

  /escrow/verify-condition:
    post:
      operationId: verifyCondition
      tags:
      - Condition
      summary: Verify condition for conditional escrow
      description: |
        Verify condition for conditional escrow (non-contract path).
        For escrows with boundContractId, use contract milestones instead.
      x-permissions:
      - role: developer
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VerifyConditionRequest'
      responses:
        '200':
          description: Verification result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VerifyConditionResponse'
        '400':
          description: Verification failed
  # ===========================================================================
  # Validation (2 endpoints)
  # ===========================================================================

  /escrow/validate:
    post:
      operationId: validateEscrow
      tags:
      - Validation
      summary: Manually trigger validation
      description: Manually trigger validation on an active escrow.
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ValidateEscrowRequest'
      responses:
        '200':
          description: Validation result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidateEscrowResponse'

  /escrow/reaffirm:
    post:
      operationId: reaffirm
      tags:
      - Validation
      summary: Re-affirm after validation failure
      description: Re-affirm after validation failure (party accepts changed state).
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReaffirmRequest'
      responses:
        '200':
          description: Reaffirmation result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReaffirmResponse'
        '400':
          description: Reaffirmation failed
  # ===========================================================================
  # Handlers (3 endpoints)
  # ===========================================================================

  /escrow/handler/register:
    post:
      operationId: registerHandler
      tags:
      - Handlers
      summary: Register a custom asset type handler
      description: Register a custom asset type handler for extensibility.
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterHandlerRequest'
      responses:
        '200':
          description: Handler registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RegisterHandlerResponse'
        '400':
          description: Registration failed
  /escrow/handler/list:
    post:
      operationId: listHandlers
      tags:
      - Handlers
      summary: List registered asset handlers
      description: List registered asset handlers (includes built-in).
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ListHandlersRequest'
      responses:
        '200':
          description: List of handlers
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListHandlersResponse'

  /escrow/handler/deregister:
    post:
      operationId: deregisterHandler
      tags:
      - Handlers
      summary: Remove a custom asset handler registration
      description: Remove a custom asset handler registration.
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeregisterHandlerRequest'
      responses:
        '200':
          description: Handler deregistered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeregisterHandlerResponse'
        '400':
          description: Deregistration failed
components:
  schemas:
    # ==========================================================================
    # Enums (10 enums)
    # ==========================================================================

    EscrowType:
      type: string
      description: |
        Type of escrow agreement.
        - two_party: Simple trade escrow between Party A and Party B
        - multi_party: N parties with complex deposit/receive rules
        - conditional: Release based on external condition or contract fulfillment
        - auction: Winner-takes-all with refunds to losers
      enum:
      - two_party
      - multi_party
      - conditional
      - auction

    EscrowStatus:
      type: string
      description: |
        Current status of the escrow agreement.
        - pending_deposits: Waiting for parties to deposit
        - partially_funded: Some but not all deposits received
        - funded: All deposits received, awaiting consent/condition
        - pending_consent: Some consents received, waiting for more
        - pending_condition: Waiting for contract fulfillment or external verification
        - finalizing: Running contract finalizer prebound APIs (transient)
        - releasing: Release in progress (transient)
        - released: Assets transferred to recipients
        - refunding: Refund in progress (transient)
        - refunded: Assets returned to depositors
        - disputed: In dispute, arbiter must resolve
        - expired: Timed out without completion
        - cancelled: Cancelled before funding complete
        - validation_failed: Held assets changed, awaiting re-affirmation
      enum:
      - pending_deposits
      - partially_funded
      - funded
      - pending_consent
      - pending_condition
      - finalizing
      - releasing
      - released
      - refunding
      - refunded
      - disputed
      - expired
      - cancelled
      - validation_failed

    EscrowTrustMode:
      type: string
      description: |
        Trust model for the escrow agreement.
        - full_consent: All parties must explicitly consent using tokens
        - initiator_trusted: The service that created the escrow can complete unilaterally
        - single_party_trusted: A designated party can complete unilaterally
      enum:
      - full_consent
      - initiator_trusted
      - single_party_trusted

    EscrowPartyRole:
      type: string
      description: |
        Role of a party in the escrow.
        - depositor: Deposits assets into escrow
        - recipient: Receives assets when released
        - depositor_recipient: Both deposits and can receive (typical for trades)
        - arbiter: Can resolve disputes, does not deposit or receive
        - observer: Can view status but cannot act
      enum:
      - depositor
      - recipient
      - depositor_recipient
      - arbiter
      - observer

    EscrowConsentType:
      type: string
      description: |
        Type of consent being given.
        - release: Agrees to release assets to recipients
        - refund: Agrees to refund assets to depositors
        - dispute: Raises a dispute
        - reaffirm: Re-affirms after validation failure
      enum:
      - release
      - refund
      - dispute
      - reaffirm

    EscrowResolution:
      type: string
      description: |
        How the escrow was resolved.
        - released: Assets went to designated recipients
        - refunded: Assets returned to depositors
        - split: Arbiter split assets between parties
        - expired_refunded: Timed out, auto-refunded
        - cancelled_refunded: Cancelled, deposits refunded
        - violation_refunded: Validation failure caused refund
      enum:
      - released
      - refunded
      - split
      - expired_refunded
      - cancelled_refunded
      - violation_refunded

    AssetType:
      type: string
      description: |
        Type of asset held in escrow.
        - currency: Currency amount held in escrow wallet
        - item: Item instance held in escrow container
        - item_stack: Stackable items (quantity) held in escrow container
        - contract: Contract instance locked under escrow guardianship
        - custom: Custom asset type via registered handler
      enum:
      - currency
      - item
      - item_stack
      - contract
      - custom

    ValidationFailureType:
      type: string
      description: |
        Type of validation failure detected.
        - asset_missing: Asset no longer exists in escrow custody
        - asset_mutated: Asset properties changed (e.g., item durability)
        - asset_expired: Asset has a time-based expiration that triggered
        - balance_mismatch: Wallet balance does not match expected held amount
      enum:
      - asset_missing
      - asset_mutated
      - asset_expired
      - balance_mismatch

    TokenAlgorithm:
      type: string
      description: |
        Algorithm used for token generation.
        - hmac_sha256: HMAC-SHA256 based tokens
        - random_bytes: Cryptographically random tokens
      enum:
      - hmac_sha256
      - random_bytes

    TokenType:
      type: string
      description: |
        Type of token being requested.
        - deposit: Token for depositing assets
        - release: Token for consenting to release
      enum:
      - deposit
      - release

    ReleaseMode:
      type: string
      description: |
        Controls how release confirmation is handled:
        - immediate: Finalizing → Released (skip Releasing state entirely).
          ⚠️ WARNING: Use only for trusted/low-value scenarios (NPC vendors, system rewards).
          Assets are marked as released BEFORE downstream services confirm transfers.
          If downstream services fail, manual intervention may be required.
        - service_only: Wait for downstream services (currency, inventory) to confirm transfers complete.
        - party_required: Wait for all parties to call /confirm-release.
        - service_and_party: Wait for both service completion AND party confirmation.
      enum:
      - immediate
      - service_only
      - party_required
      - service_and_party

    RefundMode:
      type: string
      description: |
        Controls how refund confirmation is handled. Same semantics as ReleaseMode.
        Refunds typically use 'immediate' since parties get their own assets back.
      enum:
      - immediate
      - service_only
      - party_required

    ConfirmationTimeoutBehavior:
      type: string
      description: |
        What happens when confirmation timeout expires:
        - auto_confirm: If service events received, auto-confirm parties (default).
        - dispute: Transition to Disputed state, require arbiter intervention.
        - refund: Treat as failed, transition to Refunding.
      enum:
      - auto_confirm
      - dispute
      - refund

    # ==========================================================================
    # Core Models
    # ==========================================================================

    EscrowAgreement:
      type: object
      description: Main escrow agreement record
      required:
      - id
      - escrowType
      - trustMode
      - parties
      - expectedDeposits
      - deposits
      - consents
      - status
      - requiredConsentsForRelease
      - createdAt
      - createdBy
      - createdByType
      - expiresAt
      properties:
        id:
          type: string
          format: uuid
          description: Unique escrow agreement identifier
        escrowType:
          $ref: '#/components/schemas/EscrowType'
          description: Type of escrow agreement
        trustMode:
          $ref: '#/components/schemas/EscrowTrustMode'
          description: Trust mode for the escrow
        trustedPartyId:
          type: string
          format: uuid
          nullable: true
          description: For single_party_trusted - which party has authority
        trustedPartyType:
          allOf:
          - $ref: '#/components/schemas/EntityType'
          nullable: true
          description: Type of the trusted party
        initiatorServiceId:
          type: string
          nullable: true
          description: For initiator_trusted - which service created this
        parties:
          type: array
          items:
            $ref: '#/components/schemas/EscrowParty'
          description: All parties involved in the escrow
        expectedDeposits:
          type: array
          items:
            $ref: '#/components/schemas/ExpectedDeposit'
          description: What deposits are expected from each party
        deposits:
          type: array
          items:
            $ref: '#/components/schemas/EscrowDeposit'
          description: Actual deposits received
        releaseAllocations:
          type: array
          nullable: true
          items:
            $ref: '#/components/schemas/ReleaseAllocation'
          description: How assets should be distributed on release
        boundContractId:
          type: string
          format: uuid
          nullable: true
          description: Contract governing conditions for this escrow
        consents:
          type: array
          items:
            $ref: '#/components/schemas/EscrowConsent'
          description: Consent decisions from parties
        status:
          $ref: '#/components/schemas/EscrowStatus'
          description: Current escrow status
        requiredConsentsForRelease:
          type: integer
          description: How many parties must consent for release (-1 = all required)
        lastValidatedAt:
          type: string
          format: date-time
          nullable: true
          description: When the escrow was last validated
        validationFailures:
          type: array
          nullable: true
          items:
            $ref: '#/components/schemas/ValidationFailure'
          description: Any validation failures detected
        createdAt:
          type: string
          format: date-time
          description: When the escrow was created
        createdBy:
          type: string
          format: uuid
          description: Who created the escrow
        createdByType:
          $ref: '#/components/schemas/EntityType'
          description: Type of the creator entity
        fundedAt:
          type: string
          format: date-time
          nullable: true
          description: When all expected deposits were received
        expiresAt:
          type: string
          format: date-time
          description: Auto-refund if not completed by this time
        completedAt:
          type: string
          format: date-time
          nullable: true
          description: When the escrow reached terminal state
        referenceType:
          type: string
          nullable: true
          description: What this escrow is for (e.g., trade, auction, contract)
        referenceId:
          type: string
          format: uuid
          nullable: true
          description: ID of the referenced entity
        description:
          type: string
          nullable: true
          description: Human-readable description
        metadata:
          type: object
          nullable: true
          additionalProperties: true
          description: >-
            Client-provided application-specific metadata.
            No Bannou plugin reads specific keys from this field by convention.
        resolution:
          $ref: '#/components/schemas/EscrowResolution'
          description: How the escrow was resolved
          nullable: true
        resolutionNotes:
          type: string
          nullable: true
          description: Notes about the resolution
        releaseMode:
          $ref: '#/components/schemas/ReleaseMode'
          description: How release confirmation is handled for this escrow.
        refundMode:
          $ref: '#/components/schemas/RefundMode'
          description: How refund confirmation is handled for this escrow.
        confirmationDeadline:
          type: string
          format: date-time
          nullable: true
          description: Deadline for party confirmations when in Releasing/Refunding state.

    EscrowParty:
      type: object
      description: A party in the escrow agreement
      required:
      - partyId
      - partyType
      - role
      - consentRequired
      - depositTokenUsed
      - releaseTokenUsed
      properties:
        partyId:
          type: string
          format: uuid
          description: Party entity identifier
        partyType:
          description: Type of entity (Account, Character, etc.)
          $ref: '#/components/schemas/EntityType'
        displayName:
          type: string
          nullable: true
          description: Display name for UI/logging
        role:
          $ref: '#/components/schemas/EscrowPartyRole'
          description: Role of this party in the escrow
        consentRequired:
          type: boolean
          description: Whether this party consent is required for release
        walletId:
          type: string
          format: uuid
          nullable: true
          description: Party own wallet (where currency comes from/returns to)
        containerId:
          type: string
          format: uuid
          nullable: true
          description: Party own container (where items come from/return to)
        escrowWalletId:
          type: string
          format: uuid
          nullable: true
          description: Escrow wallet for THIS party deposits (owned by escrow)
        escrowContainerId:
          type: string
          format: uuid
          nullable: true
          description: Escrow container for THIS party deposits (owned by escrow)
        depositToken:
          type: string
          nullable: true
          description: Token for depositing (full_consent mode)
        depositTokenUsed:
          type: boolean
          description: Whether the deposit token has been used
        depositTokenUsedAt:
          type: string
          format: date-time
          nullable: true
          description: When the deposit token was used
        releaseToken:
          type: string
          nullable: true
          description: Token for consenting to release
        releaseTokenUsed:
          type: boolean
          description: Whether the release token has been used
        releaseTokenUsedAt:
          type: string
          format: date-time
          nullable: true
          description: When the release token was used

    EscrowAsset:
      type: object
      description: An asset held in escrow
      required:
      - assetType
      - sourceOwnerId
      - sourceOwnerType
      properties:
        assetType:
          $ref: '#/components/schemas/AssetType'
          description: Type of asset held in escrow
        # Currency fields
        currencyDefinitionId:
          type: string
          format: uuid
          nullable: true
          description: For assetType=currency - currency definition ID
        currencyCode:
          type: string
          nullable: true
          description: Denormalized currency code for display
        currencyAmount:
          type: number
          nullable: true
          description: Amount of currency
        # Item fields
        itemInstanceId:
          type: string
          format: uuid
          nullable: true
          description: For assetType=item - unique item instance ID
        itemName:
          type: string
          nullable: true
          description: Denormalized item name for display
        itemTemplateId:
          type: string
          format: uuid
          nullable: true
          description: For assetType=item_stack - stackable item template
        itemTemplateName:
          type: string
          nullable: true
          description: Denormalized template name for display
        itemQuantity:
          type: integer
          nullable: true
          description: For assetType=item_stack - quantity
        # Contract fields
        contractInstanceId:
          type: string
          format: uuid
          nullable: true
          description: For assetType=contract - contract instance ID
        contractTemplateCode:
          type: string
          nullable: true
          description: Denormalized contract template code
        contractDescription:
          type: string
          nullable: true
          description: Description of the contract
        contractPartyRole:
          type: string
          nullable: true
          description: Which party role in the contract is being escrowed
        # Custom fields
        customAssetType:
          type: string
          nullable: true
          description: For assetType=custom - registered handler type
        customAssetId:
          type: string
          nullable: true
          description: Custom asset identifier
        customAssetData:
          type: object
          nullable: true
          additionalProperties: true
          description: >-
            Custom asset handler-specific data.
            No Bannou plugin reads specific keys from this field by convention.
        # Source tracking
        sourceOwnerId:
          type: string
          format: uuid
          description: Where this asset came from (for refunds)
        sourceOwnerType:
          $ref: '#/components/schemas/EntityType'
          description: Type of the source owner
        sourceContainerId:
          type: string
          format: uuid
          nullable: true
          description: Source wallet/container ID

    EscrowAssetBundle:
      type: object
      description: Groups multiple assets for a single deposit or release
      required:
      - bundleId
      - assets
      properties:
        bundleId:
          type: string
          format: uuid
          description: Bundle identifier
        assets:
          type: array
          items:
            $ref: '#/components/schemas/EscrowAsset'
          description: Assets in this bundle
        description:
          type: string
          nullable: true
          description: Summary for display
        estimatedValue:
          type: number
          nullable: true
          description: Optional valuation for UI display

    ExpectedDeposit:
      type: object
      description: Defines what a party should deposit
      required:
      - partyId
      - partyType
      - expectedAssets
      - optional
      - fulfilled
      properties:
        partyId:
          type: string
          format: uuid
          description: Party who should deposit
        partyType:
          description: Type of depositing party
          $ref: '#/components/schemas/EntityType'
        expectedAssets:
          type: array
          items:
            $ref: '#/components/schemas/EscrowAsset'
          description: Expected assets from this party
        optional:
          type: boolean
          description: Is this deposit optional
        depositDeadline:
          type: string
          format: date-time
          nullable: true
          description: Deadline for this specific deposit
        fulfilled:
          type: boolean
          description: Has this party fulfilled their deposit requirement

    EscrowDeposit:
      type: object
      description: Records an actual deposit
      required:
      - id
      - escrowId
      - partyId
      - partyType
      - assets
      - depositedAt
      - idempotencyKey
      properties:
        id:
          type: string
          format: uuid
          description: Deposit record identifier
        escrowId:
          type: string
          format: uuid
          description: Escrow this deposit belongs to
        partyId:
          type: string
          format: uuid
          description: Party who deposited
        partyType:
          description: Type of entity (Account, Character, etc.)
          $ref: '#/components/schemas/EntityType'
        assets:
          $ref: '#/components/schemas/EscrowAssetBundle'
          description: Assets deposited
        depositedAt:
          type: string
          format: date-time
          description: When the deposit was made
        depositTokenUsed:
          type: string
          nullable: true
          description: Token used (for audit)
        idempotencyKey:
          type: string
          description: Idempotency key for this deposit

    ReleaseAllocation:
      type: object
      description: Defines who gets what on release
      required:
      - recipientPartyId
      - recipientPartyType
      - assets
      properties:
        recipientPartyId:
          type: string
          format: uuid
          description: Party receiving assets
        recipientPartyType:
          $ref: '#/components/schemas/EntityType'
          description: Type of the recipient party
        assets:
          type: array
          items:
            $ref: '#/components/schemas/EscrowAsset'
          description: Assets this recipient should receive
        destinationWalletId:
          type: string
          format: uuid
          nullable: true
          description: Where to deliver currency
        destinationContainerId:
          type: string
          format: uuid
          nullable: true
          description: Where to deliver items

    EscrowConsent:
      type: object
      description: Records a party consent decision
      required:
      - partyId
      - partyType
      - consentType
      - consentedAt
      properties:
        partyId:
          type: string
          format: uuid
          description: Party giving consent
        partyType:
          description: Type of entity (Account, Character, etc.)
          $ref: '#/components/schemas/EntityType'
        consentType:
          $ref: '#/components/schemas/EscrowConsentType'
          description: Type of consent given
        consentedAt:
          type: string
          format: date-time
          description: When consent was given
        releaseTokenUsed:
          type: string
          nullable: true
          description: Token used (for audit)
        notes:
          type: string
          nullable: true
          description: Optional notes

    ValidationFailure:
      type: object
      description: Records a validation check failure
      required:
      - detectedAt
      - assetType
      - assetDescription
      - failureType
      - affectedPartyId
      - affectedPartyType
      properties:
        detectedAt:
          type: string
          format: date-time
          description: When the failure was detected
        assetType:
          $ref: '#/components/schemas/AssetType'
          description: Type of asset affected
        assetDescription:
          type: string
          description: Description of the affected asset
        failureType:
          $ref: '#/components/schemas/ValidationFailureType'
          description: Type of validation failure
        affectedPartyId:
          type: string
          format: uuid
          description: Which party deposit is affected
        affectedPartyType:
          $ref: '#/components/schemas/EntityType'
          description: Type of the affected party
        details:
          type: object
          nullable: true
          additionalProperties: true
          description: >-
            Validation failure diagnostic details.
            No Bannou plugin reads specific keys from this field by convention.

    AssetHandlerInfo:
      type: object
      description: Information about a registered asset handler
      required:
      - assetType
      - pluginId
      - builtIn
      - depositEndpoint
      - releaseEndpoint
      - refundEndpoint
      - validateEndpoint
      properties:
        assetType:
          type: string
          description: Unique asset type identifier
        pluginId:
          type: string
          description: Plugin that implements this handler
        builtIn:
          type: boolean
          description: Whether this is a built-in handler
        depositEndpoint:
          type: string
          description: Endpoint for depositing
        releaseEndpoint:
          type: string
          description: Endpoint for releasing
        refundEndpoint:
          type: string
          description: Endpoint for refunding
        validateEndpoint:
          type: string
          description: Endpoint for validation

    # ==========================================================================
    # Request/Response Models - Lifecycle
    # ==========================================================================

    CreateEscrowRequest:
      type: object
      description: Request to create a new escrow agreement
      required:
      - escrowType
      - trustMode
      - parties
      - expectedDeposits
      - idempotencyKey
      properties:
        escrowType:
          $ref: '#/components/schemas/EscrowType'
          description: Type of escrow agreement
        trustMode:
          $ref: '#/components/schemas/EscrowTrustMode'
          description: Trust mode for the escrow
        trustedPartyId:
          type: string
          format: uuid
          nullable: true
          description: For single_party_trusted mode
        trustedPartyType:
          allOf:
          - $ref: '#/components/schemas/EntityType'
          nullable: true
          description: Type of the trusted party
        parties:
          type: array
          items:
            $ref: '#/components/schemas/CreateEscrowPartyInput'
          description: Parties in the escrow
        expectedDeposits:
          type: array
          items:
            $ref: '#/components/schemas/ExpectedDepositInput'
          description: Expected deposits from parties
        releaseAllocations:
          type: array
          nullable: true
          items:
            $ref: '#/components/schemas/ReleaseAllocationInput'
          description: Optional explicit release allocations
        boundContractId:
          type: string
          format: uuid
          nullable: true
          description: Contract governing this escrow
        requiredConsentsForRelease:
          type: integer
          nullable: true
          description: Number of consents required (-1 for all)
        expiresAt:
          type: string
          format: date-time
          nullable: true
          description: Optional expiration time
        referenceType:
          type: string
          nullable: true
          description: Reference type (trade, auction, etc.)
        referenceId:
          type: string
          format: uuid
          nullable: true
          description: Reference entity ID
        description:
          type: string
          nullable: true
          description: Human-readable description
        metadata:
          type: object
          nullable: true
          additionalProperties: true
          description: >-
            Client-provided application-specific metadata.
            No Bannou plugin reads specific keys from this field by convention.
        releaseMode:
          allOf:
          - $ref: '#/components/schemas/ReleaseMode'
          nullable: true
          description: |
            How release confirmation is handled. Defaults to service_only if not specified.
            Only applies to unbound escrows; contract-bound escrows follow contract fulfillment.
        refundMode:
          allOf:
          - $ref: '#/components/schemas/RefundMode'
          nullable: true
          description: How refund confirmation is handled. Defaults to immediate if not specified.
        idempotencyKey:
          type: string
          description: Idempotency key for this operation

    CreateEscrowPartyInput:
      type: object
      description: Input for defining a party in escrow creation
      required:
      - partyId
      - partyType
      - role
      properties:
        partyId:
          type: string
          format: uuid
          description: Party entity ID
        partyType:
          description: Type of entity (Account, Character, etc.)
          $ref: '#/components/schemas/EntityType'
        displayName:
          type: string
          nullable: true
          description: Display name
        role:
          $ref: '#/components/schemas/EscrowPartyRole'
          description: Role of this party in the escrow
        consentRequired:
          type: boolean
          nullable: true
          description: Whether consent is required (defaults based on role)
        walletId:
          type: string
          format: uuid
          nullable: true
          description: Party wallet for currency operations
        containerId:
          type: string
          format: uuid
          nullable: true
          description: Party container for item operations

    ExpectedDepositInput:
      type: object
      description: Input for defining expected deposits from a party
      required:
      - partyId
      - partyType
      - expectedAssets
      properties:
        partyId:
          type: string
          format: uuid
          description: Party who should deposit
        partyType:
          description: Type of depositing party
          $ref: '#/components/schemas/EntityType'
        expectedAssets:
          type: array
          items:
            $ref: '#/components/schemas/EscrowAssetInput'
          description: Expected assets
        optional:
          type: boolean
          nullable: true
          description: Is this deposit optional
        depositDeadline:
          type: string
          format: date-time
          nullable: true
          description: Specific deadline for this deposit

    EscrowAssetInput:
      type: object
      description: Input for specifying an asset in escrow operations
      required:
      - assetType
      properties:
        assetType:
          $ref: '#/components/schemas/AssetType'
          description: Type of asset to deposit
        currencyDefinitionId:
          type: string
          format: uuid
          nullable: true
          description: Currency definition ID
        currencyCode:
          type: string
          nullable: true
          description: Currency code
        currencyAmount:
          type: number
          nullable: true
          description: Currency amount
        itemInstanceId:
          type: string
          format: uuid
          nullable: true
          description: Item instance ID
        itemName:
          type: string
          nullable: true
          description: Item name
        itemTemplateId:
          type: string
          format: uuid
          nullable: true
          description: Item template ID (for stacks)
        itemTemplateName:
          type: string
          nullable: true
          description: Item template name
        itemQuantity:
          type: integer
          nullable: true
          description: Item quantity (for stacks)
        contractInstanceId:
          type: string
          format: uuid
          nullable: true
          description: Contract instance ID
        contractTemplateCode:
          type: string
          nullable: true
          description: Contract template code
        contractDescription:
          type: string
          nullable: true
          description: Contract description
        contractPartyRole:
          type: string
          nullable: true
          description: Contract party role being escrowed
        customAssetType:
          type: string
          nullable: true
          description: Custom asset type
        customAssetId:
          type: string
          nullable: true
          description: Custom asset ID
        customAssetData:
          type: object
          nullable: true
          additionalProperties: true
          description: >-
            Custom asset handler-specific data.
            No Bannou plugin reads specific keys from this field by convention.

    ReleaseAllocationInput:
      type: object
      description: Input for specifying how assets should be allocated on release
      required:
      - recipientPartyId
      - recipientPartyType
      - assets
      properties:
        recipientPartyId:
          type: string
          format: uuid
          description: Recipient party ID
        recipientPartyType:
          $ref: '#/components/schemas/EntityType'
          description: Recipient party type
        assets:
          type: array
          items:
            $ref: '#/components/schemas/EscrowAssetInput'
          description: Assets to allocate
        destinationWalletId:
          type: string
          format: uuid
          nullable: true
          description: Destination wallet
        destinationContainerId:
          type: string
          format: uuid
          nullable: true
          description: Destination container

    CreateEscrowResponse:
      type: object
      description: Response from creating an escrow agreement
      required:
      - escrow
      - depositTokens
      properties:
        escrow:
          $ref: '#/components/schemas/EscrowAgreement'
          description: Created escrow agreement
        depositTokens:
          type: array
          items:
            $ref: '#/components/schemas/PartyToken'
          description: Deposit tokens for each party (full_consent mode)

    PartyToken:
      type: object
      description: Token issued to a party for deposit or release operations
      required:
      - partyId
      - partyType
      - token
      properties:
        partyId:
          type: string
          format: uuid
          description: Party ID
        partyType:
          description: Type of entity (Account, Character, etc.)
          $ref: '#/components/schemas/EntityType'
        token:
          type: string
          description: The token

    GetEscrowRequest:
      type: object
      description: Request to retrieve an escrow agreement by ID
      required:
      - escrowId
      properties:
        escrowId:
          type: string
          format: uuid
          description: Escrow ID to retrieve

    GetEscrowResponse:
      type: object
      description: Response containing escrow agreement details
      required:
      - escrow
      properties:
        escrow:
          $ref: '#/components/schemas/EscrowAgreement'
          description: Escrow agreement details

    ListEscrowsRequest:
      type: object
      description: Request to list escrow agreements with optional filters
      properties:
        partyId:
          type: string
          format: uuid
          nullable: true
          description: Filter by party
        partyType:
          allOf:
          - $ref: '#/components/schemas/EntityType'
          nullable: true
          description: Party type filter
        status:
          type: array
          nullable: true
          items:
            $ref: '#/components/schemas/EscrowStatus'
          description: Filter by status
        referenceType:
          type: string
          nullable: true
          description: Filter by reference type
        referenceId:
          type: string
          format: uuid
          nullable: true
          description: Filter by reference ID
        fromDate:
          type: string
          format: date-time
          nullable: true
          description: Filter from date
        toDate:
          type: string
          format: date-time
          nullable: true
          description: Filter to date
        limit:
          type: integer
          nullable: true
          description: Limit results
        offset:
          type: integer
          nullable: true
          description: Offset for pagination

    ListEscrowsResponse:
      type: object
      description: Response containing list of escrow agreements
      required:
      - escrows
      - totalCount
      properties:
        escrows:
          type: array
          description: List of escrow agreements matching the query
          items:
            $ref: '#/components/schemas/EscrowAgreement'
        totalCount:
          type: integer
          description: Total count for pagination

    GetMyTokenRequest:
      type: object
      description: Request to retrieve a party token for deposit or release
      required:
      - escrowId
      - ownerId
      - ownerType
      - tokenType
      properties:
        escrowId:
          type: string
          format: uuid
          description: Escrow ID
        ownerId:
          type: string
          format: uuid
          description: Party ID
        ownerType:
          $ref: '#/components/schemas/EntityType'
          description: Party type
        tokenType:
          $ref: '#/components/schemas/TokenType'
          description: Type of token to retrieve

    GetMyTokenResponse:
      type: object
      description: Response containing party token information
      required:
      - tokenUsed
      properties:
        token:
          type: string
          nullable: true
          description: The requested token (if available)
        tokenUsed:
          type: boolean
          description: Whether the token has been used
        tokenUsedAt:
          type: string
          format: date-time
          nullable: true
          description: When the token was used

    # ==========================================================================
    # Request/Response Models - Deposits
    # ==========================================================================

    DepositRequest:
      type: object
      description: Request to deposit assets into an escrow
      required:
      - escrowId
      - partyId
      - partyType
      - assets
      - idempotencyKey
      properties:
        escrowId:
          type: string
          format: uuid
          description: Escrow ID
        partyId:
          type: string
          format: uuid
          description: Party depositing
        partyType:
          description: Type of entity (Account, Character, etc.)
          $ref: '#/components/schemas/EntityType'
        assets:
          $ref: '#/components/schemas/EscrowAssetBundleInput'
          description: Assets to deposit
        depositToken:
          type: string
          nullable: true
          description: Deposit token (required for full_consent)
        idempotencyKey:
          type: string
          description: Idempotency key

    EscrowAssetBundleInput:
      type: object
      description: Input for specifying a bundle of assets
      required:
      - assets
      properties:
        assets:
          type: array
          items:
            $ref: '#/components/schemas/EscrowAssetInput'
          description: Assets to deposit
        description:
          type: string
          nullable: true
          description: Bundle description
        estimatedValue:
          type: number
          nullable: true
          description: Estimated value

    DepositResponse:
      type: object
      description: Response from depositing assets into an escrow
      required:
      - escrow
      - deposit
      - fullyFunded
      - releaseTokens
      properties:
        escrow:
          $ref: '#/components/schemas/EscrowAgreement'
          description: Updated escrow agreement
        deposit:
          $ref: '#/components/schemas/EscrowDeposit'
          description: Deposit record
        fullyFunded:
          type: boolean
          description: Whether escrow is now fully funded
        releaseTokens:
          type: array
          items:
            $ref: '#/components/schemas/PartyToken'
          description: Release tokens (issued when fully funded)

    ValidateDepositRequest:
      type: object
      description: Request to validate a deposit without executing
      required:
      - escrowId
      - partyId
      - partyType
      - assets
      properties:
        escrowId:
          type: string
          format: uuid
          description: Escrow ID
        partyId:
          type: string
          format: uuid
          description: Party to validate
        partyType:
          description: Type of entity (Account, Character, etc.)
          $ref: '#/components/schemas/EntityType'
        assets:
          $ref: '#/components/schemas/EscrowAssetBundleInput'
          description: Assets to validate

    ValidateDepositResponse:
      type: object
      description: Response from deposit validation
      required:
      - valid
      - errors
      - warnings
      properties:
        valid:
          type: boolean
          description: Whether the deposit would be valid
        errors:
          type: array
          items:
            type: string
          description: Validation errors
        warnings:
          type: array
          items:
            type: string
          description: Validation warnings

    GetDepositStatusRequest:
      type: object
      description: Request to get deposit status for a party
      required:
      - escrowId
      - partyId
      - partyType
      properties:
        escrowId:
          type: string
          format: uuid
          description: Escrow ID
        partyId:
          type: string
          format: uuid
          description: Party ID
        partyType:
          description: Type of entity (Account, Character, etc.)
          $ref: '#/components/schemas/EntityType'

    GetDepositStatusResponse:
      type: object
      description: Response containing party deposit status
      required:
      - expectedAssets
      - depositedAssets
      - fulfilled
      properties:
        expectedAssets:
          type: array
          items:
            $ref: '#/components/schemas/EscrowAsset'
          description: Expected assets from this party
        depositedAssets:
          type: array
          items:
            $ref: '#/components/schemas/EscrowAsset'
          description: Actually deposited assets
        fulfilled:
          type: boolean
          description: Whether deposit requirement is fulfilled
        depositToken:
          type: string
          nullable: true
          description: Deposit token (if not yet used)
        depositDeadline:
          type: string
          format: date-time
          nullable: true
          description: Deposit deadline

    # ==========================================================================
    # Request/Response Models - Consent
    # ==========================================================================

    ConsentRequest:
      type: object
      description: Request to record party consent for release or refund
      required:
      - escrowId
      - partyId
      - partyType
      - consentType
      - idempotencyKey
      properties:
        escrowId:
          type: string
          format: uuid
          description: Escrow ID
        partyId:
          type: string
          format: uuid
          description: Party giving consent
        partyType:
          description: Type of entity (Account, Character, etc.)
          $ref: '#/components/schemas/EntityType'
        consentType:
          $ref: '#/components/schemas/EscrowConsentType'
          description: Type of consent being given
        releaseToken:
          type: string
          nullable: true
          description: Release token (required for full_consent)
        notes:
          type: string
          nullable: true
          description: Optional notes
        idempotencyKey:
          type: string
          description: Idempotency key

    ConsentResponse:
      type: object
      description: Response from recording party consent
      required:
      - escrow
      - consentRecorded
      - triggered
      - newStatus
      properties:
        escrow:
          $ref: '#/components/schemas/EscrowAgreement'
          description: Updated escrow agreement
        consentRecorded:
          type: boolean
          description: Whether consent was recorded
        triggered:
          type: boolean
          description: Whether this consent triggered completion
        newStatus:
          $ref: '#/components/schemas/EscrowStatus'
          description: New escrow status after consent

    GetConsentStatusRequest:
      type: object
      description: Request to get consent status for all parties
      required:
      - escrowId
      properties:
        escrowId:
          type: string
          format: uuid
          description: Escrow ID

    GetConsentStatusResponse:
      type: object
      description: Response containing consent status for all parties
      required:
      - partiesRequiringConsent
      - consentsReceived
      - consentsRequired
      - canRelease
      - canRefund
      properties:
        partiesRequiringConsent:
          type: array
          items:
            $ref: '#/components/schemas/PartyConsentStatus'
          description: Consent status per party
        consentsReceived:
          type: integer
          description: Number of consents received
        consentsRequired:
          type: integer
          description: Number of consents required
        canRelease:
          type: boolean
          description: Whether release can proceed
        canRefund:
          type: boolean
          description: Whether refund can proceed

    PartyConsentStatus:
      type: object
      description: Consent status for a single party
      required:
      - partyId
      - partyType
      - consentGiven
      properties:
        partyId:
          type: string
          format: uuid
          description: Party ID
        partyType:
          description: Type of entity (Account, Character, etc.)
          $ref: '#/components/schemas/EntityType'
        displayName:
          type: string
          nullable: true
          description: Party display name
        consentGiven:
          type: boolean
          description: Whether consent was given
        consentType:
          $ref: '#/components/schemas/EscrowConsentType'
          description: Type of consent given (if any)
          nullable: true
        consentedAt:
          type: string
          format: date-time
          nullable: true
          description: When consent was given

    # ==========================================================================
    # Request/Response Models - Completion
    # ==========================================================================

    ReleaseRequest:
      type: object
      description: Request to trigger escrow release to recipients
      required:
      - escrowId
      - idempotencyKey
      properties:
        escrowId:
          type: string
          format: uuid
          description: Escrow ID
        initiatorServiceId:
          type: string
          nullable: true
          description: For initiator_trusted mode
        notes:
          type: string
          nullable: true
          description: Optional notes
        idempotencyKey:
          type: string
          description: Idempotency key

    ReleaseResponse:
      type: object
      description: Response from releasing escrow assets to recipients
      required:
      - escrow
      - finalizerResults
      - releases
      properties:
        escrow:
          $ref: '#/components/schemas/EscrowAgreement'
          description: Released escrow agreement
        finalizerResults:
          type: array
          items:
            $ref: '#/components/schemas/FinalizerResult'
          description: Results of contract finalizer APIs
        releases:
          type: array
          items:
            $ref: '#/components/schemas/ReleaseResult'
          description: Release results per recipient

    FinalizerResult:
      type: object
      description: Result from a contract finalizer API call
      required:
      - endpoint
      - success
      properties:
        endpoint:
          type: string
          description: Finalizer endpoint
        success:
          type: boolean
          description: Whether it succeeded
        error:
          type: string
          nullable: true
          description: Error message if failed

    ReleaseResult:
      type: object
      description: Result of releasing assets to a single recipient
      required:
      - recipientPartyId
      - success
      properties:
        recipientPartyId:
          type: string
          format: uuid
          description: Recipient party ID
        assets:
          $ref: '#/components/schemas/EscrowAssetBundle'
          description: Assets released (null if failed)
          nullable: true
        success:
          type: boolean
          description: Whether release succeeded
        error:
          type: string
          nullable: true
          description: Error message if failed

    RefundRequest:
      type: object
      description: Request to trigger escrow refund to depositors
      required:
      - escrowId
      - idempotencyKey
      properties:
        escrowId:
          type: string
          format: uuid
          description: Escrow ID
        initiatorServiceId:
          type: string
          nullable: true
          description: For initiator_trusted mode
        reason:
          type: string
          nullable: true
          description: Reason for refund
        idempotencyKey:
          type: string
          description: Idempotency key

    RefundResponse:
      type: object
      description: Response from refunding escrow assets to depositors
      required:
      - escrow
      - refunds
      properties:
        escrow:
          $ref: '#/components/schemas/EscrowAgreement'
          description: Refunded escrow agreement
        refunds:
          type: array
          items:
            $ref: '#/components/schemas/RefundResult'
          description: Refund results per depositor

    RefundResult:
      type: object
      description: Result of refunding assets to a single depositor
      required:
      - depositorPartyId
      - success
      properties:
        depositorPartyId:
          type: string
          format: uuid
          description: Depositor party ID
        assets:
          $ref: '#/components/schemas/EscrowAssetBundle'
          description: Assets refunded (null if failed)
          nullable: true
        success:
          type: boolean
          description: Whether refund succeeded
        error:
          type: string
          nullable: true
          description: Error message if failed

    CancelRequest:
      type: object
      description: Request to cancel escrow before fully funded
      required:
      - escrowId
      - idempotencyKey
      properties:
        escrowId:
          type: string
          format: uuid
          description: Escrow ID
        reason:
          type: string
          nullable: true
          description: Reason for cancellation
        idempotencyKey:
          type: string
          description: Idempotency key

    CancelResponse:
      type: object
      description: Response from cancelling an escrow
      required:
      - escrow
      - refunds
      properties:
        escrow:
          $ref: '#/components/schemas/EscrowAgreement'
          description: Cancelled escrow agreement
        refunds:
          type: array
          items:
            $ref: '#/components/schemas/RefundResult'
          description: Refund results for any deposits

    DisputeRequest:
      type: object
      description: Request to raise a dispute on a funded escrow
      required:
      - escrowId
      - partyId
      - partyType
      - reason
      - idempotencyKey
      properties:
        escrowId:
          type: string
          format: uuid
          description: Escrow ID
        partyId:
          type: string
          format: uuid
          description: Party raising dispute
        partyType:
          description: Type of entity (Account, Character, etc.)
          $ref: '#/components/schemas/EntityType'
        reason:
          type: string
          description: Reason for dispute
        releaseToken:
          type: string
          nullable: true
          description: Release token (proves party identity)
        idempotencyKey:
          type: string
          description: Idempotency key

    DisputeResponse:
      type: object
      description: Response from raising a dispute on an escrow
      required:
      - escrow
      properties:
        escrow:
          $ref: '#/components/schemas/EscrowAgreement'
          description: Disputed escrow agreement

    ConfirmReleaseRequest:
      type: object
      description: Request to confirm receipt of released assets
      additionalProperties: false
      required:
      - escrowId
      - partyId
      - releaseToken
      properties:
        escrowId:
          type: string
          format: uuid
          description: The escrow being confirmed.
        partyId:
          type: string
          format: uuid
          description: The party confirming receipt.
        releaseToken:
          type: string
          description: The party's release token (received via confirmation shortcut).
        notes:
          type: string
          nullable: true
          description: Optional confirmation notes.

    ConfirmReleaseResponse:
      type: object
      description: Response from confirming release receipt
      additionalProperties: false
      required:
      - escrowId
      - confirmed
      - allPartiesConfirmed
      properties:
        escrowId:
          type: string
          format: uuid
          description: The escrow ID.
        confirmed:
          type: boolean
          description: Whether this party's confirmation was recorded.
        allPartiesConfirmed:
          type: boolean
          description: Whether all parties have now confirmed (triggers Released transition).
        status:
          $ref: '#/components/schemas/EscrowStatus'
          description: Current escrow status after confirmation.
          nullable: true

    ConfirmRefundRequest:
      type: object
      description: Request to confirm receipt of refunded assets
      additionalProperties: false
      required:
      - escrowId
      - partyId
      properties:
        escrowId:
          type: string
          format: uuid
          description: The escrow being confirmed.
        partyId:
          type: string
          format: uuid
          description: The party confirming receipt of refund.
        notes:
          type: string
          nullable: true
          description: Optional confirmation notes.

    ConfirmRefundResponse:
      type: object
      description: Response from confirming refund receipt
      additionalProperties: false
      required:
      - escrowId
      - confirmed
      - allPartiesConfirmed
      properties:
        escrowId:
          type: string
          format: uuid
          description: The escrow ID.
        confirmed:
          type: boolean
          description: Whether this party's confirmation was recorded.
        allPartiesConfirmed:
          type: boolean
          description: Whether all parties have now confirmed (triggers Refunded transition).
        status:
          $ref: '#/components/schemas/EscrowStatus'
          description: Current escrow status after confirmation.
          nullable: true

    # ==========================================================================
    # Request/Response Models - Arbiter
    # ==========================================================================

    ResolveRequest:
      type: object
      description: Request for arbiter to resolve a disputed escrow
      required:
      - escrowId
      - arbiterId
      - arbiterType
      - resolution
      - idempotencyKey
      properties:
        escrowId:
          type: string
          format: uuid
          description: Escrow ID
        arbiterId:
          type: string
          format: uuid
          description: Arbiter ID
        arbiterType:
          $ref: '#/components/schemas/EntityType'
          description: Arbiter type
        resolution:
          $ref: '#/components/schemas/EscrowResolution'
          description: Resolution decision for the dispute
        splitAllocations:
          type: array
          nullable: true
          items:
            $ref: '#/components/schemas/SplitAllocation'
          description: For split resolution
        notes:
          type: string
          nullable: true
          description: Resolution notes
        idempotencyKey:
          type: string
          description: Idempotency key

    SplitAllocation:
      type: object
      description: Allocation of assets to a party in a split resolution
      required:
      - partyId
      - partyType
      - assets
      properties:
        partyId:
          type: string
          format: uuid
          description: Party ID
        partyType:
          description: Type of entity (Account, Character, etc.)
          $ref: '#/components/schemas/EntityType'
        assets:
          type: array
          items:
            $ref: '#/components/schemas/EscrowAssetInput'
          description: Assets allocated to this party

    ResolveResponse:
      type: object
      description: Response from arbiter resolving a disputed escrow
      required:
      - escrow
      - transfers
      properties:
        escrow:
          $ref: '#/components/schemas/EscrowAgreement'
          description: Resolved escrow agreement
        transfers:
          type: array
          items:
            $ref: '#/components/schemas/TransferResult'
          description: Transfer results

    TransferResult:
      type: object
      description: Result of transferring assets to a party during resolution
      required:
      - partyId
      - success
      properties:
        partyId:
          type: string
          format: uuid
          description: Party ID
        assets:
          $ref: '#/components/schemas/EscrowAssetBundle'
          description: Assets transferred (null if failed)
          nullable: true
        success:
          type: boolean
          description: Whether transfer succeeded
        error:
          type: string
          nullable: true
          description: Error message if failed

    # ==========================================================================
    # Request/Response Models - Condition
    # ==========================================================================

    VerifyConditionRequest:
      type: object
      description: Request to verify a condition for conditional escrow
      required:
      - escrowId
      - conditionMet
      - verifierId
      - verifierType
      - idempotencyKey
      properties:
        escrowId:
          type: string
          format: uuid
          description: Escrow ID
        conditionMet:
          type: boolean
          description: Whether the condition was met
        verifierId:
          type: string
          format: uuid
          description: Verifier entity ID
        verifierType:
          $ref: '#/components/schemas/EntityType'
          description: Verifier entity type
        verificationData:
          type: object
          nullable: true
          additionalProperties: true
          description: >-
            Caller-provided proof/evidence data for condition verification.
            No Bannou plugin reads specific keys from this field by convention.
        idempotencyKey:
          type: string
          description: Idempotency key

    VerifyConditionResponse:
      type: object
      description: Response from verifying a condition on an escrow
      required:
      - escrow
      - triggered
      properties:
        escrow:
          $ref: '#/components/schemas/EscrowAgreement'
          description: Updated escrow agreement
        triggered:
          type: boolean
          description: Whether this triggered release/refund

    # ==========================================================================
    # Request/Response Models - Validation
    # ==========================================================================

    ValidateEscrowRequest:
      type: object
      description: Request to manually validate escrow assets
      required:
      - escrowId
      properties:
        escrowId:
          type: string
          format: uuid
          description: Escrow ID

    ValidateEscrowResponse:
      type: object
      description: Response from validating escrow assets
      required:
      - valid
      - failures
      - escrow
      properties:
        valid:
          type: boolean
          description: Whether all assets are valid
        failures:
          type: array
          items:
            $ref: '#/components/schemas/ValidationFailure'
          description: Validation failures
        escrow:
          $ref: '#/components/schemas/EscrowAgreement'
          description: Escrow agreement with validation results

    ReaffirmRequest:
      type: object
      description: Request to re-affirm after validation failure
      required:
      - escrowId
      - partyId
      - partyType
      - idempotencyKey
      properties:
        escrowId:
          type: string
          format: uuid
          description: Escrow ID
        partyId:
          type: string
          format: uuid
          description: Party reaffirming
        partyType:
          description: Type of entity (Account, Character, etc.)
          $ref: '#/components/schemas/EntityType'
        releaseToken:
          type: string
          nullable: true
          description: Release token
        idempotencyKey:
          type: string
          description: Idempotency key

    ReaffirmResponse:
      type: object
      description: Response from party re-affirming after validation failure
      required:
      - escrow
      - allReaffirmed
      properties:
        escrow:
          $ref: '#/components/schemas/EscrowAgreement'
          description: Reaffirmed escrow agreement
        allReaffirmed:
          type: boolean
          description: Whether all parties have reaffirmed

    # ==========================================================================
    # Request/Response Models - Handlers
    # ==========================================================================

    RegisterHandlerRequest:
      type: object
      description: Request to register a custom asset type handler
      required:
      - assetType
      - pluginId
      - depositEndpoint
      - releaseEndpoint
      - refundEndpoint
      - validateEndpoint
      properties:
        assetType:
          type: string
          description: Unique asset type identifier
        pluginId:
          type: string
          description: Plugin implementing this handler
        depositEndpoint:
          type: string
          description: Deposit endpoint path
        releaseEndpoint:
          type: string
          description: Release endpoint path
        refundEndpoint:
          type: string
          description: Refund endpoint path
        validateEndpoint:
          type: string
          description: Validate endpoint path

    RegisterHandlerResponse:
      type: object
      description: Response from registering an asset handler
      required:
      - registered
      properties:
        registered:
          type: boolean
          description: Whether registration succeeded

    ListHandlersRequest:
      type: object
      description: Empty request to list handlers
      properties: {}

    ListHandlersResponse:
      type: object
      description: Response containing list of registered asset handlers
      required:
      - handlers
      properties:
        handlers:
          type: array
          items:
            $ref: '#/components/schemas/AssetHandlerInfo'
          description: Registered handlers

    DeregisterHandlerRequest:
      type: object
      description: Request to remove a custom asset handler registration
      required:
      - assetType
      properties:
        assetType:
          type: string
          description: Asset type to deregister

    DeregisterHandlerResponse:
      type: object
      description: Response from deregistering an asset handler
      required:
      - deregistered
      properties:
        deregistered:
          type: boolean
          description: Whether deregistration succeeded


    EntityType:
      type: string
      description: |
        Universal entity type identifier for first-class Bannou entities.
        Used for polymorphic entity references (ownerType, entityType, partyType).

        NOT for game-configurable content type codes (use opaque strings) or
        service-specific roles that include non-entity values (use service-specific enums).
        See IMPLEMENTATION TENETS polymorphic type field classification for guidance.
      enum:
      - system
      - account
      - character
      - actor
      - guild
      - organization
      - government
      - faction
      - location
      - realm
      - item
      - monster
      - relationship
      - session
      - deity
      - dungeon
      - custom
      - other

x-inlined-types:
- EntityType
