openapi: 3.0.0
info:
  title: Bannou Location Service API
  description: |
    Location management service for game worlds.

    **POST-Only API Pattern**: This API uses POST for all operations to support zero-copy
    WebSocket routing. Path parameters are passed in request bodies instead of URLs.
    See docs/BANNOU_DESIGN.md for architectural rationale.

    Locations represent physical places in the game world. Each location belongs to
    exactly one realm and can optionally have a parent location for hierarchical organization.

    **Three-Level Hierarchy**:
    - Realm (top-level persistent world - separate Realm service)
    - Region (parentLocationId=null, locations within a realm)
    - Location (parentLocationId=regionId, specific places within regions)

    **Realm-Scoped**: Every location has a realmId, enabling realm-specific location queries.

    **Hierarchy Support**: Locations can nest within other locations via parentLocationId,
    enabling Region -> City -> District -> Building -> Room organization patterns.

    **Location Types**: Flexible locationType field (e.g., "REGION", "CITY", "BUILDING", "ROOM")
    allows domain-specific categorization without rigid schema constraints.

    **Deprecation System**: Locations can be deprecated instead of deleted directly.
    Deprecated locations remain queryable but prevent new entity placement.

    **Two-Step Deletion**:
    1. Deprecate the location (soft delete, prevents new usage)
    2. Optionally hard-delete the deprecated location after all references are removed

    **SCHEMA MODIFICATION GATE**: STOP. Before modifying this schema, you MUST:
    1. Read docs/reference/SCHEMA-RULES.md
    2. State which section applies to your change
    3. Only then proceed with edits
    Edits without stating the applicable rule are FORBIDDEN.
  version: 1.0.0
x-service-layer: GameFoundation
servers:
- url: http://localhost:5012
  description: Bannou service endpoint (internal only)

# NOTE: x-lifecycle moved to location-events.yaml

paths:
  /location/get:
    post:
      summary: Get location by ID
      operationId: getLocation
      tags:
      - Location
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetLocationRequest'
      responses:
        '200':
          description: Location retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LocationResponse'
        '404':
          description: Location not found

  /location/get-by-code:
    post:
      summary: Get location by code and realm
      description: Retrieve a location using its unique code within a specific realm
      operationId: getLocationByCode
      tags:
      - Location
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetLocationByCodeRequest'
      responses:
        '200':
          description: Location retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LocationResponse'
        '404':
          description: Location not found

  /location/list:
    post:
      summary: List locations with filtering
      description: Retrieve locations with optional realm, parent, and type filtering
      operationId: listLocations
      tags:
      - Location
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ListLocationsRequest'
      responses:
        '200':
          description: Locations retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LocationListResponse'

  /location/list-by-realm:
    post:
      summary: List all locations in a realm (primary query pattern)
      description: |
        Returns all locations within a specific realm, optionally filtered by
        location type and parent. This is the primary access pattern for
        realm-scoped location queries.
      operationId: listLocationsByRealm
      tags:
      - Location
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ListLocationsByRealmRequest'
      responses:
        '200':
          description: Locations retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LocationListResponse'

  /location/list-by-parent:
    post:
      summary: Get child locations for a parent location
      description: |
        Retrieve all locations that have the specified location as their parent.
        Useful for getting all cities in a region, all buildings in a city, etc.
      operationId: listLocationsByParent
      tags:
      - Location
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ListLocationsByParentRequest'
      responses:
        '200':
          description: Child locations retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LocationListResponse'
        '404':
          description: Parent location not found

  /location/list-root:
    post:
      summary: Get root locations in a realm
      description: |
        Returns all top-level locations in a realm (locations with no parent).
        These are typically regions or major areas within the realm.
      operationId: listRootLocations
      tags:
      - Location
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ListRootLocationsRequest'
      responses:
        '200':
          description: Root locations retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LocationListResponse'

  /location/get-ancestors:
    post:
      summary: Get all ancestors of a location
      description: |
        Returns the full ancestry chain from the specified location up to the
        root location (parentLocationId=null). For example, for a specific building
        might return [district, city, region].
      operationId: getLocationAncestors
      tags:
      - Location
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetLocationAncestorsRequest'
      responses:
        '200':
          description: Ancestors retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LocationListResponse'
        '404':
          description: Location not found

  /location/validate-territory:
    post:
      operationId: validateTerritory
      tags:
      - Location
      summary: Validate location against territory boundaries
      description: |
        Checks if a proposed location falls within or outside specified territory boundaries.
        Used by Contract service's clause type handler system for territory validation.

        Territory modes:
        - exclusive: Location must NOT be within any territory location (or descendants)
        - inclusive: Location MUST be within at least one territory location (or descendants)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ValidateTerritoryRequest'
      responses:
        '200':
          description: Territory validation result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidateTerritoryResponse'
        '404':
          description: Location not found
      x-permissions:
      - role: user
        states: {}

  /location/get-descendants:
    post:
      summary: Get all descendants of a location
      description: |
        Returns all locations that are descendants of the specified location
        (direct children, grandchildren, etc.). Useful for finding all places
        within a region or city.
      operationId: getLocationDescendants
      tags:
      - Location
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetLocationDescendantsRequest'
      responses:
        '200':
          description: Descendants retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LocationListResponse'
        '404':
          description: Location not found

  /location/create:
    post:
      summary: Create new location
      operationId: createLocation
      tags:
      - Location Admin
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateLocationRequest'
      responses:
        '200':
          description: Location created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LocationResponse'
        '400':
          description: Invalid location data or parent realm mismatch
        '409':
          description: Location with this code already exists in this realm

  /location/update:
    post:
      summary: Update location
      operationId: updateLocation
      tags:
      - Location Admin
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateLocationRequest'
      responses:
        '200':
          description: Location updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LocationResponse'
        '404':
          description: Location not found
        '400':
          description: Invalid update data

  /location/set-parent:
    post:
      summary: Set or change the parent of a location
      description: |
        Update a location's parent, moving it in the hierarchy.
        Validates that:
        - New parent exists and is in the same realm
        - No circular reference would be created
        - Updates depth for location and all descendants
      operationId: setLocationParent
      tags:
      - Location Admin
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SetLocationParentRequest'
      responses:
        '200':
          description: Parent updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LocationResponse'
        '404':
          description: Location or parent not found
        '400':
          description: Invalid parent (different realm or circular reference)

  /location/remove-parent:
    post:
      summary: Remove parent from a location (make it a root location)
      description: |
        Remove the parent of a location, making it a top-level root location
        within its realm. Updates depth for location and all descendants.
      operationId: removeLocationParent
      tags:
      - Location Admin
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RemoveLocationParentRequest'
      responses:
        '200':
          description: Parent removed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LocationResponse'
        '404':
          description: Location not found

  /location/delete:
    post:
      summary: Delete location
      description: |
        Hard delete a location. This will fail if the location:
        - Has child locations (must delete or reparent children first)
        - Is still referenced by other entities
        For safe removal, first deprecate the location, remove all children,
        then delete.
      operationId: deleteLocation
      tags:
      - Location Admin
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeleteLocationRequest'
      responses:
        '200':
          description: Location deleted successfully
        '404':
          description: Location not found
        '409':
          description: Cannot delete - location has children or is in use

  /location/transfer-realm:
    post:
      summary: Transfer a location to a different realm
      description: |
        Moves a location from its current realm to a target realm.
        Updates all realm-scoped indexes (code-index, realm-index, parent/root indexes).
        The transferred location becomes a root location in the target realm (parent cleared).
        Returns Conflict if the target realm already has a location with the same code.
        Does NOT move children â€” caller is responsible for tree ordering.
      operationId: transferLocationToRealm
      tags:
      - Location Admin
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TransferLocationToRealmRequest'
      responses:
        '200':
          description: Location transferred successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LocationResponse'
        '404':
          description: Location or target realm not found
        '409':
          description: Target realm already has a location with the same code

  /location/deprecate:
    post:
      summary: Deprecate a location
      description: |
        Soft-delete a location by marking it as deprecated.
        Deprecated locations:
        - Remain queryable for historical data
        - Cannot be used for placing new entities
        - Can be hard-deleted after all references are removed
      operationId: deprecateLocation
      tags:
      - Location Admin
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeprecateLocationRequest'
      responses:
        '200':
          description: Location deprecated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LocationResponse'
        '404':
          description: Location not found
        '409':
          description: Location is already deprecated

  /location/undeprecate:
    post:
      summary: Restore a deprecated location
      description: |
        Remove the deprecated status from a location, making it
        available for entity placement again.
      operationId: undeprecateLocation
      tags:
      - Location Admin
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UndeprecateLocationRequest'
      responses:
        '200':
          description: Location restored successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LocationResponse'
        '404':
          description: Location not found
        '400':
          description: Location is not deprecated

  /location/exists:
    post:
      summary: Check if location exists and is active
      description: |
        Fast validation endpoint for other services to check location validity.
        Returns true if location exists and is not deprecated, false otherwise.
      operationId: locationExists
      tags:
      - Location
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LocationExistsRequest'
      responses:
        '200':
          description: Validation result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LocationExistsResponse'

  /location/query/by-position:
    post:
      summary: Find locations containing a spatial position
      description: |
        Given a Position3D and realmId, returns all locations whose bounds contain
        that position, ordered by depth descending (most specific first). Only
        locations with spatial bounds data are considered. A position is "in" a
        location if it falls within the location's axis-aligned bounding box.
      operationId: queryLocationsByPosition
      tags:
      - Location
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QueryLocationsByPositionRequest'
      responses:
        '200':
          description: Locations containing the position
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LocationListResponse'

  /location/seed:
    post:
      summary: Seed locations from configuration
      description: |
        Idempotent operation to seed locations from provided data.
        Creates locations that don't exist, optionally updates existing locations.
        Processes locations in dependency order (parents before children).
        Typically called at service startup with YAML-defined location hierarchies.
      operationId: seedLocations
      tags:
      - Location Admin
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SeedLocationsRequest'
      responses:
        '200':
          description: Seed operation completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SeedLocationsResponse'
        '400':
          description: Invalid seed data

  /location/report-entity-position:
    post:
      summary: Report entity presence at a location
      description: |
        Reports that an entity is present at a location. Creates or refreshes an ephemeral
        presence binding with configurable TTL. Reporters must call this periodically to
        keep the presence alive. Publishes arrival/departure events only when the entity's
        location actually changes (pure refreshes are silent).

        The optional previousLocationId provides a caller-hint optimization: if provided
        and matches the current stored location, only a TTL refresh occurs (no GET needed).
        If omitted, the service reads the current value to detect location changes.
      operationId: reportEntityPosition
      tags:
      - Location Presence
      x-permissions:
      - role: developer
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReportEntityPositionRequest'
      responses:
        '200':
          description: Position reported successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReportEntityPositionResponse'
        '404':
          description: Location not found

  /location/get-entity-location:
    post:
      summary: Get the current location of an entity
      description: |
        Queries where an entity currently is. Returns the entity's location if a
        non-expired presence binding exists.
      operationId: getEntityLocation
      tags:
      - Location Presence
      x-permissions:
      - role: developer
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetEntityLocationRequest'
      responses:
        '200':
          description: Entity location query result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetEntityLocationResponse'

  /location/list-entities-at-location:
    post:
      summary: List entities currently at a location
      description: |
        Queries which entities are currently present at a location. Supports optional
        entity type filtering and pagination. Results are hydrated from the entity
        presence store for reporting metadata.
      operationId: listEntitiesAtLocation
      tags:
      - Location Presence
      x-permissions:
      - role: developer
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ListEntitiesAtLocationRequest'
      responses:
        '200':
          description: Entity list for the location
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListEntitiesAtLocationResponse'

  /location/clear-entity-position:
    post:
      summary: Remove entity presence from its current location
      description: |
        Clears an entity's presence binding, removing it from its current location.
        Publishes a departure event if the entity was present at a location.
      operationId: clearEntityPosition
      tags:
      - Location Presence
      x-permissions:
      - role: developer
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ClearEntityPositionRequest'
      responses:
        '200':
          description: Entity position cleared
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClearEntityPositionResponse'

components:
  schemas:
    LocationType:
      type: string
      description: Type classification for locations
      enum:
      - CONTINENT
      - REGION
      - CITY
      - DISTRICT
      - BUILDING
      - ROOM
      - LANDMARK
      - WILDERNESS
      - DUNGEON
      - OTHER

    BoundsPrecision:
      type: string
      description: Precision level of spatial bounds for a location
      enum:
      - exact
      - approximate
      - none

    CoordinateMode:
      type: string
      description: How this location's coordinate system relates to its parent
      enum:
      - inherit
      - local
      - portal

    TerritoryMode:
      type: string
      description: Territory validation mode for constraint checking
      enum:
      - exclusive
      - inclusive

    ValidateTerritoryRequest:
      type: object
      description: Request to validate a location against territory boundaries
      additionalProperties: false
      required:
      - locationId
      - territoryLocationIds
      properties:
        locationId:
          type: string
          format: uuid
          description: The location to validate
        territoryLocationIds:
          type: array
          items:
            type: string
            format: uuid
          description: Territory boundary location IDs
        territoryMode:
          allOf:
          - $ref: '#/components/schemas/TerritoryMode'
          nullable: true
          description: Validation mode (exclusive or inclusive). Defaults to exclusive.

    ValidateTerritoryResponse:
      type: object
      description: Territory validation result
      additionalProperties: false
      required:
      - isValid
      properties:
        isValid:
          type: boolean
          description: True if location passes territory validation
        violationReason:
          type: string
          nullable: true
          description: Human-readable reason if validation failed
        matchedTerritoryId:
          type: string
          format: uuid
          nullable: true
          description: The territory location that matched (for inclusive) or conflicted (for exclusive)

    GetLocationRequest:
      description: Request to retrieve a location by its unique identifier
      type: object
      additionalProperties: false
      required:
      - locationId
      properties:
        locationId:
          type: string
          format: uuid
          description: Unique identifier of the location

    GetLocationByCodeRequest:
      description: Request to retrieve a location by its code within a specific realm
      type: object
      additionalProperties: false
      required:
      - code
      - realmId
      properties:
        code:
          type: string
          minLength: 1
          maxLength: 100
          pattern: '^[A-Z][A-Z0-9_]*$'
          description: Unique code for the location within the realm
        realmId:
          type: string
          format: uuid
          description: Realm ID to scope the code lookup

    ListLocationsRequest:
      description: Request to list locations within a realm with optional type and deprecation filtering
      type: object
      additionalProperties: false
      required:
      - realmId
      properties:
        realmId:
          type: string
          format: uuid
          description: Realm ID to query (required - locations are partitioned by realm)
        locationType:
          allOf:
          - $ref: '#/components/schemas/LocationType'
          nullable: true
          description: Filter by location type
        includeDeprecated:
          type: boolean
          default: false
          description: Whether to include deprecated locations in the response
        page:
          type: integer
          minimum: 1
          default: 1
          description: Page number for pagination (1-indexed)
        pageSize:
          type: integer
          minimum: 1
          maximum: 100
          default: 20
          description: Number of results per page

    ListLocationsByRealmRequest:
      description: Request to list all locations within a specific realm with optional filtering
      type: object
      additionalProperties: false
      required:
      - realmId
      properties:
        realmId:
          type: string
          format: uuid
          description: Realm ID to query
        locationType:
          allOf:
          - $ref: '#/components/schemas/LocationType'
          nullable: true
          description: Optional type filter
        includeDeprecated:
          type: boolean
          default: false
          description: Whether to include deprecated locations in the response
        page:
          type: integer
          minimum: 1
          default: 1
          description: Page number for pagination (1-indexed)
        pageSize:
          type: integer
          minimum: 1
          maximum: 100
          default: 20
          description: Number of results per page

    ListLocationsByParentRequest:
      description: Request to list all child locations of a specified parent location
      type: object
      additionalProperties: false
      required:
      - parentLocationId
      properties:
        parentLocationId:
          type: string
          format: uuid
          description: ID of the parent location
        locationType:
          allOf:
          - $ref: '#/components/schemas/LocationType'
          nullable: true
          description: Optional filter by location type
        includeDeprecated:
          type: boolean
          default: false
          description: Whether to include deprecated locations in the response
        page:
          type: integer
          minimum: 1
          default: 1
          description: Page number for pagination (1-indexed)
        pageSize:
          type: integer
          minimum: 1
          maximum: 100
          default: 20
          description: Number of results per page

    ListRootLocationsRequest:
      description: Request to list all top-level locations (without parents) in a realm
      type: object
      additionalProperties: false
      required:
      - realmId
      properties:
        realmId:
          type: string
          format: uuid
          description: Realm ID to get root locations for
        locationType:
          allOf:
          - $ref: '#/components/schemas/LocationType'
          nullable: true
          description: Optional filter by location type
        includeDeprecated:
          type: boolean
          default: false
          description: Whether to include deprecated locations in the response
        page:
          type: integer
          minimum: 1
          default: 1
          description: Page number for pagination (1-indexed)
        pageSize:
          type: integer
          minimum: 1
          maximum: 100
          default: 20
          description: Number of results per page

    GetLocationAncestorsRequest:
      description: Request to retrieve the full ancestry chain of a location up to the root
      type: object
      additionalProperties: false
      required:
      - locationId
      properties:
        locationId:
          type: string
          format: uuid
          description: The location to get ancestors for

    GetLocationDescendantsRequest:
      description: Request to retrieve all descendants of a location (children, grandchildren, etc.)
      type: object
      additionalProperties: false
      required:
      - locationId
      properties:
        locationId:
          type: string
          format: uuid
          description: The location to get descendants for
        locationType:
          allOf:
          - $ref: '#/components/schemas/LocationType'
          nullable: true
          description: Optional filter by location type
        maxDepth:
          type: integer
          minimum: 1
          maximum: 10
          nullable: true
          description: Maximum depth of descendants to return (null = all)
        includeDeprecated:
          type: boolean
          default: false
          description: Whether to include deprecated locations in the response
        page:
          type: integer
          minimum: 1
          default: 1
          description: Page number for pagination (1-indexed)
        pageSize:
          type: integer
          minimum: 1
          maximum: 100
          default: 20
          description: Number of results per page

    CreateLocationRequest:
      description: Request to create a new location within a realm
      type: object
      additionalProperties: false
      required:
      - code
      - name
      - realmId
      - locationType
      properties:
        code:
          type: string
          minLength: 1
          maxLength: 100
          pattern: '^[A-Z][A-Z0-9_]*$'
          description: Unique code for the location within the realm
        name:
          type: string
          minLength: 1
          maxLength: 200
          description: Display name for the location
        description:
          type: string
          maxLength: 2000
          nullable: true
          description: Description of the location
        realmId:
          type: string
          format: uuid
          description: Realm this location belongs to
        locationType:
          $ref: '#/components/schemas/LocationType'
          description: Type classification for this location
        parentLocationId:
          type: string
          format: uuid
          nullable: true
          description: Parent location ID for hierarchy (null for root locations)
        bounds:
          allOf:
          - $ref: '#/components/schemas/BoundingBox3D'
          nullable: true
          description: Optional spatial extent in world coordinates
        boundsPrecision:
          allOf:
          - $ref: '#/components/schemas/BoundsPrecision'
          nullable: true
          description: Precision level of spatial bounds (defaults to none)
        coordinateMode:
          allOf:
          - $ref: '#/components/schemas/CoordinateMode'
          nullable: true
          description: How this location's coordinate system relates to its parent (defaults to inherit)
        localOrigin:
          allOf:
          - $ref: '#/components/schemas/Position3D'
          nullable: true
          description: Origin point for local or inherited coordinate systems
        metadata:
          type: object
          additionalProperties: true
          nullable: true
          description: >-
            Client-provided location metadata.
            No Bannou plugin reads specific keys from this field by convention.

    UpdateLocationRequest:
      description: Request to update an existing location's properties
      type: object
      additionalProperties: false
      required:
      - locationId
      properties:
        locationId:
          type: string
          format: uuid
          description: ID of the location to update
        name:
          type: string
          minLength: 1
          maxLength: 200
          nullable: true
          description: Display name for the location
        description:
          type: string
          maxLength: 2000
          nullable: true
          description: Description of the location
        locationType:
          allOf:
          - $ref: '#/components/schemas/LocationType'
          nullable: true
          description: Type of location
        bounds:
          allOf:
          - $ref: '#/components/schemas/BoundingBox3D'
          nullable: true
          description: Optional spatial extent in world coordinates
        boundsPrecision:
          allOf:
          - $ref: '#/components/schemas/BoundsPrecision'
          nullable: true
          description: Precision level of spatial bounds
        coordinateMode:
          allOf:
          - $ref: '#/components/schemas/CoordinateMode'
          nullable: true
          description: How this location's coordinate system relates to its parent
        localOrigin:
          allOf:
          - $ref: '#/components/schemas/Position3D'
          nullable: true
          description: Origin point for local or inherited coordinate systems
        metadata:
          type: object
          additionalProperties: true
          nullable: true
          description: >-
            Updated client-provided location metadata.
            No Bannou plugin reads specific keys from this field by convention.

    SetLocationParentRequest:
      description: Request to set or change a location's parent in the hierarchy
      type: object
      additionalProperties: false
      required:
      - locationId
      - parentLocationId
      properties:
        locationId:
          type: string
          format: uuid
          description: ID of the location to update
        parentLocationId:
          type: string
          format: uuid
          description: ID of the new parent location (must be in same realm)

    RemoveLocationParentRequest:
      description: Request to remove a location's parent, making it a root location
      type: object
      additionalProperties: false
      required:
      - locationId
      properties:
        locationId:
          type: string
          format: uuid
          description: ID of the location to make a root location

    DeleteLocationRequest:
      description: Request to permanently delete a location from the system
      type: object
      additionalProperties: false
      required:
      - locationId
      properties:
        locationId:
          type: string
          format: uuid
          description: ID of the location to delete

    TransferLocationToRealmRequest:
      description: Request to transfer a location from its current realm to a different realm
      type: object
      additionalProperties: false
      required:
      - locationId
      - targetRealmId
      properties:
        locationId:
          type: string
          format: uuid
          description: ID of the location to transfer
        targetRealmId:
          type: string
          format: uuid
          description: ID of the target realm to transfer the location to

    DeprecateLocationRequest:
      description: Request to soft-delete a location by marking it as deprecated
      type: object
      additionalProperties: false
      required:
      - locationId
      properties:
        locationId:
          type: string
          format: uuid
          description: ID of the location to deprecate
        reason:
          type: string
          maxLength: 500
          nullable: true
          description: Optional reason for deprecation (for audit purposes)

    UndeprecateLocationRequest:
      description: Request to restore a deprecated location back to active status
      type: object
      additionalProperties: false
      required:
      - locationId
      properties:
        locationId:
          type: string
          format: uuid
          description: ID of the location to restore

    LocationExistsRequest:
      description: Request to check if a location exists and is active
      type: object
      additionalProperties: false
      required:
      - locationId
      properties:
        locationId:
          type: string
          format: uuid
          description: ID of the location to validate

    LocationExistsResponse:
      description: Response indicating whether a location exists and its active status
      type: object
      additionalProperties: false
      required:
      - exists
      - isActive
      properties:
        exists:
          type: boolean
          description: Whether the location exists
        isActive:
          type: boolean
          description: Whether the location is active (false if deprecated or not found)
        locationId:
          type: string
          format: uuid
          nullable: true
          description: The location ID if found
        realmId:
          type: string
          format: uuid
          nullable: true
          description: The realm ID if location found

    SeedLocationsRequest:
      description: Request to seed multiple locations from configuration data
      type: object
      additionalProperties: false
      required:
      - locations
      properties:
        locations:
          type: array
          items:
            $ref: '#/components/schemas/SeedLocation'
          description: List of locations to seed (processed in dependency order)
        updateExisting:
          type: boolean
          default: false
          description: Whether to update locations that already exist

    SeedLocation:
      description: Location data for seeding operations, using codes instead of IDs for references
      type: object
      additionalProperties: false
      required:
      - code
      - name
      - realmCode
      - locationType
      properties:
        code:
          type: string
          description: Unique code for the location within realm
        name:
          type: string
          description: Display name
        description:
          type: string
          nullable: true
          description: Description
        realmCode:
          type: string
          description: Code of the realm (resolved during seeding)
        locationType:
          $ref: '#/components/schemas/LocationType'
          description: Type classification for this location
        parentLocationCode:
          type: string
          nullable: true
          description: Code of the parent location (resolved during seeding)
        bounds:
          allOf:
          - $ref: '#/components/schemas/BoundingBox3D'
          nullable: true
          description: Optional spatial extent in world coordinates
        boundsPrecision:
          allOf:
          - $ref: '#/components/schemas/BoundsPrecision'
          nullable: true
          description: Precision level of spatial bounds (defaults to none)
        coordinateMode:
          allOf:
          - $ref: '#/components/schemas/CoordinateMode'
          nullable: true
          description: How this location's coordinate system relates to its parent (defaults to inherit)
        localOrigin:
          allOf:
          - $ref: '#/components/schemas/Position3D'
          nullable: true
          description: Origin point for local or inherited coordinate systems
        metadata:
          type: object
          additionalProperties: true
          nullable: true
          description: >-
            Client-provided location metadata.
            No Bannou plugin reads specific keys from this field by convention.

    QueryLocationsByPositionRequest:
      description: Request to find all locations containing a spatial position
      type: object
      additionalProperties: false
      required:
      - position
      - realmId
      properties:
        position:
          $ref: '#/components/schemas/Position3D'
          description: Position to query in world coordinates
        realmId:
          type: string
          format: uuid
          description: Realm to search within
        maxDepth:
          type: integer
          minimum: 0
          nullable: true
          description: Maximum hierarchy depth to search (null for all depths)
        page:
          type: integer
          minimum: 1
          default: 1
          description: Page number for pagination (1-indexed)
        pageSize:
          type: integer
          minimum: 1
          maximum: 100
          default: 20
          description: Number of results per page

    LocationResponse:
      description: Complete location data returned from API operations
      type: object
      additionalProperties: false
      required:
      - locationId
      - realmId
      - code
      - name
      - locationType
      - depth
      - isDeprecated
      - createdAt
      - updatedAt
      properties:
        locationId:
          type: string
          format: uuid
          description: Unique identifier for the location
        realmId:
          type: string
          format: uuid
          description: Realm this location belongs to
        code:
          type: string
          description: Unique code for the location within its realm
        name:
          type: string
          description: Display name of the location
        description:
          type: string
          nullable: true
          description: Optional description of the location
        locationType:
          $ref: '#/components/schemas/LocationType'
          description: Type classification of the location
        parentLocationId:
          type: string
          format: uuid
          nullable: true
          description: Parent location ID (null for root locations)
        depth:
          type: integer
          description: Depth in hierarchy (0 for root locations)
        isDeprecated:
          type: boolean
          description: Whether this location is deprecated and cannot be used
        deprecatedAt:
          type: string
          format: date-time
          nullable: true
          description: Timestamp when this location was deprecated
        deprecationReason:
          type: string
          nullable: true
          description: Optional reason for deprecation
        bounds:
          allOf:
          - $ref: '#/components/schemas/BoundingBox3D'
          nullable: true
          description: Optional spatial extent in world coordinates
        boundsPrecision:
          allOf:
          - $ref: '#/components/schemas/BoundsPrecision'
          description: Precision level of spatial bounds
        coordinateMode:
          allOf:
          - $ref: '#/components/schemas/CoordinateMode'
          description: How this location's coordinate system relates to its parent
        localOrigin:
          allOf:
          - $ref: '#/components/schemas/Position3D'
          nullable: true
          description: Origin point for local or inherited coordinate systems
        metadata:
          type: object
          additionalProperties: true
          nullable: true
          description: >-
            Client-provided location metadata.
            No Bannou plugin reads specific keys from this field by convention.
        createdAt:
          type: string
          format: date-time
          description: Timestamp when the location was created
        updatedAt:
          type: string
          format: date-time
          description: Timestamp when the location was last updated

    LocationListResponse:
      description: Paginated list of locations with metadata for navigation
      type: object
      additionalProperties: false
      required:
      - locations
      - totalCount
      - page
      - pageSize
      properties:
        locations:
          type: array
          items:
            $ref: '#/components/schemas/LocationResponse'
          description: List of locations matching the query
        totalCount:
          type: integer
          description: Total number of locations matching the query (across all pages)
        page:
          type: integer
          description: Current page number (1-indexed)
        pageSize:
          type: integer
          description: Number of results per page
        hasNextPage:
          type: boolean
          description: Whether there are more pages after the current page
        hasPreviousPage:
          type: boolean
          description: Whether there are pages before the current page

    SeedLocationsResponse:
      description: Summary of a seed operation including counts of created, updated, and skipped locations
      type: object
      additionalProperties: false
      required:
      - created
      - updated
      - skipped
      - errors
      properties:
        created:
          type: integer
          description: Number of new locations created
        updated:
          type: integer
          description: Number of existing locations updated
        skipped:
          type: integer
          description: Number of locations skipped (already exist, updateExisting=false)
        errors:
          type: array
          items:
            type: string
          description: List of error messages for locations that failed to seed

    ReportEntityPositionRequest:
      description: Request to report an entity's presence at a location
      type: object
      additionalProperties: false
      required:
      - entityType
      - entityId
      - locationId
      properties:
        entityType:
          type: string
          description: Type of entity (opaque string - character, actor, npc, player, etc.)
        entityId:
          type: string
          format: uuid
          description: ID of the entity being reported
        locationId:
          type: string
          format: uuid
          description: ID of the location the entity is at
        previousLocationId:
          type: string
          format: uuid
          nullable: true
          description: Caller hint for the entity's previous location (optimization to skip GET on refresh)
        realmId:
          type: string
          format: uuid
          nullable: true
          description: ID of the realm the location belongs to (included in arrival events if provided)
        reportedBy:
          type: string
          nullable: true
          description: Identifier of the reporter (service name or session ID)

    ReportEntityPositionResponse:
      description: Result of reporting entity presence
      type: object
      additionalProperties: false
      required:
      - recorded
      properties:
        recorded:
          type: boolean
          description: Whether the position was successfully recorded
        arrivedAt:
          type: string
          format: uuid
          nullable: true
          description: Location ID the entity arrived at (only set when location changed)
        departedFrom:
          type: string
          format: uuid
          nullable: true
          description: Location ID the entity departed from (only set when location changed)

    GetEntityLocationRequest:
      description: Request to query an entity's current location
      type: object
      additionalProperties: false
      required:
      - entityType
      - entityId
      properties:
        entityType:
          type: string
          description: Type of entity (opaque string - character, actor, npc, player, etc.)
        entityId:
          type: string
          format: uuid
          description: ID of the entity to look up

    GetEntityLocationResponse:
      description: Result of querying an entity's current location
      type: object
      additionalProperties: false
      required:
      - found
      properties:
        found:
          type: boolean
          description: Whether a non-expired presence binding exists for this entity
        locationId:
          type: string
          format: uuid
          nullable: true
          description: ID of the location the entity is currently at
        realmId:
          type: string
          format: uuid
          nullable: true
          description: ID of the realm the location belongs to
        entityType:
          type: string
          nullable: true
          description: Type of entity (echoed back)
        entityId:
          type: string
          format: uuid
          nullable: true
          description: ID of the entity (echoed back)
        reportedAt:
          type: string
          format: date-time
          nullable: true
          description: When the presence was last reported
        reportedBy:
          type: string
          nullable: true
          description: Identifier of the last reporter

    ListEntitiesAtLocationRequest:
      description: Request to list entities at a specific location
      type: object
      additionalProperties: false
      required:
      - locationId
      properties:
        locationId:
          type: string
          format: uuid
          description: ID of the location to query
        entityType:
          type: string
          nullable: true
          description: Optional filter by entity type (opaque string)
        page:
          type: integer
          default: 1
          description: Page number (1-indexed)
        pageSize:
          type: integer
          default: 50
          description: Number of entities per page

    ListEntitiesAtLocationResponse:
      description: Result of listing entities at a location
      type: object
      additionalProperties: false
      required:
      - entities
      - totalCount
      - locationId
      properties:
        entities:
          type: array
          items:
            $ref: '#/components/schemas/EntityPresenceEntry'
          description: Entities currently present at the location
        totalCount:
          type: integer
          description: Total number of entities matching the query
        locationId:
          type: string
          format: uuid
          description: ID of the queried location

    EntityPresenceEntry:
      description: An entity currently present at a location
      type: object
      additionalProperties: false
      required:
      - entityType
      - entityId
      properties:
        entityType:
          type: string
          description: Type of entity (opaque string)
        entityId:
          type: string
          format: uuid
          description: ID of the entity
        reportedAt:
          type: string
          format: date-time
          nullable: true
          description: When the presence was last reported
        reportedBy:
          type: string
          nullable: true
          description: Identifier of the last reporter

    ClearEntityPositionRequest:
      description: Request to clear an entity's presence from its current location
      type: object
      additionalProperties: false
      required:
      - entityType
      - entityId
      properties:
        entityType:
          type: string
          description: Type of entity (opaque string - character, actor, npc, player, etc.)
        entityId:
          type: string
          format: uuid
          description: ID of the entity to clear

    ClearEntityPositionResponse:
      description: Result of clearing entity presence
      type: object
      additionalProperties: false
      required:
      - cleared
      properties:
        cleared:
          type: boolean
          description: Whether the entity had an active presence that was cleared
        previousLocationId:
          type: string
          format: uuid
          nullable: true
          description: Location the entity was removed from (null if entity had no active presence)
    BoundingBox3D:
      type: object
      additionalProperties: false
      description: Axis-aligned bounding box in world coordinates (meters, Y-up, right-handed)
      required:
      - minX
      - minY
      - minZ
      - maxX
      - maxY
      - maxZ
      properties:
        minX:
          type: number
          format: float
          description: Minimum X bound in world space
        minY:
          type: number
          format: float
          description: Minimum Y bound in world space
        minZ:
          type: number
          format: float
          description: Minimum Z bound in world space
        maxX:
          type: number
          format: float
          description: Maximum X bound in world space
        maxY:
          type: number
          format: float
          description: Maximum Y bound in world space
        maxZ:
          type: number
          format: float
          description: Maximum Z bound in world space

    # ==========================================================================
    # Archive Base Types
    # ==========================================================================

    Position3D:
      type: object
      additionalProperties: false
      description: Position in world coordinates (meters, Y-up, right-handed)
      required:
      - x
      - y
      - z
      properties:
        x:
          type: number
          format: float
          description: X coordinate in world space (meters)
        y:
          type: number
          format: float
          description: Y coordinate (up axis) in world space (meters)
        z:
          type: number
          format: float
          description: Z coordinate in world space (meters)

x-inlined-types:
- BoundingBox3D
- Position3D
