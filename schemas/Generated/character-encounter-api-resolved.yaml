openapi: 3.0.0
info:
  title: Bannou Character Encounter Service API
  description: |
    Character encounter tracking service for memorable interactions between characters.

    **Purpose**: Tracks what happens BETWEEN characters (encounters) as opposed to
    Character-History which tracks what happens TO a character. Enables:
    - Dialogue triggers ("We've met before...")
    - Grudges/alliances ("You killed my brother!")
    - Quest hooks ("The merchant you saved has a job for you")
    - NPC memory (Characters remember interactions)

    **Multi-Participant Design**: Each encounter has one shared record with N perspectives
    (one per participant). This scales linearly O(N) and supports group events.

    **Memory Decay**: Encounter memories fade over time unless reinforced. Memory decay
    is applied lazily on access (not via background jobs) for simpler deployment.

    **Configurable Type Codes**: Games can define custom encounter types beyond the
    built-in types (COMBAT, TRADE, DIALOGUE, QUEST, SOCIAL, CEREMONY).

    **POST-Only API Pattern**: This API uses POST for all operations to support zero-copy
    WebSocket routing. Path parameters are passed in request bodies instead of URLs.
    See docs/BANNOU_DESIGN.md for architectural rationale.

    **SCHEMA MODIFICATION GATE**: STOP. Before modifying this schema, you MUST:
    1. Read docs/reference/SCHEMA-RULES.md
    2. State which section applies to your change
    3. Only then proceed with edits
    Edits without stating the applicable rule are FORBIDDEN.
  version: 1.0.0
  # Resource reference tracking (see SCHEMA-RULES.md "x-references")
  x-references:
  - target: character
    sourceType: character-encounter
    field: characterId
    onDelete: cascade
    cleanup:
      endpoint: /character-encounter/delete-by-character
      payloadTemplate: '{"characterId": "{{resourceId}}"}'
  # Compression callback for resource archival (see SCHEMA-RULES.md "x-compression-callback")
  x-compression-callback:
    resourceType: character
    sourceType: character-encounter
    compressEndpoint: /character-encounter/get-compress-data
    compressPayloadTemplate: '{"characterId": "{{resourceId}}"}'
    priority: 30
    templateNamespace: encounters
    description: Memorable interactions and relationship impacts
    decompressEndpoint: /character-encounter/restore-from-archive
    decompressPayloadTemplate: '{"characterId": "{{resourceId}}", "data": "{{data}}"}'
servers:
- url: http://localhost:5012
  description: Bannou service endpoint (internal only)

paths:
  # ============================================================================
  # Encounter Type Management (Configurable Codes)
  # ============================================================================

  /character-encounter/type/create:
    post:
      summary: Create new encounter type
      operationId: createEncounterType
      tags:
      - Encounter Type Management
      description: |
        Creates a new encounter type code for game-specific encounter categories.
        Built-in types (COMBAT, TRADE, etc.) cannot be created via this endpoint.
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateEncounterTypeRequest'
      responses:
        '200':
          description: Encounter type created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EncounterTypeResponse'
        '400':
          description: Invalid encounter type data
        '409':
          description: Encounter type with this code already exists

  /character-encounter/type/get:
    post:
      summary: Get encounter type by code
      operationId: getEncounterType
      tags:
      - Encounter Type Management
      description: Retrieve an encounter type by its unique code.
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetEncounterTypeRequest'
      responses:
        '200':
          description: Encounter type retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EncounterTypeResponse'
        '404':
          description: Encounter type not found

  /character-encounter/type/list:
    post:
      summary: List all encounter types
      operationId: listEncounterTypes
      tags:
      - Encounter Type Management
      description: Retrieve all encounter types including built-in and custom types.
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ListEncounterTypesRequest'
      responses:
        '200':
          description: Encounter types retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EncounterTypeListResponse'

  /character-encounter/type/update:
    post:
      summary: Update encounter type
      operationId: updateEncounterType
      tags:
      - Encounter Type Management
      description: |
        Update an existing encounter type. Built-in types can only have their
        description and defaultEmotionalImpact updated.
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateEncounterTypeRequest'
      responses:
        '200':
          description: Encounter type updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EncounterTypeResponse'
        '404':
          description: Encounter type not found
        '400':
          description: Invalid update data

  /character-encounter/type/delete:
    post:
      summary: Delete encounter type
      operationId: deleteEncounterType
      tags:
      - Encounter Type Management
      description: |
        Delete a custom encounter type. Built-in types cannot be deleted.
        Types with existing encounters cannot be deleted.
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeleteEncounterTypeRequest'
      responses:
        '200':
          description: Encounter type deleted successfully
        '404':
          description: Encounter type not found
        '400':
          description: Cannot delete built-in type
        '409':
          description: Cannot delete - type is in use by encounters

  /character-encounter/type/seed:
    post:
      summary: Seed default encounter types
      operationId: seedEncounterTypes
      tags:
      - Encounter Type Management
      description: |
        Idempotent operation to seed built-in encounter types. Called automatically
        at service startup, but can be invoked manually to restore defaults.
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SeedEncounterTypesRequest'
      responses:
        '200':
          description: Seed operation completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SeedEncounterTypesResponse'

  # ============================================================================
  # Recording
  # ============================================================================

  /character-encounter/record:
    post:
      summary: Record new encounter with perspectives
      operationId: recordEncounter
      tags:
      - Recording
      description: |
        Records a new encounter between two or more characters. Creates the shared
        encounter record and individual perspectives for each participant.

        Perspectives can be provided in the request or will be auto-generated with
        default values if not specified.
      x-permissions: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RecordEncounterRequest'
      responses:
        '200':
          description: Encounter recorded successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EncounterResponse'
        '400':
          description: Invalid encounter data (requires at least 2 participants)
        '404':
          description: One or more characters not found
        '409':
          description: Duplicate encounter (same participants, timestamp, and type)

  # ============================================================================
  # Queries
  # ============================================================================

  /character-encounter/query/by-character:
    post:
      summary: Get character's encounters (paginated)
      operationId: queryByCharacter
      tags:
      - Queries
      description: |
        Retrieves all encounters for a character with optional filtering.
        Memory decay is applied lazily on access.
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QueryByCharacterRequest'
      responses:
        '200':
          description: Encounters retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EncounterListResponse'

  /character-encounter/query/between:
    post:
      summary: Get encounters between two characters
      operationId: queryBetween
      tags:
      - Queries
      description: |
        Retrieves all encounters between two specific characters.
        Useful for relationship history and dialogue context.
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QueryBetweenRequest'
      responses:
        '200':
          description: Encounters retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EncounterListResponse'

  /character-encounter/query/by-location:
    post:
      summary: Recent encounters at location
      operationId: queryByLocation
      tags:
      - Queries
      description: |
        Retrieves recent encounters at a specific location.
        Useful for scene context and area history.
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QueryByLocationRequest'
      responses:
        '200':
          description: Encounters retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EncounterListResponse'

  /character-encounter/has-met:
    post:
      summary: Quick check if two characters have met
      operationId: hasMet
      tags:
      - Queries
      description: |
        Fast boolean check for whether two characters have any recorded encounters.
        Does not apply memory decay or return encounter details.
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/HasMetRequest'
      responses:
        '200':
          description: Check completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HasMetResponse'

  /character-encounter/get-sentiment:
    post:
      summary: Aggregate sentiment toward another character
      operationId: getSentiment
      tags:
      - Queries
      description: |
        Calculates the aggregate sentiment a character has toward another based
        on all their encounters. Memory strength is factored into the calculation.
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetSentimentRequest'
      responses:
        '200':
          description: Sentiment calculated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SentimentResponse'

  /character-encounter/batch-get:
    post:
      summary: Bulk sentiment for multiple targets
      operationId: batchGetSentiment
      tags:
      - Queries
      description: |
        Calculates sentiment toward multiple target characters in a single call.
        Efficient for behavior system queries that check multiple NPCs.
      x-permissions: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BatchGetSentimentRequest'
      responses:
        '200':
          description: Sentiments calculated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchSentimentResponse'

  # ============================================================================
  # Perspectives
  # ============================================================================

  /character-encounter/get-perspective:
    post:
      summary: Get character's view of encounter
      operationId: getPerspective
      tags:
      - Perspectives
      description: |
        Retrieves a specific character's perspective on an encounter.
        Includes emotional impact, sentiment shift, and memory strength.
      x-permissions:
      - role: user
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetPerspectiveRequest'
      responses:
        '200':
          description: Perspective retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PerspectiveResponse'
        '404':
          description: Perspective not found

  /character-encounter/update-perspective:
    post:
      summary: Update perspective (reflection)
      operationId: updatePerspective
      tags:
      - Perspectives
      description: |
        Updates a character's perspective on an encounter. Used when a character
        reflects on past events or gains new information about an encounter.
      x-permissions: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdatePerspectiveRequest'
      responses:
        '200':
          description: Perspective updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PerspectiveResponse'
        '404':
          description: Perspective not found

  /character-encounter/refresh-memory:
    post:
      summary: Strengthen memory (referenced)
      operationId: refreshMemory
      tags:
      - Perspectives
      description: |
        Strengthens a character's memory of an encounter. Called when the encounter
        is referenced in dialogue, thought, or action. Counteracts memory decay.
      x-permissions: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshMemoryRequest'
      responses:
        '200':
          description: Memory refreshed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PerspectiveResponse'
        '404':
          description: Perspective not found

  # ============================================================================
  # Admin
  # ============================================================================

  /character-encounter/delete:
    post:
      summary: Delete encounter and perspectives
      operationId: deleteEncounter
      tags:
      - Admin
      description: |
        Deletes an encounter record and all associated perspectives.
        This is a hard delete and cannot be undone.
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeleteEncounterRequest'
      responses:
        '200':
          description: Encounter deleted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeleteEncounterResponse'
        '404':
          description: Encounter not found

  /character-encounter/delete-by-character:
    post:
      summary: Delete all encounters for a character
      operationId: deleteByCharacter
      tags:
      - Admin
      description: |
        Deletes all encounter records and perspectives involving a specific character.
        Used during character deletion or compression. This is a hard delete.
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeleteByCharacterRequest'
      responses:
        '200':
          description: Encounters deleted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeleteByCharacterResponse'

  /character-encounter/decay-memories:
    post:
      summary: Trigger memory decay (maintenance)
      operationId: decayMemories
      tags:
      - Admin
      description: |
        Manually triggers memory decay processing for all or specific characters.
        Normally decay is applied lazily on access, but this can be used for
        maintenance or testing purposes.
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DecayMemoriesRequest'
      responses:
        '200':
          description: Decay processing completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DecayMemoriesResponse'

  # ===========================================================================
  # Compression Endpoints (Resource Service Integration)
  # ===========================================================================

  /character-encounter/get-compress-data:
    post:
      summary: Get encounter data for compression
      operationId: getCompressData
      tags:
      - Compression
      description: |
        Called by Resource service during character compression.
        Returns encounters and perspectives involving this character for archival.
      x-permissions:
      - role: developer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetCompressDataRequest'
      responses:
        '200':
          description: Compressed data returned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CharacterEncounterArchive'
        '404':
          description: No encounter data for character

  /character-encounter/restore-from-archive:
    post:
      summary: Restore encounter data from archive
      operationId: restoreFromArchive
      tags:
      - Compression
      description: |
        Called by Resource service during character decompression.
        Restores encounters and perspectives from archive data.
      x-permissions:
      - role: admin
        states: {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RestoreFromArchiveRequest'
      responses:
        '200':
          description: Restoration result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RestoreFromArchiveResponse'
        '400':
          description: Invalid archive data

components:
  schemas:
    # ==========================================================================
    # Enums
    # ==========================================================================

    EncounterOutcome:
      type: string
      description: Overall outcome of an encounter
      enum:
      - POSITIVE
      - NEGATIVE
      - NEUTRAL
      - MEMORABLE
      - TRANSFORMATIVE

    EmotionalImpact:
      type: string
      description: How the encounter emotionally affected the character
      enum:
      - GRATITUDE
      - ANGER
      - FEAR
      - RESPECT
      - CONTEMPT
      - AFFECTION
      - RIVALRY
      - INDIFFERENCE
      - GUILT
      - PRIDE

    # ==========================================================================
    # Core Models
    # ==========================================================================

    EncounterModel:
      type: object
      description: Core encounter record representing a memorable interaction
      additionalProperties: false
      required:
      - encounterId
      - timestamp
      - realmId
      - encounterTypeCode
      - outcome
      - participantIds
      - createdAt
      properties:
        encounterId:
          type: string
          format: uuid
          description: Unique identifier for this encounter
        timestamp:
          type: string
          format: date-time
          description: In-game time when the encounter occurred
        realmId:
          type: string
          format: uuid
          description: Realm where the encounter took place
        locationId:
          type: string
          format: uuid
          nullable: true
          description: Specific location within the realm (optional)
        encounterTypeCode:
          type: string
          description: Type code for this encounter (e.g., COMBAT, TRADE)
        context:
          type: string
          maxLength: 500
          nullable: true
          description: What triggered or contextualized the encounter
        outcome:
          allOf:
          - $ref: '#/components/schemas/EncounterOutcome'
          description: Outcome of the encounter (POSITIVE, NEGATIVE, NEUTRAL, MEMORABLE, TRANSFORMATIVE)
        participantIds:
          type: array
          items:
            type: string
            format: uuid
          minItems: 2
          description: All character IDs involved in the encounter
        metadata:
          type: object
          additionalProperties: true
          nullable: true
          description: Additional encounter-specific data
        createdAt:
          type: string
          format: date-time
          description: System timestamp when record was created

    EncounterPerspectiveModel:
      type: object
      description: A character's individual perspective on an encounter
      additionalProperties: false
      required:
      - perspectiveId
      - encounterId
      - characterId
      - emotionalImpact
      - memoryStrength
      - createdAt
      properties:
        perspectiveId:
          type: string
          format: uuid
          description: Unique identifier for this perspective
        encounterId:
          type: string
          format: uuid
          description: Reference to the shared encounter record
        characterId:
          type: string
          format: uuid
          description: Character holding this perspective
        emotionalImpact:
          allOf:
          - $ref: '#/components/schemas/EmotionalImpact'
          description: Primary emotional response to the encounter
        impactIntensity:
          type: number
          format: float
          minimum: 0.0
          maximum: 1.0
          description: Intensity of emotional impact (0.0-1.0). Used for kernel extraction threshold (>0.7 indicates 
            high-impact encounter).
        sentimentShift:
          type: number
          format: float
          minimum: -1.0
          maximum: 1.0
          nullable: true
          description: Opinion change toward other participants (-1.0 to +1.0)
        memoryStrength:
          type: number
          format: float
          minimum: 0.0
          maximum: 1.0
          description: How strongly remembered (0.0-1.0, decays over time)
        rememberedAs:
          type: string
          maxLength: 200
          nullable: true
          description: Short description from this character's POV
        lastDecayedAt:
          type: string
          format: date-time
          nullable: true
          description: When memory decay was last applied
        createdAt:
          type: string
          format: date-time
          description: System timestamp when record was created
        updatedAt:
          type: string
          format: date-time
          nullable: true
          description: Last modification timestamp

    EncounterTypeModel:
      type: object
      description: Configurable encounter type definition
      additionalProperties: false
      required:
      - typeId
      - code
      - name
      - isBuiltIn
      - sortOrder
      - isActive
      - createdAt
      properties:
        typeId:
          type: string
          format: uuid
          description: Unique identifier for this type
        code:
          type: string
          minLength: 1
          maxLength: 50
          pattern: '^[A-Z][A-Z0-9_]*$'
          description: Unique code (e.g., COMBAT, TRADE, HEALING)
        name:
          type: string
          minLength: 1
          maxLength: 100
          description: Display name for the encounter type
        description:
          type: string
          maxLength: 500
          nullable: true
          description: Description of this encounter type
        isBuiltIn:
          type: boolean
          description: True for system types, false for custom
        defaultEmotionalImpact:
          $ref: '#/components/schemas/EmotionalImpact'
          nullable: true
          description: Suggested emotional response for this type
        sortOrder:
          type: integer
          description: Display ordering
        isActive:
          type: boolean
          description: Soft-delete flag
        createdAt:
          type: string
          format: date-time
          description: System timestamp when type was created

    # ==========================================================================
    # Request Schemas - Encounter Type Management
    # ==========================================================================

    CreateEncounterTypeRequest:
      type: object
      description: Request to create a new encounter type
      additionalProperties: false
      required:
      - code
      - name
      properties:
        code:
          type: string
          minLength: 1
          maxLength: 50
          pattern: '^[A-Z][A-Z0-9_]*$'
          description: Unique code for the encounter type
        name:
          type: string
          minLength: 1
          maxLength: 100
          description: Display name for the encounter type
        description:
          type: string
          maxLength: 500
          nullable: true
          description: Description of this encounter type
        defaultEmotionalImpact:
          $ref: '#/components/schemas/EmotionalImpact'
          nullable: true
          description: Suggested emotional response
        sortOrder:
          type: integer
          default: 100
          description: Display ordering (lower = first)

    GetEncounterTypeRequest:
      type: object
      description: Request to retrieve an encounter type by code
      additionalProperties: false
      required:
      - code
      properties:
        code:
          type: string
          description: Unique code of the encounter type

    ListEncounterTypesRequest:
      type: object
      description: Request to list encounter types with optional filtering
      additionalProperties: false
      properties:
        includeInactive:
          type: boolean
          default: false
          description: Include soft-deleted types
        builtInOnly:
          type: boolean
          default: false
          description: Only return built-in types
        customOnly:
          type: boolean
          default: false
          description: Only return custom types

    UpdateEncounterTypeRequest:
      type: object
      description: Request to update an encounter type
      additionalProperties: false
      required:
      - code
      properties:
        code:
          type: string
          description: Code of the type to update
        name:
          type: string
          minLength: 1
          maxLength: 100
          nullable: true
          description: New display name
        description:
          type: string
          maxLength: 500
          nullable: true
          description: New description
        defaultEmotionalImpact:
          $ref: '#/components/schemas/EmotionalImpact'
          nullable: true
          description: New suggested emotional response
        sortOrder:
          type: integer
          nullable: true
          description: New display ordering

    DeleteEncounterTypeRequest:
      type: object
      description: Request to delete an encounter type
      additionalProperties: false
      required:
      - code
      properties:
        code:
          type: string
          description: Code of the type to delete

    SeedEncounterTypesRequest:
      type: object
      description: Request to seed default encounter types
      additionalProperties: false
      properties:
        forceReset:
          type: boolean
          default: false
          description: Reset built-in types to defaults even if they exist

    # ==========================================================================
    # Request Schemas - Recording
    # ==========================================================================

    RecordEncounterRequest:
      type: object
      description: Request to record a new encounter
      additionalProperties: false
      required:
      - timestamp
      - realmId
      - encounterTypeCode
      - outcome
      - participantIds
      properties:
        timestamp:
          type: string
          format: date-time
          description: In-game time of the encounter
        realmId:
          type: string
          format: uuid
          description: Realm where the encounter occurred
        locationId:
          type: string
          format: uuid
          nullable: true
          description: Specific location (optional)
        encounterTypeCode:
          type: string
          description: Type code (must be an active type)
        context:
          type: string
          maxLength: 500
          nullable: true
          description: What triggered the encounter
        outcome:
          allOf:
          - $ref: '#/components/schemas/EncounterOutcome'
          description: Outcome of the encounter being recorded
        participantIds:
          type: array
          items:
            type: string
            format: uuid
          minItems: 2
          description: Character IDs involved (minimum 2)
        perspectives:
          type: array
          items:
            $ref: '#/components/schemas/PerspectiveInput'
          nullable: true
          description: Optional perspectives (auto-generated if not provided)
        metadata:
          type: object
          additionalProperties: true
          nullable: true
          description: Additional encounter data

    PerspectiveInput:
      type: object
      description: Input for a single participant's perspective
      additionalProperties: false
      required:
      - characterId
      - emotionalImpact
      properties:
        characterId:
          type: string
          format: uuid
          description: Character this perspective belongs to
        emotionalImpact:
          allOf:
          - $ref: '#/components/schemas/EmotionalImpact'
          description: Character's emotional response to the encounter
        impactIntensity:
          type: number
          format: float
          minimum: 0.0
          maximum: 1.0
          nullable: true
          description: Intensity of emotional impact (0.0-1.0). Defaults based on emotionalImpact if not provided.
        sentimentShift:
          type: number
          format: float
          minimum: -1.0
          maximum: 1.0
          nullable: true
          description: Opinion change toward other participants
        memoryStrength:
          type: number
          format: float
          minimum: 0.0
          maximum: 1.0
          default: 1.0
          description: Initial memory strength
        rememberedAs:
          type: string
          maxLength: 200
          nullable: true
          description: How this character remembers the encounter

    # ==========================================================================
    # Request Schemas - Queries
    # ==========================================================================

    QueryByCharacterRequest:
      type: object
      description: Request to query encounters by character
      additionalProperties: false
      required:
      - characterId
      properties:
        characterId:
          type: string
          format: uuid
          description: Character to query encounters for
        encounterTypeCode:
          type: string
          nullable: true
          description: Filter by encounter type
        outcome:
          $ref: '#/components/schemas/EncounterOutcome'
          nullable: true
          description: Filter by outcome
        minimumMemoryStrength:
          type: number
          format: float
          minimum: 0.0
          maximum: 1.0
          nullable: true
          description: Filter by minimum memory strength
        fromTimestamp:
          type: string
          format: date-time
          nullable: true
          description: Filter encounters after this time
        toTimestamp:
          type: string
          format: date-time
          nullable: true
          description: Filter encounters before this time
        page:
          type: integer
          minimum: 1
          default: 1
          description: Page number (1-based)
        pageSize:
          type: integer
          minimum: 1
          maximum: 100
          default: 20
          description: Results per page

    QueryBetweenRequest:
      type: object
      description: Request to query encounters between two characters
      additionalProperties: false
      required:
      - characterIdA
      - characterIdB
      properties:
        characterIdA:
          type: string
          format: uuid
          description: First character
        characterIdB:
          type: string
          format: uuid
          description: Second character
        encounterTypeCode:
          type: string
          nullable: true
          description: Filter by encounter type
        minimumMemoryStrength:
          type: number
          format: float
          minimum: 0.0
          maximum: 1.0
          nullable: true
          description: Filter by minimum memory strength (for either character)
        page:
          type: integer
          minimum: 1
          default: 1
          description: Page number (1-based)
        pageSize:
          type: integer
          minimum: 1
          maximum: 100
          default: 20
          description: Results per page

    QueryByLocationRequest:
      type: object
      description: Request to query recent encounters at a location
      additionalProperties: false
      required:
      - locationId
      properties:
        locationId:
          type: string
          format: uuid
          description: Location to query
        encounterTypeCode:
          type: string
          nullable: true
          description: Filter by encounter type
        fromTimestamp:
          type: string
          format: date-time
          nullable: true
          description: Filter encounters after this time
        page:
          type: integer
          minimum: 1
          default: 1
          description: Page number (1-based)
        pageSize:
          type: integer
          minimum: 1
          maximum: 100
          default: 20
          description: Results per page

    HasMetRequest:
      type: object
      description: Request to check if two characters have met
      additionalProperties: false
      required:
      - characterIdA
      - characterIdB
      properties:
        characterIdA:
          type: string
          format: uuid
          description: First character
        characterIdB:
          type: string
          format: uuid
          description: Second character

    GetSentimentRequest:
      type: object
      description: Request to get aggregate sentiment toward another character
      additionalProperties: false
      required:
      - characterId
      - targetCharacterId
      properties:
        characterId:
          type: string
          format: uuid
          description: Character whose sentiment to query
        targetCharacterId:
          type: string
          format: uuid
          description: Target character to measure sentiment toward

    BatchGetSentimentRequest:
      type: object
      description: Request to get sentiment toward multiple characters
      additionalProperties: false
      required:
      - characterId
      - targetCharacterIds
      properties:
        characterId:
          type: string
          format: uuid
          description: Character whose sentiment to query
        targetCharacterIds:
          type: array
          items:
            type: string
            format: uuid
          minItems: 1
          maxItems: 100
          description: Target characters to measure sentiment toward

    # ==========================================================================
    # Request Schemas - Perspectives
    # ==========================================================================

    GetPerspectiveRequest:
      type: object
      description: Request to get a character's perspective on an encounter
      additionalProperties: false
      required:
      - encounterId
      - characterId
      properties:
        encounterId:
          type: string
          format: uuid
          description: Encounter to get perspective for
        characterId:
          type: string
          format: uuid
          description: Character whose perspective to retrieve

    UpdatePerspectiveRequest:
      type: object
      description: Request to update a character's perspective
      additionalProperties: false
      required:
      - encounterId
      - characterId
      properties:
        encounterId:
          type: string
          format: uuid
          description: Encounter to update perspective for
        characterId:
          type: string
          format: uuid
          description: Character whose perspective to update
        emotionalImpact:
          $ref: '#/components/schemas/EmotionalImpact'
          nullable: true
          description: New emotional impact
        impactIntensity:
          type: number
          format: float
          minimum: 0.0
          maximum: 1.0
          nullable: true
          description: New impact intensity (0.0-1.0)
        sentimentShift:
          type: number
          format: float
          minimum: -1.0
          maximum: 1.0
          nullable: true
          description: New sentiment shift
        rememberedAs:
          type: string
          maxLength: 200
          nullable: true
          description: New memory description

    RefreshMemoryRequest:
      type: object
      description: Request to refresh memory strength
      additionalProperties: false
      required:
      - encounterId
      - characterId
      properties:
        encounterId:
          type: string
          format: uuid
          description: Encounter to refresh memory for
        characterId:
          type: string
          format: uuid
          description: Character whose memory to refresh
        strengthBoost:
          type: number
          format: float
          minimum: 0.0
          maximum: 1.0
          nullable: true
          description: Amount to boost memory strength (capped at 1.0). Falls back to configured MemoryRefreshBoost if 
            not provided.

    # ==========================================================================
    # Request Schemas - Admin
    # ==========================================================================

    DeleteEncounterRequest:
      type: object
      description: Request to delete an encounter
      additionalProperties: false
      required:
      - encounterId
      properties:
        encounterId:
          type: string
          format: uuid
          description: Encounter to delete

    DeleteByCharacterRequest:
      type: object
      description: Request to delete all encounters for a character
      additionalProperties: false
      required:
      - characterId
      properties:
        characterId:
          type: string
          format: uuid
          description: Character to delete encounters for

    DecayMemoriesRequest:
      type: object
      description: Request to trigger memory decay processing
      additionalProperties: false
      properties:
        characterId:
          type: string
          format: uuid
          nullable: true
          description: Specific character to process (null for all)
        dryRun:
          type: boolean
          default: false
          description: Preview changes without applying

    # ==========================================================================
    # Response Schemas
    # ==========================================================================

    EncounterTypeResponse:
      type: object
      description: Response containing an encounter type
      additionalProperties: false
      required:
      - typeId
      - code
      - name
      - isBuiltIn
      - sortOrder
      - isActive
      - createdAt
      properties:
        typeId:
          type: string
          format: uuid
          description: Unique identifier
        code:
          type: string
          description: Unique code
        name:
          type: string
          description: Display name
        description:
          type: string
          nullable: true
          description: Description
        isBuiltIn:
          type: boolean
          description: Whether this is a built-in type
        defaultEmotionalImpact:
          $ref: '#/components/schemas/EmotionalImpact'
          nullable: true
          description: Suggested emotional response
        sortOrder:
          type: integer
          description: Display ordering
        isActive:
          type: boolean
          description: Whether the type is active
        createdAt:
          type: string
          format: date-time
          description: When the type was created

    EncounterTypeListResponse:
      type: object
      description: Response containing a list of encounter types
      additionalProperties: false
      required:
      - types
      - totalCount
      properties:
        types:
          type: array
          items:
            $ref: '#/components/schemas/EncounterTypeResponse'
          description: List of encounter types
        totalCount:
          type: integer
          description: Total number of types

    SeedEncounterTypesResponse:
      type: object
      description: Response from seed operation
      additionalProperties: false
      required:
      - created
      - updated
      - skipped
      properties:
        created:
          type: integer
          description: Number of types created
        updated:
          type: integer
          description: Number of types updated
        skipped:
          type: integer
          description: Number of types skipped

    EncounterResponse:
      type: object
      description: Response containing an encounter with perspectives
      additionalProperties: false
      required:
      - encounter
      - perspectives
      properties:
        encounter:
          allOf:
          - $ref: '#/components/schemas/EncounterModel'
          description: The shared encounter record
        perspectives:
          type: array
          items:
            $ref: '#/components/schemas/EncounterPerspectiveModel'
          description: All perspectives on this encounter

    EncounterListResponse:
      type: object
      description: Paginated list of encounters
      additionalProperties: false
      required:
      - encounters
      - totalCount
      - page
      - pageSize
      properties:
        encounters:
          type: array
          items:
            $ref: '#/components/schemas/EncounterResponse'
          description: List of encounters with perspectives
        totalCount:
          type: integer
          description: Total matching encounters
        page:
          type: integer
          description: Current page (1-based)
        pageSize:
          type: integer
          description: Results per page
        hasNextPage:
          type: boolean
          description: Whether more results exist
        hasPreviousPage:
          type: boolean
          description: Whether previous results exist

    HasMetResponse:
      type: object
      description: Response for has-met check
      additionalProperties: false
      required:
      - hasMet
      - encounterCount
      properties:
        hasMet:
          type: boolean
          description: Whether the characters have any recorded encounters
        encounterCount:
          type: integer
          description: Total number of encounters between them

    SentimentResponse:
      type: object
      description: Response containing aggregate sentiment
      additionalProperties: false
      required:
      - characterId
      - targetCharacterId
      - sentiment
      - encounterCount
      properties:
        characterId:
          type: string
          format: uuid
          description: Character whose sentiment was queried
        targetCharacterId:
          type: string
          format: uuid
          description: Target of the sentiment
        sentiment:
          type: number
          format: float
          minimum: -1.0
          maximum: 1.0
          description: Aggregate sentiment (-1.0 = hostile, +1.0 = friendly)
        encounterCount:
          type: integer
          description: Number of encounters factored in
        dominantEmotion:
          $ref: '#/components/schemas/EmotionalImpact'
          nullable: true
          description: Most common emotional impact across encounters

    BatchSentimentResponse:
      type: object
      description: Response containing sentiment toward multiple targets
      additionalProperties: false
      required:
      - characterId
      - sentiments
      properties:
        characterId:
          type: string
          format: uuid
          description: Character whose sentiment was queried
        sentiments:
          type: array
          items:
            $ref: '#/components/schemas/SentimentResponse'
          description: Sentiment toward each target

    PerspectiveResponse:
      type: object
      description: Response containing a perspective
      additionalProperties: false
      required:
      - perspective
      properties:
        perspective:
          allOf:
          - $ref: '#/components/schemas/EncounterPerspectiveModel'
          description: The character's perspective on the encounter

    DeleteEncounterResponse:
      type: object
      description: Response from delete operation
      additionalProperties: false
      required:
      - encounterId
      - perspectivesDeleted
      properties:
        encounterId:
          type: string
          format: uuid
          description: Deleted encounter ID
        perspectivesDeleted:
          type: integer
          description: Number of perspectives deleted

    DeleteByCharacterResponse:
      type: object
      description: Response from delete-by-character operation
      additionalProperties: false
      required:
      - characterId
      - encountersDeleted
      - perspectivesDeleted
      properties:
        characterId:
          type: string
          format: uuid
          description: Character whose data was deleted
        encountersDeleted:
          type: integer
          description: Number of encounters deleted
        perspectivesDeleted:
          type: integer
          description: Number of perspectives deleted

    DecayMemoriesResponse:
      type: object
      description: Response from decay processing
      additionalProperties: false
      required:
      - perspectivesProcessed
      - memoriesFaded
      - dryRun
      properties:
        perspectivesProcessed:
          type: integer
          description: Number of perspectives processed
        memoriesFaded:
          type: integer
          description: Number of memories that fell below threshold
        dryRun:
          type: boolean
          description: Whether this was a preview run

    # ==========================================================================
    # Compression Models (Resource Service Integration)
    # ==========================================================================

    GetCompressDataRequest:
      type: object
      description: Request to get encounter data for compression
      additionalProperties: false
      required:
      - characterId
      properties:
        characterId:
          type: string
          format: uuid
          description: ID of the character to get compress data for

    CharacterEncounterArchive:
      type: object
      x-archive-type: true
      description: |
        Complete encounter data for archive storage and storyline SDK consumption.
        Inherits base archive properties from ResourceArchiveBase.
        The characterId field equals resourceId for convenience.
      allOf:
      - $ref: '#/components/schemas/ResourceArchiveBase'
      additionalProperties: false
      required:
      - characterId
      - hasEncounters
      - encounterCount
      properties:
        characterId:
          type: string
          format: uuid
          description: Character this data belongs to (equals resourceId)
        hasEncounters:
          type: boolean
          description: Whether encounters exist for this character
        encounterCount:
          type: integer
          description: Number of encounters archived
        encounters:
          type: array
          items:
            $ref: '#/components/schemas/EncounterResponse'
          description: Encounters with perspectives (empty if hasEncounters=false)
        aggregateSentiment:
          type: object
          additionalProperties:
            type: number
            format: float
          description: |
            Map of target characterId to aggregate sentiment.
            Preserves sentiment relationships for historical reference.
          nullable: true

    RestoreFromArchiveRequest:
      type: object
      description: Request to restore encounter data from archive
      additionalProperties: false
      required:
      - characterId
      - data
      properties:
        characterId:
          type: string
          format: uuid
          description: ID of the character to restore data for
        data:
          type: string
          description: Base64-encoded gzipped CharacterEncounterArchive JSON

    RestoreFromArchiveResponse:
      type: object
      description: Result of restoration from archive
      additionalProperties: false
      required:
      - characterId
      - encountersRestored
      - perspectivesRestored
      - success
      properties:
        characterId:
          type: string
          format: uuid
          description: Character data was restored for
        encountersRestored:
          type: integer
          description: Number of encounters restored
        perspectivesRestored:
          type: integer
          description: Number of perspectives restored
        success:
          type: boolean
          description: Whether restoration completed successfully
        errorMessage:
          type: string
          nullable: true
          description: Error details if restoration failed
    ResourceArchiveBase:
      type: object
      description: |
        Base schema for all resource archives that can be stored in
        the resource service's archive bundles and consumed by the
        storyline SDK's ArchiveExtractor.

        Archives implementing this base schema are marked with
        x-archive-type: true and are automatically collected by
        the archive generation script for SDK model generation.
      required:
      - resourceId
      - resourceType
      - archivedAt
      - schemaVersion
      properties:
        resourceId:
          type: string
          format: uuid
          description: Unique identifier of the archived resource
        resourceType:
          type: string
          description: Type identifier (e.g., "character", "character-personality", "realm-history")
        archivedAt:
          type: string
          format: date-time
          description: When this archive was created
        schemaVersion:
          type: integer
          minimum: 1
          description: Schema version for forward compatibility migration
        nestedArchives:
          type: array
          description: Child archives from dependent resources (populated by lib-resource compression)
          items:
            $ref: '#/components/schemas/ResourceArchiveBase'
x-inlined-types:
- ResourceArchiveBase
