# Bannou State Store Definitions
#
# This file defines all state stores used by Bannou services.
# Generated code provides typed constants and configuration.
#
# SCHEMA MODIFICATION GATE: STOP. Before modifying this schema, you MUST:
# 1. Read docs/reference/SCHEMA-RULES.md
# 2. State which section applies to your change
# 3. Only then proceed with edits
# Edits without stating the applicable rule are FORBIDDEN.
#
# Schema: x-state-stores defines each store with:
#   - backend: redis | mysql | memory
#   - prefix: Redis key prefix (redis only)
#   - table: MySQL table name (mysql only, defaults to store name with underscores)
#   - service: Primary service that owns this store
#   - purpose: Human-readable description
#   - enableSearch: Enable RedisSearch full-text indexing (redis only)
#
# Generated artifacts:
#   - bannou-service/Generated/StateStoreDefinitions.cs
#   - docs/GENERATED-STATE-STORES.md

openapi: 3.1.0
info:
  title: Bannou State Store Definitions
  version: 1.0.0
  description: |
    Defines all state stores used by Bannou services.
    This schema is the single source of truth for state store configuration.

x-state-stores:
  # ============================================================================
  # Redis Stores - Ephemeral/Session Data
  # ============================================================================

  auth-statestore:
    backend: redis
    prefix: auth
    service: Auth
    purpose: Session and token state (ephemeral)

  edge-revocation-statestore:
    backend: redis
    prefix: "auth:edge"
    service: Auth
    purpose: Edge revocation tracking for CDN/firewall layer blocking

  connect-statestore:
    backend: redis
    prefix: connect
    service: Connect
    purpose: WebSocket session state

  permission-statestore:
    backend: redis
    prefix: permission
    service: Permission
    purpose: Permission cache and session capabilities

  voice-statestore:
    backend: redis
    prefix: voice
    service: Voice
    purpose: Voice room and peer state

  asset-statestore:
    backend: redis
    prefix: asset
    service: Asset
    purpose: Asset upload tracking and bundle state

  asset-processor-pool:
    backend: redis
    prefix: "asset:pool"
    service: Asset
    purpose: Processor pool node state and indexing

  # ============================================================================
  # Orchestrator Stores
  # ============================================================================

  orchestrator-heartbeats:
    backend: redis
    prefix: "orch:hb"
    service: Orchestrator
    purpose: Service heartbeat tracking

  orchestrator-routings:
    backend: redis
    prefix: "orch:rt"
    service: Orchestrator
    purpose: Service-to-app-id routing tables

  orchestrator-config:
    backend: redis
    prefix: "orch:cfg"
    service: Orchestrator
    purpose: Configuration version and metadata

  # ============================================================================
  # Messaging Stores
  # ============================================================================

  messaging-external-subs:
    backend: redis
    prefix: "msg:subs"
    service: Messaging
    purpose: External subscription recovery data

  # ============================================================================
  # Actor/Behavior Stores - Agent Cognition Data
  # ============================================================================

  agent-memories:
    backend: redis
    prefix: "agent:mem"
    service: Behavior
    purpose: Cognition pipeline memory storage (used by lib-behavior's ActorLocalMemoryStore)

  actor-state:
    backend: redis
    prefix: "actor:state"
    service: Actor
    purpose: Runtime actor state

  actor-templates:
    backend: redis
    prefix: "actor:tpl"
    service: Actor
    purpose: Actor template definitions

  actor-instances:
    backend: redis
    prefix: "actor:inst"
    service: Actor
    purpose: Active actor instance registry

  actor-pool-nodes:
    backend: redis
    prefix: "actor:pool"
    service: Actor
    purpose: Actor pool node assignments

  actor-assignments:
    backend: redis
    prefix: "actor:assign"
    service: Actor
    purpose: Actor-to-node assignments

  behavior-statestore:
    backend: redis
    prefix: "behavior"
    service: Behavior
    purpose: Behavior metadata and compiled definitions

  # ============================================================================
  # Documentation Stores
  # ============================================================================

  documentation-statestore:
    backend: redis
    prefix: doc
    service: Documentation
    purpose: Documentation content and metadata
    enableSearch: true

  # ============================================================================
  # Test Stores
  # ============================================================================

  test-search-statestore:
    backend: redis
    prefix: test-search
    service: State
    purpose: Test store with RedisSearch enabled
    enableSearch: true

  # ============================================================================
  # Matchmaking Stores
  # ============================================================================

  matchmaking-statestore:
    backend: redis
    prefix: mm
    service: Matchmaking
    purpose: Matchmaking queue and ticket state

  # ============================================================================
  # Analytics Stores
  # ============================================================================

  analytics-summary:
    backend: redis
    prefix: "analytics:sum"
    service: Analytics
    purpose: Event buffer, session mappings, and resolution caches for analytics ingestion

  analytics-summary-data:
    backend: mysql
    service: Analytics
    purpose: Entity summary data for queryable analytics (MySQL for server-side filtering)

  analytics-rating:
    backend: redis
    prefix: "analytics:rating"
    service: Analytics
    purpose: Glicko-2 skill ratings

  analytics-history-data:
    backend: mysql
    service: Analytics
    purpose: Controller possession history for queryable audit trails (MySQL for server-side filtering)

  # ============================================================================
  # Leaderboard Stores
  # ============================================================================

  leaderboard-definition:
    backend: redis
    prefix: "lb:def"
    service: Leaderboard
    purpose: Leaderboard definitions and metadata

  leaderboard-ranking:
    backend: redis
    prefix: "lb:rank"
    service: Leaderboard
    purpose: Real-time ranking data (sorted sets)

  leaderboard-season:
    backend: mysql
    service: Leaderboard
    purpose: Season history and archives

  # ============================================================================
  # Achievement Stores
  # ============================================================================

  achievement-definition:
    backend: redis
    prefix: "ach:def"
    service: Achievement
    purpose: Achievement definitions

  achievement-progress:
    backend: redis
    prefix: "ach:prog"
    service: Achievement
    purpose: Player achievement progress

  # ============================================================================
  # Save-Load Stores
  # ============================================================================

  save-load-slots:
    backend: mysql
    service: SaveLoad
    purpose: Save slot metadata and ownership

  save-load-versions:
    backend: mysql
    service: SaveLoad
    purpose: Save version history

  save-load-schemas:
    backend: mysql
    service: SaveLoad
    purpose: Registered save data schemas

  save-load-cache:
    backend: redis
    prefix: "saveload:cache"
    service: SaveLoad
    purpose: Recently accessed save data cache

  save-load-pending:
    backend: redis
    prefix: "saveload:pending"
    service: SaveLoad
    purpose: Pending save operations

  # ============================================================================
  # MySQL Stores - Durable/Queryable Data
  # ============================================================================

  account-statestore:
    backend: mysql
    service: Account
    purpose: Persistent account data

  character-statestore:
    backend: mysql
    service: Character
    purpose: Persistent character data

  character-lock:
    backend: redis
    prefix: "character:lock"
    service: Character
    purpose: Distributed locks for character update and compression operations

  character-history-statestore:
    backend: mysql
    service: CharacterHistory
    purpose: Character historical events and backstory

  character-personality-statestore:
    backend: mysql
    service: CharacterPersonality
    purpose: Character personality traits and combat preferences

  character-encounter-statestore:
    backend: mysql
    service: CharacterEncounter
    purpose: Encounter records and participant perspectives

  game-session-statestore:
    backend: mysql
    service: GameSession
    purpose: Game session state and history

  location-statestore:
    backend: mysql
    service: Location
    purpose: Location hierarchy and metadata

  location-cache:
    backend: redis
    prefix: "location"
    service: Location
    purpose: Location lookup cache for frequently-accessed locations

  location-lock:
    backend: redis
    prefix: "location:lock"
    service: Location
    purpose: Distributed locks for concurrent index modifications

  realm-statestore:
    backend: mysql
    service: Realm
    purpose: Realm definitions and configuration

  realm-history-statestore:
    backend: mysql
    service: RealmHistory
    purpose: Realm historical events and lore

  relationship-statestore:
    backend: mysql
    service: Relationship
    purpose: Entity relationships

  relationship-type-statestore:
    backend: mysql
    service: RelationshipType
    purpose: Relationship type definitions

  game-service-statestore:
    backend: mysql
    service: GameService
    purpose: Game service registry

  species-statestore:
    backend: mysql
    service: Species
    purpose: Species definitions

  subscription-statestore:
    backend: mysql
    service: Subscription
    purpose: User subscriptions to game services

  scene-statestore:
    backend: mysql
    service: Scene
    purpose: Hierarchical scene composition storage

  # ============================================================================
  # Redis Stores - Spatial/Mapping Data
  # ============================================================================

  mapping-statestore:
    backend: redis
    prefix: mapping
    service: Mapping
    purpose: Spatial map data and channels

  # ============================================================================
  # Orchestrator - Primary Store
  # ============================================================================

  orchestrator-statestore:
    backend: redis
    prefix: orch
    service: Orchestrator
    purpose: Primary orchestrator state

  # ============================================================================
  # Mesh Stores - Service Endpoint Discovery
  # ============================================================================

  mesh-endpoints:
    backend: redis
    prefix: "mesh:endpoint"
    service: Mesh
    purpose: Service endpoint registration and health status

  mesh-appid-index:
    backend: redis
    prefix: "mesh:appid"
    service: Mesh
    purpose: App-ID to instance-ID mapping index

  mesh-global-index:
    backend: redis
    prefix: "mesh:idx"
    service: Mesh
    purpose: Global endpoint index for discovery

  mesh-circuit-breaker:
    backend: redis
    prefix: "mesh:cb"
    service: Mesh
    purpose: Distributed circuit breaker state for cross-instance failure tracking

  # ============================================================================
  # Music Stores
  # ============================================================================

  music-styles:
    backend: mysql
    service: Music
    purpose: Style definitions (celtic, jazz, baroque, etc.)

  music-compositions:
    backend: redis
    prefix: "music:comp"
    service: Music
    purpose: Cached generated compositions

  # ============================================================================
  # Contract Stores
  # ============================================================================

  contract-statestore:
    backend: redis
    prefix: contract
    service: Contract
    purpose: Contract templates, instances, breaches, and indexes
    enableSearch: true

  # ============================================================================
  # Currency Stores
  # ============================================================================

  currency-balance-cache:
    backend: redis
    prefix: "currency:balance"
    service: Currency
    purpose: Real-time balance lookups (cached, refreshed on access)

  currency-idempotency:
    backend: redis
    prefix: "currency:idemp"
    service: Currency
    purpose: Idempotency key deduplication

  currency-holds-cache:
    backend: redis
    prefix: "currency:hold"
    service: Currency
    purpose: Authorization hold state for pre-auth scenarios

  currency-definitions:
    backend: mysql
    service: Currency
    purpose: Currency type definitions and behavior rules

  currency-wallets:
    backend: mysql
    service: Currency
    purpose: Wallet ownership and status

  currency-balances:
    backend: mysql
    service: Currency
    purpose: Currency balance records per wallet

  currency-transactions:
    backend: mysql
    service: Currency
    purpose: Immutable transaction history

  currency-holds:
    backend: mysql
    service: Currency
    purpose: Authorization hold records

  # ============================================================================
  # Item Stores
  # ============================================================================

  item-template-cache:
    backend: redis
    prefix: "item:tpl"
    service: Item
    purpose: Template lookup cache (global, aggressive caching)

  item-template-store:
    backend: mysql
    service: Item
    purpose: Item template definitions (persistent, queryable)

  item-instance-cache:
    backend: redis
    prefix: "item:inst"
    service: Item
    purpose: Hot item instance data for active gameplay

  item-instance-store:
    backend: mysql
    service: Item
    purpose: Item instances (persistent, realm-partitioned)

  item-lock:
    backend: redis
    prefix: "item:lock"
    service: Item
    purpose: Distributed locks for item instance modifications

  # ============================================================================
  # Inventory Stores
  # ============================================================================

  inventory-container-cache:
    backend: redis
    prefix: "inv:cont"
    service: Inventory
    purpose: Container state and item list cache

  inventory-container-store:
    backend: mysql
    service: Inventory
    purpose: Container definitions (persistent)

  inventory-lock:
    backend: redis
    prefix: "inv:lock"
    service: Inventory
    purpose: Distributed locks for concurrent modifications

  # ============================================================================
  # Escrow Stores
  # ============================================================================

  escrow-tokens:
    backend: redis
    prefix: "escrow:token"
    service: Escrow
    purpose: Token hash validation (hashed tokens to escrow/party info)

  escrow-idempotency:
    backend: redis
    prefix: "escrow:idemp"
    service: Escrow
    purpose: Idempotency key deduplication cache

  escrow-status-index:
    backend: redis
    prefix: "escrow:status"
    service: Escrow
    purpose: Escrow IDs by status (sorted set for expiration/validation)

  escrow-party-pending:
    backend: redis
    prefix: "escrow:pending"
    service: Escrow
    purpose: Count pending escrows per party for limits

  escrow-active-validation:
    backend: redis
    prefix: "escrow:validate"
    service: Escrow
    purpose: Track active escrows requiring periodic validation

  escrow-agreements:
    backend: mysql
    service: Escrow
    purpose: Main escrow agreement records

  escrow-handler-registry:
    backend: mysql
    service: Escrow
    purpose: Custom asset type handler registrations

  # ============================================================================
  # Resource Lifecycle Stores
  # ============================================================================

  resource-refcounts:
    backend: redis
    prefix: "resource:ref"
    service: Resource
    purpose: Reference counts and source tracking per resource

  resource-cleanup:
    backend: redis
    prefix: "resource:cleanup"
    service: Resource
    purpose: Cleanup callback definitions per resource type

  resource-grace:
    backend: redis
    prefix: "resource:grace"
    service: Resource
    purpose: Grace period timestamps for resources with zero references

  resource-compress:
    backend: redis
    prefix: "resource:compress"
    service: Resource
    purpose: Compression callback definitions and callback index sets

  resource-archives:
    backend: mysql
    service: Resource
    purpose: Compressed archive bundles (durable storage for long-term archival)
