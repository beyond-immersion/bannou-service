// <auto-generated>
// This file was generated by generate-permissions.sh from species-api.yaml
// Do not edit this file directly - changes will be overwritten.
// To modify permissions, edit x-permissions sections in the OpenAPI schema.
// </auto-generated>

#nullable enable

using BeyondImmersion.BannouService.Events;
using Dapr.Client;
using Microsoft.Extensions.Logging;

namespace BeyondImmersion.BannouService.Species;

/// <summary>
/// Generated permission registration for Species service.
/// Contains permission matrix extracted from x-permissions sections in OpenAPI schema.
/// </summary>
public static class SpeciesPermissionRegistration
{
    /// <summary>
    /// Service ID for permission registration.
    /// </summary>
    public const string ServiceId = "species";

    /// <summary>
    /// Service version from OpenAPI schema.
    /// </summary>
    public const string ServiceVersion = "1.0.0";

    /// <summary>
    /// Generates the ServiceRegistrationEvent containing all endpoint permissions.
    /// </summary>
    public static ServiceRegistrationEvent CreateRegistrationEvent()
    {
        return new ServiceRegistrationEvent
        {
            EventId = Guid.NewGuid().ToString(),
            Timestamp = DateTimeOffset.UtcNow,
            ServiceId = ServiceId,
            Version = ServiceVersion,
            AppId = Environment.GetEnvironmentVariable("DAPR_APP_ID") ?? "bannou",
            Endpoints = GetEndpoints()
        };
    }

    /// <summary>
    /// Gets the list of endpoints with their permission requirements.
    /// </summary>
    public static ICollection<ServiceEndpoint> GetEndpoints()
    {
        var endpoints = new List<ServiceEndpoint>();

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/species/get",
            Method = ServiceEndpointMethod.POST,
            Description = "getSpecies",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "user",
                    RequiredStates = new Dictionary<string, string> { {"auth", "authenticated"} }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/species/get-by-code",
            Method = ServiceEndpointMethod.POST,
            Description = "getSpeciesByCode",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "user",
                    RequiredStates = new Dictionary<string, string> { {"auth", "authenticated"} }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/species/list",
            Method = ServiceEndpointMethod.POST,
            Description = "listSpecies",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "user",
                    RequiredStates = new Dictionary<string, string> { {"auth", "authenticated"} }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/species/list-by-realm",
            Method = ServiceEndpointMethod.POST,
            Description = "listSpeciesByRealm",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "user",
                    RequiredStates = new Dictionary<string, string> { {"auth", "authenticated"} }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/species/create",
            Method = ServiceEndpointMethod.POST,
            Description = "createSpecies",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "admin",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/species/update",
            Method = ServiceEndpointMethod.POST,
            Description = "updateSpecies",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "admin",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/species/delete",
            Method = ServiceEndpointMethod.POST,
            Description = "deleteSpecies",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "admin",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/species/deprecate",
            Method = ServiceEndpointMethod.POST,
            Description = "deprecateSpecies",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "admin",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/species/undeprecate",
            Method = ServiceEndpointMethod.POST,
            Description = "undeprecateSpecies",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "admin",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/species/merge",
            Method = ServiceEndpointMethod.POST,
            Description = "mergeSpecies",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "admin",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/species/add-to-realm",
            Method = ServiceEndpointMethod.POST,
            Description = "addSpeciesToRealm",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "admin",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/species/remove-from-realm",
            Method = ServiceEndpointMethod.POST,
            Description = "removeSpeciesFromRealm",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "admin",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/species/seed",
            Method = ServiceEndpointMethod.POST,
            Description = "seedSpecies",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "admin",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        return endpoints;
    }

    /// <summary>
    /// Builds the permission matrix for RegisterServicePermissionsAsync.
    /// Key structure: state -> role -> list of methods
    /// </summary>
    public static Dictionary<string, IDictionary<string, ICollection<string>>> BuildPermissionMatrix()
    {
        var matrix = new Dictionary<string, IDictionary<string, ICollection<string>>>();

        foreach (var endpoint in GetEndpoints())
        {
            var methodKey = $"{endpoint.Method}:{endpoint.Path}";

            foreach (var permission in endpoint.Permissions)
            {
                // Determine state key - use "default" if no specific states required
                var stateKey = permission.RequiredStates.Count > 0
                    ? string.Join("|", permission.RequiredStates.Select(s => $"{s.Key}:{s.Value}"))
                    : "default";

                if (!matrix.TryGetValue(stateKey, out var roleMap))
                {
                    roleMap = new Dictionary<string, ICollection<string>>();
                    matrix[stateKey] = roleMap;
                }

                if (!roleMap.TryGetValue(permission.Role, out var methods))
                {
                    methods = new List<string>();
                    roleMap[permission.Role] = methods;
                }

                if (!methods.Contains(methodKey))
                {
                    methods.Add(methodKey);
                }
            }
        }

        return matrix;
    }

    /// <summary>
    /// Registers service permissions via event publishing.
    /// Should only be called after Dapr connectivity is confirmed.
    /// </summary>
    public static async Task RegisterViaEventAsync(DaprClient daprClient, ILogger? logger = null)
    {
        try
        {
            var registrationEvent = CreateRegistrationEvent();

            await daprClient.PublishEventAsync(
                "bannou-pubsub",
                "permissions.service-registered",
                registrationEvent);

            logger?.LogInformation(
                "Published service registration event for {ServiceId} v{Version} with {EndpointCount} endpoints",
                ServiceId, ServiceVersion, registrationEvent.Endpoints.Count);
        }
        catch (Exception ex)
        {
            logger?.LogError(ex, "Failed to publish service registration event for {ServiceId}", ServiceId);
            throw;
        }
    }

}
