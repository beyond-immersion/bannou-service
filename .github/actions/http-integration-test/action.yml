name: 'HTTP Integration Tests'
description: 'Run HTTP integration tests with coordinator service configuration'

runs:
  using: 'composite'
  steps:
    - name: Prepare Test Fixtures
      shell: bash
      run: |
        echo "ðŸ“ Preparing test fixtures (dot_git -> .git rename)..."
        ./scripts/prepare-test-fixtures.sh

    - name: Build HTTP Integration Services (All Services)
      shell: bash
      run: |
        echo "ðŸ”§ Building Docker image with all services for HTTP integration testing..."
        echo "ðŸ“‹ Service-to-service testing via mesh (no ingress - uses generated clients)..."
        docker compose -p bannou-ci-http \
          -f "./provisioning/docker-compose.yml" \
          -f "./provisioning/docker-compose.services.yml" \
          -f "./provisioning/docker-compose.test.yml" \
          -f "./provisioning/docker-compose.test.http.yml" \
          build

    - name: Execute HTTP Integration Tests
      shell: bash
      run: |
        echo "ðŸ”— Running HTTP integration tests via mesh service invocation..."
        # Start all services in detached mode
        docker compose -p bannou-ci-http \
          -f "./provisioning/docker-compose.yml" \
          -f "./provisioning/docker-compose.services.yml" \
          -f "./provisioning/docker-compose.test.yml" \
          -f "./provisioning/docker-compose.test.http.yml" \
          up -d

        # Stream test logs in background for visibility
        docker compose -p bannou-ci-http \
          -f "./provisioning/docker-compose.yml" \
          -f "./provisioning/docker-compose.services.yml" \
          -f "./provisioning/docker-compose.test.yml" \
          -f "./provisioning/docker-compose.test.http.yml" \
          logs -f bannou-http-tester &

        # Wait for the http-tester container to complete and capture its exit code
        # Using 'wait' instead of '--exit-code-from' to allow orchestrator tests
        # to create/destroy containers without aborting the test suite
        docker compose -p bannou-ci-http \
          -f "./provisioning/docker-compose.yml" \
          -f "./provisioning/docker-compose.services.yml" \
          -f "./provisioning/docker-compose.test.yml" \
          -f "./provisioning/docker-compose.test.http.yml" \
          wait bannou-http-tester

    - name: Dump Service Logs on Failure
      if: failure()
      shell: bash
      run: |
        echo "ðŸ“‹ Dumping all service logs for debugging..."
        echo "=== BANNOU SERVICE LOGS (ALL) ==="
        docker compose -p bannou-ci-http \
          -f "./provisioning/docker-compose.yml" \
          -f "./provisioning/docker-compose.services.yml" \
          -f "./provisioning/docker-compose.test.yml" \
          -f "./provisioning/docker-compose.test.http.yml" \
          logs bannou || echo "Failed to get bannou logs"
        echo ""
        echo "=== RABBITMQ LOGS (last 500) ==="
        docker compose -p bannou-ci-http \
          -f "./provisioning/docker-compose.yml" \
          -f "./provisioning/docker-compose.services.yml" \
          -f "./provisioning/docker-compose.test.yml" \
          -f "./provisioning/docker-compose.test.http.yml" \
          logs --tail=500 rabbitmq || echo "Failed to get rabbitmq logs"

    - name: Cleanup HTTP Integration Services
      if: always()
      shell: bash
      run: |
        echo "ðŸ›‘ Stopping integration testing services..."
        docker compose -p bannou-ci-http \
          -f "./provisioning/docker-compose.yml" \
          -f "./provisioning/docker-compose.services.yml" \
          -f "./provisioning/docker-compose.test.yml" \
          -f "./provisioning/docker-compose.test.http.yml" \
          down --remove-orphans -v
