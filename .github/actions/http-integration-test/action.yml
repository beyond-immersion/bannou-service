name: 'HTTP Integration Tests'
description: 'Run HTTP integration tests with coordinator service configuration'

runs:
  using: 'composite'
  steps:
    - name: Build HTTP Integration Services (All Services)
      shell: bash
      run: |
        echo "üîß Building Docker image with all services for HTTP integration testing..."
        echo "üìã Using .env.ci.http configuration for coordinator mode..."
        docker compose -p bannou-ci-http -f "./provisioning/docker-compose.yml" -f "./provisioning/docker-compose.ingress.yml" -f "./provisioning/docker-compose.ci.yml" -f "./provisioning/docker-compose.ci.http.yml" build

    - name: Start Coordinator Services for HTTP Integration Testing
      shell: bash
      run: |
        echo "üöÄ Starting coordinator services for HTTP integration testing..."
        echo "üìã Coordinator will manage test subject services as needed..."
        docker compose -p bannou-ci-http -f "./provisioning/docker-compose.yml" -f "./provisioning/docker-compose.ingress.yml" -f "./provisioning/docker-compose.ci.yml"  -f "./provisioning/docker-compose.ci.http.yml" up -d
        echo "‚è≥ Waiting for coordinator services to be ready..."
        sleep 30

    - name: Execute HTTP Integration Tests
      shell: bash
      run: |
        echo "üîó Running HTTP integration tests with generated client types..."
        DAEMON_MODE=true dotnet run --project http-tester --configuration Release --no-build

    - name: Cleanup HTTP Integration Services
      if: always()
      shell: bash
      run: |
        echo "üõë Stopping integration testing services..."
        docker compose -p bannou-ci-http -f "./provisioning/docker-compose.yml" -f "./provisioning/docker-compose.ingress.yml" -f "./provisioning/docker-compose.ci.yml" -f "./provisioning/docker-compose.ci.http.yml" down --remove-orphans -v
