name: 'WebSocket Backward Compatibility Tests'
description: 'Run WebSocket tests with published NuGet SDK for backward compatibility'

runs:
  using: 'composite'
  steps:
    - name: Start WebSocket Services
      shell: bash
      run: |
        echo "üìã Using .env.test.edge configuration for backward-compatibility WebSocket testing..."
        docker compose -p bannou-ci-edge \
          -f "./provisioning/docker-compose.yml" \
          -f "./provisioning/docker-compose.services.yml" \
          -f "./provisioning/docker-compose.ingress.yml" \
          -f "./provisioning/docker-compose.test.yml" \
          -f "./provisioning/docker-compose.test.edge.yml" \
          up -d

        echo "‚è≥ Waiting for WebSocket services to be ready..."
        sleep 30

    - name: Check Published SDK Availability
      id: check-sdk
      shell: bash
      run: |
        echo "üîç Checking if BeyondImmersion.Bannou.Client.SDK is published..."
        if dotnet restore edge-tester -p:UsePublishedSDK=true --verbosity quiet 2>/dev/null; then
          echo "sdk_available=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Published SDK found - running backward compatibility tests"
        else
          echo "sdk_available=false" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è No published SDK found on NuGet.org - skipping backward compatibility tests"
          echo "This is expected for the first release. Tests will run after initial SDK publication."
        fi

    - name: Build Edge Tester with Published SDK
      if: steps.check-sdk.outputs.sdk_available == 'true'
      shell: bash
      run: |
        echo "üîß Building edge-tester with published NuGet dependency..."
        dotnet build edge-tester --configuration Release -p:UsePublishedSDK=true --no-dependencies

    - name: Execute WebSocket Backward Compatibility Tests
      if: steps.check-sdk.outputs.sdk_available == 'true'
      shell: bash
      run: |
        echo "üì° Running WebSocket tests with published NuGet SDK (backwards compatibility)..."
        # Source .env.test.edge to get client configuration (endpoints, credentials)
        # Using set -a / set +a pattern to automatically export sourced variables
        set -a && source .env.test.edge && set +a
        # Override Docker hostnames with localhost for CI host access
        # (edge-tester runs on CI host, not in Docker, so it needs localhost)
        # OpenResty maps internal port 80 to host port 9080 (see docker-compose.ingress.yml)
        export OPENRESTY_HOST=localhost
        export OPENRESTY_PORT=9080
        export REGISTER_ENDPOINT=localhost:9080/auth/register
        export LOGIN_CREDENTIALS_ENDPOINT=localhost:9080/auth/login
        export LOGIN_TOKEN_ENDPOINT=localhost:9080/auth/refresh
        export CONNECT_ENDPOINT=localhost:9080/connect
        DAEMON_MODE=true dotnet run --project edge-tester --configuration Release --no-build

    - name: Dump Service Logs on Failure
      if: failure()
      shell: bash
      run: |
        echo "üìã Dumping all service logs for debugging..."
        echo "=== BANNOU SERVICE LOGS (ALL) ==="
        docker compose -p bannou-ci-edge \
          -f "./provisioning/docker-compose.yml" \
          -f "./provisioning/docker-compose.services.yml" \
          -f "./provisioning/docker-compose.ingress.yml" \
          -f "./provisioning/docker-compose.test.yml" \
          -f "./provisioning/docker-compose.test.edge.yml" \
          logs bannou || echo "Failed to get bannou logs"
        echo ""
        echo "=== OPENRESTY LOGS (last 500) ==="
        docker compose -p bannou-ci-edge \
          -f "./provisioning/docker-compose.yml" \
          -f "./provisioning/docker-compose.services.yml" \
          -f "./provisioning/docker-compose.ingress.yml" \
          -f "./provisioning/docker-compose.test.yml" \
          -f "./provisioning/docker-compose.test.edge.yml" \
          logs --tail=500 openresty || echo "Failed to get openresty logs"
        echo ""
        echo "=== RABBITMQ LOGS (last 500) ==="
        docker compose -p bannou-ci-edge \
          -f "./provisioning/docker-compose.yml" \
          -f "./provisioning/docker-compose.services.yml" \
          -f "./provisioning/docker-compose.ingress.yml" \
          -f "./provisioning/docker-compose.test.yml" \
          -f "./provisioning/docker-compose.test.edge.yml" \
          logs --tail=500 rabbitmq || echo "Failed to get rabbitmq logs"

    - name: Skip Notice
      if: steps.check-sdk.outputs.sdk_available != 'true'
      shell: bash
      run: |
        echo "‚è≠Ô∏è WebSocket backward compatibility tests skipped - no published SDK available yet"
        echo "Forward compatibility tests will validate the current SDK functionality"
