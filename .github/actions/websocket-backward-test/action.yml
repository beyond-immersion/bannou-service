name: 'WebSocket Backward Compatibility Tests'
description: 'Run WebSocket tests with published NuGet SDK for backward compatibility'

runs:
  using: 'composite'
  steps:
    - name: Check Published SDK Availability
      id: check-sdk
      shell: bash
      run: |
        echo "üîç Checking if BeyondImmersion.Bannou.Client is published..."
        if dotnet restore edge-tester -p:UsePublishedSDK=true --verbosity quiet 2>/dev/null; then
          echo "sdk_available=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Published SDK found - running backward compatibility tests"
        else
          echo "sdk_available=false" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è No published SDK found on NuGet.org - skipping backward compatibility tests"
          echo "This is expected for the first release. Tests will run after initial SDK publication."
        fi

    - name: Build Edge Tester Container with Published SDK
      if: steps.check-sdk.outputs.sdk_available == 'true'
      shell: bash
      run: |
        echo "üìã Using .env.test.edge configuration for backward-compatibility WebSocket testing..."
        echo "üîß Building edge-tester container with published SDK (UsePublishedSDK=true)..."
        docker compose -p bannou-ci-edge \
          -f "./provisioning/docker-compose.yml" \
          -f "./provisioning/docker-compose.services.yml" \
          -f "./provisioning/docker-compose.storage.yml" \
          -f "./provisioning/docker-compose.ingress.yml" \
          -f "./provisioning/docker-compose.test.yml" \
          -f "./provisioning/docker-compose.test.edge.yml" \
          build bannou-edge-tester --build-arg UsePublishedSDK=true

    - name: Execute WebSocket Backward Compatibility Tests
      if: steps.check-sdk.outputs.sdk_available == 'true'
      shell: bash
      run: |
        echo "üì° Running WebSocket tests with published NuGet SDK (backwards compatibility)..."
        # Start all services in detached mode
        docker compose -p bannou-ci-edge \
          -f "./provisioning/docker-compose.yml" \
          -f "./provisioning/docker-compose.services.yml" \
          -f "./provisioning/docker-compose.storage.yml" \
          -f "./provisioning/docker-compose.ingress.yml" \
          -f "./provisioning/docker-compose.test.yml" \
          -f "./provisioning/docker-compose.test.edge.yml" \
          up -d

        # Stream test logs in background for visibility
        docker compose -p bannou-ci-edge \
          -f "./provisioning/docker-compose.yml" \
          -f "./provisioning/docker-compose.services.yml" \
          -f "./provisioning/docker-compose.storage.yml" \
          -f "./provisioning/docker-compose.ingress.yml" \
          -f "./provisioning/docker-compose.test.yml" \
          -f "./provisioning/docker-compose.test.edge.yml" \
          logs -f bannou-edge-tester &

        # Wait for the edge-tester container to complete and capture its exit code
        docker compose -p bannou-ci-edge \
          -f "./provisioning/docker-compose.yml" \
          -f "./provisioning/docker-compose.services.yml" \
          -f "./provisioning/docker-compose.storage.yml" \
          -f "./provisioning/docker-compose.ingress.yml" \
          -f "./provisioning/docker-compose.test.yml" \
          -f "./provisioning/docker-compose.test.edge.yml" \
          wait bannou-edge-tester

    - name: Dump Service Logs on Failure
      if: failure()
      shell: bash
      run: |
        echo "üìã Dumping all service logs for debugging..."
        echo "=== BANNOU SERVICE LOGS (ALL) ==="
        docker compose -p bannou-ci-edge \
          -f "./provisioning/docker-compose.yml" \
          -f "./provisioning/docker-compose.services.yml" \
          -f "./provisioning/docker-compose.storage.yml" \
          -f "./provisioning/docker-compose.ingress.yml" \
          -f "./provisioning/docker-compose.test.yml" \
          -f "./provisioning/docker-compose.test.edge.yml" \
          logs bannou || echo "Failed to get bannou logs"
        echo ""
        echo "=== OPENRESTY LOGS (last 500) ==="
        docker compose -p bannou-ci-edge \
          -f "./provisioning/docker-compose.yml" \
          -f "./provisioning/docker-compose.services.yml" \
          -f "./provisioning/docker-compose.storage.yml" \
          -f "./provisioning/docker-compose.ingress.yml" \
          -f "./provisioning/docker-compose.test.yml" \
          -f "./provisioning/docker-compose.test.edge.yml" \
          logs --tail=500 openresty || echo "Failed to get openresty logs"
        echo ""
        echo "=== RABBITMQ LOGS (last 500) ==="
        docker compose -p bannou-ci-edge \
          -f "./provisioning/docker-compose.yml" \
          -f "./provisioning/docker-compose.services.yml" \
          -f "./provisioning/docker-compose.storage.yml" \
          -f "./provisioning/docker-compose.ingress.yml" \
          -f "./provisioning/docker-compose.test.yml" \
          -f "./provisioning/docker-compose.test.edge.yml" \
          logs --tail=500 rabbitmq || echo "Failed to get rabbitmq logs"

    - name: Cleanup Containers
      if: always() && steps.check-sdk.outputs.sdk_available == 'true'
      shell: bash
      run: |
        echo "üõë Cleaning up backward compatibility test services..."
        docker compose -p bannou-ci-edge \
          -f "./provisioning/docker-compose.yml" \
          -f "./provisioning/docker-compose.services.yml" \
          -f "./provisioning/docker-compose.storage.yml" \
          -f "./provisioning/docker-compose.ingress.yml" \
          -f "./provisioning/docker-compose.test.yml" \
          -f "./provisioning/docker-compose.test.edge.yml" \
          down --remove-orphans -v || echo "Cleanup completed (some resources may not have existed)"

    - name: Skip Notice
      if: steps.check-sdk.outputs.sdk_available != 'true'
      shell: bash
      run: |
        echo "‚è≠Ô∏è WebSocket backward compatibility tests skipped - no published SDK available yet"
        echo "Forward compatibility tests will validate the current SDK functionality"
