name: 'WebSocket Forward Compatibility Tests'
description: 'Run WebSocket tests with current generated SDK for forward compatibility'

runs:
  using: 'composite'
  steps:
    - name: Build and Start WebSocket Services
      shell: bash
      run: |
        echo "ðŸ“‹ Using .env.test.edge configuration for forward-compatibility WebSocket testing..."
        export DAPR_COMPONENTS_HOST_PATH="$(pwd)/provisioning/dapr/components-http-test"
        echo "DAPR_COMPONENTS_HOST_PATH=${DAPR_COMPONENTS_HOST_PATH}"
        echo "ðŸ”§ Building edge-tester container with current SDK (UsePublishedSDK=false)..."
        docker compose -p bannou-ci-edge \
          -f "./provisioning/docker-compose.yml" \
          -f "./provisioning/docker-compose.services.yml" \
          -f "./provisioning/docker-compose.ingress.yml" \
          -f "./provisioning/docker-compose.test.yml" \
          -f "./provisioning/docker-compose.test.edge.yml" \
          build bannou-edge-tester --build-arg UsePublishedSDK=false

    - name: Execute WebSocket Forward Compatibility Tests
      shell: bash
      run: |
        echo "ðŸš€ Running WebSocket tests with current generated SDK (forward compatibility)..."
        export DAPR_COMPONENTS_HOST_PATH="$(pwd)/provisioning/dapr/components-http-test"
        echo "DAPR_COMPONENTS_HOST_PATH=${DAPR_COMPONENTS_HOST_PATH}"
        # Start all services in detached mode
        docker compose -p bannou-ci-edge \
          -f "./provisioning/docker-compose.yml" \
          -f "./provisioning/docker-compose.services.yml" \
          -f "./provisioning/docker-compose.ingress.yml" \
          -f "./provisioning/docker-compose.test.yml" \
          -f "./provisioning/docker-compose.test.edge.yml" \
          up -d

        # Stream test logs in background for visibility
        docker compose -p bannou-ci-edge \
          -f "./provisioning/docker-compose.yml" \
          -f "./provisioning/docker-compose.services.yml" \
          -f "./provisioning/docker-compose.ingress.yml" \
          -f "./provisioning/docker-compose.test.yml" \
          -f "./provisioning/docker-compose.test.edge.yml" \
          logs -f bannou-edge-tester &

        # Wait for the edge-tester container to complete and capture its exit code
        docker compose -p bannou-ci-edge \
          -f "./provisioning/docker-compose.yml" \
          -f "./provisioning/docker-compose.services.yml" \
          -f "./provisioning/docker-compose.ingress.yml" \
          -f "./provisioning/docker-compose.test.yml" \
          -f "./provisioning/docker-compose.test.edge.yml" \
          wait bannou-edge-tester

    - name: Dump Service Logs on Failure
      if: failure()
      shell: bash
      run: |
        echo "ðŸ“‹ Dumping all service logs for debugging..."
        echo "=== BANNOU SERVICE LOGS (ALL) ==="
        docker compose -p bannou-ci-edge \
          -f "./provisioning/docker-compose.yml" \
          -f "./provisioning/docker-compose.services.yml" \
          -f "./provisioning/docker-compose.ingress.yml" \
          -f "./provisioning/docker-compose.test.yml" \
          -f "./provisioning/docker-compose.test.edge.yml" \
          logs bannou || echo "Failed to get bannou logs"
        echo ""
        echo "=== OPENRESTY LOGS (last 500) ==="
        docker compose -p bannou-ci-edge \
          -f "./provisioning/docker-compose.yml" \
          -f "./provisioning/docker-compose.services.yml" \
          -f "./provisioning/docker-compose.ingress.yml" \
          -f "./provisioning/docker-compose.test.yml" \
          -f "./provisioning/docker-compose.test.edge.yml" \
          logs --tail=500 openresty || echo "Failed to get openresty logs"
        echo ""
        echo "=== RABBITMQ LOGS (last 500) ==="
        docker compose -p bannou-ci-edge \
          -f "./provisioning/docker-compose.yml" \
          -f "./provisioning/docker-compose.services.yml" \
          -f "./provisioning/docker-compose.ingress.yml" \
          -f "./provisioning/docker-compose.test.yml" \
          -f "./provisioning/docker-compose.test.edge.yml" \
          logs --tail=500 rabbitmq || echo "Failed to get rabbitmq logs"

    - name: Final Cleanup
      if: always()
      shell: bash
      run: |
        echo "ðŸ›‘ Final cleanup of all integration testing services..."
        docker compose -p bannou-ci-edge \
          -f "./provisioning/docker-compose.yml" \
          -f "./provisioning/docker-compose.services.yml" \
          -f "./provisioning/docker-compose.ingress.yml" \
          -f "./provisioning/docker-compose.test.yml" \
          -f "./provisioning/docker-compose.test.edge.yml" \
          down --remove-orphans -v

        echo "ðŸ§¹ Cleaning up Docker resources..."
        docker container prune -f
        docker image prune -f
        docker volume prune -f
