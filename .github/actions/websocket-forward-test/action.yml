name: 'WebSocket Forward Compatibility Tests'
description: 'Run WebSocket tests with current generated SDK for forward compatibility'

runs:
  using: 'composite'
  steps:
    - name: Build and Start WebSocket Services
      shell: bash
      run: |
        echo "ðŸ“‹ Using .env.test.edge configuration for forward-compatibility WebSocket testing..."
        echo "ðŸ”§ Building edge-tester container with current SDK (UsePublishedSDK=false)..."
        docker compose -p bannou-ci-edge \
          -f "./provisioning/docker-compose.yml" \
          -f "./provisioning/docker-compose.services.yml" \
          -f "./provisioning/docker-compose.ingress.yml" \
          -f "./provisioning/docker-compose.test.yml" \
          -f "./provisioning/docker-compose.test.edge.yml" \
          build bannou-edge-tester --build-arg UsePublishedSDK=false

    - name: Execute WebSocket Forward Compatibility Tests
      shell: bash
      run: |
        echo "ðŸš€ Running WebSocket tests with current generated SDK (forward compatibility)..."
        # Start all services in detached mode
        docker compose -p bannou-ci-edge \
          -f "./provisioning/docker-compose.yml" \
          -f "./provisioning/docker-compose.services.yml" \
          -f "./provisioning/docker-compose.ingress.yml" \
          -f "./provisioning/docker-compose.test.yml" \
          -f "./provisioning/docker-compose.test.edge.yml" \
          up -d

        # Stream test logs in background for visibility
        docker compose -p bannou-ci-edge \
          -f "./provisioning/docker-compose.yml" \
          -f "./provisioning/docker-compose.services.yml" \
          -f "./provisioning/docker-compose.ingress.yml" \
          -f "./provisioning/docker-compose.test.yml" \
          -f "./provisioning/docker-compose.test.edge.yml" \
          logs -f bannou-edge-tester &

        # Wait for the edge-tester container to complete and capture its exit code
        docker compose -p bannou-ci-edge \
          -f "./provisioning/docker-compose.yml" \
          -f "./provisioning/docker-compose.services.yml" \
          -f "./provisioning/docker-compose.ingress.yml" \
          -f "./provisioning/docker-compose.test.yml" \
          -f "./provisioning/docker-compose.test.edge.yml" \
          wait bannou-edge-tester

    - name: Dump Service Logs and Network Info
      if: failure()
      shell: bash
      run: |
        echo "ðŸ“‹ Dumping all service logs and network information for debugging..."

        echo ""
        echo "=== DOCKER PS SNAPSHOT ==="
        docker ps -a --format 'table {{.Names}}\t{{.Status}}\t{{.Networks}}\t{{.Ports}}'

        echo ""
        echo "=== DOCKER NETWORKS ==="
        docker network ls

        echo ""
        echo "=== BANNOU NETWORK INSPECTION ==="
        # Find and inspect any network containing 'bannou' or 'edge'
        for net in $(docker network ls --format '{{.Name}}' | grep -E 'bannou|edge'); do
          echo "--- Network: $net ---"
          docker network inspect "$net" --format '{{range .Containers}}{{.Name}}: {{.IPv4Address}}{{"\n"}}{{end}}' || true
        done

        echo ""
        echo "=== BANNOU SERVICE LOGS (last 1000 lines) ==="
        docker compose -p bannou-ci-edge \
          -f "./provisioning/docker-compose.yml" \
          -f "./provisioning/docker-compose.services.yml" \
          -f "./provisioning/docker-compose.ingress.yml" \
          -f "./provisioning/docker-compose.test.yml" \
          -f "./provisioning/docker-compose.test.edge.yml" \
          logs --tail=1000 bannou || echo "Failed to get bannou logs"

        echo ""
        echo "=== OPENRESTY LOGS (last 500) ==="
        docker compose -p bannou-ci-edge \
          -f "./provisioning/docker-compose.yml" \
          -f "./provisioning/docker-compose.services.yml" \
          -f "./provisioning/docker-compose.ingress.yml" \
          -f "./provisioning/docker-compose.test.yml" \
          -f "./provisioning/docker-compose.test.edge.yml" \
          logs --tail=500 openresty || echo "Failed to get openresty logs"

        echo ""
        echo "=== RABBITMQ LOGS (last 200) ==="
        docker compose -p bannou-ci-edge \
          -f "./provisioning/docker-compose.yml" \
          -f "./provisioning/docker-compose.services.yml" \
          -f "./provisioning/docker-compose.ingress.yml" \
          -f "./provisioning/docker-compose.test.yml" \
          -f "./provisioning/docker-compose.test.edge.yml" \
          logs --tail=200 rabbitmq || echo "Failed to get rabbitmq logs"

        echo ""
        echo "=== ORCHESTRATOR DEPLOYED CONTAINERS ==="
        for c in $(docker ps -a --format '{{.Names}}' | grep -E '^bannou-bannou|^bannou-main|^bannou-auth|^bannou-edge'); do
          echo "--- logs for $c ---"
          docker logs --tail=300 "$c" 2>&1 || true
        done

        echo ""
        echo "=== CONTAINER HEALTH STATUS ==="
        docker ps -a --format '{{.Names}}\t{{.Status}}' | grep -E 'bannou|redis|rabbit' || true

    - name: Final Cleanup
      if: always()
      shell: bash
      run: |
        echo "ðŸ›‘ Final cleanup of all integration testing services..."
        docker compose -p bannou-ci-edge \
          -f "./provisioning/docker-compose.yml" \
          -f "./provisioning/docker-compose.services.yml" \
          -f "./provisioning/docker-compose.ingress.yml" \
          -f "./provisioning/docker-compose.test.yml" \
          -f "./provisioning/docker-compose.test.edge.yml" \
          down --remove-orphans -v

        echo "ðŸ§¹ Cleaning up Docker resources..."
        docker container prune -f
        docker image prune -f
        docker volume prune -f
