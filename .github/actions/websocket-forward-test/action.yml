name: 'WebSocket Forward Compatibility Tests'
description: 'Run WebSocket tests with current generated SDK for forward compatibility'

runs:
  using: 'composite'
  steps:
    - name: Ensure WebSocket Services Running
      shell: bash
      run: |
        echo "üìã Using .env.test.edge configuration for forward-compatibility WebSocket testing..."
        docker compose -p bannou-ci-edge \
          -f "./provisioning/docker-compose.yml" \
          -f "./provisioning/docker-compose.services.yml" \
          -f "./provisioning/docker-compose.ingress.yml" \
          -f "./provisioning/docker-compose.test.yml" \
          -f "./provisioning/docker-compose.test.edge.yml" \
          ps

        echo "‚è≥ Waiting for services to be fully ready..."
        sleep 15

    - name: Build SDK and Edge Tester with Current SDK
      shell: bash
      run: |
        echo "üîß Building Client SDK first..."
        dotnet build Bannou.Client.SDK --configuration Release
        echo "üîß Building edge-tester with current generated SDK..."
        dotnet build edge-tester --configuration Release -p:UseCurrentSDK=true

    - name: Execute WebSocket Forward Compatibility Tests
      shell: bash
      run: |
        echo "üöÄ Running WebSocket tests with current generated SDK (forward compatibility)..."
        # Source .env.test.edge to get client configuration (endpoints, credentials)
        # Using set -a / set +a pattern to automatically export sourced variables
        set -a && source .env.test.edge && set +a
        # Override Docker hostnames with localhost for CI host access
        # (edge-tester runs on CI host, not in Docker, so it needs localhost)
        # OpenResty maps internal port 80 to host port 9080 (see docker-compose.ingress.yml)
        export OPENRESTY_HOST=localhost
        export OPENRESTY_PORT=9080
        export REGISTER_ENDPOINT=localhost:9080/auth/register
        export LOGIN_CREDENTIALS_ENDPOINT=localhost:9080/auth/login
        export LOGIN_TOKEN_ENDPOINT=localhost:9080/auth/refresh
        export CONNECT_ENDPOINT=localhost:9080/connect
        DAEMON_MODE=true dotnet run --project edge-tester --configuration Release --no-build

    - name: Final Cleanup
      if: always()
      shell: bash
      run: |
        echo "üõë Final cleanup of all integration testing services..."
        docker compose -p bannou-ci-edge \
          -f "./provisioning/docker-compose.yml" \
          -f "./provisioning/docker-compose.services.yml" \
          -f "./provisioning/docker-compose.ingress.yml" \
          -f "./provisioning/docker-compose.test.yml" \
          -f "./provisioning/docker-compose.test.edge.yml" \
          down --remove-orphans -v

        echo "üßπ Cleaning up Docker resources..."
        docker container prune -f
        docker image prune -f
        docker volume prune -f
