name: 'Infrastructure Integration Tests'
description: 'Run infrastructure tests with minimal service configuration (TESTING service only)'

runs:
  using: 'composite'
  steps:
    - name: Install Docker Compose
      shell: bash
      run: |
        echo "üê≥ Installing Docker Compose for infrastructure testing..."
        sudo apt-get update
        sudo apt-get install -y docker-compose

    - name: Build Infrastructure Image (TESTING service only)
      shell: bash
      run: |
        echo "üîß Building Docker image with TESTING service only..."
        docker compose -p bannou-ci-infra -f "./provisioning/docker-compose.yml" -f "./provisioning/docker-compose.ingress.yml" -f "./provisioning/docker-compose.ci.yml" -f "./provisioning/docker-compose.ci.infrastructure.yml" build

    - name: Execute Infrastructure Tests
      shell: bash
      run: |
        echo "üèóÔ∏è Running infrastructure tests with minimal service configuration (TESTING service only)..."
        docker compose -p bannou-ci-infra -f "./provisioning/docker-compose.yml" -f "./provisioning/docker-compose.ingress.yml"  -f "./provisioning/docker-compose.ci.yml" -f "./provisioning/docker-compose.ci.infrastructure.yml" up --exit-code-from=bannou-tester

    - name: Cleanup Infrastructure Tests
      if: always()
      shell: bash
      run: |
        echo "üõë Stopping infrastructure testing containers..."
        docker compose -p bannou-ci-infra -f "./provisioning/docker-compose.yml" -f "./provisioning/docker-compose.ingress.yml" -f "./provisioning/docker-compose.ci.yml" -f "./provisioning/docker-compose.ci.infrastructure.yml" down --remove-orphans -v
