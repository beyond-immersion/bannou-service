name: 'Infrastructure Integration Tests'
description: 'Run infrastructure tests with minimal service configuration (TESTING service only)'

runs:
  using: 'composite'
  steps:
    - name: Install Docker Compose
      shell: bash
      run: |
        echo "üê≥ Installing Docker Compose for infrastructure testing..."
        sudo apt-get update
        sudo apt-get install -y docker-compose

    - name: Build Infrastructure Image (TESTING service only)
      shell: bash
      run: |
        echo "üîß Building minimal infrastructure (TESTING service only - no databases, no ingress)..."
        docker compose -p bannou-ci-infra \
          -f "./provisioning/docker-compose.yml" \
          -f "./provisioning/docker-compose.test.yml" \
          -f "./provisioning/docker-compose.test.infrastructure.yml" \
          build

    - name: Execute Infrastructure Tests
      shell: bash
      run: |
        echo "üèóÔ∏è Running minimal infrastructure tests (bannou + dapr + placement + rabbitmq)..."
        docker compose -p bannou-ci-infra \
          -f "./provisioning/docker-compose.yml" \
          -f "./provisioning/docker-compose.test.yml" \
          -f "./provisioning/docker-compose.test.infrastructure.yml" \
          up --exit-code-from=bannou-infra-tester

    - name: Cleanup Infrastructure Tests
      if: always()
      shell: bash
      run: |
        echo "üõë Stopping infrastructure testing containers..."
        docker compose -p bannou-ci-infra \
          -f "./provisioning/docker-compose.yml" \
          -f "./provisioning/docker-compose.test.yml" \
          -f "./provisioning/docker-compose.test.infrastructure.yml" \
          down --remove-orphans -v
