name: 'SDK Preview Auto-Publish'

# Automatically publishes preview SDK packages when PRs are merged to master.
# Tests have already passed in the PR (required by branch protection), so this
# workflow only builds and publishes - no redundant test execution.
on:
  push:
    branches: [master]

env:
  DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
  DOTNET_VERSION: '9.0.x'

jobs:
  publish-preview:
    name: Build and Publish SDK Preview
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore NuGet Packages
        run: dotnet restore

      - name: Build Solution
        run: dotnet build --configuration Release --no-restore

      - name: Build and Pack SDK Previews
        id: pack
        run: |
          # Read base version from SDK_VERSION file (represents last stable release)
          SDK_VERSION=$(cat sdks/SDK_VERSION | tr -d '[:space:]')

          # Add patch bump so previews are always higher than the last stable release
          # e.g., SDK_VERSION=1.0.0 â†’ preview base=1.0.1 â†’ 1.0.1-preview.X > 1.0.0 stable
          IFS='.' read -r MAJOR MINOR PATCH <<< "$SDK_VERSION"
          PREVIEW_BASE="${MAJOR}.${MINOR}.$((PATCH + 1))"
          PREVIEW_VERSION="${PREVIEW_BASE}-preview.${{ github.run_number }}"

          echo "sdk_version=${SDK_VERSION}" >> $GITHUB_OUTPUT
          echo "preview_version=${PREVIEW_VERSION}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Building and packing SDKs v${PREVIEW_VERSION} (pre-release)..."
          echo "  SDK_VERSION (last stable): ${SDK_VERSION}"
          echo "  Preview version: ${PREVIEW_VERSION}"

          # Define all packable SDK projects (order matters - dependencies first)
          SDK_PROJECTS=(
            # Foundation packages (no Bannou dependencies)
            "sdks/core"
            "sdks/protocol"
            # Packages with foundation dependencies
            "sdks/transport"
            "sdks/bundle-format"
            # Public SDK packages
            "sdks/server"
            "sdks/client"
            "sdks/client-voice"
            "sdks/scene-composer"
            "sdks/scene-composer-stride"
            "sdks/scene-composer-godot"
            "sdks/asset-bundler"
            "sdks/asset-bundler-stride"
            "sdks/asset-bundler-godot"
            "sdks/asset-loader"
            "sdks/asset-loader-client"
            "sdks/asset-loader-server"
            "sdks/asset-loader-stride"
            "sdks/asset-loader-godot"
          )

          for PROJECT in "${SDK_PROJECTS[@]}"; do
            PROJECT_NAME=$(basename "$PROJECT")
            echo "ðŸ“¦ Building ${PROJECT_NAME}..."
            dotnet restore "$PROJECT"
            dotnet build "$PROJECT" --configuration Release --no-restore
            dotnet pack "$PROJECT" --configuration Release -p:PackageVersion=${PREVIEW_VERSION} --output ./nuget-packages --no-build
          done

          echo "âœ… Packages built:"
          ls -la ./nuget-packages/

      - name: Publish Previews to NuGet
        run: |
          echo "ðŸš€ Publishing preview v${{ steps.pack.outputs.preview_version }} to NuGet.org..."
          dotnet nuget push ./nuget-packages/*.nupkg \
            --api-key ${{ secrets.NUGET_API_KEY }} \
            --source https://api.nuget.org/v3/index.json \
            --skip-duplicate
          echo "âœ… Preview packages published!"
          echo "Pre-release packages are not installed by default - users must explicitly opt-in"

      - name: Get Commit Info
        if: always()
        run: |
          {
            echo "COMMIT_MESSAGE<<EOF"
            git log -1 --pretty=%B
            echo "EOF"
          } >> $GITHUB_ENV
          echo "COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an')" >> $GITHUB_ENV

      - name: Notify Discord
        if: always() && env.DISCORD_WEBHOOK != ''
        uses: ./.github/actions/discord-notify
        with:
          webhook-url: ${{ env.DISCORD_WEBHOOK }}
          stage-name: "SDK Preview v${{ steps.pack.outputs.preview_version }}"
          status: ${{ job.status }}
          commit-message: ${{ env.COMMIT_MESSAGE }}
          commit-author: ${{ env.COMMIT_AUTHOR }}
          run-url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          repository-url: ${{ github.server_url }}/${{ github.repository }}
