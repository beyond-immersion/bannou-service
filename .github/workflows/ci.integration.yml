name: 'Bannou Integration Pipeline'

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:

# Discord webhook for notifications (secrets only needed for Discord)
env:
  DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

jobs:
  integration-pipeline:
    name: Sequential Integration Testing
    runs-on: ubuntu-latest

    steps:
      # Initial setup and notification
      - name: Setup Bannou Environment
        id: setup
        uses: ./.github/actions/setup-bannou
        with:
          dotnet-version: '9.0.x'

      - name: Notify Pipeline Start
        uses: ./.github/actions/discord-notify
        with:
          webhook-url: ${{ env.DISCORD_WEBHOOK }}
          stage-name: "Integration Pipeline Started"
          status: "success"
          commit-message: ${{ steps.setup.outputs.commit-message }}
          commit-author: ${{ steps.setup.outputs.commit-author }}
          run-url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          repository-url: ${{ github.server_url }}/${{ github.repository }}

      # Unit Tests
      - name: Unit Tests
        run: |
          echo "ðŸ§ª Running unit tests..."
          dotnet test --configuration Release --no-build

      - name: Notify Unit Tests Result
        if: always()
        uses: ./.github/actions/discord-notify
        with:
          webhook-url: ${{ env.DISCORD_WEBHOOK }}
          stage-name: "Unit Tests"
          status: ${{ job.status }}
          commit-message: ${{ steps.setup.outputs.commit-message }}
          commit-author: ${{ steps.setup.outputs.commit-author }}
          run-url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          repository-url: ${{ github.server_url }}/${{ github.repository }}

      # Infrastructure Tests (minimal dependencies - still uses secrets for security)
      - name: Infrastructure Tests
        if: success()
        uses: ./.github/actions/infrastructure-test

      - name: Notify Infrastructure Tests Result
        if: always() && steps.setup.conclusion == 'success'
        uses: ./.github/actions/discord-notify
        with:
          webhook-url: ${{ env.DISCORD_WEBHOOK }}
          stage-name: "Infrastructure Tests"
          status: ${{ job.status }}
          commit-message: ${{ steps.setup.outputs.commit-message }}
          commit-author: ${{ steps.setup.outputs.commit-author }}
          run-url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          repository-url: ${{ github.server_url }}/${{ github.repository }}

      # HTTP Integration Tests (coordinator mode with .env.ci.http)
      - name: HTTP Integration Tests
        if: success()
        uses: ./.github/actions/http-integration-test

      - name: Notify HTTP Integration Tests Result
        if: always() && steps.setup.conclusion == 'success'
        uses: ./.github/actions/discord-notify
        with:
          webhook-url: ${{ env.DISCORD_WEBHOOK }}
          stage-name: "HTTP Integration Tests"
          status: ${{ job.status }}
          commit-message: ${{ steps.setup.outputs.commit-message }}
          commit-author: ${{ steps.setup.outputs.commit-author }}
          run-url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          repository-url: ${{ github.server_url }}/${{ github.repository }}

      # WebSocket Backward Compatibility Tests (coordinator mode with .env.ci.edge)
      - name: WebSocket Backward Compatibility Tests
        if: success()
        uses: ./.github/actions/websocket-backward-test

      - name: Notify WebSocket Backward Tests Result
        if: always() && steps.setup.conclusion == 'success'
        uses: ./.github/actions/discord-notify
        with:
          webhook-url: ${{ env.DISCORD_WEBHOOK }}
          stage-name: "WebSocket Backward Compatibility"
          status: ${{ job.status }}
          commit-message: ${{ steps.setup.outputs.commit-message }}
          commit-author: ${{ steps.setup.outputs.commit-author }}
          run-url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          repository-url: ${{ github.server_url }}/${{ github.repository }}

      # WebSocket Forward Compatibility Tests (reuses .env.ci.edge configuration)
      - name: WebSocket Forward Compatibility Tests
        if: success()
        uses: ./.github/actions/websocket-forward-test

      - name: Notify WebSocket Forward Tests Result
        if: always() && steps.setup.conclusion == 'success'
        uses: ./.github/actions/discord-notify
        with:
          webhook-url: ${{ env.DISCORD_WEBHOOK }}
          stage-name: "WebSocket Forward Compatibility"
          status: ${{ job.status }}
          commit-message: ${{ steps.setup.outputs.commit-message }}
          commit-author: ${{ steps.setup.outputs.commit-author }}
          run-url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          repository-url: ${{ github.server_url }}/${{ github.repository }}

      # NuGet Publishing (only on master branch success)
      - name: Calculate Semantic Version
        if: success() && github.ref == 'refs/heads/master' && github.event_name == 'push'
        id: version
        uses: mathieudutour/github-tag-action@v6.1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          default_bump: patch
          dry_run: false

      - name: Build and Pack Client SDK for Release
        if: success() && github.ref == 'refs/heads/master' && github.event_name == 'push'
        run: |
          echo "ðŸ“¦ Building and packing Client SDK v${{ steps.version.outputs.new_version }}..."
          dotnet build Bannou.Client.SDK --configuration Release --no-dependencies
          dotnet pack Bannou.Client.SDK --configuration Release -p:PackageVersion=${{ steps.version.outputs.new_version }} --output ./nuget-packages --no-build

      - name: Publish to NuGet
        if: success() && github.ref == 'refs/heads/master' && github.event_name == 'push'
        run: |
          echo "ðŸš€ Publishing to NuGet.org..."
          dotnet nuget push ./nuget-packages/*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate

      - name: Notify Pipeline Complete
        if: always() && steps.setup.conclusion == 'success'
        uses: ./.github/actions/discord-notify
        with:
          webhook-url: ${{ env.DISCORD_WEBHOOK }}
          stage-name: "Integration Pipeline Complete"
          status: ${{ job.status }}
          commit-message: ${{ steps.setup.outputs.commit-message }}
          commit-author: ${{ steps.setup.outputs.commit-author }}
          run-url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          repository-url: ${{ github.server_url }}/${{ github.repository }}
