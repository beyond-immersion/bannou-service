name: 'Bannou Integration Pipeline'

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:

# Discord webhook for notifications (secrets only needed for Discord)
env:
  DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

jobs:
  integration-pipeline:
    name: Sequential Integration Testing
    runs-on: ubuntu-latest

    steps:
      # Must checkout first to access local actions
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Initial setup and notification
      - name: Setup Bannou Environment
        id: setup
        uses: ./.github/actions/setup-bannou
        with:
          dotnet-version: '9.0.x'

      - name: Notify Pipeline Start
        uses: ./.github/actions/discord-notify
        with:
          webhook-url: ${{ env.DISCORD_WEBHOOK }}
          stage-name: "Integration Pipeline Started"
          status: "success"
          commit-message: ${{ steps.setup.outputs.commit-message }}
          commit-author: ${{ steps.setup.outputs.commit-author }}
          run-url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          repository-url: ${{ github.server_url }}/${{ github.repository }}

      # Unit Tests
      - name: Unit Tests
        run: |
          echo "ðŸ§ª Running unit tests..."
          dotnet test --configuration Release --no-build

      - name: Notify Unit Tests Result
        if: always()
        uses: ./.github/actions/discord-notify
        with:
          webhook-url: ${{ env.DISCORD_WEBHOOK }}
          stage-name: "Unit Tests"
          status: ${{ job.status }}
          commit-message: ${{ steps.setup.outputs.commit-message }}
          commit-author: ${{ steps.setup.outputs.commit-author }}
          run-url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          repository-url: ${{ github.server_url }}/${{ github.repository }}

      # Infrastructure Tests (minimal dependencies - still uses secrets for security)
      - name: Infrastructure Tests
        if: success()
        uses: ./.github/actions/infrastructure-test

      - name: Notify Infrastructure Tests Result
        if: always() && steps.setup.conclusion == 'success'
        uses: ./.github/actions/discord-notify
        with:
          webhook-url: ${{ env.DISCORD_WEBHOOK }}
          stage-name: "Infrastructure Tests"
          status: ${{ job.status }}
          commit-message: ${{ steps.setup.outputs.commit-message }}
          commit-author: ${{ steps.setup.outputs.commit-author }}
          run-url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          repository-url: ${{ github.server_url }}/${{ github.repository }}

      # HTTP Integration Tests (coordinator mode with .env.ci.http)
      - name: HTTP Integration Tests
        if: success()
        uses: ./.github/actions/http-integration-test

      - name: Notify HTTP Integration Tests Result
        if: always() && steps.setup.conclusion == 'success'
        uses: ./.github/actions/discord-notify
        with:
          webhook-url: ${{ env.DISCORD_WEBHOOK }}
          stage-name: "HTTP Integration Tests"
          status: ${{ job.status }}
          commit-message: ${{ steps.setup.outputs.commit-message }}
          commit-author: ${{ steps.setup.outputs.commit-author }}
          run-url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          repository-url: ${{ github.server_url }}/${{ github.repository }}

      # WebSocket Backward Compatibility Tests (coordinator mode with .env.ci.edge)
      - name: WebSocket Backward Compatibility Tests
        if: success()
        uses: ./.github/actions/websocket-backward-test

      - name: Notify WebSocket Backward Tests Result
        if: always() && steps.setup.conclusion == 'success'
        uses: ./.github/actions/discord-notify
        with:
          webhook-url: ${{ env.DISCORD_WEBHOOK }}
          stage-name: "WebSocket Backward Compatibility"
          status: ${{ job.status }}
          commit-message: ${{ steps.setup.outputs.commit-message }}
          commit-author: ${{ steps.setup.outputs.commit-author }}
          run-url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          repository-url: ${{ github.server_url }}/${{ github.repository }}

      # WebSocket Forward Compatibility Tests (reuses .env.ci.edge configuration)
      - name: WebSocket Forward Compatibility Tests
        if: success()
        uses: ./.github/actions/websocket-forward-test

      - name: Notify WebSocket Forward Tests Result
        if: always() && steps.setup.conclusion == 'success'
        uses: ./.github/actions/discord-notify
        with:
          webhook-url: ${{ env.DISCORD_WEBHOOK }}
          stage-name: "WebSocket Forward Compatibility"
          status: ${{ job.status }}
          commit-message: ${{ steps.setup.outputs.commit-message }}
          commit-author: ${{ steps.setup.outputs.commit-author }}
          run-url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          repository-url: ${{ github.server_url }}/${{ github.repository }}

      # NuGet Pre-Release Publishing (only on master branch success)
      # Publishes preview packages for staging/testing
      # Stable releases are handled by ci.sdk-release.yml workflow
      - name: Build and Pack SDK Previews
        if: success() && github.ref == 'refs/heads/master' && github.event_name == 'push'
        id: pack
        run: |
          # Read base version from SDK_VERSION file (in repo root)
          BASE_VERSION=$(cat SDK_VERSION | tr -d '[:space:]')
          PREVIEW_VERSION="${BASE_VERSION}-preview.${{ github.run_number }}"
          echo "ðŸ“¦ Building and packing SDKs v${PREVIEW_VERSION} (pre-release)..."
          echo "preview_version=${PREVIEW_VERSION}" >> $GITHUB_OUTPUT
          echo "base_version=${BASE_VERSION}" >> $GITHUB_OUTPUT

          # Build and pack Server SDK (Bannou.SDK)
          echo "ðŸ“¦ Building Server SDK (Bannou.SDK)..."
          dotnet build Bannou.SDK --configuration Release --no-dependencies
          dotnet pack Bannou.SDK --configuration Release -p:PackageVersion=${PREVIEW_VERSION} --output ./nuget-packages --no-build

          # Build and pack Client SDK (Bannou.Client.SDK)
          echo "ðŸ“¦ Building Client SDK (Bannou.Client.SDK)..."
          dotnet build Bannou.Client.SDK --configuration Release --no-dependencies
          dotnet pack Bannou.Client.SDK --configuration Release -p:PackageVersion=${PREVIEW_VERSION} --output ./nuget-packages --no-build

      - name: Publish Previews to NuGet
        if: success() && github.ref == 'refs/heads/master' && github.event_name == 'push'
        run: |
          echo "ðŸš€ Publishing preview v${{ steps.pack.outputs.preview_version }} to NuGet.org..."
          dotnet nuget push ./nuget-packages/*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate
          echo "âœ… Preview packages published:"
          echo "   â€¢ BeyondImmersion.Bannou.SDK (Server SDK - with ServiceClients + Dapr)"
          echo "   â€¢ BeyondImmersion.Bannou.Client.SDK (Client SDK - WebSocket only)"
          echo "   Pre-release packages are not installed by default - users must explicitly opt-in"

      - name: Notify Pipeline Complete
        if: always() && steps.setup.conclusion == 'success'
        uses: ./.github/actions/discord-notify
        with:
          webhook-url: ${{ env.DISCORD_WEBHOOK }}
          stage-name: "Integration Pipeline Complete"
          status: ${{ job.status }}
          commit-message: ${{ steps.setup.outputs.commit-message }}
          commit-author: ${{ steps.setup.outputs.commit-author }}
          run-url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          repository-url: ${{ github.server_url }}/${{ github.repository }}
