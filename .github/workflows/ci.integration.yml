name: 'Comprehensive CI Pipeline'

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:

jobs:

  comprehensive-tests:
    name: Comprehensive Testing Pipeline
    runs-on: ubuntu-latest
    env:
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      ACCOUNT_DB_USER: ${{ secrets.ACCOUNT_DB_USER }}
      ACCOUNT_DB_PASSWORD: ${{ secrets.ACCOUNT_DB_PASSWORD }}
      AUTH_TOKEN_PUBLIC_KEY: ${{ secrets.AUTH_TOKEN_PUBLIC_KEY }}
      AUTH_TOKEN_PRIVATE_KEY: ${{ secrets.AUTH_TOKEN_PRIVATE_KEY }}

    steps:
      - uses: actions/checkout@v4
        name: Checkout Repo
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Restore NuGet Packages
        run: |
          echo "ðŸ“¦ Restoring NuGet packages (including NSwag.MSBuild)..."
          dotnet restore

      - name: Install NSwag Global Tool (Fallback)
        run: |
          echo "ðŸ”§ Installing NSwag as global tool (fallback for CI environments)..."
          dotnet tool install --global NSwag.ConsoleCore --version 14.2.0 || echo "NSwag tool already installed or MSBuild package sufficient"

      # Step 1: Generate Services - Ensure all controllers/models are current
      - name: 1ï¸âƒ£ Generate Services (Initial)
        run: |
          echo "ðŸ”§ Generating all service controllers, models, and clients..."
          scripts/generate-all-services.sh
          
      # Step 2: Generate SDK - Create client SDK from current service definitions
      - name: 2ï¸âƒ£ Generate Client SDK (Initial) 
        run: |
          echo "ðŸ“¦ Generating Client SDK from current services..."
          scripts/generate-client-sdk.sh
          
      # Step 3: Build - Compile everything with fresh generated code
      - name: 3ï¸âƒ£ Build All Projects
        run: |
          echo "ðŸ—ï¸ Building all projects with generated code..."
          dotnet build --configuration Release
          
      # Step 4: Unit Tests - Test individual components
      - name: 6ï¸âƒ£ Unit Tests
        run: |
          echo "ðŸ§ª Running unit tests..."
          dotnet test --configuration Release --no-build
          
      # Step 5: Infrastructure Tests - integration tests with minimal service dependencies (TESTING service only)
      - name: 7ï¸âƒ£ Infrastructure Tests (Setup)
        run: |
          echo "ðŸ³ Installing Docker Compose for infrastructure testing..."
          sudo apt-get update
          sudo apt-get install -y docker-compose

      - name: 7ï¸âƒ£ Infrastructure Tests (Build with TESTING service only)
        env:
          ACCOUNT_DB_USER: ${{ secrets.ACCOUNT_DB_USER }}
          ACCOUNT_DB_PASSWORD: ${{ secrets.ACCOUNT_DB_PASSWORD }}
          AUTH_TOKEN_PUBLIC_KEY: ${{ secrets.AUTH_TOKEN_PUBLIC_KEY }}
          AUTH_TOKEN_PRIVATE_KEY: ${{ secrets.AUTH_TOKEN_PRIVATE_KEY }}
        run: |
          echo "ðŸ”§ Building Docker image with TESTING service only..."
          # Create .env file if not exists for environment variables
          if [ ! -f .env ]; then touch .env; fi

          # Build Docker image with only TESTING service to minimize dependencies
          docker compose --env-file ./.env -p bannou-ci-infra -f "./provisioning/docker-compose.yml" -f "./provisioning/docker-compose.ci.yml" -f "./provisioning/docker-compose.ingress.yml" -f "./provisioning/docker-compose.infrastructure.yml" build --build-arg BANNOU_SERVICES="testing"

      - name: 7ï¸âƒ£ Infrastructure Tests (Execution)
        env:
          ACCOUNT_DB_USER: ${{ secrets.ACCOUNT_DB_USER }}
          ACCOUNT_DB_PASSWORD: ${{ secrets.ACCOUNT_DB_PASSWORD }}
          AUTH_TOKEN_PUBLIC_KEY: ${{ secrets.AUTH_TOKEN_PUBLIC_KEY }}
          AUTH_TOKEN_PRIVATE_KEY: ${{ secrets.AUTH_TOKEN_PRIVATE_KEY }}
        run: |
          echo "ðŸ—ï¸ Running infrastructure tests with minimal service configuration (TESTING service only)..."
          # Create .env file if not exists for environment variables
          if [ ! -f .env ]; then touch .env; fi

          # Use infrastructure configuration to test only TESTING service (minimal dependencies)
          docker compose --env-file ./.env -p bannou-ci-infra -f "./provisioning/docker-compose.yml" -f "./provisioning/docker-compose.ci.yml" -f "./provisioning/docker-compose.ingress.yml" -f "./provisioning/docker-compose.infrastructure.yml" up --exit-code-from=bannou-tester

          # Stop containers after infrastructure tests
          echo "ðŸ›‘ Stopping containers after infrastructure tests..."
          docker compose -p bannou-ci-infra -f "./provisioning/docker-compose.yml" -f "./provisioning/docker-compose.ci.yml" -f "./provisioning/docker-compose.ingress.yml" -f "./provisioning/docker-compose.infrastructure.yml" down --remove-orphans -v

      # Step 6: Start Services for Integration Testing - full service configuration for HTTP/WebSocket tests
      - name: 8ï¸âƒ£ Build Services for Integration Testing (All Services)
        env:
          ACCOUNT_DB_USER: ${{ secrets.ACCOUNT_DB_USER }}
          ACCOUNT_DB_PASSWORD: ${{ secrets.ACCOUNT_DB_PASSWORD }}
          AUTH_TOKEN_PUBLIC_KEY: ${{ secrets.AUTH_TOKEN_PUBLIC_KEY }}
          AUTH_TOKEN_PRIVATE_KEY: ${{ secrets.AUTH_TOKEN_PRIVATE_KEY }}
        run: |
          echo "ðŸ”§ Building Docker image with all services for integration testing..."
          # Create .env file if not exists for environment variables
          if [ ! -f .env ]; then touch .env; fi

          # Build Docker image with all services (no BANNOU_SERVICES restriction)
          docker compose --env-file ./.env -p bannou-ci-integration -f "./provisioning/docker-compose.yml" -f "./provisioning/docker-compose.ci.yml" -f "./provisioning/docker-compose.ingress.yml" build

      - name: 8ï¸âƒ£ Start Services for Integration Testing
        env:
          ACCOUNT_DB_USER: ${{ secrets.ACCOUNT_DB_USER }}
          ACCOUNT_DB_PASSWORD: ${{ secrets.ACCOUNT_DB_PASSWORD }}
          AUTH_TOKEN_PUBLIC_KEY: ${{ secrets.AUTH_TOKEN_PUBLIC_KEY }}
          AUTH_TOKEN_PRIVATE_KEY: ${{ secrets.AUTH_TOKEN_PRIVATE_KEY }}
        run: |
          echo "ðŸš€ Starting services with full configuration for integration testing..."
          # Create .env file if not exists for environment variables
          if [ ! -f .env ]; then touch .env; fi

          # Start services with default configuration (all services enabled)
          docker compose --env-file ./.env -p bannou-ci-integration -f "./provisioning/docker-compose.yml" -f "./provisioning/docker-compose.ci.yml" -f "./provisioning/docker-compose.ingress.yml" up -d

          # Wait for services to be ready
          echo "â³ Waiting for services to be ready..."
          sleep 30

      # Step 7: HTTP Integration Tests - http-tester app using newly generated client types
      - name: 9ï¸âƒ£ HTTP Integration Tests (Generated Clients)
        run: |
          echo "ðŸ”— Running HTTP integration tests with generated client types..."
          DAEMON_MODE=true dotnet run --project http-tester --configuration Release --no-build

      # Step 8: WebSocket Integration Tests (Backwards Compatibility) - edge-tester app using published NuGet
      - name: ðŸ”Ÿ WebSocket Tests (Backwards Compatibility - Published SDK)
        run: |
          echo "ðŸ“¡ Running WebSocket tests with published NuGet SDK (backwards compatibility)..."
          # Build edge-tester with published NuGet dependency
          dotnet build edge-tester --configuration Release -p:UsePublishedSDK=true --no-dependencies
          DAEMON_MODE=true dotnet run --project edge-tester --configuration Release --no-build

      # Step 9: WebSocket Integration Tests (Forward Compatibility) - edge-tester app using current SDK
      - name: 1ï¸âƒ£1ï¸âƒ£ WebSocket Tests (Forward Compatibility - Current SDK)
        run: |
          echo "ðŸš€ Running WebSocket tests with current generated SDK (forward compatibility)..."
          # Build edge-tester with current generated SDK
          dotnet build edge-tester --configuration Release -p:UseCurrentSDK=true --no-dependencies
          DAEMON_MODE=true dotnet run --project edge-tester --configuration Release --no-build

      # Step 10: Stop Integration Testing Services
      - name: 1ï¸âƒ£2ï¸âƒ£ Stop Integration Testing Services
        if: always()
        run: |
          echo "ðŸ›‘ Stopping integration testing services..."
          docker compose -p bannou-ci-integration -f "./provisioning/docker-compose.yml" -f "./provisioning/docker-compose.ci.yml" -f "./provisioning/docker-compose.ingress.yml" down --remove-orphans -v
          
      - name: Docker Cleanup
        if: always()
        continue-on-error: true
        run: |
          echo "ðŸ§¹ Cleaning up all Docker resources..."
          # Clean up infrastructure testing containers (if any remain)
          docker compose -p bannou-ci-infra -f "./provisioning/docker-compose.yml" -f "./provisioning/docker-compose.ci.yml" -f "./provisioning/docker-compose.ingress.yml" -f "./provisioning/docker-compose.infrastructure.yml" down --remove-orphans -v 2>/dev/null || true
          # Clean up integration testing containers (if any remain)
          docker compose -p bannou-ci-integration -f "./provisioning/docker-compose.yml" -f "./provisioning/docker-compose.ci.yml" -f "./provisioning/docker-compose.ingress.yml" down --remove-orphans -v 2>/dev/null || true
          # General cleanup
          docker container prune -f
          docker image prune -f
          docker volume prune -f

      # NuGet Publishing Pipeline - only runs on master branch success with production environment
      - name: Calculate Semantic Version
        if: success() && github.ref == 'refs/heads/master' && github.event_name == 'push'
        id: version
        uses: mathieudutour/github-tag-action@v6.1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          default_bump: patch
          dry_run: false
          
      - name: ðŸ“¦ Build and Pack Client SDK for Release
        if: success() && github.ref == 'refs/heads/master' && github.event_name == 'push'
        run: |
          echo "ðŸ“¦ Building and packing Client SDK v${{ steps.version.outputs.new_version }}..."
          dotnet build Bannou.Client.SDK --configuration Release --no-dependencies
          dotnet pack Bannou.Client.SDK --configuration Release -p:PackageVersion=${{ steps.version.outputs.new_version }} --output ./nuget-packages --no-build
          
      - name: ðŸš€ Publish to NuGet (Production Environment)
        if: success() && github.ref == 'refs/heads/master' && github.event_name == 'push'
        run: |
          echo "ðŸš€ Publishing to NuGet.org with production environment restrictions..."
          dotnet nuget push ./nuget-packages/*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate

      - name: Get Latest Commit Info
        id: commit_info
        run: |
          {
            echo "COMMIT_MESSAGE<<EOF"
            git log -1 --pretty=%B
            echo "EOF"
          } >> $GITHUB_ENV
          echo "COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an')" >> $GITHUB_ENV
          echo "COMMIT_AUTHOR_EMAIL=$(git log -1 --pretty=format:'%ae')" >> $GITHUB_ENV

      - name: Notify Success
        if: success() && env.DISCORD_WEBHOOK != ''
        uses: tsickert/discord-webhook@v7.0.0
        continue-on-error: true
        with:
          webhook-url: ${{ env.DISCORD_WEBHOOK }}
          username: "GitHub Actions"
          content: |
            **:white_check_mark: Integration Tests Passed Successfully**
            - **Action Run:** [View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - **Author:** ${{ env.COMMIT_AUTHOR }}
            - **Commit Message:** ${{ env.COMMIT_MESSAGE }}
            [Repository](${{ github.server_url }}/${{ github.repository }})
          avatar-url: "https://commons.wikimedia.org/wiki/File:Allowed.svg"
          embed-title: "Success: Integration Tests"
          embed-url: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          embed-description: ":white_check_mark: The integration tests have passed successfully."
          embed-author-name: "${{ env.COMMIT_AUTHOR }}"
          embed-author-icon-url: "https://commons.wikimedia.org/wiki/File:Allowed.svg"
          embed-author-url: "${{ github.server_url }}/${{ github.repository }}"
          embed-footer-text: "Commit Message: ${{ env.COMMIT_MESSAGE }}"
          embed-color: 15430476
          embed-timestamp: "${{ steps.ml.outputs.time }}"

      - name: Notify Failure
        if: failure() && env.DISCORD_WEBHOOK != ''
        uses: tsickert/discord-webhook@v7.0.0
        continue-on-error: true
        with:
          webhook-url: ${{ env.DISCORD_WEBHOOK }}
          username: "GitHub Actions"
          content: |
            **:x: Integration Tests Failed**
            - **Action Run:** [View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - **Author:** ${{ env.COMMIT_AUTHOR }}
            - **Commit Message:** ${{ env.COMMIT_MESSAGE }}
            [Repository](${{ github.server_url }}/${{ github.repository }})
          avatar-url: "https://commons.wikimedia.org/wiki/File:Heavy_red_%22x%22.png"
          embed-title: "Failed: Integration Tests"
          embed-url: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          embed-description: ":x: The integration tests have failed."
          embed-author-name: "${{ env.COMMIT_AUTHOR }}"
          embed-author-icon-url: "https://commons.wikimedia.org/wiki/File:Heavy_red_%22x%22.png"
          embed-author-url: "${{ github.server_url }}/${{ github.repository }}"
          embed-footer-text: "Commit Message: ${{ env.COMMIT_MESSAGE }}"
          embed-color: 15430476
          embed-timestamp: "${{ steps.ml.outputs.time }}"

      - name: Notify Cancelled
        if: cancelled() && env.DISCORD_WEBHOOK != ''
        uses: tsickert/discord-webhook@v7.0.0
        continue-on-error: true
        with:
          webhook-url: ${{ env.DISCORD_WEBHOOK }}
          username: "GitHub Actions"
          content: |
            **:warning: Integration Tests Cancelled**
            - **Action Run:** [View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - **Author:** ${{ env.COMMIT_AUTHOR }}
            - **Commit Message:** ${{ env.COMMIT_MESSAGE }}
            [Repository](${{ github.server_url }}/${{ github.repository }})
          avatar-url: "https://commons.wikimedia.org/wiki/File:Heavy_red_%22x%22.png"
          embed-title: "Cancelled: Integration Tests"
          embed-url: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          embed-description: ":warning: The integration tests have been cancelled."
          embed-author-name: "${{ env.COMMIT_AUTHOR }}"
          embed-author-icon-url: "https://commons.wikimedia.org/wiki/File:Heavy_red_%22x%22.png"
          embed-author-url: "${{ github.server_url }}/${{ github.repository }}"
          embed-footer-text: "Commit Message: ${{ env.COMMIT_MESSAGE }}"
          embed-color: 15430476
          embed-timestamp: "${{ steps.ml.outputs.time }}"
