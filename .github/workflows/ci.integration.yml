name: 'Integration Tests'

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:

jobs:

  integration-tests:
    name: Integration Tests
    runs-on: [self-hosted, bannou]
    env:
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      ACCOUNT_DB_USER: ${{ secrets.ACCOUNT_DB_USER }}
      ACCOUNT_DB_PASSWORD: ${{ secrets.ACCOUNT_DB_PASSWORD }}
      AUTH_TOKEN_PUBLIC_KEY: ${{ secrets.AUTH_TOKEN_PUBLIC_KEY }}
      AUTH_TOKEN_PRIVATE_KEY: ${{ secrets.AUTH_TOKEN_PRIVATE_KEY }}

    steps:
      - uses: actions/checkout@v3
        name: Checkout Repo

      - name: Set UID and GID
        run: |
          echo "UID=$(id -u)" >> $GITHUB_ENV
          echo "GID=$(id -g)" >> $GITHUB_ENV

      - name: Try to create docker-in-docker CI environment
        run: |
          if [ ! "$(docker ps -q -f name=dind)" ]; then
            if [ "$(docker ps -aq -f status=exited -f name=dind)" ]; then
              docker rm dind
            fi
            docker run --privileged --name dind --detach \
              --volume dind-vol:/var/lib/docker \
              docker:dind
          fi

      - name: Get DinD IP address
        id: dind_ip
        run: echo "::set-output name=ip::$(docker inspect -f '{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}' dind)"

      - name: Set DOCKER_HOST Environment Variable
        run: echo "DOCKER_HOST=tcp://${{ steps.dind_ip.outputs.ip }}:2375" >> $GITHUB_ENV

      - name: Rebuild Services
        run: docker-compose -H tcp://localhost:2375 -p bannou-tests -f "./provisioning/docker-compose.yml" -f "./provisioning/docker-compose.ci.yml" build --no-cache --pull

      - name: Run Integration Tests
        run: docker-compose -H tcp://localhost:2375 -p bannou-tests -f "./provisioning/docker-compose.yml" -f "./provisioning/docker-compose.ci.yml" up --exit-code-from=bannou-tester

      - name: Cleanup
        if: always()
        continue-on-error: true
        run: docker-compose -H tcp://localhost:2375 -p bannou-tests -f "./provisioning/docker-compose.yml" -f "./provisioning/docker-compose.ci.yml" down --remove-orphans -v &&
            docker container prune -f &&
            docker image prune -f &&
            docker volume prune -f

      - name: Notify Success
        if: success() && env.DISCORD_WEBHOOK != ''
        uses: rjstone/discord-webhook-notify@v1
        continue-on-error: true
        with:
          webhookUrl: ${{ env.DISCORD_WEBHOOK }}
          details: 'The integration tests have passed successfully.'
          severity: info

      - name: Notify Failure
        if: failure() && env.DISCORD_WEBHOOK != ''
        uses: rjstone/discord-webhook-notify@v1
        continue-on-error: true
        with:
          webhookUrl: ${{ env.DISCORD_WEBHOOK }}
          details: 'The integration tests have failed. Check the Actions log for more details.'
          severity: error

      - name: Notify Cancelled
        if: cancelled() && env.DISCORD_WEBHOOK != ''
        uses: rjstone/discord-webhook-notify@v1
        continue-on-error: true
        with:
          webhookUrl: ${{ env.DISCORD_WEBHOOK }}
          details: 'The integration tests have been cancelled.'
          severity: warn
