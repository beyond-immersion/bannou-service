//----------------------
// <auto-generated>
//     Generated from OpenAPI schema: schemas/messaging-configuration.yaml
//
//     WARNING: DO NOT EDIT THIS FILE (FOUNDATION TENETS)
//     This file is auto-generated from configuration schema.
//     Any manual changes will be overwritten on next generation.
//
//     To add/modify configuration:
//     1. Edit the source schema (schemas/messaging-configuration.yaml)
//     2. Run: scripts/generate-all-services.sh
//
//     IMPLEMENTATION TENETS - Configuration-First:
//     - Access configuration via dependency injection, never Environment.GetEnvironmentVariable.
//     - ALL properties below MUST be referenced somewhere in the plugin (no dead config).
//     - Any hardcoded tunable (limit, timeout, threshold, capacity) in service code means
//       a configuration property is MISSING - add it to the configuration schema.
//     - If a property is unused, remove it from the configuration schema.
//
//     Example: public MyService(MessagingServiceConfiguration config) { _config = config; }
//
//     See: docs/reference/tenets/IMPLEMENTATION.md (Configuration-First, Internal Model Type Safety)
// </auto-generated>
//----------------------

using System.ComponentModel.DataAnnotations;
using BeyondImmersion.BannouService;
using BeyondImmersion.BannouService.Attributes;
using BeyondImmersion.BannouService.Configuration;

#nullable enable

namespace BeyondImmersion.BannouService.Messaging;

/// <summary>
/// Configuration class for Messaging service.
/// Properties are automatically bound from environment variables.
/// </summary>
/// <remarks>
/// <para>
/// <b>IMPLEMENTATION TENETS - Configuration-First:</b> Access configuration via dependency injection.
/// Never use <c>Environment.GetEnvironmentVariable()</c> directly in service code.
/// ALL properties in this class MUST be referenced somewhere in the plugin.
/// If a property is unused, remove it from the configuration schema.
/// </para>
/// <para>
/// Environment variable names follow the pattern: {SERVICE}_{PROPERTY} (e.g., AUTH_JWT_SECRET).
/// </para>
/// </remarks>
[ServiceConfiguration(typeof(MessagingService))]
public class MessagingServiceConfiguration : BaseServiceConfiguration
{

    /// <summary>
    /// Use in-memory messaging instead of RabbitMQ. Messages are NOT persisted. ONLY for testing/minimal infrastructure.
    /// Environment variable: MESSAGING_USE_INMEMORY
    /// </summary>
    public bool UseInMemory { get; set; } = false;

    /// <summary>
    /// RabbitMQ server hostname
    /// Environment variable: MESSAGING_RABBITMQ_HOST
    /// </summary>
    [ConfigStringLength(MinLength = 1)]
    public string RabbitMQHost { get; set; } = "rabbitmq";

    /// <summary>
    /// RabbitMQ server port
    /// Environment variable: MESSAGING_RABBITMQ_PORT
    /// </summary>
    [ConfigRange(Minimum = 1, Maximum = 65535)]
    public int RabbitMQPort { get; set; } = 5672;

    /// <summary>
    /// RabbitMQ username
    /// Environment variable: MESSAGING_RABBITMQ_USERNAME
    /// </summary>
    public string RabbitMQUsername { get; set; } = "guest";

    /// <summary>
    /// RabbitMQ password
    /// Environment variable: MESSAGING_RABBITMQ_PASSWORD
    /// </summary>
    public string RabbitMQPassword { get; set; } = "guest";

    /// <summary>
    /// RabbitMQ virtual host
    /// Environment variable: MESSAGING_RABBITMQ_VHOST
    /// </summary>
    public string RabbitMQVirtualHost { get; set; } = "/";

    /// <summary>
    /// Default exchange name for publishing
    /// Environment variable: MESSAGING_DEFAULT_EXCHANGE
    /// </summary>
    [ConfigStringLength(MinLength = 1)]
    public string DefaultExchange { get; set; } = AppConstants.DEFAULT_APP_NAME;

    /// <summary>
    /// Enable RabbitMQ publisher confirms for reliability. When enabled, BasicPublishAsync waits for broker confirmation (RabbitMQ.Client 7.x pattern).
    /// Environment variable: MESSAGING_ENABLE_PUBLISHER_CONFIRMS
    /// </summary>
    public bool EnablePublisherConfirms { get; set; } = true;

    /// <summary>
    /// Number of connection retry attempts
    /// Environment variable: MESSAGING_CONNECTION_RETRY_COUNT
    /// </summary>
    [ConfigRange(Minimum = 0, Maximum = 100)]
    public int ConnectionRetryCount { get; set; } = 5;

    /// <summary>
    /// Delay between connection retry attempts in milliseconds
    /// Environment variable: MESSAGING_CONNECTION_RETRY_DELAY_MS
    /// </summary>
    [ConfigRange(Minimum = 100, Maximum = 30000)]
    public int ConnectionRetryDelayMs { get; set; } = 1000;

    /// <summary>
    /// Maximum backoff delay for connection retries in milliseconds
    /// Environment variable: MESSAGING_CONNECTION_MAX_BACKOFF_MS
    /// </summary>
    [ConfigRange(Minimum = 1000, Maximum = 300000)]
    public int ConnectionMaxBackoffMs { get; set; } = 60000;

    /// <summary>
    /// Maximum number of channels in the publisher channel pool
    /// Environment variable: MESSAGING_CHANNEL_POOL_SIZE
    /// </summary>
    [ConfigRange(Minimum = 10, Maximum = 500)]
    public int ChannelPoolSize { get; set; } = 100;

    /// <summary>
    /// Maximum concurrent channel creation requests (backpressure semaphore count)
    /// Environment variable: MESSAGING_MAX_CONCURRENT_CHANNEL_CREATION
    /// </summary>
    [ConfigRange(Minimum = 10, Maximum = 200)]
    public int MaxConcurrentChannelCreation { get; set; } = 50;

    /// <summary>
    /// Hard limit on total active channels per connection (RabbitMQ typically allows 2048)
    /// Environment variable: MESSAGING_MAX_TOTAL_CHANNELS
    /// </summary>
    [ConfigRange(Minimum = 100, Maximum = 2000)]
    public int MaxTotalChannels { get; set; } = 1000;

    /// <summary>
    /// Default prefetch count for subscriptions
    /// Environment variable: MESSAGING_DEFAULT_PREFETCH_COUNT
    /// </summary>
    [ConfigRange(Minimum = 1, Maximum = 10000)]
    public int DefaultPrefetchCount { get; set; } = 10;

    /// <summary>
    /// Default auto-acknowledge setting for subscriptions
    /// Environment variable: MESSAGING_DEFAULT_AUTO_ACK
    /// </summary>
    public bool DefaultAutoAck { get; set; } = false;

    /// <summary>
    /// Dead letter exchange name for failed messages
    /// Environment variable: MESSAGING_DEAD_LETTER_EXCHANGE
    /// </summary>
    [ConfigStringLength(MinLength = 1)]
    public string DeadLetterExchange { get; set; } = "bannou-dlx";

    /// <summary>
    /// Maximum messages in dead letter queue before oldest dropped
    /// Environment variable: MESSAGING_DEAD_LETTER_MAX_LENGTH
    /// </summary>
    [ConfigRange(Minimum = 1000, Maximum = 10000000)]
    public int DeadLetterMaxLength { get; set; } = 100000;

    /// <summary>
    /// Time-to-live for dead letter messages in milliseconds (default 7 days)
    /// Environment variable: MESSAGING_DEAD_LETTER_TTL_MS
    /// </summary>
    [ConfigRange(Minimum = 3600000, Maximum = 2592000000)]
    public int DeadLetterTtlMs { get; set; } = 604800000;

    /// <summary>
    /// Behavior when DLX queue exceeds max length (drop-head drops oldest, reject-publish blocks new messages)
    /// Environment variable: MESSAGING_DEAD_LETTER_OVERFLOW_BEHAVIOR
    /// </summary>
    public DeadLetterOverflowBehavior DeadLetterOverflowBehavior { get; set; } = DeadLetterOverflowBehavior.DropHead;

    /// <summary>
    /// Enable dead letter consumer background service for logging and monitoring
    /// Environment variable: MESSAGING_DEAD_LETTER_CONSUMER_ENABLED
    /// </summary>
    public bool DeadLetterConsumerEnabled { get; set; } = true;

    /// <summary>
    /// Delay in seconds before dead letter consumer starts subscribing (allows other services to initialize)
    /// Environment variable: MESSAGING_DEAD_LETTER_CONSUMER_STARTUP_DELAY_SECONDS
    /// </summary>
    [ConfigRange(Minimum = 1, Maximum = 60)]
    public int DeadLetterConsumerStartupDelaySeconds { get; set; } = 5;

    /// <summary>
    /// Maximum retry attempts before discarding message to dead-letter topic
    /// Environment variable: MESSAGING_RETRY_MAX_ATTEMPTS
    /// </summary>
    [ConfigRange(Minimum = 1, Maximum = 20)]
    public int RetryMaxAttempts { get; set; } = 5;

    /// <summary>
    /// Base delay between retry attempts in milliseconds (doubles with each retry)
    /// Environment variable: MESSAGING_RETRY_DELAY_MS
    /// </summary>
    [ConfigRange(Minimum = 100, Maximum = 60000)]
    public int RetryDelayMs { get; set; } = 5000;

    /// <summary>
    /// Maximum backoff delay between retries in milliseconds (caps exponential growth)
    /// Environment variable: MESSAGING_RETRY_MAX_BACKOFF_MS
    /// </summary>
    [ConfigRange(Minimum = 1000, Maximum = 300000)]
    public int RetryMaxBackoffMs { get; set; } = 60000;

    /// <summary>
    /// Enable retry buffer for failed event publishes
    /// Environment variable: MESSAGING_RETRY_BUFFER_ENABLED
    /// </summary>
    public bool RetryBufferEnabled { get; set; } = true;

    /// <summary>
    /// Maximum number of messages in retry buffer before node crash (500k = ~5s at 100k msg/sec)
    /// Environment variable: MESSAGING_RETRY_BUFFER_MAX_SIZE
    /// </summary>
    [ConfigRange(Minimum = 10000, Maximum = 2000000)]
    public int RetryBufferMaxSize { get; set; } = 500000;

    /// <summary>
    /// Maximum age of buffered messages before node crash (gives operators time to respond)
    /// Environment variable: MESSAGING_RETRY_BUFFER_MAX_AGE_SECONDS
    /// </summary>
    [ConfigRange(Minimum = 60, Maximum = 1800)]
    public int RetryBufferMaxAgeSeconds { get; set; } = 600;

    /// <summary>
    /// Interval between retry attempts for buffered messages
    /// Environment variable: MESSAGING_RETRY_BUFFER_INTERVAL_SECONDS
    /// </summary>
    [ConfigRange(Minimum = 1, Maximum = 60)]
    public int RetryBufferIntervalSeconds { get; set; } = 5;

    /// <summary>
    /// When buffer reaches this percentage full, start rejecting new publishes (0.0-1.0)
    /// Environment variable: MESSAGING_RETRY_BUFFER_BACKPRESSURE_THRESHOLD
    /// </summary>
    [ConfigRange(Minimum = 0.5, Maximum = 0.95)]
    public double RetryBufferBackpressureThreshold { get; set; } = 0.8;

    /// <summary>
    /// Enable batched publishing for high-throughput scenarios. When enabled, messages are queued and sent in batches to reduce broker overhead.
    /// Environment variable: MESSAGING_ENABLE_PUBLISH_BATCHING
    /// </summary>
    public bool EnablePublishBatching { get; set; } = false;

    /// <summary>
    /// Maximum number of messages to batch before sending. Batch is flushed when this size is reached.
    /// Environment variable: MESSAGING_PUBLISH_BATCH_SIZE
    /// </summary>
    [ConfigRange(Minimum = 10, Maximum = 1000)]
    public int PublishBatchSize { get; set; } = 100;

    /// <summary>
    /// Maximum delay in milliseconds before flushing a partial batch. Ensures low-throughput periods don't accumulate stale messages.
    /// Environment variable: MESSAGING_PUBLISH_BATCH_TIMEOUT_MS
    /// </summary>
    [ConfigRange(Minimum = 1, Maximum = 100)]
    public int PublishBatchTimeoutMs { get; set; } = 10;

    /// <summary>
    /// Maximum retry attempts for HTTP callback delivery (network failures only)
    /// Environment variable: MESSAGING_CALLBACK_RETRY_MAX_ATTEMPTS
    /// </summary>
    [ConfigRange(Minimum = 0, Maximum = 10)]
    public int CallbackRetryMaxAttempts { get; set; } = 3;

    /// <summary>
    /// Delay between HTTP callback retry attempts in milliseconds
    /// Environment variable: MESSAGING_CALLBACK_RETRY_DELAY_MS
    /// </summary>
    [ConfigRange(Minimum = 100, Maximum = 30000)]
    public int CallbackRetryDelayMs { get; set; } = 1000;

    /// <summary>
    /// Maximum seconds to wait for graceful subscription cleanup during shutdown. Prevents indefinite blocking when channels hang.
    /// Environment variable: MESSAGING_SHUTDOWN_TIMEOUT_SECONDS
    /// </summary>
    [ConfigRange(Minimum = 1, Maximum = 60)]
    public int ShutdownTimeoutSeconds { get; set; } = 10;

    /// <summary>
    /// Interval in hours between subscription TTL refresh operations
    /// Environment variable: MESSAGING_SUBSCRIPTION_TTL_REFRESH_INTERVAL_HOURS
    /// </summary>
    [ConfigRange(Minimum = 1, Maximum = 24)]
    public int SubscriptionTtlRefreshIntervalHours { get; set; } = 6;

    /// <summary>
    /// Delay in seconds before starting subscription recovery service
    /// Environment variable: MESSAGING_SUBSCRIPTION_RECOVERY_STARTUP_DELAY_SECONDS
    /// </summary>
    [ConfigRange(Minimum = 0, Maximum = 60)]
    public int SubscriptionRecoveryStartupDelaySeconds { get; set; } = 2;

    /// <summary>
    /// Interval in seconds between RabbitMQ connection recovery attempts
    /// Environment variable: MESSAGING_RABBITMQ_NETWORK_RECOVERY_INTERVAL_SECONDS
    /// </summary>
    [ConfigRange(Minimum = 1, Maximum = 300)]
    public int RabbitMQNetworkRecoveryIntervalSeconds { get; set; } = 10;

    /// <summary>
    /// TTL in seconds for external HTTP callback subscriptions (default 24 hours)
    /// Environment variable: MESSAGING_EXTERNAL_SUBSCRIPTION_TTL_SECONDS
    /// </summary>
    [ConfigRange(Minimum = 3600, Maximum = 2592000)]
    public int ExternalSubscriptionTtlSeconds { get; set; } = 86400;

}
