// <auto-generated>
// This code was generated by generate-references.py
// Do not edit this file manually.
// </auto-generated>

#nullable enable

using BeyondImmersion.Bannou.Core;
using BeyondImmersion.BannouService;
using BeyondImmersion.BannouService.Resource;

namespace BeyondImmersion.BannouService.Worldstate;

/// <summary>
/// Generated partial class providing resource reference tracking helpers for WorldstateService.
/// </summary>
/// <remarks>
/// <para>
/// Call Register*ReferenceAsync() after creating an entity that references a foundational resource.
/// Call Unregister*ReferenceAsync() before deleting an entity that references a foundational resource.
/// Call RegisterResourceCleanupCallbacksAsync() during service startup to register cleanup callbacks.
/// </para>
/// </remarks>
public partial class WorldstateService
{

    /// <summary>
    /// Registers a reference from a worldstate entity to a realm resource.
    /// Call this after creating an entity that references the resource.
    /// </summary>
    /// <param name="worldstateId">The ID of the worldstate entity holding the reference.</param>
    /// <param name="realmId">The ID of the realm resource being referenced.</param>
    /// <param name="cancellationToken">Cancellation token.</param>
    protected async Task RegisterRealmReferenceAsync(
        string worldstateId,
        Guid realmId,
        CancellationToken cancellationToken = default)
    {
        await _resourceClient.RegisterReferenceAsync(
            new RegisterReferenceRequest
            {
                ResourceType = "realm",
                ResourceId = realmId,
                SourceType = "worldstate",
                SourceId = worldstateId
            },
            cancellationToken);
    }

    /// <summary>
    /// Unregisters a reference from a worldstate entity to a realm resource.
    /// Call this before deleting an entity that references the resource.
    /// </summary>
    /// <param name="worldstateId">The ID of the worldstate entity releasing the reference.</param>
    /// <param name="realmId">The ID of the realm resource being dereferenced.</param>
    /// <param name="cancellationToken">Cancellation token.</param>
    protected async Task UnregisterRealmReferenceAsync(
        string worldstateId,
        Guid realmId,
        CancellationToken cancellationToken = default)
    {
        await _resourceClient.UnregisterReferenceAsync(
            new UnregisterReferenceRequest
            {
                ResourceType = "realm",
                ResourceId = realmId,
                SourceType = "worldstate",
                SourceId = worldstateId
            },
            cancellationToken);
    }

    /// <summary>
    /// Registers a reference from a worldstate entity to a game-service resource.
    /// Call this after creating an entity that references the resource.
    /// </summary>
    /// <param name="worldstateId">The ID of the worldstate entity holding the reference.</param>
    /// <param name="gameServiceId">The ID of the game-service resource being referenced.</param>
    /// <param name="cancellationToken">Cancellation token.</param>
    protected async Task RegisterGameServiceReferenceAsync(
        string worldstateId,
        Guid gameServiceId,
        CancellationToken cancellationToken = default)
    {
        await _resourceClient.RegisterReferenceAsync(
            new RegisterReferenceRequest
            {
                ResourceType = "game-service",
                ResourceId = gameServiceId,
                SourceType = "worldstate",
                SourceId = worldstateId
            },
            cancellationToken);
    }

    /// <summary>
    /// Unregisters a reference from a worldstate entity to a game-service resource.
    /// Call this before deleting an entity that references the resource.
    /// </summary>
    /// <param name="worldstateId">The ID of the worldstate entity releasing the reference.</param>
    /// <param name="gameServiceId">The ID of the game-service resource being dereferenced.</param>
    /// <param name="cancellationToken">Cancellation token.</param>
    protected async Task UnregisterGameServiceReferenceAsync(
        string worldstateId,
        Guid gameServiceId,
        CancellationToken cancellationToken = default)
    {
        await _resourceClient.UnregisterReferenceAsync(
            new UnregisterReferenceRequest
            {
                ResourceType = "game-service",
                ResourceId = gameServiceId,
                SourceType = "worldstate",
                SourceId = worldstateId
            },
            cancellationToken);
    }

    // ═══════════════════════════════════════════════════════════════════════════
    // Cleanup Callback Registration
    // ═══════════════════════════════════════════════════════════════════════════

    /// <summary>
    /// Registers cleanup callbacks with lib-resource for all resource references.
    /// Call this during service startup or when the IResourceClient becomes available.
    /// </summary>
    /// <param name="resourceClient">The resource service client.</param>
    /// <param name="cancellationToken">Cancellation token.</param>
    /// <returns>True if all callbacks were registered successfully.</returns>
    public static async Task<bool> RegisterResourceCleanupCallbacksAsync(
        IResourceClient resourceClient,
        CancellationToken cancellationToken = default)
    {
        var allSucceeded = true;

        // Register cleanup callback for realm references
        try
        {
            await resourceClient.DefineCleanupCallbackAsync(
                new DefineCleanupRequest
                {
                    ResourceType = "realm",
                    SourceType = "worldstate",
                    OnDeleteAction = OnDeleteAction.CASCADE,
                    ServiceName = "worldstate",
                    CallbackEndpoint = "/worldstate/cleanup-by-realm",
                    PayloadTemplate = "{\"realmId\": \"{{resourceId}}\"}",
                    Description = "Cleanup worldstate entities referencing deleted realm"
                },
                cancellationToken);
        }
        catch (ApiException)
        {
            allSucceeded = false;
        }

        // Register cleanup callback for game-service references
        try
        {
            await resourceClient.DefineCleanupCallbackAsync(
                new DefineCleanupRequest
                {
                    ResourceType = "game-service",
                    SourceType = "worldstate",
                    OnDeleteAction = OnDeleteAction.CASCADE,
                    ServiceName = "worldstate",
                    CallbackEndpoint = "/worldstate/cleanup-by-game-service",
                    PayloadTemplate = "{\"gameServiceId\": \"{{resourceId}}\"}",
                    Description = "Cleanup worldstate entities referencing deleted game-service"
                },
                cancellationToken);
        }
        catch (ApiException)
        {
            allSucceeded = false;
        }

        return allSucceeded;
    }
}
