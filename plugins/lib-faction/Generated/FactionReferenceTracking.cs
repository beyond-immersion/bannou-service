// <auto-generated>
// This code was generated by generate-references.py
// Do not edit this file manually.
// </auto-generated>

#nullable enable

using BeyondImmersion.Bannou.Core;
using BeyondImmersion.BannouService;
using BeyondImmersion.BannouService.Resource;

namespace BeyondImmersion.BannouService.Faction;

/// <summary>
/// Generated partial class providing resource reference tracking helpers for FactionService.
/// </summary>
/// <remarks>
/// <para>
/// Call Register*ReferenceAsync() after creating an entity that references a foundational resource.
/// Call Unregister*ReferenceAsync() before deleting an entity that references a foundational resource.
/// Call RegisterResourceCleanupCallbacksAsync() during service startup to register cleanup callbacks.
/// </para>
/// </remarks>
public partial class FactionService
{

    /// <summary>
    /// Registers a reference from a faction entity to a character resource.
    /// Call this after creating an entity that references the resource.
    /// </summary>
    /// <param name="factionId">The ID of the faction entity holding the reference.</param>
    /// <param name="characterId">The ID of the character resource being referenced.</param>
    /// <param name="cancellationToken">Cancellation token.</param>
    protected async Task RegisterCharacterReferenceAsync(
        string factionId,
        Guid characterId,
        CancellationToken cancellationToken = default)
    {
        await _resourceClient.RegisterReferenceAsync(
            new RegisterReferenceRequest
            {
                ResourceType = "character",
                ResourceId = characterId,
                SourceType = "faction",
                SourceId = factionId
            },
            cancellationToken);
    }

    /// <summary>
    /// Unregisters a reference from a faction entity to a character resource.
    /// Call this before deleting an entity that references the resource.
    /// </summary>
    /// <param name="factionId">The ID of the faction entity releasing the reference.</param>
    /// <param name="characterId">The ID of the character resource being dereferenced.</param>
    /// <param name="cancellationToken">Cancellation token.</param>
    protected async Task UnregisterCharacterReferenceAsync(
        string factionId,
        Guid characterId,
        CancellationToken cancellationToken = default)
    {
        await _resourceClient.UnregisterReferenceAsync(
            new UnregisterReferenceRequest
            {
                ResourceType = "character",
                ResourceId = characterId,
                SourceType = "faction",
                SourceId = factionId
            },
            cancellationToken);
    }

    /// <summary>
    /// Registers a reference from a faction entity to a realm resource.
    /// Call this after creating an entity that references the resource.
    /// </summary>
    /// <param name="factionId">The ID of the faction entity holding the reference.</param>
    /// <param name="realmId">The ID of the realm resource being referenced.</param>
    /// <param name="cancellationToken">Cancellation token.</param>
    protected async Task RegisterRealmReferenceAsync(
        string factionId,
        Guid realmId,
        CancellationToken cancellationToken = default)
    {
        await _resourceClient.RegisterReferenceAsync(
            new RegisterReferenceRequest
            {
                ResourceType = "realm",
                ResourceId = realmId,
                SourceType = "faction",
                SourceId = factionId
            },
            cancellationToken);
    }

    /// <summary>
    /// Unregisters a reference from a faction entity to a realm resource.
    /// Call this before deleting an entity that references the resource.
    /// </summary>
    /// <param name="factionId">The ID of the faction entity releasing the reference.</param>
    /// <param name="realmId">The ID of the realm resource being dereferenced.</param>
    /// <param name="cancellationToken">Cancellation token.</param>
    protected async Task UnregisterRealmReferenceAsync(
        string factionId,
        Guid realmId,
        CancellationToken cancellationToken = default)
    {
        await _resourceClient.UnregisterReferenceAsync(
            new UnregisterReferenceRequest
            {
                ResourceType = "realm",
                ResourceId = realmId,
                SourceType = "faction",
                SourceId = factionId
            },
            cancellationToken);
    }

    /// <summary>
    /// Registers a reference from a faction entity to a location resource.
    /// Call this after creating an entity that references the resource.
    /// </summary>
    /// <param name="factionId">The ID of the faction entity holding the reference.</param>
    /// <param name="locationId">The ID of the location resource being referenced.</param>
    /// <param name="cancellationToken">Cancellation token.</param>
    protected async Task RegisterLocationReferenceAsync(
        string factionId,
        Guid locationId,
        CancellationToken cancellationToken = default)
    {
        await _resourceClient.RegisterReferenceAsync(
            new RegisterReferenceRequest
            {
                ResourceType = "location",
                ResourceId = locationId,
                SourceType = "faction",
                SourceId = factionId
            },
            cancellationToken);
    }

    /// <summary>
    /// Unregisters a reference from a faction entity to a location resource.
    /// Call this before deleting an entity that references the resource.
    /// </summary>
    /// <param name="factionId">The ID of the faction entity releasing the reference.</param>
    /// <param name="locationId">The ID of the location resource being dereferenced.</param>
    /// <param name="cancellationToken">Cancellation token.</param>
    protected async Task UnregisterLocationReferenceAsync(
        string factionId,
        Guid locationId,
        CancellationToken cancellationToken = default)
    {
        await _resourceClient.UnregisterReferenceAsync(
            new UnregisterReferenceRequest
            {
                ResourceType = "location",
                ResourceId = locationId,
                SourceType = "faction",
                SourceId = factionId
            },
            cancellationToken);
    }

    // ═══════════════════════════════════════════════════════════════════════════
    // Cleanup Callback Registration
    // ═══════════════════════════════════════════════════════════════════════════

    /// <summary>
    /// Registers cleanup callbacks with lib-resource for all resource references.
    /// Call this during service startup or when the IResourceClient becomes available.
    /// </summary>
    /// <param name="resourceClient">The resource service client.</param>
    /// <param name="cancellationToken">Cancellation token.</param>
    /// <returns>True if all callbacks were registered successfully.</returns>
    public static async Task<bool> RegisterResourceCleanupCallbacksAsync(
        IResourceClient resourceClient,
        CancellationToken cancellationToken = default)
    {
        var allSucceeded = true;

        // Register cleanup callback for character references
        try
        {
            await resourceClient.DefineCleanupCallbackAsync(
                new DefineCleanupRequest
                {
                    ResourceType = "character",
                    SourceType = "faction",
                    OnDeleteAction = OnDeleteAction.CASCADE,
                    ServiceName = "faction",
                    CallbackEndpoint = "/faction/cleanup-by-character",
                    PayloadTemplate = "{\"characterId\": \"{{resourceId}}\"}",
                    Description = "Cleanup faction entities referencing deleted character"
                },
                cancellationToken);
        }
        catch (ApiException)
        {
            allSucceeded = false;
        }

        // Register cleanup callback for realm references
        try
        {
            await resourceClient.DefineCleanupCallbackAsync(
                new DefineCleanupRequest
                {
                    ResourceType = "realm",
                    SourceType = "faction",
                    OnDeleteAction = OnDeleteAction.CASCADE,
                    ServiceName = "faction",
                    CallbackEndpoint = "/faction/cleanup-by-realm",
                    PayloadTemplate = "{\"realmId\": \"{{resourceId}}\"}",
                    Description = "Cleanup faction entities referencing deleted realm"
                },
                cancellationToken);
        }
        catch (ApiException)
        {
            allSucceeded = false;
        }

        // Register cleanup callback for location references
        try
        {
            await resourceClient.DefineCleanupCallbackAsync(
                new DefineCleanupRequest
                {
                    ResourceType = "location",
                    SourceType = "faction",
                    OnDeleteAction = OnDeleteAction.CASCADE,
                    ServiceName = "faction",
                    CallbackEndpoint = "/faction/cleanup-by-location",
                    PayloadTemplate = "{\"locationId\": \"{{resourceId}}\"}",
                    Description = "Cleanup faction entities referencing deleted location"
                },
                cancellationToken);
        }
        catch (ApiException)
        {
            allSucceeded = false;
        }

        return allSucceeded;
    }
}
