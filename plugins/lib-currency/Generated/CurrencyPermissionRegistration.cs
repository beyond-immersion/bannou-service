//----------------------
// <auto-generated>
//     Generated from OpenAPI schema: schemas/currency-api.yaml
//
//     WARNING: DO NOT EDIT THIS FILE (TENETS T1/T2)
//     This file is auto-generated from x-permissions sections in the schema.
//     Any manual changes will be overwritten on next generation.
//
//     To modify permissions:
//     1. Edit x-permissions sections in schemas/currency-api.yaml
//     2. Run: scripts/generate-all-services.sh
//
//     See: docs/reference/tenets/FOUNDATION.md (T1: Schema-First, T2: Code Generation)
//     See: docs/reference/tenets/FOUNDATION.md (T13: X-Permissions Usage)
// </auto-generated>
//----------------------

#nullable enable

using BeyondImmersion.BannouService;
using BeyondImmersion.BannouService.Events;
using BeyondImmersion.BannouService.Services;
using Microsoft.Extensions.Logging;

namespace BeyondImmersion.BannouService.Currency;

/// <summary>
/// Generated permission registration for Currency service.
/// Contains permission matrix extracted from x-permissions sections in OpenAPI schema.
/// </summary>
public static class CurrencyPermissionRegistration
{
    /// <summary>
    /// Service ID for permission registration.
    /// </summary>
    public const string ServiceId = "currency";

    /// <summary>
    /// Service version from OpenAPI schema.
    /// </summary>
    public const string ServiceVersion = "1.0.0";

    /// <summary>
    /// Generates the ServiceRegistrationEvent containing all endpoint permissions.
    /// </summary>
    /// <param name="instanceId">The unique instance GUID for this bannou instance</param>
    public static ServiceRegistrationEvent CreateRegistrationEvent(Guid instanceId)
    {
        return new ServiceRegistrationEvent
        {
            EventId = Guid.NewGuid(),
            Timestamp = DateTimeOffset.UtcNow,
            ServiceId = instanceId,
            ServiceName = ServiceId,
            Version = ServiceVersion,
            AppId = Program.Configuration.EffectiveAppId,
            Endpoints = GetEndpoints()
        };
    }

    /// <summary>
    /// Gets the list of endpoints with their permission requirements.
    /// </summary>
    public static ICollection<ServiceEndpoint> GetEndpoints()
    {
        var endpoints = new List<ServiceEndpoint>();

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/currency/definition/create",
            Method = ServiceEndpointMethod.POST,
            Description = "createCurrencyDefinition",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "admin",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/currency/definition/get",
            Method = ServiceEndpointMethod.POST,
            Description = "getCurrencyDefinition",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "user",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/currency/definition/list",
            Method = ServiceEndpointMethod.POST,
            Description = "listCurrencyDefinitions",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "user",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/currency/definition/update",
            Method = ServiceEndpointMethod.POST,
            Description = "updateCurrencyDefinition",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "admin",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/currency/wallet/create",
            Method = ServiceEndpointMethod.POST,
            Description = "createWallet",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "developer",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/currency/wallet/get",
            Method = ServiceEndpointMethod.POST,
            Description = "getWallet",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "user",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/currency/wallet/get-or-create",
            Method = ServiceEndpointMethod.POST,
            Description = "getOrCreateWallet",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "developer",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/currency/wallet/freeze",
            Method = ServiceEndpointMethod.POST,
            Description = "freezeWallet",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "admin",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/currency/wallet/unfreeze",
            Method = ServiceEndpointMethod.POST,
            Description = "unfreezeWallet",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "admin",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/currency/wallet/close",
            Method = ServiceEndpointMethod.POST,
            Description = "closeWallet",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "admin",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/currency/balance/get",
            Method = ServiceEndpointMethod.POST,
            Description = "getBalance",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "user",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/currency/balance/batch-get",
            Method = ServiceEndpointMethod.POST,
            Description = "batchGetBalances",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "user",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/currency/credit",
            Method = ServiceEndpointMethod.POST,
            Description = "creditCurrency",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "developer",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/currency/debit",
            Method = ServiceEndpointMethod.POST,
            Description = "debitCurrency",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "developer",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/currency/transfer",
            Method = ServiceEndpointMethod.POST,
            Description = "transferCurrency",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "developer",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/currency/batch-credit",
            Method = ServiceEndpointMethod.POST,
            Description = "batchCreditCurrency",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "developer",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/currency/convert/calculate",
            Method = ServiceEndpointMethod.POST,
            Description = "calculateConversion",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "user",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/currency/convert/execute",
            Method = ServiceEndpointMethod.POST,
            Description = "executeConversion",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "developer",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/currency/exchange-rate/get",
            Method = ServiceEndpointMethod.POST,
            Description = "getExchangeRate",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "user",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/currency/exchange-rate/update",
            Method = ServiceEndpointMethod.POST,
            Description = "updateExchangeRate",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "admin",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/currency/transaction/get",
            Method = ServiceEndpointMethod.POST,
            Description = "getTransaction",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "developer",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/currency/transaction/history",
            Method = ServiceEndpointMethod.POST,
            Description = "getTransactionHistory",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "user",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/currency/transaction/by-reference",
            Method = ServiceEndpointMethod.POST,
            Description = "getTransactionsByReference",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "developer",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/currency/stats/global-supply",
            Method = ServiceEndpointMethod.POST,
            Description = "getGlobalSupply",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "user",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/currency/stats/wallet-distribution",
            Method = ServiceEndpointMethod.POST,
            Description = "getWalletDistribution",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "admin",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/currency/escrow/deposit",
            Method = ServiceEndpointMethod.POST,
            Description = "escrowDeposit",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "developer",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/currency/escrow/release",
            Method = ServiceEndpointMethod.POST,
            Description = "escrowRelease",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "developer",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/currency/escrow/refund",
            Method = ServiceEndpointMethod.POST,
            Description = "escrowRefund",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "developer",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/currency/hold/create",
            Method = ServiceEndpointMethod.POST,
            Description = "createHold",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "developer",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/currency/hold/capture",
            Method = ServiceEndpointMethod.POST,
            Description = "captureHold",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "developer",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/currency/hold/release",
            Method = ServiceEndpointMethod.POST,
            Description = "releaseHold",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "developer",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/currency/hold/get",
            Method = ServiceEndpointMethod.POST,
            Description = "getHold",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "developer",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        return endpoints;
    }

    /// <summary>
    /// Builds the permission matrix for RegisterServicePermissionsAsync.
    /// Key structure: state -> role -> list of methods
    /// State key construction must match PermissionService.RecompileSessionPermissionsAsync:
    /// - Same service (s.Key == ServiceId): use just s.Value (e.g., "ringing")
    /// - Cross-service: use "{s.Key}:{s.Value}" (e.g., "game-session:in_game")
    /// </summary>
    public static Dictionary<string, IDictionary<string, ICollection<string>>> BuildPermissionMatrix()
    {
        var matrix = new Dictionary<string, IDictionary<string, ICollection<string>>>();

        foreach (var endpoint in GetEndpoints())
        {
            var methodKey = $"{endpoint.Method}:{endpoint.Path}";

            foreach (var permission in endpoint.Permissions)
            {
                // Determine state key - use "default" if no specific states required
                // For same-service states, use just the value to match lookup logic
                var stateKey = permission.RequiredStates.Count > 0
                    ? string.Join("|", permission.RequiredStates.Select(s =>
                        s.Key == ServiceId ? s.Value : $"{s.Key}:{s.Value}"))
                    : "default";

                if (!matrix.TryGetValue(stateKey, out var roleMap))
                {
                    roleMap = new Dictionary<string, ICollection<string>>();
                    matrix[stateKey] = roleMap;
                }

                if (!roleMap.TryGetValue(permission.Role, out var methods))
                {
                    methods = new List<string>();
                    roleMap[permission.Role] = methods;
                }

                if (!methods.Contains(methodKey))
                {
                    methods.Add(methodKey);
                }
            }
        }

        return matrix;
    }

    /// <summary>
    /// Registers service permissions via event publishing.
    /// Should only be called after messaging infrastructure is confirmed.
    /// </summary>
    public static async Task RegisterViaEventAsync(IMessageBus messageBus, ILogger? logger = null)
    {
        var registrationEvent = CreateRegistrationEvent(Guid.Parse(Program.ServiceGUID));

        var success = await messageBus.TryPublishAsync(
            "permission.service-registered",
            registrationEvent);

        if (success)
        {
            logger?.LogInformation(
                "Published service registration event for {ServiceName} v{Version} with {EndpointCount} endpoints",
                ServiceId, ServiceVersion, registrationEvent.Endpoints.Count);
        }
        else
        {
            logger?.LogWarning(
                "Failed to publish service registration event for {ServiceId} (will be retried)",
                ServiceId);
        }
    }

}
