// <auto-generated>
// This code was generated by generate-references.py
// Do not edit this file manually.
// </auto-generated>

#nullable enable

using BeyondImmersion.Bannou.Core;
using BeyondImmersion.BannouService;
using BeyondImmersion.BannouService.Resource;

namespace BeyondImmersion.BannouService.Divine;

/// <summary>
/// Generated partial class providing resource reference tracking helpers for DivineService.
/// </summary>
/// <remarks>
/// <para>
/// Call Register*ReferenceAsync() after creating an entity that references a foundational resource.
/// Call Unregister*ReferenceAsync() before deleting an entity that references a foundational resource.
/// Call RegisterResourceCleanupCallbacksAsync() during service startup to register cleanup callbacks.
/// </para>
/// </remarks>
public partial class DivineService
{

    /// <summary>
    /// Registers a reference from a divine entity to a character resource.
    /// Call this after creating an entity that references the resource.
    /// </summary>
    /// <param name="divineId">The ID of the divine entity holding the reference.</param>
    /// <param name="characterId">The ID of the character resource being referenced.</param>
    /// <param name="cancellationToken">Cancellation token.</param>
    protected async Task RegisterCharacterReferenceAsync(
        string divineId,
        Guid characterId,
        CancellationToken cancellationToken = default)
    {
        await _resourceClient.RegisterReferenceAsync(
            new RegisterReferenceRequest
            {
                ResourceType = "character",
                ResourceId = characterId,
                SourceType = "divine",
                SourceId = divineId
            },
            cancellationToken);
    }

    /// <summary>
    /// Unregisters a reference from a divine entity to a character resource.
    /// Call this before deleting an entity that references the resource.
    /// </summary>
    /// <param name="divineId">The ID of the divine entity releasing the reference.</param>
    /// <param name="characterId">The ID of the character resource being dereferenced.</param>
    /// <param name="cancellationToken">Cancellation token.</param>
    protected async Task UnregisterCharacterReferenceAsync(
        string divineId,
        Guid characterId,
        CancellationToken cancellationToken = default)
    {
        await _resourceClient.UnregisterReferenceAsync(
            new UnregisterReferenceRequest
            {
                ResourceType = "character",
                ResourceId = characterId,
                SourceType = "divine",
                SourceId = divineId
            },
            cancellationToken);
    }

    /// <summary>
    /// Registers a reference from a divine entity to a game-service resource.
    /// Call this after creating an entity that references the resource.
    /// </summary>
    /// <param name="divineId">The ID of the divine entity holding the reference.</param>
    /// <param name="gameServiceId">The ID of the game-service resource being referenced.</param>
    /// <param name="cancellationToken">Cancellation token.</param>
    protected async Task RegisterGameServiceReferenceAsync(
        string divineId,
        Guid gameServiceId,
        CancellationToken cancellationToken = default)
    {
        await _resourceClient.RegisterReferenceAsync(
            new RegisterReferenceRequest
            {
                ResourceType = "game-service",
                ResourceId = gameServiceId,
                SourceType = "divine",
                SourceId = divineId
            },
            cancellationToken);
    }

    /// <summary>
    /// Unregisters a reference from a divine entity to a game-service resource.
    /// Call this before deleting an entity that references the resource.
    /// </summary>
    /// <param name="divineId">The ID of the divine entity releasing the reference.</param>
    /// <param name="gameServiceId">The ID of the game-service resource being dereferenced.</param>
    /// <param name="cancellationToken">Cancellation token.</param>
    protected async Task UnregisterGameServiceReferenceAsync(
        string divineId,
        Guid gameServiceId,
        CancellationToken cancellationToken = default)
    {
        await _resourceClient.UnregisterReferenceAsync(
            new UnregisterReferenceRequest
            {
                ResourceType = "game-service",
                ResourceId = gameServiceId,
                SourceType = "divine",
                SourceId = divineId
            },
            cancellationToken);
    }

    // ═══════════════════════════════════════════════════════════════════════════
    // Cleanup Callback Registration
    // ═══════════════════════════════════════════════════════════════════════════

    /// <summary>
    /// Registers cleanup callbacks with lib-resource for all resource references.
    /// Call this during service startup or when the IResourceClient becomes available.
    /// </summary>
    /// <param name="resourceClient">The resource service client.</param>
    /// <param name="cancellationToken">Cancellation token.</param>
    /// <returns>True if all callbacks were registered successfully.</returns>
    public static async Task<bool> RegisterResourceCleanupCallbacksAsync(
        IResourceClient resourceClient,
        CancellationToken cancellationToken = default)
    {
        var allSucceeded = true;

        // Register cleanup callback for character references
        try
        {
            await resourceClient.DefineCleanupCallbackAsync(
                new DefineCleanupRequest
                {
                    ResourceType = "character",
                    SourceType = "divine",
                    OnDeleteAction = OnDeleteAction.CASCADE,
                    ServiceName = "divine",
                    CallbackEndpoint = "/divine/cleanup-by-character",
                    PayloadTemplate = "{\"characterId\": \"{{resourceId}}\"}",
                    Description = "Cleanup divine entities referencing deleted character"
                },
                cancellationToken);
        }
        catch (ApiException)
        {
            allSucceeded = false;
        }

        // Register cleanup callback for game-service references
        try
        {
            await resourceClient.DefineCleanupCallbackAsync(
                new DefineCleanupRequest
                {
                    ResourceType = "game-service",
                    SourceType = "divine",
                    OnDeleteAction = OnDeleteAction.CASCADE,
                    ServiceName = "divine",
                    CallbackEndpoint = "/divine/cleanup-by-game-service",
                    PayloadTemplate = "{\"gameServiceId\": \"{{resourceId}}\"}",
                    Description = "Cleanup divine entities referencing deleted game-service"
                },
                cancellationToken);
        }
        catch (ApiException)
        {
            allSucceeded = false;
        }

        return allSucceeded;
    }
}
