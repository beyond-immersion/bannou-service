//----------------------
// <auto-generated>
//     Generated from OpenAPI schema: schemas/save-load-configuration.yaml
//
//     WARNING: DO NOT EDIT THIS FILE (FOUNDATION TENETS)
//     This file is auto-generated from configuration schema.
//     Any manual changes will be overwritten on next generation.
//
//     To add/modify configuration:
//     1. Edit the source schema (schemas/save-load-configuration.yaml)
//     2. Run: scripts/generate-all-services.sh
//
//     IMPLEMENTATION TENETS - Configuration-First:
//     - Access configuration via dependency injection, never Environment.GetEnvironmentVariable.
//     - ALL properties below MUST be referenced in SaveLoadService.cs (no dead config).
//     - Any hardcoded tunable (limit, timeout, threshold, capacity) in service code means
//       a configuration property is MISSING - add it to the configuration schema.
//     - If a property is unused, remove it from the configuration schema.
//
//     Example: public MyService(SaveLoadServiceConfiguration config) { _config = config; }
//
//     See: docs/reference/tenets/IMPLEMENTATION.md (Configuration-First, Internal Model Type Safety)
// </auto-generated>
//----------------------

using System.ComponentModel.DataAnnotations;
using BeyondImmersion.BannouService;
using BeyondImmersion.BannouService.Attributes;
using BeyondImmersion.BannouService.Configuration;

#nullable enable

namespace BeyondImmersion.BannouService.SaveLoad;

/// <summary>
/// Configuration class for SaveLoad service.
/// Properties are automatically bound from environment variables.
/// </summary>
/// <remarks>
/// <para>
/// <b>IMPLEMENTATION TENETS - Configuration-First:</b> Access configuration via dependency injection.
/// Never use <c>Environment.GetEnvironmentVariable()</c> directly in service code.
/// ALL properties in this class MUST be referenced in the service implementation.
/// If a property is unused, remove it from the configuration schema.
/// </para>
/// <para>
/// Environment variable names follow the pattern: {SERVICE}_{PROPERTY} (e.g., AUTH_JWT_SECRET).
/// </para>
/// </remarks>
[ServiceConfiguration(typeof(SaveLoadService))]
public class SaveLoadServiceConfiguration : IServiceConfiguration
{
    /// <inheritdoc />
    public Guid? ForceServiceId { get; set; }

    /// <summary>
    /// Maximum size for a single save in bytes (default 100MB)
    /// Environment variable: SAVE_LOAD_MAX_SAVE_SIZE_BYTES
    /// </summary>
    public int MaxSaveSizeBytes { get; set; } = 104857600;

    /// <summary>
    /// Auto-compress saves larger than this (default 1MB)
    /// Environment variable: SAVE_LOAD_AUTO_COMPRESS_THRESHOLD_BYTES
    /// </summary>
    public int AutoCompressThresholdBytes { get; set; } = 1048576;

    /// <summary>
    /// Default compression algorithm
    /// Environment variable: SAVE_LOAD_DEFAULT_COMPRESSION_TYPE
    /// </summary>
    public CompressionType DefaultCompressionType { get; set; } = CompressionType.GZIP;

    /// <summary>
    /// TTL for hot cache entries in minutes
    /// Environment variable: SAVE_LOAD_HOT_CACHE_TTL_MINUTES
    /// </summary>
    public int HotCacheTtlMinutes { get; set; } = 60;

    /// <summary>
    /// MinIO bucket for save assets
    /// Environment variable: SAVE_LOAD_ASSET_BUCKET
    /// </summary>
    public string AssetBucket { get; set; } = "game-saves";

    /// <summary>
    /// Default max versions for QUICK_SAVE category
    /// Environment variable: SAVE_LOAD_DEFAULT_MAX_VERSIONS_QUICK_SAVE
    /// </summary>
    public int DefaultMaxVersionsQuickSave { get; set; } = 1;

    /// <summary>
    /// Default max versions for AUTO_SAVE category
    /// Environment variable: SAVE_LOAD_DEFAULT_MAX_VERSIONS_AUTO_SAVE
    /// </summary>
    public int DefaultMaxVersionsAutoSave { get; set; } = 5;

    /// <summary>
    /// Default max versions for MANUAL_SAVE category
    /// Environment variable: SAVE_LOAD_DEFAULT_MAX_VERSIONS_MANUAL_SAVE
    /// </summary>
    public int DefaultMaxVersionsManualSave { get; set; } = 10;

    /// <summary>
    /// Default max versions for CHECKPOINT category
    /// Environment variable: SAVE_LOAD_DEFAULT_MAX_VERSIONS_CHECKPOINT
    /// </summary>
    public int DefaultMaxVersionsCheckpoint { get; set; } = 20;

    /// <summary>
    /// Default max versions for STATE_SNAPSHOT category
    /// Environment variable: SAVE_LOAD_DEFAULT_MAX_VERSIONS_STATE_SNAPSHOT
    /// </summary>
    public int DefaultMaxVersionsStateSnapshot { get; set; } = 3;

    /// <summary>
    /// Interval for automatic cleanup task
    /// Environment variable: SAVE_LOAD_CLEANUP_INTERVAL_MINUTES
    /// </summary>
    public int CleanupIntervalMinutes { get; set; } = 60;

    /// <summary>
    /// Delay in seconds before cleanup service starts processing
    /// Environment variable: SAVE_LOAD_CLEANUP_STARTUP_DELAY_SECONDS
    /// </summary>
    public int CleanupStartupDelaySeconds { get; set; } = 30;

    /// <summary>
    /// Run scheduled cleanup only on control plane instance (EffectiveAppID == DefaultAppId). Prevents duplicate cleanup work across multi-instance deployments.
    /// Environment variable: SAVE_LOAD_CLEANUP_CONTROL_PLANE_ONLY
    /// </summary>
    public bool CleanupControlPlaneOnly { get; set; } = true;

    /// <summary>
    /// Grace period before cleaning up SESSION-owned saves after session ends. Allows other services to copy/promote saves to longer-term storage.
    /// Environment variable: SAVE_LOAD_SESSION_CLEANUP_GRACE_PERIOD_MINUTES
    /// </summary>
    public int SessionCleanupGracePeriodMinutes { get; set; } = 5;

    /// <summary>
    /// Enable/disable schema migrations entirely
    /// Environment variable: SAVE_LOAD_MIGRATIONS_ENABLED
    /// </summary>
    public bool MigrationsEnabled { get; set; } = true;

    /// <summary>
    /// Maximum JSON Patch operations per migration (safety limit)
    /// Environment variable: SAVE_LOAD_MIGRATION_MAX_PATCH_OPERATIONS
    /// </summary>
    public int MigrationMaxPatchOperations { get; set; } = 1000;

    /// <summary>
    /// Maximum save slots per owner entity
    /// Environment variable: SAVE_LOAD_MAX_SLOTS_PER_OWNER
    /// </summary>
    public int MaxSlotsPerOwner { get; set; } = 100;

    /// <summary>
    /// Rate limit - maximum saves per owner per minute
    /// Environment variable: SAVE_LOAD_MAX_SAVES_PER_MINUTE
    /// </summary>
    public int MaxSavesPerMinute { get; set; } = 10;

    /// <summary>
    /// Maximum total storage per owner (default 1GB)
    /// Environment variable: SAVE_LOAD_MAX_TOTAL_SIZE_BYTES_PER_OWNER
    /// </summary>
    public int MaxTotalSizeBytesPerOwner { get; set; } = 1073741824;

    /// <summary>
    /// Brotli compression level (0-11, higher = better compression, slower)
    /// Environment variable: SAVE_LOAD_BROTLI_COMPRESSION_LEVEL
    /// </summary>
    [ConfigRange(Minimum = 0, Maximum = 11)]
    public int BrotliCompressionLevel { get; set; } = 6;

    /// <summary>
    /// GZIP compression level (1-9, higher = better compression, slower)
    /// Environment variable: SAVE_LOAD_GZIP_COMPRESSION_LEVEL
    /// </summary>
    [ConfigRange(Minimum = 1, Maximum = 9)]
    public int GzipCompressionLevel { get; set; } = 6;

    /// <summary>
    /// Default compression per category as comma-separated KEY=VALUE pairs (e.g., "QUICK_SAVE=NONE,AUTO_SAVE=GZIP"). Overrides DefaultCompressionType when specified. If empty/null, uses DefaultCompressionType for all categories.
    /// Environment variable: SAVE_LOAD_DEFAULT_COMPRESSION_BY_CATEGORY
    /// </summary>
    public string? DefaultCompressionByCategory { get; set; }

    /// <summary>
    /// Maximum thumbnail size in bytes (default 256KB)
    /// Environment variable: SAVE_LOAD_THUMBNAIL_MAX_SIZE_BYTES
    /// </summary>
    public int ThumbnailMaxSizeBytes { get; set; } = 262144;

    /// <summary>
    /// Comma-separated list of allowed thumbnail MIME types
    /// Environment variable: SAVE_LOAD_THUMBNAIL_ALLOWED_FORMATS
    /// </summary>
    public string ThumbnailAllowedFormats { get; set; } = "image/jpeg,image/webp,image/png";

    /// <summary>
    /// Enable delta/incremental save support
    /// Environment variable: SAVE_LOAD_DELTA_SAVES_ENABLED
    /// </summary>
    public bool DeltaSavesEnabled { get; set; } = true;

    /// <summary>
    /// Default algorithm for delta computation
    /// Environment variable: SAVE_LOAD_DEFAULT_DELTA_ALGORITHM
    /// </summary>
    public DeltaAlgorithm DefaultDeltaAlgorithm { get; set; } = DeltaAlgorithm.JSON_PATCH;

    /// <summary>
    /// Maximum number of deltas before forcing collapse. Longer chains increase load latency.
    /// Environment variable: SAVE_LOAD_MAX_DELTA_CHAIN_LENGTH
    /// </summary>
    public int MaxDeltaChainLength { get; set; } = 10;

    /// <summary>
    /// Automatically collapse delta chains during cleanup
    /// Environment variable: SAVE_LOAD_AUTO_COLLAPSE_ENABLED
    /// </summary>
    public bool AutoCollapseEnabled { get; set; } = true;

    /// <summary>
    /// If delta is larger than this percent of full save, store as full instead. Avoids storing deltas that dont provide meaningful savings.
    /// Environment variable: SAVE_LOAD_DELTA_SIZE_THRESHOLD_PERCENT
    /// </summary>
    public int DeltaSizeThresholdPercent { get; set; } = 50;

    /// <summary>
    /// Minimum base save size in bytes before applying delta threshold logic (1KB default)
    /// Environment variable: SAVE_LOAD_MIN_BASE_SIZE_FOR_DELTA_THRESHOLD_BYTES
    /// </summary>
    public int MinBaseSizeForDeltaThresholdBytes { get; set; } = 1024;

    /// <summary>
    /// Enable device-based conflict detection for cloud saves. Requires deviceId to be provided in save requests.
    /// Environment variable: SAVE_LOAD_CONFLICT_DETECTION_ENABLED
    /// </summary>
    public bool ConflictDetectionEnabled { get; set; } = true;

    /// <summary>
    /// Time window for considering saves as potentially conflicting. Saves from different devices within this window trigger conflict flag.
    /// Environment variable: SAVE_LOAD_CONFLICT_DETECTION_WINDOW_MINUTES
    /// </summary>
    public int ConflictDetectionWindowMinutes { get; set; } = 5;

    /// <summary>
    /// Queue uploads to MinIO/S3 instead of synchronous write. Save is acknowledged immediately when data is stored in Redis pending queue. Background worker uploads asynchronously.
    /// Environment variable: SAVE_LOAD_ASYNC_UPLOAD_ENABLED
    /// </summary>
    public bool AsyncUploadEnabled { get; set; } = true;

    /// <summary>
    /// TTL for pending uploads in Redis. If upload fails repeatedly, entry expires and save is considered failed (event published).
    /// Environment variable: SAVE_LOAD_PENDING_UPLOAD_TTL_MINUTES
    /// </summary>
    public int PendingUploadTtlMinutes { get; set; } = 60;

    /// <summary>
    /// Maximum concurrent uploads to storage backend (semaphore). Prevents overwhelming MinIO/S3 during traffic spikes.
    /// Environment variable: SAVE_LOAD_MAX_CONCURRENT_UPLOADS
    /// </summary>
    public int MaxConcurrentUploads { get; set; } = 10;

    /// <summary>
    /// Number of pending uploads to process per batch cycle
    /// Environment variable: SAVE_LOAD_UPLOAD_BATCH_SIZE
    /// </summary>
    public int UploadBatchSize { get; set; } = 5;

    /// <summary>
    /// Interval between upload batch processing cycles
    /// Environment variable: SAVE_LOAD_UPLOAD_BATCH_INTERVAL_MS
    /// </summary>
    public int UploadBatchIntervalMs { get; set; } = 100;

    /// <summary>
    /// Number of retry attempts for failed uploads before giving up
    /// Environment variable: SAVE_LOAD_UPLOAD_RETRY_ATTEMPTS
    /// </summary>
    public int UploadRetryAttempts { get; set; } = 3;

    /// <summary>
    /// Base delay between retry attempts (exponential backoff applied)
    /// Environment variable: SAVE_LOAD_UPLOAD_RETRY_DELAY_MS
    /// </summary>
    public int UploadRetryDelayMs { get; set; } = 1000;

    /// <summary>
    /// Enable circuit breaker for storage backend (MinIO/S3). When open, new saves queue in Redis until circuit resets.
    /// Environment variable: SAVE_LOAD_STORAGE_CIRCUIT_BREAKER_ENABLED
    /// </summary>
    public bool StorageCircuitBreakerEnabled { get; set; } = true;

    /// <summary>
    /// Number of consecutive failures before circuit opens
    /// Environment variable: SAVE_LOAD_STORAGE_CIRCUIT_BREAKER_THRESHOLD
    /// </summary>
    public int StorageCircuitBreakerThreshold { get; set; } = 5;

    /// <summary>
    /// Seconds before attempting to close circuit (half-open state)
    /// Environment variable: SAVE_LOAD_STORAGE_CIRCUIT_BREAKER_RESET_SECONDS
    /// </summary>
    public int StorageCircuitBreakerResetSeconds { get; set; } = 30;

    /// <summary>
    /// Successful uploads needed in half-open state to close circuit
    /// Environment variable: SAVE_LOAD_STORAGE_CIRCUIT_BREAKER_HALF_OPEN_ATTEMPTS
    /// </summary>
    public int StorageCircuitBreakerHalfOpenAttempts { get; set; } = 2;

}
