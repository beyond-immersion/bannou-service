// <auto-generated>
// This code was generated by generate-references.py
// Do not edit this file manually.
// </auto-generated>

#nullable enable

using BeyondImmersion.Bannou.Core;
using BeyondImmersion.BannouService;
using BeyondImmersion.BannouService.Events;
using BeyondImmersion.BannouService.Messaging;
using BeyondImmersion.BannouService.Resource;

namespace BeyondImmersion.BannouService.Relationship;

/// <summary>
/// Generated partial class providing resource reference tracking helpers for RelationshipService.
/// </summary>
/// <remarks>
/// <para>
/// Call Register*ReferenceAsync() after creating an entity that references a foundational resource.
/// Call Unregister*ReferenceAsync() before deleting an entity that references a foundational resource.
/// Call RegisterResourceCleanupCallbacksAsync() during service startup to register cleanup callbacks.
/// </para>
/// </remarks>
public partial class RelationshipService
{

    /// <summary>
    /// Registers a reference from a relationship entity to a character resource.
    /// Call this after creating an entity that references the resource.
    /// </summary>
    /// <param name="relationshipId">The ID of the relationship entity holding the reference.</param>
    /// <param name="characterId">The ID of the character resource being referenced.</param>
    /// <param name="cancellationToken">Cancellation token.</param>
    /// <returns>True if the event was published successfully.</returns>
    protected async Task<bool> RegisterCharacterReferenceAsync(
        string relationshipId,
        Guid characterId,
        CancellationToken cancellationToken = default)
    {
        return await _messageBus.TryPublishAsync(
            "resource.reference.registered",
            new ResourceReferenceRegisteredEvent
            {
                ResourceType = "character",
                ResourceId = characterId,
                SourceType = "relationship",
                SourceId = relationshipId,
                Timestamp = DateTimeOffset.UtcNow
            },
            cancellationToken);
    }

    /// <summary>
    /// Unregisters a reference from a relationship entity to a character resource.
    /// Call this before deleting an entity that references the resource.
    /// </summary>
    /// <param name="relationshipId">The ID of the relationship entity releasing the reference.</param>
    /// <param name="characterId">The ID of the character resource being dereferenced.</param>
    /// <param name="cancellationToken">Cancellation token.</param>
    /// <returns>True if the event was published successfully.</returns>
    protected async Task<bool> UnregisterCharacterReferenceAsync(
        string relationshipId,
        Guid characterId,
        CancellationToken cancellationToken = default)
    {
        return await _messageBus.TryPublishAsync(
            "resource.reference.unregistered",
            new ResourceReferenceUnregisteredEvent
            {
                ResourceType = "character",
                ResourceId = characterId,
                SourceType = "relationship",
                SourceId = relationshipId,
                Timestamp = DateTimeOffset.UtcNow
            },
            cancellationToken);
    }

    /// <summary>
    /// Registers a reference from a relationship entity to a realm resource.
    /// Call this after creating an entity that references the resource.
    /// </summary>
    /// <param name="relationshipId">The ID of the relationship entity holding the reference.</param>
    /// <param name="realmId">The ID of the realm resource being referenced.</param>
    /// <param name="cancellationToken">Cancellation token.</param>
    /// <returns>True if the event was published successfully.</returns>
    protected async Task<bool> RegisterRealmReferenceAsync(
        string relationshipId,
        Guid realmId,
        CancellationToken cancellationToken = default)
    {
        return await _messageBus.TryPublishAsync(
            "resource.reference.registered",
            new ResourceReferenceRegisteredEvent
            {
                ResourceType = "realm",
                ResourceId = realmId,
                SourceType = "relationship",
                SourceId = relationshipId,
                Timestamp = DateTimeOffset.UtcNow
            },
            cancellationToken);
    }

    /// <summary>
    /// Unregisters a reference from a relationship entity to a realm resource.
    /// Call this before deleting an entity that references the resource.
    /// </summary>
    /// <param name="relationshipId">The ID of the relationship entity releasing the reference.</param>
    /// <param name="realmId">The ID of the realm resource being dereferenced.</param>
    /// <param name="cancellationToken">Cancellation token.</param>
    /// <returns>True if the event was published successfully.</returns>
    protected async Task<bool> UnregisterRealmReferenceAsync(
        string relationshipId,
        Guid realmId,
        CancellationToken cancellationToken = default)
    {
        return await _messageBus.TryPublishAsync(
            "resource.reference.unregistered",
            new ResourceReferenceUnregisteredEvent
            {
                ResourceType = "realm",
                ResourceId = realmId,
                SourceType = "relationship",
                SourceId = relationshipId,
                Timestamp = DateTimeOffset.UtcNow
            },
            cancellationToken);
    }

    // ═══════════════════════════════════════════════════════════════════════════
    // Cleanup Callback Registration
    // ═══════════════════════════════════════════════════════════════════════════

    /// <summary>
    /// Registers cleanup callbacks with lib-resource for all resource references.
    /// Call this during service startup or when the IResourceClient becomes available.
    /// </summary>
    /// <param name="resourceClient">The resource service client.</param>
    /// <param name="cancellationToken">Cancellation token.</param>
    /// <returns>True if all callbacks were registered successfully.</returns>
    public static async Task<bool> RegisterResourceCleanupCallbacksAsync(
        IResourceClient resourceClient,
        CancellationToken cancellationToken = default)
    {
        var allSucceeded = true;

        // Register cleanup callback for character references
        try
        {
            await resourceClient.DefineCleanupCallbackAsync(
                new DefineCleanupRequest
                {
                    ResourceType = "character",
                    SourceType = "relationship",
                    OnDeleteAction = OnDeleteAction.CASCADE,
                    ServiceName = "relationship",
                    CallbackEndpoint = "/relationship/cleanup-by-entity",
                    PayloadTemplate = "{\"entityId\": \"{{resourceId}}\", \"entityType\": \"Character\"}",
                    Description = "Cleanup relationship entities referencing deleted character"
                },
                cancellationToken);
        }
        catch (ApiException)
        {
            allSucceeded = false;
        }

        // Register cleanup callback for realm references
        try
        {
            await resourceClient.DefineCleanupCallbackAsync(
                new DefineCleanupRequest
                {
                    ResourceType = "realm",
                    SourceType = "relationship",
                    OnDeleteAction = OnDeleteAction.CASCADE,
                    ServiceName = "relationship",
                    CallbackEndpoint = "/relationship/cleanup-by-entity",
                    PayloadTemplate = "{\"entityId\": \"{{resourceId}}\", \"entityType\": \"Realm\"}",
                    Description = "Cleanup relationship entities referencing deleted realm"
                },
                cancellationToken);
        }
        catch (ApiException)
        {
            allSucceeded = false;
        }

        return allSucceeded;
    }
}
