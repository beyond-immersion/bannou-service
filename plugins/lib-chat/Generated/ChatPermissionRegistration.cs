//----------------------
// <auto-generated>
//     Generated from OpenAPI schema: schemas/chat-api.yaml
//
//     WARNING: DO NOT EDIT THIS FILE (FOUNDATION TENETS)
//     This file is auto-generated from x-permissions sections in the schema.
//     Any manual changes will be overwritten on next generation.
//
//     To modify permissions:
//     1. Edit x-permissions sections in schemas/chat-api.yaml
//     2. Run: scripts/generate-all-services.sh
//
//     See: docs/reference/tenets/FOUNDATION.md
// </auto-generated>
//----------------------

#nullable enable

using BeyondImmersion.BannouService;
using BeyondImmersion.BannouService.Services;
using Microsoft.Extensions.Logging;

namespace BeyondImmersion.BannouService.Chat;

/// <summary>
/// Generated permission registration for Chat service.
/// Contains permission matrix extracted from x-permissions sections in OpenAPI schema.
/// </summary>
public static class ChatPermissionRegistration
{
    /// <summary>
    /// Service ID for permission registration.
    /// </summary>
    public const string ServiceId = "chat";

    /// <summary>
    /// Service version from OpenAPI schema.
    /// </summary>
    public const string ServiceVersion = "1.0.0";

    /// <summary>
    /// Gets the list of endpoints with their permission requirements.
    /// </summary>
    public static ICollection<ServiceEndpoint> GetEndpoints()
    {
        var endpoints = new List<ServiceEndpoint>();

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/chat/type/register",
            Method = ServiceEndpointMethod.POST,
            Description = "RegisterRoomType",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "developer",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/chat/type/get",
            Method = ServiceEndpointMethod.POST,
            Description = "GetRoomType",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "developer",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/chat/type/list",
            Method = ServiceEndpointMethod.POST,
            Description = "ListRoomTypes",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "developer",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/chat/type/update",
            Method = ServiceEndpointMethod.POST,
            Description = "UpdateRoomType",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "developer",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/chat/type/deprecate",
            Method = ServiceEndpointMethod.POST,
            Description = "DeprecateRoomType",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "developer",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/chat/room/create",
            Method = ServiceEndpointMethod.POST,
            Description = "CreateRoom",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "user",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/chat/room/get",
            Method = ServiceEndpointMethod.POST,
            Description = "GetRoom",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "user",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/chat/room/list",
            Method = ServiceEndpointMethod.POST,
            Description = "ListRooms",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "user",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/chat/room/update",
            Method = ServiceEndpointMethod.POST,
            Description = "UpdateRoom",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "user",
                    RequiredStates = new Dictionary<string, string> { {"chat", "in_room"} }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/chat/room/delete",
            Method = ServiceEndpointMethod.POST,
            Description = "DeleteRoom",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "user",
                    RequiredStates = new Dictionary<string, string> { {"chat", "in_room"} }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/chat/room/archive",
            Method = ServiceEndpointMethod.POST,
            Description = "ArchiveRoom",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "user",
                    RequiredStates = new Dictionary<string, string> { {"chat", "in_room"} }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/chat/room/join",
            Method = ServiceEndpointMethod.POST,
            Description = "JoinRoom",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "user",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/chat/room/leave",
            Method = ServiceEndpointMethod.POST,
            Description = "LeaveRoom",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "user",
                    RequiredStates = new Dictionary<string, string> { {"chat", "in_room"} }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/chat/room/participants",
            Method = ServiceEndpointMethod.POST,
            Description = "ListParticipants",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "user",
                    RequiredStates = new Dictionary<string, string> { {"chat", "in_room"} }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/chat/room/participant/kick",
            Method = ServiceEndpointMethod.POST,
            Description = "KickParticipant",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "user",
                    RequiredStates = new Dictionary<string, string> { {"chat", "in_room"} }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/chat/room/participant/ban",
            Method = ServiceEndpointMethod.POST,
            Description = "BanParticipant",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "user",
                    RequiredStates = new Dictionary<string, string> { {"chat", "in_room"} }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/chat/room/participant/unban",
            Method = ServiceEndpointMethod.POST,
            Description = "UnbanParticipant",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "user",
                    RequiredStates = new Dictionary<string, string> { {"chat", "in_room"} }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/chat/room/participant/mute",
            Method = ServiceEndpointMethod.POST,
            Description = "MuteParticipant",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "user",
                    RequiredStates = new Dictionary<string, string> { {"chat", "in_room"} }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/chat/message/send",
            Method = ServiceEndpointMethod.POST,
            Description = "SendMessage",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "user",
                    RequiredStates = new Dictionary<string, string> { {"chat", "in_room"} }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/chat/message/send-batch",
            Method = ServiceEndpointMethod.POST,
            Description = "SendMessageBatch",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "developer",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/chat/message/history",
            Method = ServiceEndpointMethod.POST,
            Description = "GetMessageHistory",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "user",
                    RequiredStates = new Dictionary<string, string> { {"chat", "in_room"} }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/chat/message/delete",
            Method = ServiceEndpointMethod.POST,
            Description = "DeleteMessage",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "user",
                    RequiredStates = new Dictionary<string, string> { {"chat", "in_room"} }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/chat/message/pin",
            Method = ServiceEndpointMethod.POST,
            Description = "PinMessage",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "user",
                    RequiredStates = new Dictionary<string, string> { {"chat", "in_room"} }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/chat/message/unpin",
            Method = ServiceEndpointMethod.POST,
            Description = "UnpinMessage",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "user",
                    RequiredStates = new Dictionary<string, string> { {"chat", "in_room"} }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/chat/message/search",
            Method = ServiceEndpointMethod.POST,
            Description = "SearchMessages",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "user",
                    RequiredStates = new Dictionary<string, string> { {"chat", "in_room"} }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/chat/admin/rooms",
            Method = ServiceEndpointMethod.POST,
            Description = "AdminListRooms",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "developer",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/chat/admin/stats",
            Method = ServiceEndpointMethod.POST,
            Description = "AdminGetStats",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "developer",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        endpoints.Add(new ServiceEndpoint
        {
            Path = "/chat/admin/cleanup",
            Method = ServiceEndpointMethod.POST,
            Description = "AdminForceCleanup",
            Permissions = new List<PermissionRequirement>
            {
                new PermissionRequirement
                {
                    Role = "developer",
                    RequiredStates = new Dictionary<string, string> {  }
                },
            }
        });

        return endpoints;
    }

    /// <summary>
    /// Builds the permission matrix for RegisterServicePermissionsAsync.
    /// Key structure: state -> role -> list of methods
    /// State key construction must match PermissionService.RecompileSessionPermissionsAsync:
    /// - Same service (s.Key == ServiceId): use just s.Value (e.g., "ringing")
    /// - Cross-service: use "{s.Key}:{s.Value}" (e.g., "game-session:in_game")
    /// </summary>
    public static Dictionary<string, IDictionary<string, ICollection<string>>> BuildPermissionMatrix()
    {
        var matrix = new Dictionary<string, IDictionary<string, ICollection<string>>>();

        foreach (var endpoint in GetEndpoints())
        {
            var methodKey = endpoint.Path;

            foreach (var permission in endpoint.Permissions)
            {
                // Determine state key - use "default" if no specific states required
                // For same-service states, use just the value to match lookup logic
                var stateKey = permission.RequiredStates.Count > 0
                    ? string.Join("|", permission.RequiredStates.Select(s =>
                        s.Key == ServiceId ? s.Value : $"{s.Key}:{s.Value}"))
                    : "default";

                if (!matrix.TryGetValue(stateKey, out var roleMap))
                {
                    roleMap = new Dictionary<string, ICollection<string>>();
                    matrix[stateKey] = roleMap;
                }

                if (!roleMap.TryGetValue(permission.Role, out var methods))
                {
                    methods = new List<string>();
                    roleMap[permission.Role] = methods;
                }

                if (!methods.Contains(methodKey))
                {
                    methods.Add(methodKey);
                }
            }
        }

        return matrix;
    }

}

/// <summary>
/// Partial class overlay: registers Chat service permissions via DI registry.
/// Generated from x-permissions sections in chat-api.yaml.
/// Push-based: this service pushes its permission matrix TO the IPermissionRegistry.
/// </summary>
public partial class ChatService
{
    /// <summary>
    /// Registers this service's permissions with the Permission service via DI registry.
    /// Called by PluginLoader during startup with the resolved IPermissionRegistry.
    /// </summary>
    async Task IBannouService.RegisterServicePermissionsAsync(
        string appId, IPermissionRegistry? registry)
    {
        if (registry != null)
        {
            await registry.RegisterServiceAsync(
                ChatPermissionRegistration.ServiceId,
                ChatPermissionRegistration.ServiceVersion,
                ChatPermissionRegistration.BuildPermissionMatrix());
        }
    }
}
