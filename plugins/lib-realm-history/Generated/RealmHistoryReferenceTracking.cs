// <auto-generated>
// This code was generated by generate-references.py
// Do not edit this file manually.
// </auto-generated>

#nullable enable

using BeyondImmersion.Bannou.Core;
using BeyondImmersion.BannouService;
using BeyondImmersion.BannouService.Events;
using BeyondImmersion.BannouService.Messaging;
using BeyondImmersion.BannouService.Resource;

namespace BeyondImmersion.BannouService.RealmHistory;

/// <summary>
/// Generated partial class providing resource reference tracking helpers for RealmHistoryService.
/// </summary>
/// <remarks>
/// <para>
/// Call Register*ReferenceAsync() after creating an entity that references a foundational resource.
/// Call Unregister*ReferenceAsync() before deleting an entity that references a foundational resource.
/// Call RegisterResourceCleanupCallbacksAsync() during service startup to register cleanup callbacks.
/// </para>
/// </remarks>
public partial class RealmHistoryService
{

    /// <summary>
    /// Registers a reference from a realm-history entity to a realm resource.
    /// Call this after creating an entity that references the resource.
    /// </summary>
    /// <param name="realmHistoryId">The ID of the realm-history entity holding the reference.</param>
    /// <param name="realmId">The ID of the realm resource being referenced.</param>
    /// <param name="cancellationToken">Cancellation token.</param>
    /// <returns>True if the event was published successfully.</returns>
    protected async Task<bool> RegisterRealmReferenceAsync(
        string realmHistoryId,
        Guid realmId,
        CancellationToken cancellationToken = default)
    {
        return await _messageBus.TryPublishAsync(
            "resource.reference.registered",
            new ResourceReferenceRegisteredEvent
            {
                ResourceType = "realm",
                ResourceId = realmId,
                SourceType = "realm-history",
                SourceId = realmHistoryId,
                Timestamp = DateTimeOffset.UtcNow
            },
            cancellationToken);
    }

    /// <summary>
    /// Unregisters a reference from a realm-history entity to a realm resource.
    /// Call this before deleting an entity that references the resource.
    /// </summary>
    /// <param name="realmHistoryId">The ID of the realm-history entity releasing the reference.</param>
    /// <param name="realmId">The ID of the realm resource being dereferenced.</param>
    /// <param name="cancellationToken">Cancellation token.</param>
    /// <returns>True if the event was published successfully.</returns>
    protected async Task<bool> UnregisterRealmReferenceAsync(
        string realmHistoryId,
        Guid realmId,
        CancellationToken cancellationToken = default)
    {
        return await _messageBus.TryPublishAsync(
            "resource.reference.unregistered",
            new ResourceReferenceUnregisteredEvent
            {
                ResourceType = "realm",
                ResourceId = realmId,
                SourceType = "realm-history",
                SourceId = realmHistoryId,
                Timestamp = DateTimeOffset.UtcNow
            },
            cancellationToken);
    }

    // ═══════════════════════════════════════════════════════════════════════════
    // Cleanup Callback Registration
    // ═══════════════════════════════════════════════════════════════════════════

    /// <summary>
    /// Registers cleanup callbacks with lib-resource for all resource references.
    /// Call this during service startup or when the IResourceClient becomes available.
    /// </summary>
    /// <param name="resourceClient">The resource service client.</param>
    /// <param name="cancellationToken">Cancellation token.</param>
    /// <returns>True if all callbacks were registered successfully.</returns>
    public static async Task<bool> RegisterResourceCleanupCallbacksAsync(
        IResourceClient resourceClient,
        CancellationToken cancellationToken = default)
    {
        var allSucceeded = true;

        // Register cleanup callback for realm references
        try
        {
            await resourceClient.DefineCleanupCallbackAsync(
                new DefineCleanupRequest
                {
                    ResourceType = "realm",
                    SourceType = "realm-history",
                    OnDeleteAction = OnDeleteAction.CASCADE,
                    ServiceName = "realm-history",
                    CallbackEndpoint = "/realm-history/delete-all",
                    PayloadTemplate = "{\"realmId\": \"{{resourceId}}\"}",
                    Description = "Cleanup realm-history entities referencing deleted realm"
                },
                cancellationToken);
        }
        catch (ApiException)
        {
            allSucceeded = false;
        }

        return allSucceeded;
    }
}
