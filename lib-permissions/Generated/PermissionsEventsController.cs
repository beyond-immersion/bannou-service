// <auto-generated>
// This file was generated by generate-event-subscriptions.sh from permissions-events.yaml
// Do not edit this file directly - changes will be overwritten.
// To modify event subscriptions, edit x-event-subscriptions in permissions-events.yaml
// </auto-generated>

#nullable enable

using BeyondImmersion.BannouService.Events;
using BeyondImmersion.BannouService.Attributes;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;

namespace BeyondImmersion.BannouService.Permissions;

/// <summary>
/// Generated controller for handling pubsub events for Permissions service.
/// Dispatches events to registered handlers via IEventConsumer.
/// </summary>
[ApiController]
[Route("[controller]")]
public class PermissionsEventsController : ControllerBase
{
    private readonly ILogger<PermissionsEventsController> _logger;
    private readonly IEventConsumer _eventConsumer;

    /// <summary>
    /// Creates a new PermissionsEventsController instance.
    /// </summary>
    public PermissionsEventsController(
        ILogger<PermissionsEventsController> logger,
        IEventConsumer eventConsumer)
    {
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
        _eventConsumer = eventConsumer ?? throw new ArgumentNullException(nameof(eventConsumer));
    }

    /// <summary>
    /// Handle permissions.service-registered events via pubsub.
    /// Dispatches to all registered handlers via IEventConsumer.
    /// </summary>
    [Topic("bannou-pubsub", "permissions.service-registered")]
    [HttpPost("handle-permissions-service-registered")]
    public async Task<IActionResult> HandlePermissionsServiceRegisteredAsync()
    {
        try
        {
            var evt = await BannouEventHelper.ReadEventAsync<ServiceRegistrationEvent>(Request);

            if (evt == null)
            {
                _logger.LogWarning("Failed to parse ServiceRegistrationEvent from request body");
                return BadRequest("Invalid event data");
            }

            _logger.LogDebug("Dispatching permissions.service-registered event");

            await _eventConsumer.DispatchAsync("permissions.service-registered", evt, HttpContext.RequestServices);

            return Ok();
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to dispatch permissions.service-registered event");
            return StatusCode(500, "Internal server error processing event");
        }
    }

    /// <summary>
    /// Handle permissions.session-state-changed events via pubsub.
    /// Dispatches to all registered handlers via IEventConsumer.
    /// </summary>
    [Topic("bannou-pubsub", "permissions.session-state-changed")]
    [HttpPost("handle-permissions-session-state-changed")]
    public async Task<IActionResult> HandlePermissionsSessionStateChangedAsync()
    {
        try
        {
            var evt = await BannouEventHelper.ReadEventAsync<SessionStateChangeEvent>(Request);

            if (evt == null)
            {
                _logger.LogWarning("Failed to parse SessionStateChangeEvent from request body");
                return BadRequest("Invalid event data");
            }

            _logger.LogDebug("Dispatching permissions.session-state-changed event");

            await _eventConsumer.DispatchAsync("permissions.session-state-changed", evt, HttpContext.RequestServices);

            return Ok();
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to dispatch permissions.session-state-changed event");
            return StatusCode(500, "Internal server error processing event");
        }
    }

    /// <summary>
    /// Handle session.updated events via pubsub.
    /// Dispatches to all registered handlers via IEventConsumer.
    /// </summary>
    [Topic("bannou-pubsub", "session.updated")]
    [HttpPost("handle-session-updated")]
    public async Task<IActionResult> HandleSessionUpdatedAsync()
    {
        try
        {
            var evt = await BannouEventHelper.ReadEventAsync<SessionUpdatedEvent>(Request);

            if (evt == null)
            {
                _logger.LogWarning("Failed to parse SessionUpdatedEvent from request body");
                return BadRequest("Invalid event data");
            }

            _logger.LogDebug("Dispatching session.updated event");

            await _eventConsumer.DispatchAsync("session.updated", evt, HttpContext.RequestServices);

            return Ok();
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to dispatch session.updated event");
            return StatusCode(500, "Internal server error processing event");
        }
    }

    /// <summary>
    /// Handle session.connected events via pubsub.
    /// Dispatches to all registered handlers via IEventConsumer.
    /// </summary>
    [Topic("bannou-pubsub", "session.connected")]
    [HttpPost("handle-session-connected")]
    public async Task<IActionResult> HandleSessionConnectedAsync()
    {
        try
        {
            var evt = await BannouEventHelper.ReadEventAsync<SessionConnectedEvent>(Request);

            if (evt == null)
            {
                _logger.LogWarning("Failed to parse SessionConnectedEvent from request body");
                return BadRequest("Invalid event data");
            }

            _logger.LogDebug("Dispatching session.connected event");

            await _eventConsumer.DispatchAsync("session.connected", evt, HttpContext.RequestServices);

            return Ok();
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to dispatch session.connected event");
            return StatusCode(500, "Internal server error processing event");
        }
    }

    /// <summary>
    /// Handle session.disconnected events via pubsub.
    /// Dispatches to all registered handlers via IEventConsumer.
    /// </summary>
    [Topic("bannou-pubsub", "session.disconnected")]
    [HttpPost("handle-session-disconnected")]
    public async Task<IActionResult> HandleSessionDisconnectedAsync()
    {
        try
        {
            var evt = await BannouEventHelper.ReadEventAsync<SessionDisconnectedEvent>(Request);

            if (evt == null)
            {
                _logger.LogWarning("Failed to parse SessionDisconnectedEvent from request body");
                return BadRequest("Invalid event data");
            }

            _logger.LogDebug("Dispatching session.disconnected event");

            await _eventConsumer.DispatchAsync("session.disconnected", evt, HttpContext.RequestServices);

            return Ok();
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to dispatch session.disconnected event");
            return StatusCode(500, "Internal server error processing event");
        }
    }
}
