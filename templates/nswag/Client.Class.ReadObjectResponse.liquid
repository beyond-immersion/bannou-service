/// <summary>
    /// Gets or sets a value indicating whether to read the response as a string before deserialization.
    /// When true, the response is read as text first; when false, it's streamed directly.
    /// </summary>
    public bool ReadResponseAsString { get; set; }

    /// <summary>
    /// Reads and deserializes an HTTP response into the specified type.
    /// </summary>
    /// <typeparam name="T">The type to deserialize the response into.</typeparam>
    /// <param name="response">The HTTP response message to read.</param>
    /// <param name="headers">The response headers.</param>
    /// <param name="cancellationToken">A cancellation token.</param>
    /// <returns>The deserialized response object and raw text.</returns>
    protected virtual async System.Threading.Tasks.Task<ObjectResponseResult<T>> ReadObjectResponseAsync<T>(System.Net.Http.HttpResponseMessage response, System.Collections.Generic.IReadOnlyDictionary<string, System.Collections.Generic.IEnumerable<string>> headers, System.Threading.CancellationToken cancellationToken)
    {
        if (response == null)
        {
            throw new System.ArgumentNullException(nameof(response), "HTTP response cannot be null");
        }

        if (response.Content == null)
        {
            throw new {{ ExceptionClass }}("Response has no content to deserialize", (int)response.StatusCode, string.Empty, headers, null);
        }

        if (ReadResponseAsString)
        {
            var responseText = await ReadAsStringAsync(response.Content, cancellationToken).ConfigureAwait(false);
            try
            {
{% if UseSystemTextJson -%}
                var typedBody = BeyondImmersion.Bannou.Core.BannouJson.Deserialize<T>(responseText);
{% else -%}
                var typedBody = Newtonsoft.Json.JsonConvert.DeserializeObject<T>(responseText, JsonSerializerSettings);
{% endif -%}
                if (typedBody == null)
                {
                    throw new {{ ExceptionClass }}("Response body deserialized to null for type " + typeof(T).FullName, (int)response.StatusCode, responseText, headers, null);
                }
                return new ObjectResponseResult<T>(typedBody, responseText);
            }
{% if UseSystemTextJson -%}
            catch (System.Text.Json.JsonException exception)
{% else -%}
            catch (Newtonsoft.Json.JsonException exception)
{% endif -%}
            {
                var message = "Could not deserialize the response body string as " + typeof(T).FullName + ".";
                throw new {{ ExceptionClass }}(message, (int)response.StatusCode, responseText, headers, exception);
            }
        }
        else
        {
            try
            {
                using (var responseStream = await ReadAsStreamAsync(response.Content, cancellationToken).ConfigureAwait(false))
                {
{% if UseSystemTextJson -%}
                    var typedBody = await BeyondImmersion.Bannou.Core.BannouJson.DeserializeAsync<T>(responseStream, cancellationToken).ConfigureAwait(false);
                    if (typedBody == null)
                    {
                        throw new {{ ExceptionClass }}("Response body deserialized to null for type " + typeof(T).FullName, (int)response.StatusCode, string.Empty, headers, null);
                    }
                    return new ObjectResponseResult<T>(typedBody, string.Empty);
{% else -%}
                    using (var streamReader = new System.IO.StreamReader(responseStream))
                    using (var jsonTextReader = new Newtonsoft.Json.JsonTextReader(streamReader))
                    {
                        var serializer = Newtonsoft.Json.JsonSerializer.Create(JsonSerializerSettings);
                        var typedBody = serializer.Deserialize<T>(jsonTextReader);
                        if (typedBody == null)
                        {
                            throw new {{ ExceptionClass }}("Response body deserialized to null for type " + typeof(T).FullName, (int)response.StatusCode, string.Empty, headers, null);
                        }
                        return new ObjectResponseResult<T>(typedBody, string.Empty);
                    }
{% endif -%}
                }
            }
{% if UseSystemTextJson -%}
            catch (System.Text.Json.JsonException exception)
{% else -%}
            catch (Newtonsoft.Json.JsonException exception)
{% endif -%}
            {
                var message = "Could not deserialize the response body stream as " + typeof(T).FullName + ".";
                throw new {{ ExceptionClass }}(message, (int)response.StatusCode, string.Empty, headers, exception);
            }
        }
    }
