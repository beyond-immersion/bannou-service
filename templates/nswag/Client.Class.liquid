{% template Client.Class.Annotations %}
/// <summary>
/// Client implementation for the {{ Class | replace: "Client", "" }} service.
/// Provides strongly-typed methods for invoking service endpoints via the mesh infrastructure.
/// </summary>
[System.CodeDom.Compiler.GeneratedCode("NSwag", "{{ ToolchainVersion }}")]
{{ ClientClassAccessModifier }} partial class {{ Class }} {% if GenerateClientInterfaces %}: I{{ Class }}, BeyondImmersion.BannouService.ServiceClients.IServiceClient<{{ Class }}>{% endif %}
{
    // Use centralized BannouJson serialization helper
    private static readonly System.Text.Json.JsonSerializerOptions _jsonOptions = BeyondImmersion.BannouService.Configuration.BannouJson.Options;

    private readonly BeyondImmersion.BannouService.Services.IMeshInvocationClient _meshClient;
    private readonly BeyondImmersion.BannouService.Services.IServiceAppMappingResolver _resolver;
    private readonly Microsoft.Extensions.Logging.ILogger<{{ Class }}>? _logger;

    /// <summary>
    /// Service name used for app-id resolution. Extracted from class name.
    /// </summary>
    private static readonly string _serviceName = "{{ Class | replace: "Client", "" | downcase }}";

    /// <summary>
    /// The name of the service this client communicates with.
    /// Implements IServiceClient.ServiceName.
    /// </summary>
    public string ServiceName => _serviceName;

{% assign constructorParameters = "BeyondImmersion.BannouService.Services.IMeshInvocationClient meshClient, BeyondImmersion.BannouService.Services.IServiceAppMappingResolver resolver, Microsoft.Extensions.Logging.ILogger<" | append: Class | append: ">? logger = null" -%}
    /// <summary>
    /// Initializes a new instance of the <see cref="{{ Class }}"/> class.
    /// </summary>
    /// <param name="meshClient">The mesh invocation client for service-to-service communication.</param>
    /// <param name="resolver">The service app mapping resolver for endpoint resolution.</param>
    /// <param name="logger">Optional logger for diagnostic output.</param>
    public {{ Class }}({{ constructorParameters }})
    {
        _meshClient = meshClient ?? throw new System.ArgumentNullException(nameof(meshClient));
        _resolver = resolver ?? throw new System.ArgumentNullException(nameof(resolver));
        _logger = logger;
        Initialize();
    {% template Client.Class.Constructor %}
    }

{% if ExposeJsonSerializerSettings -%}
{%     assign serializerSettingsAccessModifier = "public" %}
{% else -%}
{%     assign serializerSettingsAccessModifier = "protected" %}
{% endif -%}
{% if UseRequestAndResponseSerializationSettings -%}
    /// <summary>
    /// Gets the JSON serializer settings used for serializing request bodies.
    /// </summary>
    {{ serializerSettingsAccessModifier }} {{ JsonSerializerSettingsType }} RequestJsonSerializerSettings { get { return _jsonOptions; } }
    /// <summary>
    /// Gets the JSON serializer settings used for deserializing response bodies.
    /// </summary>
    {{ serializerSettingsAccessModifier }} {{ JsonSerializerSettingsType }} ResponseJsonSerializerSettings { get { return _jsonOptions; } }
{% else -%}
    /// <summary>
    /// Gets the JSON serializer settings used for request and response serialization.
    /// </summary>
    {{ serializerSettingsAccessModifier }} {{ JsonSerializerSettingsType }} JsonSerializerSettings { get { return _jsonOptions; } }
{% endif -%}

    partial void Initialize();

    #region Header Support Methods

    /// <summary>
    /// Storage for custom headers to be applied to the next request.
    /// </summary>
    private readonly System.Collections.Generic.Dictionary<string, string> _customHeaders = new();

    /// <summary>
    /// Authorization header value for the next request.
    /// </summary>
    private string? _authorizationHeader;

    /// <summary>
    /// Sets a custom header for the next service request.
    /// Headers are applied once and then cleared.
    /// </summary>
    /// <param name="name">Header name (e.g., "X-Custom-Header")</param>
    /// <param name="value">Header value</param>
    public void SetHeader(string name, string value)
    {
        if (string.IsNullOrWhiteSpace(name))
            throw new System.ArgumentException("Header name cannot be null or empty", nameof(name));

        _customHeaders[name] = value ?? string.Empty;
    }

    /// <summary>
    /// Sets the Authorization header for the next request.
    /// Automatically prefixes with "Bearer " if not already present.
    /// Returns this instance for method chaining.
    /// </summary>
    /// <param name="token">JWT token or authorization value</param>
    /// <returns>This client instance for method chaining</returns>
    public {{ Class }} WithAuthorization(string? token)
    {
        if (string.IsNullOrWhiteSpace(token))
        {
            return this;
        }

        _authorizationHeader = token.StartsWith("Bearer ", System.StringComparison.OrdinalIgnoreCase)
            ? token : $"Bearer {token}";

        return this;
    }

    /// <summary>
    /// Clears the Authorization header.
    /// </summary>
    public void ClearAuthorization()
    {
        _authorizationHeader = null;
    }

    /// <summary>
    /// Clears all custom headers and authorization for a fresh request.
    /// Called automatically after each request.
    /// </summary>
    private void ClearHeaders()
    {
        _customHeaders.Clear();
        _authorizationHeader = null;
    }

    /// <summary>
    /// Applies stored headers to a request message.
    /// </summary>
    private void ApplyHeaders(System.Net.Http.HttpRequestMessage request)
    {
        // Apply authorization header if set
        if (!string.IsNullOrEmpty(_authorizationHeader))
        {
            var tokenValue = _authorizationHeader.StartsWith("Bearer ", System.StringComparison.OrdinalIgnoreCase)
                ? _authorizationHeader.Substring(7)
                : _authorizationHeader;
            request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", tokenValue);
        }

        // Apply custom headers
        foreach (var header in _customHeaders)
        {
            if (!request.Headers.Contains(header.Key))
            {
                request.Headers.TryAddWithoutValidation(header.Key, header.Value);
            }
        }
    }

    #endregion

{% for operation in Operations %}
{%     if GenerateOptionalParameters == false -%}
    {% template Client.Method.Documentation %}
    {% template Client.Method.Annotations %}
    {{ operation.MethodAccessModifier }} virtual {{ operation.ResultType }} {{ operation.ActualOperationName }}Async({% for parameter in operation.Parameters %}{{ parameter.Type }} {{ parameter.VariableName }}{% if GenerateOptionalParameters and parameter.IsOptional %} = null{% endif %}{% if parameter.IsLast == false %}, {% endif %}{% endfor %})
    {
        return {{ operation.ActualOperationName }}Async({% for parameter in operation.Parameters %}{{ parameter.VariableName }}, {% endfor %}System.Threading.CancellationToken.None);
    }

{%     endif -%}
{%     if GenerateSyncMethods -%}
    {% template Client.Method.Documentation %}
    {% template Client.Method.Annotations %}
    {{ operation.MethodAccessModifier }} virtual {{ operation.SyncResultType }} {{ operation.ActualOperationName }}({% for parameter in operation.Parameters %}{{ parameter.Type }} {{ parameter.VariableName }}{% if GenerateOptionalParameters and parameter.IsOptional %} = null{% endif %}{% if parameter.IsLast == false %}, {% endif %}{% endfor %})
    {
        {% if operation.HasResult or operation.WrapResponse %}return {% endif %}System.Threading.Tasks.Task.Run(async () => await {{ operation.ActualOperationName }}Async({% for parameter in operation.Parameters %}{{ parameter.VariableName }}, {% endfor %}System.Threading.CancellationToken.None)).GetAwaiter().GetResult();
    }

{%     endif -%}
{%     for parameter in operation.Parameters -%}
{%         unless parameter.Description and parameter.Description != "" -%}
    /// <param name="{{ parameter.VariableName }}">The {{ parameter.VariableName }} parameter.</param>
{%         endunless -%}
{%     endfor -%}
    /// <param name="cancellationToken">A cancellation token that can be used by other objects or threads to receive notice of cancellation.</param>
    {% template Client.Method.Documentation %}
    {% template Client.Method.Annotations %}
    {{ operation.MethodAccessModifier }} virtual async {{ operation.ResultType }} {{ operation.ActualOperationName }}Async({% for parameter in operation.Parameters %}{{ parameter.Type }} {{ parameter.VariableName }}{% if GenerateOptionalParameters and parameter.IsOptional %} = null{% endif %}, {% endfor %}System.Threading.CancellationToken cancellationToken{% if GenerateOptionalParameters %} = default(System.Threading.CancellationToken){% endif %})
    {
{%     for parameter in operation.PathParameters -%}
{%         if parameter.IsNullable == false and parameter.IsRequired -%}
        if ({{ parameter.VariableName }} == null)
            throw new System.ArgumentNullException("{{ parameter.VariableName }}");

{%         endif -%}
{%     endfor -%}
{%     for parameter in operation.QueryParameters -%}
{%         if parameter.IsNullable == false and parameter.IsRequired -%}
        if ({{ parameter.VariableName }} == null)
            throw new System.ArgumentNullException("{{ parameter.VariableName }}");

{%         endif -%}
{%     endfor -%}
{%     if operation.HasContent and operation.ContentParameter.IsRequired -%}
        if ({{ operation.ContentParameter.VariableName }} == null)
            throw new System.ArgumentNullException("{{ operation.ContentParameter.VariableName }}");

{%     endif -%}
        // Build method path (without base URL - mesh client handles endpoint resolution)
        var urlBuilder_ = new System.Text.StringBuilder();
        // Operation Path: "{{ operation.Path }}"
{%     if operation.Path contains "{" -%}
{%        assign pathParts = operation.Path | split: "{" -%}
{%        for pathPart in pathParts -%}
{%            if pathPart contains "}" -%}
{%                assign pathParameterParts = pathPart | split: "}" -%}
{%                assign pathParameterFound = true -%}
{%                for parameter in operation.PathParameters -%}
{%                    if parameter.Name == pathParameterParts[0] -%}
{%                        if parameter.IsOptional -%}
{%                            assign pathParameterFound = false -%}
        if ({{ parameter.VariableName }} != null)
        {
            {% template Client.Class.PathParameter %}
        }
        else
            if (urlBuilder_.Length > 0) urlBuilder_.Length--;
{%                        else -%}
        {% template Client.Class.PathParameter %}
{%                        endif -%}
{%                    endif -%}
{%                endfor -%}
{%                comment -%} >>> just in case {% endcomment -%}
{%                unless pathParameterFound -%}
        urlBuilder_.Append("{{ '{' }}{{ pathParameterParts[0] }}{{ '}' }}");
{%                endunless -%}
{%                comment -%} <<< just in case {% endcomment -%}
{%                assign nonParameterPartLengh = pathParameterParts[1] | size -%}
{%                if nonParameterPartLengh == 1 -%}
        urlBuilder_.Append('{{ pathParameterParts[1] }}');
{%                elsif nonParameterPartLengh > 0 -%}
        urlBuilder_.Append("{{ pathParameterParts[1] }}");
{%                endif -%}
{%            else -%}
{%                 unless pathPart == "" -%}
        urlBuilder_.Append("{{ pathPart }}");
{%                 endunless -%}
{%            endif -%}
{%        endfor -%}
{%    else -%}
{%        unless operation.Path == "" -%}
        urlBuilder_.Append("{{ operation.Path }}");
{%        endunless -%}
{%    endif -%}
{%     if operation.HasQueryParameters -%}
        urlBuilder_.Append('?');
{%         for parameter in operation.QueryParameters -%}
{%             if parameter.IsOptional -%}
        if ({{ parameter.VariableName }} != null)
        {
            {% template Client.Class.QueryParameter %}
        }
{%             else -%}
        {% template Client.Class.QueryParameter %}
{%             endif -%}
{%         endfor -%}
        urlBuilder_.Length--;
{%     endif -%}

        var methodPath_ = urlBuilder_.ToString().TrimStart('/');
        var appId_ = _resolver.GetAppIdForService(ServiceName);

        // Create HTTP request via mesh client
        using (var request_ = _meshClient.CreateInvokeMethodRequest(
            new System.Net.Http.HttpMethod("{{ operation.HttpMethodUpper | upcase }}"),
            appId_,
            methodPath_))
        {
{%     for parameter in operation.HeaderParameters %}
{%         if parameter.IsRequired -%}
            if ({{ parameter.VariableName }} == null)
                throw new System.ArgumentNullException("{{ parameter.VariableName }}");
            {% template Client.Class.HeaderParameter %}
{%         else -%}
            if ({{ parameter.VariableName }} != null)
                {% template Client.Class.HeaderParameter %}
{%         endif -%}
{%     endfor -%}
{%     if operation.HasContent -%}
{%         if operation.HasBinaryBodyParameter -%}
{%             if operation.ContentParameter.HasBinaryBodyWithMultipleMimeTypes -%}
            var content_ = new System.Net.Http.StreamContent({{ operation.ContentParameter.VariableName }}.Data);
            content_.Headers.ContentType = System.Net.Http.Headers.MediaTypeHeaderValue.Parse({{ operation.ContentParameter.VariableName }}.ContentType);
{%             else -%}
            var content_ = new System.Net.Http.StreamContent({{ operation.ContentParameter.VariableName }});
            content_.Headers.ContentType = System.Net.Http.Headers.MediaTypeHeaderValue.Parse("{{ operation.Consumes }}");
{%             endif -%}
{%         elsif operation.HasXmlBodyParameter -%}
            var content_ = new System.Net.Http.StringContent({{ operation.ContentParameter.VariableName }});
            content_.Headers.ContentType = System.Net.Http.Headers.MediaTypeHeaderValue.Parse("{{ operation.Consumes }}");
{%         elsif operation.ConsumesOnlyFormUrlEncoded -%}
            var json_ = BeyondImmersion.BannouService.Configuration.BannouJson.SerializeToUtf8Bytes({{ operation.ContentParameter.VariableName }});
            var dictionary_ = BeyondImmersion.BannouService.Configuration.BannouJson.Deserialize<System.Collections.Generic.Dictionary<string, string>>(json_);
            var content_ = new System.Net.Http.FormUrlEncodedContent(dictionary_);
            content_.Headers.ContentType = System.Net.Http.Headers.MediaTypeHeaderValue.Parse("{{ operation.Consumes }}");
{%         elsif operation.HasPlainTextBodyParameter -%}
            var content_ = new System.Net.Http.StringContent({{ operation.ContentParameter.VariableName }});
            content_.Headers.ContentType = System.Net.Http.Headers.MediaTypeHeaderValue.Parse("{{ operation.Consumes }}");
{%         else -%}
            var json_ = BeyondImmersion.BannouService.Configuration.BannouJson.SerializeToUtf8Bytes({{ operation.ContentParameter.VariableName }});
            var content_ = new System.Net.Http.ByteArrayContent(json_);
            content_.Headers.ContentType = System.Net.Http.Headers.MediaTypeHeaderValue.Parse("{{ operation.Consumes }}");
{%         endif -%}
            request_.Content = content_;
{%     else -%}
{%         if operation.HasFormParameters -%}
{%             if operation.ConsumesOnlyFormUrlEncoded -%}
            var keyValues_ = new System.Collections.Generic.List<System.Collections.Generic.KeyValuePair<string, string>>();
{%                 for parameter in operation.FormParameters -%}
{%                     if parameter.IsNullable -%}
            if ({{ parameter.VariableName }} != null)
{%                     else -%}
            if ({{ parameter.VariableName }} == null)
                throw new System.ArgumentNullException("{{ parameter.VariableName }}");
            else
{%                     endif -%}
                keyValues_.Add(new System.Collections.Generic.KeyValuePair<string, string>("{{ parameter.Name }}", ConvertToString({{ parameter.VariableName }}, System.Globalization.CultureInfo.InvariantCulture)));
{%                 endfor -%}
            request_.Content = new System.Net.Http.FormUrlEncodedContent(keyValues_);
{%             else -%}
            var boundary_ = System.Guid.NewGuid().ToString();
            var content_ = new System.Net.Http.MultipartFormDataContent(boundary_);
            content_.Headers.Remove("Content-Type");
            content_.Headers.TryAddWithoutValidation("Content-Type", "multipart/form-data; boundary=" + boundary_);
{%                 for parameter in operation.FormParameters %}
{%                     if parameter.IsNullable -%}
            if ({{ parameter.VariableName }} != null)
{%                     else -%}
            if ({{ parameter.VariableName }} == null)
                throw new System.ArgumentNullException("{{ parameter.VariableName }}");
            else
{%                     endif -%}
            {
{%                     if parameter.IsFile -%}
{%                         if parameter.IsArray -%}
                foreach (var item_ in {{ parameter.VariableName }})
                {
                    var content_{{ parameter.VariableName }}_ = new System.Net.Http.StreamContent(item_.Data);
                    if (!string.IsNullOrEmpty(item_.ContentType))
                        content_{{ parameter.VariableName }}_.Headers.ContentType = System.Net.Http.Headers.MediaTypeHeaderValue.Parse(item_.ContentType);
                    content_.Add(content_{{ parameter.VariableName }}_, "{{ parameter.Name }}", item_.FileName ?? "{{ parameter.Name }}");
                }
{%                         else -%}
                var content_{{ parameter.VariableName }}_ = new System.Net.Http.StreamContent({{ parameter.VariableName }}.Data);
                if (!string.IsNullOrEmpty({{ parameter.VariableName }}.ContentType))
                    content_{{ parameter.VariableName }}_.Headers.ContentType = System.Net.Http.Headers.MediaTypeHeaderValue.Parse({{ parameter.VariableName }}.ContentType);
                content_.Add(content_{{ parameter.VariableName }}_, "{{ parameter.Name }}", {{ parameter.VariableName }}.FileName ?? "{{ parameter.Name }}");
{%                         endif -%}
{%                     elsif parameter.IsArray -%}
                foreach (var item_ in {{ parameter.VariableName }})
                {
                    content_.Add(new System.Net.Http.StringContent(ConvertToString(item_, System.Globalization.CultureInfo.InvariantCulture)), "{{ parameter.Name }}");
                }
{%                     elsif parameter.IsObject -%}
                var json_ = BeyondImmersion.BannouService.Configuration.BannouJson.SerializeToUtf8Bytes({{ parameter.VariableName }});
                content_.Add(new System.Net.Http.ByteArrayContent(json_), "{{ parameter.Name }}");
{%                     else -%}
                content_.Add(new System.Net.Http.StringContent(ConvertToString({{ parameter.VariableName }}, System.Globalization.CultureInfo.InvariantCulture)), "{{ parameter.Name }}");
{%                     endif -%}
            }
{%                 endfor -%}
            request_.Content = content_;
{%             endif -%}
{%         elsif operation.IsGetOrDeleteOrHead == false -%}
            request_.Content = new System.Net.Http.StringContent(string.Empty, System.Text.Encoding.UTF8, "{{ operation.Consumes }}");
{%         endif -%}
{%     endif -%}
{%     if operation.HasResultType and operation.HasAcceptHeaderParameterParameter == false -%}
            request_.Headers.Accept.Add(System.Net.Http.Headers.MediaTypeWithQualityHeaderValue.Parse("{{ operation.Produces }}"));
{%     endif -%}

            // Apply custom headers
            ApplyHeaders(request_);

            try
            {
                var response_ = await _meshClient.InvokeMethodWithResponseAsync(request_, cancellationToken).ConfigureAwait(false);
                var disposeResponse_ = true;
                try
                {
                    var headers_ = new System.Collections.Generic.Dictionary<string, System.Collections.Generic.IEnumerable<string>>();
                    foreach (var item_ in response_.Headers)
                        headers_[item_.Key] = item_.Value;
                    if (response_.Content != null && response_.Content.Headers != null)
                    {
                        foreach (var item_ in response_.Content.Headers)
                            headers_[item_.Key] = item_.Value;
                    }

                    var status_ = (int)response_.StatusCode;
{%     for response in operation.Responses -%}
                    if (status_ == {{ response.StatusCode }}{% if response.CheckChunkedStatusCode %} || status_ == 206{% endif %})
                    {
                        {% template Client.Class.ProcessResponse %}
                    }
                    else
{%     endfor -%}
{%     if operation.HasDefaultResponse -%}
{%         if operation.DefaultResponse.HasType -%}
                    {
{%             assign response = operation.DefaultResponse -%}
                        {% template Client.Class.ProcessResponse %}
                    }
{%         elsif operation.HasSuccessResponse -%}
                    {
                        var responseData_ = response_.Content == null ? null : await ReadAsStringAsync(response_.Content, cancellationToken).ConfigureAwait(false);
                        throw new {{ ExceptionClass }}("{{ operation.DefaultResponse.ExceptionDescription }}", status_, responseData_, headers_, null);
                    }
{%        elsif operation.HasResultType -%}
{%             if operation.WrapResponse and operation.UnwrappedResultType != "FileResponse" %}
                    return new {{ ResponseClass }}<{{ operation.UnwrappedResultType }}>(status_, headers_, {{ operation.UnwrappedResultDefaultValue }});
{%             else -%}
                    {% if operation.HasResult %}return {{ operation.UnwrappedResultDefaultValue }};{% else %}return;{% endif %}
{%             endif -%}
{%         elsif operation.WrapResponse -%}
                    return new {{ ResponseClass }}(status_, headers_);
{%         endif -%}
{%     else -%}
{%         if operation.HasSuccessResponse == false -%}
{% comment -%}
    If the success response has already been explicitely declared, there is no need for this default code (because handled above).
    Otherwise, return default values on success because we don't want to throw on "unknown status code".
    Success is always expected
{%- endcomment %}
                    if (status_ == 200 || status_ == 204)
                    {
{%             if operation.HasResultType -%}
{%                 if operation.WrapResponse and operation.UnwrappedResultType != "FileResponse" %}
                        return new {{ ResponseClass }}<{{ operation.UnwrappedResultType }}>(status_, headers_, {{ operation.UnwrappedResultDefaultValue }});
{%                 else -%}
                        {% if operation.HasResult %}return {{ operation.UnwrappedResultDefaultValue }};{% else %}return;{% endif %}
{%                 endif -%}
{%             elsif operation.WrapResponse -%}
                        return new {{ ResponseClass }}(status_, headers_);
{%             else -%}{% comment %} This method isn't expected to return a value. Just return. {% endcomment %}
                        return;
{%             endif -%}
                    }
                    else
{%         endif -%}
                    {
                        var responseData_ = response_.Content == null ? null : await ReadAsStringAsync(response_.Content, cancellationToken).ConfigureAwait(false);
                        throw new {{ ExceptionClass }}("The HTTP status code of the response was not expected (" + status_ + ").", status_, responseData_, headers_, null);
                    }
{%     endif -%}
                }
                finally
                {
                    if (disposeResponse_)
                        response_.Dispose();
                }
            }
            finally
            {
                // Clear headers after request (one-time use)
                ClearHeaders();
            }
        }
    }

{% endfor %}
    /// <summary>
    /// Represents the result of deserializing an HTTP response into an object.
    /// </summary>
    /// <typeparam name="T">The type of the deserialized response object.</typeparam>
    protected struct ObjectResponseResult<T>
    {
        /// <summary>
        /// Initializes a new instance of the <see cref="ObjectResponseResult{T}"/> struct.
        /// </summary>
        /// <param name="responseObject">The deserialized response object.</param>
        /// <param name="responseText">The raw response text.</param>
        public ObjectResponseResult(T responseObject, string responseText)
        {
            this.Object = responseObject;
            this.Text = responseText;
        }

        /// <summary>
        /// Gets the deserialized response object.
        /// </summary>
        public T Object { get; }

        /// <summary>
        /// Gets the raw response text.
        /// </summary>
        public string Text { get; }
    }

    [System.Runtime.CompilerServices.MethodImpl(System.Runtime.CompilerServices.MethodImplOptions.AggressiveInlining)]
    private static System.Threading.Tasks.Task<string> ReadAsStringAsync(System.Net.Http.HttpContent content, System.Threading.CancellationToken cancellationToken)
    {
#if NET5_0_OR_GREATER
        return content.ReadAsStringAsync(cancellationToken);
#else
        return content.ReadAsStringAsync();
#endif
    }

    [System.Runtime.CompilerServices.MethodImpl(System.Runtime.CompilerServices.MethodImplOptions.AggressiveInlining)]
    private static System.Threading.Tasks.Task<System.IO.Stream> ReadAsStreamAsync(System.Net.Http.HttpContent content, System.Threading.CancellationToken cancellationToken)
    {
#if NET5_0_OR_GREATER
        return content.ReadAsStreamAsync(cancellationToken);
#else
        return content.ReadAsStreamAsync();
#endif
    }


    {% template Client.Class.ReadObjectResponse %}

    {% template Client.Class.ConvertToString %}
    {% template Client.Class.Body %}
}
